cscope 15 $HOME/F2FS/F2FS_rainbow/f2fs               0000449285
	@acl.c

15 
	~<lšux/f2fs_fs.h
>

16 
	~"f2fs.h
"

17 
	~"x©Œ.h
"

18 
	~"aş.h
"

20 
šlše
 
size_t
 
	$f2fs_aş_size
(
couÁ
)

22 ià(
couÁ
 <= 4) {

23  (
f2fs_aş_h—d”
) +

24 
couÁ
 * (
f2fs_aş_’Œy_shÜt
);

26  (
f2fs_aş_h—d”
) +

27 4 * (
f2fs_aş_’Œy_shÜt
) +

28 (
couÁ
 - 4è* (
f2fs_aş_’Œy
);

30 
	}
}

32 
šlše
 
	$f2fs_aş_couÁ
(
size_t
 
size
)

34 
ssize_t
 
s
;

35 
size
 -ğ(
f2fs_aş_h—d”
);

36 
s
 = 
size
 - 4 * (
f2fs_aş_’Œy_shÜt
);

37 ià(
s
 < 0) {

38 ià(
size
 % (
f2fs_aş_’Œy_shÜt
))

40  
size
 / (
f2fs_aş_’Œy_shÜt
);

42 ià(
s
 % (
f2fs_aş_’Œy
))

44  
s
 / (
f2fs_aş_’Œy
) + 4;

46 
	}
}

48 
posix_aş
 *
	$f2fs_aş_äom_disk
(cÚ¡ *
v®ue
, 
size_t
 
size
)

50 
i
, 
couÁ
;

51 
posix_aş
 *
aş
;

52 
f2fs_aş_h—d”
 *
hdr
 = (f2fs_aş_h—d” *)
v®ue
;

53 
f2fs_aş_’Œy
 *
’Œy
 = (f2fs_aş_’Œy *)(
hdr
 + 1);

54 cÚ¡ *
’d
 = 
v®ue
 + 
size
;

56 ià(
hdr
->
a_v”siÚ
 !ğ
	`ıu_to_Ë32
(
F2FS_ACL_VERSION
))

57  
	`ERR_PTR
(-
EINVAL
);

59 
couÁ
 = 
	`f2fs_aş_couÁ
(
size
);

60 ià(
couÁ
 < 0)

61  
	`ERR_PTR
(-
EINVAL
);

62 ià(
couÁ
 == 0)

63  
NULL
;

65 
aş
 = 
	`posix_aş_®loc
(
couÁ
, 
GFP_KERNEL
);

66 ià(!
aş
)

67  
	`ERR_PTR
(-
ENOMEM
);

69 
i
 = 0; i < 
couÁ
; i++) {

71 ià((*)
’Œy
 > 
’d
)

72 
ç
;

74 
aş
->
a_’Œ›s
[
i
].
e_g
 = 
	`Ë16_to_ıu
(
’Œy
->e_tag);

75 
aş
->
a_’Œ›s
[
i
].
e_³rm
 = 
	`Ë16_to_ıu
(
’Œy
->e_perm);

77 
aş
->
a_’Œ›s
[
i
].
e_g
) {

78 
ACL_USER_OBJ
:

79 
ACL_GROUP_OBJ
:

80 
ACL_MASK
:

81 
ACL_OTHER
:

82 
’Œy
 = (
f2fs_aş_’Œy
 *)((*)entry +

83 (
f2fs_aş_’Œy_shÜt
));

86 
ACL_USER
:

87 
aş
->
a_’Œ›s
[
i
].
e_uid
 =

88 
	`make_kuid
(&
š™_u£r_ns
,

89 
	`Ë32_to_ıu
(
’Œy
->
e_id
));

90 
’Œy
 = (
f2fs_aş_’Œy
 *)((*)entry +

91 (
f2fs_aş_’Œy
));

93 
ACL_GROUP
:

94 
aş
->
a_’Œ›s
[
i
].
e_gid
 =

95 
	`make_kgid
(&
š™_u£r_ns
,

96 
	`Ë32_to_ıu
(
’Œy
->
e_id
));

97 
’Œy
 = (
f2fs_aş_’Œy
 *)((*)entry +

98 (
f2fs_aş_’Œy
));

101 
ç
;

104 ià((*)
’Œy
 !ğ
’d
)

105 
ç
;

106  
aş
;

107 
ç
:

108 
	`posix_aş_»Ëa£
(
aş
);

109  
	`ERR_PTR
(-
EINVAL
);

110 
	}
}

112 *
	$f2fs_aş_to_disk
(cÚ¡ 
posix_aş
 *
aş
, 
size_t
 *
size
)

114 
f2fs_aş_h—d”
 *
f2fs_aş
;

115 
f2fs_aş_’Œy
 *
’Œy
;

116 
i
;

118 
f2fs_aş
 = 
	`km®loc
((
f2fs_aş_h—d”
è+ 
aş
->
a_couÁ
 *

119 (
f2fs_aş_’Œy
), 
GFP_KERNEL
);

120 ià(!
f2fs_aş
)

121  
	`ERR_PTR
(-
ENOMEM
);

123 
f2fs_aş
->
a_v”siÚ
 = 
	`ıu_to_Ë32
(
F2FS_ACL_VERSION
);

124 
’Œy
 = (
f2fs_aş_’Œy
 *)(
f2fs_aş
 + 1);

126 
i
 = 0; i < 
aş
->
a_couÁ
; i++) {

128 
’Œy
->
e_g
 = 
	`ıu_to_Ë16
(
aş
->
a_’Œ›s
[
i
].e_tag);

129 
’Œy
->
e_³rm
 = 
	`ıu_to_Ë16
(
aş
->
a_’Œ›s
[
i
].e_perm);

131 
aş
->
a_’Œ›s
[
i
].
e_g
) {

132 
ACL_USER
:

133 
’Œy
->
e_id
 = 
	`ıu_to_Ë32
(

134 
	`äom_kuid
(&
š™_u£r_ns
,

135 
aş
->
a_’Œ›s
[
i
].
e_uid
));

136 
’Œy
 = (
f2fs_aş_’Œy
 *)((*)entry +

137 (
f2fs_aş_’Œy
));

139 
ACL_GROUP
:

140 
’Œy
->
e_id
 = 
	`ıu_to_Ë32
(

141 
	`äom_kgid
(&
š™_u£r_ns
,

142 
aş
->
a_’Œ›s
[
i
].
e_gid
));

143 
’Œy
 = (
f2fs_aş_’Œy
 *)((*)entry +

144 (
f2fs_aş_’Œy
));

146 
ACL_USER_OBJ
:

147 
ACL_GROUP_OBJ
:

148 
ACL_MASK
:

149 
ACL_OTHER
:

150 
’Œy
 = (
f2fs_aş_’Œy
 *)((*)entry +

151 (
f2fs_aş_’Œy_shÜt
));

154 
ç
;

157 *
size
 = 
	`f2fs_aş_size
(
aş
->
a_couÁ
);

158  (*)
f2fs_aş
;

160 
ç
:

161 
	`kä“
(
f2fs_aş
);

162  
	`ERR_PTR
(-
EINVAL
);

163 
	}
}

165 
posix_aş
 *
	$f2fs_g‘_aş
(
šode
 *šode, 
ty³
)

167 
Çme_šdex
 = 
F2FS_XATTR_INDEX_POSIX_ACL_DEFAULT
;

168 *
v®ue
 = 
NULL
;

169 
posix_aş
 *
aş
;

170 
»tv®
;

172 ià(
ty³
 =ğ
ACL_TYPE_ACCESS
)

173 
Çme_šdex
 = 
F2FS_XATTR_INDEX_POSIX_ACL_ACCESS
;

175 
»tv®
 = 
	`f2fs_g‘x©Œ
(
šode
, 
Çme_šdex
, "", 
NULL
, 0);

176 ià(
»tv®
 > 0) {

177 
v®ue
 = 
	`km®loc
(
»tv®
, 
GFP_F2FS_ZERO
);

178 ià(!
v®ue
)

179  
	`ERR_PTR
(-
ENOMEM
);

180 
»tv®
 = 
	`f2fs_g‘x©Œ
(
šode
, 
Çme_šdex
, "", 
v®ue
,„etval);

183 ià(
»tv®
 > 0)

184 
aş
 = 
	`f2fs_aş_äom_disk
(
v®ue
, 
»tv®
);

185 ià(
»tv®
 =ğ-
ENODATA
)

186 
aş
 = 
NULL
;

188 
aş
 = 
	`ERR_PTR
(
»tv®
);

189 
	`kä“
(
v®ue
);

191 ià(!
	`IS_ERR
(
aş
))

192 
	`£t_ÿched_aş
(
šode
, 
ty³
, 
aş
);

194  
aş
;

195 
	}
}

197 
	$__f2fs_£t_aş
(
šode
 *šode, 
ty³
,

198 
posix_aş
 *
aş
, 
·ge
 *
age
)

200 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

201 
Çme_šdex
;

202 *
v®ue
 = 
NULL
;

203 
size_t
 
size
 = 0;

204 
”rÜ
;

206 
ty³
) {

207 
ACL_TYPE_ACCESS
:

208 
Çme_šdex
 = 
F2FS_XATTR_INDEX_POSIX_ACL_ACCESS
;

209 ià(
aş
) {

210 
”rÜ
 = 
	`posix_aş_equiv_mode
(
aş
, &
šode
->
i_mode
);

211 ià(
”rÜ
 < 0)

212  
”rÜ
;

213 
	`£t_aş_šode
(
fi
, 
šode
->
i_mode
);

214 ià(
”rÜ
 == 0)

215 
aş
 = 
NULL
;

219 
ACL_TYPE_DEFAULT
:

220 
Çme_šdex
 = 
F2FS_XATTR_INDEX_POSIX_ACL_DEFAULT
;

221 ià(!
	`S_ISDIR
(
šode
->
i_mode
))

222  
aş
 ? -
EACCES
 : 0;

226  -
EINVAL
;

229 ià(
aş
) {

230 
v®ue
 = 
	`f2fs_aş_to_disk
(
aş
, &
size
);

231 ià(
	`IS_ERR
(
v®ue
)) {

232 
	`cÚd_ş—r_šode_æag
(
fi
, 
FI_ACL_MODE
);

233  ()
	`PTR_ERR
(
v®ue
);

237 
”rÜ
 = 
	`f2fs_£tx©Œ
(
šode
, 
Çme_šdex
, "", 
v®ue
, 
size
, 
age
, 0);

239 
	`kä“
(
v®ue
);

240 ià(!
”rÜ
)

241 
	`£t_ÿched_aş
(
šode
, 
ty³
, 
aş
);

243 
	`cÚd_ş—r_šode_æag
(
fi
, 
FI_ACL_MODE
);

244  
”rÜ
;

245 
	}
}

247 
	$f2fs_£t_aş
(
šode
 *šode, 
posix_aş
 *
aş
, 
ty³
)

249  
	`__f2fs_£t_aş
(
šode
, 
ty³
, 
aş
, 
NULL
);

250 
	}
}

252 
	$f2fs_š™_aş
(
šode
 *šode, šod*
dœ
, 
·ge
 *
age
)

254 
posix_aş
 *
deçuÉ_aş
, *
aş
;

255 
”rÜ
 = 0;

257 
”rÜ
 = 
	`posix_aş_ü—‹
(
dœ
, &
šode
->
i_mode
, &
deçuÉ_aş
, &
aş
);

258 ià(
”rÜ
)

259  
”rÜ
;

261 ià(
deçuÉ_aş
) {

262 
”rÜ
 = 
	`__f2fs_£t_aş
(
šode
, 
ACL_TYPE_DEFAULT
, 
deçuÉ_aş
,

263 
age
);

264 
	`posix_aş_»Ëa£
(
deçuÉ_aş
);

266 ià(
aş
) {

267 ià(
”rÜ
)

268 
”rÜ
 = 
	`__f2fs_£t_aş
(
šode
, 
ACL_TYPE_ACCESS
, 
aş
,

269 
age
);

270 
	`posix_aş_»Ëa£
(
aş
);

273  
”rÜ
;

274 
	}
}

	@acl.h

15 #iâdeà
__F2FS_ACL_H__


16 
	#__F2FS_ACL_H__


	)

18 
	~<lšux/posix_aş_x©Œ.h
>

20 
	#F2FS_ACL_VERSION
 0x0001

	)

22 
	sf2fs_aş_’Œy
 {

23 
__Ë16
 
	me_g
;

24 
__Ë16
 
	me_³rm
;

25 
__Ë32
 
	me_id
;

28 
	sf2fs_aş_’Œy_shÜt
 {

29 
__Ë16
 
	me_g
;

30 
__Ë16
 
	me_³rm
;

33 
	sf2fs_aş_h—d”
 {

34 
__Ë32
 
	ma_v”siÚ
;

37 #ifdeà
CONFIG_F2FS_FS_POSIX_ACL


39 
posix_aş
 *
f2fs_g‘_aş
(
šode
 *, );

40 
f2fs_£t_aş
(
šode
 *šode, 
posix_aş
 *
aş
, 
ty³
);

41 
f2fs_š™_aş
(
šode
 *, šod*, 
·ge
 *);

43 
	#f2fs_check_aş
 
NULL


	)

44 
	#f2fs_g‘_aş
 
NULL


	)

45 
	#f2fs_£t_aş
 
NULL


	)

47 
šlše
 
	$f2fs_š™_aş
(
šode
 *šode, šod*
dœ
,

48 
·ge
 *page)

51 
	}
}

	@checkpoint.c

11 
	~<lšux/fs.h
>

12 
	~<lšux/bio.h
>

13 
	~<lšux/m·ge.h
>

14 
	~<lšux/wr™eback.h
>

15 
	~<lšux/blkdev.h
>

16 
	~<lšux/f2fs_fs.h
>

17 
	~<lšux/·gevec.h
>

18 
	~<lšux/sw­.h
>

20 
	~"f2fs.h
"

21 
	~"node.h
"

22 
	~"£gm’t.h
"

23 
	~<Œaû/ev’ts/f2fs.h
>

25 
kmem_ÿche
 *
	gšo_’Œy_¦ab
;

26 
kmem_ÿche
 *
	gšode_’Œy_¦ab
;

31 
·ge
 *
	$g¿b_m‘a_·ge
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
šdex
)

33 
add»ss_¥aû
 *
m­pšg
 = 
	`META_MAPPING
(
sbi
);

34 
·ge
 *·gğ
NULL
;

35 
»³©
:

36 
·ge
 = 
	`g¿b_ÿche_·ge
(
m­pšg
, 
šdex
);

37 ià(!
·ge
) {

38 
	`cÚd_»sched
();

39 
»³©
;

41 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
META
);

42 
	`S‘PageU±od©e
(
·ge
);

43  
·ge
;

44 
	}
}

49 
·ge
 *
	$g‘_m‘a_·ge
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
šdex
)

51 
add»ss_¥aû
 *
m­pšg
 = 
	`META_MAPPING
(
sbi
);

52 
·ge
 *page;

53 
»³©
:

54 
·ge
 = 
	`g¿b_ÿche_·ge
(
m­pšg
, 
šdex
);

55 ià(!
·ge
) {

56 
	`cÚd_»sched
();

57 
»³©
;

59 ià(
	`PageU±od©e
(
·ge
))

60 
out
;

62 ià(
	`f2fs_subm™_·ge_bio
(
sbi
, 
·ge
, 
šdex
,

63 
READ_SYNC
 | 
REQ_META
 | 
REQ_PRIO
))

64 
»³©
;

66 
	`lock_·ge
(
·ge
);

67 ià(
	`uÆik–y
(
·ge
->
m­pšg
 != mapping)) {

68 
	`f2fs_put_·ge
(
·ge
, 1);

69 
»³©
;

71 
out
:

72  
·ge
;

73 
	}
}

75 
·ge
 *
	$g‘_m‘a_·ge_¿
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
šdex
)

77 
boŞ
 
»adah—d
 = 
çl£
;

78 
·ge
 *page;

80 
·ge
 = 
	`fšd_g‘_·ge
(
	`META_MAPPING
(
sbi
), 
šdex
);

81 ià(!
·ge
 || (·g&& !
	`PageU±od©e
(page)))

82 
»adah—d
 = 
Œue
;

83 
	`f2fs_put_·ge
(
·ge
, 0);

85 ià(
»adah—d
)

86 
	`¿_m‘a_·ges
(
sbi
, 
šdex
, 
	`MAX_BIO_BLOCKS
(sbi), 
META_POR
);

87  
	`g‘_m‘a_·ge
(
sbi
, 
šdex
);

88 
	}
}

90 
šlše
 
block_t
 
	$g‘_max_m‘a_blks
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

92 
ty³
) {

93 
META_NAT
:

94  
	`NM_I
(
sbi
)->
max_nid
 / 
NAT_ENTRY_PER_BLOCK
;

95 
META_SIT
:

96  
	`SIT_BLK_CNT
(
sbi
);

97 
META_SSA
:

98 
META_CP
:

100 
META_POR
:

101  
	`MAX_BLKADDR
(
sbi
);

103 
	`BUG
();

105 
	}
}

110 
	$¿_m‘a_·ges
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
¡¬t
, 
Ä·ges
, 
ty³
)

112 
block_t
 
´ev_blk_addr
 = 0;

113 
·ge
 *page;

114 
block_t
 
blkno
 = 
¡¬t
;

115 
block_t
 
max_blks
 = 
	`g‘_max_m‘a_blks
(
sbi
, 
ty³
);

117 
f2fs_io_šfo
 
fio
 = {

118 .
ty³
 = 
META
,

119 .
rw
 = 
READ_SYNC
 | 
REQ_META
 | 
REQ_PRIO


122 ; 
Ä·ges
-- > 0; 
blkno
++) {

123 
block_t
 
blk_addr
;

125 
ty³
) {

126 
META_NAT
:

128 ià(
	`uÆik–y
(
blkno
 >ğ
max_blks
))

129 
blkno
 = 0;

130 
blk_addr
 = 
	`cu¼’t_Çt_addr
(
sbi
,

131 
blkno
 * 
NAT_ENTRY_PER_BLOCK
);

133 
META_SIT
:

135 ià(
	`uÆik–y
(
blkno
 >ğ
max_blks
))

136 
out
;

137 
blk_addr
 = 
	`cu¼’t_s™_addr
(
sbi
,

138 
blkno
 * 
SIT_ENTRY_PER_BLOCK
);

139 ià(
blkno
 !ğ
¡¬t
 && 
´ev_blk_addr
 + 1 !ğ
blk_addr
)

140 
out
;

141 
´ev_blk_addr
 = 
blk_addr
;

143 
META_SSA
:

144 
META_CP
:

145 
META_POR
:

146 ià(
	`uÆik–y
(
blkno
 >ğ
max_blks
))

147 
out
;

148 ià(
	`uÆik–y
(
blkno
 < 
	`SEG0_BLKADDR
(
sbi
)))

149 
out
;

150 
blk_addr
 = 
blkno
;

153 
	`BUG
();

156 
·ge
 = 
	`g¿b_ÿche_·ge
(
	`META_MAPPING
(
sbi
), 
blk_addr
);

157 ià(!
·ge
)

159 ià(
	`PageU±od©e
(
·ge
)) {

160 
	`f2fs_put_·ge
(
·ge
, 1);

164 #ifdeà
F2FS_DA_MAP


165 
	`f2fs_subm™_·ge_mbio
(
sbi
, 
·ge
, 
blk_addr
, &
fio
, 
NULL
);

167 
	`f2fs_subm™_·ge_mbio
(
sbi
, 
·ge
, 
blk_addr
, &
fio
);

169 
	`f2fs_put_·ge
(
·ge
, 0);

171 
out
:

172 
	`f2fs_subm™_m”ged_bio
(
sbi
, 
META
, 
READ
);

173  
blkno
 - 
¡¬t
;

174 
	}
}

176 
	$f2fs_wr™e_m‘a_·ge
(
·ge
 *page,

177 
wr™eback_cÚŒŞ
 *
wbc
)

179 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_P_SB
(
·ge
);

181 
	`Œaû_f2fs_wr™•age
(
·ge
, 
META
);

183 ià(
	`uÆik–y
(
sbi
->
pÜ_došg
))

184 
»dœty_out
;

185 ià(
wbc
->
fÜ_»şaim
)

186 
»dœty_out
;

187 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

188 
»dœty_out
;

190 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
META
);

191 
	`wr™e_m‘a_·ge
(
sbi
, 
·ge
);

192 
	`dec_·ge_couÁ
(
sbi
, 
F2FS_DIRTY_META
);

193 
	`uÆock_·ge
(
·ge
);

196 
»dœty_out
:

197 
	`»dœty_·ge_fÜ_wr™•age
(
wbc
, 
·ge
);

198  
AOP_WRITEPAGE_ACTIVATE
;

199 
	}
}

201 
	$f2fs_wr™e_m‘a_·ges
(
add»ss_¥aû
 *
m­pšg
,

202 
wr™eback_cÚŒŞ
 *
wbc
)

204 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_M_SB
(
m­pšg
);

205 
diff
, 
wr™‹n
;

207 
	`Œaû_f2fs_wr™•ages
(
m­pšg
->
ho¡
, 
wbc
, 
META
);

210 ià(
wbc
->
fÜ_kupd©e
 ||

211 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_META
è< 
	`Ä_·ges_to_sk
(sbi, 
META
))

212 
sk_wr™e
;

215 
	`mu‹x_lock
(&
sbi
->
ı_mu‹x
);

216 
diff
 = 
	`Ä_·ges_to_wr™e
(
sbi
, 
META
, 
wbc
);

217 
wr™‹n
 = 
	`sync_m‘a_·ges
(
sbi
, 
META
, 
wbc
->
Ä_to_wr™e
);

218 
	`mu‹x_uÆock
(&
sbi
->
ı_mu‹x
);

219 
wbc
->
Ä_to_wr™e
 = 
	`max
(()0, wbc->Ä_to_wr™- 
wr™‹n
 - 
diff
);

222 
sk_wr™e
:

223 
wbc
->
·ges_sk³d
 +ğ
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_META
);

225 
	}
}

227 
	$sync_m‘a_·ges
(
f2fs_sb_šfo
 *
sbi
, 
·ge_ty³
 
ty³
,

228 
Ä_to_wr™e
)

230 
add»ss_¥aû
 *
m­pšg
 = 
	`META_MAPPING
(
sbi
);

231 
pgoff_t
 
šdex
 = 0, 
’d
 = 
LONG_MAX
;

232 
·gevec
 
pvec
;

233 
nwr™‹n
 = 0;

234 
wr™eback_cÚŒŞ
 
wbc
 = {

235 .
fÜ_»şaim
 = 0,

238 
	`·gevec_š™
(&
pvec
, 0);

240 
šdex
 <ğ
’d
) {

241 
i
, 
Ä_·ges
;

242 
Ä_·ges
 = 
	`·gevec_lookup_g
(&
pvec
, 
m­pšg
, &
šdex
,

243 
PAGECACHE_TAG_DIRTY
,

244 
	`mš
(
’d
 - 
šdex
, (
pgoff_t
)
PAGEVEC_SIZE
-1) + 1);

245 ià(
	`uÆik–y
(
Ä_·ges
 == 0))

248 
i
 = 0; i < 
Ä_·ges
; i++) {

249 
·ge
 *·gğ
pvec
.
·ges
[
i
];

251 
	`lock_·ge
(
·ge
);

253 ià(
	`uÆik–y
(
·ge
->
m­pšg
 != mapping)) {

254 
cÚtšue_uÆock
:

255 
	`uÆock_·ge
(
·ge
);

258 ià(!
	`PageDœty
(
·ge
)) {

260 
cÚtšue_uÆock
;

263 ià(!
	`ş—r_·ge_dœty_fÜ_io
(
·ge
))

264 
cÚtšue_uÆock
;

266 ià(
	`f2fs_wr™e_m‘a_·ge
(
·ge
, &
wbc
)) {

267 
	`uÆock_·ge
(
·ge
);

270 
nwr™‹n
++;

271 ià(
	`uÆik–y
(
nwr™‹n
 >ğ
Ä_to_wr™e
))

274 
	`·gevec_»Ëa£
(&
pvec
);

275 
	`cÚd_»sched
();

278 ià(
nwr™‹n
)

279 
	`f2fs_subm™_m”ged_bio
(
sbi
, 
ty³
, 
WRITE
);

281  
nwr™‹n
;

282 
	}
}

284 
	$f2fs_£t_m‘a_·ge_dœty
(
·ge
 *page)

286 
	`Œaû_f2fs_£t_·ge_dœty
(
·ge
, 
META
);

288 
	`S‘PageU±od©e
(
·ge
);

289 ià(!
	`PageDœty
(
·ge
)) {

290 
	`__£t_·ge_dœty_nobufãrs
(
·ge
);

291 
	`šc_·ge_couÁ
(
	`F2FS_P_SB
(
·ge
), 
F2FS_DIRTY_META
);

295 
	}
}

297 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
	gf2fs_m‘a_aİs
 = {

298 .
wr™•age
 = 
f2fs_wr™e_m‘a_·ge
,

299 .
	gwr™•ages
 = 
f2fs_wr™e_m‘a_·ges
,

300 .
	g£t_·ge_dœty
 = 
f2fs_£t_m‘a_·ge_dœty
,

303 
	$__add_šo_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
, 
ty³
)

305 
šo_’Œy
 *
e
;

306 
»Œy
:

307 
	`¥š_lock
(&
sbi
->
šo_lock
[
ty³
]);

309 
e
 = 
	`¿dix_Œ“_lookup
(&
sbi
->
šo_roÙ
[
ty³
], 
šo
);

310 ià(!
e
) {

311 
e
 = 
	`kmem_ÿche_®loc
(
šo_’Œy_¦ab
, 
GFP_ATOMIC
);

312 ià(!
e
) {

313 
	`¥š_uÆock
(&
sbi
->
šo_lock
[
ty³
]);

314 
»Œy
;

316 ià(
	`¿dix_Œ“_š£¹
(&
sbi
->
šo_roÙ
[
ty³
], 
šo
, 
e
)) {

317 
	`¥š_uÆock
(&
sbi
->
šo_lock
[
ty³
]);

318 
	`kmem_ÿche_ä“
(
šo_’Œy_¦ab
, 
e
);

319 
»Œy
;

321 
	`mem£t
(
e
, 0, (
šo_’Œy
));

322 
e
->
šo
 = ino;

324 
	`li¡_add_
(&
e
->
li¡
, &
sbi
->
šo_li¡
[
ty³
]);

326 
	`¥š_uÆock
(&
sbi
->
šo_lock
[
ty³
]);

327 
	}
}

329 
	$__»move_šo_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
, 
ty³
)

331 
šo_’Œy
 *
e
;

333 
	`¥š_lock
(&
sbi
->
šo_lock
[
ty³
]);

334 
e
 = 
	`¿dix_Œ“_lookup
(&
sbi
->
šo_roÙ
[
ty³
], 
šo
);

335 ià(
e
) {

336 
	`li¡_d–
(&
e
->
li¡
);

337 
	`¿dix_Œ“_d–‘e
(&
sbi
->
šo_roÙ
[
ty³
], 
šo
);

338 ià(
ty³
 =ğ
ORPHAN_INO
)

339 
sbi
->
n_Üphªs
--;

340 
	`¥š_uÆock
(&
sbi
->
šo_lock
[
ty³
]);

341 
	`kmem_ÿche_ä“
(
šo_’Œy_¦ab
, 
e
);

344 
	`¥š_uÆock
(&
sbi
->
šo_lock
[
ty³
]);

345 
	}
}

347 
	$add_dœty_šode
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
, 
ty³
)

350 
	`__add_šo_’Œy
(
sbi
, 
šo
, 
ty³
);

351 
	}
}

353 
	$»move_dœty_šode
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
, 
ty³
)

356 
	`__»move_šo_’Œy
(
sbi
, 
šo
, 
ty³
);

357 
	}
}

360 
boŞ
 
	$exi¡_wr™‹n_d©a
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
, 
mode
)

362 
šo_’Œy
 *
e
;

363 
	`¥š_lock
(&
sbi
->
šo_lock
[
mode
]);

364 
e
 = 
	`¿dix_Œ“_lookup
(&
sbi
->
šo_roÙ
[
mode
], 
šo
);

365 
	`¥š_uÆock
(&
sbi
->
šo_lock
[
mode
]);

366  
e
 ? 
Œue
 : 
çl£
;

367 
	}
}

369 
	$»Ëa£_dœty_šode
(
f2fs_sb_šfo
 *
sbi
)

371 
šo_’Œy
 *
e
, *
tmp
;

372 
i
;

374 
i
 = 
APPEND_INO
; i <ğ
UPDATE_INO
; i++) {

375 
	`¥š_lock
(&
sbi
->
šo_lock
[
i
]);

376 
	`li¡_fÜ_—ch_’Œy_§ã
(
e
, 
tmp
, &
sbi
->
šo_li¡
[
i
], 
li¡
) {

377 
	`li¡_d–
(&
e
->
li¡
);

378 
	`¿dix_Œ“_d–‘e
(&
sbi
->
šo_roÙ
[
i
], 
e
->
šo
);

379 
	`kmem_ÿche_ä“
(
šo_’Œy_¦ab
, 
e
);

381 
	`¥š_uÆock
(&
sbi
->
šo_lock
[
i
]);

383 
	}
}

385 
	$acquœe_Üphª_šode
(
f2fs_sb_šfo
 *
sbi
)

387 
”r
 = 0;

389 
	`¥š_lock
(&
sbi
->
šo_lock
[
ORPHAN_INO
]);

390 ià(
	`uÆik–y
(
sbi
->
n_Üphªs
 >ğsbi->
max_Üphªs
))

391 
”r
 = -
ENOSPC
;

393 
sbi
->
n_Üphªs
++;

394 
	`¥š_uÆock
(&
sbi
->
šo_lock
[
ORPHAN_INO
]);

396  
”r
;

397 
	}
}

399 
	$»Ëa£_Üphª_šode
(
f2fs_sb_šfo
 *
sbi
)

401 
	`¥š_lock
(&
sbi
->
šo_lock
[
ORPHAN_INO
]);

402 
	`f2fs_bug_Ú
(
sbi
, sbi->
n_Üphªs
 == 0);

403 
sbi
->
n_Üphªs
--;

404 
	`¥š_uÆock
(&
sbi
->
šo_lock
[
ORPHAN_INO
]);

405 
	}
}

407 
	$add_Üphª_šode
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
)

410 
	`__add_šo_’Œy
(
sbi
, 
šo
, 
ORPHAN_INO
);

411 
	}
}

413 
	$»move_Üphª_šode
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
)

416 
	`__»move_šo_’Œy
(
sbi
, 
šo
, 
ORPHAN_INO
);

417 
	}
}

419 
	$»cov”_Üphª_šode
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
)

421 
šode
 *šodğ
	`f2fs_ig‘
(
sbi
->
sb
, 
šo
);

422 
	`f2fs_bug_Ú
(
sbi
, 
	`IS_ERR
(
šode
));

423 
	`ş—r_Æšk
(
šode
);

426 
	`ut
(
šode
);

427 
	}
}

429 
	$»cov”_Üphª_šodes
(
f2fs_sb_šfo
 *
sbi
)

431 
block_t
 
¡¬t_blk
, 
Üphª_blkaddr
, 
i
, 
j
;

433 ià(!
	`is_£t_ck±_æags
(
	`F2FS_CKPT
(
sbi
), 
CP_ORPHAN_PRESENT_FLAG
))

436 
sbi
->
pÜ_došg
 = 
Œue
;

438 
¡¬t_blk
 = 
	`__¡¬t_ı_addr
(
sbi
) + 1 +

439 
	`Ë32_to_ıu
(
	`F2FS_RAW_SUPER
(
sbi
)->
ı_·ylßd
);

440 
Üphª_blkaddr
 = 
	`__¡¬t_sum_addr
(
sbi
) - 1;

442 
	`¿_m‘a_·ges
(
sbi
, 
¡¬t_blk
, 
Üphª_blkaddr
, 
META_CP
);

444 
i
 = 0; i < 
Üphª_blkaddr
; i++) {

445 
·ge
 *·gğ
	`g‘_m‘a_·ge
(
sbi
, 
¡¬t_blk
 + 
i
);

446 
f2fs_Üphª_block
 *
Üphª_blk
;

448 
Üphª_blk
 = (
f2fs_Üphª_block
 *)
	`·ge_add»ss
(
·ge
);

449 
j
 = 0; j < 
	`Ë32_to_ıu
(
Üphª_blk
->
’Œy_couÁ
); j++) {

450 
nid_t
 
šo
 = 
	`Ë32_to_ıu
(
Üphª_blk
->šo[
j
]);

451 
	`»cov”_Üphª_šode
(
sbi
, 
šo
);

453 
	`f2fs_put_·ge
(
·ge
, 1);

456 
	`ş—r_ck±_æags
(
	`F2FS_CKPT
(
sbi
), 
CP_ORPHAN_PRESENT_FLAG
);

457 
sbi
->
pÜ_došg
 = 
çl£
;

459 
	}
}

461 
	$wr™e_Üphª_šodes
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
¡¬t_blk
)

463 
li¡_h—d
 *
h—d
;

464 
f2fs_Üphª_block
 *
Üphª_blk
 = 
NULL
;

465 
ÃÁr›s
 = 0;

466 
šdex
;

467 
Üphª_blocks
 =

468 ()
	`GET_ORPHAN_BLOCKS
(
sbi
->
n_Üphªs
);

469 
·ge
 *·gğ
NULL
;

470 
šo_’Œy
 *
Üphª
 = 
NULL
;

472 
šdex
 = 0; index < 
Üphª_blocks
; index++)

473 
	`g¿b_m‘a_·ge
(
sbi
, 
¡¬t_blk
 + 
šdex
);

475 
šdex
 = 1;

476 
	`¥š_lock
(&
sbi
->
šo_lock
[
ORPHAN_INO
]);

477 
h—d
 = &
sbi
->
šo_li¡
[
ORPHAN_INO
];

480 
	`li¡_fÜ_—ch_’Œy
(
Üphª
, 
h—d
, 
li¡
) {

481 ià(!
·ge
) {

482 
·ge
 = 
	`fšd_g‘_·ge
(
	`META_MAPPING
(
sbi
), 
¡¬t_blk
++);

483 
	`f2fs_bug_Ú
(
sbi
, !
·ge
);

484 
Üphª_blk
 =

485 (
f2fs_Üphª_block
 *)
	`·ge_add»ss
(
·ge
);

486 
	`mem£t
(
Üphª_blk
, 0, (*orphan_blk));

487 
	`f2fs_put_·ge
(
·ge
, 0);

490 
Üphª_blk
->
šo
[
ÃÁr›s
++] = 
	`ıu_to_Ë32
(
Üphª
->ino);

492 ià(
ÃÁr›s
 =ğ
F2FS_ORPHANS_PER_BLOCK
) {

498 
Üphª_blk
->
blk_addr
 = 
	`ıu_to_Ë16
(
šdex
);

499 
Üphª_blk
->
blk_couÁ
 = 
	`ıu_to_Ë16
(
Üphª_blocks
);

500 
Üphª_blk
->
’Œy_couÁ
 = 
	`ıu_to_Ë32
(
ÃÁr›s
);

501 
	`£t_·ge_dœty
(
·ge
);

502 
	`f2fs_put_·ge
(
·ge
, 1);

503 
šdex
++;

504 
ÃÁr›s
 = 0;

505 
·ge
 = 
NULL
;

509 ià(
·ge
) {

510 
Üphª_blk
->
blk_addr
 = 
	`ıu_to_Ë16
(
šdex
);

511 
Üphª_blk
->
blk_couÁ
 = 
	`ıu_to_Ë16
(
Üphª_blocks
);

512 
Üphª_blk
->
’Œy_couÁ
 = 
	`ıu_to_Ë32
(
ÃÁr›s
);

513 
	`£t_·ge_dœty
(
·ge
);

514 
	`f2fs_put_·ge
(
·ge
, 1);

517 
	`¥š_uÆock
(&
sbi
->
šo_lock
[
ORPHAN_INO
]);

518 
	}
}

520 
·ge
 *
	$v®id©e_checkpošt
(
f2fs_sb_šfo
 *
sbi
,

521 
block_t
 
ı_addr
, *
v”siÚ
)

523 
·ge
 *
ı_·ge_1
, *
ı_·ge_2
 = 
NULL
;

524 
blk_size
 = 
sbi
->
blocksize
;

525 
f2fs_checkpošt
 *
ı_block
;

526 
cur_v”siÚ
 = 0, 
´e_v”siÚ
 = 0;

527 
size_t
 
üc_off£t
;

528 
__u32
 
üc
 = 0;

531 
ı_·ge_1
 = 
	`g‘_m‘a_·ge
(
sbi
, 
ı_addr
);

534 
ı_block
 = (
f2fs_checkpošt
 *)
	`·ge_add»ss
(
ı_·ge_1
);

535 
üc_off£t
 = 
	`Ë32_to_ıu
(
ı_block
->
checksum_off£t
);

536 ià(
üc_off£t
 >ğ
blk_size
)

537 
šv®id_ı1
;

539 
üc
 = 
	`Ë32_to_ıu
(*((
__u32
 *)((*)
ı_block
 + 
üc_off£t
)));

540 ià(!
	`f2fs_üc_v®id
(
üc
, 
ı_block
, 
üc_off£t
))

541 
šv®id_ı1
;

543 
´e_v”siÚ
 = 
	`cur_ı_v”siÚ
(
ı_block
);

546 
ı_addr
 +ğ
	`Ë32_to_ıu
(
ı_block
->
ı_·ck_tÙ®_block_couÁ
) - 1;

547 
ı_·ge_2
 = 
	`g‘_m‘a_·ge
(
sbi
, 
ı_addr
);

549 
ı_block
 = (
f2fs_checkpošt
 *)
	`·ge_add»ss
(
ı_·ge_2
);

550 
üc_off£t
 = 
	`Ë32_to_ıu
(
ı_block
->
checksum_off£t
);

551 ià(
üc_off£t
 >ğ
blk_size
)

552 
šv®id_ı2
;

554 
üc
 = 
	`Ë32_to_ıu
(*((
__u32
 *)((*)
ı_block
 + 
üc_off£t
)));

555 ià(!
	`f2fs_üc_v®id
(
üc
, 
ı_block
, 
üc_off£t
))

556 
šv®id_ı2
;

558 
cur_v”siÚ
 = 
	`cur_ı_v”siÚ
(
ı_block
);

560 ià(
cur_v”siÚ
 =ğ
´e_v”siÚ
) {

561 *
v”siÚ
 = 
cur_v”siÚ
;

562 
	`f2fs_put_·ge
(
ı_·ge_2
, 1);

563  
ı_·ge_1
;

565 
šv®id_ı2
:

566 
	`f2fs_put_·ge
(
ı_·ge_2
, 1);

567 
šv®id_ı1
:

568 
	`f2fs_put_·ge
(
ı_·ge_1
, 1);

569  
NULL
;

570 
	}
}

572 
	$g‘_v®id_checkpošt
(
f2fs_sb_šfo
 *
sbi
)

574 
f2fs_checkpošt
 *
ı_block
;

575 
f2fs_su³r_block
 *
fsb
 = 
sbi
->
¿w_su³r
;

576 
·ge
 *
ı1
, *
ı2
, *
cur_·ge
;

577 
blk_size
 = 
sbi
->
blocksize
;

578 
ı1_v”siÚ
 = 0, 
ı2_v”siÚ
 = 0;

579 
ı_¡¬t_blk_no
;

580 
ı_blks
 = 1 + 
	`Ë32_to_ıu
(
	`F2FS_RAW_SUPER
(
sbi
)->
ı_·ylßd
);

581 
block_t
 
ı_blk_no
;

582 
i
;

584 
sbi
->
ck±
 = 
	`kz®loc
(
ı_blks
 * 
blk_size
, 
GFP_KERNEL
);

585 ià(!
sbi
->
ck±
)

586  -
ENOMEM
;

592 
ı_¡¬t_blk_no
 = 
	`Ë32_to_ıu
(
fsb
->
ı_blkaddr
);

593 
ı1
 = 
	`v®id©e_checkpošt
(
sbi
, 
ı_¡¬t_blk_no
, &
ı1_v”siÚ
);

596 
ı_¡¬t_blk_no
 += (()1) <<

597 
	`Ë32_to_ıu
(
fsb
->
log_blocks_³r_£g
);

598 
ı2
 = 
	`v®id©e_checkpošt
(
sbi
, 
ı_¡¬t_blk_no
, &
ı2_v”siÚ
);

600 ià(
ı1
 && 
ı2
) {

601 ià(
	`v”_aá”
(
ı2_v”siÚ
, 
ı1_v”siÚ
))

602 
cur_·ge
 = 
ı2
;

604 
cur_·ge
 = 
ı1
;

605 } ià(
ı1
) {

606 
cur_·ge
 = 
ı1
;

607 } ià(
ı2
) {

608 
cur_·ge
 = 
ı2
;

610 
ç_no_ı
;

613 
ı_block
 = (
f2fs_checkpošt
 *)
	`·ge_add»ss
(
cur_·ge
);

614 
	`memıy
(
sbi
->
ck±
, 
ı_block
, 
blk_size
);

616 ià(
ı_blks
 <= 1)

617 
dÚe
;

619 
ı_blk_no
 = 
	`Ë32_to_ıu
(
fsb
->
ı_blkaddr
);

620 ià(
cur_·ge
 =ğ
ı2
)

621 
ı_blk_no
 +ğ1 << 
	`Ë32_to_ıu
(
fsb
->
log_blocks_³r_£g
);

623 
i
 = 1; i < 
ı_blks
; i++) {

624 *
s™_b™m­_±r
;

625 *
ck±
 = (*)
sbi
->ckpt;

627 
cur_·ge
 = 
	`g‘_m‘a_·ge
(
sbi
, 
ı_blk_no
 + 
i
);

628 
s™_b™m­_±r
 = 
	`·ge_add»ss
(
cur_·ge
);

629 
	`memıy
(
ck±
 + 
i
 * 
blk_size
, 
s™_b™m­_±r
, blk_size);

630 
	`f2fs_put_·ge
(
cur_·ge
, 1);

632 
dÚe
:

633 
	`f2fs_put_·ge
(
ı1
, 1);

634 
	`f2fs_put_·ge
(
ı2
, 1);

637 
ç_no_ı
:

638 
	`kä“
(
sbi
->
ck±
);

639  -
EINVAL
;

640 
	}
}

642 
	$__add_dœty_šode
(
šode
 *šode, 
dœ_šode_’Œy
 *
Ãw
)

644 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

646 ià(
	`is_šode_æag_£t
(
	`F2FS_I
(
šode
), 
FI_DIRTY_DIR
))

647  -
EEXIST
;

649 
	`£t_šode_æag
(
	`F2FS_I
(
šode
), 
FI_DIRTY_DIR
);

650 
	`F2FS_I
(
šode
)->
dœty_dœ
 = 
Ãw
;

651 
	`li¡_add_
(&
Ãw
->
li¡
, &
sbi
->
dœ_šode_li¡
);

652 
	`¡©_šc_dœty_dœ
(
sbi
);

654 
	}
}

656 
	$upd©e_dœty_·ge
(
šode
 *šode, 
·ge
 *page)

658 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

659 
dœ_šode_’Œy
 *
Ãw
;

660 
»t
 = 0;

662 ià(!
	`S_ISDIR
(
šode
->
i_mode
è&& !
	`S_ISREG
(inode->i_mode))

665 ià(!
	`S_ISDIR
(
šode
->
i_mode
)) {

666 
	`šode_šc_dœty_·ges
(
šode
);

667 
out
;

670 
Ãw
 = 
	`f2fs_kmem_ÿche_®loc
(
šode_’Œy_¦ab
, 
GFP_NOFS
);

671 
Ãw
->
šode
 = inode;

672 
	`INIT_LIST_HEAD
(&
Ãw
->
li¡
);

674 
	`¥š_lock
(&
sbi
->
dœ_šode_lock
);

675 
»t
 = 
	`__add_dœty_šode
(
šode
, 
Ãw
);

676 
	`šode_šc_dœty_·ges
(
šode
);

677 
	`¥š_uÆock
(&
sbi
->
dœ_šode_lock
);

679 ià(
»t
)

680 
	`kmem_ÿche_ä“
(
šode_’Œy_¦ab
, 
Ãw
);

681 
out
:

682 
	`S‘PagePriv©e
(
·ge
);

683 
	}
}

685 
	$add_dœty_dœ_šode
(
šode
 *inode)

687 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

688 
dœ_šode_’Œy
 *
Ãw
 =

689 
	`f2fs_kmem_ÿche_®loc
(
šode_’Œy_¦ab
, 
GFP_NOFS
);

690 
»t
 = 0;

692 
Ãw
->
šode
 = inode;

693 
	`INIT_LIST_HEAD
(&
Ãw
->
li¡
);

695 
	`¥š_lock
(&
sbi
->
dœ_šode_lock
);

696 
»t
 = 
	`__add_dœty_šode
(
šode
, 
Ãw
);

697 
	`¥š_uÆock
(&
sbi
->
dœ_šode_lock
);

699 ià(
»t
)

700 
	`kmem_ÿche_ä“
(
šode_’Œy_¦ab
, 
Ãw
);

701 
	}
}

703 
	$»move_dœty_dœ_šode
(
šode
 *inode)

705 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

706 
dœ_šode_’Œy
 *
’Œy
;

708 ià(!
	`S_ISDIR
(
šode
->
i_mode
))

711 
	`¥š_lock
(&
sbi
->
dœ_šode_lock
);

712 ià(
	`g‘_dœty_·ges
(
šode
) ||

713 !
	`is_šode_æag_£t
(
	`F2FS_I
(
šode
), 
FI_DIRTY_DIR
)) {

714 
	`¥š_uÆock
(&
sbi
->
dœ_šode_lock
);

718 
’Œy
 = 
	`F2FS_I
(
šode
)->
dœty_dœ
;

719 
	`li¡_d–
(&
’Œy
->
li¡
);

720 
	`F2FS_I
(
šode
)->
dœty_dœ
 = 
NULL
;

721 
	`ş—r_šode_æag
(
	`F2FS_I
(
šode
), 
FI_DIRTY_DIR
);

722 
	`¡©_dec_dœty_dœ
(
sbi
);

723 
	`¥š_uÆock
(&
sbi
->
dœ_šode_lock
);

724 
	`kmem_ÿche_ä“
(
šode_’Œy_¦ab
, 
’Œy
);

727 ià(
	`is_šode_æag_£t
(
	`F2FS_I
(
šode
), 
FI_DELAY_IPUT
)) {

728 
	`ş—r_šode_æag
(
	`F2FS_I
(
šode
), 
FI_DELAY_IPUT
);

729 
	`ut
(
šode
);

731 
	}
}

733 
	$sync_dœty_dœ_šodes
(
f2fs_sb_šfo
 *
sbi
)

735 
li¡_h—d
 *
h—d
;

736 
dœ_šode_’Œy
 *
’Œy
;

737 
šode
 *inode;

739 
»Œy
:

740 
	`¥š_lock
(&
sbi
->
dœ_šode_lock
);

742 
h—d
 = &
sbi
->
dœ_šode_li¡
;

743 ià(
	`li¡_em±y
(
h—d
)) {

744 
	`¥š_uÆock
(&
sbi
->
dœ_šode_lock
);

747 
’Œy
 = 
	`li¡_’Œy
(
h—d
->
Ãxt
, 
dœ_šode_’Œy
, 
li¡
);

748 
šode
 = 
	`ig¿b
(
’Œy
->inode);

749 
	`¥š_uÆock
(&
sbi
->
dœ_šode_lock
);

750 ià(
šode
) {

751 
	`fem­_fd©awr™e
(
šode
->
i_m­pšg
);

752 
	`ut
(
šode
);

758 
	`f2fs_subm™_m”ged_bio
(
sbi
, 
DATA
, 
WRITE
);

760 
»Œy
;

761 
	}
}

766 
	$block_İ”©iÚs
(
f2fs_sb_šfo
 *
sbi
)

768 
wr™eback_cÚŒŞ
 
wbc
 = {

769 .
sync_mode
 = 
WB_SYNC_ALL
,

770 .
Ä_to_wr™e
 = 
LONG_MAX
,

771 .
fÜ_»şaim
 = 0,

773 
blk_¶ug
 
¶ug
;

774 
”r
 = 0;

776 
	`blk_¡¬t_¶ug
(&
¶ug
);

778 #ifdeà
F2FS_DA_MAP


779 
F2FS_PLUG_ON
 = 
Œue
;

782 
»Œy_æush_d’ts
:

783 
	`f2fs_lock_®l
(
sbi
);

785 ià(
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_DENTS
)) {

786 
	`f2fs_uÆock_®l
(
sbi
);

787 
	`sync_dœty_dœ_šodes
(
sbi
);

788 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
))) {

789 
”r
 = -
EIO
;

790 
out
;

792 
»Œy_æush_d’ts
;

799 
»Œy_æush_nodes
:

800 
	`down_wr™e
(&
sbi
->
node_wr™e
);

802 ià(
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_NODES
)) {

803 
	`up_wr™e
(&
sbi
->
node_wr™e
);

804 
	`sync_node_·ges
(
sbi
, 0, &
wbc
);

805 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
))) {

806 
	`f2fs_uÆock_®l
(
sbi
);

807 
”r
 = -
EIO
;

808 
out
;

810 
»Œy_æush_nodes
;

812 
out
:

814 #ifdeà
F2FS_DA_MAP


815 
F2FS_PLUG_ON
 = 
çl£
;

818 
	`blk_fšish_¶ug
(&
¶ug
);

820  
”r
;

821 
	}
}

823 
	$unblock_İ”©iÚs
(
f2fs_sb_šfo
 *
sbi
)

825 
	`up_wr™e
(&
sbi
->
node_wr™e
);

826 
	`f2fs_uÆock_®l
(
sbi
);

827 
	}
}

829 
	$wa™_Ú_®l_·ges_wr™eback
(
f2fs_sb_šfo
 *
sbi
)

831 
	`DEFINE_WAIT
(
wa™
);

834 
	`´•¬e_to_wa™
(&
sbi
->
ı_wa™
, &
wa™
, 
TASK_UNINTERRUPTIBLE
);

836 ià(!
	`g‘_·ges
(
sbi
, 
F2FS_WRITEBACK
))

839 
	`io_scheduË
();

842 
	`fšish_wa™
(&
sbi
->
ı_wa™
, &
wa™
);

843 
	}
}

845 
	$do_checkpošt
(
f2fs_sb_šfo
 *
sbi
, 
ı_cÚŒŞ
 *
ıc
)

847 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

848 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_WARM_NODE
);

849 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

850 
nid_t
 
Ï¡_nid
 = 
nm_i
->
Ãxt_sÿn_nid
;

851 
block_t
 
¡¬t_blk
;

852 
·ge
 *
ı_·ge
;

853 
d©a_sum_blocks
, 
Üphª_blocks
;

854 
__u32
 
üc32
 = 0;

855 *
kaddr
;

856 
i
;

857 
ı_·ylßd_blks
 = 
	`Ë32_to_ıu
(
	`F2FS_RAW_SUPER
(
sbi
)->
ı_·ylßd
);

863 
	`disÿrd_Ãxt_dnode
(
sbi
, 
	`NEXT_FREE_BLKADDR
(sbi, 
cur£g
));

866 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_META
)) {

867 
	`sync_m‘a_·ges
(
sbi
, 
META
, 
LONG_MAX
);

868 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

872 
	`Ãxt_ä“_nid
(
sbi
, &
Ï¡_nid
);

878 
ck±
->
–­£d_time
 = 
	`ıu_to_Ë64
(
	`g‘_mtime
(
sbi
));

879 
ck±
->
v®id_block_couÁ
 = 
	`ıu_to_Ë64
(
	`v®id_u£r_blocks
(
sbi
));

880 
ck±
->
ä“_£gm’t_couÁ
 = 
	`ıu_to_Ë32
(
	`ä“_£gm’ts
(
sbi
));

881 
i
 = 0; i < 
NR_CURSEG_NODE_TYPE
; i++) {

882 
ck±
->
cur_node_£gno
[
i
] =

883 
	`ıu_to_Ë32
(
	`cur£g_£gno
(
sbi
, 
i
 + 
CURSEG_HOT_NODE
));

884 
ck±
->
cur_node_blkoff
[
i
] =

885 
	`ıu_to_Ë16
(
	`cur£g_blkoff
(
sbi
, 
i
 + 
CURSEG_HOT_NODE
));

886 
ck±
->
®loc_ty³
[
i
 + 
CURSEG_HOT_NODE
] =

887 
	`cur£g_®loc_ty³
(
sbi
, 
i
 + 
CURSEG_HOT_NODE
);

889 
i
 = 0; i < 
NR_CURSEG_DATA_TYPE
; i++) {

890 
ck±
->
cur_d©a_£gno
[
i
] =

891 
	`ıu_to_Ë32
(
	`cur£g_£gno
(
sbi
, 
i
 + 
CURSEG_HOT_DATA
));

892 
ck±
->
cur_d©a_blkoff
[
i
] =

893 
	`ıu_to_Ë16
(
	`cur£g_blkoff
(
sbi
, 
i
 + 
CURSEG_HOT_DATA
));

894 
ck±
->
®loc_ty³
[
i
 + 
CURSEG_HOT_DATA
] =

895 
	`cur£g_®loc_ty³
(
sbi
, 
i
 + 
CURSEG_HOT_DATA
);

898 
ck±
->
v®id_node_couÁ
 = 
	`ıu_to_Ë32
(
	`v®id_node_couÁ
(
sbi
));

899 
ck±
->
v®id_šode_couÁ
 = 
	`ıu_to_Ë32
(
	`v®id_šode_couÁ
(
sbi
));

900 
ck±
->
Ãxt_ä“_nid
 = 
	`ıu_to_Ë32
(
Ï¡_nid
);

903 
d©a_sum_blocks
 = 
	`Åages_fÜ_summ¬y_æush
(
sbi
);

904 ià(
d©a_sum_blocks
 < 
NR_CURSEG_DATA_TYPE
)

905 
	`£t_ck±_æags
(
ck±
, 
CP_COMPACT_SUM_FLAG
);

907 
	`ş—r_ck±_æags
(
ck±
, 
CP_COMPACT_SUM_FLAG
);

909 
Üphª_blocks
 = 
	`GET_ORPHAN_BLOCKS
(
sbi
->
n_Üphªs
);

910 
ck±
->
ı_·ck_¡¬t_sum
 = 
	`ıu_to_Ë32
(1 + 
ı_·ylßd_blks
 +

911 
Üphª_blocks
);

913 ià(
ıc
->
»asÚ
 =ğ
CP_UMOUNT
) {

914 
	`£t_ck±_æags
(
ck±
, 
CP_UMOUNT_FLAG
);

915 
ck±
->
ı_·ck_tÙ®_block_couÁ
 = 
	`ıu_to_Ë32
(
F2FS_CP_PACKS
+

916 
ı_·ylßd_blks
 + 
d©a_sum_blocks
 +

917 
Üphª_blocks
 + 
NR_CURSEG_NODE_TYPE
);

919 
	`ş—r_ck±_æags
(
ck±
, 
CP_UMOUNT_FLAG
);

920 
ck±
->
ı_·ck_tÙ®_block_couÁ
 = 
	`ıu_to_Ë32
(
F2FS_CP_PACKS
 +

921 
ı_·ylßd_blks
 + 
d©a_sum_blocks
 +

922 
Üphª_blocks
);

925 ià(
sbi
->
n_Üphªs
)

926 
	`£t_ck±_æags
(
ck±
, 
CP_ORPHAN_PRESENT_FLAG
);

928 
	`ş—r_ck±_æags
(
ck±
, 
CP_ORPHAN_PRESENT_FLAG
);

930 ià(
sbi
->
Ãed_fsck
)

931 
	`£t_ck±_æags
(
ck±
, 
CP_FSCK_FLAG
);

934 
	`g‘_s™_b™m­
(
sbi
, 
	`__b™m­_±r
(sbi, 
SIT_BITMAP
));

935 
	`g‘_Çt_b™m­
(
sbi
, 
	`__b™m­_±r
(sbi, 
NAT_BITMAP
));

937 
üc32
 = 
	`f2fs_üc32
(
ck±
, 
	`Ë32_to_ıu
(ck±->
checksum_off£t
));

938 *((
__Ë32
 *)((*)
ck±
 +

939 
	`Ë32_to_ıu
(
ck±
->
checksum_off£t
)))

940 ğ
	`ıu_to_Ë32
(
üc32
);

942 
¡¬t_blk
 = 
	`__¡¬t_ı_addr
(
sbi
);

945 
ı_·ge
 = 
	`g¿b_m‘a_·ge
(
sbi
, 
¡¬t_blk
++);

946 
kaddr
 = 
	`·ge_add»ss
(
ı_·ge
);

947 
	`memıy
(
kaddr
, 
ck±
, (1 << 
sbi
->
log_blocksize
));

948 
	`£t_·ge_dœty
(
ı_·ge
);

949 
	`f2fs_put_·ge
(
ı_·ge
, 1);

951 
i
 = 1; i < 1 + 
ı_·ylßd_blks
; i++) {

952 
ı_·ge
 = 
	`g¿b_m‘a_·ge
(
sbi
, 
¡¬t_blk
++);

953 
kaddr
 = 
	`·ge_add»ss
(
ı_·ge
);

954 
	`memıy
(
kaddr
, (*)
ck±
 + 
i
 * 
F2FS_BLKSIZE
,

955 (1 << 
sbi
->
log_blocksize
));

956 
	`£t_·ge_dœty
(
ı_·ge
);

957 
	`f2fs_put_·ge
(
ı_·ge
, 1);

960 ià(
sbi
->
n_Üphªs
) {

961 
	`wr™e_Üphª_šodes
(
sbi
, 
¡¬t_blk
);

962 
¡¬t_blk
 +ğ
Üphª_blocks
;

965 
	`wr™e_d©a_summ¬›s
(
sbi
, 
¡¬t_blk
);

966 
¡¬t_blk
 +ğ
d©a_sum_blocks
;

967 ià(
ıc
->
»asÚ
 =ğ
CP_UMOUNT
) {

968 
	`wr™e_node_summ¬›s
(
sbi
, 
¡¬t_blk
);

969 
¡¬t_blk
 +ğ
NR_CURSEG_NODE_TYPE
;

973 
ı_·ge
 = 
	`g¿b_m‘a_·ge
(
sbi
, 
¡¬t_blk
);

974 
kaddr
 = 
	`·ge_add»ss
(
ı_·ge
);

975 
	`memıy
(
kaddr
, 
ck±
, (1 << 
sbi
->
log_blocksize
));

976 
	`£t_·ge_dœty
(
ı_·ge
);

977 
	`f2fs_put_·ge
(
ı_·ge
, 1);

980 
	`wa™_Ú_®l_·ges_wr™eback
(
sbi
);

982 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

985 
	`fem­_fd©awa™_¿nge
(
	`NODE_MAPPING
(
sbi
), 0, 
LONG_MAX
);

986 
	`fem­_fd©awa™_¿nge
(
	`META_MAPPING
(
sbi
), 0, 
LONG_MAX
);

989 
sbi
->
Ï¡_v®id_block_couÁ
 = sbi->
tÙ®_v®id_block_couÁ
;

990 
sbi
->
®loc_v®id_block_couÁ
 = 0;

993 
	`sync_m‘a_·ges
(
sbi
, 
META_FLUSH
, 
LONG_MAX
);

995 
	`»Ëa£_dœty_šode
(
sbi
);

997 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

1000 
	`ş—r_´eä“_£gm’ts
(
sbi
);

1001 
	`F2FS_RESET_SB_DIRT
(
sbi
);

1002 
	}
}

1007 
	$wr™e_checkpošt
(
f2fs_sb_šfo
 *
sbi
, 
ı_cÚŒŞ
 *
ıc
)

1009 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

1010 
ck±_v”
;

1012 
	`Œaû_f2fs_wr™e_checkpošt
(
sbi
->
sb
, 
ıc
->
»asÚ
, "start block_ops");

1014 
	`mu‹x_lock
(&
sbi
->
ı_mu‹x
);

1016 ià(!
sbi
->
s_dœty
 && 
ıc
->
»asÚ
 !ğ
CP_DISCARD
)

1017 
out
;

1018 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

1019 
out
;

1020 ià(
	`block_İ”©iÚs
(
sbi
))

1021 
out
;

1023 
	`Œaû_f2fs_wr™e_checkpošt
(
sbi
->
sb
, 
ıc
->
»asÚ
, "finish block_ops");

1025 
	`f2fs_subm™_m”ged_bio
(
sbi
, 
DATA
, 
WRITE
);

1026 
	`f2fs_subm™_m”ged_bio
(
sbi
, 
NODE
, 
WRITE
);

1027 
	`f2fs_subm™_m”ged_bio
(
sbi
, 
META
, 
WRITE
);

1034 
ck±_v”
 = 
	`cur_ı_v”siÚ
(
ck±
);

1035 
ck±
->
checkpošt_v”
 = 
	`ıu_to_Ë64
(++
ck±_v”
);

1038 
	`æush_Çt_’Œ›s
(
sbi
);

1039 
	`æush_s™_’Œ›s
(
sbi
, 
ıc
);

1042 
	`do_checkpošt
(
sbi
, 
ıc
);

1044 
	`unblock_İ”©iÚs
(
sbi
);

1045 
	`¡©_šc_ı_couÁ
(
sbi
->
¡©_šfo
);

1046 
out
:

1047 
	`mu‹x_uÆock
(&
sbi
->
ı_mu‹x
);

1048 
	`Œaû_f2fs_wr™e_checkpošt
(
sbi
->
sb
, 
ıc
->
»asÚ
, "finish checkpoint");

1049 
	}
}

1051 
	$š™_šo_’Œy_šfo
(
f2fs_sb_šfo
 *
sbi
)

1053 
i
;

1055 
i
 = 0; i < 
MAX_INO_ENTRY
; i++) {

1056 
	`INIT_RADIX_TREE
(&
sbi
->
šo_roÙ
[
i
], 
GFP_ATOMIC
);

1057 
	`¥š_lock_š™
(&
sbi
->
šo_lock
[
i
]);

1058 
	`INIT_LIST_HEAD
(&
sbi
->
šo_li¡
[
i
]);

1067 
sbi
->
n_Üphªs
 = 0;

1068 
sbi
->
max_Üphªs
 = (sbi->
blocks_³r_£g
 - 
F2FS_CP_PACKS
 -

1069 
NR_CURSEG_TYPE
è* 
F2FS_ORPHANS_PER_BLOCK
;

1070 
	}
}

1072 
__š™
 
	$ü—‹_checkpošt_ÿches
()

1074 
šo_’Œy_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("f2fs_ino_entry",

1075 (
šo_’Œy
));

1076 ià(!
šo_’Œy_¦ab
)

1077  -
ENOMEM
;

1078 
šode_’Œy_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("f2fs_dirty_dir_entry",

1079 (
dœ_šode_’Œy
));

1080 ià(!
šode_’Œy_¦ab
) {

1081 
	`kmem_ÿche_de¡roy
(
šo_’Œy_¦ab
);

1082  -
ENOMEM
;

1085 
	}
}

1087 
	$de¡roy_checkpošt_ÿches
()

1089 
	`kmem_ÿche_de¡roy
(
šo_’Œy_¦ab
);

1090 
	`kmem_ÿche_de¡roy
(
šode_’Œy_¦ab
);

1091 
	}
}

	@data.c

11 
	~<lšux/fs.h
>

12 
	~<lšux/f2fs_fs.h
>

13 
	~<lšux/bufãr_h—d.h
>

14 
	~<lšux/m·ge.h
>

15 
	~<lšux/aio.h
>

16 
	~<lšux/wr™eback.h
>

17 
	~<lšux/backšg-dev.h
>

18 
	~<lšux/blkdev.h
>

19 
	~<lšux/bio.h
>

20 
	~<lšux/´eãtch.h
>

22 
	~"f2fs.h
"

23 
	~"node.h
"

24 
	~"£gm’t.h
"

25 
	~<Œaû/ev’ts/f2fs.h
>

27 
	$f2fs_»ad_’d_io
(
bio
 *bio, 
”r
)

29 
bio_vec
 *
bvec
;

30 
i
;

32 
	`bio_fÜ_—ch_£gm’t_®l
(
bvec
, 
bio
, 
i
) {

33 
·ge
 *·gğ
bvec
->
bv_·ge
;

35 ià(!
”r
) {

36 
	`S‘PageU±od©e
(
·ge
);

38 
	`CË¬PageU±od©e
(
·ge
);

39 
	`S‘PageE¼Ü
(
·ge
);

41 
	`uÆock_·ge
(
·ge
);

43 
	`bio_put
(
bio
);

44 
	}
}

46 
	$f2fs_wr™e_’d_io
(
bio
 *bio, 
”r
)

48 
f2fs_sb_šfo
 *
sbi
 = 
bio
->
bi_´iv©e
;

49 
bio_vec
 *
bvec
;

50 
i
;

52 #ifdeà
F2FS_DA_MAP


53 
·ge
* 
dummy_·ge
 = 
NULL
;

54 
boŞ
 
is_dummy_bio
 = 
çl£
;

55 if(
	`uÆik–y
(
bio
->
bi_max_vecs
 =ğ
BIO_MAX_W_DUMMY
)){

56 
is_dummy_bio
 = 
Œue
;

57 
bio
->
bi_max_vecs
--;

61 
	`bio_fÜ_—ch_£gm’t_®l
(
bvec
, 
bio
, 
i
) {

62 
·ge
 *·gğ
bvec
->
bv_·ge
;

64 ià(
	`uÆik–y
(
”r
)) {

65 
	`£t_·ge_dœty
(
·ge
);

66 
	`£t_b™
(
AS_EIO
, &
·ge
->
m­pšg
->
æags
);

67 
	`f2fs_¡İ_checkpošt
(
sbi
);

69 
	`’d_·ge_wr™eback
(
·ge
);

70 
	`dec_·ge_couÁ
(
sbi
, 
F2FS_WRITEBACK
);

72 #ifdeà
F2FS_DA_MAP


74 
dummy_·ge
 = 
·ge
;

78 #ifdeà
F2FS_DA_MAP


80 if(
	`uÆik–y
(
is_dummy_bio
)){

81 if(
dummy_·ge
 !ğ
NULL
)

82 
	`·ge_ÿche_»Ëa£
(
dummy_·ge
);

84 
	`´štk
("ERROR[f2fs_write_end_io] dummy_page has NULL…ointer.\n");

88 ià(
sbi
->
wa™_io
) {

89 
	`com¶‘e
(
sbi
->
wa™_io
);

90 
sbi
->
wa™_io
 = 
NULL
;

93 ià(!
	`g‘_·ges
(
sbi
, 
F2FS_WRITEBACK
) &&

94 !
	`li¡_em±y
(&
sbi
->
ı_wa™
.
sk_li¡
))

95 
	`wake_up
(&
sbi
->
ı_wa™
);

97 
	`bio_put
(
bio
);

98 
	}
}

103 
bio
 *
	$__bio_®loc
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
blk_addr
,

104 
Åages
, 
boŞ
 
is_»ad
)

106 
bio
 *bio;

109 
bio
 = 
	`bio_®loc
(
GFP_NOIO
, 
Åages
);

111 
bio
->
bi_bdev
 = 
sbi
->
sb
->
s_bdev
;

112 
bio
->
bi_™”
.
bi_£ùÜ
 = 
	`SECTOR_FROM_BLOCK
(
blk_addr
);

113 
bio
->
bi_’d_io
 = 
is_»ad
 ? 
f2fs_»ad_’d_io
 : 
f2fs_wr™e_’d_io
;

114 
bio
->
bi_´iv©e
 = 
sbi
;

116  
bio
;

117 
	}
}

119 #ifdeà
F2FS_DA_MAP


129 
boŞ
 
	$f2fs_Ãed_dummy_·ge
(
f2fs_bio_šfo
 *
io
)

131 
Ï¡_block_š_bio
;

132 
Ï¡_block_off£t
;

133 
n_blocks
;

134 
¡¬t_block_š_bio
;

135 
f2fs_sb_šfo
 *
sbi
;

138 if(!
io
->
bio
){

139 
	`´štk
("ERROR[f2fs_need_dummy_page] bio is NULL\n");

140  
çl£
;

142 
sbi
 = 
io
->sbi;

145 
n_blocks
 = 
io
->
bio
->
bi_vút
;

148 
Ï¡_block_š_bio
 = 
io
->last_block_in_bio;

149 
Ï¡_block_off£t
 = 
Ï¡_block_š_bio
 % 4096;

150 
¡¬t_block_š_bio
 = 
Ï¡_block_š_bio
 - 
n_blocks
 + 1;

155 if((
¡¬t_block_š_bio
 >ğ
	`MAIN_BLKADDR
(
sbi
))

156 && (
¡¬t_block_š_bio
 < 
	`MAX_BLKADDR
(
sbi
))

157 && (
n_blocks
 % 
N_PAGE_ALIGN
 != 0)){

159  
Œue
;

162  
çl£
;

163 
	}
}

165 
cur£g_šfo
 *
	$da_g‘_cur£g_i
(
f2fs_bio_šfo
 *
io
, * 
ty³
)

167 
cur£g_šfo
 *
‹mp_cur£g
;

168 
f2fs_sb_šfo
 *
sbi
 = 
io
->sbi;

170 
i
;

172 
block_t
 
Ãxt_blkaddr
;

173 
block_t
 
Ï¡_block_š_bio
 = 
io
->last_block_in_bio;

175 #ifdeà
F2FS_DA_MAP_DBG


176 
	`´štk
(" [JS DBG] da_g‘_cur£g_i, blkaddr: %d\n", 
Ï¡_block_š_bio
);

178 
i
 = 0; i< 
NR_CURSEG_TYPE
; i++){

179 
‹mp_cur£g
 = 
	`CURSEG_I
(
sbi
, 
i
);

180 
Ãxt_blkaddr
 = 
	`NEXT_FREE_BLKADDR
(
sbi
, 
‹mp_cur£g
);

182 #ifdeà
F2FS_DA_MAP_DBG


183 
	`´štk
(" [JS DBG] da_g‘_cur£g_i,‚ext: blkaddr[%d] %d\n",
i
, 
Ãxt_blkaddr
);

185 if(
Ï¡_block_š_bio
 =ğ
Ãxt_blkaddr
 - 1){

186 *
ty³
 = 
i
;

187  
‹mp_cur£g
;

191  
NULL
;

192 
	}
}

201 
	$f2fs_bio_add_dummy_·ge
(
f2fs_bio_šfo
 *
io
)

203 
s™_šfo
 *
s™_i
;

204 
·ge
 *
Ãw_·ge
 = 
NULL
;

205 
bio
* 
p_bio
;

206 
add»ss_¥aû
* 
m­pšg
;

207 
cur£g_šfo
 *
cur£g
;

208 
f2fs_sb_šfo
 *
sbi
;

210 
f2fs_node
 *
º
;

212 
·ge
 *
Ï¡_·ge
;

213 
block_t
 
Ãw_blkaddr
;

215 
ty³
;

216 
vút
;

218 
sbi
 = 
io
->sbi;

219 
p_bio
 = 
io
->
bio
;

220 
vút
 = 
p_bio
->
bi_vút
;

223 
Ï¡_·ge
 = 
p_bio
->
bi_io_vec
[
vút
-1].
bv_·ge
;

225 
m­pšg
 = 
Ï¡_·ge
->mapping;

226 if(
m­pšg
 =ğ
NULL
){

227 
	`´štk
("ERROR[f2fs_bio_add_dummy_page] mapping is NULL!\n");

232 
»³©
:

233 
Ãw_·ge
 = 
	`·ge_ÿche_®loc
(
m­pšg
);

234 if(!
Ãw_·ge
){

235 
	`cÚd_»sched
();

236 
»³©
;

239 
	`£t_·ge_wr™eback
(
Ãw_·ge
);

240 
	`šc_·ge_couÁ
(
sbi
, 
F2FS_WRITEBACK
);

242 
	`uÆock_·ge
(
Ãw_·ge
);

245 if(
vút
 =ğ
	`MAX_BIO_BLOCKS
(
sbi
)){

246 
	`´štk
("ERROR[f2fs_bio_add_dummy_page] bio is full\n");

247 
	`f2fs_put_·ge
(
Ãw_·ge
, 0);

250 
	`bio_add_·ge
(
p_bio
, 
Ãw_·ge
, 
PAGE_CACHE_SIZE
, 0);

253 
p_bio
->
bi_max_vecs
++;

256 
s™_i
 = 
	`SIT_I
(
sbi
);

259 
cur£g
 = 
	`da_g‘_cur£g_i
(
io
, &
ty³
);

260 if(
cur£g
 =ğ
NULL
){

261 
	`´štk
("ERROR[f2fs_bio_add_dummy_page] curseg„eturn NULL\n");

262 
	`f2fs_put_·ge
(
Ãw_·ge
, 0);

267 
	`mu‹x_lock
(&
cur£g
->
cur£g_mu‹x
);

269 
Ãw_blkaddr
 = 
	`NEXT_FREE_BLKADDR
(
sbi
, 
cur£g
);

271 #ifdeà
F2FS_DA_MAP_DBG


272 
	`´štk
(" [JS DBG]‡dd dummyØblkadd¸%d\n", 
Ãw_blkaddr
);

276 
	`mu‹x_lock
(&
s™_i
->
£Áry_lock
);

279 
	`__»äesh_Ãxt_blkoff
(
sbi
, 
cur£g
);

282 
	`¡©_šc_block_couÁ
(
sbi
, 
cur£g
);

285 ià(!
	`__has_cur£g_¥aû
(
sbi
, 
ty³
))

286 
s™_i
->
s_İs
->
	`®loÿ‹_£gm’t
(
sbi
, 
ty³
, 
çl£
);

289 
	`upd©e_s™_’Œy
(
sbi
, 
Ãw_blkaddr
, 1);

290 
	`upd©e_s™_’Œy
(
sbi
, 
Ãw_blkaddr
, -1);

291 
	`loÿ‹_dœty_£gm’t
(
sbi
, 
	`GET_SEGNO
(sbi, 
Ãw_blkaddr
));

294 
	`mu‹x_uÆock
(&
s™_i
->
£Áry_lock
);

297 ià(
Ãw_·ge
 && 
	`IS_NODESEG
(
ty³
)){

298 
º
 = 
	`F2FS_NODE
(
Ï¡_·ge
);

299 if((
º
 !ğ
NULL
è&& (
Ãw_blkaddr
 =ğº->
foÙ”
.
Ãxt_blkaddr
))

300 
	`fl_node_foÙ”_blkaddr
(
Ï¡_·ge
, 
	`NEXT_FREE_BLKADDR
(
sbi
, 
cur£g
));

302 
º
 = 
	`F2FS_NODE
(
Ãw_·ge
);

303 
º
->
foÙ”
.
nid
 = -1;

307 
	`mu‹x_uÆock
(&
cur£g
->
cur£g_mu‹x
);

310 
io
->
Ï¡_block_š_bio
 = 
Ãw_blkaddr
;

312 #ifdeà
F2FS_GET_FS_WAF


313 
dummy_·ge_couÁ
++;

315 
	}
}

325 
	$__subm™_m”ged_bio
(
f2fs_bio_šfo
 *
io
)

327 
f2fs_io_šfo
 *
fio
 = &
io
->fio;

328 
rw
;

330 #ifdeà
F2FS_DA_MAP


331 
boŞ
 
Ãed_dummy_·ge
 = 
çl£
;

333 #ifdeà
F2FS_GET_FS_WORKLOAD


334 
Ï¡_block_š_bio
;

335 
n_blocks
;

336 
¡¬t_block_š_bio
;

337 
ty³
 = -1;

338 
cur£g_šfo
 *
cur£g
;

339 
cur£g
 = 
	`da_g‘_cur£g_i
(
io
, &
ty³
);

342 ià(!
io
->
bio
)

345 
rw
 = 
fio
->rw;

347 ià(
	`is_»ad_io
(
rw
)) {

348 
	`Œaû_f2fs_subm™_»ad_bio
(
io
->
sbi
->
sb
, 
rw
,

349 
fio
->
ty³
, 
io
->
bio
);

350 
	`subm™_bio
(
rw
, 
io
->
bio
);

352 
	`Œaû_f2fs_subm™_wr™e_bio
(
io
->
sbi
->
sb
, 
rw
,

353 
fio
->
ty³
, 
io
->
bio
);

355 #ifdeà
F2FS_DA_MAP


357 
Ãed_dummy_·ge
 = 
	`f2fs_Ãed_dummy_·ge
(
io
);

358 if(
Ãed_dummy_·ge
 =ğ
Œue
)

361 
	`f2fs_bio_add_dummy_·ge
(
io
);

368 ià(
fio
->
ty³
 =ğ
META_FLUSH
) {

369 
	`DECLARE_COMPLETION_ONSTACK
(
wa™
);

370 
io
->
sbi
->
wa™_io
 = &
wa™
;

371 
	`subm™_bio
(
rw
, 
io
->
bio
);

372 
	`wa™_fÜ_com¶‘iÚ
(&
wa™
);

374 
	`subm™_bio
(
rw
, 
io
->
bio
);

378 #ifdeà
F2FS_GET_FS_WORKLOAD


380 
n_blocks
 = 
io
->
bio
->
bi_vút
;

383 
Ï¡_block_š_bio
 = 
io
->last_block_in_bio;

384 
¡¬t_block_š_bio
 = 
Ï¡_block_š_bio
 - 
n_blocks
 + 1;

386 
	`´štk
("N\t%d\t%d\t%d\t%d\n", 
¡¬t_block_š_bio
, 
n_blocks
, 
ty³
, 
cu¼’t
->
pid
);

389 #ifdeà
F2FS_GET_FS_WAF


390 if(!
	`is_»ad_io
(
fio
->
rw
)){

391 
Ën_fs_wr™e
 +ğ
io
->
bio
->
bi_vút
 * 4096;

395 
io
->
bio
 = 
NULL
;

396 
	}
}

398 
	$f2fs_subm™_m”ged_bio
(
f2fs_sb_šfo
 *
sbi
,

399 
·ge_ty³
 
ty³
, 
rw
)

401 
·ge_ty³
 
bty³
 = 
	`PAGE_TYPE_OF_BIO
(
ty³
);

402 
f2fs_bio_šfo
 *
io
;

404 
io
 = 
	`is_»ad_io
(
rw
è? &
sbi
->
»ad_io
 : &sbi->
wr™e_io
[
bty³
];

406 
	`down_wr™e
(&
io
->
io_rw£m
);

409 ià(
ty³
 >ğ
META_FLUSH
) {

410 
io
->
fio
.
ty³
 = 
META_FLUSH
;

411 ià(
	`‹¡_İt
(
sbi
, 
NOBARRIER
))

412 
io
->
fio
.
rw
 = 
WRITE_FLUSH
 | 
REQ_META
 | 
REQ_PRIO
;

414 
io
->
fio
.
rw
 = 
WRITE_FLUSH_FUA
 | 
REQ_META
 | 
REQ_PRIO
;

417 
	`__subm™_m”ged_bio
(
io
);

418 
	`up_wr™e
(&
io
->
io_rw£m
);

419 
	}
}

425 
	$f2fs_subm™_·ge_bio
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page,

426 
block_t
 
blk_addr
, 
rw
)

428 
bio
 *bio;

430 
	`Œaû_f2fs_subm™_·ge_bio
(
·ge
, 
blk_addr
, 
rw
);

433 
bio
 = 
	`__bio_®loc
(
sbi
, 
blk_addr
, 1, 
	`is_»ad_io
(
rw
));

435 ià(
	`bio_add_·ge
(
bio
, 
·ge
, 
PAGE_CACHE_SIZE
, 0) < PAGE_CACHE_SIZE) {

436 
	`bio_put
(
bio
);

437 
	`f2fs_put_·ge
(
·ge
, 1);

438  -
EFAULT
;

441 #ifdeà
F2FS_GET_FS_WAF


442 if(!
	`is_»ad_io
(
rw
)){

443 
Ën_fs_wr™e
 +ğ
bio
->
bi_vút
 * 4096;

447 
	`subm™_bio
(
rw
, 
bio
);

449 
	}
}

451 #ifdeà
F2FS_DA_MAP


452 
	$f2fs_subm™_·ge_mbio
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page,

453 
block_t
 
blk_addr
, 
f2fs_io_šfo
 *
fio
, 
f2fs_da_io_šfo
* 
dio
)

455 
	$f2fs_subm™_·ge_mbio
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page,

456 
block_t
 
blk_addr
, 
f2fs_io_šfo
 *
fio
)

459 
·ge_ty³
 
bty³
 = 
	`PAGE_TYPE_OF_BIO
(
fio
->
ty³
);

460 
f2fs_bio_šfo
 *
io
;

461 
boŞ
 
is_»ad
 = 
	`is_»ad_io
(
fio
->
rw
);

463 #ifdeà
F2FS_DA_MAP


464 
boŞ
 
bio_was_fuÎ
 = 
çl£
;

466 
io
 = 
is_»ad
 ? &
sbi
->
»ad_io
 : &sbi->
wr™e_io
[
bty³
];

468 
	`v”ify_block_addr
(
sbi
, 
blk_addr
);

470 
	`down_wr™e
(&
io
->
io_rw£m
);

472 ià(!
is_»ad
)

473 
	`šc_·ge_couÁ
(
sbi
, 
F2FS_WRITEBACK
);

475 #ifdeà
F2FS_DA_MAP


476 ià(
dio
 !ğ
NULL
 && (
F2FS_PLUG_ON
 =ğ
Œue
)){

477 if(
	`IS_NODESEG
(
dio
->
ty³
) &&

478 !
is_»ad
 &&

479 (
io
->
Ï¡_block_š_bio
 =ğ
blk_addr
 - 1) &&

480 (
fio
->
rw
 =ğ
WRITE_SYNC
) &&

481 (
io
->
fio
.
rw
 != fio->rw)){

483 
io
->
fio
.
rw
 = fio->rw;

488 ià(
io
->
bio
 && (io->
Ï¡_block_š_bio
 !ğ
blk_addr
 - 1 ||

489 
io
->
fio
.
rw
 != fio->rw)){

490 
	`__subm™_m”ged_bio
(
io
);

493 
®loc_Ãw
:

494 #ifdeà
F2FS_DA_MAP


495 if((
dio
 !ğ
NULL
è&& (!
bio_was_fuÎ
è&& !
is_»ad
){

496 
	`®loÿ‹_d©a_block
(
sbi
, 
·ge
, 
dio
->
Şd_blkaddr
, &
blk_addr
, dio->
sum
, dio->
ty³
);

497 
dio
->
Şd_blkaddr
 = 
blk_addr
;

498 #ifdeà
F2FS_DA_MAP_DBG


499 
	`´štk
(" [JS DBG] f2fs_subm™_·ge_mbio,‚ew blkaddr: %d\n", 
blk_addr
);

504 ià(
io
->
bio
 =ğ
NULL
) {

505 
bio_blocks
 = 
	`MAX_BIO_BLOCKS
(
sbi
);

507 
io
->
bio
 = 
	`__bio_®loc
(
sbi
, 
blk_addr
, 
bio_blocks
, 
is_»ad
);

508 
io
->
fio
 = *fio;

511 ià(
	`bio_add_·ge
(
io
->
bio
, 
·ge
, 
PAGE_CACHE_SIZE
, 0) <

512 
PAGE_CACHE_SIZE
) {

513 
	`__subm™_m”ged_bio
(
io
);

514 #ifdeà
F2FS_DA_MAP


515 
bio_was_fuÎ
 = 
Œue
;

518 
®loc_Ãw
;

521 
io
->
Ï¡_block_š_bio
 = 
blk_addr
;

523 
	`up_wr™e
(&
io
->
io_rw£m
);

524 
	`Œaû_f2fs_subm™_·ge_mbio
(
·ge
, 
fio
->
rw
, fio->
ty³
, 
blk_addr
);

525 
	}
}

533 
	$__£t_d©a_blkaddr
(
dnode_of_d©a
 *
dn
, 
block_t
 
Ãw_addr
)

535 
f2fs_node
 *
º
;

536 
__Ë32
 *
addr_¬¿y
;

537 
·ge
 *
node_·ge
 = 
dn
->node_page;

538 
ofs_š_node
 = 
dn
->ofs_in_node;

540 
	`f2fs_wa™_Ú_·ge_wr™eback
(
node_·ge
, 
NODE
);

542 
º
 = 
	`F2FS_NODE
(
node_·ge
);

545 
addr_¬¿y
 = 
	`blkaddr_š_node
(
º
);

546 
addr_¬¿y
[
ofs_š_node
] = 
	`ıu_to_Ë32
(
Ãw_addr
);

547 
	`£t_·ge_dœty
(
node_·ge
);

548 
	}
}

550 
	$»£rve_Ãw_block
(
dnode_of_d©a
 *
dn
)

552 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dn
->
šode
);

554 ià(
	`uÆik–y
(
	`is_šode_æag_£t
(
	`F2FS_I
(
dn
->
šode
), 
FI_NO_ALLOC
)))

555  -
EPERM
;

556 ià(
	`uÆik–y
(!
	`šc_v®id_block_couÁ
(
sbi
, 
dn
->
šode
, 1)))

557  -
ENOSPC
;

559 
	`Œaû_f2fs_»£rve_Ãw_block
(
dn
->
šode
, dn->
nid
, dn->
ofs_š_node
);

561 
	`__£t_d©a_blkaddr
(
dn
, 
NEW_ADDR
);

562 
dn
->
d©a_blkaddr
 = 
NEW_ADDR
;

563 
	`m¬k_šode_dœty
(
dn
->
šode
);

564 
	`sync_šode_·ge
(
dn
);

566 
	}
}

568 
	$f2fs_»£rve_block
(
dnode_of_d©a
 *
dn
, 
pgoff_t
 
šdex
)

570 
boŞ
 
Ãed_put
 = 
dn
->
šode_·ge
 ? 
çl£
 : 
Œue
;

571 
”r
;

574 
	`f2fs_bug_Ú
(
	`F2FS_I_SB
(
dn
->
šode
), !
Ãed_put
 && 
šdex
);

576 
”r
 = 
	`g‘_dnode_of_d©a
(
dn
, 
šdex
, 
ALLOC_NODE
);

577 ià(
”r
)

578  
”r
;

580 ià(
dn
->
d©a_blkaddr
 =ğ
NULL_ADDR
)

581 
”r
 = 
	`»£rve_Ãw_block
(
dn
);

582 ià(
”r
 || 
Ãed_put
)

583 
	`f2fs_put_dnode
(
dn
);

584  
”r
;

585 
	}
}

587 
	$check_ex‹Á_ÿche
(
šode
 *šode, 
pgoff_t
 
pgofs
,

588 
bufãr_h—d
 *
bh_»suÉ
)

590 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

591 
pgoff_t
 
¡¬t_fofs
, 
’d_fofs
;

592 
block_t
 
¡¬t_blkaddr
;

594 ià(
	`is_šode_æag_£t
(
fi
, 
FI_NO_EXTENT
))

597 
	`»ad_lock
(&
fi
->
ext
.
ext_lock
);

598 ià(
fi
->
ext
.
Ën
 == 0) {

599 
	`»ad_uÆock
(&
fi
->
ext
.
ext_lock
);

603 
	`¡©_šc_tÙ®_h™
(
šode
->
i_sb
);

605 
¡¬t_fofs
 = 
fi
->
ext
.
fofs
;

606 
’d_fofs
 = 
fi
->
ext
.
fofs
 + fi->ext.
Ën
 - 1;

607 
¡¬t_blkaddr
 = 
fi
->
ext
.
blk_addr
;

609 ià(
pgofs
 >ğ
¡¬t_fofs
 &&…gof <ğ
’d_fofs
) {

610 
blkb™s
 = 
šode
->
i_sb
->
s_blocksize_b™s
;

611 
size_t
 
couÁ
;

613 
	`ş—r_bufãr_Ãw
(
bh_»suÉ
);

614 
	`m­_bh
(
bh_»suÉ
, 
šode
->
i_sb
,

615 
¡¬t_blkaddr
 + 
pgofs
 - 
¡¬t_fofs
);

616 
couÁ
 = 
’d_fofs
 - 
pgofs
 + 1;

617 ià(
couÁ
 < (
UINT_MAX
 >> 
blkb™s
))

618 
bh_»suÉ
->
b_size
 = (
couÁ
 << 
blkb™s
);

620 
bh_»suÉ
->
b_size
 = 
UINT_MAX
;

622 
	`¡©_šc_»ad_h™
(
šode
->
i_sb
);

623 
	`»ad_uÆock
(&
fi
->
ext
.
ext_lock
);

626 
	`»ad_uÆock
(&
fi
->
ext
.
ext_lock
);

628 
	}
}

630 
	$upd©e_ex‹Á_ÿche
(
block_t
 
blk_addr
, 
dnode_of_d©a
 *
dn
)

632 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
dn
->
šode
);

633 
pgoff_t
 
fofs
, 
¡¬t_fofs
, 
’d_fofs
;

634 
block_t
 
¡¬t_blkaddr
, 
’d_blkaddr
;

635 
Ãed_upd©e
 = 
Œue
;

637 
	`f2fs_bug_Ú
(
	`F2FS_I_SB
(
dn
->
šode
), 
blk_addr
 =ğ
NEW_ADDR
);

638 
fofs
 = 
	`¡¬t_bidx_of_node
(
	`ofs_of_node
(
dn
->
node_·ge
), 
fi
) +

639 
dn
->
ofs_š_node
;

642 
	`__£t_d©a_blkaddr
(
dn
, 
blk_addr
);

644 ià(
	`is_šode_æag_£t
(
fi
, 
FI_NO_EXTENT
))

647 
	`wr™e_lock
(&
fi
->
ext
.
ext_lock
);

649 
¡¬t_fofs
 = 
fi
->
ext
.
fofs
;

650 
’d_fofs
 = 
fi
->
ext
.
fofs
 + fi->ext.
Ën
 - 1;

651 
¡¬t_blkaddr
 = 
fi
->
ext
.
blk_addr
;

652 
’d_blkaddr
 = 
fi
->
ext
.
blk_addr
 + fi->ext.
Ën
 - 1;

655 ià(
fi
->
ext
.
Ën
 =ğ1 && 
fofs
 =ğ
¡¬t_fofs
)

656 
fi
->
ext
.
Ën
 = 0;

659 ià(
fi
->
ext
.
Ën
 == 0) {

660 ià(
blk_addr
 !ğ
NULL_ADDR
) {

661 
fi
->
ext
.
fofs
 = fofs;

662 
fi
->
ext
.
blk_addr
 = blk_addr;

663 
fi
->
ext
.
Ën
 = 1;

665 
’d_upd©e
;

669 ià(
fofs
 =ğ
¡¬t_fofs
 - 1 && 
blk_addr
 =ğ
¡¬t_blkaddr
 - 1) {

670 
fi
->
ext
.
fofs
--;

671 
fi
->
ext
.
blk_addr
--;

672 
fi
->
ext
.
Ën
++;

673 
’d_upd©e
;

677 ià(
fofs
 =ğ
’d_fofs
 + 1 && 
blk_addr
 =ğ
’d_blkaddr
 + 1) {

678 
fi
->
ext
.
Ën
++;

679 
’d_upd©e
;

683 ià(
fi
->
ext
.
Ën
 > 1 &&

684 
fofs
 >ğ
¡¬t_fofs
 && fof <ğ
’d_fofs
) {

685 ià((
’d_fofs
 - 
fofs
è< (
fi
->
ext
.
Ën
 >> 1)) {

686 
fi
->
ext
.
Ën
 = 
fofs
 - 
¡¬t_fofs
;

688 
fi
->
ext
.
fofs
 = fofs + 1;

689 
fi
->
ext
.
blk_addr
 = 
¡¬t_blkaddr
 +

690 
fofs
 - 
¡¬t_fofs
 + 1;

691 
fi
->
ext
.
Ën
 -ğ
fofs
 - 
¡¬t_fofs
 + 1;

694 
Ãed_upd©e
 = 
çl£
;

698 ià(
fi
->
ext
.
Ën
 < 
F2FS_MIN_EXTENT_LEN
) {

699 
fi
->
ext
.
Ën
 = 0;

700 
	`£t_šode_æag
(
fi
, 
FI_NO_EXTENT
);

701 
Ãed_upd©e
 = 
Œue
;

703 
’d_upd©e
:

704 
	`wr™e_uÆock
(&
fi
->
ext
.
ext_lock
);

705 ià(
Ãed_upd©e
)

706 
	`sync_šode_·ge
(
dn
);

708 
	}
}

710 
·ge
 *
	$fšd_d©a_·ge
(
šode
 *šode, 
pgoff_t
 
šdex
, 
boŞ
 
sync
)

712 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

713 
dnode_of_d©a
 
dn
;

714 
·ge
 *page;

715 
”r
;

717 
·ge
 = 
	`fšd_g‘_·ge
(
m­pšg
, 
šdex
);

718 ià(
·ge
 && 
	`PageU±od©e
(page))

719  
·ge
;

720 
	`f2fs_put_·ge
(
·ge
, 0);

722 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

723 
”r
 = 
	`g‘_dnode_of_d©a
(&
dn
, 
šdex
, 
LOOKUP_NODE
);

724 ià(
”r
)

725  
	`ERR_PTR
(
”r
);

726 
	`f2fs_put_dnode
(&
dn
);

728 ià(
dn
.
d©a_blkaddr
 =ğ
NULL_ADDR
)

729  
	`ERR_PTR
(-
ENOENT
);

732 ià(
	`uÆik–y
(
dn
.
d©a_blkaddr
 =ğ
NEW_ADDR
))

733  
	`ERR_PTR
(-
EINVAL
);

735 
·ge
 = 
	`g¿b_ÿche_·ge
(
m­pšg
, 
šdex
);

736 ià(!
·ge
)

737  
	`ERR_PTR
(-
ENOMEM
);

739 ià(
	`PageU±od©e
(
·ge
)) {

740 
	`uÆock_·ge
(
·ge
);

741  
·ge
;

744 
”r
 = 
	`f2fs_subm™_·ge_bio
(
	`F2FS_I_SB
(
šode
), 
·ge
, 
dn
.
d©a_blkaddr
,

745 
sync
 ? 
READ_SYNC
 : 
READA
);

746 ià(
”r
)

747  
	`ERR_PTR
(
”r
);

749 ià(
sync
) {

750 
	`wa™_Ú_·ge_locked
(
·ge
);

751 ià(
	`uÆik–y
(!
	`PageU±od©e
(
·ge
))) {

752 
	`f2fs_put_·ge
(
·ge
, 0);

753  
	`ERR_PTR
(-
EIO
);

756  
·ge
;

757 
	}
}

764 
·ge
 *
	$g‘_lock_d©a_·ge
(
šode
 *šode, 
pgoff_t
 
šdex
)

766 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

767 
dnode_of_d©a
 
dn
;

768 
·ge
 *page;

769 
”r
;

771 
»³©
:

772 
·ge
 = 
	`g¿b_ÿche_·ge
(
m­pšg
, 
šdex
);

773 ià(!
·ge
)

774  
	`ERR_PTR
(-
ENOMEM
);

776 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

777 
”r
 = 
	`g‘_dnode_of_d©a
(&
dn
, 
šdex
, 
LOOKUP_NODE
);

778 ià(
”r
) {

779 
	`f2fs_put_·ge
(
·ge
, 1);

780  
	`ERR_PTR
(
”r
);

782 
	`f2fs_put_dnode
(&
dn
);

784 ià(
	`uÆik–y
(
dn
.
d©a_blkaddr
 =ğ
NULL_ADDR
)) {

785 
	`f2fs_put_·ge
(
·ge
, 1);

786  
	`ERR_PTR
(-
ENOENT
);

789 ià(
	`PageU±od©e
(
·ge
))

790  
·ge
;

798 ià(
dn
.
d©a_blkaddr
 =ğ
NEW_ADDR
) {

799 
	`z”o_u£r_£gm’t
(
·ge
, 0, 
PAGE_CACHE_SIZE
);

800 
	`S‘PageU±od©e
(
·ge
);

801  
·ge
;

804 
”r
 = 
	`f2fs_subm™_·ge_bio
(
	`F2FS_I_SB
(
šode
), 
·ge
,

805 
dn
.
d©a_blkaddr
, 
READ_SYNC
);

806 ià(
”r
)

807  
	`ERR_PTR
(
”r
);

809 
	`lock_·ge
(
·ge
);

810 ià(
	`uÆik–y
(!
	`PageU±od©e
(
·ge
))) {

811 
	`f2fs_put_·ge
(
·ge
, 1);

812  
	`ERR_PTR
(-
EIO
);

814 ià(
	`uÆik–y
(
·ge
->
m­pšg
 != mapping)) {

815 
	`f2fs_put_·ge
(
·ge
, 1);

816 
»³©
;

818  
·ge
;

819 
	}
}

829 
·ge
 *
	$g‘_Ãw_d©a_·ge
(
šode
 *inode,

830 
·ge
 *
age
, 
pgoff_t
 
šdex
, 
boŞ
 
Ãw_i_size
)

832 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

833 
·ge
 *page;

834 
dnode_of_d©a
 
dn
;

835 
”r
;

837 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
age
, 
NULL
, 0);

838 
”r
 = 
	`f2fs_»£rve_block
(&
dn
, 
šdex
);

839 ià(
”r
)

840  
	`ERR_PTR
(
”r
);

841 
»³©
:

842 
·ge
 = 
	`g¿b_ÿche_·ge
(
m­pšg
, 
šdex
);

843 ià(!
·ge
) {

844 
”r
 = -
ENOMEM
;

845 
put_”r
;

848 ià(
	`PageU±od©e
(
·ge
))

849  
·ge
;

851 ià(
dn
.
d©a_blkaddr
 =ğ
NEW_ADDR
) {

852 
	`z”o_u£r_£gm’t
(
·ge
, 0, 
PAGE_CACHE_SIZE
);

853 
	`S‘PageU±od©e
(
·ge
);

856 
”r
 = 
	`f2fs_subm™_·ge_bio
(
	`F2FS_I_SB
(
šode
), 
·ge
,

857 
dn
.
d©a_blkaddr
, 
READ_SYNC
);

858 ià(
”r
)

859 
put_”r
;

861 
	`lock_·ge
(
·ge
);

862 ià(
	`uÆik–y
(!
	`PageU±od©e
(
·ge
))) {

863 
	`f2fs_put_·ge
(
·ge
, 1);

864 
”r
 = -
EIO
;

865 
put_”r
;

867 ià(
	`uÆik–y
(
·ge
->
m­pšg
 != mapping)) {

868 
	`f2fs_put_·ge
(
·ge
, 1);

869 
»³©
;

873 ià(
Ãw_i_size
 &&

874 
	`i_size_»ad
(
šode
è< ((
šdex
 + 1è<< 
PAGE_CACHE_SHIFT
)) {

875 
	`i_size_wr™e
(
šode
, ((
šdex
 + 1è<< 
PAGE_CACHE_SHIFT
));

877 
	`£t_šode_æag
(
	`F2FS_I
(
šode
), 
FI_UPDATE_DIR
);

879  
·ge
;

881 
put_”r
:

882 
	`f2fs_put_dnode
(&
dn
);

883  
	`ERR_PTR
(
”r
);

884 
	}
}

886 
	$__®loÿ‹_d©a_block
(
dnode_of_d©a
 *
dn
)

888 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dn
->
šode
);

889 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
dn
->
šode
);

890 
f2fs_summ¬y
 
sum
;

891 
block_t
 
Ãw_blkaddr
;

892 
node_šfo
 
ni
;

893 
pgoff_t
 
fofs
;

894 
ty³
;

896 ià(
	`uÆik–y
(
	`is_šode_æag_£t
(
	`F2FS_I
(
dn
->
šode
), 
FI_NO_ALLOC
)))

897  -
EPERM
;

898 ià(
	`uÆik–y
(!
	`šc_v®id_block_couÁ
(
sbi
, 
dn
->
šode
, 1)))

899  -
ENOSPC
;

901 
	`__£t_d©a_blkaddr
(
dn
, 
NEW_ADDR
);

902 
dn
->
d©a_blkaddr
 = 
NEW_ADDR
;

904 
	`g‘_node_šfo
(
sbi
, 
dn
->
nid
, &
ni
);

905 
	`£t_summ¬y
(&
sum
, 
dn
->
nid
, dn->
ofs_š_node
, 
ni
.
v”siÚ
);

907 
ty³
 = 
CURSEG_WARM_DATA
;

909 
	`®loÿ‹_d©a_block
(
sbi
, 
NULL
, 
NULL_ADDR
, &
Ãw_blkaddr
, &
sum
, 
ty³
);

912 
	`£t_šode_æag
(
	`F2FS_I
(
dn
->
šode
), 
FI_NO_EXTENT
);

913 
	`upd©e_ex‹Á_ÿche
(
Ãw_blkaddr
, 
dn
);

914 
	`ş—r_šode_æag
(
	`F2FS_I
(
dn
->
šode
), 
FI_NO_EXTENT
);

917 
fofs
 = 
	`¡¬t_bidx_of_node
(
	`ofs_of_node
(
dn
->
node_·ge
), 
fi
) +

918 
dn
->
ofs_š_node
;

919 ià(
	`i_size_»ad
(
dn
->
šode
è< ((
fofs
 + 1è<< 
PAGE_CACHE_SHIFT
))

920 
	`i_size_wr™e
(
dn
->
šode
, ((
fofs
 + 1è<< 
PAGE_CACHE_SHIFT
));

922 
dn
->
d©a_blkaddr
 = 
Ãw_blkaddr
;

924 
	}
}

934 
	$__g‘_d©a_block
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

935 
bufãr_h—d
 *
bh_»suÉ
, 
ü—‹
, 
boŞ
 
f›m­
)

937 
blkb™s
 = 
šode
->
i_sb
->
s_blocksize_b™s
;

938 
maxblocks
 = 
bh_»suÉ
->
b_size
 >> 
blkb™s
;

939 
dnode_of_d©a
 
dn
;

940 
mode
 = 
ü—‹
 ? 
ALLOC_NODE
 : 
LOOKUP_NODE_RA
;

941 
pgoff_t
 
pgofs
, 
’d_off£t
;

942 
”r
 = 0, 
ofs
 = 1;

943 
boŞ
 
®loÿ‹d
 = 
çl£
;

946 
pgofs
 = (
pgoff_t
)(
iblock
 >> (
PAGE_CACHE_SHIFT
 - 
blkb™s
));

948 ià(
	`check_ex‹Á_ÿche
(
šode
, 
pgofs
, 
bh_»suÉ
))

949 
out
;

951 ià(
ü—‹
) {

952 
	`f2fs_b®ªû_fs
(
	`F2FS_I_SB
(
šode
));

953 
	`f2fs_lock_İ
(
	`F2FS_I_SB
(
šode
));

957 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

958 
”r
 = 
	`g‘_dnode_of_d©a
(&
dn
, 
pgofs
, 
mode
);

959 ià(
”r
) {

960 ià(
”r
 =ğ-
ENOENT
)

961 
”r
 = 0;

962 
uÆock_out
;

964 ià(
dn
.
d©a_blkaddr
 =ğ
NEW_ADDR
 && !
f›m­
)

965 
put_out
;

967 ià(
dn
.
d©a_blkaddr
 !ğ
NULL_ADDR
) {

968 
	`m­_bh
(
bh_»suÉ
, 
šode
->
i_sb
, 
dn
.
d©a_blkaddr
);

969 } ià(
ü—‹
) {

970 
”r
 = 
	`__®loÿ‹_d©a_block
(&
dn
);

971 ià(
”r
)

972 
put_out
;

973 
®loÿ‹d
 = 
Œue
;

974 
	`m­_bh
(
bh_»suÉ
, 
šode
->
i_sb
, 
dn
.
d©a_blkaddr
);

976 
put_out
;

979 
’d_off£t
 = 
	`ADDRS_PER_PAGE
(
dn
.
node_·ge
, 
	`F2FS_I
(
šode
));

980 
bh_»suÉ
->
b_size
 = (((
size_t
)1è<< 
blkb™s
);

981 
dn
.
ofs_š_node
++;

982 
pgofs
++;

984 
g‘_Ãxt
:

985 ià(
dn
.
ofs_š_node
 >ğ
’d_off£t
) {

986 ià(
®loÿ‹d
)

987 
	`sync_šode_·ge
(&
dn
);

988 
®loÿ‹d
 = 
çl£
;

989 
	`f2fs_put_dnode
(&
dn
);

991 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

992 
”r
 = 
	`g‘_dnode_of_d©a
(&
dn
, 
pgofs
, 
mode
);

993 ià(
”r
) {

994 ià(
”r
 =ğ-
ENOENT
)

995 
”r
 = 0;

996 
uÆock_out
;

998 ià(
dn
.
d©a_blkaddr
 =ğ
NEW_ADDR
 && !
f›m­
)

999 
put_out
;

1001 
’d_off£t
 = 
	`ADDRS_PER_PAGE
(
dn
.
node_·ge
, 
	`F2FS_I
(
šode
));

1004 ià(
maxblocks
 > (
bh_»suÉ
->
b_size
 >> 
blkb™s
)) {

1005 
block_t
 
blkaddr
 = 
	`d©ablock_addr
(
dn
.
node_·ge
, dn.
ofs_š_node
);

1006 ià(
blkaddr
 =ğ
NULL_ADDR
 && 
ü—‹
) {

1007 
”r
 = 
	`__®loÿ‹_d©a_block
(&
dn
);

1008 ià(
”r
)

1009 
sync_out
;

1010 
®loÿ‹d
 = 
Œue
;

1011 
blkaddr
 = 
dn
.
d©a_blkaddr
;

1014 ià(
blkaddr
 =ğ(
bh_»suÉ
->
b_blockÄ
 + 
ofs
)) {

1015 
ofs
++;

1016 
dn
.
ofs_š_node
++;

1017 
pgofs
++;

1018 
bh_»suÉ
->
b_size
 +ğ(((
size_t
)1è<< 
blkb™s
);

1019 
g‘_Ãxt
;

1022 
sync_out
:

1023 ià(
®loÿ‹d
)

1024 
	`sync_šode_·ge
(&
dn
);

1025 
put_out
:

1026 
	`f2fs_put_dnode
(&
dn
);

1027 
uÆock_out
:

1028 ià(
ü—‹
)

1029 
	`f2fs_uÆock_İ
(
	`F2FS_I_SB
(
šode
));

1030 
out
:

1031 
	`Œaû_f2fs_g‘_d©a_block
(
šode
, 
iblock
, 
bh_»suÉ
, 
”r
);

1032  
”r
;

1033 
	}
}

1035 
	$g‘_d©a_block
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

1036 
bufãr_h—d
 *
bh_»suÉ
, 
ü—‹
)

1038  
	`__g‘_d©a_block
(
šode
, 
iblock
, 
bh_»suÉ
, 
ü—‹
, 
çl£
);

1039 
	}
}

1041 
	$g‘_d©a_block_f›m­
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

1042 
bufãr_h—d
 *
bh_»suÉ
, 
ü—‹
)

1044  
	`__g‘_d©a_block
(
šode
, 
iblock
, 
bh_»suÉ
, 
ü—‹
, 
Œue
);

1045 
	}
}

1047 
	$f2fs_f›m­
(
šode
 *šode, 
f›m­_ex‹Á_šfo
 *
f›šfo
,

1048 
u64
 
¡¬t
, u64 
Ën
)

1050  
	`g’”ic_block_f›m­
(
šode
, 
f›šfo
,

1051 
¡¬t
, 
Ën
, 
g‘_d©a_block_f›m­
);

1052 
	}
}

1054 
	$f2fs_»ad_d©a_·ge
(
fe
 *fe, 
·ge
 *page)

1056 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

1057 
»t
;

1059 
	`Œaû_f2fs_»ad·ge
(
·ge
, 
DATA
);

1062 ià(
	`f2fs_has_šlše_d©a
(
šode
))

1063 
»t
 = 
	`f2fs_»ad_šlše_d©a
(
šode
, 
·ge
);

1065 
»t
 = 
	`m·ge_»ad·ge
(
·ge
, 
g‘_d©a_block
);

1067  
»t
;

1068 
	}
}

1070 
	$f2fs_»ad_d©a_·ges
(
fe
 *file,

1071 
add»ss_¥aû
 *
m­pšg
,

1072 
li¡_h—d
 *
·ges
, 
Ä_·ges
)

1074 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

1077 ià(
	`f2fs_has_šlše_d©a
(
šode
))

1080  
	`m·ge_»ad·ges
(
m­pšg
, 
·ges
, 
Ä_·ges
, 
g‘_d©a_block
);

1081 
	}
}

1083 
	$do_wr™e_d©a_·ge
(
·ge
 *·ge, 
f2fs_io_šfo
 *
fio
)

1085 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

1086 
block_t
 
Şd_blkaddr
, 
Ãw_blkaddr
;

1087 
dnode_of_d©a
 
dn
;

1088 
”r
 = 0;

1090 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

1091 
”r
 = 
	`g‘_dnode_of_d©a
(&
dn
, 
·ge
->
šdex
, 
LOOKUP_NODE
);

1092 ià(
”r
)

1093  
”r
;

1095 
Şd_blkaddr
 = 
dn
.
d©a_blkaddr
;

1098 ià(
Şd_blkaddr
 =ğ
NULL_ADDR
)

1099 
out_wr™•age
;

1101 
	`£t_·ge_wr™eback
(
·ge
);

1107 ià(
	`uÆik–y
(
Şd_blkaddr
 !ğ
NEW_ADDR
 &&

1108 !
	`is_cŞd_d©a
(
·ge
) &&

1109 
	`Ãed_š¶aû_upd©e
(
šode
))) {

1110 
	`»wr™e_d©a_·ge
(
·ge
, 
Şd_blkaddr
, 
fio
);

1111 
	`£t_šode_æag
(
	`F2FS_I
(
šode
), 
FI_UPDATE_WRITE
);

1113 
	`wr™e_d©a_·ge
(
·ge
, &
dn
, &
Ãw_blkaddr
, 
fio
);

1114 
	`upd©e_ex‹Á_ÿche
(
Ãw_blkaddr
, &
dn
);

1115 
	`£t_šode_æag
(
	`F2FS_I
(
šode
), 
FI_APPEND_WRITE
);

1117 
out_wr™•age
:

1118 
	`f2fs_put_dnode
(&
dn
);

1119  
”r
;

1120 
	}
}

1122 
	$f2fs_wr™e_d©a_·ge
(
·ge
 *page,

1123 
wr™eback_cÚŒŞ
 *
wbc
)

1125 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

1126 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1127 
loff_t
 
i_size
 = 
	`i_size_»ad
(
šode
);

1128 cÚ¡ 
pgoff_t
 
’d_šdex
 = ((è
i_size
)

1129 >> 
PAGE_CACHE_SHIFT
;

1130 
off£t
 = 0;

1131 
boŞ
 
Ãed_b®ªû_fs
 = 
çl£
;

1132 
”r
 = 0;

1133 
f2fs_io_šfo
 
fio
 = {

1134 .
ty³
 = 
DATA
,

1135 .
rw
 = (
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
è? 
WRITE_SYNC
 : 
WRITE
,

1138 
	`Œaû_f2fs_wr™•age
(
·ge
, 
DATA
);

1140 ià(
·ge
->
šdex
 < 
’d_šdex
)

1141 
wr™e
;

1147 
off£t
 = 
i_size
 & (
PAGE_CACHE_SIZE
 - 1);

1148 ià((
·ge
->
šdex
 >ğ
’d_šdex
 + 1è|| !
off£t
)

1149 
out
;

1151 
	`z”o_u£r_£gm’t
(
·ge
, 
off£t
, 
PAGE_CACHE_SIZE
);

1152 
wr™e
:

1153 ià(
	`uÆik–y
(
sbi
->
pÜ_došg
))

1154 
»dœty_out
;

1157 ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

1158 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

1159 
»dœty_out
;

1160 
”r
 = 
	`do_wr™e_d©a_·ge
(
·ge
, &
fio
);

1161 
dÚe
;

1165 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
))) {

1166 
	`S‘PageE¼Ü
(
·ge
);

1167 
	`uÆock_·ge
(
·ge
);

1168 
out
;

1171 ià(!
wbc
->
fÜ_»şaim
)

1172 
Ãed_b®ªû_fs
 = 
Œue
;

1173 ià(
	`has_nÙ_’ough_ä“_£cs
(
sbi
, 0))

1174 
»dœty_out
;

1176 
	`f2fs_lock_İ
(
sbi
);

1177 ià(
	`f2fs_has_šlše_d©a
(
šode
è|| 
	`f2fs_may_šlše
(inode))

1178 
”r
 = 
	`f2fs_wr™e_šlše_d©a
(
šode
, 
·ge
, 
off£t
);

1180 
”r
 = 
	`do_wr™e_d©a_·ge
(
·ge
, &
fio
);

1181 
	`f2fs_uÆock_İ
(
sbi
);

1182 
dÚe
:

1183 ià(
”r
 &&ƒ¼ !ğ-
ENOENT
)

1184 
»dœty_out
;

1186 
	`ş—r_cŞd_d©a
(
·ge
);

1187 
out
:

1188 
	`šode_dec_dœty_·ges
(
šode
);

1189 
	`uÆock_·ge
(
·ge
);

1190 ià(
Ãed_b®ªû_fs
)

1191 
	`f2fs_b®ªû_fs
(
sbi
);

1192 ià(
wbc
->
fÜ_»şaim
)

1193 
	`f2fs_subm™_m”ged_bio
(
sbi
, 
DATA
, 
WRITE
);

1196 
»dœty_out
:

1197 
	`»dœty_·ge_fÜ_wr™•age
(
wbc
, 
·ge
);

1198  
AOP_WRITEPAGE_ACTIVATE
;

1199 
	}
}

1201 
	$__f2fs_wr™•age
(
·ge
 *·ge, 
wr™eback_cÚŒŞ
 *
wbc
,

1202 *
d©a
)

1204 
add»ss_¥aû
 *
m­pšg
 = 
d©a
;

1205 
»t
 = 
m­pšg
->
a_İs
->
	`wr™•age
(
·ge
, 
wbc
);

1206 
	`m­pšg_£t_”rÜ
(
m­pšg
, 
»t
);

1207  
»t
;

1208 
	}
}

1210 
	$f2fs_wr™e_d©a_·ges
(
add»ss_¥aû
 *
m­pšg
,

1211 
wr™eback_cÚŒŞ
 *
wbc
)

1213 
šode
 *šodğ
m­pšg
->
ho¡
;

1214 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1216 
»t
;

1217 
diff
;

1219 
	`Œaû_f2fs_wr™•ages
(
m­pšg
->
ho¡
, 
wbc
, 
DATA
);

1222 ià(!
m­pšg
->
a_İs
->
wr™•age
)

1225 ià(
	`S_ISDIR
(
šode
->
i_mode
è&& 
wbc
->
sync_mode
 =ğ
WB_SYNC_NONE
 &&

1226 
	`g‘_dœty_·ges
(
šode
è< 
	`Ä_·ges_to_sk
(
sbi
, 
DATA
) &&

1227 
	`avaabË_ä“_memÜy
(
sbi
, 
DIRTY_DENTS
))

1228 
sk_wr™e
;

1230 
diff
 = 
	`Ä_·ges_to_wr™e
(
sbi
, 
DATA
, 
wbc
);

1238 
»t
 = 
	`wr™e_ÿche_·ges
(
m­pšg
, 
wbc
, 
__f2fs_wr™•age
, mapping);

1246 
	`f2fs_subm™_m”ged_bio
(
sbi
, 
DATA
, 
WRITE
);

1248 
	`»move_dœty_dœ_šode
(
šode
);

1250 
wbc
->
Ä_to_wr™e
 = 
	`max
(()0, wbc->Ä_to_wr™- 
diff
);

1251  
»t
;

1253 
sk_wr™e
:

1254 
wbc
->
·ges_sk³d
 +ğ
	`g‘_dœty_·ges
(
šode
);

1256 
	}
}

1258 
	$f2fs_wr™e_çed
(
add»ss_¥aû
 *
m­pšg
, 
loff_t
 
to
)

1260 
šode
 *šodğ
m­pšg
->
ho¡
;

1262 ià(
to
 > 
šode
->
i_size
) {

1263 
	`Œunÿ‹_·geÿche
(
šode
, inode->
i_size
);

1264 
	`Œunÿ‹_blocks
(
šode
, inode->
i_size
, 
Œue
);

1266 
	}
}

1268 
	$f2fs_wr™e_begš
(
fe
 *fe, 
add»ss_¥aû
 *
m­pšg
,

1269 
loff_t
 
pos
, 
Ën
, 
æags
,

1270 
·ge
 **
·g•
, **
fsd©a
)

1272 
šode
 *šodğ
m­pšg
->
ho¡
;

1273 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1274 
·ge
 *page;

1275 
pgoff_t
 
šdex
 = ((è
pos
è>> 
PAGE_CACHE_SHIFT
;

1276 
dnode_of_d©a
 
dn
;

1277 
”r
 = 0;

1279 
	`Œaû_f2fs_wr™e_begš
(
šode
, 
pos
, 
Ën
, 
æags
);

1281 #ifdeà
F2FS_GET_FS_WAF


1282 
Ën_u£r_d©a
 +ğ
Ën
;

1285 
	`f2fs_b®ªû_fs
(
sbi
);

1286 
»³©
:

1287 
”r
 = 
	`f2fs_cÚv”t_šlše_d©a
(
šode
, 
pos
 + 
Ën
, 
NULL
);

1288 ià(
”r
)

1289 
ç
;

1291 
·ge
 = 
	`g¿b_ÿche_·ge_wr™e_begš
(
m­pšg
, 
šdex
, 
æags
);

1292 ià(!
·ge
) {

1293 
”r
 = -
ENOMEM
;

1294 
ç
;

1298 
	`uÆock_·ge
(
·ge
);

1300 *
·g•
 = 
·ge
;

1302 ià(
	`f2fs_has_šlše_d©a
(
šode
è&& (
pos
 + 
Ën
è<ğ
MAX_INLINE_DATA
)

1303 
šlše_d©a
;

1305 
	`f2fs_lock_İ
(
sbi
);

1306 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

1307 
”r
 = 
	`f2fs_»£rve_block
(&
dn
, 
šdex
);

1308 
	`f2fs_uÆock_İ
(
sbi
);

1310 ià(
”r
) {

1311 
	`f2fs_put_·ge
(
·ge
, 0);

1312 
ç
;

1314 
šlše_d©a
:

1315 
	`lock_·ge
(
·ge
);

1316 ià(
	`uÆik–y
(
·ge
->
m­pšg
 != mapping)) {

1317 
	`f2fs_put_·ge
(
·ge
, 1);

1318 
»³©
;

1321 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
);

1323 ià((
Ën
 =ğ
PAGE_CACHE_SIZE
è|| 
	`PageU±od©e
(
·ge
))

1326 ià((
pos
 & 
PAGE_CACHE_MASK
è>ğ
	`i_size_»ad
(
šode
)) {

1327 
¡¬t
 = 
pos
 & (
PAGE_CACHE_SIZE
 - 1);

1328 
’d
 = 
¡¬t
 + 
Ën
;

1331 
	`z”o_u£r_£gm’ts
(
·ge
, 0, 
¡¬t
, 
’d
, 
PAGE_CACHE_SIZE
);

1332 
out
;

1335 ià(
dn
.
d©a_blkaddr
 =ğ
NEW_ADDR
) {

1336 
	`z”o_u£r_£gm’t
(
·ge
, 0, 
PAGE_CACHE_SIZE
);

1338 ià(
	`f2fs_has_šlše_d©a
(
šode
)) {

1340 
”r
 = 
	`f2fs_»ad_šlše_d©a
(
šode
, 
·ge
);

1341 ià(
”r
) {

1342 
	`·ge_ÿche_»Ëa£
(
·ge
);

1343 
ç
;

1347 
”r
 = 
	`f2fs_subm™_·ge_bio
(
sbi
, 
·ge
, 
dn
.
d©a_blkaddr
,

1348 
READ_SYNC
);

1349 ià(
”r
)

1350 
ç
;

1353 
	`lock_·ge
(
·ge
);

1354 ià(
	`uÆik–y
(!
	`PageU±od©e
(
·ge
))) {

1355 
	`f2fs_put_·ge
(
·ge
, 1);

1356 
”r
 = -
EIO
;

1357 
ç
;

1359 ià(
	`uÆik–y
(
·ge
->
m­pšg
 != mapping)) {

1360 
	`f2fs_put_·ge
(
·ge
, 1);

1361 
»³©
;

1364 
out
:

1365 
	`S‘PageU±od©e
(
·ge
);

1366 
	`ş—r_cŞd_d©a
(
·ge
);

1368 
ç
:

1369 
	`f2fs_wr™e_çed
(
m­pšg
, 
pos
 + 
Ën
);

1370  
”r
;

1371 
	}
}

1373 
	$f2fs_wr™e_’d
(
fe
 *file,

1374 
add»ss_¥aû
 *
m­pšg
,

1375 
loff_t
 
pos
, 
Ën
, 
cİ›d
,

1376 
·ge
 *·ge, *
fsd©a
)

1378 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

1380 
	`Œaû_f2fs_wr™e_’d
(
šode
, 
pos
, 
Ën
, 
cİ›d
);

1382 ià(
	`f2fs_is_©omic_fe
(
šode
è|| 
	`f2fs_is_vŞ©e_fe
(inode))

1383 
	`»gi¡”_šmem_·ge
(
šode
, 
·ge
);

1385 
	`£t_·ge_dœty
(
·ge
);

1387 ià(
pos
 + 
cİ›d
 > 
	`i_size_»ad
(
šode
)) {

1388 
	`i_size_wr™e
(
šode
, 
pos
 + 
cİ›d
);

1389 
	`m¬k_šode_dœty
(
šode
);

1390 
	`upd©e_šode_·ge
(
šode
);

1393 
	`f2fs_put_·ge
(
·ge
, 1);

1394  
cİ›d
;

1395 
	}
}

1397 
	$check_dœeù_IO
(
šode
 *šode, 
rw
,

1398 
iov_™”
 *
™”
, 
loff_t
 
off£t
)

1400 
blocksize_mask
 = 
šode
->
i_sb
->
s_blocksize
 - 1;

1402 ià(
rw
 =ğ
READ
)

1405 ià(
off£t
 & 
blocksize_mask
)

1406  -
EINVAL
;

1408 ià(
	`iov_™”_®ignm’t
(
™”
è& 
blocksize_mask
)

1409  -
EINVAL
;

1412 
	}
}

1414 
ssize_t
 
	$f2fs_dœeù_IO
(
rw
, 
kiocb
 *
iocb
,

1415 
iov_™”
 *
™”
, 
loff_t
 
off£t
)

1417 
fe
 *fğ
iocb
->
ki_fp
;

1418 
add»ss_¥aû
 *
m­pšg
 = 
fe
->
f_m­pšg
;

1419 
šode
 *šodğ
m­pšg
->
ho¡
;

1420 
size_t
 
couÁ
 = 
	`iov_™”_couÁ
(
™”
);

1421 
”r
;

1424 ià(
	`f2fs_has_šlše_d©a
(
šode
))

1427 ià(
	`check_dœeù_IO
(
šode
, 
rw
, 
™”
, 
off£t
))

1430 
	`Œaû_f2fs_dœeù_IO_’‹r
(
šode
, 
off£t
, 
couÁ
, 
rw
);

1432 
”r
 = 
	`blockdev_dœeù_IO
(
rw
, 
iocb
, 
šode
, 
™”
, 
off£t
, 
g‘_d©a_block
);

1433 ià(
”r
 < 0 && (
rw
 & 
WRITE
))

1434 
	`f2fs_wr™e_çed
(
m­pšg
, 
off£t
 + 
couÁ
);

1436 
	`Œaû_f2fs_dœeù_IO_ex™
(
šode
, 
off£t
, 
couÁ
, 
rw
, 
”r
);

1438  
”r
;

1439 
	}
}

1441 
	$f2fs_šv®id©e_d©a_·ge
(
·ge
 *·ge, 
off£t
,

1442 
Ëngth
)

1444 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

1446 ià(
off£t
 % 
PAGE_CACHE_SIZE
 || 
Ëngth
 != PAGE_CACHE_SIZE)

1449 ià(
	`PageDœty
(
·ge
))

1450 
	`šode_dec_dœty_·ges
(
šode
);

1451 
	`CË¬PagePriv©e
(
·ge
);

1452 
	}
}

1454 
	$f2fs_»Ëa£_d©a_·ge
(
·ge
 *·ge, 
gå_t
 
wa™
)

1456 
	`CË¬PagePriv©e
(
·ge
);

1458 
	}
}

1460 
	$f2fs_£t_d©a_·ge_dœty
(
·ge
 *page)

1462 
add»ss_¥aû
 *
m­pšg
 = 
·ge
->mapping;

1463 
šode
 *šodğ
m­pšg
->
ho¡
;

1465 
	`Œaû_f2fs_£t_·ge_dœty
(
·ge
, 
DATA
);

1467 
	`S‘PageU±od©e
(
·ge
);

1468 
	`m¬k_šode_dœty
(
šode
);

1470 ià(!
	`PageDœty
(
·ge
)) {

1471 
	`__£t_·ge_dœty_nobufãrs
(
·ge
);

1472 
	`upd©e_dœty_·ge
(
šode
, 
·ge
);

1476 
	}
}

1478 
£ùÜ_t
 
	$f2fs_bm­
(
add»ss_¥aû
 *
m­pšg
, 
£ùÜ_t
 
block
)

1480 
šode
 *šodğ
m­pšg
->
ho¡
;

1482 ià(
	`f2fs_has_šlše_d©a
(
šode
))

1485  
	`g’”ic_block_bm­
(
m­pšg
, 
block
, 
g‘_d©a_block
);

1486 
	}
}

1488 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
	gf2fs_dblock_aİs
 = {

1489 .
»ad·ge
 = 
f2fs_»ad_d©a_·ge
,

1490 .
	g»ad·ges
 = 
f2fs_»ad_d©a_·ges
,

1491 .
	gwr™•age
 = 
f2fs_wr™e_d©a_·ge
,

1492 .
	gwr™•ages
 = 
f2fs_wr™e_d©a_·ges
,

1493 .
	gwr™e_begš
 = 
f2fs_wr™e_begš
,

1494 .
	gwr™e_’d
 = 
f2fs_wr™e_’d
,

1495 .
	g£t_·ge_dœty
 = 
f2fs_£t_d©a_·ge_dœty
,

1496 .
	gšv®id©•age
 = 
f2fs_šv®id©e_d©a_·ge
,

1497 .
	g»Ëa£·ge
 = 
f2fs_»Ëa£_d©a_·ge
,

1498 .
	gdœeù_IO
 = 
f2fs_dœeù_IO
,

1499 .
	gbm­
 = 
f2fs_bm­
,

	@debug.c

14 
	~<lšux/fs.h
>

15 
	~<lšux/backšg-dev.h
>

16 
	~<lšux/f2fs_fs.h
>

17 
	~<lšux/blkdev.h
>

18 
	~<lšux/debugfs.h
>

19 
	~<lšux/£q_fe.h
>

21 
	~"f2fs.h
"

22 
	~"node.h
"

23 
	~"£gm’t.h
"

24 
	~"gc.h
"

26 
LIST_HEAD
(
f2fs_¡©_li¡
);

27 
d’Œy
 *
	gf2fs_debugfs_roÙ
;

28 
DEFINE_MUTEX
(
f2fs_¡©_mu‹x
);

30 
	$upd©e_g’”®_¡©us
(
f2fs_sb_šfo
 *
sbi
)

32 
f2fs_¡©_šfo
 *
si
 = 
	`F2FS_STAT
(
sbi
);

33 
i
;

36 
si
->
h™_ext
 = 
sbi
->
»ad_h™_ext
;

37 
si
->
tÙ®_ext
 = 
sbi
->
tÙ®_h™_ext
;

38 
si
->
ndœty_node
 = 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_NODES
);

39 
si
->
ndœty_d’t
 = 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_DENTS
);

40 
si
->
ndœty_dœs
 = 
sbi
->
n_dœty_dœs
;

41 
si
->
ndœty_m‘a
 = 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_META
);

42 
si
->
tÙ®_couÁ
 = ()
sbi
->
u£r_block_couÁ
 / sbi->
blocks_³r_£g
;

43 
si
->
rsvd_£gs
 = 
	`»£rved_£gm’ts
(
sbi
);

44 
si
->
ov”p_£gs
 = 
	`ov”´ovisiÚ_£gm’ts
(
sbi
);

45 
si
->
v®id_couÁ
 = 
	`v®id_u£r_blocks
(
sbi
);

46 
si
->
v®id_node_couÁ
 = 
	`v®id_node_couÁ
(
sbi
);

47 
si
->
v®id_šode_couÁ
 = 
	`v®id_šode_couÁ
(
sbi
);

48 
si
->
šlše_šode
 = 
sbi
->inline_inode;

49 
si
->
utiz©iÚ
 = 
	`utiz©iÚ
(
sbi
);

51 
si
->
ä“_£gs
 = 
	`ä“_£gm’ts
(
sbi
);

52 
si
->
ä“_£cs
 = 
	`ä“_£ùiÚs
(
sbi
);

53 
si
->
´eä“_couÁ
 = 
	`´eä“_£gm’ts
(
sbi
);

54 
si
->
dœty_couÁ
 = 
	`dœty_£gm’ts
(
sbi
);

55 
si
->
node_·ges
 = 
	`NODE_MAPPING
(
sbi
)->
Ä·ges
;

56 
si
->
m‘a_·ges
 = 
	`META_MAPPING
(
sbi
)->
Ä·ges
;

57 
si
->
Çts
 = 
	`NM_I
(
sbi
)->
Çt_út
;

58 
si
->
s™s
 = 
	`SIT_I
(
sbi
)->
dœty_£Ár›s
;

59 
si
->
âids
 = 
	`NM_I
(
sbi
)->
fút
;

60 
si
->
bg_gc
 = 
sbi
->bg_gc;

61 
si
->
ut_ä“
 = ()(
	`ä“_u£r_blocks
(
sbi
è>> sbi->
log_blocks_³r_£g
)

62 * 100 / ()(
sbi
->
u£r_block_couÁ
 >> sbi->
log_blocks_³r_£g
)

64 
si
->
ut_v®id
 = ()(
	`wr™‹n_block_couÁ
(
sbi
) >>

65 
sbi
->
log_blocks_³r_£g
)

66 * 100 / ()(
sbi
->
u£r_block_couÁ
 >> sbi->
log_blocks_³r_£g
)

68 
si
->
ut_šv®id
 = 50 - si->
ut_ä“
 - si->
ut_v®id
;

69 
i
 = 
CURSEG_HOT_DATA
; i <ğ
CURSEG_COLD_NODE
; i++) {

70 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
i
);

71 
si
->
cur£g
[
i
] = cur£g->
£gno
;

72 
si
->
cur£c
[
i
] = 
cur£g
->
£gno
 / 
sbi
->
£gs_³r_£c
;

73 
si
->
curzÚe
[
i
] = si->
cur£c
[i] / 
sbi
->
£cs_³r_zÚe
;

76 
i
 = 0; i < 2; i++) {

77 
si
->
£gm’t_couÁ
[
i
] = 
sbi
->segment_count[i];

78 
si
->
block_couÁ
[
i
] = 
sbi
->block_count[i];

80 
	}
}

85 
	$upd©e_s™_šfo
(
f2fs_sb_šfo
 *
sbi
)

87 
f2fs_¡©_šfo
 *
si
 = 
	`F2FS_STAT
(
sbi
);

88 
blks_³r_£c
, 
hblks_³r_£c
, 
tÙ®_vblocks
, 
bimod®
, 
di¡
;

89 
£gno
, 
vblocks
;

90 
ndœty
 = 0;

92 
bimod®
 = 0;

93 
tÙ®_vblocks
 = 0;

94 
blks_³r_£c
 = 
sbi
->
£gs_³r_£c
 * (1 << sbi->
log_blocks_³r_£g
);

95 
hblks_³r_£c
 = 
blks_³r_£c
 / 2;

96 
£gno
 = 0; segnØ< 
	`MAIN_SEGS
(
sbi
); segnØ+ğsbi->
£gs_³r_£c
) {

97 
vblocks
 = 
	`g‘_v®id_blocks
(
sbi
, 
£gno
, sbi->
£gs_³r_£c
);

98 
di¡
 = 
	`abs
(
vblocks
 - 
hblks_³r_£c
);

99 
bimod®
 +ğ
di¡
 * dist;

101 ià(
vblocks
 > 0 && vblock < 
blks_³r_£c
) {

102 
tÙ®_vblocks
 +ğ
vblocks
;

103 
ndœty
++;

106 
di¡
 = 
	`MAIN_SECS
(
sbi
è* 
hblks_³r_£c
 * hblks_per_sec / 100;

107 
si
->
bimod®
 = bimod® / 
di¡
;

108 ià(
si
->
dœty_couÁ
)

109 
si
->
avg_vblocks
 = 
tÙ®_vblocks
 / 
ndœty
;

111 
si
->
avg_vblocks
 = 0;

112 
	}
}

117 
	$upd©e_mem_šfo
(
f2fs_sb_šfo
 *
sbi
)

119 
f2fs_¡©_šfo
 *
si
 = 
	`F2FS_STAT
(
sbi
);

120 
Åages
;

122 ià(
si
->
ba£_mem
)

123 
g‘_ÿche
;

125 
si
->
ba£_mem
 = (
f2fs_sb_šfo
è+ 
sbi
->
sb
->
s_blocksize
;

126 
si
->
ba£_mem
 +ğ2 * (
f2fs_šode_šfo
);

127 
si
->
ba£_mem
 +ğ(*
sbi
->
ck±
);

130 
si
->
ba£_mem
 +ğ(
f2fs_sm_šfo
);

133 
si
->
ba£_mem
 +ğ(
s™_šfo
);

134 
si
->
ba£_mem
 +ğ
	`MAIN_SEGS
(
sbi
è* (
£g_’Œy
);

135 
si
->
ba£_mem
 +ğ
	`f2fs_b™m­_size
(
	`MAIN_SEGS
(
sbi
));

136 
si
->
ba£_mem
 +ğ2 * 
SIT_VBLOCK_MAP_SIZE
 * 
	`MAIN_SEGS
(
sbi
);

137 ià(
sbi
->
£gs_³r_£c
 > 1)

138 
si
->
ba£_mem
 +ğ
	`MAIN_SECS
(
sbi
è* (
£c_’Œy
);

139 
si
->
ba£_mem
 +ğ
	`__b™m­_size
(
sbi
, 
SIT_BITMAP
);

142 
si
->
ba£_mem
 +ğ(
ä“_£gm­_šfo
);

143 
si
->
ba£_mem
 +ğ
	`f2fs_b™m­_size
(
	`MAIN_SEGS
(
sbi
));

144 
si
->
ba£_mem
 +ğ
	`f2fs_b™m­_size
(
	`MAIN_SECS
(
sbi
));

147 
si
->
ba£_mem
 +ğ(
cur£g_šfo
è* 
NR_CURSEG_TYPE
;

148 
si
->
ba£_mem
 +ğ
PAGE_CACHE_SIZE
 * 
NR_CURSEG_TYPE
;

151 
si
->
ba£_mem
 +ğ(
dœty_£gli¡_šfo
);

152 
si
->
ba£_mem
 +ğ
NR_DIRTY_TYPE
 * 
	`f2fs_b™m­_size
(
	`MAIN_SEGS
(
sbi
));

153 
si
->
ba£_mem
 +ğ
	`f2fs_b™m­_size
(
	`MAIN_SECS
(
sbi
));

156 
si
->
ba£_mem
 +ğ(
f2fs_nm_šfo
);

157 
si
->
ba£_mem
 +ğ
	`__b™m­_size
(
sbi
, 
NAT_BITMAP
);

160 
si
->
ba£_mem
 +ğ(
f2fs_gc_kth»ad
);

162 
g‘_ÿche
:

164 
si
->
ÿche_mem
 = 
	`NM_I
(
sbi
)->
fút
;

165 
si
->
ÿche_mem
 +ğ
	`NM_I
(
sbi
)->
Çt_út
;

166 
Åages
 = 
	`NODE_MAPPING
(
sbi
)->
Ä·ges
;

167 
si
->
ÿche_mem
 +ğ
Åages
 << 
PAGE_CACHE_SHIFT
;

168 
Åages
 = 
	`META_MAPPING
(
sbi
)->
Ä·ges
;

169 
si
->
ÿche_mem
 +ğ
Åages
 << 
PAGE_CACHE_SHIFT
;

170 
si
->
ÿche_mem
 +ğ
sbi
->
n_Üphªs
 * (
šo_’Œy
);

171 
si
->
ÿche_mem
 +ğ
sbi
->
n_dœty_dœs
 * (
dœ_šode_’Œy
);

172 
	}
}

174 
	$¡©_show
(
£q_fe
 *
s
, *
v
)

176 
f2fs_¡©_šfo
 *
si
;

177 
i
 = 0;

178 
j
;

180 
	`mu‹x_lock
(&
f2fs_¡©_mu‹x
);

181 
	`li¡_fÜ_—ch_’Œy
(
si
, &
f2fs_¡©_li¡
, 
¡©_li¡
) {

182 
devÇme
[
BDEVNAME_SIZE
];

184 
	`upd©e_g’”®_¡©us
(
si
->
sbi
);

186 
	`£q_´štf
(
s
, "\n=====[…artition info(%s). #%d ]=====\n",

187 
	`bdevÇme
(
si
->
sbi
->
sb
->
s_bdev
, 
devÇme
), 
i
++);

188 
	`£q_´štf
(
s
, "[SB: 1] [CP: 2] [SIT: %d] [NAT: %d] ",

189 
si
->
s™_¬—_£gs
, si->
Çt_¬—_£gs
);

190 
	`£q_´štf
(
s
, "[SSA: %d] [MAIN: %d",

191 
si
->
s§_¬—_£gs
, si->
maš_¬—_£gs
);

192 
	`£q_´štf
(
s
, "(OverProv:%d Resv:%d)]\n\n",

193 
si
->
ov”p_£gs
, si->
rsvd_£gs
);

194 
	`£q_´štf
(
s
, "Utilization: %d%% (%d valid blocks)\n",

195 
si
->
utiz©iÚ
, si->
v®id_couÁ
);

196 
	`£q_´štf
(
s
, " - Node: %u (Inode: %u, ",

197 
si
->
v®id_node_couÁ
, si->
v®id_šode_couÁ
);

198 
	`£q_´štf
(
s
, "Other: %u)\n - Data: %u\n",

199 
si
->
v®id_node_couÁ
 - si->
v®id_šode_couÁ
,

200 
si
->
v®id_couÁ
 - si->
v®id_node_couÁ
);

201 
	`£q_´štf
(
s
, " - Inline_data Inode: %u\n",

202 
si
->
šlše_šode
);

203 
	`£q_´štf
(
s
, "\nMain‡rea: %d segs, %d secs %d zones\n",

204 
si
->
maš_¬—_£gs
, si->
maš_¬—_£ùiÚs
,

205 
si
->
maš_¬—_zÚes
);

206 
	`£q_´štf
(
s
, " - COLD data: %d, %d, %d\n",

207 
si
->
cur£g
[
CURSEG_COLD_DATA
],

208 
si
->
cur£c
[
CURSEG_COLD_DATA
],

209 
si
->
curzÚe
[
CURSEG_COLD_DATA
]);

210 
	`£q_´štf
(
s
, " - WARM data: %d, %d, %d\n",

211 
si
->
cur£g
[
CURSEG_WARM_DATA
],

212 
si
->
cur£c
[
CURSEG_WARM_DATA
],

213 
si
->
curzÚe
[
CURSEG_WARM_DATA
]);

214 
	`£q_´štf
(
s
, " - HOT data: %d, %d, %d\n",

215 
si
->
cur£g
[
CURSEG_HOT_DATA
],

216 
si
->
cur£c
[
CURSEG_HOT_DATA
],

217 
si
->
curzÚe
[
CURSEG_HOT_DATA
]);

218 
	`£q_´štf
(
s
, " - Dir dnode: %d, %d, %d\n",

219 
si
->
cur£g
[
CURSEG_HOT_NODE
],

220 
si
->
cur£c
[
CURSEG_HOT_NODE
],

221 
si
->
curzÚe
[
CURSEG_HOT_NODE
]);

222 
	`£q_´štf
(
s
, " - File dnode: %d, %d, %d\n",

223 
si
->
cur£g
[
CURSEG_WARM_NODE
],

224 
si
->
cur£c
[
CURSEG_WARM_NODE
],

225 
si
->
curzÚe
[
CURSEG_WARM_NODE
]);

226 
	`£q_´štf
(
s
, " - Indir‚odes: %d, %d, %d\n",

227 
si
->
cur£g
[
CURSEG_COLD_NODE
],

228 
si
->
cur£c
[
CURSEG_COLD_NODE
],

229 
si
->
curzÚe
[
CURSEG_COLD_NODE
]);

230 
	`£q_´štf
(
s
, "\n - Valid: %d\n - Dirty: %d\n",

231 
si
->
maš_¬—_£gs
 - si->
dœty_couÁ
 -

232 
si
->
´eä“_couÁ
 - si->
ä“_£gs
,

233 
si
->
dœty_couÁ
);

234 
	`£q_´štf
(
s
, " - Prefree: %d\n - Free: %d (%d)\n\n",

235 
si
->
´eä“_couÁ
, si->
ä“_£gs
, si->
ä“_£cs
);

236 
	`£q_´štf
(
s
, "CP c®ls: %d\n", 
si
->
ı_couÁ
);

237 
	`£q_´štf
(
s
, "GC calls: %d (BG: %d)\n",

238 
si
->
ÿÎ_couÁ
, si->
bg_gc
);

239 
	`£q_´štf
(
s
, " - d©¨£gm’t : %d\n", 
si
->
d©a_£gs
);

240 
	`£q_´štf
(
s
, " -‚od£gm’t : %d\n", 
si
->
node_£gs
);

241 
	`£q_´štf
(
s
, "TryØmov%d blocks\n", 
si
->
tÙ_blks
);

242 
	`£q_´štf
(
s
, " - d©¨block : %d\n", 
si
->
d©a_blks
);

243 
	`£q_´štf
(
s
, " -‚odblock : %d\n", 
si
->
node_blks
);

244 
	`£q_´štf
(
s
, "\nExtent Hit Ratio: %d / %d\n",

245 
si
->
h™_ext
, si->
tÙ®_ext
);

246 
	`£q_puts
(
s
, "\nBalancing F2FS Async:\n");

247 
	`£q_´štf
(
s
, " -‚odes: %4d in %4d\n",

248 
si
->
ndœty_node
, si->
node_·ges
);

249 
	`£q_´štf
(
s
, " - dents: %4d in dirs:%4d\n",

250 
si
->
ndœty_d’t
, si->
ndœty_dœs
);

251 
	`£q_´štf
(
s
, " - meta: %4d in %4d\n",

252 
si
->
ndœty_m‘a
, si->
m‘a_·ges
);

253 
	`£q_´štf
(
s
, " - NATs: %9d\n - SITs: %9d\n",

254 
si
->
Çts
, si->
s™s
);

255 
	`£q_´štf
(
s
, " - free_nids: %9d\n",

256 
si
->
âids
);

257 
	`£q_puts
(
s
, "\nDistribution of User Blocks:");

258 
	`£q_puts
(
s
, " [ valid | invalid | free ]\n");

259 
	`£q_puts
(
s
, " [");

261 
j
 = 0; j < 
si
->
ut_v®id
; j++)

262 
	`£q_putc
(
s
, '-');

263 
	`£q_putc
(
s
, '|');

265 
j
 = 0; j < 
si
->
ut_šv®id
; j++)

266 
	`£q_putc
(
s
, '-');

267 
	`£q_putc
(
s
, '|');

269 
j
 = 0; j < 
si
->
ut_ä“
; j++)

270 
	`£q_putc
(
s
, '-');

271 
	`£q_puts
(
s
, "]\n\n");

272 
	`£q_´štf
(
s
, "SSR: %u blocks in %u segments\n",

273 
si
->
block_couÁ
[
SSR
], si->
£gm’t_couÁ
[SSR]);

274 
	`£q_´štf
(
s
, "LFS: %u blocks in %u segments\n",

275 
si
->
block_couÁ
[
LFS
], si->
£gm’t_couÁ
[LFS]);

278 
	`upd©e_s™_šfo
(
si
->
sbi
);

279 
	`£q_´štf
(
s
, "\nBDF: %u,‡vg. vblocks: %u\n",

280 
si
->
bimod®
, si->
avg_vblocks
);

283 
	`upd©e_mem_šfo
(
si
->
sbi
);

284 
	`£q_´štf
(
s
, "\nMemory: %u KB = static: %u + cached: %u\n",

285 (
si
->
ba£_mem
 + si->
ÿche_mem
) >> 10,

286 
si
->
ba£_mem
 >> 10, si->
ÿche_mem
 >> 10);

288 
	`mu‹x_uÆock
(&
f2fs_¡©_mu‹x
);

290 
	}
}

292 
	$¡©_İ’
(
šode
 *šode, 
fe
 *file)

294  
	`sšgË_İ’
(
fe
, 
¡©_show
, 
šode
->
i_´iv©e
);

295 
	}
}

297 cÚ¡ 
fe_İ”©iÚs
 
	g¡©_fİs
 = {

298 .
İ’
 = 
¡©_İ’
,

299 .
	g»ad
 = 
£q_»ad
,

300 .
	gÎ£ek
 = 
£q_l£ek
,

301 .
	g»Ëa£
 = 
sšgË_»Ëa£
,

304 
	$f2fs_bud_¡©s
(
f2fs_sb_šfo
 *
sbi
)

306 
f2fs_su³r_block
 *
¿w_su³r
 = 
	`F2FS_RAW_SUPER
(
sbi
);

307 
f2fs_¡©_šfo
 *
si
;

309 
si
 = 
	`kz®loc
((
f2fs_¡©_šfo
), 
GFP_KERNEL
);

310 ià(!
si
)

311  -
ENOMEM
;

313 
si
->
®l_¬—_£gs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ
);

314 
si
->
s™_¬—_£gs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_s™
);

315 
si
->
Çt_¬—_£gs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_Çt
);

316 
si
->
s§_¬—_£gs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_s§
);

317 
si
->
maš_¬—_£gs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_maš
);

318 
si
->
maš_¬—_£ùiÚs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£ùiÚ_couÁ
);

319 
si
->
maš_¬—_zÚes
 = si->
maš_¬—_£ùiÚs
 /

320 
	`Ë32_to_ıu
(
¿w_su³r
->
£cs_³r_zÚe
);

321 
si
->
sbi
 = sbi;

322 
sbi
->
¡©_šfo
 = 
si
;

324 
	`mu‹x_lock
(&
f2fs_¡©_mu‹x
);

325 
	`li¡_add_
(&
si
->
¡©_li¡
, &
f2fs_¡©_li¡
);

326 
	`mu‹x_uÆock
(&
f2fs_¡©_mu‹x
);

329 
	}
}

331 
	$f2fs_de¡roy_¡©s
(
f2fs_sb_šfo
 *
sbi
)

333 
f2fs_¡©_šfo
 *
si
 = 
	`F2FS_STAT
(
sbi
);

335 
	`mu‹x_lock
(&
f2fs_¡©_mu‹x
);

336 
	`li¡_d–
(&
si
->
¡©_li¡
);

337 
	`mu‹x_uÆock
(&
f2fs_¡©_mu‹x
);

339 
	`kä“
(
si
);

340 
	}
}

342 
__š™
 
	$f2fs_ü—‹_roÙ_¡©s
()

344 
d’Œy
 *
fe
;

346 
f2fs_debugfs_roÙ
 = 
	`debugfs_ü—‹_dœ
("f2fs", 
NULL
);

347 ià(!
f2fs_debugfs_roÙ
)

350 
fe
 = 
	`debugfs_ü—‹_fe
("¡©us", 
S_IRUGO
, 
f2fs_debugfs_roÙ
,

351 
NULL
, &
¡©_fİs
);

352 ià(!
fe
) {

353 
	`debugfs_»move
(
f2fs_debugfs_roÙ
);

354 
f2fs_debugfs_roÙ
 = 
NULL
;

356 
	}
}

358 
	$f2fs_de¡roy_roÙ_¡©s
()

360 ià(!
f2fs_debugfs_roÙ
)

363 
	`debugfs_»move_»cursive
(
f2fs_debugfs_roÙ
);

364 
f2fs_debugfs_roÙ
 = 
NULL
;

365 
	}
}

	@dir.c

11 
	~<lšux/fs.h
>

12 
	~<lšux/f2fs_fs.h
>

13 
	~"f2fs.h
"

14 
	~"node.h
"

15 
	~"aş.h
"

16 
	~"x©Œ.h
"

18 
	$dœ_blocks
(
šode
 *inode)

20  ((è(
	`i_size_»ad
(
šode
è+ 
PAGE_CACHE_SIZE
 - 1))

21 >> 
PAGE_CACHE_SHIFT
;

22 
	}
}

24 
	$dœ_buck‘s
(
Ëv–
, 
dœ_Ëv–
)

26 ià(
Ëv–
 + 
dœ_Ëv–
 < 
MAX_DIR_HASH_DEPTH
 / 2)

27  1 << (
Ëv–
 + 
dœ_Ëv–
);

29  
MAX_DIR_BUCKETS
;

30 
	}
}

32 
	$buck‘_blocks
(
Ëv–
)

34 ià(
Ëv–
 < 
MAX_DIR_HASH_DEPTH
 / 2)

38 
	}
}

40 
	gf2fs_f‘y³_bË
[
F2FS_FT_MAX
] = {

41 [
F2FS_FT_UNKNOWN
] = 
DT_UNKNOWN
,

42 [
F2FS_FT_REG_FILE
] = 
DT_REG
,

43 [
F2FS_FT_DIR
] = 
DT_DIR
,

44 [
F2FS_FT_CHRDEV
] = 
DT_CHR
,

45 [
F2FS_FT_BLKDEV
] = 
DT_BLK
,

46 [
F2FS_FT_FIFO
] = 
DT_FIFO
,

47 [
F2FS_FT_SOCK
] = 
DT_SOCK
,

48 [
F2FS_FT_SYMLINK
] = 
DT_LNK
,

51 
	#S_SHIFT
 12

	)

52 
	gf2fs_ty³_by_mode
[
S_IFMT
 >> 
S_SHIFT
] = {

53 [
S_IFREG
 >> 
S_SHIFT
] = 
F2FS_FT_REG_FILE
,

54 [
S_IFDIR
 >> 
S_SHIFT
] = 
F2FS_FT_DIR
,

55 [
S_IFCHR
 >> 
S_SHIFT
] = 
F2FS_FT_CHRDEV
,

56 [
S_IFBLK
 >> 
S_SHIFT
] = 
F2FS_FT_BLKDEV
,

57 [
S_IFIFO
 >> 
S_SHIFT
] = 
F2FS_FT_FIFO
,

58 [
S_IFSOCK
 >> 
S_SHIFT
] = 
F2FS_FT_SOCK
,

59 [
S_IFLNK
 >> 
S_SHIFT
] = 
F2FS_FT_SYMLINK
,

62 
	$£t_de_ty³
(
f2fs_dœ_’Œy
 *
de
, 
šode
 *inode)

64 
umode_t
 
mode
 = 
šode
->
i_mode
;

65 
de
->
fe_ty³
 = 
f2fs_ty³_by_mode
[(
mode
 & 
S_IFMT
è>> 
S_SHIFT
];

66 
	}
}

68 
	$dœ_block_šdex
(
Ëv–
,

69 
dœ_Ëv–
, 
idx
)

71 
i
;

72 
bidx
 = 0;

74 
i
 = 0; i < 
Ëv–
; i++)

75 
bidx
 +ğ
	`dœ_buck‘s
(
i
, 
dœ_Ëv–
è* 
	`buck‘_blocks
(i);

76 
bidx
 +ğ
idx
 * 
	`buck‘_blocks
(
Ëv–
);

77  
bidx
;

78 
	}
}

80 
boŞ
 
	$—¾y_m©ch_Çme
(
size_t
 
Çm–’
, 
f2fs_hash_t
 
Çmehash
,

81 
f2fs_dœ_’Œy
 *
de
)

83 ià(
	`Ë16_to_ıu
(
de
->
Çme_Ën
è!ğ
Çm–’
)

84  
çl£
;

86 ià(
de
->
hash_code
 !ğ
Çmehash
)

87  
çl£
;

89  
Œue
;

90 
	}
}

92 
f2fs_dœ_’Œy
 *
	$fšd_š_block
(
·ge
 *
d’Œy_·ge
,

93 
q¡r
 *
Çme
, *
max_¦Ùs
,

94 
f2fs_hash_t
 
Çmehash
, 
·ge
 **
»s_·ge
)

96 
f2fs_dœ_’Œy
 *
de
;

97 
b™_pos
 = 0;

98 
f2fs_d’Œy_block
 *
d’Œy_blk
 = 
	`km­
(
d’Œy_·ge
);

99 cÚ¡ *
d’Œy_b™s
 = &
d’Œy_blk
->
d’Œy_b™m­
;

100 
max_Ën
 = 0;

102 
b™_pos
 < 
NR_DENTRY_IN_BLOCK
) {

103 ià(!
	`‹¡_b™_Ë
(
b™_pos
, 
d’Œy_b™s
)) {

104 ià(
b™_pos
 == 0)

105 
max_Ën
 = 1;

106 ià(!
	`‹¡_b™_Ë
(
b™_pos
 - 1, 
d’Œy_b™s
))

107 
max_Ën
++;

108 
b™_pos
++;

111 
de
 = &
d’Œy_blk
->
d’Œy
[
b™_pos
];

112 ià(
	`—¾y_m©ch_Çme
(
Çme
->
Ën
, 
Çmehash
, 
de
)) {

113 ià(!
	`memcmp
(
d’Œy_blk
->
f’ame
[
b™_pos
],

114 
Çme
->name,

115 
Çme
->
Ën
)) {

116 *
»s_·ge
 = 
d’Œy_·ge
;

117 
found
;

120 ià(
max_Ën
 > *
max_¦Ùs
) {

121 *
max_¦Ùs
 = 
max_Ën
;

122 
max_Ën
 = 0;

129 
	`f2fs_bug_Ú
(
	`F2FS_P_SB
(
d’Œy_·ge
), !
de
->
Çme_Ën
);

131 
b™_pos
 +ğ
	`GET_DENTRY_SLOTS
(
	`Ë16_to_ıu
(
de
->
Çme_Ën
));

134 
de
 = 
NULL
;

135 
	`kunm­
(
d’Œy_·ge
);

136 
found
:

137 ià(
max_Ën
 > *
max_¦Ùs
)

138 *
max_¦Ùs
 = 
max_Ën
;

139  
de
;

140 
	}
}

142 
f2fs_dœ_’Œy
 *
	$fšd_š_Ëv–
(
šode
 *
dœ
,

143 
Ëv–
, 
q¡r
 *
Çme
,

144 
f2fs_hash_t
 
Çmehash
, 
·ge
 **
»s_·ge
)

146 
s
 = 
	`GET_DENTRY_SLOTS
(
Çme
->
Ën
);

147 
nbuck‘
, 
nblock
;

148 
bidx
, 
’d_block
;

149 
·ge
 *
d’Œy_·ge
;

150 
f2fs_dœ_’Œy
 *
de
 = 
NULL
;

151 
boŞ
 
room
 = 
çl£
;

152 
max_¦Ùs
 = 0;

154 
	`f2fs_bug_Ú
(
	`F2FS_I_SB
(
dœ
), 
Ëv–
 > 
MAX_DIR_HASH_DEPTH
);

156 
nbuck‘
 = 
	`dœ_buck‘s
(
Ëv–
, 
	`F2FS_I
(
dœ
)->
i_dœ_Ëv–
);

157 
nblock
 = 
	`buck‘_blocks
(
Ëv–
);

159 
bidx
 = 
	`dœ_block_šdex
(
Ëv–
, 
	`F2FS_I
(
dœ
)->
i_dœ_Ëv–
,

160 
	`Ë32_to_ıu
(
Çmehash
è% 
nbuck‘
);

161 
’d_block
 = 
bidx
 + 
nblock
;

163 ; 
bidx
 < 
’d_block
; bidx++) {

165 
d’Œy_·ge
 = 
	`fšd_d©a_·ge
(
dœ
, 
bidx
, 
Œue
);

166 ià(
	`IS_ERR
(
d’Œy_·ge
)) {

167 
room
 = 
Œue
;

171 
de
 = 
	`fšd_š_block
(
d’Œy_·ge
, 
Çme
, &
max_¦Ùs
,

172 
Çmehash
, 
»s_·ge
);

173 ià(
de
)

176 ià(
max_¦Ùs
 >ğ
s
)

177 
room
 = 
Œue
;

178 
	`f2fs_put_·ge
(
d’Œy_·ge
, 0);

181 ià(!
de
 && 
room
 && 
	`F2FS_I
(
dœ
)->
chash
 !ğ
Çmehash
) {

182 
	`F2FS_I
(
dœ
)->
chash
 = 
Çmehash
;

183 
	`F2FS_I
(
dœ
)->
şev–
 = 
Ëv–
;

186  
de
;

187 
	}
}

195 
f2fs_dœ_’Œy
 *
	$f2fs_fšd_’Œy
(
šode
 *
dœ
,

196 
q¡r
 *
chd
, 
·ge
 **
»s_·ge
)

198 
Åages
 = 
	`dœ_blocks
(
dœ
);

199 
f2fs_dœ_’Œy
 *
de
 = 
NULL
;

200 
f2fs_hash_t
 
Çme_hash
;

201 
max_d•th
;

202 
Ëv–
;

204 ià(
Åages
 == 0)

205  
NULL
;

207 *
»s_·ge
 = 
NULL
;

209 
Çme_hash
 = 
	`f2fs_d’Œy_hash
(
chd
);

210 
max_d•th
 = 
	`F2FS_I
(
dœ
)->
i_cu¼’t_d•th
;

212 
Ëv–
 = 0;†ev– < 
max_d•th
;†evel++) {

213 
de
 = 
	`fšd_š_Ëv–
(
dœ
, 
Ëv–
, 
chd
, 
Çme_hash
, 
»s_·ge
);

214 ià(
de
)

217 ià(!
de
 && 
	`F2FS_I
(
dœ
)->
chash
 !ğ
Çme_hash
) {

218 
	`F2FS_I
(
dœ
)->
chash
 = 
Çme_hash
;

219 
	`F2FS_I
(
dœ
)->
şev–
 = 
Ëv–
 - 1;

221  
de
;

222 
	}
}

224 
f2fs_dœ_’Œy
 *
	$f2fs_·»Á_dœ
(
šode
 *
dœ
, 
·ge
 **
p
)

226 
·ge
 *page;

227 
f2fs_dœ_’Œy
 *
de
;

228 
f2fs_d’Œy_block
 *
d’Œy_blk
;

230 
·ge
 = 
	`g‘_lock_d©a_·ge
(
dœ
, 0);

231 ià(
	`IS_ERR
(
·ge
))

232  
NULL
;

234 
d’Œy_blk
 = 
	`km­
(
·ge
);

235 
de
 = &
d’Œy_blk
->
d’Œy
[1];

236 *
p
 = 
·ge
;

237 
	`uÆock_·ge
(
·ge
);

238  
de
;

239 
	}
}

241 
šo_t
 
	$f2fs_šode_by_Çme
(
šode
 *
dœ
, 
q¡r
 *qstr)

243 
šo_t
 
»s
 = 0;

244 
f2fs_dœ_’Œy
 *
de
;

245 
·ge
 *page;

247 
de
 = 
	`f2fs_fšd_’Œy
(
dœ
, 
q¡r
, &
·ge
);

248 ià(
de
) {

249 
»s
 = 
	`Ë32_to_ıu
(
de
->
šo
);

250 
	`kunm­
(
·ge
);

251 
	`f2fs_put_·ge
(
·ge
, 0);

254  
»s
;

255 
	}
}

257 
	$f2fs_£t_lšk
(
šode
 *
dœ
, 
f2fs_dœ_’Œy
 *
de
,

258 
·ge
 *·ge, 
šode
 *inode)

260 
	`lock_·ge
(
·ge
);

261 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
);

262 
de
->
šo
 = 
	`ıu_to_Ë32
(
šode
->
i_šo
);

263 
	`£t_de_ty³
(
de
, 
šode
);

264 
	`kunm­
(
·ge
);

265 
	`£t_·ge_dœty
(
·ge
);

266 
dœ
->
i_mtime
 = dœ->
i_ùime
 = 
CURRENT_TIME
;

267 
	`m¬k_šode_dœty
(
dœ
);

269 
	`f2fs_put_·ge
(
·ge
, 1);

270 
	}
}

272 
	$š™_d’t_šode
(cÚ¡ 
q¡r
 *
Çme
, 
·ge
 *
age
)

274 
f2fs_šode
 *
ri
;

276 
	`f2fs_wa™_Ú_·ge_wr™eback
(
age
, 
NODE
);

279 
ri
 = 
	`F2FS_INODE
(
age
);

280 
ri
->
i_Çm–’
 = 
	`ıu_to_Ë32
(
Çme
->
Ën
);

281 
	`memıy
(
ri
->
i_Çme
, 
Çme
->Çme,‚ame->
Ën
);

282 
	`£t_·ge_dœty
(
age
);

283 
	}
}

285 
	$upd©e_d’t_šode
(
šode
 *šode, cÚ¡ 
q¡r
 *
Çme
)

287 
·ge
 *page;

289 
·ge
 = 
	`g‘_node_·ge
(
	`F2FS_I_SB
(
šode
), inode->
i_šo
);

290 ià(
	`IS_ERR
(
·ge
))

291  
	`PTR_ERR
(
·ge
);

293 
	`š™_d’t_šode
(
Çme
, 
·ge
);

294 
	`f2fs_put_·ge
(
·ge
, 1);

297 
	}
}

299 
	$make_em±y_dœ
(
šode
 *inode,

300 
šode
 *
·»Á
, 
·ge
 *page)

302 
·ge
 *
d’Œy_·ge
;

303 
f2fs_d’Œy_block
 *
d’Œy_blk
;

304 
f2fs_dœ_’Œy
 *
de
;

306 
d’Œy_·ge
 = 
	`g‘_Ãw_d©a_·ge
(
šode
, 
·ge
, 0, 
Œue
);

307 ià(
	`IS_ERR
(
d’Œy_·ge
))

308  
	`PTR_ERR
(
d’Œy_·ge
);

311 
d’Œy_blk
 = 
	`km­_©omic
(
d’Œy_·ge
);

313 
de
 = &
d’Œy_blk
->
d’Œy
[0];

314 
de
->
Çme_Ën
 = 
	`ıu_to_Ë16
(1);

315 
de
->
hash_code
 = 0;

316 
de
->
šo
 = 
	`ıu_to_Ë32
(
šode
->
i_šo
);

317 
	`memıy
(
d’Œy_blk
->
f’ame
[0], ".", 1);

318 
	`£t_de_ty³
(
de
, 
šode
);

320 
de
 = &
d’Œy_blk
->
d’Œy
[1];

321 
de
->
hash_code
 = 0;

322 
de
->
Çme_Ën
 = 
	`ıu_to_Ë16
(2);

323 
de
->
šo
 = 
	`ıu_to_Ë32
(
·»Á
->
i_šo
);

324 
	`memıy
(
d’Œy_blk
->
f’ame
[1], "..", 2);

325 
	`£t_de_ty³
(
de
, 
šode
);

327 
	`‹¡_ªd_£t_b™_Ë
(0, &
d’Œy_blk
->
d’Œy_b™m­
);

328 
	`‹¡_ªd_£t_b™_Ë
(1, &
d’Œy_blk
->
d’Œy_b™m­
);

329 
	`kunm­_©omic
(
d’Œy_blk
);

331 
	`£t_·ge_dœty
(
d’Œy_·ge
);

332 
	`f2fs_put_·ge
(
d’Œy_·ge
, 1);

334 
	}
}

336 
·ge
 *
	$š™_šode_m‘ad©a
(
šode
 *inode,

337 
šode
 *
dœ
, cÚ¡ 
q¡r
 *
Çme
)

339 
·ge
 *page;

340 
”r
;

342 ià(
	`is_šode_æag_£t
(
	`F2FS_I
(
šode
), 
FI_NEW_INODE
)) {

343 
·ge
 = 
	`Ãw_šode_·ge
(
šode
);

344 ià(
	`IS_ERR
(
·ge
))

345  
·ge
;

347 ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

348 
”r
 = 
	`make_em±y_dœ
(
šode
, 
dœ
, 
·ge
);

349 ià(
”r
)

350 
”rÜ
;

353 
”r
 = 
	`f2fs_š™_aş
(
šode
, 
dœ
, 
·ge
);

354 ià(
”r
)

355 
put_”rÜ
;

357 
”r
 = 
	`f2fs_š™_£cur™y
(
šode
, 
dœ
, 
Çme
, 
·ge
);

358 ià(
”r
)

359 
put_”rÜ
;

361 
·ge
 = 
	`g‘_node_·ge
(
	`F2FS_I_SB
(
dœ
), 
šode
->
i_šo
);

362 ià(
	`IS_ERR
(
·ge
))

363  
·ge
;

365 
	`£t_cŞd_node
(
šode
, 
·ge
);

368 ià(
Çme
)

369 
	`š™_d’t_šode
(
Çme
, 
·ge
);

375 ià(
	`is_šode_æag_£t
(
	`F2FS_I
(
šode
), 
FI_INC_LINK
)) {

376 
	`fe_lo¡_pšo
(
šode
);

381 ià(
šode
->
i_Æšk
 == 0)

382 
	`»move_Üphª_šode
(
	`F2FS_I_SB
(
dœ
), 
šode
->
i_šo
);

383 
	`šc_Æšk
(
šode
);

385  
·ge
;

387 
put_”rÜ
:

388 
	`f2fs_put_·ge
(
·ge
, 1);

389 
”rÜ
:

391 
	`Œunÿ‹_šode_·ges
(&
šode
->
i_d©a
, 0);

392 
	`Œunÿ‹_blocks
(
šode
, 0, 
çl£
);

393 
	`»move_dœty_dœ_šode
(
šode
);

394 
	`»move_šode_·ge
(
šode
);

395  
	`ERR_PTR
(
”r
);

396 
	}
}

398 
	$upd©e_·»Á_m‘ad©a
(
šode
 *
dœ
, inode *inode,

399 
cu¼’t_d•th
)

401 ià(
	`is_šode_æag_£t
(
	`F2FS_I
(
šode
), 
FI_NEW_INODE
)) {

402 ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

403 
	`šc_Æšk
(
dœ
);

404 
	`£t_šode_æag
(
	`F2FS_I
(
dœ
), 
FI_UPDATE_DIR
);

406 
	`ş—r_šode_æag
(
	`F2FS_I
(
šode
), 
FI_NEW_INODE
);

408 
dœ
->
i_mtime
 = dœ->
i_ùime
 = 
CURRENT_TIME
;

409 
	`m¬k_šode_dœty
(
dœ
);

411 ià(
	`F2FS_I
(
dœ
)->
i_cu¼’t_d•th
 !ğ
cu¼’t_d•th
) {

412 
	`F2FS_I
(
dœ
)->
i_cu¼’t_d•th
 = 
cu¼’t_d•th
;

413 
	`£t_šode_æag
(
	`F2FS_I
(
dœ
), 
FI_UPDATE_DIR
);

416 ià(
	`is_šode_æag_£t
(
	`F2FS_I
(
šode
), 
FI_INC_LINK
))

417 
	`ş—r_šode_æag
(
	`F2FS_I
(
šode
), 
FI_INC_LINK
);

418 
	}
}

420 
	$room_fÜ_f’ame
(
f2fs_d’Œy_block
 *
d’Œy_blk
, 
¦Ùs
)

422 
b™_¡¬t
 = 0;

423 
z”o_¡¬t
, 
z”o_’d
;

424 
Ãxt
:

425 
z”o_¡¬t
 = 
	`fšd_Ãxt_z”o_b™_Ë
(&
d’Œy_blk
->
d’Œy_b™m­
,

426 
NR_DENTRY_IN_BLOCK
,

427 
b™_¡¬t
);

428 ià(
z”o_¡¬t
 >ğ
NR_DENTRY_IN_BLOCK
)

429  
NR_DENTRY_IN_BLOCK
;

431 
z”o_’d
 = 
	`fšd_Ãxt_b™_Ë
(&
d’Œy_blk
->
d’Œy_b™m­
,

432 
NR_DENTRY_IN_BLOCK
,

433 
z”o_¡¬t
);

434 ià(
z”o_’d
 - 
z”o_¡¬t
 >ğ
¦Ùs
)

435  
z”o_¡¬t
;

437 
b™_¡¬t
 = 
z”o_’d
 + 1;

439 ià(
z”o_’d
 + 1 >ğ
NR_DENTRY_IN_BLOCK
)

440  
NR_DENTRY_IN_BLOCK
;

441 
Ãxt
;

442 
	}
}

448 
	$__f2fs_add_lšk
(
šode
 *
dœ
, cÚ¡ 
q¡r
 *
Çme
,

449 
šode
 *inode)

451 
b™_pos
;

452 
Ëv–
;

453 
cu¼’t_d•th
;

454 
bidx
, 
block
;

455 
f2fs_hash_t
 
d’Œy_hash
;

456 
f2fs_dœ_’Œy
 *
de
;

457 
nbuck‘
, 
nblock
;

458 
size_t
 
Çm–’
 = 
Çme
->
Ën
;

459 
·ge
 *
d’Œy_·ge
 = 
NULL
;

460 
f2fs_d’Œy_block
 *
d’Œy_blk
 = 
NULL
;

461 
¦Ùs
 = 
	`GET_DENTRY_SLOTS
(
Çm–’
);

462 
·ge
 *page;

463 
”r
 = 0;

464 
i
;

466 
d’Œy_hash
 = 
	`f2fs_d’Œy_hash
(
Çme
);

467 
Ëv–
 = 0;

468 
cu¼’t_d•th
 = 
	`F2FS_I
(
dœ
)->
i_cu¼’t_d•th
;

469 ià(
	`F2FS_I
(
dœ
)->
chash
 =ğ
d’Œy_hash
) {

470 
Ëv–
 = 
	`F2FS_I
(
dœ
)->
şev–
;

471 
	`F2FS_I
(
dœ
)->
chash
 = 0;

474 
¡¬t
:

475 ià(
	`uÆik–y
(
cu¼’t_d•th
 =ğ
MAX_DIR_HASH_DEPTH
))

476  -
ENOSPC
;

479 ià(
Ëv–
 =ğ
cu¼’t_d•th
)

480 ++
cu¼’t_d•th
;

482 
nbuck‘
 = 
	`dœ_buck‘s
(
Ëv–
, 
	`F2FS_I
(
dœ
)->
i_dœ_Ëv–
);

483 
nblock
 = 
	`buck‘_blocks
(
Ëv–
);

485 
bidx
 = 
	`dœ_block_šdex
(
Ëv–
, 
	`F2FS_I
(
dœ
)->
i_dœ_Ëv–
,

486 (
	`Ë32_to_ıu
(
d’Œy_hash
è% 
nbuck‘
));

488 
block
 = 
bidx
; block <ğ(bidx + 
nblock
 - 1); block++) {

489 
d’Œy_·ge
 = 
	`g‘_Ãw_d©a_·ge
(
dœ
, 
NULL
, 
block
, 
Œue
);

490 ià(
	`IS_ERR
(
d’Œy_·ge
))

491  
	`PTR_ERR
(
d’Œy_·ge
);

493 
d’Œy_blk
 = 
	`km­
(
d’Œy_·ge
);

494 
b™_pos
 = 
	`room_fÜ_f’ame
(
d’Œy_blk
, 
¦Ùs
);

495 ià(
b™_pos
 < 
NR_DENTRY_IN_BLOCK
)

496 
add_d’Œy
;

498 
	`kunm­
(
d’Œy_·ge
);

499 
	`f2fs_put_·ge
(
d’Œy_·ge
, 1);

503 ++
Ëv–
;

504 
¡¬t
;

505 
add_d’Œy
:

506 
	`f2fs_wa™_Ú_·ge_wr™eback
(
d’Œy_·ge
, 
DATA
);

508 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

509 
·ge
 = 
	`š™_šode_m‘ad©a
(
šode
, 
dœ
, 
Çme
);

510 ià(
	`IS_ERR
(
·ge
)) {

511 
”r
 = 
	`PTR_ERR
(
·ge
);

512 
ç
;

514 
de
 = &
d’Œy_blk
->
d’Œy
[
b™_pos
];

515 
de
->
hash_code
 = 
d’Œy_hash
;

516 
de
->
Çme_Ën
 = 
	`ıu_to_Ë16
(
Çm–’
);

517 
	`memıy
(
d’Œy_blk
->
f’ame
[
b™_pos
], 
Çme
->Çme,‚ame->
Ën
);

518 
de
->
šo
 = 
	`ıu_to_Ë32
(
šode
->
i_šo
);

519 
	`£t_de_ty³
(
de
, 
šode
);

520 
i
 = 0; i < 
¦Ùs
; i++)

521 
	`‹¡_ªd_£t_b™_Ë
(
b™_pos
 + 
i
, &
d’Œy_blk
->
d’Œy_b™m­
);

522 
	`£t_·ge_dœty
(
d’Œy_·ge
);

525 
	`F2FS_I
(
šode
)->
i_pšo
 = 
dœ
->
i_šo
;

526 
	`upd©e_šode
(
šode
, 
·ge
);

527 
	`f2fs_put_·ge
(
·ge
, 1);

529 
	`upd©e_·»Á_m‘ad©a
(
dœ
, 
šode
, 
cu¼’t_d•th
);

530 
ç
:

531 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

533 ià(
	`is_šode_æag_£t
(
	`F2FS_I
(
dœ
), 
FI_UPDATE_DIR
)) {

534 
	`upd©e_šode_·ge
(
dœ
);

535 
	`ş—r_šode_æag
(
	`F2FS_I
(
dœ
), 
FI_UPDATE_DIR
);

537 
	`kunm­
(
d’Œy_·ge
);

538 
	`f2fs_put_·ge
(
d’Œy_·ge
, 1);

539  
”r
;

540 
	}
}

542 
	$f2fs_do_tmpfe
(
šode
 *šode, šod*
dœ
)

544 
·ge
 *page;

545 
”r
 = 0;

547 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

548 
·ge
 = 
	`š™_šode_m‘ad©a
(
šode
, 
dœ
, 
NULL
);

549 ià(
	`IS_ERR
(
·ge
)) {

550 
”r
 = 
	`PTR_ERR
(
·ge
);

551 
ç
;

554 
	`upd©e_šode
(
šode
, 
·ge
);

555 
	`f2fs_put_·ge
(
·ge
, 1);

557 
	`ş—r_šode_æag
(
	`F2FS_I
(
šode
), 
FI_NEW_INODE
);

558 
ç
:

559 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

560  
”r
;

561 
	}
}

567 
	$f2fs_d–‘e_’Œy
(
f2fs_dœ_’Œy
 *
d’Œy
, 
·ge
 *page,

568 
šode
 *inode)

570 
f2fs_d’Œy_block
 *
d’Œy_blk
;

571 
b™_pos
;

572 
šode
 *
dœ
 = 
·ge
->
m­pšg
->
ho¡
;

573 
¦Ùs
 = 
	`GET_DENTRY_SLOTS
(
	`Ë16_to_ıu
(
d’Œy
->
Çme_Ën
));

574 
i
;

576 
	`lock_·ge
(
·ge
);

577 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
);

579 
d’Œy_blk
 = 
	`·ge_add»ss
(
·ge
);

580 
b™_pos
 = 
d’Œy
 - 
d’Œy_blk
->dentry;

581 
i
 = 0; i < 
¦Ùs
; i++)

582 
	`‹¡_ªd_ş—r_b™_Ë
(
b™_pos
 + 
i
, &
d’Œy_blk
->
d’Œy_b™m­
);

585 
b™_pos
 = 
	`fšd_Ãxt_b™_Ë
(&
d’Œy_blk
->
d’Œy_b™m­
,

586 
NR_DENTRY_IN_BLOCK
,

588 
	`kunm­
(
·ge
);

589 
	`£t_·ge_dœty
(
·ge
);

591 
dœ
->
i_ùime
 = dœ->
i_mtime
 = 
CURRENT_TIME
;

593 ià(
šode
) {

594 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

596 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

598 ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

599 
	`drİ_Æšk
(
dœ
);

600 
	`upd©e_šode_·ge
(
dœ
);

602 
šode
->
i_ùime
 = 
CURRENT_TIME
;

603 
	`drİ_Æšk
(
šode
);

604 ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

605 
	`drİ_Æšk
(
šode
);

606 
	`i_size_wr™e
(
šode
, 0);

608 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

609 
	`upd©e_šode_·ge
(
šode
);

611 ià(
šode
->
i_Æšk
 == 0)

612 
	`add_Üphª_šode
(
sbi
, 
šode
->
i_šo
);

614 
	`»Ëa£_Üphª_šode
(
sbi
);

617 ià(
b™_pos
 =ğ
NR_DENTRY_IN_BLOCK
) {

618 
	`Œunÿ‹_hŞe
(
dœ
, 
·ge
->
šdex
,…age->index + 1);

619 
	`ş—r_·ge_dœty_fÜ_io
(
·ge
);

620 
	`CË¬PageU±od©e
(
·ge
);

621 
	`šode_dec_dœty_·ges
(
dœ
);

623 
	`f2fs_put_·ge
(
·ge
, 1);

624 
	}
}

626 
boŞ
 
	$f2fs_em±y_dœ
(
šode
 *
dœ
)

628 
bidx
;

629 
·ge
 *
d’Œy_·ge
;

630 
b™_pos
;

631 
f2fs_d’Œy_block
 *
d’Œy_blk
;

632 
nblock
 = 
	`dœ_blocks
(
dœ
);

634 
bidx
 = 0; bidx < 
nblock
; bidx++) {

635 
d’Œy_·ge
 = 
	`g‘_lock_d©a_·ge
(
dœ
, 
bidx
);

636 ià(
	`IS_ERR
(
d’Œy_·ge
)) {

637 ià(
	`PTR_ERR
(
d’Œy_·ge
è=ğ-
ENOENT
)

640  
çl£
;

644 
d’Œy_blk
 = 
	`km­_©omic
(
d’Œy_·ge
);

645 ià(
bidx
 == 0)

646 
b™_pos
 = 2;

648 
b™_pos
 = 0;

649 
b™_pos
 = 
	`fšd_Ãxt_b™_Ë
(&
d’Œy_blk
->
d’Œy_b™m­
,

650 
NR_DENTRY_IN_BLOCK
,

651 
b™_pos
);

652 
	`kunm­_©omic
(
d’Œy_blk
);

654 
	`f2fs_put_·ge
(
d’Œy_·ge
, 1);

656 ià(
b™_pos
 < 
NR_DENTRY_IN_BLOCK
)

657  
çl£
;

659  
Œue
;

660 
	}
}

662 
	$f2fs_»addœ
(
fe
 *fe, 
dœ_cÚ‹xt
 *
ùx
)

664 
šode
 *šodğ
	`fe_šode
(
fe
);

665 
Åages
 = 
	`dœ_blocks
(
šode
);

666 
b™_pos
 = 0;

667 
f2fs_d’Œy_block
 *
d’Œy_blk
 = 
NULL
;

668 
f2fs_dœ_’Œy
 *
de
 = 
NULL
;

669 
·ge
 *
d’Œy_·ge
 = 
NULL
;

670 
fe_¿_¡©e
 *
¿
 = &
fe
->
f_¿
;

671 
n
 = (()
ùx
->
pos
 / 
NR_DENTRY_IN_BLOCK
);

672 
d_ty³
 = 
DT_UNKNOWN
;

674 
b™_pos
 = (()
ùx
->
pos
 % 
NR_DENTRY_IN_BLOCK
);

677 ià(
Åages
 - 
n
 > 1 && !
	`¿_has_šdex
(
¿
,‚))

678 
	`·ge_ÿche_sync_»adah—d
(
šode
->
i_m­pšg
, 
¿
, 
fe
, 
n
,

679 
	`mš
(
Åages
 - 
n
, (
pgoff_t
)
MAX_DIR_RA_PAGES
));

681 ; 
n
 < 
Åages
;‚++) {

682 
d’Œy_·ge
 = 
	`g‘_lock_d©a_·ge
(
šode
, 
n
);

683 ià(
	`IS_ERR
(
d’Œy_·ge
))

686 
d’Œy_blk
 = 
	`km­
(
d’Œy_·ge
);

687 
b™_pos
 < 
NR_DENTRY_IN_BLOCK
) {

688 
b™_pos
 = 
	`fšd_Ãxt_b™_Ë
(&
d’Œy_blk
->
d’Œy_b™m­
,

689 
NR_DENTRY_IN_BLOCK
,

690 
b™_pos
);

691 ià(
b™_pos
 >ğ
NR_DENTRY_IN_BLOCK
)

694 
de
 = &
d’Œy_blk
->
d’Œy
[
b™_pos
];

695 ià(
de
->
fe_ty³
 < 
F2FS_FT_MAX
)

696 
d_ty³
 = 
f2fs_f‘y³_bË
[
de
->
fe_ty³
];

698 
d_ty³
 = 
DT_UNKNOWN
;

699 ià(!
	`dœ_em™
(
ùx
,

700 
d’Œy_blk
->
f’ame
[
b™_pos
],

701 
	`Ë16_to_ıu
(
de
->
Çme_Ën
),

702 
	`Ë32_to_ıu
(
de
->
šo
), 
d_ty³
))

703 
¡İ
;

705 
b™_pos
 +ğ
	`GET_DENTRY_SLOTS
(
	`Ë16_to_ıu
(
de
->
Çme_Ën
));

706 
ùx
->
pos
 = 
n
 * 
NR_DENTRY_IN_BLOCK
 + 
b™_pos
;

708 
b™_pos
 = 0;

709 
ùx
->
pos
 = (
n
 + 1è* 
NR_DENTRY_IN_BLOCK
;

710 
	`kunm­
(
d’Œy_·ge
);

711 
	`f2fs_put_·ge
(
d’Œy_·ge
, 1);

712 
d’Œy_·ge
 = 
NULL
;

714 
¡İ
:

715 ià(
d’Œy_·ge
 && !
	`IS_ERR
(dentry_page)) {

716 
	`kunm­
(
d’Œy_·ge
);

717 
	`f2fs_put_·ge
(
d’Œy_·ge
, 1);

721 
	}
}

723 cÚ¡ 
fe_İ”©iÚs
 
	gf2fs_dœ_İ”©iÚs
 = {

724 .
Î£ek
 = 
g’”ic_fe_Î£ek
,

725 .
	g»ad
 = 
g’”ic_»ad_dœ
,

726 .
	g™”©e
 = 
f2fs_»addœ
,

727 .
	gfsync
 = 
f2fs_sync_fe
,

728 .
	guÆocked_ioùl
 = 
f2fs_ioùl
,

	@f2fs.h

11 #iâdeà
_LINUX_F2FS_H


12 
	#_LINUX_F2FS_H


	)

14 
	~<lšux/ty³s.h
>

15 
	~<lšux/·ge-æags.h
>

16 
	~<lšux/bufãr_h—d.h
>

17 
	~<lšux/¦ab.h
>

18 
	~<lšux/üc32.h
>

19 
	~<lšux/magic.h
>

20 
	~<lšux/kobjeù.h
>

21 
	~<lšux/sched.h
>

24 
	#F2FS_DA_MAP


	)

26 #ifdeà
CONFIG_F2FS_CHECK_FS


27 
	#f2fs_bug_Ú
(
sbi
, 
cÚd™iÚ
è
	`BUG_ON
(cÚd™iÚ)

	)

28 
	#f2fs_down_wr™e
(
x
, 
y
è
	`down_wr™e_Ã¡_lock
(x, y)

	)

30 
	#f2fs_bug_Ú
(
sbi
, 
cÚd™iÚ
) \

32 ià(
	`uÆik–y
(
cÚd™iÚ
)) { \

33 
	`WARN_ON
(1); \

34 
sbi
->
Ãed_fsck
 = 
Œue
; \

36 } 0)

	)

37 
	#f2fs_down_wr™e
(
x
, 
y
è
	`down_wr™e
(x)

	)

43 
	#F2FS_MOUNT_BG_GC
 0x00000001

	)

44 
	#F2FS_MOUNT_DISABLE_ROLL_FORWARD
 0x00000002

	)

45 
	#F2FS_MOUNT_DISCARD
 0x00000004

	)

46 
	#F2FS_MOUNT_NOHEAP
 0x00000008

	)

47 
	#F2FS_MOUNT_XATTR_USER
 0x00000010

	)

48 
	#F2FS_MOUNT_POSIX_ACL
 0x00000020

	)

49 
	#F2FS_MOUNT_DISABLE_EXT_IDENTIFY
 0x00000040

	)

50 
	#F2FS_MOUNT_INLINE_XATTR
 0x00000080

	)

51 
	#F2FS_MOUNT_INLINE_DATA
 0x00000100

	)

52 
	#F2FS_MOUNT_FLUSH_MERGE
 0x00000200

	)

53 
	#F2FS_MOUNT_NOBARRIER
 0x00000400

	)

55 
	#ş—r_İt
(
sbi
, 
İtiÚ
è(sbi->
mouÁ_İt
.
İt
 &ğ~
F2FS_MOUNT_
##İtiÚ)

	)

56 
	#£t_İt
(
sbi
, 
İtiÚ
è(sbi->
mouÁ_İt
.
İt
 |ğ
F2FS_MOUNT_
##İtiÚ)

	)

57 
	#‹¡_İt
(
sbi
, 
İtiÚ
è(sbi->
mouÁ_İt
.
İt
 & 
F2FS_MOUNT_
##İtiÚ)

	)

59 
	#v”_aá”
(
a
, 
b
è(
	`ty³check
(,‡) && \

60 
	`ty³check
(, 
b
) && \

61 (()((
a
è- (
b
)è> 0))

	)

63 
u32
 
	tblock_t
;

67 
u32
 
	tnid_t
;

69 
	sf2fs_mouÁ_šfo
 {

70 
	mİt
;

73 
	#CRCPOLY_LE
 0xedb88320

	)

75 
šlše
 
__u32
 
	$f2fs_üc32
(*
buf
, 
size_t
 
Ën
)

77 *
p
 = (*)
buf
;

78 
__u32
 
üc
 = 
F2FS_SUPER_MAGIC
;

79 
i
;

81 
Ën
--) {

82 
üc
 ^ğ*
p
++;

83 
i
 = 0; i < 8; i++)

84 
üc
 = (üø>> 1è^ ((üø& 1è? 
CRCPOLY_LE
 : 0);

86  
üc
;

87 
	}
}

89 
šlše
 
boŞ
 
	$f2fs_üc_v®id
(
__u32
 
blk_üc
, *
buf
, 
size_t
 
buf_size
)

91  
	`f2fs_üc32
(
buf
, 
buf_size
è=ğ
blk_üc
;

92 
	}
}

98 
	mNAT_BITMAP
,

99 
	mSIT_BITMAP


103 
	mCP_UMOUNT
,

104 
	mCP_SYNC
,

105 
	mCP_DISCARD
,

108 
	sı_cÚŒŞ
 {

109 
	m»asÚ
;

110 
__u64
 
	mŒim_¡¬t
;

111 
__u64
 
	mŒim_’d
;

112 
__u64
 
	mŒim_mšËn
;

113 
__u64
 
	mŒimmed
;

120 
	mMETA_CP
,

121 
	mMETA_NAT
,

122 
	mMETA_SIT
,

123 
	mMETA_SSA
,

124 
	mMETA_POR
,

129 
	mORPHAN_INO
,

130 
	mAPPEND_INO
,

131 
	mUPDATE_INO
,

132 
	mMAX_INO_ENTRY
,

135 
	sšo_’Œy
 {

136 
li¡_h—d
 
	mli¡
;

137 
nid_t
 
	mšo
;

141 
	sdœ_šode_’Œy
 {

142 
li¡_h—d
 
	mli¡
;

143 
šode
 *
	mšode
;

147 
	sdisÿrd_’Œy
 {

148 
li¡_h—d
 
	mli¡
;

149 
block_t
 
	mblkaddr
;

150 
	mËn
;

154 
	sfsync_šode_’Œy
 {

155 
li¡_h—d
 
	mli¡
;

156 
šode
 *
	mšode
;

157 
block_t
 
	mblkaddr
;

158 
block_t
 
	mÏ¡_d’Œy
;

159 
block_t
 
	mÏ¡_šode
;

162 
	#Çts_š_cursum
(
sum
è(
	`Ë16_to_ıu
(sum->
n_Çts
))

	)

163 
	#s™s_š_cursum
(
sum
è(
	`Ë16_to_ıu
(sum->
n_s™s
))

	)

165 
	#Çt_š_jouº®
(
sum
, 
i
è(sum->
Çt_j
.
’Œ›s
[i].
Ã
)

	)

166 
	#nid_š_jouº®
(
sum
, 
i
è(sum->
Çt_j
.
’Œ›s
[i].
nid
)

	)

167 
	#s™_š_jouº®
(
sum
, 
i
è(sum->
s™_j
.
’Œ›s
[i].
£
)

	)

168 
	#£gno_š_jouº®
(
sum
, 
i
è(sum->
s™_j
.
’Œ›s
[i].
£gno
)

	)

170 
	#MAX_NAT_JENTRIES
(
sum
è(
NAT_JOURNAL_ENTRIES
 - 
	`Çts_š_cursum
(sum))

	)

171 
	#MAX_SIT_JENTRIES
(
sum
è(
SIT_JOURNAL_ENTRIES
 - 
	`s™s_š_cursum
(sum))

	)

173 
šlše
 
	$upd©e_Çts_š_cursum
(
f2fs_summ¬y_block
 *
rs
, 
i
)

175 
befÜe
 = 
	`Çts_š_cursum
(
rs
);

176 
rs
->
n_Çts
 = 
	`ıu_to_Ë16
(
befÜe
 + 
i
);

177  
befÜe
;

178 
	}
}

180 
šlše
 
	$upd©e_s™s_š_cursum
(
f2fs_summ¬y_block
 *
rs
, 
i
)

182 
befÜe
 = 
	`s™s_š_cursum
(
rs
);

183 
rs
->
n_s™s
 = 
	`ıu_to_Ë16
(
befÜe
 + 
i
);

184  
befÜe
;

185 
	}
}

187 
šlše
 
boŞ
 
	$__has_cursum_¥aû
(
f2fs_summ¬y_block
 *
sum
, 
size
,

188 
ty³
)

190 ià(
ty³
 =ğ
NAT_JOURNAL
)

191  
size
 <ğ
	`MAX_NAT_JENTRIES
(
sum
);

192  
size
 <ğ
	`MAX_SIT_JENTRIES
(
sum
);

193 
	}
}

198 
	#F2FS_IOC_GETFLAGS
 
FS_IOC_GETFLAGS


	)

199 
	#F2FS_IOC_SETFLAGS
 
FS_IOC_SETFLAGS


	)

201 
	#F2FS_IOCTL_MAGIC
 0xf5

	)

202 
	#F2FS_IOC_START_ATOMIC_WRITE
 
	`_IO
(
F2FS_IOCTL_MAGIC
, 1)

	)

203 
	#F2FS_IOC_COMMIT_ATOMIC_WRITE
 
	`_IO
(
F2FS_IOCTL_MAGIC
, 2)

	)

204 
	#F2FS_IOC_START_VOLATILE_WRITE
 
	`_IO
(
F2FS_IOCTL_MAGIC
, 3)

	)

206 #ià
defšed
(
__KERNEL__
è&& defšed(
CONFIG_COMPAT
)

210 
	#F2FS_IOC32_GETFLAGS
 
FS_IOC32_GETFLAGS


	)

211 
	#F2FS_IOC32_SETFLAGS
 
FS_IOC32_SETFLAGS


	)

222 
	#XATTR_NODE_OFFSET
 (((()-1è<< 
OFFSET_BIT_SHIFT
) \

223 >> 
OFFSET_BIT_SHIFT
)

	)

225 
	mALLOC_NODE
,

226 
	mLOOKUP_NODE
,

227 
	mLOOKUP_NODE_RA
,

233 
	#F2FS_LINK_MAX
 32000

	)

235 
	#MAX_DIR_RA_PAGES
 4

	)

238 
	#F2FS_MIN_EXTENT_LEN
 16

	)

240 
	sex‹Á_šfo
 {

241 
rwlock_t
 
	mext_lock
;

242 
	mfofs
;

243 
u32
 
	mblk_addr
;

244 
	mËn
;

250 
	#FADVISE_COLD_BIT
 0x01

	)

251 
	#FADVISE_LOST_PINO_BIT
 0x02

	)

253 
	#DEF_DIR_LEVEL
 0

	)

255 
	sf2fs_šode_šfo
 {

256 
šode
 
	mvfs_šode
;

257 
	mi_æags
;

258 
	mi_advi£
;

259 
	mi_dœ_Ëv–
;

260 
	mi_cu¼’t_d•th
;

261 
	mi_pšo
;

262 
umode_t
 
	mi_aş_mode
;

265 
	mæags
;

266 
rw_£m­hÜe
 
	mi_£m
;

267 
©omic_t
 
	mdœty_·ges
;

268 
f2fs_hash_t
 
	mchash
;

269 
	mşev–
;

270 
nid_t
 
	mi_x©Œ_nid
;

271 
	mx©Œ_v”
;

272 
ex‹Á_šfo
 
	mext
;

273 
dœ_šode_’Œy
 *
	mdœty_dœ
;

275 
li¡_h—d
 
	mšmem_·ges
;

276 
mu‹x
 
	mšmem_lock
;

279 
šlše
 
	$g‘_ex‹Á_šfo
(
ex‹Á_šfo
 *
ext
,

280 
f2fs_ex‹Á
 
i_ext
)

282 
	`wr™e_lock
(&
ext
->
ext_lock
);

283 
ext
->
fofs
 = 
	`Ë32_to_ıu
(
i_ext
.fofs);

284 
ext
->
blk_addr
 = 
	`Ë32_to_ıu
(
i_ext
.blk_addr);

285 
ext
->
Ën
 = 
	`Ë32_to_ıu
(
i_ext
.len);

286 
	`wr™e_uÆock
(&
ext
->
ext_lock
);

287 
	}
}

289 
šlše
 
	$£t_¿w_ex‹Á
(
ex‹Á_šfo
 *
ext
,

290 
f2fs_ex‹Á
 *
i_ext
)

292 
	`»ad_lock
(&
ext
->
ext_lock
);

293 
i_ext
->
fofs
 = 
	`ıu_to_Ë32
(
ext
->fofs);

294 
i_ext
->
blk_addr
 = 
	`ıu_to_Ë32
(
ext
->blk_addr);

295 
i_ext
->
Ën
 = 
	`ıu_to_Ë32
(
ext
->len);

296 
	`»ad_uÆock
(&
ext
->
ext_lock
);

297 
	}
}

299 
	sf2fs_nm_šfo
 {

300 
block_t
 
	mÇt_blkaddr
;

301 
nid_t
 
	mmax_nid
;

302 
nid_t
 
	mavaabË_nids
;

303 
nid_t
 
	mÃxt_sÿn_nid
;

304 
	m¿m_th»sh
;

307 
¿dix_Œ“_roÙ
 
	mÇt_roÙ
;

308 
¿dix_Œ“_roÙ
 
	mÇt_£t_roÙ
;

309 
rwlock_t
 
	mÇt_Œ“_lock
;

310 
li¡_h—d
 
	mÇt_’Œ›s
;

311 
	mÇt_út
;

312 
	mdœty_Çt_út
;

315 
¿dix_Œ“_roÙ
 
	mä“_nid_roÙ
;

316 
li¡_h—d
 
	mä“_nid_li¡
;

317 
¥šlock_t
 
	mä“_nid_li¡_lock
;

318 
	mfút
;

319 
mu‹x
 
	mbud_lock
;

322 *
	mÇt_b™m­
;

323 
	mb™m­_size
;

331 
	sdnode_of_d©a
 {

332 
šode
 *
	mšode
;

333 
·ge
 *
	mšode_·ge
;

334 
·ge
 *
	mnode_·ge
;

335 
nid_t
 
	mnid
;

336 
	mofs_š_node
;

337 
boŞ
 
	mšode_·ge_locked
;

338 
block_t
 
	md©a_blkaddr
;

341 
šlše
 
	$£t_Ãw_dnode
(
dnode_of_d©a
 *
dn
, 
šode
 *inode,

342 
·ge
 *
age
, ·g*
Åage
, 
nid_t
 
nid
)

344 
	`mem£t
(
dn
, 0, (*dn));

345 
dn
->
šode
 = inode;

346 
dn
->
šode_·ge
 = 
age
;

347 
dn
->
node_·ge
 = 
Åage
;

348 
dn
->
nid
 =‚id;

349 
	}
}

364 
	#NR_CURSEG_DATA_TYPE
 (3)

	)

365 
	#NR_CURSEG_NODE_TYPE
 (3)

	)

366 
	#NR_CURSEG_TYPE
 (
NR_CURSEG_DATA_TYPE
 + 
NR_CURSEG_NODE_TYPE
)

	)

369 
	mCURSEG_HOT_DATA
 = 0,

370 
	mCURSEG_WARM_DATA
,

371 
	mCURSEG_COLD_DATA
,

372 
	mCURSEG_HOT_NODE
,

373 
	mCURSEG_WARM_NODE
,

374 
	mCURSEG_COLD_NODE
,

375 
	mNO_CHECK_TYPE


378 
	sæush_cmd
 {

379 
com¶‘iÚ
 
	mwa™
;

380 
Îi¡_node
 
	mÎnode
;

381 
	m»t
;

384 
	sæush_cmd_cÚŒŞ
 {

385 
sk_¡ruù
 *
	mf2fs_issue_æush
;

386 
wa™_queue_h—d_t
 
	mæush_wa™_queue
;

387 
Îi¡_h—d
 
	missue_li¡
;

388 
Îi¡_node
 *
	mdi¥©ch_li¡
;

391 
	sf2fs_sm_šfo
 {

392 
s™_šfo
 *
	ms™_šfo
;

393 
ä“_£gm­_šfo
 *
	mä“_šfo
;

394 
dœty_£gli¡_šfo
 *
	mdœty_šfo
;

395 
cur£g_šfo
 *
	mcur£g_¬¿y
;

397 
block_t
 
	m£g0_blkaddr
;

398 
block_t
 
	mmaš_blkaddr
;

399 
block_t
 
	ms§_blkaddr
;

401 
	m£gm’t_couÁ
;

402 
	mmaš_£gm’ts
;

403 
	m»£rved_£gm’ts
;

404 
	movp_£gm’ts
;

407 
	m»c_´eä“_£gm’ts
;

410 
li¡_h—d
 
	mdisÿrd_li¡
;

411 
	mÄ_disÿrds
;

412 
	mmax_disÿrds
;

414 
li¡_h—d
 
	ms™_’Œy_£t
;

416 
	mu_pŞicy
;

417 
	mmš_u_ut
;

418 
	mmš_fsync_blocks
;

421 
æush_cmd_cÚŒŞ
 *
	mcmd_cÚŒŞ_šfo
;

434 
	ecouÁ_ty³
 {

435 
	mF2FS_WRITEBACK
,

436 
	mF2FS_DIRTY_DENTS
,

437 
	mF2FS_DIRTY_NODES
,

438 
	mF2FS_DIRTY_META
,

439 
	mNR_COUNT_TYPE
,

453 
	#PAGE_TYPE_OF_BIO
(
ty³
è(Ñy³è> 
META
 ? META : (ty³))

	)

454 
	e·ge_ty³
 {

455 
	mDATA
,

456 
	mNODE
,

457 
	mMETA
,

458 
	mNR_PAGE_TYPE
,

459 
	mMETA_FLUSH
,

462 
	sf2fs_io_šfo
 {

463 
·ge_ty³
 
	mty³
;

464 
	mrw
;

467 #ifdeà
F2FS_DA_MAP


468 
	sf2fs_da_io_šfo
 {

469 
block_t
 
	mŞd_blkaddr
;

470 
	mty³
;

471 
f2fs_summ¬y
 *
	msum
;

475 
	#is_»ad_io
(
rw
è((Ôwè& 1è=ğ
READ
)

	)

476 
	sf2fs_bio_šfo
 {

477 
f2fs_sb_šfo
 *
	msbi
;

478 
bio
 *
	mbio
;

479 
£ùÜ_t
 
	mÏ¡_block_š_bio
;

480 
f2fs_io_šfo
 
	mfio
;

481 
rw_£m­hÜe
 
	mio_rw£m
;

484 
	sf2fs_sb_šfo
 {

485 
su³r_block
 *
	msb
;

486 
´oc_dœ_’Œy
 *
	ms_´oc
;

487 
bufãr_h—d
 *
	m¿w_su³r_buf
;

488 
f2fs_su³r_block
 *
	m¿w_su³r
;

489 
	ms_dœty
;

490 
boŞ
 
	mÃed_fsck
;

493 
f2fs_nm_šfo
 *
	mnm_šfo
;

494 
šode
 *
	mnode_šode
;

497 
f2fs_sm_šfo
 *
	msm_šfo
;

500 
f2fs_bio_šfo
 
	m»ad_io
;

501 
f2fs_bio_šfo
 
	mwr™e_io
[
NR_PAGE_TYPE
];

502 
com¶‘iÚ
 *
	mwa™_io
;

505 
f2fs_checkpošt
 *
	mck±
;

506 
šode
 *
	mm‘a_šode
;

507 
mu‹x
 
	mı_mu‹x
;

508 
rw_£m­hÜe
 
	mı_rw£m
;

509 
rw_£m­hÜe
 
	mnode_wr™e
;

510 
mu‹x
 
	mwr™•ages
;

511 
boŞ
 
	mpÜ_došg
;

512 
wa™_queue_h—d_t
 
	mı_wa™
;

515 
¿dix_Œ“_roÙ
 
	mšo_roÙ
[
MAX_INO_ENTRY
];

516 
¥šlock_t
 
	mšo_lock
[
MAX_INO_ENTRY
];

517 
li¡_h—d
 
	mšo_li¡
[
MAX_INO_ENTRY
];

520 
	mn_Üphªs
;

521 
	mmax_Üphªs
;

524 
li¡_h—d
 
	mdœ_šode_li¡
;

525 
¥šlock_t
 
	mdœ_šode_lock
;

528 
	mlog_£ùÜs_³r_block
;

529 
	mlog_blocksize
;

530 
	mblocksize
;

531 
	mroÙ_šo_num
;

532 
	mnode_šo_num
;

533 
	mm‘a_šo_num
;

534 
	mlog_blocks_³r_£g
;

535 
	mblocks_³r_£g
;

536 
	m£gs_³r_£c
;

537 
	m£cs_³r_zÚe
;

538 
	mtÙ®_£ùiÚs
;

539 
	mtÙ®_node_couÁ
;

540 
	mtÙ®_v®id_node_couÁ
;

541 
	mtÙ®_v®id_šode_couÁ
;

542 
	maùive_logs
;

543 
	mdœ_Ëv–
;

545 
block_t
 
	mu£r_block_couÁ
;

546 
block_t
 
	mtÙ®_v®id_block_couÁ
;

547 
block_t
 
	m®loc_v®id_block_couÁ
;

548 
block_t
 
	mÏ¡_v®id_block_couÁ
;

549 
u32
 
	ms_Ãxt_g’”©iÚ
;

550 
©omic_t
 
	mÄ_·ges
[
NR_COUNT_TYPE
];

552 
f2fs_mouÁ_šfo
 
	mmouÁ_İt
;

555 
mu‹x
 
	mgc_mu‹x
;

556 
f2fs_gc_kth»ad
 *
	mgc_th»ad
;

557 
	mcur_viùim_£c
;

560 
	mmax_viùim_£¬ch
;

566 #ifdeà
CONFIG_F2FS_STAT_FS


567 
f2fs_¡©_šfo
 *
	m¡©_šfo
;

568 
	m£gm’t_couÁ
[2];

569 
	mblock_couÁ
[2];

570 
	mtÙ®_h™_ext
, 
	m»ad_h™_ext
;

571 
	mšlše_šode
;

572 
	mbg_gc
;

573 
	mn_dœty_dœs
;

575 
	mÏ¡_viùim
[2];

576 
¥šlock_t
 
	m¡©_lock
;

579 
kobjeù
 
	ms_kobj
;

580 
com¶‘iÚ
 
	ms_kobj_uÄegi¡”
;

586 
šlše
 
f2fs_šode_šfo
 *
	$F2FS_I
(
šode
 *inode)

588  
	`cÚš”_of
(
šode
, 
f2fs_šode_šfo
, 
vfs_šode
);

589 
	}
}

591 
šlše
 
f2fs_sb_šfo
 *
	$F2FS_SB
(
su³r_block
 *
sb
)

593  
sb
->
s_fs_šfo
;

594 
	}
}

596 
šlše
 
f2fs_sb_šfo
 *
	$F2FS_I_SB
(
šode
 *inode)

598  
	`F2FS_SB
(
šode
->
i_sb
);

599 
	}
}

601 
šlše
 
f2fs_sb_šfo
 *
	$F2FS_M_SB
(
add»ss_¥aû
 *
m­pšg
)

603  
	`F2FS_I_SB
(
m­pšg
->
ho¡
);

604 
	}
}

606 
šlše
 
f2fs_sb_šfo
 *
	$F2FS_P_SB
(
·ge
 *page)

608  
	`F2FS_M_SB
(
·ge
->
m­pšg
);

609 
	}
}

611 
šlše
 
f2fs_su³r_block
 *
	$F2FS_RAW_SUPER
(
f2fs_sb_šfo
 *
sbi
)

613  (
f2fs_su³r_block
 *)(
sbi
->
¿w_su³r
);

614 
	}
}

616 
šlše
 
f2fs_checkpošt
 *
	$F2FS_CKPT
(
f2fs_sb_šfo
 *
sbi
)

618  (
f2fs_checkpošt
 *)(
sbi
->
ck±
);

619 
	}
}

621 
šlše
 
f2fs_node
 *
	$F2FS_NODE
(
·ge
 *page)

623  (
f2fs_node
 *)
	`·ge_add»ss
(
·ge
);

624 
	}
}

626 
šlše
 
f2fs_šode
 *
	$F2FS_INODE
(
·ge
 *page)

628  &((
f2fs_node
 *)
	`·ge_add»ss
(
·ge
))->
i
;

629 
	}
}

631 
šlše
 
f2fs_nm_šfo
 *
	$NM_I
(
f2fs_sb_šfo
 *
sbi
)

633  (
f2fs_nm_šfo
 *)(
sbi
->
nm_šfo
);

634 
	}
}

636 
šlše
 
f2fs_sm_šfo
 *
	$SM_I
(
f2fs_sb_šfo
 *
sbi
)

638  (
f2fs_sm_šfo
 *)(
sbi
->
sm_šfo
);

639 
	}
}

641 
šlše
 
s™_šfo
 *
	$SIT_I
(
f2fs_sb_šfo
 *
sbi
)

643  (
s™_šfo
 *)(
	`SM_I
(
sbi
)->sit_info);

644 
	}
}

646 
šlše
 
ä“_£gm­_šfo
 *
	$FREE_I
(
f2fs_sb_šfo
 *
sbi
)

648  (
ä“_£gm­_šfo
 *)(
	`SM_I
(
sbi
)->
ä“_šfo
);

649 
	}
}

651 
šlše
 
dœty_£gli¡_šfo
 *
	$DIRTY_I
(
f2fs_sb_šfo
 *
sbi
)

653  (
dœty_£gli¡_šfo
 *)(
	`SM_I
(
sbi
)->
dœty_šfo
);

654 
	}
}

656 
šlše
 
add»ss_¥aû
 *
	$META_MAPPING
(
f2fs_sb_šfo
 *
sbi
)

658  
sbi
->
m‘a_šode
->
i_m­pšg
;

659 
	}
}

661 
šlše
 
add»ss_¥aû
 *
	$NODE_MAPPING
(
f2fs_sb_šfo
 *
sbi
)

663  
sbi
->
node_šode
->
i_m­pšg
;

664 
	}
}

666 
šlše
 
	$F2FS_SET_SB_DIRT
(
f2fs_sb_šfo
 *
sbi
)

668 
sbi
->
s_dœty
 = 1;

669 
	}
}

671 
šlše
 
	$F2FS_RESET_SB_DIRT
(
f2fs_sb_šfo
 *
sbi
)

673 
sbi
->
s_dœty
 = 0;

674 
	}
}

676 
šlše
 
	$cur_ı_v”siÚ
(
f2fs_checkpošt
 *
ı
)

678  
	`Ë64_to_ıu
(
ı
->
checkpošt_v”
);

679 
	}
}

681 
šlše
 
boŞ
 
	$is_£t_ck±_æags
(
f2fs_checkpošt
 *
ı
, 
f
)

683 
ck±_æags
 = 
	`Ë32_to_ıu
(
ı
->ckpt_flags);

684  
ck±_æags
 & 
f
;

685 
	}
}

687 
šlše
 
	$£t_ck±_æags
(
f2fs_checkpošt
 *
ı
, 
f
)

689 
ck±_æags
 = 
	`Ë32_to_ıu
(
ı
->ckpt_flags);

690 
ck±_æags
 |ğ
f
;

691 
ı
->
ck±_æags
 = 
	`ıu_to_Ë32
(ckpt_flags);

692 
	}
}

694 
šlše
 
	$ş—r_ck±_æags
(
f2fs_checkpošt
 *
ı
, 
f
)

696 
ck±_æags
 = 
	`Ë32_to_ıu
(
ı
->ckpt_flags);

697 
ck±_æags
 &ğ(~
f
);

698 
ı
->
ck±_æags
 = 
	`ıu_to_Ë32
(ckpt_flags);

699 
	}
}

701 
šlše
 
	$f2fs_lock_İ
(
f2fs_sb_šfo
 *
sbi
)

703 
	`down_»ad
(&
sbi
->
ı_rw£m
);

704 
	}
}

706 
šlše
 
	$f2fs_uÆock_İ
(
f2fs_sb_šfo
 *
sbi
)

708 
	`up_»ad
(&
sbi
->
ı_rw£m
);

709 
	}
}

711 
šlše
 
	$f2fs_lock_®l
(
f2fs_sb_šfo
 *
sbi
)

713 
	`f2fs_down_wr™e
(&
sbi
->
ı_rw£m
, &sbi->
ı_mu‹x
);

714 
	}
}

716 
šlše
 
	$f2fs_uÆock_®l
(
f2fs_sb_šfo
 *
sbi
)

718 
	`up_wr™e
(&
sbi
->
ı_rw£m
);

719 
	}
}

724 
šlše
 
	$check_nid_¿nge
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
)

726 ià(
	`uÆik–y
(
nid
 < 
	`F2FS_ROOT_INO
(
sbi
)))

727  -
EINVAL
;

728 ià(
	`uÆik–y
(
nid
 >ğ
	`NM_I
(
sbi
)->
max_nid
))

729  -
EINVAL
;

731 
	}
}

733 
	#F2FS_DEFAULT_ALLOCATED_BLOCKS
 1

	)

738 
šlše
 
	$F2FS_HAS_BLOCKS
(
šode
 *inode)

740 ià(
	`F2FS_I
(
šode
)->
i_x©Œ_nid
)

741  
šode
->
i_blocks
 > 
F2FS_DEFAULT_ALLOCATED_BLOCKS
 + 1;

743  
šode
->
i_blocks
 > 
F2FS_DEFAULT_ALLOCATED_BLOCKS
;

744 
	}
}

746 
šlše
 
boŞ
 
	$f2fs_has_x©Œ_block
(
ofs
)

748  
ofs
 =ğ
XATTR_NODE_OFFSET
;

749 
	}
}

751 
šlše
 
boŞ
 
	$šc_v®id_block_couÁ
(
f2fs_sb_šfo
 *
sbi
,

752 
šode
 *šode, 
blkút_t
 
couÁ
)

754 
block_t
 
v®id_block_couÁ
;

756 
	`¥š_lock
(&
sbi
->
¡©_lock
);

757 
v®id_block_couÁ
 =

758 
sbi
->
tÙ®_v®id_block_couÁ
 + (
block_t
)
couÁ
;

759 ià(
	`uÆik–y
(
v®id_block_couÁ
 > 
sbi
->
u£r_block_couÁ
)) {

760 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

761  
çl£
;

763 
šode
->
i_blocks
 +ğ
couÁ
;

764 
sbi
->
tÙ®_v®id_block_couÁ
 = 
v®id_block_couÁ
;

765 
sbi
->
®loc_v®id_block_couÁ
 +ğ(
block_t
)
couÁ
;

766 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

767  
Œue
;

768 
	}
}

770 
šlše
 
	$dec_v®id_block_couÁ
(
f2fs_sb_šfo
 *
sbi
,

771 
šode
 *inode,

772 
blkút_t
 
couÁ
)

774 
	`¥š_lock
(&
sbi
->
¡©_lock
);

775 
	`f2fs_bug_Ú
(
sbi
, sbi->
tÙ®_v®id_block_couÁ
 < (
block_t
è
couÁ
);

776 
	`f2fs_bug_Ú
(
sbi
, 
šode
->
i_blocks
 < 
couÁ
);

777 
šode
->
i_blocks
 -ğ
couÁ
;

778 
sbi
->
tÙ®_v®id_block_couÁ
 -ğ(
block_t
)
couÁ
;

779 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

780 
	}
}

782 
šlše
 
	$šc_·ge_couÁ
(
f2fs_sb_šfo
 *
sbi
, 
couÁ_ty³
)

784 
	`©omic_šc
(&
sbi
->
Ä_·ges
[
couÁ_ty³
]);

785 
	`F2FS_SET_SB_DIRT
(
sbi
);

786 
	}
}

788 
šlše
 
	$šode_šc_dœty_·ges
(
šode
 *inode)

790 
	`©omic_šc
(&
	`F2FS_I
(
šode
)->
dœty_·ges
);

791 ià(
	`S_ISDIR
(
šode
->
i_mode
))

792 
	`šc_·ge_couÁ
(
	`F2FS_I_SB
(
šode
), 
F2FS_DIRTY_DENTS
);

793 
	}
}

795 
šlše
 
	$dec_·ge_couÁ
(
f2fs_sb_šfo
 *
sbi
, 
couÁ_ty³
)

797 
	`©omic_dec
(&
sbi
->
Ä_·ges
[
couÁ_ty³
]);

798 
	}
}

800 
šlše
 
	$šode_dec_dœty_·ges
(
šode
 *inode)

802 ià(!
	`S_ISDIR
(
šode
->
i_mode
è&& !
	`S_ISREG
(inode->i_mode))

805 
	`©omic_dec
(&
	`F2FS_I
(
šode
)->
dœty_·ges
);

807 ià(
	`S_ISDIR
(
šode
->
i_mode
))

808 
	`dec_·ge_couÁ
(
	`F2FS_I_SB
(
šode
), 
F2FS_DIRTY_DENTS
);

809 
	}
}

811 
šlše
 
	$g‘_·ges
(
f2fs_sb_šfo
 *
sbi
, 
couÁ_ty³
)

813  
	`©omic_»ad
(&
sbi
->
Ä_·ges
[
couÁ_ty³
]);

814 
	}
}

816 
šlše
 
	$g‘_dœty_·ges
(
šode
 *inode)

818  
	`©omic_»ad
(&
	`F2FS_I
(
šode
)->
dœty_·ges
);

819 
	}
}

821 
šlše
 
	$g‘_blockty³_£cs
(
f2fs_sb_šfo
 *
sbi
, 
block_ty³
)

823 
·ges_³r_£c
 = 
sbi
->
£gs_³r_£c
 *

824 (1 << 
sbi
->
log_blocks_³r_£g
);

825  ((
	`g‘_·ges
(
sbi
, 
block_ty³
è+ 
·ges_³r_£c
 - 1)

826 >> 
sbi
->
log_blocks_³r_£g
è/ sbi->
£gs_³r_£c
;

827 
	}
}

829 
šlše
 
block_t
 
	$v®id_u£r_blocks
(
f2fs_sb_šfo
 *
sbi
)

831  
sbi
->
tÙ®_v®id_block_couÁ
;

832 
	}
}

834 
šlše
 
	$__b™m­_size
(
f2fs_sb_šfo
 *
sbi
, 
æag
)

836 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

839 ià(
æag
 =ğ
NAT_BITMAP
)

840  
	`Ë32_to_ıu
(
ck±
->
Çt_v”_b™m­_by‹size
);

841 ià(
æag
 =ğ
SIT_BITMAP
)

842  
	`Ë32_to_ıu
(
ck±
->
s™_v”_b™m­_by‹size
);

845 
	}
}

847 
šlše
 *
	$__b™m­_±r
(
f2fs_sb_šfo
 *
sbi
, 
æag
)

849 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

850 
off£t
;

852 ià(
	`Ë32_to_ıu
(
	`F2FS_RAW_SUPER
(
sbi
)->
ı_·ylßd
) > 0) {

853 ià(
æag
 =ğ
NAT_BITMAP
)

854  &
ck±
->
s™_Çt_v”siÚ_b™m­
;

856  (*)
ck±
 + 
F2FS_BLKSIZE
;

858 
off£t
 = (
æag
 =ğ
NAT_BITMAP
) ?

859 
	`Ë32_to_ıu
(
ck±
->
s™_v”_b™m­_by‹size
) : 0;

860  &
ck±
->
s™_Çt_v”siÚ_b™m­
 + 
off£t
;

862 
	}
}

864 
šlše
 
block_t
 
	$__¡¬t_ı_addr
(
f2fs_sb_šfo
 *
sbi
)

866 
block_t
 
¡¬t_addr
;

867 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

868 
ck±_v”siÚ
 = 
	`cur_ı_v”siÚ
(
ck±
);

870 
¡¬t_addr
 = 
	`Ë32_to_ıu
(
	`F2FS_RAW_SUPER
(
sbi
)->
ı_blkaddr
);

876 ià(!(
ck±_v”siÚ
 & 1))

877 
¡¬t_addr
 +ğ
sbi
->
blocks_³r_£g
;

879  
¡¬t_addr
;

880 
	}
}

882 
šlše
 
block_t
 
	$__¡¬t_sum_addr
(
f2fs_sb_šfo
 *
sbi
)

884  
	`Ë32_to_ıu
(
	`F2FS_CKPT
(
sbi
)->
ı_·ck_¡¬t_sum
);

885 
	}
}

887 
šlše
 
boŞ
 
	$šc_v®id_node_couÁ
(
f2fs_sb_šfo
 *
sbi
,

888 
šode
 *inode)

890 
block_t
 
v®id_block_couÁ
;

891 
v®id_node_couÁ
;

893 
	`¥š_lock
(&
sbi
->
¡©_lock
);

895 
v®id_block_couÁ
 = 
sbi
->
tÙ®_v®id_block_couÁ
 + 1;

896 ià(
	`uÆik–y
(
v®id_block_couÁ
 > 
sbi
->
u£r_block_couÁ
)) {

897 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

898  
çl£
;

901 
v®id_node_couÁ
 = 
sbi
->
tÙ®_v®id_node_couÁ
 + 1;

902 ià(
	`uÆik–y
(
v®id_node_couÁ
 > 
sbi
->
tÙ®_node_couÁ
)) {

903 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

904  
çl£
;

907 ià(
šode
)

908 
šode
->
i_blocks
++;

910 
sbi
->
®loc_v®id_block_couÁ
++;

911 
sbi
->
tÙ®_v®id_node_couÁ
++;

912 
sbi
->
tÙ®_v®id_block_couÁ
++;

913 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

915  
Œue
;

916 
	}
}

918 
šlše
 
	$dec_v®id_node_couÁ
(
f2fs_sb_šfo
 *
sbi
,

919 
šode
 *inode)

921 
	`¥š_lock
(&
sbi
->
¡©_lock
);

923 
	`f2fs_bug_Ú
(
sbi
, !sbi->
tÙ®_v®id_block_couÁ
);

924 
	`f2fs_bug_Ú
(
sbi
, !sbi->
tÙ®_v®id_node_couÁ
);

925 
	`f2fs_bug_Ú
(
sbi
, !
šode
->
i_blocks
);

927 
šode
->
i_blocks
--;

928 
sbi
->
tÙ®_v®id_node_couÁ
--;

929 
sbi
->
tÙ®_v®id_block_couÁ
--;

931 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

932 
	}
}

934 
šlše
 
	$v®id_node_couÁ
(
f2fs_sb_šfo
 *
sbi
)

936  
sbi
->
tÙ®_v®id_node_couÁ
;

937 
	}
}

939 
šlše
 
	$šc_v®id_šode_couÁ
(
f2fs_sb_šfo
 *
sbi
)

941 
	`¥š_lock
(&
sbi
->
¡©_lock
);

942 
	`f2fs_bug_Ú
(
sbi
, sbi->
tÙ®_v®id_šode_couÁ
 =ğsbi->
tÙ®_node_couÁ
);

943 
sbi
->
tÙ®_v®id_šode_couÁ
++;

944 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

945 
	}
}

947 
šlše
 
	$dec_v®id_šode_couÁ
(
f2fs_sb_šfo
 *
sbi
)

949 
	`¥š_lock
(&
sbi
->
¡©_lock
);

950 
	`f2fs_bug_Ú
(
sbi
, !sbi->
tÙ®_v®id_šode_couÁ
);

951 
sbi
->
tÙ®_v®id_šode_couÁ
--;

952 
	`¥š_uÆock
(&
sbi
->
¡©_lock
);

953 
	}
}

955 
šlše
 
	$v®id_šode_couÁ
(
f2fs_sb_šfo
 *
sbi
)

957  
sbi
->
tÙ®_v®id_šode_couÁ
;

958 
	}
}

960 
šlše
 
	$f2fs_put_·ge
(
·ge
 *·ge, 
uÆock
)

962 ià(!
·ge
)

965 ià(
uÆock
) {

966 
	`f2fs_bug_Ú
(
	`F2FS_P_SB
(
·ge
), !
	`PageLocked
(page));

967 
	`uÆock_·ge
(
·ge
);

969 
	`·ge_ÿche_»Ëa£
(
·ge
);

970 
	}
}

972 
šlše
 
	$f2fs_put_dnode
(
dnode_of_d©a
 *
dn
)

974 ià(
dn
->
node_·ge
)

975 
	`f2fs_put_·ge
(
dn
->
node_·ge
, 1);

976 ià(
dn
->
šode_·ge
 && dn->
node_·ge
 != dn->inode_page)

977 
	`f2fs_put_·ge
(
dn
->
šode_·ge
, 0);

978 
dn
->
node_·ge
 = 
NULL
;

979 
dn
->
šode_·ge
 = 
NULL
;

980 
	}
}

982 
šlše
 
kmem_ÿche
 *
	$f2fs_kmem_ÿche_ü—‹
(cÚ¡ *
Çme
,

983 
size_t
 
size
)

985  
	`kmem_ÿche_ü—‹
(
Çme
, 
size
, 0, 
SLAB_RECLAIM_ACCOUNT
, 
NULL
);

986 
	}
}

988 
šlše
 *
	$f2fs_kmem_ÿche_®loc
(
kmem_ÿche
 *
ÿch•
,

989 
gå_t
 
æags
)

991 *
’Œy
;

992 
»Œy
:

993 
’Œy
 = 
	`kmem_ÿche_®loc
(
ÿch•
, 
æags
);

994 ià(!
’Œy
) {

995 
	`cÚd_»sched
();

996 
»Œy
;

999  
’Œy
;

1000 
	}
}

1002 
	#RAW_IS_INODE
(
p
è(Õ)->
foÙ”
.
nid
 =ğÕ)->foÙ”.
šo
)

	)

1004 
šlše
 
boŞ
 
	$IS_INODE
(
·ge
 *page)

1006 
f2fs_node
 *
p
 = 
	`F2FS_NODE
(
·ge
);

1007  
	`RAW_IS_INODE
(
p
);

1008 
	}
}

1010 
šlše
 
__Ë32
 *
	$blkaddr_š_node
(
f2fs_node
 *
node
)

1012  
	`RAW_IS_INODE
(
node
è?‚ode->
i
.
i_addr
 :‚ode->
dn
.
addr
;

1013 
	}
}

1015 
šlše
 
block_t
 
	$d©ablock_addr
(
·ge
 *
node_·ge
,

1016 
off£t
)

1018 
f2fs_node
 *
¿w_node
;

1019 
__Ë32
 *
addr_¬¿y
;

1020 
¿w_node
 = 
	`F2FS_NODE
(
node_·ge
);

1021 
addr_¬¿y
 = 
	`blkaddr_š_node
(
¿w_node
);

1022  
	`Ë32_to_ıu
(
addr_¬¿y
[
off£t
]);

1023 
	}
}

1025 
šlše
 
	$f2fs_‹¡_b™
(
Ä
, *
addr
)

1027 
mask
;

1029 
addr
 +ğ(
Ä
 >> 3);

1030 
mask
 = 1 << (7 - (
Ä
 & 0x07));

1031  
mask
 & *
addr
;

1032 
	}
}

1034 
šlše
 
	$f2fs_£t_b™
(
Ä
, *
addr
)

1036 
mask
;

1037 
»t
;

1039 
addr
 +ğ(
Ä
 >> 3);

1040 
mask
 = 1 << (7 - (
Ä
 & 0x07));

1041 
»t
 = 
mask
 & *
addr
;

1042 *
addr
 |ğ
mask
;

1043  
»t
;

1044 
	}
}

1046 
šlše
 
	$f2fs_ş—r_b™
(
Ä
, *
addr
)

1048 
mask
;

1049 
»t
;

1051 
addr
 +ğ(
Ä
 >> 3);

1052 
mask
 = 1 << (7 - (
Ä
 & 0x07));

1053 
»t
 = 
mask
 & *
addr
;

1054 *
addr
 &ğ~
mask
;

1055  
»t
;

1056 
	}
}

1060 
	mFI_NEW_INODE
,

1061 
	mFI_DIRTY_INODE
,

1062 
	mFI_DIRTY_DIR
,

1063 
	mFI_INC_LINK
,

1064 
	mFI_ACL_MODE
,

1065 
	mFI_NO_ALLOC
,

1066 
	mFI_UPDATE_DIR
,

1067 
	mFI_DELAY_IPUT
,

1068 
	mFI_NO_EXTENT
,

1069 
	mFI_INLINE_XATTR
,

1070 
	mFI_INLINE_DATA
,

1071 
	mFI_APPEND_WRITE
,

1072 
	mFI_UPDATE_WRITE
,

1073 
	mFI_NEED_IPU
,

1074 
	mFI_ATOMIC_FILE
,

1075 
	mFI_VOLATILE_FILE
,

1078 
šlše
 
	$£t_šode_æag
(
f2fs_šode_šfo
 *
fi
, 
æag
)

1080 ià(!
	`‹¡_b™
(
æag
, &
fi
->
æags
))

1081 
	`£t_b™
(
æag
, &
fi
->
æags
);

1082 
	}
}

1084 
šlše
 
	$is_šode_æag_£t
(
f2fs_šode_šfo
 *
fi
, 
æag
)

1086  
	`‹¡_b™
(
æag
, &
fi
->
æags
);

1087 
	}
}

1089 
šlše
 
	$ş—r_šode_æag
(
f2fs_šode_šfo
 *
fi
, 
æag
)

1091 ià(
	`‹¡_b™
(
æag
, &
fi
->
æags
))

1092 
	`ş—r_b™
(
æag
, &
fi
->
æags
);

1093 
	}
}

1095 
šlše
 
	$£t_aş_šode
(
f2fs_šode_šfo
 *
fi
, 
umode_t
 
mode
)

1097 
fi
->
i_aş_mode
 = 
mode
;

1098 
	`£t_šode_æag
(
fi
, 
FI_ACL_MODE
);

1099 
	}
}

1101 
šlše
 
	$cÚd_ş—r_šode_æag
(
f2fs_šode_šfo
 *
fi
, 
æag
)

1103 ià(
	`is_šode_æag_£t
(
fi
, 
FI_ACL_MODE
)) {

1104 
	`ş—r_šode_æag
(
fi
, 
FI_ACL_MODE
);

1108 
	}
}

1110 
šlše
 
	$g‘_šlše_šfo
(
f2fs_šode_šfo
 *
fi
,

1111 
f2fs_šode
 *
ri
)

1113 ià(
ri
->
i_šlše
 & 
F2FS_INLINE_XATTR
)

1114 
	`£t_šode_æag
(
fi
, 
FI_INLINE_XATTR
);

1115 ià(
ri
->
i_šlše
 & 
F2FS_INLINE_DATA
)

1116 
	`£t_šode_æag
(
fi
, 
FI_INLINE_DATA
);

1117 
	}
}

1119 
šlše
 
	$£t_¿w_šlše
(
f2fs_šode_šfo
 *
fi
,

1120 
f2fs_šode
 *
ri
)

1122 
ri
->
i_šlše
 = 0;

1124 ià(
	`is_šode_æag_£t
(
fi
, 
FI_INLINE_XATTR
))

1125 
ri
->
i_šlše
 |ğ
F2FS_INLINE_XATTR
;

1126 ià(
	`is_šode_æag_£t
(
fi
, 
FI_INLINE_DATA
))

1127 
ri
->
i_šlše
 |ğ
F2FS_INLINE_DATA
;

1128 
	}
}

1130 
šlše
 
	$f2fs_has_šlše_x©Œ
(
šode
 *inode)

1132  
	`is_šode_æag_£t
(
	`F2FS_I
(
šode
), 
FI_INLINE_XATTR
);

1133 
	}
}

1135 
šlše
 
	$addrs_³r_šode
(
f2fs_šode_šfo
 *
fi
)

1137 ià(
	`f2fs_has_šlše_x©Œ
(&
fi
->
vfs_šode
))

1138  
DEF_ADDRS_PER_INODE
 - 
F2FS_INLINE_XATTR_ADDRS
;

1139  
DEF_ADDRS_PER_INODE
;

1140 
	}
}

1142 
šlše
 *
	$šlše_x©Œ_addr
(
·ge
 *page)

1144 
f2fs_šode
 *
ri
 = 
	`F2FS_INODE
(
·ge
);

1145  (*)&(
ri
->
i_addr
[
DEF_ADDRS_PER_INODE
 -

1146 
F2FS_INLINE_XATTR_ADDRS
]);

1147 
	}
}

1149 
šlše
 
	$šlše_x©Œ_size
(
šode
 *inode)

1151 ià(
	`f2fs_has_šlše_x©Œ
(
šode
))

1152  
F2FS_INLINE_XATTR_ADDRS
 << 2;

1155 
	}
}

1157 
šlše
 
	$f2fs_has_šlše_d©a
(
šode
 *inode)

1159  
	`is_šode_æag_£t
(
	`F2FS_I
(
šode
), 
FI_INLINE_DATA
);

1160 
	}
}

1162 
šlše
 
boŞ
 
	$f2fs_is_©omic_fe
(
šode
 *inode)

1164  
	`is_šode_æag_£t
(
	`F2FS_I
(
šode
), 
FI_ATOMIC_FILE
);

1165 
	}
}

1167 
šlše
 
boŞ
 
	$f2fs_is_vŞ©e_fe
(
šode
 *inode)

1169  
	`is_šode_æag_£t
(
	`F2FS_I
(
šode
), 
FI_VOLATILE_FILE
);

1170 
	}
}

1172 
šlše
 *
	$šlše_d©a_addr
(
·ge
 *page)

1174 
f2fs_šode
 *
ri
 = 
	`F2FS_INODE
(
·ge
);

1175  (*)&(
ri
->
i_addr
[1]);

1176 
	}
}

1178 
šlše
 
	$f2fs_»adÚly
(
su³r_block
 *
sb
)

1180  
sb
->
s_æags
 & 
MS_RDONLY
;

1181 
	}
}

1183 
šlše
 
boŞ
 
	$f2fs_ı_”rÜ
(
f2fs_sb_šfo
 *
sbi
)

1185  
	`is_£t_ck±_æags
(
sbi
->
ck±
, 
CP_ERROR_FLAG
);

1186 
	}
}

1188 
šlše
 
	$f2fs_¡İ_checkpošt
(
f2fs_sb_šfo
 *
sbi
)

1190 
	`£t_ck±_æags
(
sbi
->
ck±
, 
CP_ERROR_FLAG
);

1191 
sbi
->
sb
->
s_æags
 |ğ
MS_RDONLY
;

1192 
	}
}

1194 
	#g‘_šode_mode
(
i
) \

1195 ((
	`is_šode_æag_£t
(
	`F2FS_I
(
i
), 
FI_ACL_MODE
)) ? \

1196 (
	`F2FS_I
(
i
)->
i_aş_mode
è: ((i)->
i_mode
))

	)

1199 
	#PGOFS_OF_NEXT_DNODE
(
pgofs
, 
fi
) \

1200 ((
pgofs
 < 
	`ADDRS_PER_INODE
(
fi
)) ? ADDRS_PER_INODE(fi) : \

1201 (
pgofs
 - 
	`ADDRS_PER_INODE
(
fi
è+ 
ADDRS_PER_BLOCK
) / \

1202 
ADDRS_PER_BLOCK
 * ADDRS_PER_BLOCK + 
	`ADDRS_PER_INODE
(
fi
))

	)

1207 
f2fs_sync_fe
(
fe
 *, 
loff_t
,†off_t, );

1208 
Œunÿ‹_d©a_blocks
(
dnode_of_d©a
 *);

1209 
Œunÿ‹_blocks
(
šode
 *, 
u64
, 
boŞ
);

1210 
f2fs_Œunÿ‹
(
šode
 *);

1211 
f2fs_g‘©Œ
(
vfsmouÁ
 *, 
d’Œy
 *, 
k¡©
 *);

1212 
f2fs_£‰r
(
d’Œy
 *, 
Ÿ‰r
 *);

1213 
Œunÿ‹_hŞe
(
šode
 *, 
pgoff_t
,…goff_t);

1214 
Œunÿ‹_d©a_blocks_¿nge
(
dnode_of_d©a
 *, );

1215 
f2fs_ioùl
(
fe
 *, , );

1216 
f2fs_com·t_ioùl
(
fe
 *, , );

1221 
f2fs_£t_šode_æags
(
šode
 *);

1222 
šode
 *
f2fs_ig‘
(
su³r_block
 *, );

1223 
Œy_to_ä“_Çts
(
f2fs_sb_šfo
 *, );

1224 
upd©e_šode
(
šode
 *, 
·ge
 *);

1225 
upd©e_šode_·ge
(
šode
 *);

1226 
f2fs_wr™e_šode
(
šode
 *, 
wr™eback_cÚŒŞ
 *);

1227 
f2fs_eviù_šode
(
šode
 *);

1228 
hªdË_çed_šode
(
šode
 *);

1233 
d’Œy
 *
f2fs_g‘_·»Á
(d’Œy *
chd
);

1238 
f2fs_dœ_’Œy
 *
f2fs_fšd_’Œy
(
šode
 *, 
q¡r
 *,

1239 
·ge
 **);

1240 
f2fs_dœ_’Œy
 *
f2fs_·»Á_dœ
(
šode
 *, 
·ge
 **);

1241 
šo_t
 
f2fs_šode_by_Çme
(
šode
 *, 
q¡r
 *);

1242 
f2fs_£t_lšk
(
šode
 *, 
f2fs_dœ_’Œy
 *,

1243 
·ge
 *, 
šode
 *);

1244 
upd©e_d’t_šode
(
šode
 *, cÚ¡ 
q¡r
 *);

1245 
__f2fs_add_lšk
(
šode
 *, cÚ¡ 
q¡r
 *, inode *);

1246 
f2fs_d–‘e_’Œy
(
f2fs_dœ_’Œy
 *, 
·ge
 *, 
šode
 *);

1247 
f2fs_do_tmpfe
(
šode
 *, inode *);

1248 
f2fs_make_em±y
(
šode
 *, inode *);

1249 
boŞ
 
f2fs_em±y_dœ
(
šode
 *);

1251 
šlše
 
	$f2fs_add_lšk
(
d’Œy
 *d’Œy, 
šode
 *inode)

1253  
	`__f2fs_add_lšk
(
d’Œy
->
d_·»Á
->
d_šode
, &d’Œy->
d_Çme
,

1254 
šode
);

1255 
	}
}

1260 
f2fs_sync_fs
(
su³r_block
 *, );

1261 
	$__´štf
(3, 4)

1262 
	`f2fs_msg
(
su³r_block
 *, const *, const *, ...);

1267 
f2fs_hash_t
 
	`f2fs_d’Œy_hash
(cÚ¡ 
q¡r
 *);

1272 
dnode_of_d©a
;

1273 
node_šfo
;

1275 
boŞ
 
	`avaabË_ä“_memÜy
(
f2fs_sb_šfo
 *, );

1276 
boŞ
 
	`is_checkpoš‹d_node
(
f2fs_sb_šfo
 *, 
nid_t
);

1277 
boŞ
 
	`has_fsynûd_šode
(
f2fs_sb_šfo
 *, 
nid_t
);

1278 
boŞ
 
	`Ãed_šode_block_upd©e
(
f2fs_sb_šfo
 *, 
nid_t
);

1279 
	`g‘_node_šfo
(
f2fs_sb_šfo
 *, 
nid_t
, 
node_šfo
 *);

1280 
	`g‘_dnode_of_d©a
(
dnode_of_d©a
 *, 
pgoff_t
, );

1281 
	`Œunÿ‹_šode_blocks
(
šode
 *, 
pgoff_t
);

1282 
	`Œunÿ‹_x©Œ_node
(
šode
 *, 
·ge
 *);

1283 
	`wa™_Ú_node_·ges_wr™eback
(
f2fs_sb_šfo
 *, 
nid_t
);

1284 
	`»move_šode_·ge
(
šode
 *);

1285 
·ge
 *
	`Ãw_šode_·ge
(
šode
 *);

1286 
·ge
 *
	`Ãw_node_·ge
(
dnode_of_d©a
 *, , page *);

1287 
	`¿_node_·ge
(
f2fs_sb_šfo
 *, 
nid_t
);

1288 
·ge
 *
	`g‘_node_·ge
(
f2fs_sb_šfo
 *, 
pgoff_t
);

1289 
·ge
 *
	`g‘_node_·ge_¿
(page *, );

1290 
	`sync_šode_·ge
(
dnode_of_d©a
 *);

1291 
	`sync_node_·ges
(
f2fs_sb_šfo
 *, 
nid_t
, 
wr™eback_cÚŒŞ
 *);

1292 
boŞ
 
	`®loc_nid
(
f2fs_sb_šfo
 *, 
nid_t
 *);

1293 
	`®loc_nid_dÚe
(
f2fs_sb_šfo
 *, 
nid_t
);

1294 
	`®loc_nid_çed
(
f2fs_sb_šfo
 *, 
nid_t
);

1295 
	`»cov”_šlše_x©Œ
(
šode
 *, 
·ge
 *);

1296 
	`»cov”_x©Œ_d©a
(
šode
 *, 
·ge
 *, 
block_t
);

1297 
	`»cov”_šode_·ge
(
f2fs_sb_šfo
 *, 
·ge
 *);

1298 
	`»¡Üe_node_summ¬y
(
f2fs_sb_šfo
 *, ,

1299 
f2fs_summ¬y_block
 *);

1300 
	`æush_Çt_’Œ›s
(
f2fs_sb_šfo
 *);

1301 
	`bud_node_mªag”
(
f2fs_sb_šfo
 *);

1302 
	`de¡roy_node_mªag”
(
f2fs_sb_šfo
 *);

1303 
__š™
 
	`ü—‹_node_mªag”_ÿches
();

1304 
	`de¡roy_node_mªag”_ÿches
();

1309 
	`»gi¡”_šmem_·ge
(
šode
 *, 
·ge
 *);

1310 
	`comm™_šmem_·ges
(
šode
 *, 
boŞ
);

1311 
	`f2fs_b®ªû_fs
(
f2fs_sb_šfo
 *);

1312 
	`f2fs_b®ªû_fs_bg
(
f2fs_sb_šfo
 *);

1313 
	`f2fs_issue_æush
(
f2fs_sb_šfo
 *);

1314 
	`ü—‹_æush_cmd_cÚŒŞ
(
f2fs_sb_šfo
 *);

1315 
	`de¡roy_æush_cmd_cÚŒŞ
(
f2fs_sb_šfo
 *);

1316 
	`šv®id©e_blocks
(
f2fs_sb_šfo
 *, 
block_t
);

1317 
	`»äesh_s™_’Œy
(
f2fs_sb_šfo
 *, 
block_t
, block_t);

1318 
	`ş—r_´eä“_£gm’ts
(
f2fs_sb_šfo
 *);

1319 
	`»Ëa£_disÿrd_addrs
(
f2fs_sb_šfo
 *);

1320 
	`disÿrd_Ãxt_dnode
(
f2fs_sb_šfo
 *, 
block_t
);

1321 
	`Åages_fÜ_summ¬y_æush
(
f2fs_sb_šfo
 *);

1322 
	`®loÿ‹_Ãw_£gm’ts
(
f2fs_sb_šfo
 *);

1323 
	`f2fs_Œim_fs
(
f2fs_sb_šfo
 *, 
f¡rim_¿nge
 *);

1324 
·ge
 *
	`g‘_sum_·ge
(
f2fs_sb_šfo
 *, );

1325 
	`wr™e_m‘a_·ge
(
f2fs_sb_šfo
 *, 
·ge
 *);

1326 
	`wr™e_node_·ge
(
f2fs_sb_šfo
 *, 
·ge
 *,

1327 
f2fs_io_šfo
 *, , 
block_t
, block_t *);

1328 
	`wr™e_d©a_·ge
(
·ge
 *, 
dnode_of_d©a
 *, 
block_t
 *,

1329 
f2fs_io_šfo
 *);

1330 
	`»wr™e_d©a_·ge
(
·ge
 *, 
block_t
, 
f2fs_io_šfo
 *);

1331 
	`»cov”_d©a_·ge
(
f2fs_sb_šfo
 *, 
·ge
 *,

1332 
f2fs_summ¬y
 *, 
block_t
, block_t);

1334 
	`g‘_Ãxt_d©a_block
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 *
Ãw_blkaddr
, 
ty³
);

1336 
	`®loÿ‹_d©a_block
(
f2fs_sb_šfo
 *, 
·ge
 *,

1337 
block_t
, block_ˆ*, 
f2fs_summ¬y
 *, );

1339 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
 *, 
·ge_ty³
);

1340 
	`wr™e_d©a_summ¬›s
(
f2fs_sb_šfo
 *, 
block_t
);

1341 
	`wr™e_node_summ¬›s
(
f2fs_sb_šfo
 *, 
block_t
);

1342 
	`lookup_jouº®_š_cursum
(
f2fs_summ¬y_block
 *,

1344 
	`æush_s™_’Œ›s
(
f2fs_sb_šfo
 *, 
ı_cÚŒŞ
 *);

1345 
	`bud_£gm’t_mªag”
(
f2fs_sb_šfo
 *);

1346 
	`de¡roy_£gm’t_mªag”
(
f2fs_sb_šfo
 *);

1347 
__š™
 
	`ü—‹_£gm’t_mªag”_ÿches
();

1348 
	`de¡roy_£gm’t_mªag”_ÿches
();

1353 
·ge
 *
	`g¿b_m‘a_·ge
(
f2fs_sb_šfo
 *, 
pgoff_t
);

1354 
·ge
 *
	`g‘_m‘a_·ge
(
f2fs_sb_šfo
 *, 
pgoff_t
);

1355 
·ge
 *
	`g‘_m‘a_·ge_¿
(
f2fs_sb_šfo
 *, 
pgoff_t
);

1356 
	`¿_m‘a_·ges
(
f2fs_sb_šfo
 *, 
block_t
, , );

1357 
	`sync_m‘a_·ges
(
f2fs_sb_šfo
 *, 
·ge_ty³
, );

1358 
	`add_dœty_šode
(
f2fs_sb_šfo
 *, 
nid_t
, 
ty³
);

1359 
	`»move_dœty_šode
(
f2fs_sb_šfo
 *, 
nid_t
, 
ty³
);

1360 
	`»Ëa£_dœty_šode
(
f2fs_sb_šfo
 *);

1361 
boŞ
 
	`exi¡_wr™‹n_d©a
(
f2fs_sb_šfo
 *, 
nid_t
, );

1362 
	`acquœe_Üphª_šode
(
f2fs_sb_šfo
 *);

1363 
	`»Ëa£_Üphª_šode
(
f2fs_sb_šfo
 *);

1364 
	`add_Üphª_šode
(
f2fs_sb_šfo
 *, 
nid_t
);

1365 
	`»move_Üphª_šode
(
f2fs_sb_šfo
 *, 
nid_t
);

1366 
	`»cov”_Üphª_šodes
(
f2fs_sb_šfo
 *);

1367 
	`g‘_v®id_checkpošt
(
f2fs_sb_šfo
 *);

1368 
	`upd©e_dœty_·ge
(
šode
 *, 
·ge
 *);

1369 
	`add_dœty_dœ_šode
(
šode
 *);

1370 
	`»move_dœty_dœ_šode
(
šode
 *);

1371 
	`sync_dœty_dœ_šodes
(
f2fs_sb_šfo
 *);

1372 
	`wr™e_checkpošt
(
f2fs_sb_šfo
 *, 
ı_cÚŒŞ
 *);

1373 
	`š™_šo_’Œy_šfo
(
f2fs_sb_šfo
 *);

1374 
__š™
 
	`ü—‹_checkpošt_ÿches
();

1375 
	`de¡roy_checkpošt_ÿches
();

1380 
	`f2fs_subm™_m”ged_bio
(
f2fs_sb_šfo
 *, 
·ge_ty³
, );

1381 
	`f2fs_subm™_·ge_bio
(
f2fs_sb_šfo
 *, 
·ge
 *, 
block_t
, );

1383 #ifdeà
F2FS_DA_MAP


1384 
	`f2fs_subm™_·ge_mbio
(
f2fs_sb_šfo
 *, 
·ge
 *, 
block_t
,

1385 
f2fs_io_šfo
 *, 
f2fs_da_io_šfo
 *);

1387 
	`f2fs_subm™_·ge_mbio
(
f2fs_sb_šfo
 *, 
·ge
 *, 
block_t
,

1388 
f2fs_io_šfo
 *);

1390 
	`»£rve_Ãw_block
(
dnode_of_d©a
 *);

1391 
	`f2fs_»£rve_block
(
dnode_of_d©a
 *, 
pgoff_t
);

1392 
	`upd©e_ex‹Á_ÿche
(
block_t
, 
dnode_of_d©a
 *);

1393 
·ge
 *
	`fšd_d©a_·ge
(
šode
 *, 
pgoff_t
, 
boŞ
);

1394 
·ge
 *
	`g‘_lock_d©a_·ge
(
šode
 *, 
pgoff_t
);

1395 
·ge
 *
	`g‘_Ãw_d©a_·ge
(
šode
 *, ·g*, 
pgoff_t
, 
boŞ
);

1396 
	`do_wr™e_d©a_·ge
(
·ge
 *, 
f2fs_io_šfo
 *);

1397 
	`f2fs_f›m­
(
šode
 *šode, 
f›m­_ex‹Á_šfo
 *, 
u64
, u64);

1402 
	`¡¬t_gc_th»ad
(
f2fs_sb_šfo
 *);

1403 
	`¡İ_gc_th»ad
(
f2fs_sb_šfo
 *);

1404 
block_t
 
	`¡¬t_bidx_of_node
(, 
f2fs_šode_šfo
 *);

1405 
	`f2fs_gc
(
f2fs_sb_šfo
 *);

1406 
	`bud_gc_mªag”
(
f2fs_sb_šfo
 *);

1407 
__š™
 
	`ü—‹_gc_ÿches
();

1408 
	`de¡roy_gc_ÿches
();

1413 
	`»cov”_fsync_d©a
(
f2fs_sb_šfo
 *);

1414 
boŞ
 
	`¥aû_fÜ_rŞl_fÜw¬d
(
f2fs_sb_šfo
 *);

1419 #ifdeà
CONFIG_F2FS_STAT_FS


1420 
	sf2fs_¡©_šfo
 {

1421 
li¡_h—d
 
¡©_li¡
;

1422 
f2fs_sb_šfo
 *
sbi
;

1423 
®l_¬—_£gs
, 
s™_¬—_£gs
, 
Çt_¬—_£gs
, 
s§_¬—_£gs
;

1424 
maš_¬—_£gs
, 
maš_¬—_£ùiÚs
, 
maš_¬—_zÚes
;

1425 
h™_ext
, 
tÙ®_ext
;

1426 
ndœty_node
, 
ndœty_d’t
, 
ndœty_dœs
, 
ndœty_m‘a
;

1427 
Çts
, 
s™s
, 
âids
;

1428 
tÙ®_couÁ
, 
utiz©iÚ
;

1429 
bg_gc
, 
šlše_šode
;

1430 
v®id_couÁ
, 
v®id_node_couÁ
, 
v®id_šode_couÁ
;

1431 
bimod®
, 
avg_vblocks
;

1432 
ut_ä“
, 
ut_v®id
, 
ut_šv®id
;

1433 
rsvd_£gs
, 
ov”p_£gs
;

1434 
dœty_couÁ
, 
node_·ges
, 
m‘a_·ges
;

1435 
´eä“_couÁ
, 
ÿÎ_couÁ
, 
ı_couÁ
;

1436 
tÙ_£gs
, 
node_£gs
, 
d©a_£gs
, 
ä“_£gs
, 
ä“_£cs
;

1437 
tÙ_blks
, 
d©a_blks
, 
node_blks
;

1438 
cur£g
[
NR_CURSEG_TYPE
];

1439 
cur£c
[
NR_CURSEG_TYPE
];

1440 
curzÚe
[
NR_CURSEG_TYPE
];

1442 
£gm’t_couÁ
[2];

1443 
block_couÁ
[2];

1444 
ba£_mem
, 
ÿche_mem
;

1447 
šlše
 
f2fs_¡©_šfo
 *
	$F2FS_STAT
(
f2fs_sb_šfo
 *
sbi
)

1449  (
f2fs_¡©_šfo
 *)
sbi
->
¡©_šfo
;

1450 
	}
}

1452 
	#¡©_šc_ı_couÁ
(
si
è((si)->
ı_couÁ
++)

	)

1453 
	#¡©_šc_ÿÎ_couÁ
(
si
è((si)->
ÿÎ_couÁ
++)

	)

1454 
	#¡©_šc_bggc_couÁ
(
sbi
è((sbi)->
bg_gc
++)

	)

1455 
	#¡©_šc_dœty_dœ
(
sbi
è((sbi)->
n_dœty_dœs
++)

	)

1456 
	#¡©_dec_dœty_dœ
(
sbi
è((sbi)->
n_dœty_dœs
--)

	)

1457 
	#¡©_šc_tÙ®_h™
(
sb
è((
	`F2FS_SB
(sb))->
tÙ®_h™_ext
++)

	)

1458 
	#¡©_šc_»ad_h™
(
sb
è((
	`F2FS_SB
(sb))->
»ad_h™_ext
++)

	)

1459 
	#¡©_šc_šlše_šode
(
šode
) \

1461 ià(
	`f2fs_has_šlše_d©a
(
šode
)) \

1462 ((
	`F2FS_I_SB
(
šode
))->
šlše_šode
++); \

1463 } 0)

	)

1464 
	#¡©_dec_šlše_šode
(
šode
) \

1466 ià(
	`f2fs_has_šlše_d©a
(
šode
)) \

1467 ((
	`F2FS_I_SB
(
šode
))->
šlše_šode
--); \

1468 } 0)

	)

1470 
	#¡©_šc_£g_ty³
(
sbi
, 
cur£g
) \

1471 ((
sbi
)->
£gm’t_couÁ
[(
cur£g
)->
®loc_ty³
]++)

	)

1472 
	#¡©_šc_block_couÁ
(
sbi
, 
cur£g
) \

1473 ((
sbi
)->
block_couÁ
[(
cur£g
)->
®loc_ty³
]++)

	)

1475 
	#¡©_šc_£g_couÁ
(
sbi
, 
ty³
) \

1477 
f2fs_¡©_šfo
 *
si
 = 
	`F2FS_STAT
(
sbi
); \

1478 (
si
)->
tÙ_£gs
++; \

1479 ià(
ty³
 =ğ
SUM_TYPE_DATA
) \

1480 
si
->
d©a_£gs
++; \

1482 
si
->
node_£gs
++; \

1483 } 0)

	)

1485 
	#¡©_šc_tÙ_blk_couÁ
(
si
, 
blks
) \

1486 (
si
->
tÙ_blks
 +ğ(
blks
))

	)

1488 
	#¡©_šc_d©a_blk_couÁ
(
sbi
, 
blks
) \

1490 
f2fs_¡©_šfo
 *
si
 = 
	`F2FS_STAT
(
sbi
); \

1491 
	`¡©_šc_tÙ_blk_couÁ
(
si
, 
blks
); \

1492 
si
->
d©a_blks
 +ğ(
blks
); \

1493 } 0)

	)

1495 
	#¡©_šc_node_blk_couÁ
(
sbi
, 
blks
) \

1497 
f2fs_¡©_šfo
 *
si
 = 
	`F2FS_STAT
(
sbi
); \

1498 
	`¡©_šc_tÙ_blk_couÁ
(
si
, 
blks
); \

1499 
si
->
node_blks
 +ğ(
blks
); \

1500 } 0)

	)

1502 
f2fs_bud_¡©s
(
f2fs_sb_šfo
 *);

1503 
f2fs_de¡roy_¡©s
(
f2fs_sb_šfo
 *);

1504 
__š™
 
f2fs_ü—‹_roÙ_¡©s
();

1505 
f2fs_de¡roy_roÙ_¡©s
();

1507 
	#¡©_šc_ı_couÁ
(
si
)

	)

1508 
	#¡©_šc_ÿÎ_couÁ
(
si
)

	)

1509 
	#¡©_šc_bggc_couÁ
(
si
)

	)

1510 
	#¡©_šc_dœty_dœ
(
sbi
)

	)

1511 
	#¡©_dec_dœty_dœ
(
sbi
)

	)

1512 
	#¡©_šc_tÙ®_h™
(
sb
)

	)

1513 
	#¡©_šc_»ad_h™
(
sb
)

	)

1514 
	#¡©_šc_šlše_šode
(
šode
)

	)

1515 
	#¡©_dec_šlše_šode
(
šode
)

	)

1516 
	#¡©_šc_£g_ty³
(
sbi
, 
cur£g
)

	)

1517 
	#¡©_šc_block_couÁ
(
sbi
, 
cur£g
)

	)

1518 
	#¡©_šc_£g_couÁ
(
si
, 
ty³
)

	)

1519 
	#¡©_šc_tÙ_blk_couÁ
(
si
, 
blks
)

	)

1520 
	#¡©_šc_d©a_blk_couÁ
(
si
, 
blks
)

	)

1521 
	#¡©_šc_node_blk_couÁ
(
sbi
, 
blks
)

	)

1523 
šlše
 
	$f2fs_bud_¡©s
(
f2fs_sb_šfo
 *
sbi
è{  0; 
	}
}

1524 
šlše
 
	$f2fs_de¡roy_¡©s
(
f2fs_sb_šfo
 *
sbi
è{ 
	}
}

1525 
šlše
 
__š™
 
	$f2fs_ü—‹_roÙ_¡©s
(è{ 
	}
}

1526 
šlše
 
	$f2fs_de¡roy_roÙ_¡©s
(è{ 
	}
}

1529 cÚ¡ 
fe_İ”©iÚs
 
f2fs_dœ_İ”©iÚs
;

1530 cÚ¡ 
fe_İ”©iÚs
 
f2fs_fe_İ”©iÚs
;

1531 cÚ¡ 
šode_İ”©iÚs
 
f2fs_fe_šode_İ”©iÚs
;

1532 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
f2fs_dblock_aİs
;

1533 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
f2fs_node_aİs
;

1534 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
f2fs_m‘a_aİs
;

1535 cÚ¡ 
šode_İ”©iÚs
 
f2fs_dœ_šode_İ”©iÚs
;

1536 cÚ¡ 
šode_İ”©iÚs
 
f2fs_symlšk_šode_İ”©iÚs
;

1537 cÚ¡ 
šode_İ”©iÚs
 
f2fs_¥ecŸl_šode_İ”©iÚs
;

1542 
boŞ
 
f2fs_may_šlše
(
šode
 *);

1543 
f2fs_»ad_šlše_d©a
(
šode
 *, 
·ge
 *);

1544 
f2fs_cÚv”t_šlše_d©a
(
šode
 *, 
pgoff_t
, 
·ge
 *);

1545 
f2fs_wr™e_šlše_d©a
(
šode
 *, 
·ge
 *, );

1546 
Œunÿ‹_šlše_d©a
(
šode
 *, 
u64
);

1547 
boŞ
 
»cov”_šlše_d©a
(
šode
 *, 
·ge
 *);

	@f2fs.mod.c

1 
	~<lšux/moduË.h
>

2 
	~<lšux/v”magic.h
>

3 
	~<lšux/comp”.h
>

5 
MODULE_INFO
(
v”magic
, 
VERMAGIC_STRING
);

7 
__visibË
 
moduË
 
__this_moduË


8 
__©Œibu‹__
((
£ùiÚ
(".gnu.linkonce.this_module"))) = {

9 .
Çme
 = 
KBUILD_MODNAME
,

10 .
	gš™
 = 
š™_moduË
,

11 #ifdeà
CONFIG_MODULE_UNLOAD


12 .
	gex™
 = 
ş—nup_moduË
,

14 .
	g¬ch
 = 
MODULE_ARCH_INIT
,

17 
MODULE_INFO
(
šŒ“
, "Y");

19 cÚ¡ 
modv”siÚ_šfo
 
	g____v”siÚs
[]

20 
__u£d


21 
__©Œibu‹__
((
£ùiÚ
("__versions"))) = {

22 { 0x531bf32a, 
__VMLINUX_SYMBOL_STR
(
moduË_Ïyout
) },

23 { 0x964b601a, 
__VMLINUX_SYMBOL_STR
(
kobjeù_put
) },

24 { 0x413c01e4, 
__VMLINUX_SYMBOL_STR
(
blkdev_issue_disÿrd
) },

25 { 0xd5d786e, 
__VMLINUX_SYMBOL_STR
(
k£t_ü—‹_ªd_add
) },

26 { 0xd856350d, 
__VMLINUX_SYMBOL_STR
(
®loc_·ges_cu¼’t
) },

27 { 0xa9df11dd, 
__VMLINUX_SYMBOL_STR
(
kmem_ÿche_de¡roy
) },

28 { 0x8dfd488a, 
__VMLINUX_SYMBOL_STR
(
fs_bio_£t
) },

29 { 0xd99a8d9d, 
__VMLINUX_SYMBOL_STR
(
ig‘_çed
) },

30 { 0x2ffÿ66, 
__VMLINUX_SYMBOL_STR
(
km®loc_ÿches
) },

31 { 0xd2b09û5, 
__VMLINUX_SYMBOL_STR
(
__km®loc
) },

32 { 0xbedf11d1, 
__VMLINUX_SYMBOL_STR
(
Ãw_sync_wr™e
) },

33 { 0x8e83—20, 
__VMLINUX_SYMBOL_STR
(
³rf__ev’t
) },

34 { 0x405c1144, 
__VMLINUX_SYMBOL_STR
(
g‘_£cÚds
) },

35 { 0x3138c945, 
__VMLINUX_SYMBOL_STR
(
drİ_Æšk
) },

36 { 0xe10b6827, 
__VMLINUX_SYMBOL_STR
(
subm™_bio_wa™
) },

37 { 0xc94351df, 
__VMLINUX_SYMBOL_STR
(
g’”ic_g‘x©Œ
) },

38 { 0x579—b«, 
__VMLINUX_SYMBOL_STR
(
up_»ad
) },

39 { 0x4cb99946, 
__VMLINUX_SYMBOL_STR
(
bio_®loc_bio£t
) },

40 { 0xf3a1f5af, 
__VMLINUX_SYMBOL_STR
(
make_bad_šode
) },

41 { 0x714c039, 
__VMLINUX_SYMBOL_STR
(
g’”ic_fe_Î£ek
) },

42 { 0xda3e43d1, 
__VMLINUX_SYMBOL_STR
(
_¿w_¥š_uÆock
) },

43 { 0x54a1ec5a, 
__VMLINUX_SYMBOL_STR
(
__m¬k_šode_dœty
) },

44 { 0x3ab3de9, 
__VMLINUX_SYMBOL_STR
(
debugfs_ü—‹_dœ
) },

45 { 0x270f0310, 
__VMLINUX_SYMBOL_STR
(
__£t_·ge_dœty_nobufãrs
) },

46 { 0x4fd—cb9, 
__VMLINUX_SYMBOL_STR
(
fem­_çuÉ
) },

47 { 0xc1b398a, 
__VMLINUX_SYMBOL_STR
(
sšgË_İ’
) },

48 { 0x188a3dfb, 
__VMLINUX_SYMBOL_STR
(
time¥ec_Œunc
) },

49 { 0x754d539c, 
__VMLINUX_SYMBOL_STR
(
¡¾’
) },

50 { 0x7091d6e2, 
__VMLINUX_SYMBOL_STR
(
g’”ic_fe_Î£ek_size
) },

51 { 0x60a13e90, 
__VMLINUX_SYMBOL_STR
(
rcu_b¬r›r
) },

52 { 0xc7a1840e, 
__VMLINUX_SYMBOL_STR
(
Îi¡_add_b©ch
) },

53 { 0xcc277e09, 
__VMLINUX_SYMBOL_STR
(
fem­_wr™e_ªd_wa™_¿nge
) },

54 { 0xc8b57c27, 
__VMLINUX_SYMBOL_STR
(
autÜemove_wake_funùiÚ
) },

55 { 0x9469482, 
__VMLINUX_SYMBOL_STR
(
kä“_ÿÎ_rcu
) },

56 { 0xf2e1de98, 
__VMLINUX_SYMBOL_STR
(
g’”ic_fh_to_·»Á
) },

57 { 0x79¯04a2, 
__VMLINUX_SYMBOL_STR
(
g‘_¿ndom_by‹s
) },

58 { 0x34184aã, 
__VMLINUX_SYMBOL_STR
(
cu¼’t_k”Ãl_time
) },

59 { 0xba87dfd9, 
__VMLINUX_SYMBOL_STR
(
sšgË_»Ëa£
) },

60 { 0x3fb8a666, 
__VMLINUX_SYMBOL_STR
(
£q_puts
) },

61 { 0x1bd67f2d, 
__VMLINUX_SYMBOL_STR
(
is_bad_šode
) },

62 { 0xb28ebd78, 
__VMLINUX_SYMBOL_STR
(
blkdev_issue_æush
) },

63 { 0x8cf80û4, 
__VMLINUX_SYMBOL_STR
(
·geÿche_g‘_·ge
) },

64 { 0xÿ34a823, 
__VMLINUX_SYMBOL_STR
(
Œunÿ‹_šode_·ges_¿nge
) },

65 { 0x4056dfdd, 
__VMLINUX_SYMBOL_STR
(
g’”ic_fe_İ’
) },

66 { 0xd1a014b0, 
__VMLINUX_SYMBOL_STR
(
posix_aş_acûss_x©Œ_hªdËr
) },

67 { 0xacf4d843, 
__VMLINUX_SYMBOL_STR
(
m©ch_¡rdup
) },

68 { 0x7ab88a45, 
__VMLINUX_SYMBOL_STR
(
sy¡em_ä“zšg_út
) },

69 { 0x8b900f3b, 
__VMLINUX_SYMBOL_STR
(
_¿w_»ad_lock
) },

70 { 0x6cdf3710, 
__VMLINUX_SYMBOL_STR
(
__lock_·ge
) },

71 { 0xd41a4adb, 
__VMLINUX_SYMBOL_STR
(
touch_©ime
) },

72 { 0xc0a3d105, 
__VMLINUX_SYMBOL_STR
(
fšd_Ãxt_b™
) },

73 { 0xc08d90ac, 
__VMLINUX_SYMBOL_STR
(
dput
) },

74 { 0x91831d70, 
__VMLINUX_SYMBOL_STR
(
£q_´štf
) },

75 { 0xde6ç2cb, 
__VMLINUX_SYMBOL_STR
(
g’”ic_fe_»m­_·ges
) },

76 { 0xd3e0937c, 
__VMLINUX_SYMBOL_STR
(
»move_´oc_’Œy
) },

77 { 0x6729d3df, 
__VMLINUX_SYMBOL_STR
(
__g‘_u£r_4
) },

78 { 0x44e9a829, 
__VMLINUX_SYMBOL_STR
(
m©ch_tok’
) },

79 { 0x448—c3e, 
__VMLINUX_SYMBOL_STR
(
kmemdup
) },

80 { 0x2d5d2f69, 
__VMLINUX_SYMBOL_STR
(
šc_Æšk
) },

81 { 0xc1891a45, 
__VMLINUX_SYMBOL_STR
(
š™_u£r_ns
) },

82 { 0xc0e2«ba, 
__VMLINUX_SYMBOL_STR
(
fem­_fd©awa™_¿nge
) },

83 { 0x8b0e7032, 
__VMLINUX_SYMBOL_STR
(
mu‹x_uÆock
) },

84 { 0xû3c6ef3, 
__VMLINUX_SYMBOL_STR
(
mouÁ_bdev
) },

85 { 0x85df9b6c, 
__VMLINUX_SYMBOL_STR
(
¡r£p
) },

86 { 0x703dfdb2, 
__VMLINUX_SYMBOL_STR
(
kobjeù_d–
) },

87 { 0xc4980bcd, 
__VMLINUX_SYMBOL_STR
(
g’”ic_»ad_dœ
) },

88 { 0x999e8297, 
__VMLINUX_SYMBOL_STR
(
vä“
) },

89 { 0x3ecc7262, 
__VMLINUX_SYMBOL_STR
(
ig¿b
) },

90 { 0x¯a5a95f, 
__VMLINUX_SYMBOL_STR
(
debugfs_ü—‹_fe
) },

91 { 0x4629334c, 
__VMLINUX_SYMBOL_STR
(
__´“m±_couÁ
) },

92 { 0xb1493418, 
__VMLINUX_SYMBOL_STR
(
g’”ic_£tx©Œ
) },

93 { 0xã723618, 
__VMLINUX_SYMBOL_STR
(
»dœty_·ge_fÜ_wr™•age
) },

94 { 0x6daf03da, 
__VMLINUX_SYMBOL_STR
(
debugfs_»move_»cursive
) },

95 { 0x419bdf68, 
__VMLINUX_SYMBOL_STR
(
£q_»ad
) },

96 { 0x40c7247c, 
__VMLINUX_SYMBOL_STR
(
si_memšfo
) },

97 { 0xa7272c48, 
__VMLINUX_SYMBOL_STR
(
£t_·ge_dœty
) },

98 { 0x39214c66, 
__VMLINUX_SYMBOL_STR
(
kth»ad_ü—‹_Ú_node
) },

99 { 0x8eb0371e, 
__VMLINUX_SYMBOL_STR
(
Œunÿ‹_£tsize
) },

100 { 0x9e7db4e4, 
__VMLINUX_SYMBOL_STR
(
mu‹x_Œylock
) },

101 { 0x3608f183, 
__VMLINUX_SYMBOL_STR
(
down_»ad
) },

102 { 0xc0363765, 
__VMLINUX_SYMBOL_STR
(
’d_·ge_wr™eback
) },

103 { 0xc463b4e4, 
__VMLINUX_SYMBOL_STR
(
make_kgid
) },

104 { 0xf432dd3d, 
__VMLINUX_SYMBOL_STR
(
__š™_wa™queue_h—d
) },

105 { 0x4f8b5ddb, 
__VMLINUX_SYMBOL_STR
(
_cİy_to_u£r
) },

106 { 0x22717363, 
__VMLINUX_SYMBOL_STR
(
PDE_DATA
) },

107 { 0x6d0aba34, 
__VMLINUX_SYMBOL_STR
(
wa™_fÜ_com¶‘iÚ
) },

108 { 0x5c46bbdb, 
__VMLINUX_SYMBOL_STR
(
šode_owÃr_Ü_ÿ·bË
) },

109 { 0xa7cdc1ff, 
__VMLINUX_SYMBOL_STR
(
m·ge_»ad·ges
) },

110 { 0x3c80c06c, 
__VMLINUX_SYMBOL_STR
(
k¡¹ouÎ
) },

111 { 0xbbe1«de, 
__VMLINUX_SYMBOL_STR
(
Œaû_defše_f›ld
) },

112 { 0x22f9529, 
__VMLINUX_SYMBOL_STR
(
á¿û_ev’t_bufãr_comm™
) },

113 { 0xfb578fc5, 
__VMLINUX_SYMBOL_STR
(
mem£t
) },

114 { 0x67bc8d49, 
__VMLINUX_SYMBOL_STR
(
äom_kuid
) },

115 { 0xc4b5c09, 
__VMLINUX_SYMBOL_STR
(
´oc_mkdœ
) },

116 { 0x7b2baff4, 
__VMLINUX_SYMBOL_STR
(
m·ge_»ad·ge
) },

117 { 0x8f64¯4, 
__VMLINUX_SYMBOL_STR
(
_¿w_¥š_uÆock_œq»¡Üe
) },

118 { 0x36586807, 
__VMLINUX_SYMBOL_STR
(
cu¼’t_sk
) },

119 { 0x830b0bç, 
__VMLINUX_SYMBOL_STR
(
ä“zšg_¦ow_·th
) },

120 { 0x746765b2, 
__VMLINUX_SYMBOL_STR
(
__b»ad_gå
) },

121 { 0x6b50e47d, 
__VMLINUX_SYMBOL_STR
(
__mu‹x_š™
) },

122 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
´štk
) },

123 { 0xc23c7f40, 
__VMLINUX_SYMBOL_STR
(
kth»ad_¡İ
) },

124 { 0x34b8e364, 
__VMLINUX_SYMBOL_STR
(
posix_aş_chmod
) },

125 { 0xde880062, 
__VMLINUX_SYMBOL_STR
(
d_obš_®Ÿs
) },

126 { 0x449ad0a7, 
__VMLINUX_SYMBOL_STR
(
memcmp
) },

127 { 0x121ã8df, 
__VMLINUX_SYMBOL_STR
(
iov_™”_®ignm’t
) },

128 { 0x534çc7e, 
__VMLINUX_SYMBOL_STR
(
bio_add_·ge
) },

129 { 0x97856a99, 
__VMLINUX_SYMBOL_STR
(
kobjeù_š™_ªd_add
) },

130 { 0x479c3c86, 
__VMLINUX_SYMBOL_STR
(
fšd_Ãxt_z”o_b™
) },

131 { 0xa1c76e0a, 
__VMLINUX_SYMBOL_STR
(
_cÚd_»sched
) },

132 { 0xb81ãbbd, 
__VMLINUX_SYMBOL_STR
(
äom_kgid
) },

133 { 0x6e45d0«, 
__VMLINUX_SYMBOL_STR
(
£q_putc
) },

134 { 0xf529952e, 
__VMLINUX_SYMBOL_STR
(
£cur™y_šode_š™_£cur™y
) },

135 { 0x68b83ac6, 
__VMLINUX_SYMBOL_STR
(
posix_aş_®loc
) },

136 { 0xefd56979, 
__VMLINUX_SYMBOL_STR
(
__·ge_ÿche_®loc
) },

137 { 0x5f3e89f3, 
__VMLINUX_SYMBOL_STR
(
debugfs_»move
) },

138 { 0xcb2760cc, 
__VMLINUX_SYMBOL_STR
(
kmem_ÿche_ä“
) },

139 { 0x93a6e0b2, 
__VMLINUX_SYMBOL_STR
(
io_scheduË
) },

140 { 0x16305289, 
__VMLINUX_SYMBOL_STR
(
w¬n_¦ow·th_nuÎ
) },

141 { 0xec911f, 
__VMLINUX_SYMBOL_STR
(
mu‹x_lock
) },

142 { 0x47e214fd, 
__VMLINUX_SYMBOL_STR
(
£t_Æšk
) },

143 { 0x¯c0260d, 
__VMLINUX_SYMBOL_STR
(
fe_upd©e_time
) },

144 { 0x6ãb73e1, 
__VMLINUX_SYMBOL_STR
(
wr™e_ÿche_·ges
) },

145 { 0x143687b2, 
__VMLINUX_SYMBOL_STR
(
_¿w_wr™e_lock
) },

146 { 0x60df1e3b, 
__VMLINUX_SYMBOL_STR
(
posix_aş_equiv_mode
) },

147 { 0x39a77281, 
__VMLINUX_SYMBOL_STR
(
·ge_symlšk
) },

148 { 0xb6ccc0ed, 
__VMLINUX_SYMBOL_STR
(
š£¹_šode_locked
) },

149 { 0xfd2a6815, 
__VMLINUX_SYMBOL_STR
(
Œunÿ‹_·geÿche
) },

150 { 0x1fd6bbf3, 
__VMLINUX_SYMBOL_STR
(
£t_ÿched_aş
) },

151 { 0x4e3567f7, 
__VMLINUX_SYMBOL_STR
(
m©ch_št
) },

152 { 0xf5bbf352, 
__VMLINUX_SYMBOL_STR
(
wa™_Ú_·ge_b™
) },

153 { 0x36f833«, 
__VMLINUX_SYMBOL_STR
(
uÆock_·ge
) },

154 { 0x9d71fc50, 
__VMLINUX_SYMBOL_STR
(
g’”ic_fe_»ad_™”
) },

155 { 0x680135f9, 
__VMLINUX_SYMBOL_STR
(
up_wr™e
) },

156 { 0x31518a04, 
__VMLINUX_SYMBOL_STR
(
shršk_dÿche_sb
) },

157 { 0x2dbfffd6, 
__VMLINUX_SYMBOL_STR
(
down_wr™e
) },

158 { 0xdc6f9ba9, 
__VMLINUX_SYMBOL_STR
(
__g‘_·ge_
) },

159 { 0x3d51730b, 
__VMLINUX_SYMBOL_STR
(
posix_aş_ü—‹
) },

160 { 0xdaddb7f, 
__VMLINUX_SYMBOL_STR
(
__b»l£
) },

161 { 0x3c483012, 
__VMLINUX_SYMBOL_STR
(
¿dix_Œ“_d–‘e
) },

162 { 0x45e81512, 
__VMLINUX_SYMBOL_STR
(
bio_put
) },

163 { 0x6d85e154, 
__VMLINUX_SYMBOL_STR
(
g’”ic_»movex©Œ
) },

164 { 0xa0e8e1a2, 
__VMLINUX_SYMBOL_STR
(
šode_š™_Úû
) },

165 { 0xd96“d98, 
__VMLINUX_SYMBOL_STR
(
á¿û_ev’t_»g
) },

166 { 0x“d631f8, 
__VMLINUX_SYMBOL_STR
(
·ge_fŞlow_lšk_light
) },

167 { 0xe1f687ba, 
__VMLINUX_SYMBOL_STR
(
mÁ_drİ_wr™e_fe
) },

168 { 0xdd1a84b0, 
__VMLINUX_SYMBOL_STR
(
subm™_bio
) },

169 { 0xc6cbbc89, 
__VMLINUX_SYMBOL_STR
(
ÿ·bË
) },

170 { 0xbd9074b1, 
__VMLINUX_SYMBOL_STR
(
blk_fšish_¶ug
) },

171 { 0xe20372«, 
__VMLINUX_SYMBOL_STR
(
¿dix_Œ“_gªg_lookup
) },

172 { 0x40a9b349, 
__VMLINUX_SYMBOL_STR
(
vz®loc
) },

173 { 0x8eba3a95, 
__VMLINUX_SYMBOL_STR
(
kmem_ÿche_®loc
) },

174 { 0xb2fd5ûb, 
__VMLINUX_SYMBOL_STR
(
__put_u£r_4
) },

175 { 0xddb1cd7, 
__VMLINUX_SYMBOL_STR
(
Îi¡_»v”£_Üd”
) },

176 { 0x36847623, 
__VMLINUX_SYMBOL_STR
(
g’”ic_block_f›m­
) },

177 { 0x950b—78, 
__VMLINUX_SYMBOL_STR
(
fs_kobj
) },

178 { 0x88b5e634, 
__VMLINUX_SYMBOL_STR
(
bdevÇme
) },

179 { 0xf2748943, 
__VMLINUX_SYMBOL_STR
(
Œunÿ‹_šode_·ges_fš®
) },

180 { 0xe87f0791, 
__VMLINUX_SYMBOL_STR
(
make_kuid
) },

181 { 0xaccf8003, 
__VMLINUX_SYMBOL_STR
(
·gevec_lookup_g
) },

182 { 0x3bd1b1f6, 
__VMLINUX_SYMBOL_STR
(
m£cs_to_jiff›s
) },

183 { 0xd62c833f, 
__VMLINUX_SYMBOL_STR
(
scheduË_timeout
) },

184 { 0x1000e51, 
__VMLINUX_SYMBOL_STR
(
scheduË
) },

185 { 0x96b29254, 
__VMLINUX_SYMBOL_STR
(
¡ºÿ£cmp
) },

186 { 0x251ad51f, 
__VMLINUX_SYMBOL_STR
(
uÆock_Ãw_šode
) },

187 { 0x948e5c09, 
__VMLINUX_SYMBOL_STR
(
mÁ_wªt_wr™e_fe
) },

188 { 0x8b8059bd, 
__VMLINUX_SYMBOL_STR
(
š_group_p
) },

189 { 0xûc87b5b, 
__VMLINUX_SYMBOL_STR
(
kl_block_su³r
) },

190 { 0xcb4bf16f, 
__VMLINUX_SYMBOL_STR
(
šode_Ãwsize_ok
) },

191 { 0x550517a5, 
__VMLINUX_SYMBOL_STR
(
·ge_ÿche_sync_»adah—d
) },

192 { 0x4482cdb, 
__VMLINUX_SYMBOL_STR
(
__»äig”©Ü
) },

193 { 0x82887488, 
__VMLINUX_SYMBOL_STR
(
wake_up_´oûss
) },

194 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__ãÁry__
) },

195 { 0x56ç6162, 
__VMLINUX_SYMBOL_STR
(
vfs_£os
) },

196 { 0xc0e6bdb6, 
__VMLINUX_SYMBOL_STR
(
ş—r_·ge_dœty_fÜ_io
) },

197 { 0xc881c0a0, 
__VMLINUX_SYMBOL_STR
(
šode_chªge_ok
) },

198 { 0x25378e4a, 
__VMLINUX_SYMBOL_STR
(
kmem_ÿche_®loc_Œaû
) },

199 { 0xd52bf1û, 
__VMLINUX_SYMBOL_STR
(
_¿w_¥š_lock
) },

200 { 0x9327f5û, 
__VMLINUX_SYMBOL_STR
(
_¿w_¥š_lock_œq§ve
) },

201 { 0x86465cd6, 
__VMLINUX_SYMBOL_STR
(
á¿û_ev’t_bufãr_»£rve
) },

202 { 0x10950“1, 
__VMLINUX_SYMBOL_STR
(
¿dix_Œ“_g_ş—r
) },

203 { 0x53402273, 
__VMLINUX_SYMBOL_STR
(
Ãw_sync_»ad
) },

204 { 0x98d2a973, 
__VMLINUX_SYMBOL_STR
(
kmem_ÿche_ü—‹
) },

205 { 0xb6b8cç3, 
__VMLINUX_SYMBOL_STR
(
d_tmpfe
) },

206 { 0x3e5daf36, 
__VMLINUX_SYMBOL_STR
(
»gi¡”_fesy¡em
) },

207 { 0x4302d0eb, 
__VMLINUX_SYMBOL_STR
(
ä“_·ges
) },

208 { 0x88db5201, 
__VMLINUX_SYMBOL_STR
(
g’”ic_fe_wr™e_™”
) },

209 { 0x8860253a, 
__VMLINUX_SYMBOL_STR
(
ev’t_Œigg”s_ÿÎ
) },

210 { 0xcf21d241, 
__VMLINUX_SYMBOL_STR
(
__wake_up
) },

211 { 0xb3f7646e, 
__VMLINUX_SYMBOL_STR
(
kth»ad_should_¡İ
) },

212 { 0x92c6477a, 
__VMLINUX_SYMBOL_STR
(
__·gevec_»Ëa£
) },

213 { 0x34f22f94, 
__VMLINUX_SYMBOL_STR
(
´•¬e_to_wa™_ev’t
) },

214 { 0x1fb1“b4, 
__VMLINUX_SYMBOL_STR
(
__‹¡_£t_·ge_wr™eback
) },

215 { 0x58b9557c, 
__VMLINUX_SYMBOL_STR
(
´oc_ü—‹_d©a
) },

216 { 0xab3d27e5, 
__VMLINUX_SYMBOL_STR
(
™”_fe_¥liû_wr™e
) },

217 { 0xe39445e3, 
__VMLINUX_SYMBOL_STR
(
£q_l£ek
) },

218 { 0xb9c1243, 
__VMLINUX_SYMBOL_STR
(
k£t_uÄegi¡”
) },

219 { 0x64«dccc, 
__VMLINUX_SYMBOL_STR
(
ut
) },

220 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
kä“
) },

221 { 0xf233a451, 
__VMLINUX_SYMBOL_STR
(
d_fšd_ªy_®Ÿs
) },

222 { 0xb4dÿaba, 
__VMLINUX_SYMBOL_STR
(
ihŞd
) },

223 { 0x69acdf38, 
__VMLINUX_SYMBOL_STR
(
memıy
) },

224 { 0x2a4e1c3c, 
__VMLINUX_SYMBOL_STR
(
__sb_’d_wr™e
) },

225 { 0xdbacda67, 
__VMLINUX_SYMBOL_STR
(
Œaû_ev’t_¿w_š™
) },

226 { 0xa75312bc, 
__VMLINUX_SYMBOL_STR
(
ÿÎ_rcu_sched
) },

227 { 0x5c8b5û8, 
__VMLINUX_SYMBOL_STR
(
´•¬e_to_wa™
) },

228 { 0xd498a358, 
__VMLINUX_SYMBOL_STR
(
d_¥liû_®Ÿs
) },

229 { 0xd0a91bab, 
__VMLINUX_SYMBOL_STR
(
sk_¥aûs
) },

230 { 0xe6602e9f, 
__VMLINUX_SYMBOL_STR
(
³rf_Œaû_buf_´•¬e
) },

231 { 0x25376ec2, 
__VMLINUX_SYMBOL_STR
(
sync_fesy¡em
) },

232 { 0x246e88f4, 
__VMLINUX_SYMBOL_STR
(
šv®id©e_m­pšg_·ges
) },

233 { 0x7—702f0, 
__VMLINUX_SYMBOL_STR
(
sb_£t_blocksize
) },

234 { 0xe20214df, 
__VMLINUX_SYMBOL_STR
(
__sb_¡¬t_wr™e
) },

235 { 0x87c9bc71, 
__VMLINUX_SYMBOL_STR
(
g’”ic_»adlšk
) },

236 { 0x7628f3c7, 
__VMLINUX_SYMBOL_STR
(
this_ıu_off
) },

237 { 0xf19282c9, 
__VMLINUX_SYMBOL_STR
(
put_·ge
) },

238 { 0xe13«006, 
__VMLINUX_SYMBOL_STR
(
d_make_roÙ
) },

239 { 0x7a4497db, 
__VMLINUX_SYMBOL_STR
(
kzä“
) },

240 { 0xf03e27db, 
__VMLINUX_SYMBOL_STR
(
__blockdev_dœeù_IO
) },

241 { 0xb352177e, 
__VMLINUX_SYMBOL_STR
(
fšd_fœ¡_b™
) },

242 { 0xç66f77c, 
__VMLINUX_SYMBOL_STR
(
fšish_wa™
) },

243 { 0x844e3767, 
__VMLINUX_SYMBOL_STR
(
¿dix_Œ“_lookup
) },

244 { 0x318f7b5e, 
__VMLINUX_SYMBOL_STR
(
posix_aş_deçuÉ_x©Œ_hªdËr
) },

245 { 0x47b6a10f, 
__VMLINUX_SYMBOL_STR
(
á¿û_´št_symbŞs_£q
) },

246 { 0x7980ab«, 
__VMLINUX_SYMBOL_STR
(
uÄegi¡”_fesy¡em
) },

247 { 0x90ef106f, 
__VMLINUX_SYMBOL_STR
(
š™_¥ecŸl_šode
) },

248 { 0xf3038a60, 
__VMLINUX_SYMBOL_STR
(
fem­_m­_·ges
) },

249 { 0x4b06d2e7, 
__VMLINUX_SYMBOL_STR
(
com¶‘e
) },

250 { 0x28318305, 
__VMLINUX_SYMBOL_STR
(
¢´štf
) },

251 { 0x54add4ac, 
__VMLINUX_SYMBOL_STR
(
Ãw_šode
) },

252 { 0x1e3a88fb, 
__VMLINUX_SYMBOL_STR
(
Œaû_£q_´štf
) },

253 { 0xb0e602eb, 
__VMLINUX_SYMBOL_STR
(
memmove
) },

254 { 0x19a214ã, 
__VMLINUX_SYMBOL_STR
(
g’”ic_fe_¥liû_»ad
) },

255 { 0x5287a6a1, 
__VMLINUX_SYMBOL_STR
(
g’”ic_fh_to_d’Œy
) },

256 { 0x4f6b400b, 
__VMLINUX_SYMBOL_STR
(
_cİy_äom_u£r
) },

257 { 0x9f4b2964, 
__VMLINUX_SYMBOL_STR
(
g¿b_ÿche_·ge_wr™e_begš
) },

258 { 0x614bb773, 
__VMLINUX_SYMBOL_STR
(
¿dix_Œ“_š£¹
) },

259 { 0x7a071583, 
__VMLINUX_SYMBOL_STR
(
ş—r_šode
) },

260 { 0x7d705738, 
__VMLINUX_SYMBOL_STR
(
blk_¡¬t_¶ug
) },

261 { 0x83f766df, 
__VMLINUX_SYMBOL_STR
(
·ge_put_lšk
) },

262 { 0xa2779881, 
__VMLINUX_SYMBOL_STR
(
d_š¡ªtŸ‹
) },

263 { 0x992e786f, 
__VMLINUX_SYMBOL_STR
(
á¿û_¿w_ouut_´•
) },

264 { 0x67fçad0, 
__VMLINUX_SYMBOL_STR
(
__š™_rw£m
) },

265 { 0xa231—dd, 
__VMLINUX_SYMBOL_STR
(
g’”ic_block_bm­
) },

266 { 0xebd98a24, 
__VMLINUX_SYMBOL_STR
(
ş—r_Æšk
) },

267 { 0x90cc3f9f, 
__VMLINUX_SYMBOL_STR
(
ig‘_locked
) },

268 { 0xbfb4ÿ7f, 
__VMLINUX_SYMBOL_STR
(
g’”ic_fÏ‰r
) },

269 { 0xd3e88b77, 
__VMLINUX_SYMBOL_STR
(
fem­_fd©awr™e
) },

270 { 0xf20a6e7f, 
__VMLINUX_SYMBOL_STR
(
šode_š™_owÃr
) },

271 { 0xe2304e87, 
__VMLINUX_SYMBOL_STR
(
Œunÿ‹_šode_·ges
) },

274 cÚ¡ 
	g__moduË_d•’ds
[]

275 
__u£d


276 
__©Œibu‹__
((
£ùiÚ
(".modinfo"))) =

280 
MODULE_INFO
(
¤cv”siÚ
, "94C7AD2ED729C1FD0585177");

	@file.c

11 
	~<lšux/fs.h
>

12 
	~<lšux/f2fs_fs.h
>

13 
	~<lšux/¡©.h
>

14 
	~<lšux/bufãr_h—d.h
>

15 
	~<lšux/wr™eback.h
>

16 
	~<lšux/blkdev.h
>

17 
	~<lšux/çÎoc.h
>

18 
	~<lšux/ty³s.h
>

19 
	~<lšux/com·t.h
>

20 
	~<lšux/uacûss.h
>

21 
	~<lšux/mouÁ.h
>

22 
	~<lšux/·gevec.h
>

24 
	~"f2fs.h
"

25 
	~"node.h
"

26 
	~"£gm’t.h
"

27 
	~"x©Œ.h
"

28 
	~"aş.h
"

29 
	~<Œaû/ev’ts/f2fs.h
>

31 
	$f2fs_vm_·ge_mkwr™e
(
vm_¬—_¡ruù
 *
vma
,

32 
vm_çuÉ
 *
vmf
)

34 
·ge
 *·gğ
vmf
->page;

35 
šode
 *šodğ
	`fe_šode
(
vma
->
vm_fe
);

36 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

37 
dnode_of_d©a
 
dn
;

38 
”r
;

40 
	`f2fs_b®ªû_fs
(
sbi
);

42 
	`sb_¡¬t_·geçuÉ
(
šode
->
i_sb
);

45 
”r
 = 
	`f2fs_cÚv”t_šlše_d©a
(
šode
, 
MAX_INLINE_DATA
 + 1, 
·ge
);

46 ià(
”r
)

47 
out
;

50 
	`f2fs_lock_İ
(
sbi
);

51 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

52 
”r
 = 
	`f2fs_»£rve_block
(&
dn
, 
·ge
->
šdex
);

53 
	`f2fs_uÆock_İ
(
sbi
);

54 ià(
”r
)

55 
out
;

57 
	`fe_upd©e_time
(
vma
->
vm_fe
);

58 
	`lock_·ge
(
·ge
);

59 ià(
	`uÆik–y
(
·ge
->
m­pšg
 !ğ
šode
->
i_m­pšg
 ||

60 
	`·ge_off£t
(
·ge
è> 
	`i_size_»ad
(
šode
) ||

61 !
	`PageU±od©e
(
·ge
))) {

62 
	`uÆock_·ge
(
·ge
);

63 
”r
 = -
EFAULT
;

64 
out
;

70 ià(
	`PageM­³dToDisk
(
·ge
))

71 
m­³d
;

74 ià(((
·ge
->
šdex
 + 1è<< 
PAGE_CACHE_SHIFT
è> 
	`i_size_»ad
(
šode
)) {

75 
off£t
;

76 
off£t
 = 
	`i_size_»ad
(
šode
è& ~
PAGE_CACHE_MASK
;

77 
	`z”o_u£r_£gm’t
(
·ge
, 
off£t
, 
PAGE_CACHE_SIZE
);

79 
	`£t_·ge_dœty
(
·ge
);

80 
	`S‘PageU±od©e
(
·ge
);

82 
	`Œaû_f2fs_vm_·ge_mkwr™e
(
·ge
, 
DATA
);

83 
m­³d
:

85 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
);

86 
out
:

87 
	`sb_’d_·geçuÉ
(
šode
->
i_sb
);

88  
	`block_·ge_mkwr™e_»tuº
(
”r
);

89 
	}
}

91 cÚ¡ 
vm_İ”©iÚs_¡ruù
 
	gf2fs_fe_vm_İs
 = {

92 .
çuÉ
 = 
fem­_çuÉ
,

93 .
	gm­_·ges
 = 
fem­_m­_·ges
,

94 .
	g·ge_mkwr™e
 = 
f2fs_vm_·ge_mkwr™e
,

95 .
	g»m­_·ges
 = 
g’”ic_fe_»m­_·ges
,

98 
	$g‘_·»Á_šo
(
šode
 *šode, 
nid_t
 *
pšo
)

100 
d’Œy
 *dentry;

102 
šode
 = 
	`ig¿b
(inode);

103 
d’Œy
 = 
	`d_fšd_ªy_®Ÿs
(
šode
);

104 
	`ut
(
šode
);

105 ià(!
d’Œy
)

108 ià(
	`upd©e_d’t_šode
(
šode
, &
d’Œy
->
d_Çme
)) {

109 
	`dput
(
d’Œy
);

113 *
pšo
 = 
	`·»Á_šo
(
d’Œy
);

114 
	`dput
(
d’Œy
);

116 
	}
}

118 
šlše
 
boŞ
 
	$Ãed_do_checkpošt
(
šode
 *inode)

120 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

121 
boŞ
 
Ãed_ı
 = 
çl£
;

123 ià(!
	`S_ISREG
(
šode
->
i_mode
è|| inode->
i_Æšk
 != 1)

124 
Ãed_ı
 = 
Œue
;

125 ià(
	`fe_wrÚg_pšo
(
šode
))

126 
Ãed_ı
 = 
Œue
;

127 ià(!
	`¥aû_fÜ_rŞl_fÜw¬d
(
sbi
))

128 
Ãed_ı
 = 
Œue
;

129 ià(!
	`is_checkpoš‹d_node
(
sbi
, 
	`F2FS_I
(
šode
)->
i_pšo
))

130 
Ãed_ı
 = 
Œue
;

131 ià(
	`F2FS_I
(
šode
)->
x©Œ_v”
 =ğ
	`cur_ı_v”siÚ
(
	`F2FS_CKPT
(
sbi
)))

132 
Ãed_ı
 = 
Œue
;

134  
Ãed_ı
;

135 
	}
}

137 
	$f2fs_sync_fe
(
fe
 *fe, 
loff_t
 
¡¬t
,†off_ˆ
’d
, 
d©async
)

139 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

140 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

141 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

142 
nid_t
 
šo
 = 
šode
->
i_šo
;

143 
»t
 = 0;

144 
boŞ
 
Ãed_ı
 = 
çl£
;

145 
wr™eback_cÚŒŞ
 
wbc
 = {

146 .
sync_mode
 = 
WB_SYNC_ALL
,

147 .
Ä_to_wr™e
 = 
LONG_MAX
,

148 .
fÜ_»şaim
 = 0,

151 ià(
	`uÆik–y
(
	`f2fs_»adÚly
(
šode
->
i_sb
)))

154 
	`Œaû_f2fs_sync_fe_’‹r
(
šode
);

157 ià(
	`g‘_dœty_·ges
(
šode
è<ğ
	`SM_I
(
sbi
)->
mš_fsync_blocks
)

158 
	`£t_šode_æag
(
fi
, 
FI_NEED_IPU
);

159 
»t
 = 
	`fem­_wr™e_ªd_wa™_¿nge
(
šode
->
i_m­pšg
, 
¡¬t
, 
’d
);

160 
	`ş—r_šode_æag
(
fi
, 
FI_NEED_IPU
);

162 ià(
»t
) {

163 
	`Œaû_f2fs_sync_fe_ex™
(
šode
, 
Ãed_ı
, 
d©async
, 
»t
);

164  
»t
;

170 ià(!
	`is_šode_æag_£t
(
fi
, 
FI_APPEND_WRITE
) &&

171 !
	`exi¡_wr™‹n_d©a
(
sbi
, 
šo
, 
APPEND_INO
)) {

172 
·ge
 *
i
 = 
	`fšd_g‘_·ge
(
	`NODE_MAPPING
(
sbi
), 
šo
);

175 ià((
i
 && 
	`PageDœty
(i)è|| 
	`Ãed_šode_block_upd©e
(
sbi
, 
šo
)) {

176 
	`f2fs_put_·ge
(
i
, 0);

177 
go_wr™e
;

179 
	`f2fs_put_·ge
(
i
, 0);

181 ià(
	`is_šode_æag_£t
(
fi
, 
FI_UPDATE_WRITE
) ||

182 
	`exi¡_wr™‹n_d©a
(
sbi
, 
šo
, 
UPDATE_INO
))

183 
æush_out
;

184 
out
;

186 
go_wr™e
:

188 
	`f2fs_b®ªû_fs
(
sbi
);

194 
	`down_»ad
(&
fi
->
i_£m
);

195 
Ãed_ı
 = 
	`Ãed_do_checkpošt
(
šode
);

196 
	`up_»ad
(&
fi
->
i_£m
);

198 ià(
Ãed_ı
) {

199 
nid_t
 
pšo
;

202 
»t
 = 
	`f2fs_sync_fs
(
šode
->
i_sb
, 1);

204 
	`down_wr™e
(&
fi
->
i_£m
);

205 
	`F2FS_I
(
šode
)->
x©Œ_v”
 = 0;

206 ià(
	`fe_wrÚg_pšo
(
šode
è&& inode->
i_Æšk
 == 1 &&

207 
	`g‘_·»Á_šo
(
šode
, &
pšo
)) {

208 
	`F2FS_I
(
šode
)->
i_pšo
 = 
pšo
;

209 
	`fe_gÙ_pšo
(
šode
);

210 
	`up_wr™e
(&
fi
->
i_£m
);

211 
	`m¬k_šode_dœty_sync
(
šode
);

212 
»t
 = 
	`f2fs_wr™e_šode
(
šode
, 
NULL
);

213 ià(
»t
)

214 
out
;

216 
	`up_wr™e
(&
fi
->
i_£m
);

219 
sync_nodes
:

220 
	`sync_node_·ges
(
sbi
, 
šo
, &
wbc
);

222 ià(
	`Ãed_šode_block_upd©e
(
sbi
, 
šo
)) {

223 
	`m¬k_šode_dœty_sync
(
šode
);

224 
»t
 = 
	`f2fs_wr™e_šode
(
šode
, 
NULL
);

225 ià(
»t
)

226 
out
;

227 
sync_nodes
;

230 
»t
 = 
	`wa™_Ú_node_·ges_wr™eback
(
sbi
, 
šo
);

231 ià(
»t
)

232 
out
;

235 
	`»move_dœty_šode
(
sbi
, 
šo
, 
APPEND_INO
);

236 
	`ş—r_šode_æag
(
fi
, 
FI_APPEND_WRITE
);

237 
æush_out
:

238 
	`»move_dœty_šode
(
sbi
, 
šo
, 
UPDATE_INO
);

239 
	`ş—r_šode_æag
(
fi
, 
FI_UPDATE_WRITE
);

240 
»t
 = 
	`f2fs_issue_æush
(
	`F2FS_I_SB
(
šode
));

242 
out
:

243 
	`Œaû_f2fs_sync_fe_ex™
(
šode
, 
Ãed_ı
, 
d©async
, 
»t
);

244  
»t
;

245 
	}
}

247 
pgoff_t
 
	$__g‘_fœ¡_dœty_šdex
(
add»ss_¥aû
 *
m­pšg
,

248 
pgoff_t
 
pgofs
, 
wh’û
)

250 
·gevec
 
pvec
;

251 
Ä_·ges
;

253 ià(
wh’û
 !ğ
SEEK_DATA
)

257 
	`·gevec_š™
(&
pvec
, 0);

258 
Ä_·ges
 = 
	`·gevec_lookup_g
(&
pvec
, 
m­pšg
, &
pgofs
,

259 
PAGECACHE_TAG_DIRTY
, 1);

260 
pgofs
 = 
Ä_·ges
 ? 
pvec
.
·ges
[0]->
šdex
 : 
LONG_MAX
;

261 
	`·gevec_»Ëa£
(&
pvec
);

262  
pgofs
;

263 
	}
}

265 
boŞ
 
	$__found_off£t
(
block_t
 
blkaddr
, 
pgoff_t
 
dœty
,…goff_ˆ
pgofs
,

266 
wh’û
)

268 
wh’û
) {

269 
SEEK_DATA
:

270 ià((
blkaddr
 =ğ
NEW_ADDR
 && 
dœty
 =ğ
pgofs
) ||

271 (
blkaddr
 !ğ
NEW_ADDR
 && blkadd¸!ğ
NULL_ADDR
))

272  
Œue
;

274 
SEEK_HOLE
:

275 ià(
blkaddr
 =ğ
NULL_ADDR
)

276  
Œue
;

279  
çl£
;

280 
	}
}

282 
loff_t
 
	$f2fs_£ek_block
(
fe
 *fe, 
loff_t
 
off£t
, 
wh’û
)

284 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

285 
loff_t
 
maxby‹s
 = 
šode
->
i_sb
->
s_maxby‹s
;

286 
dnode_of_d©a
 
dn
;

287 
pgoff_t
 
pgofs
, 
’d_off£t
, 
dœty
;

288 
loff_t
 
d©a_ofs
 = 
off£t
;

289 
loff_t
 
isize
;

290 
”r
 = 0;

292 
	`mu‹x_lock
(&
šode
->
i_mu‹x
);

294 
isize
 = 
	`i_size_»ad
(
šode
);

295 ià(
off£t
 >ğ
isize
)

296 
ç
;

299 ià(
	`f2fs_has_šlše_d©a
(
šode
)) {

300 ià(
wh’û
 =ğ
SEEK_HOLE
)

301 
d©a_ofs
 = 
isize
;

302 
found
;

305 
pgofs
 = (
pgoff_t
)(
off£t
 >> 
PAGE_CACHE_SHIFT
);

307 
dœty
 = 
	`__g‘_fœ¡_dœty_šdex
(
šode
->
i_m­pšg
, 
pgofs
, 
wh’û
);

309 ; 
d©a_ofs
 < 
isize
; d©a_of ğ
pgofs
 << 
PAGE_CACHE_SHIFT
) {

310 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

311 
”r
 = 
	`g‘_dnode_of_d©a
(&
dn
, 
pgofs
, 
LOOKUP_NODE_RA
);

312 ià(
”r
 &&ƒ¼ !ğ-
ENOENT
) {

313 
ç
;

314 } ià(
”r
 =ğ-
ENOENT
) {

316 ià(
wh’û
 =ğ
SEEK_DATA
) {

317 
pgofs
 = 
	`PGOFS_OF_NEXT_DNODE
(pgofs,

318 
	`F2FS_I
(
šode
));

321 
found
;

325 
’d_off£t
 = 
	`ADDRS_PER_PAGE
(
dn
.
node_·ge
, 
	`F2FS_I
(
šode
));

328 ; 
dn
.
ofs_š_node
 < 
’d_off£t
;

329 
dn
.
ofs_š_node
++, 
pgofs
++,

330 
d©a_ofs
 = 
pgofs
 << 
PAGE_CACHE_SHIFT
) {

331 
block_t
 
blkaddr
;

332 
blkaddr
 = 
	`d©ablock_addr
(
dn
.
node_·ge
, dn.
ofs_š_node
);

334 ià(
	`__found_off£t
(
blkaddr
, 
dœty
, 
pgofs
, 
wh’û
)) {

335 
	`f2fs_put_dnode
(&
dn
);

336 
found
;

339 
	`f2fs_put_dnode
(&
dn
);

342 ià(
wh’û
 =ğ
SEEK_DATA
)

343 
ç
;

344 
found
:

345 ià(
wh’û
 =ğ
SEEK_HOLE
 && 
d©a_ofs
 > 
isize
)

346 
d©a_ofs
 = 
isize
;

347 
	`mu‹x_uÆock
(&
šode
->
i_mu‹x
);

348  
	`vfs_£os
(
fe
, 
d©a_ofs
, 
maxby‹s
);

349 
ç
:

350 
	`mu‹x_uÆock
(&
šode
->
i_mu‹x
);

351  -
ENXIO
;

352 
	}
}

354 
loff_t
 
	$f2fs_Î£ek
(
fe
 *fe, 
loff_t
 
off£t
, 
wh’û
)

356 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

357 
loff_t
 
maxby‹s
 = 
šode
->
i_sb
->
s_maxby‹s
;

359 
wh’û
) {

360 
SEEK_SET
:

361 
SEEK_CUR
:

362 
SEEK_END
:

363  
	`g’”ic_fe_Î£ek_size
(
fe
, 
off£t
, 
wh’û
,

364 
maxby‹s
, 
	`i_size_»ad
(
šode
));

365 
SEEK_DATA
:

366 
SEEK_HOLE
:

367 ià(
off£t
 < 0)

368  -
ENXIO
;

369  
	`f2fs_£ek_block
(
fe
, 
off£t
, 
wh’û
);

372  -
EINVAL
;

373 
	}
}

375 
	$f2fs_fe_mm­
(
fe
 *fe, 
vm_¬—_¡ruù
 *
vma
)

377 
	`fe_acûs£d
(
fe
);

378 
vma
->
vm_İs
 = &
f2fs_fe_vm_İs
;

380 
	}
}

382 
	$Œunÿ‹_d©a_blocks_¿nge
(
dnode_of_d©a
 *
dn
, 
couÁ
)

384 
Ä_ä“
 = 0, 
ofs
 = 
dn
->
ofs_š_node
;

385 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dn
->
šode
);

386 
f2fs_node
 *
¿w_node
;

387 
__Ë32
 *
addr
;

389 
¿w_node
 = 
	`F2FS_NODE
(
dn
->
node_·ge
);

390 
addr
 = 
	`blkaddr_š_node
(
¿w_node
è+ 
ofs
;

392 ; 
couÁ
 > 0; couÁ--, 
addr
++, 
dn
->
ofs_š_node
++) {

393 
block_t
 
blkaddr
 = 
	`Ë32_to_ıu
(*
addr
);

394 ià(
blkaddr
 =ğ
NULL_ADDR
)

397 
	`upd©e_ex‹Á_ÿche
(
NULL_ADDR
, 
dn
);

398 
	`šv®id©e_blocks
(
sbi
, 
blkaddr
);

399 
Ä_ä“
++;

401 ià(
Ä_ä“
) {

402 
	`dec_v®id_block_couÁ
(
sbi
, 
dn
->
šode
, 
Ä_ä“
);

403 
	`£t_·ge_dœty
(
dn
->
node_·ge
);

404 
	`sync_šode_·ge
(
dn
);

406 
dn
->
ofs_š_node
 = 
ofs
;

408 
	`Œaû_f2fs_Œunÿ‹_d©a_blocks_¿nge
(
dn
->
šode
, dn->
nid
,

409 
dn
->
ofs_š_node
, 
Ä_ä“
);

410  
Ä_ä“
;

411 
	}
}

413 
	$Œunÿ‹_d©a_blocks
(
dnode_of_d©a
 *
dn
)

415 
	`Œunÿ‹_d©a_blocks_¿nge
(
dn
, 
ADDRS_PER_BLOCK
);

416 
	}
}

418 
	$Œunÿ‹_·¹Ÿl_d©a_·ge
(
šode
 *šode, 
u64
 
äom
)

420 
off£t
 = 
äom
 & (
PAGE_CACHE_SIZE
 - 1);

421 
·ge
 *page;

423 ià(
	`f2fs_has_šlše_d©a
(
šode
))

424  
	`Œunÿ‹_šlše_d©a
(
šode
, 
äom
);

426 ià(!
off£t
)

429 
·ge
 = 
	`fšd_d©a_·ge
(
šode
, 
äom
 >> 
PAGE_CACHE_SHIFT
, 
çl£
);

430 ià(
	`IS_ERR
(
·ge
))

433 
	`lock_·ge
(
·ge
);

434 ià(
	`uÆik–y
(!
	`PageU±od©e
(
·ge
) ||

435 
·ge
->
m­pšg
 !ğ
šode
->
i_m­pšg
))

436 
out
;

438 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
);

439 
	`z”o_u£r
(
·ge
, 
off£t
, 
PAGE_CACHE_SIZE
 - offset);

440 
	`£t_·ge_dœty
(
·ge
);

442 
out
:

443 
	`f2fs_put_·ge
(
·ge
, 1);

444 
	}
}

446 
	$Œunÿ‹_blocks
(
šode
 *šode, 
u64
 
äom
, 
boŞ
 
lock
)

448 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

449 
blocksize
 = 
šode
->
i_sb
->
s_blocksize
;

450 
dnode_of_d©a
 
dn
;

451 
pgoff_t
 
ä“_äom
;

452 
couÁ
 = 0, 
”r
 = 0;

454 
	`Œaû_f2fs_Œunÿ‹_blocks_’‹r
(
šode
, 
äom
);

456 ià(
	`f2fs_has_šlše_d©a
(
šode
))

457 
dÚe
;

459 
ä“_äom
 = (
pgoff_t
)

460 ((
äom
 + 
blocksize
 - 1è>> (
sbi
->
log_blocksize
));

462 ià(
lock
)

463 
	`f2fs_lock_İ
(
sbi
);

465 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

466 
”r
 = 
	`g‘_dnode_of_d©a
(&
dn
, 
ä“_äom
, 
LOOKUP_NODE
);

467 ià(
”r
) {

468 ià(
”r
 =ğ-
ENOENT
)

469 
ä“_Ãxt
;

470 ià(
lock
)

471 
	`f2fs_uÆock_İ
(
sbi
);

472 
	`Œaû_f2fs_Œunÿ‹_blocks_ex™
(
šode
, 
”r
);

473  
”r
;

476 
couÁ
 = 
	`ADDRS_PER_PAGE
(
dn
.
node_·ge
, 
	`F2FS_I
(
šode
));

478 
couÁ
 -ğ
dn
.
ofs_š_node
;

479 
	`f2fs_bug_Ú
(
sbi
, 
couÁ
 < 0);

481 ià(
dn
.
ofs_š_node
 || 
	`IS_INODE
(dn.
node_·ge
)) {

482 
	`Œunÿ‹_d©a_blocks_¿nge
(&
dn
, 
couÁ
);

483 
ä“_äom
 +ğ
couÁ
;

486 
	`f2fs_put_dnode
(&
dn
);

487 
ä“_Ãxt
:

488 
”r
 = 
	`Œunÿ‹_šode_blocks
(
šode
, 
ä“_äom
);

489 ià(
lock
)

490 
	`f2fs_uÆock_İ
(
sbi
);

491 
dÚe
:

493 
	`Œunÿ‹_·¹Ÿl_d©a_·ge
(
šode
, 
äom
);

495 
	`Œaû_f2fs_Œunÿ‹_blocks_ex™
(
šode
, 
”r
);

496  
”r
;

497 
	}
}

499 
	$f2fs_Œunÿ‹
(
šode
 *inode)

501 ià(!(
	`S_ISREG
(
šode
->
i_mode
è|| 
	`S_ISDIR
(inode->i_mode) ||

502 
	`S_ISLNK
(
šode
->
i_mode
)))

505 
	`Œaû_f2fs_Œunÿ‹
(
šode
);

507 ià(!
	`Œunÿ‹_blocks
(
šode
, 
	`i_size_»ad
(šode), 
Œue
)) {

508 
šode
->
i_mtime
 = inode->
i_ùime
 = 
CURRENT_TIME
;

509 
	`m¬k_šode_dœty
(
šode
);

511 
	}
}

513 
	$f2fs_g‘©Œ
(
vfsmouÁ
 *
mÁ
,

514 
d’Œy
 *d’Œy, 
k¡©
 *
¡©
)

516 
šode
 *šodğ
d’Œy
->
d_šode
;

517 
	`g’”ic_fÏ‰r
(
šode
, 
¡©
);

518 
¡©
->
blocks
 <<= 3;

520 
	}
}

522 #ifdeà
CONFIG_F2FS_FS_POSIX_ACL


523 
	$__£‰r_cİy
(
šode
 *šode, cÚ¡ 
Ÿ‰r
 *
©Œ
)

525 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

526 
Ÿ_v®id
 = 
©Œ
->ia_valid;

528 ià(
Ÿ_v®id
 & 
ATTR_UID
)

529 
šode
->
i_uid
 = 
©Œ
->
Ÿ_uid
;

530 ià(
Ÿ_v®id
 & 
ATTR_GID
)

531 
šode
->
i_gid
 = 
©Œ
->
Ÿ_gid
;

532 ià(
Ÿ_v®id
 & 
ATTR_ATIME
)

533 
šode
->
i_©ime
 = 
	`time¥ec_Œunc
(
©Œ
->
Ÿ_©ime
,

534 
šode
->
i_sb
->
s_time_g¿n
);

535 ià(
Ÿ_v®id
 & 
ATTR_MTIME
)

536 
šode
->
i_mtime
 = 
	`time¥ec_Œunc
(
©Œ
->
Ÿ_mtime
,

537 
šode
->
i_sb
->
s_time_g¿n
);

538 ià(
Ÿ_v®id
 & 
ATTR_CTIME
)

539 
šode
->
i_ùime
 = 
	`time¥ec_Œunc
(
©Œ
->
Ÿ_ùime
,

540 
šode
->
i_sb
->
s_time_g¿n
);

541 ià(
Ÿ_v®id
 & 
ATTR_MODE
) {

542 
umode_t
 
mode
 = 
©Œ
->
Ÿ_mode
;

544 ià(!
	`š_group_p
(
šode
->
i_gid
è&& !
	`ÿ·bË
(
CAP_FSETID
))

545 
mode
 &ğ~
S_ISGID
;

546 
	`£t_aş_šode
(
fi
, 
mode
);

548 
	}
}

550 
	#__£‰r_cİy
 
£‰r_cİy


	)

553 
	$f2fs_£‰r
(
d’Œy
 *d’Œy, 
Ÿ‰r
 *
©Œ
)

555 
šode
 *šodğ
d’Œy
->
d_šode
;

556 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

557 
”r
;

559 
”r
 = 
	`šode_chªge_ok
(
šode
, 
©Œ
);

560 ià(
”r
)

561  
”r
;

563 ià(
©Œ
->
Ÿ_v®id
 & 
ATTR_SIZE
) {

564 
”r
 = 
	`f2fs_cÚv”t_šlše_d©a
(
šode
, 
©Œ
->
Ÿ_size
, 
NULL
);

565 ià(
”r
)

566  
”r
;

568 ià(
©Œ
->
Ÿ_size
 !ğ
	`i_size_»ad
(
šode
)) {

569 
	`Œunÿ‹_£tsize
(
šode
, 
©Œ
->
Ÿ_size
);

570 
	`f2fs_Œunÿ‹
(
šode
);

571 
	`f2fs_b®ªû_fs
(
	`F2FS_I_SB
(
šode
));

577 
	`f2fs_Œunÿ‹
(
šode
);

581 
	`__£‰r_cİy
(
šode
, 
©Œ
);

583 ià(
©Œ
->
Ÿ_v®id
 & 
ATTR_MODE
) {

584 
”r
 = 
	`posix_aş_chmod
(
šode
, 
	`g‘_šode_mode
(inode));

585 ià(
”r
 || 
	`is_šode_æag_£t
(
fi
, 
FI_ACL_MODE
)) {

586 
šode
->
i_mode
 = 
fi
->
i_aş_mode
;

587 
	`ş—r_šode_æag
(
fi
, 
FI_ACL_MODE
);

591 
	`m¬k_šode_dœty
(
šode
);

592  
”r
;

593 
	}
}

595 cÚ¡ 
šode_İ”©iÚs
 
	gf2fs_fe_šode_İ”©iÚs
 = {

596 .
g‘©Œ
 = 
f2fs_g‘©Œ
,

597 .
	g£‰r
 = 
f2fs_£‰r
,

598 .
	gg‘_aş
 = 
f2fs_g‘_aş
,

599 .
	g£t_aş
 = 
f2fs_£t_aş
,

600 #ifdeà
CONFIG_F2FS_FS_XATTR


601 .
	g£tx©Œ
 = 
g’”ic_£tx©Œ
,

602 .
	gg‘x©Œ
 = 
g’”ic_g‘x©Œ
,

603 .
	gli¡x©Œ
 = 
f2fs_li¡x©Œ
,

604 .
	g»movex©Œ
 = 
g’”ic_»movex©Œ
,

606 .
	gf›m­
 = 
f2fs_f›m­
,

609 
	$fl_z”o
(
šode
 *šode, 
pgoff_t
 
šdex
,

610 
loff_t
 
¡¬t
,†off_ˆ
Ën
)

612 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

613 
·ge
 *page;

615 ià(!
Ën
)

618 
	`f2fs_b®ªû_fs
(
sbi
);

620 
	`f2fs_lock_İ
(
sbi
);

621 
·ge
 = 
	`g‘_Ãw_d©a_·ge
(
šode
, 
NULL
, 
šdex
, 
çl£
);

622 
	`f2fs_uÆock_İ
(
sbi
);

624 ià(!
	`IS_ERR
(
·ge
)) {

625 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
);

626 
	`z”o_u£r
(
·ge
, 
¡¬t
, 
Ën
);

627 
	`£t_·ge_dœty
(
·ge
);

628 
	`f2fs_put_·ge
(
·ge
, 1);

630 
	}
}

632 
	$Œunÿ‹_hŞe
(
šode
 *šode, 
pgoff_t
 
pg_¡¬t
,…goff_ˆ
pg_’d
)

634 
pgoff_t
 
šdex
;

635 
”r
;

637 
šdex
 = 
pg_¡¬t
; index < 
pg_’d
; index++) {

638 
dnode_of_d©a
 
dn
;

640 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

641 
”r
 = 
	`g‘_dnode_of_d©a
(&
dn
, 
šdex
, 
LOOKUP_NODE
);

642 ià(
”r
) {

643 ià(
”r
 =ğ-
ENOENT
)

645  
”r
;

648 ià(
dn
.
d©a_blkaddr
 !ğ
NULL_ADDR
)

649 
	`Œunÿ‹_d©a_blocks_¿nge
(&
dn
, 1);

650 
	`f2fs_put_dnode
(&
dn
);

653 
	}
}

655 
	$punch_hŞe
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ën
)

657 
pgoff_t
 
pg_¡¬t
, 
pg_’d
;

658 
loff_t
 
off_¡¬t
, 
off_’d
;

659 
»t
 = 0;

661 ià(!
	`S_ISREG
(
šode
->
i_mode
))

662  -
EOPNOTSUPP
;

665 ià(
off£t
 >ğ
šode
->
i_size
)

666  
»t
;

668 
»t
 = 
	`f2fs_cÚv”t_šlše_d©a
(
šode
, 
MAX_INLINE_DATA
 + 1, 
NULL
);

669 ià(
»t
)

670  
»t
;

672 
pg_¡¬t
 = ((è
off£t
è>> 
PAGE_CACHE_SHIFT
;

673 
pg_’d
 = ((è
off£t
 + 
Ën
è>> 
PAGE_CACHE_SHIFT
;

675 
off_¡¬t
 = 
off£t
 & (
PAGE_CACHE_SIZE
 - 1);

676 
off_’d
 = (
off£t
 + 
Ën
è& (
PAGE_CACHE_SIZE
 - 1);

678 ià(
pg_¡¬t
 =ğ
pg_’d
) {

679 
	`fl_z”o
(
šode
, 
pg_¡¬t
, 
off_¡¬t
,

680 
off_’d
 - 
off_¡¬t
);

682 ià(
off_¡¬t
)

683 
	`fl_z”o
(
šode
, 
pg_¡¬t
++, 
off_¡¬t
,

684 
PAGE_CACHE_SIZE
 - 
off_¡¬t
);

685 ià(
off_’d
)

686 
	`fl_z”o
(
šode
, 
pg_’d
, 0, 
off_’d
);

688 ià(
pg_¡¬t
 < 
pg_’d
) {

689 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

690 
loff_t
 
blk_¡¬t
, 
blk_’d
;

691 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

693 
	`f2fs_b®ªû_fs
(
sbi
);

695 
blk_¡¬t
 = 
pg_¡¬t
 << 
PAGE_CACHE_SHIFT
;

696 
blk_’d
 = 
pg_’d
 << 
PAGE_CACHE_SHIFT
;

697 
	`Œunÿ‹_šode_·ges_¿nge
(
m­pšg
, 
blk_¡¬t
,

698 
blk_’d
 - 1);

700 
	`f2fs_lock_İ
(
sbi
);

701 
»t
 = 
	`Œunÿ‹_hŞe
(
šode
, 
pg_¡¬t
, 
pg_’d
);

702 
	`f2fs_uÆock_İ
(
sbi
);

706  
»t
;

707 
	}
}

709 
	$ex·nd_šode_d©a
(
šode
 *šode, 
loff_t
 
off£t
,

710 
loff_t
 
Ën
, 
mode
)

712 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

713 
pgoff_t
 
šdex
, 
pg_¡¬t
, 
pg_’d
;

714 
loff_t
 
Ãw_size
 = 
	`i_size_»ad
(
šode
);

715 
loff_t
 
off_¡¬t
, 
off_’d
;

716 
»t
 = 0;

718 
	`f2fs_b®ªû_fs
(
sbi
);

720 
»t
 = 
	`šode_Ãwsize_ok
(
šode
, (
Ën
 + 
off£t
));

721 ià(
»t
)

722  
»t
;

724 
»t
 = 
	`f2fs_cÚv”t_šlše_d©a
(
šode
, 
off£t
 + 
Ën
, 
NULL
);

725 ià(
»t
)

726  
»t
;

728 
pg_¡¬t
 = ((è
off£t
è>> 
PAGE_CACHE_SHIFT
;

729 
pg_’d
 = ((è
off£t
 + 
Ën
è>> 
PAGE_CACHE_SHIFT
;

731 
off_¡¬t
 = 
off£t
 & (
PAGE_CACHE_SIZE
 - 1);

732 
off_’d
 = (
off£t
 + 
Ën
è& (
PAGE_CACHE_SIZE
 - 1);

734 
	`f2fs_lock_İ
(
sbi
);

736 
šdex
 = 
pg_¡¬t
; index <ğ
pg_’d
; index++) {

737 
dnode_of_d©a
 
dn
;

739 ià(
šdex
 =ğ
pg_’d
 && !
off_’d
)

740 
nßÎoc
;

742 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

743 
»t
 = 
	`f2fs_»£rve_block
(&
dn
, 
šdex
);

744 ià(
»t
)

746 
nßÎoc
:

747 ià(
pg_¡¬t
 =ğ
pg_’d
)

748 
Ãw_size
 = 
off£t
 + 
Ën
;

749 ià(
šdex
 =ğ
pg_¡¬t
 && 
off_¡¬t
)

750 
Ãw_size
 = (
šdex
 + 1è<< 
PAGE_CACHE_SHIFT
;

751 ià(
šdex
 =ğ
pg_’d
)

752 
Ãw_size
 = (
šdex
 << 
PAGE_CACHE_SHIFT
è+ 
off_’d
;

754 
Ãw_size
 +ğ
PAGE_CACHE_SIZE
;

757 ià(!(
mode
 & 
FALLOC_FL_KEEP_SIZE
) &&

758 
	`i_size_»ad
(
šode
è< 
Ãw_size
) {

759 
	`i_size_wr™e
(
šode
, 
Ãw_size
);

760 
	`m¬k_šode_dœty
(
šode
);

761 
	`upd©e_šode_·ge
(
šode
);

763 
	`f2fs_uÆock_İ
(
sbi
);

765  
»t
;

766 
	}
}

768 
	$f2fs_çÎoÿ‹
(
fe
 *fe, 
mode
,

769 
loff_t
 
off£t
,†off_ˆ
Ën
)

771 
šode
 *šodğ
	`fe_šode
(
fe
);

772 
»t
;

774 ià(
mode
 & ~(
FALLOC_FL_KEEP_SIZE
 | 
FALLOC_FL_PUNCH_HOLE
))

775  -
EOPNOTSUPP
;

777 
	`mu‹x_lock
(&
šode
->
i_mu‹x
);

779 ià(
mode
 & 
FALLOC_FL_PUNCH_HOLE
)

780 
»t
 = 
	`punch_hŞe
(
šode
, 
off£t
, 
Ën
);

782 
»t
 = 
	`ex·nd_šode_d©a
(
šode
, 
off£t
, 
Ën
, 
mode
);

784 ià(!
»t
) {

785 
šode
->
i_mtime
 = inode->
i_ùime
 = 
CURRENT_TIME
;

786 
	`m¬k_šode_dœty
(
šode
);

789 
	`mu‹x_uÆock
(&
šode
->
i_mu‹x
);

791 
	`Œaû_f2fs_çÎoÿ‹
(
šode
, 
mode
, 
off£t
, 
Ën
, 
»t
);

792  
»t
;

793 
	}
}

795 
	#F2FS_REG_FLMASK
 (~(
FS_DIRSYNC_FL
 | 
FS_TOPDIR_FL
))

	)

796 
	#F2FS_OTHER_FLMASK
 (
FS_NODUMP_FL
 | 
FS_NOATIME_FL
)

	)

798 
šlše
 
__u32
 
	$f2fs_mask_æags
(
umode_t
 
mode
, 
__u32
 
æags
)

800 ià(
	`S_ISDIR
(
mode
))

801  
æags
;

802 ià(
	`S_ISREG
(
mode
))

803  
æags
 & 
F2FS_REG_FLMASK
;

805  
æags
 & 
F2FS_OTHER_FLMASK
;

806 
	}
}

808 
	$f2fs_ioc_g‘æags
(
fe
 *
fp
, 
¬g
)

810 
šode
 *šodğ
	`fe_šode
(
fp
);

811 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

812 
æags
 = 
fi
->
i_æags
 & 
FS_FL_USER_VISIBLE
;

813  
	`put_u£r
(
æags
, (
__u£r
 *)
¬g
);

814 
	}
}

816 
	$f2fs_ioc_£tæags
(
fe
 *
fp
, 
¬g
)

818 
šode
 *šodğ
	`fe_šode
(
fp
);

819 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

820 
æags
 = 
fi
->
i_æags
 & 
FS_FL_USER_VISIBLE
;

821 
Şdæags
;

822 
»t
;

824 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

825 ià(
»t
)

826  
»t
;

828 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
)) {

829 
»t
 = -
EACCES
;

830 
out
;

833 ià(
	`g‘_u£r
(
æags
, (
__u£r
 *)
¬g
)) {

834 
»t
 = -
EFAULT
;

835 
out
;

838 
æags
 = 
	`f2fs_mask_æags
(
šode
->
i_mode
, flags);

840 
	`mu‹x_lock
(&
šode
->
i_mu‹x
);

842 
Şdæags
 = 
fi
->
i_æags
;

844 ià((
æags
 ^ 
Şdæags
è& (
FS_APPEND_FL
 | 
FS_IMMUTABLE_FL
)) {

845 ià(!
	`ÿ·bË
(
CAP_LINUX_IMMUTABLE
)) {

846 
	`mu‹x_uÆock
(&
šode
->
i_mu‹x
);

847 
»t
 = -
EPERM
;

848 
out
;

852 
æags
 = fÏg & 
FS_FL_USER_MODIFIABLE
;

853 
æags
 |ğ
Şdæags
 & ~
FS_FL_USER_MODIFIABLE
;

854 
fi
->
i_æags
 = 
æags
;

855 
	`mu‹x_uÆock
(&
šode
->
i_mu‹x
);

857 
	`f2fs_£t_šode_æags
(
šode
);

858 
šode
->
i_ùime
 = 
CURRENT_TIME
;

859 
	`m¬k_šode_dœty
(
šode
);

860 
out
:

861 
	`mÁ_drİ_wr™e_fe
(
fp
);

862  
»t
;

863 
	}
}

865 
	$f2fs_ioc_¡¬t_©omic_wr™e
(
fe
 *
fp
)

867 
šode
 *šodğ
	`fe_šode
(
fp
);

868 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

870 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

871  -
EACCES
;

873 
	`f2fs_b®ªû_fs
(
sbi
);

875 
	`£t_šode_æag
(
	`F2FS_I
(
šode
), 
FI_ATOMIC_FILE
);

877  
	`f2fs_cÚv”t_šlše_d©a
(
šode
, 
MAX_INLINE_DATA
 + 1, 
NULL
);

878 
	}
}

880 
	$f2fs_ioc_comm™_©omic_wr™e
(
fe
 *
fp
)

882 
šode
 *šodğ
	`fe_šode
(
fp
);

883 
»t
;

885 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

886  -
EACCES
;

888 ià(
	`f2fs_is_vŞ©e_fe
(
šode
))

891 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

892 ià(
»t
)

893  
»t
;

895 ià(
	`f2fs_is_©omic_fe
(
šode
))

896 
	`comm™_šmem_·ges
(
šode
, 
çl£
);

898 
»t
 = 
	`f2fs_sync_fe
(
fp
, 0, 
LONG_MAX
, 0);

899 
	`mÁ_drİ_wr™e_fe
(
fp
);

900  
»t
;

901 
	}
}

903 
	$f2fs_ioc_¡¬t_vŞ©e_wr™e
(
fe
 *
fp
)

905 
šode
 *šodğ
	`fe_šode
(
fp
);

907 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

908  -
EACCES
;

910 
	`£t_šode_æag
(
	`F2FS_I
(
šode
), 
FI_VOLATILE_FILE
);

912 
	}
}

914 
	$f2fs_ioc_f™rim
(
fe
 *
fp
, 
¬g
)

916 
šode
 *šodğ
	`fe_šode
(
fp
);

917 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

918 
»que¡_queue
 *
q
 = 
	`bdev_g‘_queue
(
sb
->
s_bdev
);

919 
f¡rim_¿nge
 
¿nge
;

920 
»t
;

922 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

923  -
EPERM
;

925 ià(!
	`blk_queue_disÿrd
(
q
))

926  -
EOPNOTSUPP
;

928 ià(
	`cİy_äom_u£r
(&
¿nge
, (
f¡rim_¿nge
 
__u£r
 *)
¬g
,

929 (
¿nge
)))

930  -
EFAULT
;

932 
¿nge
.
mšËn
 = 
	`max
(()range.minlen,

933 
q
->
lim™s
.
disÿrd_g¿nuÏr™y
);

934 
»t
 = 
	`f2fs_Œim_fs
(
	`F2FS_SB
(
sb
), &
¿nge
);

935 ià(
»t
 < 0)

936  
»t
;

938 ià(
	`cİy_to_u£r
((
f¡rim_¿nge
 
__u£r
 *)
¬g
, &
¿nge
,

939 (
¿nge
)))

940  -
EFAULT
;

942 
	}
}

944 
	$f2fs_ioùl
(
fe
 *
fp
, 
cmd
, 
¬g
)

946 
cmd
) {

947 
F2FS_IOC_GETFLAGS
:

948  
	`f2fs_ioc_g‘æags
(
fp
, 
¬g
);

949 
F2FS_IOC_SETFLAGS
:

950  
	`f2fs_ioc_£tæags
(
fp
, 
¬g
);

951 
F2FS_IOC_START_ATOMIC_WRITE
:

952  
	`f2fs_ioc_¡¬t_©omic_wr™e
(
fp
);

953 
F2FS_IOC_COMMIT_ATOMIC_WRITE
:

954  
	`f2fs_ioc_comm™_©omic_wr™e
(
fp
);

955 
F2FS_IOC_START_VOLATILE_WRITE
:

956  
	`f2fs_ioc_¡¬t_vŞ©e_wr™e
(
fp
);

957 
FITRIM
:

958  
	`f2fs_ioc_f™rim
(
fp
, 
¬g
);

960  -
ENOTTY
;

962 
	}
}

964 #ifdeà
CONFIG_COMPAT


965 
	$f2fs_com·t_ioùl
(
fe
 *fe, 
cmd
, 
¬g
)

967 
cmd
) {

968 
F2FS_IOC32_GETFLAGS
:

969 
cmd
 = 
F2FS_IOC_GETFLAGS
;

971 
F2FS_IOC32_SETFLAGS
:

972 
cmd
 = 
F2FS_IOC_SETFLAGS
;

975  -
ENOIOCTLCMD
;

977  
	`f2fs_ioùl
(
fe
, 
cmd
, (è
	`com·t_±r
(
¬g
));

978 
	}
}

981 cÚ¡ 
fe_İ”©iÚs
 
	gf2fs_fe_İ”©iÚs
 = {

982 .
Î£ek
 = 
f2fs_Î£ek
,

983 .
	g»ad
 = 
Ãw_sync_»ad
,

984 .
	gwr™e
 = 
Ãw_sync_wr™e
,

985 .
	g»ad_™”
 = 
g’”ic_fe_»ad_™”
,

986 .
	gwr™e_™”
 = 
g’”ic_fe_wr™e_™”
,

987 .
	gİ’
 = 
g’”ic_fe_İ’
,

988 .
	gmm­
 = 
f2fs_fe_mm­
,

989 .
	gfsync
 = 
f2fs_sync_fe
,

990 .
	gçÎoÿ‹
 = 
f2fs_çÎoÿ‹
,

991 .
	guÆocked_ioùl
 = 
f2fs_ioùl
,

992 #ifdeà
CONFIG_COMPAT


993 .
	gcom·t_ioùl
 = 
f2fs_com·t_ioùl
,

995 .
	g¥liû_»ad
 = 
g’”ic_fe_¥liû_»ad
,

996 .
	g¥liû_wr™e
 = 
™”_fe_¥liû_wr™e
,

	@gc.c

11 
	~<lšux/fs.h
>

12 
	~<lšux/moduË.h
>

13 
	~<lšux/backšg-dev.h
>

14 
	~<lšux/š™.h
>

15 
	~<lšux/f2fs_fs.h
>

16 
	~<lšux/kth»ad.h
>

17 
	~<lšux/d–ay.h
>

18 
	~<lšux/ä“z”.h
>

19 
	~<lšux/blkdev.h
>

21 
	~"f2fs.h
"

22 
	~"node.h
"

23 
	~"£gm’t.h
"

24 
	~"gc.h
"

25 
	~<Œaû/ev’ts/f2fs.h
>

27 
kmem_ÿche
 *
	gwšode_¦ab
;

29 
	$gc_th»ad_func
(*
d©a
)

31 
f2fs_sb_šfo
 *
sbi
 = 
d©a
;

32 
f2fs_gc_kth»ad
 *
gc_th
 = 
sbi
->
gc_th»ad
;

33 
wa™_queue_h—d_t
 *
wq
 = &
sbi
->
gc_th»ad
->
gc_wa™_queue_h—d
;

34 
wa™_ms
;

36 
wa™_ms
 = 
gc_th
->
mš_¦“p_time
;

39 ià(
	`Œy_to_ä“ze
())

42 
	`wa™_ev’t_š‹¼u±ibË_timeout
(*
wq
,

43 
	`kth»ad_should_¡İ
(),

44 
	`m£cs_to_jiff›s
(
wa™_ms
));

45 ià(
	`kth»ad_should_¡İ
())

48 ià(
sbi
->
sb
->
s_wr™”s
.
äoz’
 >ğ
SB_FREEZE_WRITE
) {

49 
wa™_ms
 = 
	`šü—£_¦“p_time
(
gc_th
, wait_ms);

66 ià(!
	`mu‹x_Œylock
(&
sbi
->
gc_mu‹x
))

69 ià(!
	`is_idË
(
sbi
)) {

70 
wa™_ms
 = 
	`šü—£_¦“p_time
(
gc_th
, wait_ms);

71 
	`mu‹x_uÆock
(&
sbi
->
gc_mu‹x
);

75 ià(
	`has_’ough_šv®id_blocks
(
sbi
))

76 
wa™_ms
 = 
	`deü—£_¦“p_time
(
gc_th
, wait_ms);

78 
wa™_ms
 = 
	`šü—£_¦“p_time
(
gc_th
, wait_ms);

80 
	`¡©_šc_bggc_couÁ
(
sbi
);

83 ià(
	`f2fs_gc
(
sbi
))

84 
wa™_ms
 = 
gc_th
->
no_gc_¦“p_time
;

87 
	`f2fs_b®ªû_fs_bg
(
sbi
);

89 } !
	`kth»ad_should_¡İ
());

91 
	}
}

93 
	$¡¬t_gc_th»ad
(
f2fs_sb_šfo
 *
sbi
)

95 
f2fs_gc_kth»ad
 *
gc_th
;

96 
dev_t
 
dev
 = 
sbi
->
sb
->
s_bdev
->
bd_dev
;

97 
”r
 = 0;

99 ià(!
	`‹¡_İt
(
sbi
, 
BG_GC
))

100 
out
;

101 
gc_th
 = 
	`km®loc
((
f2fs_gc_kth»ad
), 
GFP_KERNEL
);

102 ià(!
gc_th
) {

103 
”r
 = -
ENOMEM
;

104 
out
;

107 
gc_th
->
mš_¦“p_time
 = 
DEF_GC_THREAD_MIN_SLEEP_TIME
;

108 
gc_th
->
max_¦“p_time
 = 
DEF_GC_THREAD_MAX_SLEEP_TIME
;

109 
gc_th
->
no_gc_¦“p_time
 = 
DEF_GC_THREAD_NOGC_SLEEP_TIME
;

111 
gc_th
->
gc_idË
 = 0;

113 
sbi
->
gc_th»ad
 = 
gc_th
;

114 
	`š™_wa™queue_h—d
(&
sbi
->
gc_th»ad
->
gc_wa™_queue_h—d
);

115 
sbi
->
gc_th»ad
->
f2fs_gc_sk
 = 
	`kth»ad_run
(
gc_th»ad_func
, sbi,

116 "f2fs_gc-%u:%u", 
	`MAJOR
(
dev
), 
	`MINOR
(dev));

117 ià(
	`IS_ERR
(
gc_th
->
f2fs_gc_sk
)) {

118 
”r
 = 
	`PTR_ERR
(
gc_th
->
f2fs_gc_sk
);

119 
	`kä“
(
gc_th
);

120 
sbi
->
gc_th»ad
 = 
NULL
;

122 
out
:

123  
”r
;

124 
	}
}

126 
	$¡İ_gc_th»ad
(
f2fs_sb_šfo
 *
sbi
)

128 
f2fs_gc_kth»ad
 *
gc_th
 = 
sbi
->
gc_th»ad
;

129 ià(!
gc_th
)

131 
	`kth»ad_¡İ
(
gc_th
->
f2fs_gc_sk
);

132 
	`kä“
(
gc_th
);

133 
sbi
->
gc_th»ad
 = 
NULL
;

134 
	}
}

136 
	$£Ëù_gc_ty³
(
f2fs_gc_kth»ad
 *
gc_th
, 
gc_ty³
)

138 
gc_mode
 = (
gc_ty³
 =ğ
BG_GC
è? 
GC_CB
 : 
GC_GREEDY
;

140 ià(
gc_th
 && gc_th->
gc_idË
) {

141 ià(
gc_th
->
gc_idË
 == 1)

142 
gc_mode
 = 
GC_CB
;

143 ià(
gc_th
->
gc_idË
 == 2)

144 
gc_mode
 = 
GC_GREEDY
;

146  
gc_mode
;

147 
	}
}

149 
	$£Ëù_pŞicy
(
f2fs_sb_šfo
 *
sbi
, 
gc_ty³
,

150 
ty³
, 
viùim_£l_pŞicy
 *
p
)

152 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

154 ià(
p
->
®loc_mode
 =ğ
SSR
) {

155 
p
->
gc_mode
 = 
GC_GREEDY
;

156 
p
->
dœty_£gm­
 = 
dœty_i
->dœty_£gm­[
ty³
];

157 
p
->
max_£¬ch
 = 
dœty_i
->
Ä_dœty
[
ty³
];

158 
p
->
ofs_un™
 = 1;

160 
p
->
gc_mode
 = 
	`£Ëù_gc_ty³
(
sbi
->
gc_th»ad
, 
gc_ty³
);

161 
p
->
dœty_£gm­
 = 
dœty_i
->dœty_£gm­[
DIRTY
];

162 
p
->
max_£¬ch
 = 
dœty_i
->
Ä_dœty
[
DIRTY
];

163 
p
->
ofs_un™
 = 
sbi
->
£gs_³r_£c
;

166 ià(
p
->
max_£¬ch
 > 
sbi
->
max_viùim_£¬ch
)

167 
p
->
max_£¬ch
 = 
sbi
->
max_viùim_£¬ch
;

169 
p
->
off£t
 = 
sbi
->
Ï¡_viùim
[p->
gc_mode
];

170 
	}
}

172 
	$g‘_max_co¡
(
f2fs_sb_šfo
 *
sbi
,

173 
viùim_£l_pŞicy
 *
p
)

176 ià(
p
->
®loc_mode
 =ğ
SSR
)

177  1 << 
sbi
->
log_blocks_³r_£g
;

178 ià(
p
->
gc_mode
 =ğ
GC_GREEDY
)

179  (1 << 
sbi
->
log_blocks_³r_£g
è* 
p
->
ofs_un™
;

180 ià(
p
->
gc_mode
 =ğ
GC_CB
)

181  
UINT_MAX
;

184 
	}
}

186 
	$check_bg_viùims
(
f2fs_sb_šfo
 *
sbi
)

188 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

189 
£úo
;

196 
	`fÜ_—ch_£t_b™
(
£úo
, 
dœty_i
->
viùim_£cm­
, 
	`MAIN_SECS
(
sbi
)) {

197 ià(
	`£c_u§ge_check
(
sbi
, 
£úo
))

199 
	`ş—r_b™
(
£úo
, 
dœty_i
->
viùim_£cm­
);

200  
£úo
 * 
sbi
->
£gs_³r_£c
;

202  
NULL_SEGNO
;

203 
	}
}

205 
	$g‘_cb_co¡
(
f2fs_sb_šfo
 *
sbi
, 
£gno
)

207 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

208 
£úo
 = 
	`GET_SECNO
(
sbi
, 
£gno
);

209 
¡¬t
 = 
£úo
 * 
sbi
->
£gs_³r_£c
;

210 
mtime
 = 0;

211 
vblocks
;

212 
age
 = 0;

213 
u
;

214 
i
;

216 
i
 = 0; i < 
sbi
->
£gs_³r_£c
; i++)

217 
mtime
 +ğ
	`g‘_£g_’Œy
(
sbi
, 
¡¬t
 + 
i
)->mtime;

218 
vblocks
 = 
	`g‘_v®id_blocks
(
sbi
, 
£gno
, sbi->
£gs_³r_£c
);

220 
mtime
 = 
	`div_u64
(mtime, 
sbi
->
£gs_³r_£c
);

221 
vblocks
 = 
	`div_u64
(vblocks, 
sbi
->
£gs_³r_£c
);

223 
u
 = (
vblocks
 * 100è>> 
sbi
->
log_blocks_³r_£g
;

226 ià(
mtime
 < 
s™_i
->
mš_mtime
)

227 
s™_i
->
mš_mtime
 = 
mtime
;

228 ià(
mtime
 > 
s™_i
->
max_mtime
)

229 
s™_i
->
max_mtime
 = 
mtime
;

230 ià(
s™_i
->
max_mtime
 !ğs™_i->
mš_mtime
)

231 
age
 = 100 - 
	`div64_u64
(100 * (
mtime
 - 
s™_i
->
mš_mtime
),

232 
s™_i
->
max_mtime
 - s™_i->
mš_mtime
);

234  
UINT_MAX
 - ((100 * (100 - 
u
è* 
age
) / (100 + u));

235 
	}
}

237 
šlše
 
	$g‘_gc_co¡
(
f2fs_sb_šfo
 *
sbi
,

238 
£gno
, 
viùim_£l_pŞicy
 *
p
)

240 ià(
p
->
®loc_mode
 =ğ
SSR
)

241  
	`g‘_£g_’Œy
(
sbi
, 
£gno
)->
ck±_v®id_blocks
;

244 ià(
p
->
gc_mode
 =ğ
GC_GREEDY
)

245  
	`g‘_v®id_blocks
(
sbi
, 
£gno
, sbi->
£gs_³r_£c
);

247  
	`g‘_cb_co¡
(
sbi
, 
£gno
);

248 
	}
}

258 
	$g‘_viùim_by_deçuÉ
(
f2fs_sb_šfo
 *
sbi
,

259 *
»suÉ
, 
gc_ty³
, 
ty³
, 
®loc_mode
)

261 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

262 
viùim_£l_pŞicy
 
p
;

263 
£úo
, 
max_co¡
;

264 
n£¬ched
 = 0;

266 
	`mu‹x_lock
(&
dœty_i
->
£gli¡_lock
);

268 
p
.
®loc_mode
 =‡lloc_mode;

269 
	`£Ëù_pŞicy
(
sbi
, 
gc_ty³
, 
ty³
, &
p
);

271 
p
.
mš_£gno
 = 
NULL_SEGNO
;

272 
p
.
mš_co¡
 = 
max_co¡
 = 
	`g‘_max_co¡
(
sbi
, &p);

274 ià(
p
.
®loc_mode
 =ğ
LFS
 && 
gc_ty³
 =ğ
FG_GC
) {

275 
p
.
mš_£gno
 = 
	`check_bg_viùims
(
sbi
);

276 ià(
p
.
mš_£gno
 !ğ
NULL_SEGNO
)

277 
gÙ_™
;

281 
co¡
;

282 
£gno
;

284 
£gno
 = 
	`fšd_Ãxt_b™
(
p
.
dœty_£gm­
, 
	`MAIN_SEGS
(
sbi
),….
off£t
);

285 ià(
£gno
 >ğ
	`MAIN_SEGS
(
sbi
)) {

286 ià(
sbi
->
Ï¡_viùim
[
p
.
gc_mode
]) {

287 
sbi
->
Ï¡_viùim
[
p
.
gc_mode
] = 0;

288 
p
.
off£t
 = 0;

294 
p
.
off£t
 = 
£gno
 +….
ofs_un™
;

295 ià(
p
.
ofs_un™
 > 1)

296 
p
.
off£t
 -ğ
£gno
 %….
ofs_un™
;

298 
£úo
 = 
	`GET_SECNO
(
sbi
, 
£gno
);

300 ià(
	`£c_u§ge_check
(
sbi
, 
£úo
))

302 ià(
gc_ty³
 =ğ
BG_GC
 && 
	`‹¡_b™
(
£úo
, 
dœty_i
->
viùim_£cm­
))

305 
co¡
 = 
	`g‘_gc_co¡
(
sbi
, 
£gno
, &
p
);

307 ià(
p
.
mš_co¡
 > 
co¡
) {

308 
p
.
mš_£gno
 = 
£gno
;

309 
p
.
mš_co¡
 = 
co¡
;

310 } ià(
	`uÆik–y
(
co¡
 =ğ
max_co¡
)) {

314 ià(
n£¬ched
++ >ğ
p
.
max_£¬ch
) {

315 
sbi
->
Ï¡_viùim
[
p
.
gc_mode
] = 
£gno
;

319 ià(
p
.
mš_£gno
 !ğ
NULL_SEGNO
) {

320 
gÙ_™
:

321 ià(
p
.
®loc_mode
 =ğ
LFS
) {

322 
£úo
 = 
	`GET_SECNO
(
sbi
, 
p
.
mš_£gno
);

323 ià(
gc_ty³
 =ğ
FG_GC
)

324 
sbi
->
cur_viùim_£c
 = 
£úo
;

326 
	`£t_b™
(
£úo
, 
dœty_i
->
viùim_£cm­
);

328 *
»suÉ
 = (
p
.
mš_£gno
 /….
ofs_un™
) *….ofs_unit;

330 
	`Œaû_f2fs_g‘_viùim
(
sbi
->
sb
, 
ty³
, 
gc_ty³
, &
p
,

331 
sbi
->
cur_viùim_£c
,

332 
	`´eä“_£gm’ts
(
sbi
), 
	`ä“_£gm’ts
(sbi));

334 
	`mu‹x_uÆock
(&
dœty_i
->
£gli¡_lock
);

336  (
p
.
mš_£gno
 =ğ
NULL_SEGNO
) ? 0 : 1;

337 
	}
}

339 cÚ¡ 
viùim_£ËùiÚ
 
	gdeçuÉ_v_İs
 = {

340 .
g‘_viùim
 = 
g‘_viùim_by_deçuÉ
,

343 
šode
 *
	$fšd_gc_šode
(
nid_t
 
šo
, 
li¡_h—d
 *
i¡
)

345 
šode_’Œy
 *
›
;

347 
	`li¡_fÜ_—ch_’Œy
(
›
, 
i¡
, 
li¡
)

348 ià(
›
->
šode
->
i_šo
 =ğ
šo
)

349  
›
->
šode
;

350  
NULL
;

351 
	}
}

353 
	$add_gc_šode
(
šode
 *šode, 
li¡_h—d
 *
i¡
)

355 
šode_’Œy
 *
Ãw_›
;

357 ià(
šode
 =ğ
	`fšd_gc_šode
(šode->
i_šo
, 
i¡
)) {

358 
	`ut
(
šode
);

362 
Ãw_›
 = 
	`f2fs_kmem_ÿche_®loc
(
wšode_¦ab
, 
GFP_NOFS
);

363 
Ãw_›
->
šode
 = inode;

364 
	`li¡_add_
(&
Ãw_›
->
li¡
, 
i¡
);

365 
	}
}

367 
	$put_gc_šode
(
li¡_h—d
 *
i¡
)

369 
šode_’Œy
 *
›
, *
Ãxt_›
;

370 
	`li¡_fÜ_—ch_’Œy_§ã
(
›
, 
Ãxt_›
, 
i¡
, 
li¡
) {

371 
	`ut
(
›
->
šode
);

372 
	`li¡_d–
(&
›
->
li¡
);

373 
	`kmem_ÿche_ä“
(
wšode_¦ab
, 
›
);

375 
	}
}

377 
	$check_v®id_m­
(
f2fs_sb_šfo
 *
sbi
,

378 
£gno
, 
off£t
)

380 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

381 
£g_’Œy
 *
£Áry
;

382 
»t
;

384 
	`mu‹x_lock
(&
s™_i
->
£Áry_lock
);

385 
£Áry
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

386 
»t
 = 
	`f2fs_‹¡_b™
(
off£t
, 
£Áry
->
cur_v®id_m­
);

387 
	`mu‹x_uÆock
(&
s™_i
->
£Áry_lock
);

388  
»t
;

389 
	}
}

396 
	$gc_node_£gm’t
(
f2fs_sb_šfo
 *
sbi
,

397 
f2fs_summ¬y
 *
sum
, 
£gno
, 
gc_ty³
)

399 
boŞ
 
š™Ÿl
 = 
Œue
;

400 
f2fs_summ¬y
 *
’Œy
;

401 
off
;

403 
Ãxt_¡•
:

404 
’Œy
 = 
sum
;

406 
off
 = 0; ofà< 
sbi
->
blocks_³r_£g
; off++, 
’Œy
++) {

407 
nid_t
 
nid
 = 
	`Ë32_to_ıu
(
’Œy
->nid);

408 
·ge
 *
node_·ge
;

411 ià(
gc_ty³
 =ğ
BG_GC
 && 
	`has_nÙ_’ough_ä“_£cs
(
sbi
, 0))

414 ià(
	`check_v®id_m­
(
sbi
, 
£gno
, 
off
) == 0)

417 ià(
š™Ÿl
) {

418 
	`¿_node_·ge
(
sbi
, 
nid
);

421 
node_·ge
 = 
	`g‘_node_·ge
(
sbi
, 
nid
);

422 ià(
	`IS_ERR
(
node_·ge
))

426 ià(
	`check_v®id_m­
(
sbi
, 
£gno
, 
off
) == 0) {

427 
	`f2fs_put_·ge
(
node_·ge
, 1);

432 ià(
gc_ty³
 =ğ
FG_GC
) {

433 
	`f2fs_wa™_Ú_·ge_wr™eback
(
node_·ge
, 
NODE
);

434 
	`£t_·ge_dœty
(
node_·ge
);

436 ià(!
	`PageWr™eback
(
node_·ge
))

437 
	`£t_·ge_dœty
(
node_·ge
);

439 
	`f2fs_put_·ge
(
node_·ge
, 1);

440 
	`¡©_šc_node_blk_couÁ
(
sbi
, 1);

443 ià(
š™Ÿl
) {

444 
š™Ÿl
 = 
çl£
;

445 
Ãxt_¡•
;

448 ià(
gc_ty³
 =ğ
FG_GC
) {

449 
wr™eback_cÚŒŞ
 
wbc
 = {

450 .
sync_mode
 = 
WB_SYNC_ALL
,

451 .
Ä_to_wr™e
 = 
LONG_MAX
,

452 .
fÜ_»şaim
 = 0,

454 
	`sync_node_·ges
(
sbi
, 0, &
wbc
);

460 ià(
	`g‘_v®id_blocks
(
sbi
, 
£gno
, 1) != 0)

461 
Ãxt_¡•
;

463 
	}
}

472 
block_t
 
	$¡¬t_bidx_of_node
(
node_ofs
, 
f2fs_šode_šfo
 *
fi
)

474 
šdœeù_blks
 = 2 * 
NIDS_PER_BLOCK
 + 4;

475 
bidx
;

477 ià(
node_ofs
 == 0)

480 ià(
node_ofs
 <= 2) {

481 
bidx
 = 
node_ofs
 - 1;

482 } ià(
node_ofs
 <ğ
šdœeù_blks
) {

483 
dec
 = (
node_ofs
 - 4è/ (
NIDS_PER_BLOCK
 + 1);

484 
bidx
 = 
node_ofs
 - 2 - 
dec
;

486 
dec
 = (
node_ofs
 - 
šdœeù_blks
 - 3è/ (
NIDS_PER_BLOCK
 + 1);

487 
bidx
 = 
node_ofs
 - 5 - 
dec
;

489  
bidx
 * 
ADDRS_PER_BLOCK
 + 
	`ADDRS_PER_INODE
(
fi
);

490 
	}
}

492 #ifdeà
F2FS_DA_MAP


493 
	$check_dnode
(
f2fs_sb_šfo
 *
sbi
, 
f2fs_summ¬y
 *
sum
,

494 
node_šfo
 *
dni
, 
block_t
 
blkaddr
, *
nofs
)

496 
	$check_dnode
(
f2fs_sb_šfo
 *
sbi
, 
f2fs_summ¬y
 *
sum
,

497 
node_šfo
 *
dni
, 
block_t
 
blkaddr
, *
nofs
)

500 
·ge
 *
node_·ge
;

501 
nid_t
 
nid
;

502 
ofs_š_node
;

503 
block_t
 
sourû_blkaddr
;

505 
nid
 = 
	`Ë32_to_ıu
(
sum
->nid);

506 
ofs_š_node
 = 
	`Ë16_to_ıu
(
sum
->ofs_in_node);

508 
node_·ge
 = 
	`g‘_node_·ge
(
sbi
, 
nid
);

509 ià(
	`IS_ERR
(
node_·ge
))

512 
	`g‘_node_šfo
(
sbi
, 
nid
, 
dni
);

514 ià(
sum
->
v”siÚ
 !ğ
dni
->version) {

515 
	`f2fs_put_·ge
(
node_·ge
, 1);

519 *
nofs
 = 
	`ofs_of_node
(
node_·ge
);

520 
sourû_blkaddr
 = 
	`d©ablock_addr
(
node_·ge
, 
ofs_š_node
);

521 
	`f2fs_put_·ge
(
node_·ge
, 1);

523 ià(
sourû_blkaddr
 !ğ
blkaddr
)

526 
	}
}

528 
	$move_d©a_·ge
(
šode
 *šode, 
·ge
 *·ge, 
gc_ty³
)

530 
f2fs_io_šfo
 
fio
 = {

531 .
ty³
 = 
DATA
,

532 .
rw
 = 
WRITE_SYNC
,

535 ià(
gc_ty³
 =ğ
BG_GC
) {

536 ià(
	`PageWr™eback
(
·ge
))

537 
out
;

538 
	`£t_·ge_dœty
(
·ge
);

539 
	`£t_cŞd_d©a
(
·ge
);

541 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
);

543 ià(
	`ş—r_·ge_dœty_fÜ_io
(
·ge
))

544 
	`šode_dec_dœty_·ges
(
šode
);

545 
	`£t_cŞd_d©a
(
·ge
);

546 
	`do_wr™e_d©a_·ge
(
·ge
, &
fio
);

547 
	`ş—r_cŞd_d©a
(
·ge
);

549 
out
:

550 
	`f2fs_put_·ge
(
·ge
, 1);

551 
	}
}

560 
	$gc_d©a_£gm’t
(
f2fs_sb_šfo
 *
sbi
, 
f2fs_summ¬y
 *
sum
,

561 
li¡_h—d
 *
i¡
, 
£gno
, 
gc_ty³
)

563 
su³r_block
 *
sb
 = 
sbi
->sb;

564 
f2fs_summ¬y
 *
’Œy
;

565 
block_t
 
¡¬t_addr
;

566 
off
;

567 
pha£
 = 0;

569 
¡¬t_addr
 = 
	`START_BLOCK
(
sbi
, 
£gno
);

571 
Ãxt_¡•
:

572 
’Œy
 = 
sum
;

574 
off
 = 0; ofà< 
sbi
->
blocks_³r_£g
; off++, 
’Œy
++) {

575 
·ge
 *
d©a_·ge
;

576 
šode
 *inode;

577 
node_šfo
 
dni
;

578 
ofs_š_node
, 
nofs
;

579 
block_t
 
¡¬t_bidx
;

582 ià(
gc_ty³
 =ğ
BG_GC
 && 
	`has_nÙ_’ough_ä“_£cs
(
sbi
, 0))

585 ià(
	`check_v®id_m­
(
sbi
, 
£gno
, 
off
) == 0)

588 ià(
pha£
 == 0) {

589 
	`¿_node_·ge
(
sbi
, 
	`Ë32_to_ıu
(
’Œy
->
nid
));

594 ià(
	`check_dnode
(
sbi
, 
’Œy
, &
dni
, 
¡¬t_addr
 + 
off
, &
nofs
) == 0)

597 ià(
pha£
 == 1) {

598 
	`¿_node_·ge
(
sbi
, 
dni
.
šo
);

602 
ofs_š_node
 = 
	`Ë16_to_ıu
(
’Œy
->ofs_in_node);

604 ià(
pha£
 == 2) {

605 
šode
 = 
	`f2fs_ig‘
(
sb
, 
dni
.
šo
);

606 ià(
	`IS_ERR
(
šode
è|| 
	`is_bad_šode
(inode))

609 
¡¬t_bidx
 = 
	`¡¬t_bidx_of_node
(
nofs
, 
	`F2FS_I
(
šode
));

611 
d©a_·ge
 = 
	`fšd_d©a_·ge
(
šode
,

612 
¡¬t_bidx
 + 
ofs_š_node
, 
çl£
);

613 ià(
	`IS_ERR
(
d©a_·ge
))

614 
Ãxt_ut
;

616 
	`f2fs_put_·ge
(
d©a_·ge
, 0);

617 
	`add_gc_šode
(
šode
, 
i¡
);

619 
šode
 = 
	`fšd_gc_šode
(
dni
.
šo
, 
i¡
);

620 ià(
šode
) {

621 
¡¬t_bidx
 = 
	`¡¬t_bidx_of_node
(
nofs
,

622 
	`F2FS_I
(
šode
));

623 
d©a_·ge
 = 
	`g‘_lock_d©a_·ge
(
šode
,

624 
¡¬t_bidx
 + 
ofs_š_node
);

625 ià(
	`IS_ERR
(
d©a_·ge
))

627 
	`move_d©a_·ge
(
šode
, 
d©a_·ge
, 
gc_ty³
);

628 
	`¡©_šc_d©a_blk_couÁ
(
sbi
, 1);

632 
Ãxt_ut
:

633 
	`ut
(
šode
);

636 ià(++
pha£
 < 4)

637 
Ãxt_¡•
;

639 ià(
gc_ty³
 =ğ
FG_GC
) {

640 
	`f2fs_subm™_m”ged_bio
(
sbi
, 
DATA
, 
WRITE
);

646 ià(
	`g‘_v®id_blocks
(
sbi
, 
£gno
, 1) != 0) {

647 
pha£
 = 2;

648 
Ãxt_¡•
;

651 
	}
}

653 
	$__g‘_viùim
(
f2fs_sb_šfo
 *
sbi
, *
viùim
,

654 
gc_ty³
, 
ty³
)

656 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

657 
»t
;

658 
	`mu‹x_lock
(&
s™_i
->
£Áry_lock
);

659 
»t
 = 
	`DIRTY_I
(
sbi
)->
v_İs
->
	`g‘_viùim
(sbi, 
viùim
, 
gc_ty³
, 
ty³
, 
LFS
);

660 
	`mu‹x_uÆock
(&
s™_i
->
£Áry_lock
);

661  
»t
;

662 
	}
}

664 
	$do_g¬bage_cŞËù
(
f2fs_sb_šfo
 *
sbi
, 
£gno
,

665 
li¡_h—d
 *
i¡
, 
gc_ty³
)

667 
·ge
 *
sum_·ge
;

668 
f2fs_summ¬y_block
 *
sum
;

669 
blk_¶ug
 
¶ug
;

672 
sum_·ge
 = 
	`g‘_sum_·ge
(
sbi
, 
£gno
);

674 
	`blk_¡¬t_¶ug
(&
¶ug
);

676 #ifdeà
F2FS_GET_FS_WAF


677 
gc_v®id_blocks_tÙ®
 +ğ
	`g‘_v®id_blocks
(
sbi
, 
£gno
, 1);

680 
sum
 = 
	`·ge_add»ss
(
sum_·ge
);

682 
	`GET_SUM_TYPE
((&
sum
->
foÙ”
))) {

683 
SUM_TYPE_NODE
:

684 #ifdeà
F2FS_GET_FS_WAF


685 
gc_v®id_blocks_node
 +ğ
	`g‘_v®id_blocks
(
sbi
, 
£gno
, 1);

687 
	`gc_node_£gm’t
(
sbi
, 
sum
->
’Œ›s
, 
£gno
, 
gc_ty³
);

689 
SUM_TYPE_DATA
:

690 #ifdeà
F2FS_GET_FS_WAF


691 
gc_v®id_blocks_d©a
 +ğ
	`g‘_v®id_blocks
(
sbi
, 
£gno
, 1);

693 
	`gc_d©a_£gm’t
(
sbi
, 
sum
->
’Œ›s
, 
i¡
, 
£gno
, 
gc_ty³
);

697 
	`blk_fšish_¶ug
(&
¶ug
);

699 
	`¡©_šc_£g_couÁ
(
sbi
, 
	`GET_SUM_TYPE
((&
sum
->
foÙ”
)));

700 
	`¡©_šc_ÿÎ_couÁ
(
sbi
->
¡©_šfo
);

702 
	`f2fs_put_·ge
(
sum_·ge
, 1);

703 
	}
}

705 
	$f2fs_gc
(
f2fs_sb_šfo
 *
sbi
)

707 
li¡_h—d
 
i¡
;

708 
£gno
, 
i
;

709 
gc_ty³
 = 
BG_GC
;

710 
nä“
 = 0;

711 
»t
 = -1;

712 
ı_cÚŒŞ
 
ıc
 = {

713 .
»asÚ
 = 
CP_SYNC
,

716 
	`INIT_LIST_HEAD
(&
i¡
);

717 
gc_mÜe
:

718 ià(
	`uÆik–y
(!(
sbi
->
sb
->
s_æags
 & 
MS_ACTIVE
)))

719 
¡İ
;

720 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

721 
¡İ
;

723 ià(
gc_ty³
 =ğ
BG_GC
 && 
	`has_nÙ_’ough_ä“_£cs
(
sbi
, 
nä“
)) {

724 
gc_ty³
 = 
FG_GC
;

725 
	`wr™e_checkpošt
(
sbi
, &
ıc
);

728 ià(!
	`__g‘_viùim
(
sbi
, &
£gno
, 
gc_ty³
, 
NO_CHECK_TYPE
))

729 
¡İ
;

730 
»t
 = 0;

733 ià(
sbi
->
£gs_³r_£c
 > 1)

734 
	`¿_m‘a_·ges
(
sbi
, 
	`GET_SUM_BLOCK
(sbi, 
£gno
), sbi->
£gs_³r_£c
,

735 
META_SSA
);

737 
i
 = 0; i < 
sbi
->
£gs_³r_£c
; i++)

738 
	`do_g¬bage_cŞËù
(
sbi
, 
£gno
 + 
i
, &
i¡
, 
gc_ty³
);

740 ià(
gc_ty³
 =ğ
FG_GC
) {

741 
sbi
->
cur_viùim_£c
 = 
NULL_SEGNO
;

742 
nä“
++;

743 
	`WARN_ON
(
	`g‘_v®id_blocks
(
sbi
, 
£gno
, sbi->
£gs_³r_£c
));

746 ià(
	`has_nÙ_’ough_ä“_£cs
(
sbi
, 
nä“
))

747 
gc_mÜe
;

749 ià(
gc_ty³
 =ğ
FG_GC
)

750 
	`wr™e_checkpošt
(
sbi
, &
ıc
);

751 
¡İ
:

752 
	`mu‹x_uÆock
(&
sbi
->
gc_mu‹x
);

754 
	`put_gc_šode
(&
i¡
);

755  
»t
;

756 
	}
}

758 
	$bud_gc_mªag”
(
f2fs_sb_šfo
 *
sbi
)

760 
	`DIRTY_I
(
sbi
)->
v_İs
 = &
deçuÉ_v_İs
;

761 
	}
}

763 
__š™
 
	$ü—‹_gc_ÿches
()

765 
wšode_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("f2fs_gc_inodes",

766 (
šode_’Œy
));

767 ià(!
wšode_¦ab
)

768  -
ENOMEM
;

770 
	}
}

772 
	$de¡roy_gc_ÿches
()

774 
	`kmem_ÿche_de¡roy
(
wšode_¦ab
);

775 
	}
}

	@gc.h

11 
	#GC_THREAD_MIN_WB_PAGES
 1

	)

16 
	#DEF_GC_THREAD_MIN_SLEEP_TIME
 30000

	)

17 
	#DEF_GC_THREAD_MAX_SLEEP_TIME
 60000

	)

18 
	#DEF_GC_THREAD_NOGC_SLEEP_TIME
 300000

	)

19 
	#LIMIT_INVALID_BLOCK
 40

	)

20 
	#LIMIT_FREE_BLOCK
 40

	)

23 
	#DEF_MAX_VICTIM_SEARCH
 4096

	)

25 
	sf2fs_gc_kth»ad
 {

26 
sk_¡ruù
 *
	mf2fs_gc_sk
;

27 
wa™_queue_h—d_t
 
	mgc_wa™_queue_h—d
;

30 
	mmš_¦“p_time
;

31 
	mmax_¦“p_time
;

32 
	mno_gc_¦“p_time
;

35 
	mgc_idË
;

38 
	sšode_’Œy
 {

39 
li¡_h—d
 
	mli¡
;

40 
šode
 *
	mšode
;

46 
šlše
 
block_t
 
	$ä“_u£r_blocks
(
f2fs_sb_šfo
 *
sbi
)

48 ià(
	`ä“_£gm’ts
(
sbi
è< 
	`ov”´ovisiÚ_£gm’ts
(sbi))

51  (
	`ä“_£gm’ts
(
sbi
è- 
	`ov”´ovisiÚ_£gm’ts
(sbi))

52 << 
sbi
->
log_blocks_³r_£g
;

53 
	}
}

55 
šlše
 
block_t
 
	$lim™_šv®id_u£r_blocks
(
f2fs_sb_šfo
 *
sbi
)

57  ()(
sbi
->
u£r_block_couÁ
 * 
LIMIT_INVALID_BLOCK
) / 100;

58 
	}
}

60 
šlše
 
block_t
 
	$lim™_ä“_u£r_blocks
(
f2fs_sb_šfo
 *
sbi
)

62 
block_t
 
»şaimabË_u£r_blocks
 = 
sbi
->
u£r_block_couÁ
 -

63 
	`wr™‹n_block_couÁ
(
sbi
);

64  ()(
»şaimabË_u£r_blocks
 * 
LIMIT_FREE_BLOCK
) / 100;

65 
	}
}

67 
šlše
 
	$šü—£_¦“p_time
(
f2fs_gc_kth»ad
 *
gc_th
, 
wa™
)

69 ià(
wa™
 =ğ
gc_th
->
no_gc_¦“p_time
)

70  
wa™
;

72 
wa™
 +ğ
gc_th
->
mš_¦“p_time
;

73 ià(
wa™
 > 
gc_th
->
max_¦“p_time
)

74 
wa™
 = 
gc_th
->
max_¦“p_time
;

75  
wa™
;

76 
	}
}

78 
šlše
 
	$deü—£_¦“p_time
(
f2fs_gc_kth»ad
 *
gc_th
, 
wa™
)

80 ià(
wa™
 =ğ
gc_th
->
no_gc_¦“p_time
)

81 
wa™
 = 
gc_th
->
max_¦“p_time
;

83 
wa™
 -ğ
gc_th
->
mš_¦“p_time
;

84 ià(
wa™
 <ğ
gc_th
->
mš_¦“p_time
)

85 
wa™
 = 
gc_th
->
mš_¦“p_time
;

86  
wa™
;

87 
	}
}

89 
šlše
 
boŞ
 
	$has_’ough_šv®id_blocks
(
f2fs_sb_šfo
 *
sbi
)

91 
block_t
 
šv®id_u£r_blocks
 = 
sbi
->
u£r_block_couÁ
 -

92 
	`wr™‹n_block_couÁ
(
sbi
);

98 ià(
šv®id_u£r_blocks
 > 
	`lim™_šv®id_u£r_blocks
(
sbi
) &&

99 
	`ä“_u£r_blocks
(
sbi
è< 
	`lim™_ä“_u£r_blocks
(sbi))

100  
Œue
;

101  
çl£
;

102 
	}
}

104 
šlše
 
	$is_idË
(
f2fs_sb_šfo
 *
sbi
)

106 
block_deviû
 *
bdev
 = 
sbi
->
sb
->
s_bdev
;

107 
»que¡_queue
 *
q
 = 
	`bdev_g‘_queue
(
bdev
);

108 
»que¡_li¡
 *
¾
 = &
q
->
roÙ_¾
;

109  !(
¾
->
couÁ
[
BLK_RW_SYNC
]è&& !Ôl->couÁ[
BLK_RW_ASYNC
]);

110 
	}
}

	@hash.c

15 
	~<lšux/ty³s.h
>

16 
	~<lšux/fs.h
>

17 
	~<lšux/f2fs_fs.h
>

18 
	~<lšux/üy±ohash.h
>

19 
	~<lšux/·gem­.h
>

21 
	~"f2fs.h
"

26 
	#DELTA
 0x9E3779B9

	)

28 
	$TEA_ŒªsfÜm
(
buf
[4], cÚ¡ 
š
[])

30 
__u32
 
sum
 = 0;

31 
__u32
 
b0
 = 
buf
[0], 
b1
 = buf[1];

32 
__u32
 
a
 = 
š
[0], 
b
 = in[1], 
c
 = in[2], 
d
 = in[3];

33 
n
 = 16;

36 
sum
 +ğ
DELTA
;

37 
b0
 +ğ((
b1
 << 4)+
a
è^ (b1+
sum
è^ ((b1 >> 5)+
b
);

38 
b1
 +ğ((
b0
 << 4)+
c
è^ (b0+
sum
è^ ((b0 >> 5)+
d
);

39 } --
n
);

41 
buf
[0] +ğ
b0
;

42 
buf
[1] +ğ
b1
;

43 
	}
}

45 
	$¡r2hashbuf
(cÚ¡ *
msg
, 
size_t
 
Ën
,

46 *
buf
, 
num
)

48 
·d
, 
v®
;

49 
i
;

51 
·d
 = (
__u32
)
Ën
 | ((__u32)len << 8);

52 
·d
 |=…ad << 16;

54 
v®
 = 
·d
;

55 ià(
Ën
 > 
num
 * 4)

56 
Ën
 = 
num
 * 4;

57 
i
 = 0; i < 
Ën
; i++) {

58 ià((
i
 % 4) == 0)

59 
v®
 = 
·d
;

60 
v®
 = 
msg
[
i
] + (val << 8);

61 ià((
i
 % 4) == 3) {

62 *
buf
++ = 
v®
;

63 
v®
 = 
·d
;

64 
num
--;

67 ià(--
num
 >= 0)

68 *
buf
++ = 
v®
;

69 --
num
 >= 0)

70 *
buf
++ = 
·d
;

71 
	}
}

73 
f2fs_hash_t
 
	$f2fs_d’Œy_hash
(cÚ¡ 
q¡r
 *
Çme_šfo
)

75 
__u32
 
hash
;

76 
f2fs_hash_t
 
f2fs_hash
;

77 cÚ¡ *
p
;

78 
__u32
 
š
[8], 
buf
[4];

79 cÚ¡ *
Çme
 = 
Çme_šfo
->name;

80 
size_t
 
Ën
 = 
Çme_šfo
->len;

82 ià((
Ën
 <ğ2è&& (
Çme
[0] == '.') &&

83 (
Çme
[1] == '.' ||‚ame[1] == '\0'))

87 
buf
[0] = 0x67452301;

88 
buf
[1] = 0xefcdab89;

89 
buf
[2] = 0x98badcfe;

90 
buf
[3] = 0x10325476;

92 
p
 = 
Çme
;

94 
	`¡r2hashbuf
(
p
, 
Ën
, 
š
, 4);

95 
	`TEA_ŒªsfÜm
(
buf
, 
š
);

96 
p
 += 16;

97 ià(
Ën
 <= 16)

99 
Ën
 -= 16;

101 
hash
 = 
buf
[0];

102 
f2fs_hash
 = 
	`ıu_to_Ë32
(
hash
 & ~
F2FS_HASH_COL_BIT
);

103  
f2fs_hash
;

104 
	}
}

	@inline.c

11 
	~<lšux/fs.h
>

12 
	~<lšux/f2fs_fs.h
>

14 
	~"f2fs.h
"

16 
boŞ
 
	$f2fs_may_šlše
(
šode
 *inode)

18 
block_t
 
Ä_blocks
;

19 
loff_t
 
i_size
;

21 ià(!
	`‹¡_İt
(
	`F2FS_I_SB
(
šode
), 
INLINE_DATA
))

22  
çl£
;

24 ià(
	`f2fs_is_©omic_fe
(
šode
))

25  
çl£
;

27 
Ä_blocks
 = 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
 ? 3 : 2;

28 ià(
šode
->
i_blocks
 > 
Ä_blocks
)

29  
çl£
;

31 
i_size
 = 
	`i_size_»ad
(
šode
);

32 ià(
i_size
 > 
MAX_INLINE_DATA
)

33  
çl£
;

35  
Œue
;

36 
	}
}

38 
	$f2fs_»ad_šlše_d©a
(
šode
 *šode, 
·ge
 *page)

40 
·ge
 *
age
;

41 *
¤c_addr
, *
d¡_addr
;

43 ià(
·ge
->
šdex
) {

44 
	`z”o_u£r_£gm’t
(
·ge
, 0, 
PAGE_CACHE_SIZE
);

45 
out
;

48 
age
 = 
	`g‘_node_·ge
(
	`F2FS_I_SB
(
šode
), inode->
i_šo
);

49 ià(
	`IS_ERR
(
age
)) {

50 
	`uÆock_·ge
(
·ge
);

51  
	`PTR_ERR
(
age
);

54 
	`z”o_u£r_£gm’t
(
·ge
, 
MAX_INLINE_DATA
, 
PAGE_CACHE_SIZE
);

57 
¤c_addr
 = 
	`šlše_d©a_addr
(
age
);

58 
d¡_addr
 = 
	`km­
(
·ge
);

59 
	`memıy
(
d¡_addr
, 
¤c_addr
, 
MAX_INLINE_DATA
);

60 
	`kunm­
(
·ge
);

61 
	`f2fs_put_·ge
(
age
, 1);

63 
out
:

64 
	`S‘PageU±od©e
(
·ge
);

65 
	`uÆock_·ge
(
·ge
);

68 
	}
}

70 
	$__f2fs_cÚv”t_šlše_d©a
(
šode
 *šode, 
·ge
 *page)

72 
”r
 = 0;

73 
·ge
 *
age
;

74 
dnode_of_d©a
 
dn
;

75 *
¤c_addr
, *
d¡_addr
;

76 
block_t
 
Ãw_blk_addr
;

77 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

78 
f2fs_io_šfo
 
fio
 = {

79 .
ty³
 = 
DATA
,

80 .
rw
 = 
WRITE_SYNC
 | 
REQ_PRIO
,

83 
	`f2fs_lock_İ
(
sbi
);

84 
age
 = 
	`g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

85 ià(
	`IS_ERR
(
age
)) {

86 
”r
 = 
	`PTR_ERR
(
age
);

87 
out
;

91 ià(!
	`f2fs_has_šlše_d©a
(
šode
))

92 
out
;

98 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
age
, 
NULL
, 0);

99 
”r
 = 
	`f2fs_»£rve_block
(&
dn
, 0);

100 ià(
”r
)

101 
out
;

103 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
);

104 
	`z”o_u£r_£gm’t
(
·ge
, 
MAX_INLINE_DATA
, 
PAGE_CACHE_SIZE
);

107 
¤c_addr
 = 
	`šlše_d©a_addr
(
age
);

108 
d¡_addr
 = 
	`km­
(
·ge
);

109 
	`memıy
(
d¡_addr
, 
¤c_addr
, 
MAX_INLINE_DATA
);

110 
	`kunm­
(
·ge
);

111 
	`S‘PageU±od©e
(
·ge
);

114 
	`£t_·ge_wr™eback
(
·ge
);

115 
	`wr™e_d©a_·ge
(
·ge
, &
dn
, &
Ãw_blk_addr
, &
fio
);

116 
	`upd©e_ex‹Á_ÿche
(
Ãw_blk_addr
, &
dn
);

117 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
DATA
);

120 
	`z”o_u£r_£gm’t
(
age
, 
INLINE_DATA_OFFSET
,

121 
INLINE_DATA_OFFSET
 + 
MAX_INLINE_DATA
);

122 
	`ş—r_šode_æag
(
	`F2FS_I
(
šode
), 
FI_INLINE_DATA
);

123 
	`¡©_dec_šlše_šode
(
šode
);

125 
	`sync_šode_·ge
(&
dn
);

126 
	`f2fs_put_dnode
(&
dn
);

127 
out
:

128 
	`f2fs_uÆock_İ
(
sbi
);

129  
”r
;

130 
	}
}

132 
	$f2fs_cÚv”t_šlše_d©a
(
šode
 *šode, 
pgoff_t
 
to_size
,

133 
·ge
 *page)

135 
·ge
 *
Ãw_·ge
 =…age;

136 
”r
;

138 ià(!
	`f2fs_has_šlše_d©a
(
šode
))

140 ià(
to_size
 <ğ
MAX_INLINE_DATA
)

143 ià(!
·ge
 ||…age->
šdex
 != 0) {

144 
Ãw_·ge
 = 
	`g¿b_ÿche_·ge
(
šode
->
i_m­pšg
, 0);

145 ià(!
Ãw_·ge
)

146  -
ENOMEM
;

149 
”r
 = 
	`__f2fs_cÚv”t_šlše_d©a
(
šode
, 
Ãw_·ge
);

150 ià(!
·ge
 ||…age->
šdex
 != 0)

151 
	`f2fs_put_·ge
(
Ãw_·ge
, 1);

152  
”r
;

153 
	}
}

155 
	$f2fs_wr™e_šlše_d©a
(
šode
 *inode,

156 
·ge
 *·ge, 
size
)

158 *
¤c_addr
, *
d¡_addr
;

159 
·ge
 *
age
;

160 
dnode_of_d©a
 
dn
;

161 
”r
;

163 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

164 
”r
 = 
	`g‘_dnode_of_d©a
(&
dn
, 0, 
LOOKUP_NODE
);

165 ià(
”r
)

166  
”r
;

167 
age
 = 
dn
.
šode_·ge
;

169 
	`f2fs_wa™_Ú_·ge_wr™eback
(
age
, 
NODE
);

170 
	`z”o_u£r_£gm’t
(
age
, 
INLINE_DATA_OFFSET
,

171 
INLINE_DATA_OFFSET
 + 
MAX_INLINE_DATA
);

172 
¤c_addr
 = 
	`km­
(
·ge
);

173 
d¡_addr
 = 
	`šlše_d©a_addr
(
age
);

174 
	`memıy
(
d¡_addr
, 
¤c_addr
, 
size
);

175 
	`kunm­
(
·ge
);

178 ià(!
	`f2fs_has_šlše_d©a
(
šode
)) {

179 
	`Œunÿ‹_d©a_blocks_¿nge
(&
dn
, 1);

180 
	`£t_šode_æag
(
	`F2FS_I
(
šode
), 
FI_INLINE_DATA
);

181 
	`¡©_šc_šlše_šode
(
šode
);

184 
	`£t_šode_æag
(
	`F2FS_I
(
šode
), 
FI_APPEND_WRITE
);

185 
	`sync_šode_·ge
(&
dn
);

186 
	`f2fs_put_dnode
(&
dn
);

189 
	}
}

191 
	$Œunÿ‹_šlše_d©a
(
šode
 *šode, 
u64
 
äom
)

193 
·ge
 *
age
;

195 ià(
äom
 >ğ
MAX_INLINE_DATA
)

198 
age
 = 
	`g‘_node_·ge
(
	`F2FS_I_SB
(
šode
), inode->
i_šo
);

199 ià(
	`IS_ERR
(
age
))

202 
	`f2fs_wa™_Ú_·ge_wr™eback
(
age
, 
NODE
);

204 
	`z”o_u£r_£gm’t
(
age
, 
INLINE_DATA_OFFSET
 + 
äom
,

205 
INLINE_DATA_OFFSET
 + 
MAX_INLINE_DATA
);

206 
	`£t_·ge_dœty
(
age
);

207 
	`f2fs_put_·ge
(
age
, 1);

208 
	}
}

210 
boŞ
 
	$»cov”_šlše_d©a
(
šode
 *šode, 
·ge
 *
Åage
)

212 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

213 
f2fs_šode
 *
ri
 = 
NULL
;

214 *
¤c_addr
, *
d¡_addr
;

215 
·ge
 *
age
;

225 ià(
	`IS_INODE
(
Åage
))

226 
ri
 = 
	`F2FS_INODE
(
Åage
);

228 ià(
	`f2fs_has_šlše_d©a
(
šode
) &&

229 
ri
 && (ri->
i_šlše
 & 
F2FS_INLINE_DATA
)) {

230 
´oûss_šlše
:

231 
age
 = 
	`g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

232 
	`f2fs_bug_Ú
(
sbi
, 
	`IS_ERR
(
age
));

234 
	`f2fs_wa™_Ú_·ge_wr™eback
(
age
, 
NODE
);

236 
¤c_addr
 = 
	`šlše_d©a_addr
(
Åage
);

237 
d¡_addr
 = 
	`šlše_d©a_addr
(
age
);

238 
	`memıy
(
d¡_addr
, 
¤c_addr
, 
MAX_INLINE_DATA
);

239 
	`upd©e_šode
(
šode
, 
age
);

240 
	`f2fs_put_·ge
(
age
, 1);

241  
Œue
;

244 ià(
	`f2fs_has_šlše_d©a
(
šode
)) {

245 
age
 = 
	`g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

246 
	`f2fs_bug_Ú
(
sbi
, 
	`IS_ERR
(
age
));

247 
	`f2fs_wa™_Ú_·ge_wr™eback
(
age
, 
NODE
);

248 
	`z”o_u£r_£gm’t
(
age
, 
INLINE_DATA_OFFSET
,

249 
INLINE_DATA_OFFSET
 + 
MAX_INLINE_DATA
);

250 
	`ş—r_šode_æag
(
	`F2FS_I
(
šode
), 
FI_INLINE_DATA
);

251 
	`upd©e_šode
(
šode
, 
age
);

252 
	`f2fs_put_·ge
(
age
, 1);

253 } ià(
ri
 && (ri->
i_šlše
 & 
F2FS_INLINE_DATA
)) {

254 
	`Œunÿ‹_blocks
(
šode
, 0, 
çl£
);

255 
	`£t_šode_æag
(
	`F2FS_I
(
šode
), 
FI_INLINE_DATA
);

256 
´oûss_šlše
;

258  
çl£
;

259 
	}
}

	@inode.c

11 
	~<lšux/fs.h
>

12 
	~<lšux/f2fs_fs.h
>

13 
	~<lšux/bufãr_h—d.h
>

14 
	~<lšux/wr™eback.h
>

15 
	~<lšux/b™İs.h
>

17 
	~"f2fs.h
"

18 
	~"node.h
"

20 
	~<Œaû/ev’ts/f2fs.h
>

22 
	$f2fs_£t_šode_æags
(
šode
 *inode)

24 
æags
 = 
	`F2FS_I
(
šode
)->
i_æags
;

25 
Ãw_æ
 = 0;

27 ià(
æags
 & 
FS_SYNC_FL
)

28 
Ãw_æ
 |ğ
S_SYNC
;

29 ià(
æags
 & 
FS_APPEND_FL
)

30 
Ãw_æ
 |ğ
S_APPEND
;

31 ià(
æags
 & 
FS_IMMUTABLE_FL
)

32 
Ãw_æ
 |ğ
S_IMMUTABLE
;

33 ià(
æags
 & 
FS_NOATIME_FL
)

34 
Ãw_æ
 |ğ
S_NOATIME
;

35 ià(
æags
 & 
FS_DIRSYNC_FL
)

36 
Ãw_æ
 |ğ
S_DIRSYNC
;

37 
	`£t_mask_b™s
(&
šode
->
i_æags
,

38 
S_SYNC
|
S_APPEND
|
S_IMMUTABLE
|
S_NOATIME
|
S_DIRSYNC
, 
Ãw_æ
);

39 
	}
}

41 
	$__g‘_šode_rdev
(
šode
 *šode, 
f2fs_šode
 *
ri
)

43 ià(
	`S_ISCHR
(
šode
->
i_mode
è|| 
	`S_ISBLK
(inode->i_mode) ||

44 
	`S_ISFIFO
(
šode
->
i_mode
è|| 
	`S_ISSOCK
(inode->i_mode)) {

45 ià(
ri
->
i_addr
[0])

46 
šode
->
i_rdev
 =

47 
	`Şd_decode_dev
(
	`Ë32_to_ıu
(
ri
->
i_addr
[0]));

49 
šode
->
i_rdev
 =

50 
	`Ãw_decode_dev
(
	`Ë32_to_ıu
(
ri
->
i_addr
[1]));

52 
	}
}

54 
	$__£t_šode_rdev
(
šode
 *šode, 
f2fs_šode
 *
ri
)

56 ià(
	`S_ISCHR
(
šode
->
i_mode
è|| 
	`S_ISBLK
(inode->i_mode)) {

57 ià(
	`Şd_v®id_dev
(
šode
->
i_rdev
)) {

58 
ri
->
i_addr
[0] =

59 
	`ıu_to_Ë32
(
	`Şd_’code_dev
(
šode
->
i_rdev
));

60 
ri
->
i_addr
[1] = 0;

62 
ri
->
i_addr
[0] = 0;

63 
ri
->
i_addr
[1] =

64 
	`ıu_to_Ë32
(
	`Ãw_’code_dev
(
šode
->
i_rdev
));

65 
ri
->
i_addr
[2] = 0;

68 
	}
}

70 
	$do_»ad_šode
(
šode
 *inode)

72 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

73 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

74 
·ge
 *
node_·ge
;

75 
f2fs_šode
 *
ri
;

78 ià(
	`check_nid_¿nge
(
sbi
, 
šode
->
i_šo
)) {

79 
	`f2fs_msg
(
šode
->
i_sb
, 
KERN_ERR
, "bad inode‚umber: %lu",

80 (è
šode
->
i_šo
);

81 
	`WARN_ON
(1);

82  -
EINVAL
;

85 
node_·ge
 = 
	`g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

86 ià(
	`IS_ERR
(
node_·ge
))

87  
	`PTR_ERR
(
node_·ge
);

89 
ri
 = 
	`F2FS_INODE
(
node_·ge
);

91 
šode
->
i_mode
 = 
	`Ë16_to_ıu
(
ri
->i_mode);

92 
	`i_uid_wr™e
(
šode
, 
	`Ë32_to_ıu
(
ri
->
i_uid
));

93 
	`i_gid_wr™e
(
šode
, 
	`Ë32_to_ıu
(
ri
->
i_gid
));

94 
	`£t_Æšk
(
šode
, 
	`Ë32_to_ıu
(
ri
->
i_lšks
));

95 
šode
->
i_size
 = 
	`Ë64_to_ıu
(
ri
->i_size);

96 
šode
->
i_blocks
 = 
	`Ë64_to_ıu
(
ri
->i_blocks);

98 
šode
->
i_©ime
.
tv_£c
 = 
	`Ë64_to_ıu
(
ri
->i_atime);

99 
šode
->
i_ùime
.
tv_£c
 = 
	`Ë64_to_ıu
(
ri
->i_ctime);

100 
šode
->
i_mtime
.
tv_£c
 = 
	`Ë64_to_ıu
(
ri
->i_mtime);

101 
šode
->
i_©ime
.
tv_n£c
 = 
	`Ë32_to_ıu
(
ri
->
i_©ime_n£c
);

102 
šode
->
i_ùime
.
tv_n£c
 = 
	`Ë32_to_ıu
(
ri
->
i_ùime_n£c
);

103 
šode
->
i_mtime
.
tv_n£c
 = 
	`Ë32_to_ıu
(
ri
->
i_mtime_n£c
);

104 
šode
->
i_g’”©iÚ
 = 
	`Ë32_to_ıu
(
ri
->i_generation);

106 
fi
->
i_cu¼’t_d•th
 = 
	`Ë32_to_ıu
(
ri
->i_current_depth);

107 
fi
->
i_x©Œ_nid
 = 
	`Ë32_to_ıu
(
ri
->i_xattr_nid);

108 
fi
->
i_æags
 = 
	`Ë32_to_ıu
(
ri
->i_flags);

109 
fi
->
æags
 = 0;

110 
fi
->
i_advi£
 = 
ri
->i_advise;

111 
fi
->
i_pšo
 = 
	`Ë32_to_ıu
(
ri
->i_pino);

112 
fi
->
i_dœ_Ëv–
 = 
ri
->i_dir_level;

114 
	`g‘_ex‹Á_šfo
(&
fi
->
ext
, 
ri
->
i_ext
);

115 
	`g‘_šlše_šfo
(
fi
, 
ri
);

118 
	`__g‘_šode_rdev
(
šode
, 
ri
);

120 
	`f2fs_put_·ge
(
node_·ge
, 1);

122 
	}
}

124 
šode
 *
	$f2fs_ig‘
(
su³r_block
 *
sb
, 
šo
)

126 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

127 
šode
 *inode;

128 
»t
 = 0;

130 
šode
 = 
	`ig‘_locked
(
sb
, 
šo
);

131 ià(!
šode
)

132  
	`ERR_PTR
(-
ENOMEM
);

134 ià(!(
šode
->
i_¡©e
 & 
I_NEW
)) {

135 
	`Œaû_f2fs_ig‘
(
šode
);

136  
šode
;

138 ià(
šo
 =ğ
	`F2FS_NODE_INO
(
sbi
è|| inØ=ğ
	`F2FS_META_INO
(sbi))

139 
make_now
;

141 
»t
 = 
	`do_»ad_šode
(
šode
);

142 ià(
»t
)

143 
bad_šode
;

144 
make_now
:

145 ià(
šo
 =ğ
	`F2FS_NODE_INO
(
sbi
)) {

146 
šode
->
i_m­pšg
->
a_İs
 = &
f2fs_node_aİs
;

147 
	`m­pšg_£t_gå_mask
(
šode
->
i_m­pšg
, 
GFP_F2FS_ZERO
);

148 } ià(
šo
 =ğ
	`F2FS_META_INO
(
sbi
)) {

149 
šode
->
i_m­pšg
->
a_İs
 = &
f2fs_m‘a_aİs
;

150 
	`m­pšg_£t_gå_mask
(
šode
->
i_m­pšg
, 
GFP_F2FS_ZERO
);

151 } ià(
	`S_ISREG
(
šode
->
i_mode
)) {

152 
šode
->
i_İ
 = &
f2fs_fe_šode_İ”©iÚs
;

153 
šode
->
i_fİ
 = &
f2fs_fe_İ”©iÚs
;

154 
šode
->
i_m­pšg
->
a_İs
 = &
f2fs_dblock_aİs
;

155 } ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

156 
šode
->
i_İ
 = &
f2fs_dœ_šode_İ”©iÚs
;

157 
šode
->
i_fİ
 = &
f2fs_dœ_İ”©iÚs
;

158 
šode
->
i_m­pšg
->
a_İs
 = &
f2fs_dblock_aİs
;

159 
	`m­pšg_£t_gå_mask
(
šode
->
i_m­pšg
, 
GFP_F2FS_ZERO
);

160 } ià(
	`S_ISLNK
(
šode
->
i_mode
)) {

161 
šode
->
i_İ
 = &
f2fs_symlšk_šode_İ”©iÚs
;

162 
šode
->
i_m­pšg
->
a_İs
 = &
f2fs_dblock_aİs
;

163 } ià(
	`S_ISCHR
(
šode
->
i_mode
è|| 
	`S_ISBLK
(inode->i_mode) ||

164 
	`S_ISFIFO
(
šode
->
i_mode
è|| 
	`S_ISSOCK
(inode->i_mode)) {

165 
šode
->
i_İ
 = &
f2fs_¥ecŸl_šode_İ”©iÚs
;

166 
	`š™_¥ecŸl_šode
(
šode
, inode->
i_mode
, inode->
i_rdev
);

168 
»t
 = -
EIO
;

169 
bad_šode
;

171 
	`uÆock_Ãw_šode
(
šode
);

172 
	`Œaû_f2fs_ig‘
(
šode
);

173  
šode
;

175 
bad_šode
:

176 
	`ig‘_çed
(
šode
);

177 
	`Œaû_f2fs_ig‘_ex™
(
šode
, 
»t
);

178  
	`ERR_PTR
(
»t
);

179 
	}
}

181 
	$upd©e_šode
(
šode
 *šode, 
·ge
 *
node_·ge
)

183 
f2fs_šode
 *
ri
;

185 
	`f2fs_wa™_Ú_·ge_wr™eback
(
node_·ge
, 
NODE
);

187 
ri
 = 
	`F2FS_INODE
(
node_·ge
);

189 
ri
->
i_mode
 = 
	`ıu_to_Ë16
(
šode
->i_mode);

190 
ri
->
i_advi£
 = 
	`F2FS_I
(
šode
)->i_advise;

191 
ri
->
i_uid
 = 
	`ıu_to_Ë32
(
	`i_uid_»ad
(
šode
));

192 
ri
->
i_gid
 = 
	`ıu_to_Ë32
(
	`i_gid_»ad
(
šode
));

193 
ri
->
i_lšks
 = 
	`ıu_to_Ë32
(
šode
->
i_Æšk
);

194 
ri
->
i_size
 = 
	`ıu_to_Ë64
(
	`i_size_»ad
(
šode
));

195 
ri
->
i_blocks
 = 
	`ıu_to_Ë64
(
šode
->i_blocks);

196 
	`£t_¿w_ex‹Á
(&
	`F2FS_I
(
šode
)->
ext
, &
ri
->
i_ext
);

197 
	`£t_¿w_šlše
(
	`F2FS_I
(
šode
), 
ri
);

199 
ri
->
i_©ime
 = 
	`ıu_to_Ë64
(
šode
->i_©ime.
tv_£c
);

200 
ri
->
i_ùime
 = 
	`ıu_to_Ë64
(
šode
->i_ùime.
tv_£c
);

201 
ri
->
i_mtime
 = 
	`ıu_to_Ë64
(
šode
->i_mtime.
tv_£c
);

202 
ri
->
i_©ime_n£c
 = 
	`ıu_to_Ë32
(
šode
->
i_©ime
.
tv_n£c
);

203 
ri
->
i_ùime_n£c
 = 
	`ıu_to_Ë32
(
šode
->
i_ùime
.
tv_n£c
);

204 
ri
->
i_mtime_n£c
 = 
	`ıu_to_Ë32
(
šode
->
i_mtime
.
tv_n£c
);

205 
ri
->
i_cu¼’t_d•th
 = 
	`ıu_to_Ë32
(
	`F2FS_I
(
šode
)->i_current_depth);

206 
ri
->
i_x©Œ_nid
 = 
	`ıu_to_Ë32
(
	`F2FS_I
(
šode
)->i_xattr_nid);

207 
ri
->
i_æags
 = 
	`ıu_to_Ë32
(
	`F2FS_I
(
šode
)->i_flags);

208 
ri
->
i_pšo
 = 
	`ıu_to_Ë32
(
	`F2FS_I
(
šode
)->i_pino);

209 
ri
->
i_g’”©iÚ
 = 
	`ıu_to_Ë32
(
šode
->i_generation);

210 
ri
->
i_dœ_Ëv–
 = 
	`F2FS_I
(
šode
)->i_dir_level;

212 
	`__£t_šode_rdev
(
šode
, 
ri
);

213 
	`£t_cŞd_node
(
šode
, 
node_·ge
);

214 
	`£t_·ge_dœty
(
node_·ge
);

216 
	`ş—r_šode_æag
(
	`F2FS_I
(
šode
), 
FI_DIRTY_INODE
);

217 
	}
}

219 
	$upd©e_šode_·ge
(
šode
 *inode)

221 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

222 
·ge
 *
node_·ge
;

223 
»Œy
:

224 
node_·ge
 = 
	`g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

225 ià(
	`IS_ERR
(
node_·ge
)) {

226 
”r
 = 
	`PTR_ERR
(
node_·ge
);

227 ià(
”r
 =ğ-
ENOMEM
) {

228 
	`cÚd_»sched
();

229 
»Œy
;

230 } ià(
”r
 !ğ-
ENOENT
) {

231 
	`f2fs_¡İ_checkpošt
(
sbi
);

235 
	`upd©e_šode
(
šode
, 
node_·ge
);

236 
	`f2fs_put_·ge
(
node_·ge
, 1);

237 
	}
}

239 
	$f2fs_wr™e_šode
(
šode
 *šode, 
wr™eback_cÚŒŞ
 *
wbc
)

241 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

243 ià(
šode
->
i_šo
 =ğ
	`F2FS_NODE_INO
(
sbi
) ||

244 
šode
->
i_šo
 =ğ
	`F2FS_META_INO
(
sbi
))

247 ià(!
	`is_šode_æag_£t
(
	`F2FS_I
(
šode
), 
FI_DIRTY_INODE
))

254 
	`f2fs_lock_İ
(
sbi
);

255 
	`upd©e_šode_·ge
(
šode
);

256 
	`f2fs_uÆock_İ
(
sbi
);

258 ià(
wbc
)

259 
	`f2fs_b®ªû_fs
(
sbi
);

262 
	}
}

267 
	$f2fs_eviù_šode
(
šode
 *inode)

269 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

270 
nid_t
 
xnid
 = 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
;

273 ià(
	`f2fs_is_©omic_fe
(
šode
è|| 
	`f2fs_is_vŞ©e_fe
(inode))

274 
	`comm™_šmem_·ges
(
šode
, 
Œue
);

276 
	`Œaû_f2fs_eviù_šode
(
šode
);

277 
	`Œunÿ‹_šode_·ges_fš®
(&
šode
->
i_d©a
);

279 ià(
šode
->
i_šo
 =ğ
	`F2FS_NODE_INO
(
sbi
) ||

280 
šode
->
i_šo
 =ğ
	`F2FS_META_INO
(
sbi
))

281 
out_ş—r
;

283 
	`f2fs_bug_Ú
(
sbi
, 
	`g‘_dœty_·ges
(
šode
));

284 
	`»move_dœty_dœ_šode
(
šode
);

286 ià(
šode
->
i_Æšk
 || 
	`is_bad_šode
(inode))

287 
no_d–‘e
;

289 
	`sb_¡¬t_štwr™e
(
šode
->
i_sb
);

290 
	`£t_šode_æag
(
	`F2FS_I
(
šode
), 
FI_NO_ALLOC
);

291 
	`i_size_wr™e
(
šode
, 0);

293 ià(
	`F2FS_HAS_BLOCKS
(
šode
))

294 
	`f2fs_Œunÿ‹
(
šode
);

296 
	`f2fs_lock_İ
(
sbi
);

297 
	`»move_šode_·ge
(
šode
);

298 
	`¡©_dec_šlše_šode
(
šode
);

299 
	`f2fs_uÆock_İ
(
sbi
);

301 
	`sb_’d_štwr™e
(
šode
->
i_sb
);

302 
no_d–‘e
:

303 
	`šv®id©e_m­pšg_·ges
(
	`NODE_MAPPING
(
sbi
), 
šode
->
i_šo
, inode->i_ino);

304 ià(
xnid
)

305 
	`šv®id©e_m­pšg_·ges
(
	`NODE_MAPPING
(
sbi
), 
xnid
, xnid);

306 ià(
	`is_šode_æag_£t
(
	`F2FS_I
(
šode
), 
FI_APPEND_WRITE
))

307 
	`add_dœty_šode
(
sbi
, 
šode
->
i_šo
, 
APPEND_INO
);

308 ià(
	`is_šode_æag_£t
(
	`F2FS_I
(
šode
), 
FI_UPDATE_WRITE
))

309 
	`add_dœty_šode
(
sbi
, 
šode
->
i_šo
, 
UPDATE_INO
);

310 
out_ş—r
:

311 
	`ş—r_šode
(
šode
);

312 
	}
}

315 
	$hªdË_çed_šode
(
šode
 *inode)

317 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

319 
	`ş—r_Æšk
(
šode
);

320 
	`make_bad_šode
(
šode
);

321 
	`uÆock_Ãw_šode
(
šode
);

323 
	`i_size_wr™e
(
šode
, 0);

324 ià(
	`F2FS_HAS_BLOCKS
(
šode
))

325 
	`f2fs_Œunÿ‹
(
šode
);

327 
	`»move_šode_·ge
(
šode
);

328 
	`¡©_dec_šlše_šode
(
šode
);

330 
	`®loc_nid_çed
(
sbi
, 
šode
->
i_šo
);

331 
	`f2fs_uÆock_İ
(
sbi
);

334 
	`ut
(
šode
);

335 
	}
}

	@namei.c

11 
	~<lšux/fs.h
>

12 
	~<lšux/f2fs_fs.h
>

13 
	~<lšux/·gem­.h
>

14 
	~<lšux/sched.h
>

15 
	~<lšux/ùy³.h
>

16 
	~<lšux/dÿche.h
>

18 
	~"f2fs.h
"

19 
	~"node.h
"

20 
	~"x©Œ.h
"

21 
	~"aş.h
"

22 
	~<Œaû/ev’ts/f2fs.h
>

24 
šode
 *
	$f2fs_Ãw_šode
(
šode
 *
dœ
, 
umode_t
 
mode
)

26 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

27 
nid_t
 
šo
;

28 
šode
 *inode;

29 
boŞ
 
nid_ä“
 = 
çl£
;

30 
”r
;

32 
šode
 = 
	`Ãw_šode
(
dœ
->
i_sb
);

33 ià(!
šode
)

34  
	`ERR_PTR
(-
ENOMEM
);

36 
	`f2fs_lock_İ
(
sbi
);

37 ià(!
	`®loc_nid
(
sbi
, &
šo
)) {

38 
	`f2fs_uÆock_İ
(
sbi
);

39 
”r
 = -
ENOSPC
;

40 
ç
;

42 
	`f2fs_uÆock_İ
(
sbi
);

44 
	`šode_š™_owÃr
(
šode
, 
dœ
, 
mode
);

46 
šode
->
i_šo
 = 
šo
;

47 
šode
->
i_blocks
 = 0;

48 
šode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_ùime
 = 
CURRENT_TIME
;

49 
šode
->
i_g’”©iÚ
 = 
sbi
->
s_Ãxt_g’”©iÚ
++;

51 
”r
 = 
	`š£¹_šode_locked
(
šode
);

52 ià(
”r
) {

53 
”r
 = -
EINVAL
;

54 
nid_ä“
 = 
Œue
;

55 
out
;

57 
	`Œaû_f2fs_Ãw_šode
(
šode
, 0);

58 
	`m¬k_šode_dœty
(
šode
);

59  
šode
;

61 
out
:

62 
	`ş—r_Æšk
(
šode
);

63 
	`uÆock_Ãw_šode
(
šode
);

64 
ç
:

65 
	`Œaû_f2fs_Ãw_šode
(
šode
, 
”r
);

66 
	`make_bad_šode
(
šode
);

67 
	`ut
(
šode
);

68 ià(
nid_ä“
)

69 
	`®loc_nid_çed
(
sbi
, 
šo
);

70  
	`ERR_PTR
(
”r
);

71 
	}
}

73 
	$is_muÉimedŸ_fe
(cÚ¡ *
s
, cÚ¡ *
sub
)

75 
size_t
 
¦’
 = 
	`¡¾’
(
s
);

76 
size_t
 
subËn
 = 
	`¡¾’
(
sub
);

78 ià(
subËn
 > 
¦’
)

81  !
	`¡ºÿ£cmp
(
s
 + 
¦’
 - 
subËn
, 
sub
, sublen);

82 
	}
}

87 
šlše
 
	$£t_cŞd_fes
(
f2fs_sb_šfo
 *
sbi
, 
šode
 *inode,

88 cÚ¡ *
Çme
)

90 
i
;

91 
	`__u8
 (*
exi¡
)[8] = 
sbi
->
¿w_su³r
->
ex‹nsiÚ_li¡
;

93 
couÁ
 = 
	`Ë32_to_ıu
(
sbi
->
¿w_su³r
->
ex‹nsiÚ_couÁ
);

94 
i
 = 0; i < 
couÁ
; i++) {

95 ià(
	`is_muÉimedŸ_fe
(
Çme
, 
exi¡
[
i
])) {

96 
	`fe_£t_cŞd
(
šode
);

100 
	}
}

102 
	$f2fs_ü—‹
(
šode
 *
dœ
, 
d’Œy
 *d’Œy, 
umode_t
 
mode
,

103 
boŞ
 
exş
)

105 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

106 
šode
 *inode;

107 
nid_t
 
šo
 = 0;

108 
”r
;

110 
	`f2fs_b®ªû_fs
(
sbi
);

112 
šode
 = 
	`f2fs_Ãw_šode
(
dœ
, 
mode
);

113 ià(
	`IS_ERR
(
šode
))

114  
	`PTR_ERR
(
šode
);

116 ià(!
	`‹¡_İt
(
sbi
, 
DISABLE_EXT_IDENTIFY
))

117 
	`£t_cŞd_fes
(
sbi
, 
šode
, 
d’Œy
->
d_Çme
.
Çme
);

119 
šode
->
i_İ
 = &
f2fs_fe_šode_İ”©iÚs
;

120 
šode
->
i_fİ
 = &
f2fs_fe_İ”©iÚs
;

121 
šode
->
i_m­pšg
->
a_İs
 = &
f2fs_dblock_aİs
;

122 
šo
 = 
šode
->
i_šo
;

124 
	`f2fs_lock_İ
(
sbi
);

125 
”r
 = 
	`f2fs_add_lšk
(
d’Œy
, 
šode
);

126 ià(
”r
)

127 
out
;

128 
	`f2fs_uÆock_İ
(
sbi
);

130 
	`®loc_nid_dÚe
(
sbi
, 
šo
);

132 
	`d_š¡ªtŸ‹
(
d’Œy
, 
šode
);

133 
	`uÆock_Ãw_šode
(
šode
);

135 
out
:

136 
	`hªdË_çed_šode
(
šode
);

137  
”r
;

138 
	}
}

140 
	$f2fs_lšk
(
d’Œy
 *
Şd_d’Œy
, 
šode
 *
dœ
,

141 
d’Œy
 *dentry)

143 
šode
 *šodğ
Şd_d’Œy
->
d_šode
;

144 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

145 
”r
;

147 
	`f2fs_b®ªû_fs
(
sbi
);

149 
šode
->
i_ùime
 = 
CURRENT_TIME
;

150 
	`ihŞd
(
šode
);

152 
	`£t_šode_æag
(
	`F2FS_I
(
šode
), 
FI_INC_LINK
);

153 
	`f2fs_lock_İ
(
sbi
);

154 
”r
 = 
	`f2fs_add_lšk
(
d’Œy
, 
šode
);

155 ià(
”r
)

156 
out
;

157 
	`f2fs_uÆock_İ
(
sbi
);

159 
	`d_š¡ªtŸ‹
(
d’Œy
, 
šode
);

161 
out
:

162 
	`ş—r_šode_æag
(
	`F2FS_I
(
šode
), 
FI_INC_LINK
);

163 
	`ut
(
šode
);

164 
	`f2fs_uÆock_İ
(
sbi
);

165  
”r
;

166 
	}
}

168 
d’Œy
 *
	$f2fs_g‘_·»Á
(
d’Œy
 *
chd
)

170 
q¡r
 
dÙdÙ
 = 
	`QSTR_INIT
("..", 2);

171 
šo
 = 
	`f2fs_šode_by_Çme
(
chd
->
d_šode
, &
dÙdÙ
);

172 ià(!
šo
)

173  
	`ERR_PTR
(-
ENOENT
);

174  
	`d_obš_®Ÿs
(
	`f2fs_ig‘
(
chd
->
d_šode
->
i_sb
, 
šo
));

175 
	}
}

177 
d’Œy
 *
	$f2fs_lookup
(
šode
 *
dœ
, 
d’Œy
 *dentry,

178 
æags
)

180 
šode
 *šodğ
NULL
;

181 
f2fs_dœ_’Œy
 *
de
;

182 
·ge
 *page;

184 ià(
d’Œy
->
d_Çme
.
Ën
 > 
F2FS_NAME_LEN
)

185  
	`ERR_PTR
(-
ENAMETOOLONG
);

187 
de
 = 
	`f2fs_fšd_’Œy
(
dœ
, &
d’Œy
->
d_Çme
, &
·ge
);

188 ià(
de
) {

189 
nid_t
 
šo
 = 
	`Ë32_to_ıu
(
de
->ino);

190 
	`kunm­
(
·ge
);

191 
	`f2fs_put_·ge
(
·ge
, 0);

193 
šode
 = 
	`f2fs_ig‘
(
dœ
->
i_sb
, 
šo
);

194 ià(
	`IS_ERR
(
šode
))

195  
	`ERR_CAST
(
šode
);

197 
	`¡©_šc_šlše_šode
(
šode
);

200  
	`d_¥liû_®Ÿs
(
šode
, 
d’Œy
);

201 
	}
}

203 
	$f2fs_uÆšk
(
šode
 *
dœ
, 
d’Œy
 *dentry)

205 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

206 
šode
 *šodğ
d’Œy
->
d_šode
;

207 
f2fs_dœ_’Œy
 *
de
;

208 
·ge
 *page;

209 
”r
 = -
ENOENT
;

211 
	`Œaû_f2fs_uÆšk_’‹r
(
dœ
, 
d’Œy
);

212 
	`f2fs_b®ªû_fs
(
sbi
);

214 
de
 = 
	`f2fs_fšd_’Œy
(
dœ
, &
d’Œy
->
d_Çme
, &
·ge
);

215 ià(!
de
)

216 
ç
;

218 
	`f2fs_lock_İ
(
sbi
);

219 
”r
 = 
	`acquœe_Üphª_šode
(
sbi
);

220 ià(
”r
) {

221 
	`f2fs_uÆock_İ
(
sbi
);

222 
	`kunm­
(
·ge
);

223 
	`f2fs_put_·ge
(
·ge
, 0);

224 
ç
;

226 
	`f2fs_d–‘e_’Œy
(
de
, 
·ge
, 
šode
);

227 
	`f2fs_uÆock_İ
(
sbi
);

230 
	`m¬k_šode_dœty
(
šode
);

231 
ç
:

232 
	`Œaû_f2fs_uÆšk_ex™
(
šode
, 
”r
);

233  
”r
;

234 
	}
}

236 
	$f2fs_symlšk
(
šode
 *
dœ
, 
d’Œy
 *dentry,

237 cÚ¡ *
symÇme
)

239 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

240 
šode
 *inode;

241 
size_t
 
symËn
 = 
	`¡¾’
(
symÇme
) + 1;

242 
”r
;

244 
	`f2fs_b®ªû_fs
(
sbi
);

246 
šode
 = 
	`f2fs_Ãw_šode
(
dœ
, 
S_IFLNK
 | 
S_IRWXUGO
);

247 ià(
	`IS_ERR
(
šode
))

248  
	`PTR_ERR
(
šode
);

250 
šode
->
i_İ
 = &
f2fs_symlšk_šode_İ”©iÚs
;

251 
šode
->
i_m­pšg
->
a_İs
 = &
f2fs_dblock_aİs
;

253 
	`f2fs_lock_İ
(
sbi
);

254 
”r
 = 
	`f2fs_add_lšk
(
d’Œy
, 
šode
);

255 ià(
”r
)

256 
out
;

257 
	`f2fs_uÆock_İ
(
sbi
);

259 
”r
 = 
	`·ge_symlšk
(
šode
, 
symÇme
, 
symËn
);

260 
	`®loc_nid_dÚe
(
sbi
, 
šode
->
i_šo
);

262 
	`d_š¡ªtŸ‹
(
d’Œy
, 
šode
);

263 
	`uÆock_Ãw_šode
(
šode
);

264  
”r
;

265 
out
:

266 
	`hªdË_çed_šode
(
šode
);

267  
”r
;

268 
	}
}

270 
	$f2fs_mkdœ
(
šode
 *
dœ
, 
d’Œy
 *d’Œy, 
umode_t
 
mode
)

272 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

273 
šode
 *inode;

274 
”r
;

276 
	`f2fs_b®ªû_fs
(
sbi
);

278 
šode
 = 
	`f2fs_Ãw_šode
(
dœ
, 
S_IFDIR
 | 
mode
);

279 ià(
	`IS_ERR
(
šode
))

280  
	`PTR_ERR
(
šode
);

282 
šode
->
i_İ
 = &
f2fs_dœ_šode_İ”©iÚs
;

283 
šode
->
i_fİ
 = &
f2fs_dœ_İ”©iÚs
;

284 
šode
->
i_m­pšg
->
a_İs
 = &
f2fs_dblock_aİs
;

285 
	`m­pšg_£t_gå_mask
(
šode
->
i_m­pšg
, 
GFP_F2FS_ZERO
);

287 
	`£t_šode_æag
(
	`F2FS_I
(
šode
), 
FI_INC_LINK
);

288 
	`f2fs_lock_İ
(
sbi
);

289 
”r
 = 
	`f2fs_add_lšk
(
d’Œy
, 
šode
);

290 ià(
”r
)

291 
out_ç
;

292 
	`f2fs_uÆock_İ
(
sbi
);

294 
	`®loc_nid_dÚe
(
sbi
, 
šode
->
i_šo
);

296 
	`d_š¡ªtŸ‹
(
d’Œy
, 
šode
);

297 
	`uÆock_Ãw_šode
(
šode
);

301 
out_ç
:

302 
	`ş—r_šode_æag
(
	`F2FS_I
(
šode
), 
FI_INC_LINK
);

303 
	`hªdË_çed_šode
(
šode
);

304  
”r
;

305 
	}
}

307 
	$f2fs_rmdœ
(
šode
 *
dœ
, 
d’Œy
 *dentry)

309 
šode
 *šodğ
d’Œy
->
d_šode
;

310 ià(
	`f2fs_em±y_dœ
(
šode
))

311  
	`f2fs_uÆšk
(
dœ
, 
d’Œy
);

312  -
ENOTEMPTY
;

313 
	}
}

315 
	$f2fs_mknod
(
šode
 *
dœ
, 
d’Œy
 *dentry,

316 
umode_t
 
mode
, 
dev_t
 
rdev
)

318 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

319 
šode
 *inode;

320 
”r
 = 0;

322 ià(!
	`Ãw_v®id_dev
(
rdev
))

323  -
EINVAL
;

325 
	`f2fs_b®ªû_fs
(
sbi
);

327 
šode
 = 
	`f2fs_Ãw_šode
(
dœ
, 
mode
);

328 ià(
	`IS_ERR
(
šode
))

329  
	`PTR_ERR
(
šode
);

331 
	`š™_¥ecŸl_šode
(
šode
, inode->
i_mode
, 
rdev
);

332 
šode
->
i_İ
 = &
f2fs_¥ecŸl_šode_İ”©iÚs
;

334 
	`f2fs_lock_İ
(
sbi
);

335 
”r
 = 
	`f2fs_add_lšk
(
d’Œy
, 
šode
);

336 ià(
”r
)

337 
out
;

338 
	`f2fs_uÆock_İ
(
sbi
);

340 
	`®loc_nid_dÚe
(
sbi
, 
šode
->
i_šo
);

341 
	`d_š¡ªtŸ‹
(
d’Œy
, 
šode
);

342 
	`uÆock_Ãw_šode
(
šode
);

344 
out
:

345 
	`hªdË_çed_šode
(
šode
);

346  
”r
;

347 
	}
}

349 
	$f2fs_»Çme
(
šode
 *
Şd_dœ
, 
d’Œy
 *
Şd_d’Œy
,

350 
šode
 *
Ãw_dœ
, 
d’Œy
 *
Ãw_d’Œy
)

352 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
Şd_dœ
);

353 
šode
 *
Şd_šode
 = 
Şd_d’Œy
->
d_šode
;

354 
šode
 *
Ãw_šode
 = 
Ãw_d’Œy
->
d_šode
;

355 
·ge
 *
Şd_dœ_·ge
;

356 
·ge
 *
Şd_·ge
, *
Ãw_·ge
;

357 
f2fs_dœ_’Œy
 *
Şd_dœ_’Œy
 = 
NULL
;

358 
f2fs_dœ_’Œy
 *
Şd_’Œy
;

359 
f2fs_dœ_’Œy
 *
Ãw_’Œy
;

360 
”r
 = -
ENOENT
;

362 
	`f2fs_b®ªû_fs
(
sbi
);

364 
Şd_’Œy
 = 
	`f2fs_fšd_’Œy
(
Şd_dœ
, &
Şd_d’Œy
->
d_Çme
, &
Şd_·ge
);

365 ià(!
Şd_’Œy
)

366 
out
;

368 ià(
	`S_ISDIR
(
Şd_šode
->
i_mode
)) {

369 
”r
 = -
EIO
;

370 
Şd_dœ_’Œy
 = 
	`f2fs_·»Á_dœ
(
Şd_šode
, &
Şd_dœ_·ge
);

371 ià(!
Şd_dœ_’Œy
)

372 
out_Şd
;

375 ià(
Ãw_šode
) {

377 
”r
 = -
ENOTEMPTY
;

378 ià(
Şd_dœ_’Œy
 && !
	`f2fs_em±y_dœ
(
Ãw_šode
))

379 
out_dœ
;

381 
”r
 = -
ENOENT
;

382 
Ãw_’Œy
 = 
	`f2fs_fšd_’Œy
(
Ãw_dœ
, &
Ãw_d’Œy
->
d_Çme
,

383 &
Ãw_·ge
);

384 ià(!
Ãw_’Œy
)

385 
out_dœ
;

387 
	`f2fs_lock_İ
(
sbi
);

389 
”r
 = 
	`acquœe_Üphª_šode
(
sbi
);

390 ià(
”r
)

391 
put_out_dœ
;

393 ià(
	`upd©e_d’t_šode
(
Şd_šode
, &
Ãw_d’Œy
->
d_Çme
)) {

394 
	`»Ëa£_Üphª_šode
(
sbi
);

395 
put_out_dœ
;

398 
	`f2fs_£t_lšk
(
Ãw_dœ
, 
Ãw_’Œy
, 
Ãw_·ge
, 
Şd_šode
);

400 
Ãw_šode
->
i_ùime
 = 
CURRENT_TIME
;

401 
	`down_wr™e
(&
	`F2FS_I
(
Ãw_šode
)->
i_£m
);

402 ià(
Şd_dœ_’Œy
)

403 
	`drİ_Æšk
(
Ãw_šode
);

404 
	`drİ_Æšk
(
Ãw_šode
);

405 
	`up_wr™e
(&
	`F2FS_I
(
Ãw_šode
)->
i_£m
);

407 
	`m¬k_šode_dœty
(
Ãw_šode
);

409 ià(!
Ãw_šode
->
i_Æšk
)

410 
	`add_Üphª_šode
(
sbi
, 
Ãw_šode
->
i_šo
);

412 
	`»Ëa£_Üphª_šode
(
sbi
);

414 
	`upd©e_šode_·ge
(
Şd_šode
);

415 
	`upd©e_šode_·ge
(
Ãw_šode
);

417 
	`f2fs_lock_İ
(
sbi
);

419 
”r
 = 
	`f2fs_add_lšk
(
Ãw_d’Œy
, 
Şd_šode
);

420 ià(
”r
) {

421 
	`f2fs_uÆock_İ
(
sbi
);

422 
out_dœ
;

425 ià(
Şd_dœ_’Œy
) {

426 
	`šc_Æšk
(
Ãw_dœ
);

427 
	`upd©e_šode_·ge
(
Ãw_dœ
);

431 
	`down_wr™e
(&
	`F2FS_I
(
Şd_šode
)->
i_£m
);

432 
	`fe_lo¡_pšo
(
Şd_šode
);

433 
	`up_wr™e
(&
	`F2FS_I
(
Şd_šode
)->
i_£m
);

435 
Şd_šode
->
i_ùime
 = 
CURRENT_TIME
;

436 
	`m¬k_šode_dœty
(
Şd_šode
);

438 
	`f2fs_d–‘e_’Œy
(
Şd_’Œy
, 
Şd_·ge
, 
NULL
);

440 ià(
Şd_dœ_’Œy
) {

441 ià(
Şd_dœ
 !ğ
Ãw_dœ
) {

442 
	`f2fs_£t_lšk
(
Şd_šode
, 
Şd_dœ_’Œy
,

443 
Şd_dœ_·ge
, 
Ãw_dœ
);

444 
	`upd©e_šode_·ge
(
Şd_šode
);

446 
	`kunm­
(
Şd_dœ_·ge
);

447 
	`f2fs_put_·ge
(
Şd_dœ_·ge
, 0);

449 
	`drİ_Æšk
(
Şd_dœ
);

450 
	`m¬k_šode_dœty
(
Şd_dœ
);

451 
	`upd©e_šode_·ge
(
Şd_dœ
);

454 
	`f2fs_uÆock_İ
(
sbi
);

457 
put_out_dœ
:

458 
	`f2fs_uÆock_İ
(
sbi
);

459 
	`kunm­
(
Ãw_·ge
);

460 
	`f2fs_put_·ge
(
Ãw_·ge
, 0);

461 
out_dœ
:

462 ià(
Şd_dœ_’Œy
) {

463 
	`kunm­
(
Şd_dœ_·ge
);

464 
	`f2fs_put_·ge
(
Şd_dœ_·ge
, 0);

466 
out_Şd
:

467 
	`kunm­
(
Şd_·ge
);

468 
	`f2fs_put_·ge
(
Şd_·ge
, 0);

469 
out
:

470  
”r
;

471 
	}
}

473 
	$f2fs_üoss_»Çme
(
šode
 *
Şd_dœ
, 
d’Œy
 *
Şd_d’Œy
,

474 
šode
 *
Ãw_dœ
, 
d’Œy
 *
Ãw_d’Œy
)

476 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
Şd_dœ
);

477 
šode
 *
Şd_šode
 = 
Şd_d’Œy
->
d_šode
;

478 
šode
 *
Ãw_šode
 = 
Ãw_d’Œy
->
d_šode
;

479 
·ge
 *
Şd_dœ_·ge
, *
Ãw_dœ_·ge
;

480 
·ge
 *
Şd_·ge
, *
Ãw_·ge
;

481 
f2fs_dœ_’Œy
 *
Şd_dœ_’Œy
 = 
NULL
, *
Ãw_dœ_’Œy
 = NULL;

482 
f2fs_dœ_’Œy
 *
Şd_’Œy
, *
Ãw_’Œy
;

483 
Şd_Æšk
 = 0, 
Ãw_Æšk
 = 0;

484 
”r
 = -
ENOENT
;

486 
	`f2fs_b®ªû_fs
(
sbi
);

488 
Şd_’Œy
 = 
	`f2fs_fšd_’Œy
(
Şd_dœ
, &
Şd_d’Œy
->
d_Çme
, &
Şd_·ge
);

489 ià(!
Şd_’Œy
)

490 
out
;

492 
Ãw_’Œy
 = 
	`f2fs_fšd_’Œy
(
Ãw_dœ
, &
Ãw_d’Œy
->
d_Çme
, &
Ãw_·ge
);

493 ià(!
Ãw_’Œy
)

494 
out_Şd
;

497 ià(
Şd_dœ
 !ğ
Ãw_dœ
) {

498 ià(
	`S_ISDIR
(
Şd_šode
->
i_mode
)) {

499 
”r
 = -
EIO
;

500 
Şd_dœ_’Œy
 = 
	`f2fs_·»Á_dœ
(
Şd_šode
,

501 &
Şd_dœ_·ge
);

502 ià(!
Şd_dœ_’Œy
)

503 
out_Ãw
;

506 ià(
	`S_ISDIR
(
Ãw_šode
->
i_mode
)) {

507 
”r
 = -
EIO
;

508 
Ãw_dœ_’Œy
 = 
	`f2fs_·»Á_dœ
(
Ãw_šode
,

509 &
Ãw_dœ_·ge
);

510 ià(!
Ãw_dœ_’Œy
)

511 
out_Şd_dœ
;

520 ià((!
Şd_dœ_’Œy
 || !
Ãw_dœ_’Œy
) &&

521 
Şd_dœ_’Œy
 !ğ
Ãw_dœ_’Œy
) {

522 
Şd_Æšk
 = 
Şd_dœ_’Œy
 ? -1 : 1;

523 
Ãw_Æšk
 = -
Şd_Æšk
;

524 
”r
 = -
EMLINK
;

525 ià((
Şd_Æšk
 > 0 && 
Şd_šode
->
i_Æšk
 >ğ
F2FS_LINK_MAX
) ||

526 (
Ãw_Æšk
 > 0 && 
Ãw_šode
->
i_Æšk
 >ğ
F2FS_LINK_MAX
))

527 
out_Ãw_dœ
;

530 
	`f2fs_lock_İ
(
sbi
);

532 
”r
 = 
	`upd©e_d’t_šode
(
Şd_šode
, &
Ãw_d’Œy
->
d_Çme
);

533 ià(
”r
)

534 
out_uÆock
;

536 
”r
 = 
	`upd©e_d’t_šode
(
Ãw_šode
, &
Şd_d’Œy
->
d_Çme
);

537 ià(
”r
)

538 
out_undo
;

541 ià(
Şd_dœ_’Œy
)

542 
	`f2fs_£t_lšk
(
Şd_šode
, 
Şd_dœ_’Œy
, 
Şd_dœ_·ge
, 
Ãw_dœ
);

545 ià(
Ãw_dœ_’Œy
)

546 
	`f2fs_£t_lšk
(
Ãw_šode
, 
Ãw_dœ_’Œy
, 
Ãw_dœ_·ge
, 
Şd_dœ
);

549 
	`f2fs_£t_lšk
(
Şd_dœ
, 
Şd_’Œy
, 
Şd_·ge
, 
Ãw_šode
);

551 
	`down_wr™e
(&
	`F2FS_I
(
Şd_šode
)->
i_£m
);

552 
	`fe_lo¡_pšo
(
Şd_šode
);

553 
	`up_wr™e
(&
	`F2FS_I
(
Şd_šode
)->
i_£m
);

555 
	`upd©e_šode_·ge
(
Şd_šode
);

557 
Şd_dœ
->
i_ùime
 = 
CURRENT_TIME
;

558 ià(
Şd_Æšk
) {

559 
	`down_wr™e
(&
	`F2FS_I
(
Şd_dœ
)->
i_£m
);

560 ià(
Şd_Æšk
 < 0)

561 
	`drİ_Æšk
(
Şd_dœ
);

563 
	`šc_Æšk
(
Şd_dœ
);

564 
	`up_wr™e
(&
	`F2FS_I
(
Şd_dœ
)->
i_£m
);

566 
	`m¬k_šode_dœty
(
Şd_dœ
);

567 
	`upd©e_šode_·ge
(
Şd_dœ
);

570 
	`f2fs_£t_lšk
(
Ãw_dœ
, 
Ãw_’Œy
, 
Ãw_·ge
, 
Şd_šode
);

572 
	`down_wr™e
(&
	`F2FS_I
(
Ãw_šode
)->
i_£m
);

573 
	`fe_lo¡_pšo
(
Ãw_šode
);

574 
	`up_wr™e
(&
	`F2FS_I
(
Ãw_šode
)->
i_£m
);

576 
	`upd©e_šode_·ge
(
Ãw_šode
);

578 
Ãw_dœ
->
i_ùime
 = 
CURRENT_TIME
;

579 ià(
Ãw_Æšk
) {

580 
	`down_wr™e
(&
	`F2FS_I
(
Ãw_dœ
)->
i_£m
);

581 ià(
Ãw_Æšk
 < 0)

582 
	`drİ_Æšk
(
Ãw_dœ
);

584 
	`šc_Æšk
(
Ãw_dœ
);

585 
	`up_wr™e
(&
	`F2FS_I
(
Ãw_dœ
)->
i_£m
);

587 
	`m¬k_šode_dœty
(
Ãw_dœ
);

588 
	`upd©e_šode_·ge
(
Ãw_dœ
);

590 
	`f2fs_uÆock_İ
(
sbi
);

592 
out_undo
:

594 
	`upd©e_d’t_šode
(
Şd_šode
, &
Şd_d’Œy
->
d_Çme
);

595 
out_uÆock
:

596 
	`f2fs_uÆock_İ
(
sbi
);

597 
out_Ãw_dœ
:

598 ià(
Ãw_dœ_’Œy
) {

599 
	`kunm­
(
Ãw_dœ_·ge
);

600 
	`f2fs_put_·ge
(
Ãw_dœ_·ge
, 0);

602 
out_Şd_dœ
:

603 ià(
Şd_dœ_’Œy
) {

604 
	`kunm­
(
Şd_dœ_·ge
);

605 
	`f2fs_put_·ge
(
Şd_dœ_·ge
, 0);

607 
out_Ãw
:

608 
	`kunm­
(
Ãw_·ge
);

609 
	`f2fs_put_·ge
(
Ãw_·ge
, 0);

610 
out_Şd
:

611 
	`kunm­
(
Şd_·ge
);

612 
	`f2fs_put_·ge
(
Şd_·ge
, 0);

613 
out
:

614  
”r
;

615 
	}
}

617 
	$f2fs_»Çme2
(
šode
 *
Şd_dœ
, 
d’Œy
 *
Şd_d’Œy
,

618 
šode
 *
Ãw_dœ
, 
d’Œy
 *
Ãw_d’Œy
,

619 
æags
)

621 ià(
æags
 & ~(
RENAME_NOREPLACE
 | 
RENAME_EXCHANGE
))

622  -
EINVAL
;

624 ià(
æags
 & 
RENAME_EXCHANGE
) {

625  
	`f2fs_üoss_»Çme
(
Şd_dœ
, 
Şd_d’Œy
,

626 
Ãw_dœ
, 
Ãw_d’Œy
);

632  
	`f2fs_»Çme
(
Şd_dœ
, 
Şd_d’Œy
, 
Ãw_dœ
, 
Ãw_d’Œy
);

633 
	}
}

635 
	$f2fs_tmpfe
(
šode
 *
dœ
, 
d’Œy
 *d’Œy, 
umode_t
 
mode
)

637 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dœ
);

638 
šode
 *inode;

639 
”r
;

641 
šode
 = 
	`f2fs_Ãw_šode
(
dœ
, 
mode
);

642 ià(
	`IS_ERR
(
šode
))

643  
	`PTR_ERR
(
šode
);

645 
šode
->
i_İ
 = &
f2fs_fe_šode_İ”©iÚs
;

646 
šode
->
i_fİ
 = &
f2fs_fe_İ”©iÚs
;

647 
šode
->
i_m­pšg
->
a_İs
 = &
f2fs_dblock_aİs
;

649 
	`f2fs_lock_İ
(
sbi
);

650 
”r
 = 
	`acquœe_Üphª_šode
(
sbi
);

651 ià(
”r
)

652 
out
;

654 
”r
 = 
	`f2fs_do_tmpfe
(
šode
, 
dœ
);

655 ià(
”r
)

656 
»Ëa£_out
;

662 
	`add_Üphª_šode
(
sbi
, 
šode
->
i_šo
);

663 
	`f2fs_uÆock_İ
(
sbi
);

665 
	`®loc_nid_dÚe
(
sbi
, 
šode
->
i_šo
);

666 
	`d_tmpfe
(
d’Œy
, 
šode
);

667 
	`uÆock_Ãw_šode
(
šode
);

670 
»Ëa£_out
:

671 
	`»Ëa£_Üphª_šode
(
sbi
);

672 
out
:

673 
	`hªdË_çed_šode
(
šode
);

674  
”r
;

675 
	}
}

677 cÚ¡ 
šode_İ”©iÚs
 
	gf2fs_dœ_šode_İ”©iÚs
 = {

678 .
ü—‹
 = 
f2fs_ü—‹
,

679 .
	glookup
 = 
f2fs_lookup
,

680 .
	glšk
 = 
f2fs_lšk
,

681 .
	guÆšk
 = 
f2fs_uÆšk
,

682 .
	gsymlšk
 = 
f2fs_symlšk
,

683 .
	gmkdœ
 = 
f2fs_mkdœ
,

684 .
	grmdœ
 = 
f2fs_rmdœ
,

685 .
	gmknod
 = 
f2fs_mknod
,

686 .
	g»Çme2
 = 
f2fs_»Çme2
,

687 .
	gtmpfe
 = 
f2fs_tmpfe
,

688 .
	gg‘©Œ
 = 
f2fs_g‘©Œ
,

689 .
	g£‰r
 = 
f2fs_£‰r
,

690 .
	gg‘_aş
 = 
f2fs_g‘_aş
,

691 .
	g£t_aş
 = 
f2fs_£t_aş
,

692 #ifdeà
CONFIG_F2FS_FS_XATTR


693 .
	g£tx©Œ
 = 
g’”ic_£tx©Œ
,

694 .
	gg‘x©Œ
 = 
g’”ic_g‘x©Œ
,

695 .
	gli¡x©Œ
 = 
f2fs_li¡x©Œ
,

696 .
	g»movex©Œ
 = 
g’”ic_»movex©Œ
,

700 cÚ¡ 
šode_İ”©iÚs
 
	gf2fs_symlšk_šode_İ”©iÚs
 = {

701 .
»adlšk
 = 
g’”ic_»adlšk
,

702 .
	gfŞlow_lšk
 = 
·ge_fŞlow_lšk_light
,

703 .
	gput_lšk
 = 
·ge_put_lšk
,

704 .
	gg‘©Œ
 = 
f2fs_g‘©Œ
,

705 .
	g£‰r
 = 
f2fs_£‰r
,

706 #ifdeà
CONFIG_F2FS_FS_XATTR


707 .
	g£tx©Œ
 = 
g’”ic_£tx©Œ
,

708 .
	gg‘x©Œ
 = 
g’”ic_g‘x©Œ
,

709 .
	gli¡x©Œ
 = 
f2fs_li¡x©Œ
,

710 .
	g»movex©Œ
 = 
g’”ic_»movex©Œ
,

714 cÚ¡ 
šode_İ”©iÚs
 
	gf2fs_¥ecŸl_šode_İ”©iÚs
 = {

715 .
g‘©Œ
 = 
f2fs_g‘©Œ
,

716 .
	g£‰r
 = 
f2fs_£‰r
,

717 .
	gg‘_aş
 = 
f2fs_g‘_aş
,

718 .
	g£t_aş
 = 
f2fs_£t_aş
,

719 #ifdeà
CONFIG_F2FS_FS_XATTR


720 .
	g£tx©Œ
 = 
g’”ic_£tx©Œ
,

721 .
	gg‘x©Œ
 = 
g’”ic_g‘x©Œ
,

722 .
	gli¡x©Œ
 = 
f2fs_li¡x©Œ
,

723 .
	g»movex©Œ
 = 
g’”ic_»movex©Œ
,

	@node.c

11 
	~<lšux/fs.h
>

12 
	~<lšux/f2fs_fs.h
>

13 
	~<lšux/m·ge.h
>

14 
	~<lšux/backšg-dev.h
>

15 
	~<lšux/blkdev.h
>

16 
	~<lšux/·gevec.h
>

17 
	~<lšux/sw­.h
>

19 
	~"f2fs.h
"

20 
	~"node.h
"

21 
	~"£gm’t.h
"

22 
	~<Œaû/ev’ts/f2fs.h
>

24 
	#Ú_bud_ä“_nids
(
nmi
è
	`mu‹x_is_locked
(&
nm_i
->
bud_lock
)

	)

26 
kmem_ÿche
 *
	gÇt_’Œy_¦ab
;

27 
kmem_ÿche
 *
	gä“_nid_¦ab
;

28 
kmem_ÿche
 *
	gÇt_’Œy_£t_¦ab
;

30 
boŞ
 
	$avaabË_ä“_memÜy
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

32 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

33 
sysšfo
 
v®
;

34 
mem_size
 = 0;

35 
boŞ
 
»s
 = 
çl£
;

37 
	`si_memšfo
(&
v®
);

39 ià(
ty³
 =ğ
FREE_NIDS
) {

40 
mem_size
 = (
nm_i
->
fút
 * (
ä“_nid
)) >> 12;

41 
»s
 = 
mem_size
 < ((
v®
.
tÙ®¿m
 * 
nm_i
->
¿m_th»sh
 / 100) >> 2);

42 } ià(
ty³
 =ğ
NAT_ENTRIES
) {

43 
mem_size
 = (
nm_i
->
Çt_út
 * (
Çt_’Œy
)) >> 12;

44 
»s
 = 
mem_size
 < ((
v®
.
tÙ®¿m
 * 
nm_i
->
¿m_th»sh
 / 100) >> 2);

45 } ià(
ty³
 =ğ
DIRTY_DENTS
) {

46 ià(
sbi
->
sb
->
s_bdi
->
dœty_exûeded
)

47  
çl£
;

48 
mem_size
 = 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_DENTS
);

49 
»s
 = 
mem_size
 < ((
v®
.
tÙ®¿m
 * 
nm_i
->
¿m_th»sh
 / 100) >> 1);

51  
»s
;

52 
	}
}

54 
	$ş—r_node_·ge_dœty
(
·ge
 *page)

56 
add»ss_¥aû
 *
m­pšg
 = 
·ge
->mapping;

57 
æags
;

59 ià(
	`PageDœty
(
·ge
)) {

60 
	`¥š_lock_œq§ve
(&
m­pšg
->
Œ“_lock
, 
æags
);

61 
	`¿dix_Œ“_g_ş—r
(&
m­pšg
->
·ge_Œ“
,

62 
	`·ge_šdex
(
·ge
),

63 
PAGECACHE_TAG_DIRTY
);

64 
	`¥š_uÆock_œq»¡Üe
(&
m­pšg
->
Œ“_lock
, 
æags
);

66 
	`ş—r_·ge_dœty_fÜ_io
(
·ge
);

67 
	`dec_·ge_couÁ
(
	`F2FS_M_SB
(
m­pšg
), 
F2FS_DIRTY_NODES
);

69 
	`CË¬PageU±od©e
(
·ge
);

70 
	}
}

72 
·ge
 *
	$g‘_cu¼’t_Çt_·ge
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
)

74 
pgoff_t
 
šdex
 = 
	`cu¼’t_Çt_addr
(
sbi
, 
nid
);

75  
	`g‘_m‘a_·ge
(
sbi
, 
šdex
);

76 
	}
}

78 
·ge
 *
	$g‘_Ãxt_Çt_·ge
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
)

80 
·ge
 *
¤c_·ge
;

81 
·ge
 *
d¡_·ge
;

82 
pgoff_t
 
¤c_off
;

83 
pgoff_t
 
d¡_off
;

84 *
¤c_addr
;

85 *
d¡_addr
;

86 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

88 
¤c_off
 = 
	`cu¼’t_Çt_addr
(
sbi
, 
nid
);

89 
d¡_off
 = 
	`Ãxt_Çt_addr
(
sbi
, 
¤c_off
);

92 
¤c_·ge
 = 
	`g‘_m‘a_·ge
(
sbi
, 
¤c_off
);

93 
d¡_·ge
 = 
	`g¿b_m‘a_·ge
(
sbi
, 
d¡_off
);

94 
	`f2fs_bug_Ú
(
sbi
, 
	`PageDœty
(
¤c_·ge
));

96 
¤c_addr
 = 
	`·ge_add»ss
(
¤c_·ge
);

97 
d¡_addr
 = 
	`·ge_add»ss
(
d¡_·ge
);

98 
	`memıy
(
d¡_addr
, 
¤c_addr
, 
PAGE_CACHE_SIZE
);

99 
	`£t_·ge_dœty
(
d¡_·ge
);

100 
	`f2fs_put_·ge
(
¤c_·ge
, 1);

102 
	`£t_to_Ãxt_Çt
(
nm_i
, 
nid
);

104  
d¡_·ge
;

105 
	}
}

107 
Çt_’Œy
 *
	$__lookup_Çt_ÿche
(
f2fs_nm_šfo
 *
nm_i
, 
nid_t
 
n
)

109  
	`¿dix_Œ“_lookup
(&
nm_i
->
Çt_roÙ
, 
n
);

110 
	}
}

112 
	$__gªg_lookup_Çt_ÿche
(
f2fs_nm_šfo
 *
nm_i
,

113 
nid_t
 
¡¬t
, 
Ä
, 
Çt_’Œy
 **
•
)

115  
	`¿dix_Œ“_gªg_lookup
(&
nm_i
->
Çt_roÙ
, (**)
•
, 
¡¬t
, 
Ä
);

116 
	}
}

118 
	$__d–_äom_Çt_ÿche
(
f2fs_nm_šfo
 *
nm_i
, 
Çt_’Œy
 *
e
)

120 
	`li¡_d–
(&
e
->
li¡
);

121 
	`¿dix_Œ“_d–‘e
(&
nm_i
->
Çt_roÙ
, 
	`Çt_g‘_nid
(
e
));

122 
nm_i
->
Çt_út
--;

123 
	`kmem_ÿche_ä“
(
Çt_’Œy_¦ab
, 
e
);

124 
	}
}

126 
	$__£t_Çt_ÿche_dœty
(
f2fs_nm_šfo
 *
nm_i
,

127 
Çt_’Œy
 *
Ã
)

129 
nid_t
 
£t
 = 
	`NAT_BLOCK_OFFSET
(
Ã
->
ni
.
nid
);

130 
Çt_’Œy_£t
 *
h—d
;

132 ià(
	`g‘_Çt_æag
(
Ã
, 
IS_DIRTY
))

134 
»Œy
:

135 
h—d
 = 
	`¿dix_Œ“_lookup
(&
nm_i
->
Çt_£t_roÙ
, 
£t
);

136 ià(!
h—d
) {

137 
h—d
 = 
	`f2fs_kmem_ÿche_®loc
(
Çt_’Œy_£t_¦ab
, 
GFP_ATOMIC
);

139 
	`INIT_LIST_HEAD
(&
h—d
->
’Œy_li¡
);

140 
	`INIT_LIST_HEAD
(&
h—d
->
£t_li¡
);

141 
h—d
->
£t
 = set;

142 
h—d
->
’Œy_út
 = 0;

144 ià(
	`¿dix_Œ“_š£¹
(&
nm_i
->
Çt_£t_roÙ
, 
£t
, 
h—d
)) {

145 
	`cÚd_»sched
();

146 
»Œy
;

149 
	`li¡_move_
(&
Ã
->
li¡
, &
h—d
->
’Œy_li¡
);

150 
nm_i
->
dœty_Çt_út
++;

151 
h—d
->
’Œy_út
++;

152 
	`£t_Çt_æag
(
Ã
, 
IS_DIRTY
, 
Œue
);

153 
	}
}

155 
	$__ş—r_Çt_ÿche_dœty
(
f2fs_nm_šfo
 *
nm_i
,

156 
Çt_’Œy
 *
Ã
)

158 
nid_t
 
£t
 = 
Ã
->
ni
.
nid
 / 
NAT_ENTRY_PER_BLOCK
;

159 
Çt_’Œy_£t
 *
h—d
;

161 
h—d
 = 
	`¿dix_Œ“_lookup
(&
nm_i
->
Çt_£t_roÙ
, 
£t
);

162 ià(
h—d
) {

163 
	`li¡_move_
(&
Ã
->
li¡
, &
nm_i
->
Çt_’Œ›s
);

164 
	`£t_Çt_æag
(
Ã
, 
IS_DIRTY
, 
çl£
);

165 
h—d
->
’Œy_út
--;

166 
nm_i
->
dœty_Çt_út
--;

168 
	}
}

170 
	$__gªg_lookup_Çt_£t
(
f2fs_nm_šfo
 *
nm_i
,

171 
nid_t
 
¡¬t
, 
Ä
, 
Çt_’Œy_£t
 **
•
)

173  
	`¿dix_Œ“_gªg_lookup
(&
nm_i
->
Çt_£t_roÙ
, (**)
•
,

174 
¡¬t
, 
Ä
);

175 
	}
}

177 
boŞ
 
	$is_checkpoš‹d_node
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
)

179 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

180 
Çt_’Œy
 *
e
;

181 
boŞ
 
is_ı
 = 
Œue
;

183 
	`»ad_lock
(&
nm_i
->
Çt_Œ“_lock
);

184 
e
 = 
	`__lookup_Çt_ÿche
(
nm_i
, 
nid
);

185 ià(
e
 && !
	`g‘_Çt_æag
Ó, 
IS_CHECKPOINTED
))

186 
is_ı
 = 
çl£
;

187 
	`»ad_uÆock
(&
nm_i
->
Çt_Œ“_lock
);

188  
is_ı
;

189 
	}
}

191 
boŞ
 
	$has_fsynûd_šode
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
)

193 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

194 
Çt_’Œy
 *
e
;

195 
boŞ
 
fsynûd
 = 
çl£
;

197 
	`»ad_lock
(&
nm_i
->
Çt_Œ“_lock
);

198 
e
 = 
	`__lookup_Çt_ÿche
(
nm_i
, 
šo
);

199 ià(
e
 && 
	`g‘_Çt_æag
Ó, 
HAS_FSYNCED_INODE
))

200 
fsynûd
 = 
Œue
;

201 
	`»ad_uÆock
(&
nm_i
->
Çt_Œ“_lock
);

202  
fsynûd
;

203 
	}
}

205 
boŞ
 
	$Ãed_šode_block_upd©e
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
)

207 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

208 
Çt_’Œy
 *
e
;

209 
boŞ
 
Ãed_upd©e
 = 
Œue
;

211 
	`»ad_lock
(&
nm_i
->
Çt_Œ“_lock
);

212 
e
 = 
	`__lookup_Çt_ÿche
(
nm_i
, 
šo
);

213 ià(
e
 && 
	`g‘_Çt_æag
Ó, 
HAS_LAST_FSYNC
) &&

214 (
	`g‘_Çt_æag
(
e
, 
IS_CHECKPOINTED
) ||

215 
	`g‘_Çt_æag
(
e
, 
HAS_FSYNCED_INODE
)))

216 
Ãed_upd©e
 = 
çl£
;

217 
	`»ad_uÆock
(&
nm_i
->
Çt_Œ“_lock
);

218  
Ãed_upd©e
;

219 
	}
}

221 
Çt_’Œy
 *
	$g¿b_Çt_’Œy
(
f2fs_nm_šfo
 *
nm_i
, 
nid_t
 
nid
)

223 
Çt_’Œy
 *
Ãw
;

225 
Ãw
 = 
	`kmem_ÿche_®loc
(
Çt_’Œy_¦ab
, 
GFP_ATOMIC
);

226 ià(!
Ãw
)

227  
NULL
;

228 ià(
	`¿dix_Œ“_š£¹
(&
nm_i
->
Çt_roÙ
, 
nid
, 
Ãw
)) {

229 
	`kmem_ÿche_ä“
(
Çt_’Œy_¦ab
, 
Ãw
);

230  
NULL
;

232 
	`mem£t
(
Ãw
, 0, (
Çt_’Œy
));

233 
	`Çt_£t_nid
(
Ãw
, 
nid
);

234 
	`Çt_»£t_æag
(
Ãw
);

235 
	`li¡_add_
(&
Ãw
->
li¡
, &
nm_i
->
Çt_’Œ›s
);

236 
nm_i
->
Çt_út
++;

237  
Ãw
;

238 
	}
}

240 
	$ÿche_Çt_’Œy
(
f2fs_nm_šfo
 *
nm_i
, 
nid_t
 
nid
,

241 
f2fs_Çt_’Œy
 *
Ã
)

243 
Çt_’Œy
 *
e
;

244 
»Œy
:

245 
	`wr™e_lock
(&
nm_i
->
Çt_Œ“_lock
);

246 
e
 = 
	`__lookup_Çt_ÿche
(
nm_i
, 
nid
);

247 ià(!
e
) {

248 
e
 = 
	`g¿b_Çt_’Œy
(
nm_i
, 
nid
);

249 ià(!
e
) {

250 
	`wr™e_uÆock
(&
nm_i
->
Çt_Œ“_lock
);

251 
»Œy
;

253 
	`node_šfo_äom_¿w_Çt
(&
e
->
ni
, 
Ã
);

255 
	`wr™e_uÆock
(&
nm_i
->
Çt_Œ“_lock
);

256 
	}
}

258 
	$£t_node_addr
(
f2fs_sb_šfo
 *
sbi
, 
node_šfo
 *
ni
,

259 
block_t
 
Ãw_blkaddr
, 
boŞ
 
fsync_dÚe
)

261 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

262 
Çt_’Œy
 *
e
;

263 
»Œy
:

264 
	`wr™e_lock
(&
nm_i
->
Çt_Œ“_lock
);

265 
e
 = 
	`__lookup_Çt_ÿche
(
nm_i
, 
ni
->
nid
);

266 ià(!
e
) {

267 
e
 = 
	`g¿b_Çt_’Œy
(
nm_i
, 
ni
->
nid
);

268 ià(!
e
) {

269 
	`wr™e_uÆock
(&
nm_i
->
Çt_Œ“_lock
);

270 
»Œy
;

272 
e
->
ni
 = *ni;

273 
	`f2fs_bug_Ú
(
sbi
, 
ni
->
blk_addr
 =ğ
NEW_ADDR
);

274 } ià(
Ãw_blkaddr
 =ğ
NEW_ADDR
) {

280 
e
->
ni
 = *ni;

281 
	`f2fs_bug_Ú
(
sbi
, 
ni
->
blk_addr
 !ğ
NULL_ADDR
);

285 
	`f2fs_bug_Ú
(
sbi
, 
	`Çt_g‘_blkaddr
(
e
è!ğ
ni
->
blk_addr
);

286 
	`f2fs_bug_Ú
(
sbi
, 
	`Çt_g‘_blkaddr
(
e
è=ğ
NULL_ADDR
 &&

287 
Ãw_blkaddr
 =ğ
NULL_ADDR
);

288 
	`f2fs_bug_Ú
(
sbi
, 
	`Çt_g‘_blkaddr
(
e
è=ğ
NEW_ADDR
 &&

289 
Ãw_blkaddr
 =ğ
NEW_ADDR
);

290 
	`f2fs_bug_Ú
(
sbi
, 
	`Çt_g‘_blkaddr
(
e
è!ğ
NEW_ADDR
 &&

291 
	`Çt_g‘_blkaddr
(
e
è!ğ
NULL_ADDR
 &&

292 
Ãw_blkaddr
 =ğ
NEW_ADDR
);

295 ià(
	`Çt_g‘_blkaddr
(
e
è!ğ
NEW_ADDR
 && 
Ãw_blkaddr
 =ğ
NULL_ADDR
) {

296 
v”siÚ
 = 
	`Çt_g‘_v”siÚ
(
e
);

297 
	`Çt_£t_v”siÚ
(
e
, 
	`šc_node_v”siÚ
(
v”siÚ
));

301 
	`Çt_£t_blkaddr
(
e
, 
Ãw_blkaddr
);

302 ià(
Ãw_blkaddr
 =ğ
NEW_ADDR
 ||‚ew_blkadd¸=ğ
NULL_ADDR
)

303 
	`£t_Çt_æag
(
e
, 
IS_CHECKPOINTED
, 
çl£
);

304 
	`__£t_Çt_ÿche_dœty
(
nm_i
, 
e
);

307 
e
 = 
	`__lookup_Çt_ÿche
(
nm_i
, 
ni
->
šo
);

308 ià(
e
) {

309 ià(
fsync_dÚe
 && 
ni
->
nid
 =ğni->
šo
)

310 
	`£t_Çt_æag
(
e
, 
HAS_FSYNCED_INODE
, 
Œue
);

311 
	`£t_Çt_æag
(
e
, 
HAS_LAST_FSYNC
, 
fsync_dÚe
);

313 
	`wr™e_uÆock
(&
nm_i
->
Çt_Œ“_lock
);

314 
	}
}

316 
	$Œy_to_ä“_Çts
(
f2fs_sb_šfo
 *
sbi
, 
Ä_shršk
)

318 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

320 ià(
	`avaabË_ä“_memÜy
(
sbi
, 
NAT_ENTRIES
))

323 
	`wr™e_lock
(&
nm_i
->
Çt_Œ“_lock
);

324 
Ä_shršk
 && !
	`li¡_em±y
(&
nm_i
->
Çt_’Œ›s
)) {

325 
Çt_’Œy
 *
Ã
;

326 
Ã
 = 
	`li¡_fœ¡_’Œy
(&
nm_i
->
Çt_’Œ›s
,

327 
Çt_’Œy
, 
li¡
);

328 
	`__d–_äom_Çt_ÿche
(
nm_i
, 
Ã
);

329 
Ä_shršk
--;

331 
	`wr™e_uÆock
(&
nm_i
->
Çt_Œ“_lock
);

332  
Ä_shršk
;

333 
	}
}

338 
	$g‘_node_šfo
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
, 
node_šfo
 *
ni
)

340 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

341 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
);

342 
f2fs_summ¬y_block
 *
sum
 = 
cur£g
->
sum_blk
;

343 
nid_t
 
¡¬t_nid
 = 
	`START_NID
(
nid
);

344 
f2fs_Çt_block
 *
Çt_blk
;

345 
·ge
 *·gğ
NULL
;

346 
f2fs_Çt_’Œy
 
Ã
;

347 
Çt_’Œy
 *
e
;

348 
i
;

350 
	`mem£t
(&
Ã
, 0, (
f2fs_Çt_’Œy
));

351 
ni
->
nid
 =‚id;

354 
	`»ad_lock
(&
nm_i
->
Çt_Œ“_lock
);

355 
e
 = 
	`__lookup_Çt_ÿche
(
nm_i
, 
nid
);

356 ià(
e
) {

357 
ni
->
šo
 = 
	`Çt_g‘_šo
(
e
);

358 
ni
->
blk_addr
 = 
	`Çt_g‘_blkaddr
(
e
);

359 
ni
->
v”siÚ
 = 
	`Çt_g‘_v”siÚ
(
e
);

361 
	`»ad_uÆock
(&
nm_i
->
Çt_Œ“_lock
);

362 ià(
e
)

366 
	`mu‹x_lock
(&
cur£g
->
cur£g_mu‹x
);

367 
i
 = 
	`lookup_jouº®_š_cursum
(
sum
, 
NAT_JOURNAL
, 
nid
, 0);

368 ià(
i
 >= 0) {

369 
Ã
 = 
	`Çt_š_jouº®
(
sum
, 
i
);

370 
	`node_šfo_äom_¿w_Çt
(
ni
, &
Ã
);

372 
	`mu‹x_uÆock
(&
cur£g
->
cur£g_mu‹x
);

373 ià(
i
 >= 0)

374 
ÿche
;

377 
·ge
 = 
	`g‘_cu¼’t_Çt_·ge
(
sbi
, 
¡¬t_nid
);

378 
Çt_blk
 = (
f2fs_Çt_block
 *)
	`·ge_add»ss
(
·ge
);

379 
Ã
 = 
Çt_blk
->
’Œ›s
[
nid
 - 
¡¬t_nid
];

380 
	`node_šfo_äom_¿w_Çt
(
ni
, &
Ã
);

381 
	`f2fs_put_·ge
(
·ge
, 1);

382 
ÿche
:

384 
	`ÿche_Çt_’Œy
(
	`NM_I
(
sbi
), 
nid
, &
Ã
);

385 
	}
}

391 
	$g‘_node_·th
(
f2fs_šode_šfo
 *
fi
, 
block
,

392 
off£t
[4], 
noff£t
[4])

394 cÚ¡ 
dœeù_šdex
 = 
	`ADDRS_PER_INODE
(
fi
);

395 cÚ¡ 
dœeù_blks
 = 
ADDRS_PER_BLOCK
;

396 cÚ¡ 
d±rs_³r_blk
 = 
NIDS_PER_BLOCK
;

397 cÚ¡ 
šdœeù_blks
 = 
ADDRS_PER_BLOCK
 * 
NIDS_PER_BLOCK
;

398 cÚ¡ 
dšdœeù_blks
 = 
šdœeù_blks
 * 
NIDS_PER_BLOCK
;

399 
n
 = 0;

400 
Ëv–
 = 0;

402 
noff£t
[0] = 0;

404 ià(
block
 < 
dœeù_šdex
) {

405 
off£t
[
n
] = 
block
;

406 
gÙ
;

408 
block
 -ğ
dœeù_šdex
;

409 ià(
block
 < 
dœeù_blks
) {

410 
off£t
[
n
++] = 
NODE_DIR1_BLOCK
;

411 
noff£t
[
n
] = 1;

412 
off£t
[
n
] = 
block
;

413 
Ëv–
 = 1;

414 
gÙ
;

416 
block
 -ğ
dœeù_blks
;

417 ià(
block
 < 
dœeù_blks
) {

418 
off£t
[
n
++] = 
NODE_DIR2_BLOCK
;

419 
noff£t
[
n
] = 2;

420 
off£t
[
n
] = 
block
;

421 
Ëv–
 = 1;

422 
gÙ
;

424 
block
 -ğ
dœeù_blks
;

425 ià(
block
 < 
šdœeù_blks
) {

426 
off£t
[
n
++] = 
NODE_IND1_BLOCK
;

427 
noff£t
[
n
] = 3;

428 
off£t
[
n
++] = 
block
 / 
dœeù_blks
;

429 
noff£t
[
n
] = 4 + 
off£t
[n - 1];

430 
off£t
[
n
] = 
block
 % 
dœeù_blks
;

431 
Ëv–
 = 2;

432 
gÙ
;

434 
block
 -ğ
šdœeù_blks
;

435 ià(
block
 < 
šdœeù_blks
) {

436 
off£t
[
n
++] = 
NODE_IND2_BLOCK
;

437 
noff£t
[
n
] = 4 + 
d±rs_³r_blk
;

438 
off£t
[
n
++] = 
block
 / 
dœeù_blks
;

439 
noff£t
[
n
] = 5 + 
d±rs_³r_blk
 + 
off£t
[n - 1];

440 
off£t
[
n
] = 
block
 % 
dœeù_blks
;

441 
Ëv–
 = 2;

442 
gÙ
;

444 
block
 -ğ
šdœeù_blks
;

445 ià(
block
 < 
dšdœeù_blks
) {

446 
off£t
[
n
++] = 
NODE_DIND_BLOCK
;

447 
noff£t
[
n
] = 5 + (
d±rs_³r_blk
 * 2);

448 
off£t
[
n
++] = 
block
 / 
šdœeù_blks
;

449 
noff£t
[
n
] = 6 + (
d±rs_³r_blk
 * 2) +

450 
off£t
[
n
 - 1] * (
d±rs_³r_blk
 + 1);

451 
off£t
[
n
++] = (
block
 / 
dœeù_blks
è% 
d±rs_³r_blk
;

452 
noff£t
[
n
] = 7 + (
d±rs_³r_blk
 * 2) +

453 
off£t
[
n
 - 2] * (
d±rs_³r_blk
 + 1) +

454 
off£t
[
n
 - 1];

455 
off£t
[
n
] = 
block
 % 
dœeù_blks
;

456 
Ëv–
 = 3;

457 
gÙ
;

459 
	`BUG
();

461 
gÙ
:

462  
Ëv–
;

463 
	}
}

471 
	$g‘_dnode_of_d©a
(
dnode_of_d©a
 *
dn
, 
pgoff_t
 
šdex
, 
mode
)

473 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dn
->
šode
);

474 
·ge
 *
Åage
[4];

475 
·ge
 *
·»Á
;

476 
off£t
[4];

477 
noff£t
[4];

478 
nid_t
 
nids
[4];

479 
Ëv–
, 
i
;

480 
”r
 = 0;

482 
Ëv–
 = 
	`g‘_node_·th
(
	`F2FS_I
(
dn
->
šode
), 
šdex
, 
off£t
, 
noff£t
);

484 
nids
[0] = 
dn
->
šode
->
i_šo
;

485 
Åage
[0] = 
dn
->
šode_·ge
;

487 ià(!
Åage
[0]) {

488 
Åage
[0] = 
	`g‘_node_·ge
(
sbi
, 
nids
[0]);

489 ià(
	`IS_ERR
(
Åage
[0]))

490  
	`PTR_ERR
(
Åage
[0]);

492 
·»Á
 = 
Åage
[0];

493 ià(
Ëv–
 != 0)

494 
nids
[1] = 
	`g‘_nid
(
·»Á
, 
off£t
[0], 
Œue
);

495 
dn
->
šode_·ge
 = 
Åage
[0];

496 
dn
->
šode_·ge_locked
 = 
Œue
;

499 
i
 = 1; i <ğ
Ëv–
; i++) {

500 
boŞ
 
dÚe
 = 
çl£
;

502 ià(!
nids
[
i
] && 
mode
 =ğ
ALLOC_NODE
) {

504 ià(!
	`®loc_nid
(
sbi
, &(
nids
[
i
]))) {

505 
”r
 = -
ENOSPC
;

506 
»Ëa£_·ges
;

509 
dn
->
nid
 = 
nids
[
i
];

510 
Åage
[
i
] = 
	`Ãw_node_·ge
(
dn
, 
noff£t
[i], 
NULL
);

511 ià(
	`IS_ERR
(
Åage
[
i
])) {

512 
	`®loc_nid_çed
(
sbi
, 
nids
[
i
]);

513 
”r
 = 
	`PTR_ERR
(
Åage
[
i
]);

514 
»Ëa£_·ges
;

517 
	`£t_nid
(
·»Á
, 
off£t
[
i
 - 1], 
nids
[i], i == 1);

518 
	`®loc_nid_dÚe
(
sbi
, 
nids
[
i
]);

519 
dÚe
 = 
Œue
;

520 } ià(
mode
 =ğ
LOOKUP_NODE_RA
 && 
i
 =ğ
Ëv–
 &&†evel > 1) {

521 
Åage
[
i
] = 
	`g‘_node_·ge_¿
(
·»Á
, 
off£t
[i - 1]);

522 ià(
	`IS_ERR
(
Åage
[
i
])) {

523 
”r
 = 
	`PTR_ERR
(
Åage
[
i
]);

524 
»Ëa£_·ges
;

526 
dÚe
 = 
Œue
;

528 ià(
i
 == 1) {

529 
dn
->
šode_·ge_locked
 = 
çl£
;

530 
	`uÆock_·ge
(
·»Á
);

532 
	`f2fs_put_·ge
(
·»Á
, 1);

535 ià(!
dÚe
) {

536 
Åage
[
i
] = 
	`g‘_node_·ge
(
sbi
, 
nids
[i]);

537 ià(
	`IS_ERR
(
Åage
[
i
])) {

538 
”r
 = 
	`PTR_ERR
(
Åage
[
i
]);

539 
	`f2fs_put_·ge
(
Åage
[0], 0);

540 
»Ëa£_out
;

543 ià(
i
 < 
Ëv–
) {

544 
·»Á
 = 
Åage
[
i
];

545 
nids
[
i
 + 1] = 
	`g‘_nid
(
·»Á
, 
off£t
[i], 
çl£
);

548 
dn
->
nid
 = 
nids
[
Ëv–
];

549 
dn
->
ofs_š_node
 = 
off£t
[
Ëv–
];

550 
dn
->
node_·ge
 = 
Åage
[
Ëv–
];

551 
dn
->
d©a_blkaddr
 = 
	`d©ablock_addr
(dn->
node_·ge
, dn->
ofs_š_node
);

554 
»Ëa£_·ges
:

555 
	`f2fs_put_·ge
(
·»Á
, 1);

556 ià(
i
 > 1)

557 
	`f2fs_put_·ge
(
Åage
[0], 0);

558 
»Ëa£_out
:

559 
dn
->
šode_·ge
 = 
NULL
;

560 
dn
->
node_·ge
 = 
NULL
;

561  
”r
;

562 
	}
}

564 
	$Œunÿ‹_node
(
dnode_of_d©a
 *
dn
)

566 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dn
->
šode
);

567 
node_šfo
 
ni
;

569 
	`g‘_node_šfo
(
sbi
, 
dn
->
nid
, &
ni
);

570 ià(
dn
->
šode
->
i_blocks
 == 0) {

571 
	`f2fs_bug_Ú
(
sbi
, 
ni
.
blk_addr
 !ğ
NULL_ADDR
);

572 
šv®id©e
;

574 
	`f2fs_bug_Ú
(
sbi
, 
ni
.
blk_addr
 =ğ
NULL_ADDR
);

577 
	`šv®id©e_blocks
(
sbi
, 
ni
.
blk_addr
);

578 
	`dec_v®id_node_couÁ
(
sbi
, 
dn
->
šode
);

579 
	`£t_node_addr
(
sbi
, &
ni
, 
NULL_ADDR
, 
çl£
);

581 ià(
dn
->
nid
 =ğdn->
šode
->
i_šo
) {

582 
	`»move_Üphª_šode
(
sbi
, 
dn
->
nid
);

583 
	`dec_v®id_šode_couÁ
(
sbi
);

585 
	`sync_šode_·ge
(
dn
);

587 
šv®id©e
:

588 
	`ş—r_node_·ge_dœty
(
dn
->
node_·ge
);

589 
	`F2FS_SET_SB_DIRT
(
sbi
);

591 
	`f2fs_put_·ge
(
dn
->
node_·ge
, 1);

593 
	`šv®id©e_m­pšg_·ges
(
	`NODE_MAPPING
(
sbi
),

594 
dn
->
node_·ge
->
šdex
, dn->node_page->index);

596 
dn
->
node_·ge
 = 
NULL
;

597 
	`Œaû_f2fs_Œunÿ‹_node
(
dn
->
šode
, dn->
nid
, 
ni
.
blk_addr
);

598 
	}
}

600 
	$Œunÿ‹_dnode
(
dnode_of_d©a
 *
dn
)

602 
·ge
 *page;

604 ià(
dn
->
nid
 == 0)

608 
·ge
 = 
	`g‘_node_·ge
(
	`F2FS_I_SB
(
dn
->
šode
), dn->
nid
);

609 ià(
	`IS_ERR
(
·ge
è&& 
	`PTR_ERR
Õageè=ğ-
ENOENT
)

611 ià(
	`IS_ERR
(
·ge
))

612  
	`PTR_ERR
(
·ge
);

615 
dn
->
node_·ge
 = 
·ge
;

616 
dn
->
ofs_š_node
 = 0;

617 
	`Œunÿ‹_d©a_blocks
(
dn
);

618 
	`Œunÿ‹_node
(
dn
);

620 
	}
}

622 
	$Œunÿ‹_nodes
(
dnode_of_d©a
 *
dn
, 
nofs
,

623 
ofs
, 
d•th
)

625 
dnode_of_d©a
 
rdn
 = *
dn
;

626 
·ge
 *page;

627 
f2fs_node
 *
º
;

628 
nid_t
 
chd_nid
;

629 
chd_nofs
;

630 
ä“d
 = 0;

631 
i
, 
»t
;

633 ià(
dn
->
nid
 == 0)

634  
NIDS_PER_BLOCK
 + 1;

636 
	`Œaû_f2fs_Œunÿ‹_nodes_’‹r
(
dn
->
šode
, dn->
nid
, dn->
d©a_blkaddr
);

638 
·ge
 = 
	`g‘_node_·ge
(
	`F2FS_I_SB
(
dn
->
šode
), dn->
nid
);

639 ià(
	`IS_ERR
(
·ge
)) {

640 
	`Œaû_f2fs_Œunÿ‹_nodes_ex™
(
dn
->
šode
, 
	`PTR_ERR
(
·ge
));

641  
	`PTR_ERR
(
·ge
);

644 
º
 = 
	`F2FS_NODE
(
·ge
);

645 ià(
d•th
 < 3) {

646 
i
 = 
ofs
; i < 
NIDS_PER_BLOCK
; i++, 
ä“d
++) {

647 
chd_nid
 = 
	`Ë32_to_ıu
(
º
->
š
.
nid
[
i
]);

648 ià(
chd_nid
 == 0)

650 
rdn
.
nid
 = 
chd_nid
;

651 
»t
 = 
	`Œunÿ‹_dnode
(&
rdn
);

652 ià(
»t
 < 0)

653 
out_”r
;

654 
	`£t_nid
(
·ge
, 
i
, 0, 
çl£
);

657 
chd_nofs
 = 
nofs
 + 
ofs
 * (
NIDS_PER_BLOCK
 + 1) + 1;

658 
i
 = 
ofs
; i < 
NIDS_PER_BLOCK
; i++) {

659 
chd_nid
 = 
	`Ë32_to_ıu
(
º
->
š
.
nid
[
i
]);

660 ià(
chd_nid
 == 0) {

661 
chd_nofs
 +ğ
NIDS_PER_BLOCK
 + 1;

664 
rdn
.
nid
 = 
chd_nid
;

665 
»t
 = 
	`Œunÿ‹_nodes
(&
rdn
, 
chd_nofs
, 0, 
d•th
 - 1);

666 ià(
»t
 =ğ(
NIDS_PER_BLOCK
 + 1)) {

667 
	`£t_nid
(
·ge
, 
i
, 0, 
çl£
);

668 
chd_nofs
 +ğ
»t
;

669 } ià(
»t
 < 0 &&„‘ !ğ-
ENOENT
) {

670 
out_”r
;

673 
ä“d
 = 
chd_nofs
;

676 ià(!
ofs
) {

678 
dn
->
node_·ge
 = 
·ge
;

679 
	`Œunÿ‹_node
(
dn
);

680 
ä“d
++;

682 
	`f2fs_put_·ge
(
·ge
, 1);

684 
	`Œaû_f2fs_Œunÿ‹_nodes_ex™
(
dn
->
šode
, 
ä“d
);

685  
ä“d
;

687 
out_”r
:

688 
	`f2fs_put_·ge
(
·ge
, 1);

689 
	`Œaû_f2fs_Œunÿ‹_nodes_ex™
(
dn
->
šode
, 
»t
);

690  
»t
;

691 
	}
}

693 
	$Œunÿ‹_·¹Ÿl_nodes
(
dnode_of_d©a
 *
dn
,

694 
f2fs_šode
 *
ri
, *
off£t
, 
d•th
)

696 
·ge
 *
·ges
[2];

697 
nid_t
 
nid
[3];

698 
nid_t
 
chd_nid
;

699 
”r
 = 0;

700 
i
;

701 
idx
 = 
d•th
 - 2;

703 
nid
[0] = 
	`Ë32_to_ıu
(
ri
->
i_nid
[
off£t
[0] - 
NODE_DIR1_BLOCK
]);

704 ià(!
nid
[0])

708 
i
 = 0; i < 
idx
 + 1; i++) {

710 
·ges
[
i
] = 
	`g‘_node_·ge
(
	`F2FS_I_SB
(
dn
->
šode
), 
nid
[i]);

711 ià(
	`IS_ERR
(
·ges
[
i
])) {

712 
”r
 = 
	`PTR_ERR
(
·ges
[
i
]);

713 
idx
 = 
i
 - 1;

714 
ç
;

716 
nid
[
i
 + 1] = 
	`g‘_nid
(
·ges
[i], 
off£t
[˜+ 1], 
çl£
);

720 
i
 = 
off£t
[
idx
 + 1]; i < 
NIDS_PER_BLOCK
; i++) {

721 
chd_nid
 = 
	`g‘_nid
(
·ges
[
idx
], 
i
, 
çl£
);

722 ià(!
chd_nid
)

724 
dn
->
nid
 = 
chd_nid
;

725 
”r
 = 
	`Œunÿ‹_dnode
(
dn
);

726 ià(
”r
 < 0)

727 
ç
;

728 
	`£t_nid
(
·ges
[
idx
], 
i
, 0, 
çl£
);

731 ià(
off£t
[
idx
 + 1] == 0) {

732 
dn
->
node_·ge
 = 
·ges
[
idx
];

733 
dn
->
nid
 =‚id[
idx
];

734 
	`Œunÿ‹_node
(
dn
);

736 
	`f2fs_put_·ge
(
·ges
[
idx
], 1);

738 
off£t
[
idx
]++;

739 
off£t
[
idx
 + 1] = 0;

740 
idx
--;

741 
ç
:

742 
i
 = 
idx
; i >= 0; i--)

743 
	`f2fs_put_·ge
(
·ges
[
i
], 1);

745 
	`Œaû_f2fs_Œunÿ‹_·¹Ÿl_nodes
(
dn
->
šode
, 
nid
, 
d•th
, 
”r
);

747  
”r
;

748 
	}
}

753 
	$Œunÿ‹_šode_blocks
(
šode
 *šode, 
pgoff_t
 
äom
)

755 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

756 
”r
 = 0, 
cÚt
 = 1;

757 
Ëv–
, 
off£t
[4], 
noff£t
[4];

758 
nofs
 = 0;

759 
f2fs_šode
 *
ri
;

760 
dnode_of_d©a
 
dn
;

761 
·ge
 *page;

763 
	`Œaû_f2fs_Œunÿ‹_šode_blocks_’‹r
(
šode
, 
äom
);

765 
Ëv–
 = 
	`g‘_node_·th
(
	`F2FS_I
(
šode
), 
äom
, 
off£t
, 
noff£t
);

766 
»¡¬t
:

767 
·ge
 = 
	`g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

768 ià(
	`IS_ERR
(
·ge
)) {

769 
	`Œaû_f2fs_Œunÿ‹_šode_blocks_ex™
(
šode
, 
	`PTR_ERR
(
·ge
));

770  
	`PTR_ERR
(
·ge
);

773 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
·ge
, 
NULL
, 0);

774 
	`uÆock_·ge
(
·ge
);

776 
ri
 = 
	`F2FS_INODE
(
·ge
);

777 
Ëv–
) {

780 
nofs
 = 
noff£t
[1];

783 
nofs
 = 
noff£t
[1];

784 ià(!
off£t
[
Ëv–
 - 1])

785 
sk_·¹Ÿl
;

786 
”r
 = 
	`Œunÿ‹_·¹Ÿl_nodes
(&
dn
, 
ri
, 
off£t
, 
Ëv–
);

787 ià(
”r
 < 0 &&ƒ¼ !ğ-
ENOENT
)

788 
ç
;

789 
nofs
 +ğ1 + 
NIDS_PER_BLOCK
;

792 
nofs
 = 5 + 2 * 
NIDS_PER_BLOCK
;

793 ià(!
off£t
[
Ëv–
 - 1])

794 
sk_·¹Ÿl
;

795 
”r
 = 
	`Œunÿ‹_·¹Ÿl_nodes
(&
dn
, 
ri
, 
off£t
, 
Ëv–
);

796 ià(
”r
 < 0 &&ƒ¼ !ğ-
ENOENT
)

797 
ç
;

800 
	`BUG
();

803 
sk_·¹Ÿl
:

804 
cÚt
) {

805 
dn
.
nid
 = 
	`Ë32_to_ıu
(
ri
->
i_nid
[
off£t
[0] - 
NODE_DIR1_BLOCK
]);

806 
off£t
[0]) {

807 
NODE_DIR1_BLOCK
:

808 
NODE_DIR2_BLOCK
:

809 
”r
 = 
	`Œunÿ‹_dnode
(&
dn
);

812 
NODE_IND1_BLOCK
:

813 
NODE_IND2_BLOCK
:

814 
”r
 = 
	`Œunÿ‹_nodes
(&
dn
, 
nofs
, 
off£t
[1], 2);

817 
NODE_DIND_BLOCK
:

818 
”r
 = 
	`Œunÿ‹_nodes
(&
dn
, 
nofs
, 
off£t
[1], 3);

819 
cÚt
 = 0;

823 
	`BUG
();

825 ià(
”r
 < 0 &&ƒ¼ !ğ-
ENOENT
)

826 
ç
;

827 ià(
off£t
[1] == 0 &&

828 
ri
->
i_nid
[
off£t
[0] - 
NODE_DIR1_BLOCK
]) {

829 
	`lock_·ge
(
·ge
);

830 ià(
	`uÆik–y
(
·ge
->
m­pšg
 !ğ
	`NODE_MAPPING
(
sbi
))) {

831 
	`f2fs_put_·ge
(
·ge
, 1);

832 
»¡¬t
;

834 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
NODE
);

835 
ri
->
i_nid
[
off£t
[0] - 
NODE_DIR1_BLOCK
] = 0;

836 
	`£t_·ge_dœty
(
·ge
);

837 
	`uÆock_·ge
(
·ge
);

839 
off£t
[1] = 0;

840 
off£t
[0]++;

841 
nofs
 +ğ
”r
;

843 
ç
:

844 
	`f2fs_put_·ge
(
·ge
, 0);

845 
	`Œaû_f2fs_Œunÿ‹_šode_blocks_ex™
(
šode
, 
”r
);

846  
”r
 > 0 ? 0 :ƒrr;

847 
	}
}

849 
	$Œunÿ‹_x©Œ_node
(
šode
 *šode, 
·ge
 *page)

851 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

852 
nid_t
 
nid
 = 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
;

853 
dnode_of_d©a
 
dn
;

854 
·ge
 *
Åage
;

856 ià(!
nid
)

859 
Åage
 = 
	`g‘_node_·ge
(
sbi
, 
nid
);

860 ià(
	`IS_ERR
(
Åage
))

861  
	`PTR_ERR
(
Åage
);

863 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
 = 0;

866 
	`F2FS_I
(
šode
)->
x©Œ_v”
 = 
	`cur_ı_v”siÚ
(
	`F2FS_CKPT
(
sbi
));

868 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
·ge
, 
Åage
, 
nid
);

870 ià(
·ge
)

871 
dn
.
šode_·ge_locked
 = 
Œue
;

872 
	`Œunÿ‹_node
(&
dn
);

874 
	}
}

880 
	$»move_šode_·ge
(
šode
 *inode)

882 
dnode_of_d©a
 
dn
;

884 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, inode->
i_šo
);

885 ià(
	`g‘_dnode_of_d©a
(&
dn
, 0, 
LOOKUP_NODE
))

888 ià(
	`Œunÿ‹_x©Œ_node
(
šode
, 
dn
.
šode_·ge
)) {

889 
	`f2fs_put_dnode
(&
dn
);

894 ià(
	`S_ISREG
(
šode
->
i_mode
è|| 
	`S_ISDIR
(inode->i_mode) ||

895 
	`S_ISLNK
(
šode
->
i_mode
))

896 
	`Œunÿ‹_d©a_blocks_¿nge
(&
dn
, 1);

899 
	`f2fs_bug_Ú
(
	`F2FS_I_SB
(
šode
),

900 
šode
->
i_blocks
 != 0 && inode->i_blocks != 1);

903 
	`Œunÿ‹_node
(&
dn
);

904 
	}
}

906 
·ge
 *
	$Ãw_šode_·ge
(
šode
 *inode)

908 
dnode_of_d©a
 
dn
;

911 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, inode->
i_šo
);

914  
	`Ãw_node_·ge
(&
dn
, 0, 
NULL
);

915 
	}
}

917 
·ge
 *
	$Ãw_node_·ge
(
dnode_of_d©a
 *
dn
,

918 
ofs
, 
·ge
 *
age
)

920 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dn
->
šode
);

921 
node_šfo
 
Şd_ni
, 
Ãw_ni
;

922 
·ge
 *page;

923 
”r
;

925 ià(
	`uÆik–y
(
	`is_šode_æag_£t
(
	`F2FS_I
(
dn
->
šode
), 
FI_NO_ALLOC
)))

926  
	`ERR_PTR
(-
EPERM
);

928 
·ge
 = 
	`g¿b_ÿche_·ge
(
	`NODE_MAPPING
(
sbi
), 
dn
->
nid
);

929 ià(!
·ge
)

930  
	`ERR_PTR
(-
ENOMEM
);

932 ià(
	`uÆik–y
(!
	`šc_v®id_node_couÁ
(
sbi
, 
dn
->
šode
))) {

933 
”r
 = -
ENOSPC
;

934 
ç
;

937 
	`g‘_node_šfo
(
sbi
, 
dn
->
nid
, &
Şd_ni
);

940 
	`f2fs_bug_Ú
(
sbi
, 
Şd_ni
.
blk_addr
 !ğ
NULL_ADDR
);

941 
Ãw_ni
 = 
Şd_ni
;

942 
Ãw_ni
.
šo
 = 
dn
->
šode
->
i_šo
;

943 
	`£t_node_addr
(
sbi
, &
Ãw_ni
, 
NEW_ADDR
, 
çl£
);

945 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
NODE
);

946 
	`fl_node_foÙ”
(
·ge
, 
dn
->
nid
, dn->
šode
->
i_šo
, 
ofs
, 
Œue
);

947 
	`£t_cŞd_node
(
dn
->
šode
, 
·ge
);

948 
	`S‘PageU±od©e
(
·ge
);

949 
	`£t_·ge_dœty
(
·ge
);

951 ià(
	`f2fs_has_x©Œ_block
(
ofs
))

952 
	`F2FS_I
(
dn
->
šode
)->
i_x©Œ_nid
 = dn->
nid
;

954 
dn
->
node_·ge
 = 
·ge
;

955 ià(
age
)

956 
	`upd©e_šode
(
dn
->
šode
, 
age
);

958 
	`sync_šode_·ge
(
dn
);

959 ià(
ofs
 == 0)

960 
	`šc_v®id_šode_couÁ
(
sbi
);

962  
·ge
;

964 
ç
:

965 
	`ş—r_node_·ge_dœty
(
·ge
);

966 
	`f2fs_put_·ge
(
·ge
, 1);

967  
	`ERR_PTR
(
”r
);

968 
	}
}

976 
	$»ad_node_·ge
(
·ge
 *·ge, 
rw
)

978 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_P_SB
(
·ge
);

979 
node_šfo
 
ni
;

981 
	`g‘_node_šfo
(
sbi
, 
·ge
->
šdex
, &
ni
);

983 ià(
	`uÆik–y
(
ni
.
blk_addr
 =ğ
NULL_ADDR
)) {

984 
	`f2fs_put_·ge
(
·ge
, 1);

985  -
ENOENT
;

988 #ifdeà
F2FS_DA_MAP_DBG


992 ià(
	`PageU±od©e
(
·ge
))

993  
LOCKED_PAGE
;

995  
	`f2fs_subm™_·ge_bio
(
sbi
, 
·ge
, 
ni
.
blk_addr
, 
rw
);

996 
	}
}

1001 
	$¿_node_·ge
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
)

1003 
·ge
 *
­age
;

1004 
”r
;

1006 
­age
 = 
	`fšd_g‘_·ge
(
	`NODE_MAPPING
(
sbi
), 
nid
);

1007 ià(
­age
 && 
	`PageU±od©e
(apage)) {

1008 
	`f2fs_put_·ge
(
­age
, 0);

1011 
	`f2fs_put_·ge
(
­age
, 0);

1013 
­age
 = 
	`g¿b_ÿche_·ge
(
	`NODE_MAPPING
(
sbi
), 
nid
);

1014 ià(!
­age
)

1017 
”r
 = 
	`»ad_node_·ge
(
­age
, 
READA
);

1018 ià(
”r
 == 0)

1019 
	`f2fs_put_·ge
(
­age
, 0);

1020 ià(
”r
 =ğ
LOCKED_PAGE
)

1021 
	`f2fs_put_·ge
(
­age
, 1);

1022 
	}
}

1024 
·ge
 *
	$g‘_node_·ge
(
f2fs_sb_šfo
 *
sbi
, 
pgoff_t
 
nid
)

1026 
·ge
 *page;

1027 
”r
;

1029 #ifdeà
F2FS_DA_MAP


1030 
pgoff_t
 
‹mp_nid
 = 
nid
;

1033 #ifdeà
F2FS_DA_MAP_DBG


1034 
f2fs_node
 *
º
;

1037 
»³©
:

1039 #ifdeà
F2FS_DA_MAP


1040 
·ge
 = 
	`g¿b_ÿche_·ge
(
	`NODE_MAPPING
(
sbi
), 
‹mp_nid
);

1042 
·ge
 = 
	`g¿b_ÿche_·ge
(
	`NODE_MAPPING
(
sbi
), 
nid
);

1045 ià(!
·ge
)

1046  
	`ERR_PTR
(-
ENOMEM
);

1048 
”r
 = 
	`»ad_node_·ge
(
·ge
, 
READ_SYNC
);

1049 ià(
”r
 < 0)

1050  
	`ERR_PTR
(
”r
);

1051 ià(
”r
 =ğ
LOCKED_PAGE
)

1052 
gÙ_™
;

1054 
	`lock_·ge
(
·ge
);

1056 #ifdeà
F2FS_DA_MAP


1057 if(
	`nid_of_node
(
·ge
) == -1){

1059 #ifdeà
F2FS_DA_MAP_DBG


1060 
	`´štk
("[g‘_node]‚id_of_·gi -1, gÙØ»³© [nid: %lu]\n", 
‹mp_nid
);

1062 
‹mp_nid
++;

1063 
	`f2fs_put_·ge
(
·ge
, 1);

1064 
»³©
;

1068 ià(
	`uÆik–y
(!
	`PageU±od©e
(
·ge
è|| 
nid
 !ğ
	`nid_of_node
(page))) {

1070 #ifdeà
F2FS_DA_MAP_DBG


1071 
	`´štk
("[g‘_node] h”3. %d %lu %d %p\n", 
	`PageU±od©e
(
·ge
), 
nid
, 
	`nid_of_node
(page),…age);

1072 
º
 = 
	`F2FS_NODE
(
·ge
);

1073 
	`´štk
("[g‘_node] h”3-1. %d %d %d\n", 
º
->
foÙ”
.
šo
,„n->foÙ”.
ı_v”
,„n->foÙ”.
Ãxt_blkaddr
);

1076 
	`f2fs_put_·ge
(
·ge
, 1);

1077  
	`ERR_PTR
(-
EIO
);

1079 ià(
	`uÆik–y
(
·ge
->
m­pšg
 !ğ
	`NODE_MAPPING
(
sbi
))) {

1080 
	`f2fs_put_·ge
(
·ge
, 1);

1081 
»³©
;

1083 
gÙ_™
:

1084  
·ge
;

1085 
	}
}

1091 
·ge
 *
	$g‘_node_·ge_¿
(
·ge
 *
·»Á
, 
¡¬t
)

1093 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_P_SB
(
·»Á
);

1094 
blk_¶ug
 
¶ug
;

1095 
·ge
 *page;

1096 
”r
, 
i
, 
’d
;

1097 
nid_t
 
nid
;

1100 
nid
 = 
	`g‘_nid
(
·»Á
, 
¡¬t
, 
çl£
);

1101 ià(!
nid
)

1102  
	`ERR_PTR
(-
ENOENT
);

1103 
»³©
:

1104 
·ge
 = 
	`g¿b_ÿche_·ge
(
	`NODE_MAPPING
(
sbi
), 
nid
);

1105 ià(!
·ge
)

1106  
	`ERR_PTR
(-
ENOMEM
);

1108 
”r
 = 
	`»ad_node_·ge
(
·ge
, 
READ_SYNC
);

1109 ià(
”r
 < 0)

1110  
	`ERR_PTR
(
”r
);

1111 ià(
”r
 =ğ
LOCKED_PAGE
)

1112 
·ge_h™
;

1114 
	`blk_¡¬t_¶ug
(&
¶ug
);

1117 
’d
 = 
¡¬t
 + 
MAX_RA_NODE
;

1118 
’d
 = 
	`mš
Ónd, 
NIDS_PER_BLOCK
);

1119 
i
 = 
¡¬t
 + 1; i < 
’d
; i++) {

1120 
nid
 = 
	`g‘_nid
(
·»Á
, 
i
, 
çl£
);

1121 ià(!
nid
)

1123 
	`¿_node_·ge
(
sbi
, 
nid
);

1126 
	`blk_fšish_¶ug
(&
¶ug
);

1128 
	`lock_·ge
(
·ge
);

1129 ià(
	`uÆik–y
(
·ge
->
m­pšg
 !ğ
	`NODE_MAPPING
(
sbi
))) {

1130 
	`f2fs_put_·ge
(
·ge
, 1);

1131 
»³©
;

1133 
·ge_h™
:

1134 ià(
	`uÆik–y
(!
	`PageU±od©e
(
·ge
))) {

1135 
	`f2fs_put_·ge
(
·ge
, 1);

1136  
	`ERR_PTR
(-
EIO
);

1138  
·ge
;

1139 
	}
}

1141 
	$sync_šode_·ge
(
dnode_of_d©a
 *
dn
)

1143 ià(
	`IS_INODE
(
dn
->
node_·ge
è|| dn->
šode_·ge
 == dn->node_page) {

1144 
	`upd©e_šode
(
dn
->
šode
, dn->
node_·ge
);

1145 } ià(
dn
->
šode_·ge
) {

1146 ià(!
dn
->
šode_·ge_locked
)

1147 
	`lock_·ge
(
dn
->
šode_·ge
);

1148 
	`upd©e_šode
(
dn
->
šode
, dn->
šode_·ge
);

1149 ià(!
dn
->
šode_·ge_locked
)

1150 
	`uÆock_·ge
(
dn
->
šode_·ge
);

1152 
	`upd©e_šode_·ge
(
dn
->
šode
);

1154 
	}
}

1156 
	$sync_node_·ges
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
,

1157 
wr™eback_cÚŒŞ
 *
wbc
)

1159 
pgoff_t
 
šdex
, 
’d
;

1160 
·gevec
 
pvec
;

1161 
¡•
 = 
šo
 ? 2 : 0;

1162 
nwr™‹n
 = 0, 
wrÙe
 = 0;

1164 
	`·gevec_š™
(&
pvec
, 0);

1166 
Ãxt_¡•
:

1167 
šdex
 = 0;

1168 
’d
 = 
LONG_MAX
;

1170 
šdex
 <ğ
’d
) {

1171 
i
, 
Ä_·ges
;

1172 
Ä_·ges
 = 
	`·gevec_lookup_g
(&
pvec
, 
	`NODE_MAPPING
(
sbi
), &
šdex
,

1173 
PAGECACHE_TAG_DIRTY
,

1174 
	`mš
(
’d
 - 
šdex
, (
pgoff_t
)
PAGEVEC_SIZE
-1) + 1);

1175 ià(
Ä_·ges
 == 0)

1178 
i
 = 0; i < 
Ä_·ges
; i++) {

1179 
·ge
 *·gğ
pvec
.
·ges
[
i
];

1187 ià(
¡•
 =ğ0 && 
	`IS_DNODE
(
·ge
))

1189 ià(
¡•
 =ğ1 && (!
	`IS_DNODE
(
·ge
) ||

1190 
	`is_cŞd_node
(
·ge
)))

1192 ià(
¡•
 =ğ2 && (!
	`IS_DNODE
(
·ge
) ||

1193 !
	`is_cŞd_node
(
·ge
)))

1200 ià(
šo
 && 
	`šo_of_node
(
·ge
) == ino)

1201 
	`lock_·ge
(
·ge
);

1202 ià(!
	`Œylock_·ge
(
·ge
))

1205 ià(
	`uÆik–y
(
·ge
->
m­pšg
 !ğ
	`NODE_MAPPING
(
sbi
))) {

1206 
cÚtšue_uÆock
:

1207 
	`uÆock_·ge
(
·ge
);

1210 ià(
šo
 && 
	`šo_of_node
(
·ge
) != ino)

1211 
cÚtšue_uÆock
;

1213 ià(!
	`PageDœty
(
·ge
)) {

1215 
cÚtšue_uÆock
;

1218 ià(!
	`ş—r_·ge_dœty_fÜ_io
(
·ge
))

1219 
cÚtšue_uÆock
;

1222 ià(
šo
 && 
	`IS_DNODE
(
·ge
)) {

1223 
	`£t_fsync_m¬k
(
·ge
, 1);

1224 ià(
	`IS_INODE
(
·ge
)) {

1225 ià(!
	`is_checkpoš‹d_node
(
sbi
, 
šo
) &&

1226 !
	`has_fsynûd_šode
(
sbi
, 
šo
))

1227 
	`£t_d’Œy_m¬k
(
·ge
, 1);

1229 
	`£t_d’Œy_m¬k
(
·ge
, 0);

1231 
nwr™‹n
++;

1233 
	`£t_fsync_m¬k
(
·ge
, 0);

1234 
	`£t_d’Œy_m¬k
(
·ge
, 0);

1237 ià(
	`NODE_MAPPING
(
sbi
)->
a_İs
->
	`wr™•age
(
·ge
, 
wbc
))

1238 
	`uÆock_·ge
(
·ge
);

1240 
wrÙe
++;

1242 ià(--
wbc
->
Ä_to_wr™e
 == 0)

1245 
	`·gevec_»Ëa£
(&
pvec
);

1246 
	`cÚd_»sched
();

1248 ià(
wbc
->
Ä_to_wr™e
 == 0) {

1249 
¡•
 = 2;

1254 ià(
¡•
 < 2) {

1255 
¡•
++;

1256 
Ãxt_¡•
;

1259 ià(
wrÙe
){

1260 
	`f2fs_subm™_m”ged_bio
(
sbi
, 
NODE
, 
WRITE
);

1263  
nwr™‹n
;

1264 
	}
}

1266 
	$wa™_Ú_node_·ges_wr™eback
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
šo
)

1268 
pgoff_t
 
šdex
 = 0, 
’d
 = 
LONG_MAX
;

1269 
·gevec
 
pvec
;

1270 
»t2
 = 0, 
»t
 = 0;

1272 
	`·gevec_š™
(&
pvec
, 0);

1274 
šdex
 <ğ
’d
) {

1275 
i
, 
Ä_·ges
;

1276 
Ä_·ges
 = 
	`·gevec_lookup_g
(&
pvec
, 
	`NODE_MAPPING
(
sbi
), &
šdex
,

1277 
PAGECACHE_TAG_WRITEBACK
,

1278 
	`mš
(
’d
 - 
šdex
, (
pgoff_t
)
PAGEVEC_SIZE
-1) + 1);

1279 ià(
Ä_·ges
 == 0)

1282 
i
 = 0; i < 
Ä_·ges
; i++) {

1283 
·ge
 *·gğ
pvec
.
·ges
[
i
];

1286 ià(
	`uÆik–y
(
·ge
->
šdex
 > 
’d
))

1289 ià(
šo
 && 
	`šo_of_node
(
·ge
) == ino) {

1290 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
NODE
);

1291 ià(
	`Te¡CË¬PageE¼Ü
(
·ge
))

1292 
»t
 = -
EIO
;

1295 
	`·gevec_»Ëa£
(&
pvec
);

1296 
	`cÚd_»sched
();

1299 ià(
	`uÆik–y
(
	`‹¡_ªd_ş—r_b™
(
AS_ENOSPC
, &
	`NODE_MAPPING
(
sbi
)->
æags
)))

1300 
»t2
 = -
ENOSPC
;

1301 ià(
	`uÆik–y
(
	`‹¡_ªd_ş—r_b™
(
AS_EIO
, &
	`NODE_MAPPING
(
sbi
)->
æags
)))

1302 
»t2
 = -
EIO
;

1303 ià(!
»t
)

1304 
»t
 = 
»t2
;

1305  
»t
;

1306 
	}
}

1308 
	$f2fs_wr™e_node_·ge
(
·ge
 *page,

1309 
wr™eback_cÚŒŞ
 *
wbc
)

1311 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_P_SB
(
·ge
);

1312 
nid_t
 
nid
;

1313 
block_t
 
Ãw_addr
;

1314 
node_šfo
 
ni
;

1315 
f2fs_io_šfo
 
fio
 = {

1316 .
ty³
 = 
NODE
,

1317 .
rw
 = (
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
è? 
WRITE_SYNC
 : 
WRITE
,

1320 #ifdeà
F2FS_DA_MAP


1321 if(
F2FS_PLUG_ON
 =ğ
Œue
)

1322 
fio
.
rw
 = 
WRITE_SYNC
;

1325 
	`Œaû_f2fs_wr™•age
(
·ge
, 
NODE
);

1327 ià(
	`uÆik–y
(
sbi
->
pÜ_došg
))

1328 
»dœty_out
;

1329 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
)))

1330 
»dœty_out
;

1332 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
NODE
);

1335 
nid
 = 
	`nid_of_node
(
·ge
);

1337 
	`f2fs_bug_Ú
(
sbi
, 
·ge
->
šdex
 !ğ
nid
);

1339 
	`g‘_node_šfo
(
sbi
, 
nid
, &
ni
);

1342 ià(
	`uÆik–y
(
ni
.
blk_addr
 =ğ
NULL_ADDR
)) {

1343 
	`dec_·ge_couÁ
(
sbi
, 
F2FS_DIRTY_NODES
);

1344 
	`uÆock_·ge
(
·ge
);

1348 ià(
wbc
->
fÜ_»şaim
)

1349 
»dœty_out
;

1350 
	`down_»ad
(&
sbi
->
node_wr™e
);

1351 
	`£t_·ge_wr™eback
(
·ge
);

1352 
	`wr™e_node_·ge
(
sbi
, 
·ge
, &
fio
, 
nid
, 
ni
.
blk_addr
, &
Ãw_addr
);

1353 
	`£t_node_addr
(
sbi
, &
ni
, 
Ãw_addr
, 
	`is_fsync_dnode
(
·ge
));

1354 
	`dec_·ge_couÁ
(
sbi
, 
F2FS_DIRTY_NODES
);

1355 
	`up_»ad
(&
sbi
->
node_wr™e
);

1356 
	`uÆock_·ge
(
·ge
);

1359 
»dœty_out
:

1360 
	`»dœty_·ge_fÜ_wr™•age
(
wbc
, 
·ge
);

1361  
AOP_WRITEPAGE_ACTIVATE
;

1362 
	}
}

1364 
	$f2fs_wr™e_node_·ges
(
add»ss_¥aû
 *
m­pšg
,

1365 
wr™eback_cÚŒŞ
 *
wbc
)

1367 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_M_SB
(
m­pšg
);

1368 
diff
;

1370 
	`Œaû_f2fs_wr™•ages
(
m­pšg
->
ho¡
, 
wbc
, 
NODE
);

1373 
	`f2fs_b®ªû_fs_bg
(
sbi
);

1376 ià(
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_NODES
è< 
	`Ä_·ges_to_sk
(sbi, 
NODE
))

1377 
sk_wr™e
;

1379 
diff
 = 
	`Ä_·ges_to_wr™e
(
sbi
, 
NODE
, 
wbc
);

1381 
wbc
->
sync_mode
 = 
WB_SYNC_NONE
;

1383 
	`sync_node_·ges
(
sbi
, 0, 
wbc
);

1384 
wbc
->
Ä_to_wr™e
 = 
	`max
(()0, wbc->Ä_to_wr™- 
diff
);

1387 
sk_wr™e
:

1388 
wbc
->
·ges_sk³d
 +ğ
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_NODES
);

1390 
	}
}

1392 
	$f2fs_£t_node_·ge_dœty
(
·ge
 *page)

1394 
	`Œaû_f2fs_£t_·ge_dœty
(
·ge
, 
NODE
);

1396 
	`S‘PageU±od©e
(
·ge
);

1397 ià(!
	`PageDœty
(
·ge
)) {

1398 
	`__£t_·ge_dœty_nobufãrs
(
·ge
);

1399 
	`šc_·ge_couÁ
(
	`F2FS_P_SB
(
·ge
), 
F2FS_DIRTY_NODES
);

1400 
	`S‘PagePriv©e
(
·ge
);

1404 
	}
}

1406 
	$f2fs_šv®id©e_node_·ge
(
·ge
 *·ge, 
off£t
,

1407 
Ëngth
)

1409 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

1410 ià(
	`PageDœty
(
·ge
))

1411 
	`dec_·ge_couÁ
(
	`F2FS_I_SB
(
šode
), 
F2FS_DIRTY_NODES
);

1412 
	`CË¬PagePriv©e
(
·ge
);

1413 
	}
}

1415 
	$f2fs_»Ëa£_node_·ge
(
·ge
 *·ge, 
gå_t
 
wa™
)

1417 
	`CË¬PagePriv©e
(
·ge
);

1419 
	}
}

1424 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
	gf2fs_node_aİs
 = {

1425 .
wr™•age
 = 
f2fs_wr™e_node_·ge
,

1426 .
	gwr™•ages
 = 
f2fs_wr™e_node_·ges
,

1427 .
	g£t_·ge_dœty
 = 
f2fs_£t_node_·ge_dœty
,

1428 .
	gšv®id©•age
 = 
f2fs_šv®id©e_node_·ge
,

1429 .
	g»Ëa£·ge
 = 
f2fs_»Ëa£_node_·ge
,

1432 
ä“_nid
 *
	$__lookup_ä“_nid_li¡
(
f2fs_nm_šfo
 *
nm_i
,

1433 
nid_t
 
n
)

1435  
	`¿dix_Œ“_lookup
(&
nm_i
->
ä“_nid_roÙ
, 
n
);

1436 
	}
}

1438 
	$__d–_äom_ä“_nid_li¡
(
f2fs_nm_šfo
 *
nm_i
,

1439 
ä“_nid
 *
i
)

1441 
	`li¡_d–
(&
i
->
li¡
);

1442 
	`¿dix_Œ“_d–‘e
(&
nm_i
->
ä“_nid_roÙ
, 
i
->
nid
);

1443 
	}
}

1445 
	$add_ä“_nid
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
, 
boŞ
 
bud
)

1447 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

1448 
ä“_nid
 *
i
;

1449 
Çt_’Œy
 *
Ã
;

1450 
boŞ
 
®loÿ‹d
 = 
çl£
;

1452 ià(!
	`avaabË_ä“_memÜy
(
sbi
, 
FREE_NIDS
))

1456 ià(
	`uÆik–y
(
nid
 == 0))

1459 ià(
bud
) {

1461 
	`»ad_lock
(&
nm_i
->
Çt_Œ“_lock
);

1462 
Ã
 = 
	`__lookup_Çt_ÿche
(
nm_i
, 
nid
);

1463 ià(
Ã
 &&

1464 (!
	`g‘_Çt_æag
(
Ã
, 
IS_CHECKPOINTED
) ||

1465 
	`Çt_g‘_blkaddr
(
Ã
è!ğ
NULL_ADDR
))

1466 
®loÿ‹d
 = 
Œue
;

1467 
	`»ad_uÆock
(&
nm_i
->
Çt_Œ“_lock
);

1468 ià(
®loÿ‹d
)

1472 
i
 = 
	`f2fs_kmem_ÿche_®loc
(
ä“_nid_¦ab
, 
GFP_NOFS
);

1473 
i
->
nid
 =‚id;

1474 
i
->
¡©e
 = 
NID_NEW
;

1476 
	`¥š_lock
(&
nm_i
->
ä“_nid_li¡_lock
);

1477 ià(
	`¿dix_Œ“_š£¹
(&
nm_i
->
ä“_nid_roÙ
, 
i
->
nid
, i)) {

1478 
	`¥š_uÆock
(&
nm_i
->
ä“_nid_li¡_lock
);

1479 
	`kmem_ÿche_ä“
(
ä“_nid_¦ab
, 
i
);

1482 
	`li¡_add_
(&
i
->
li¡
, &
nm_i
->
ä“_nid_li¡
);

1483 
nm_i
->
fút
++;

1484 
	`¥š_uÆock
(&
nm_i
->
ä“_nid_li¡_lock
);

1486 
	}
}

1488 
	$»move_ä“_nid
(
f2fs_nm_šfo
 *
nm_i
, 
nid_t
 
nid
)

1490 
ä“_nid
 *
i
;

1491 
boŞ
 
Ãed_ä“
 = 
çl£
;

1493 
	`¥š_lock
(&
nm_i
->
ä“_nid_li¡_lock
);

1494 
i
 = 
	`__lookup_ä“_nid_li¡
(
nm_i
, 
nid
);

1495 ià(
i
 && i->
¡©e
 =ğ
NID_NEW
) {

1496 
	`__d–_äom_ä“_nid_li¡
(
nm_i
, 
i
);

1497 
nm_i
->
fút
--;

1498 
Ãed_ä“
 = 
Œue
;

1500 
	`¥š_uÆock
(&
nm_i
->
ä“_nid_li¡_lock
);

1502 ià(
Ãed_ä“
)

1503 
	`kmem_ÿche_ä“
(
ä“_nid_¦ab
, 
i
);

1504 
	}
}

1506 
	$sÿn_Çt_·ge
(
f2fs_sb_šfo
 *
sbi
,

1507 
·ge
 *
Çt_·ge
, 
nid_t
 
¡¬t_nid
)

1509 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

1510 
f2fs_Çt_block
 *
Çt_blk
 = 
	`·ge_add»ss
(
Çt_·ge
);

1511 
block_t
 
blk_addr
;

1512 
i
;

1514 
i
 = 
¡¬t_nid
 % 
NAT_ENTRY_PER_BLOCK
;

1516 ; 
i
 < 
NAT_ENTRY_PER_BLOCK
; i++, 
¡¬t_nid
++) {

1518 ià(
	`uÆik–y
(
¡¬t_nid
 >ğ
nm_i
->
max_nid
))

1521 
blk_addr
 = 
	`Ë32_to_ıu
(
Çt_blk
->
’Œ›s
[
i
].
block_addr
);

1522 
	`f2fs_bug_Ú
(
sbi
, 
blk_addr
 =ğ
NEW_ADDR
);

1523 ià(
blk_addr
 =ğ
NULL_ADDR
) {

1524 ià(
	`add_ä“_nid
(
sbi
, 
¡¬t_nid
, 
Œue
) < 0)

1528 
	}
}

1530 
	$bud_ä“_nids
(
f2fs_sb_šfo
 *
sbi
)

1532 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

1533 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
);

1534 
f2fs_summ¬y_block
 *
sum
 = 
cur£g
->
sum_blk
;

1535 
i
 = 0;

1536 
nid_t
 
nid
 = 
nm_i
->
Ãxt_sÿn_nid
;

1539 ià(
nm_i
->
fút
 > 
NAT_ENTRY_PER_BLOCK
)

1543 
	`¿_m‘a_·ges
(
sbi
, 
	`NAT_BLOCK_OFFSET
(
nid
), 
FREE_NID_PAGES
, 
META_NAT
);

1546 
·ge
 *·gğ
	`g‘_cu¼’t_Çt_·ge
(
sbi
, 
nid
);

1548 
	`sÿn_Çt_·ge
(
sbi
, 
·ge
, 
nid
);

1549 
	`f2fs_put_·ge
(
·ge
, 1);

1551 
nid
 +ğ(
NAT_ENTRY_PER_BLOCK
 - (nid % NAT_ENTRY_PER_BLOCK));

1552 ià(
	`uÆik–y
(
nid
 >ğ
nm_i
->
max_nid
))

1553 
nid
 = 0;

1555 ià(
i
++ =ğ
FREE_NID_PAGES
)

1560 
nm_i
->
Ãxt_sÿn_nid
 = 
nid
;

1563 
	`mu‹x_lock
(&
cur£g
->
cur£g_mu‹x
);

1564 
i
 = 0; i < 
	`Çts_š_cursum
(
sum
); i++) {

1565 
block_t
 
addr
 = 
	`Ë32_to_ıu
(
	`Çt_š_jouº®
(
sum
, 
i
).
block_addr
);

1566 
nid
 = 
	`Ë32_to_ıu
(
	`nid_š_jouº®
(
sum
, 
i
));

1567 ià(
addr
 =ğ
NULL_ADDR
)

1568 
	`add_ä“_nid
(
sbi
, 
nid
, 
Œue
);

1570 
	`»move_ä“_nid
(
nm_i
, 
nid
);

1572 
	`mu‹x_uÆock
(&
cur£g
->
cur£g_mu‹x
);

1573 
	}
}

1580 
boŞ
 
	$®loc_nid
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 *
nid
)

1582 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

1583 
ä“_nid
 *
i
 = 
NULL
;

1584 
»Œy
:

1585 ià(
	`uÆik–y
(
sbi
->
tÙ®_v®id_node_couÁ
 + 1 > 
nm_i
->
avaabË_nids
))

1586  
çl£
;

1588 
	`¥š_lock
(&
nm_i
->
ä“_nid_li¡_lock
);

1591 ià(
nm_i
->
fút
 && !
	`Ú_bud_ä“_nids
(nm_i)) {

1592 
	`f2fs_bug_Ú
(
sbi
, 
	`li¡_em±y
(&
nm_i
->
ä“_nid_li¡
));

1593 
	`li¡_fÜ_—ch_’Œy
(
i
, &
nm_i
->
ä“_nid_li¡
, 
li¡
)

1594 ià(
i
->
¡©e
 =ğ
NID_NEW
)

1597 
	`f2fs_bug_Ú
(
sbi
, 
i
->
¡©e
 !ğ
NID_NEW
);

1598 *
nid
 = 
i
->nid;

1599 
i
->
¡©e
 = 
NID_ALLOC
;

1600 
nm_i
->
fút
--;

1601 
	`¥š_uÆock
(&
nm_i
->
ä“_nid_li¡_lock
);

1602  
Œue
;

1604 
	`¥š_uÆock
(&
nm_i
->
ä“_nid_li¡_lock
);

1607 
	`mu‹x_lock
(&
nm_i
->
bud_lock
);

1608 
	`bud_ä“_nids
(
sbi
);

1609 
	`mu‹x_uÆock
(&
nm_i
->
bud_lock
);

1610 
»Œy
;

1611 
	}
}

1616 
	$®loc_nid_dÚe
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
)

1618 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

1619 
ä“_nid
 *
i
;

1621 
	`¥š_lock
(&
nm_i
->
ä“_nid_li¡_lock
);

1622 
i
 = 
	`__lookup_ä“_nid_li¡
(
nm_i
, 
nid
);

1623 
	`f2fs_bug_Ú
(
sbi
, !
i
 || i->
¡©e
 !ğ
NID_ALLOC
);

1624 
	`__d–_äom_ä“_nid_li¡
(
nm_i
, 
i
);

1625 
	`¥š_uÆock
(&
nm_i
->
ä“_nid_li¡_lock
);

1627 
	`kmem_ÿche_ä“
(
ä“_nid_¦ab
, 
i
);

1628 
	}
}

1633 
	$®loc_nid_çed
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
nid
)

1635 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

1636 
ä“_nid
 *
i
;

1637 
boŞ
 
Ãed_ä“
 = 
çl£
;

1639 ià(!
nid
)

1642 
	`¥š_lock
(&
nm_i
->
ä“_nid_li¡_lock
);

1643 
i
 = 
	`__lookup_ä“_nid_li¡
(
nm_i
, 
nid
);

1644 
	`f2fs_bug_Ú
(
sbi
, !
i
 || i->
¡©e
 !ğ
NID_ALLOC
);

1645 ià(!
	`avaabË_ä“_memÜy
(
sbi
, 
FREE_NIDS
)) {

1646 
	`__d–_äom_ä“_nid_li¡
(
nm_i
, 
i
);

1647 
Ãed_ä“
 = 
Œue
;

1649 
i
->
¡©e
 = 
NID_NEW
;

1650 
nm_i
->
fút
++;

1652 
	`¥š_uÆock
(&
nm_i
->
ä“_nid_li¡_lock
);

1654 ià(
Ãed_ä“
)

1655 
	`kmem_ÿche_ä“
(
ä“_nid_¦ab
, 
i
);

1656 
	}
}

1658 
	$»cov”_šlše_x©Œ
(
šode
 *šode, 
·ge
 *page)

1660 *
¤c_addr
, *
d¡_addr
;

1661 
size_t
 
šlše_size
;

1662 
·ge
 *
age
;

1663 
f2fs_šode
 *
ri
;

1665 
age
 = 
	`g‘_node_·ge
(
	`F2FS_I_SB
(
šode
), inode->
i_šo
);

1666 
	`f2fs_bug_Ú
(
	`F2FS_I_SB
(
šode
), 
	`IS_ERR
(
age
));

1668 
ri
 = 
	`F2FS_INODE
(
·ge
);

1669 ià(!(
ri
->
i_šlše
 & 
F2FS_INLINE_XATTR
)) {

1670 
	`ş—r_šode_æag
(
	`F2FS_I
(
šode
), 
FI_INLINE_XATTR
);

1671 
upd©e_šode
;

1674 
d¡_addr
 = 
	`šlše_x©Œ_addr
(
age
);

1675 
¤c_addr
 = 
	`šlše_x©Œ_addr
(
·ge
);

1676 
šlše_size
 = 
	`šlše_x©Œ_size
(
šode
);

1678 
	`f2fs_wa™_Ú_·ge_wr™eback
(
age
, 
NODE
);

1679 
	`memıy
(
d¡_addr
, 
¤c_addr
, 
šlše_size
);

1680 
upd©e_šode
:

1681 
	`upd©e_šode
(
šode
, 
age
);

1682 
	`f2fs_put_·ge
(
age
, 1);

1683 
	}
}

1685 
	$»cov”_x©Œ_d©a
(
šode
 *šode, 
·ge
 *·ge, 
block_t
 
blkaddr
)

1687 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

1688 
nid_t
 
´ev_xnid
 = 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
;

1689 
nid_t
 
Ãw_xnid
 = 
	`nid_of_node
(
·ge
);

1690 
node_šfo
 
ni
;

1693 ià(!
´ev_xnid
)

1694 
»cov”_xnid
;

1697 
	`g‘_node_šfo
(
sbi
, 
´ev_xnid
, &
ni
);

1698 
	`f2fs_bug_Ú
(
sbi
, 
ni
.
blk_addr
 =ğ
NULL_ADDR
);

1699 
	`šv®id©e_blocks
(
sbi
, 
ni
.
blk_addr
);

1700 
	`dec_v®id_node_couÁ
(
sbi
, 
šode
);

1701 
	`£t_node_addr
(
sbi
, &
ni
, 
NULL_ADDR
, 
çl£
);

1703 
»cov”_xnid
:

1705 ià(
	`uÆik–y
(!
	`šc_v®id_node_couÁ
(
sbi
, 
šode
)))

1706 
	`f2fs_bug_Ú
(
sbi
, 1);

1708 
	`»move_ä“_nid
(
	`NM_I
(
sbi
), 
Ãw_xnid
);

1709 
	`g‘_node_šfo
(
sbi
, 
Ãw_xnid
, &
ni
);

1710 
ni
.
šo
 = 
šode
->
i_šo
;

1711 
	`£t_node_addr
(
sbi
, &
ni
, 
NEW_ADDR
, 
çl£
);

1712 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
 = 
Ãw_xnid
;

1715 
	`»äesh_s™_’Œy
(
sbi
, 
NEW_ADDR
, 
blkaddr
);

1716 
	`£t_node_addr
(
sbi
, &
ni
, 
blkaddr
, 
çl£
);

1718 
	`upd©e_šode_·ge
(
šode
);

1719 
	}
}

1721 
	$»cov”_šode_·ge
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page)

1723 
f2fs_šode
 *
¤c
, *
d¡
;

1724 
nid_t
 
šo
 = 
	`šo_of_node
(
·ge
);

1725 
node_šfo
 
Şd_ni
, 
Ãw_ni
;

1726 
·ge
 *
age
;

1728 
	`g‘_node_šfo
(
sbi
, 
šo
, &
Şd_ni
);

1730 ià(
	`uÆik–y
(
Şd_ni
.
blk_addr
 !ğ
NULL_ADDR
))

1731  -
EINVAL
;

1733 
age
 = 
	`g¿b_ÿche_·ge
(
	`NODE_MAPPING
(
sbi
), 
šo
);

1734 ià(!
age
)

1735  -
ENOMEM
;

1738 
	`»move_ä“_nid
(
	`NM_I
(
sbi
), 
šo
);

1740 
	`S‘PageU±od©e
(
age
);

1741 
	`fl_node_foÙ”
(
age
, 
šo
, ino, 0, 
Œue
);

1743 
¤c
 = 
	`F2FS_INODE
(
·ge
);

1744 
d¡
 = 
	`F2FS_INODE
(
age
);

1746 
	`memıy
(
d¡
, 
¤c
, ()&¤c->
i_ext
 - ()src);

1747 
d¡
->
i_size
 = 0;

1748 
d¡
->
i_blocks
 = 
	`ıu_to_Ë64
(1);

1749 
d¡
->
i_lšks
 = 
	`ıu_to_Ë32
(1);

1750 
d¡
->
i_x©Œ_nid
 = 0;

1751 
d¡
->
i_šlše
 = 
¤c
->i_šlš& 
F2FS_INLINE_XATTR
;

1753 
Ãw_ni
 = 
Şd_ni
;

1754 
Ãw_ni
.
šo
 = ino;

1756 ià(
	`uÆik–y
(!
	`šc_v®id_node_couÁ
(
sbi
, 
NULL
)))

1757 
	`WARN_ON
(1);

1758 
	`£t_node_addr
(
sbi
, &
Ãw_ni
, 
NEW_ADDR
, 
çl£
);

1759 
	`šc_v®id_šode_couÁ
(
sbi
);

1760 
	`£t_·ge_dœty
(
age
);

1761 
	`f2fs_put_·ge
(
age
, 1);

1763 
	}
}

1769 
	$¿_sum_·ges
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 **
·ges
,

1770 
¡¬t
, 
Ä·ges
)

1772 
šode
 *šodğ
sbi
->
sb
->
s_bdev
->
bd_šode
;

1773 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

1774 
i
, 
·ge_idx
 = 
¡¬t
;

1775 
f2fs_io_šfo
 
fio
 = {

1776 .
ty³
 = 
META
,

1777 .
rw
 = 
READ_SYNC
 | 
REQ_META
 | 
REQ_PRIO


1780 
i
 = 0; 
·ge_idx
 < 
¡¬t
 + 
Ä·ges
;…age_idx++, i++) {

1782 
·ges
[
i
] = 
	`g¿b_ÿche_·ge
(
m­pšg
, 
·ge_idx
);

1783 ià(!
·ges
[
i
])

1785 #ifdeà
F2FS_DA_MAP


1786 
	`f2fs_subm™_·ge_mbio
(
sbi
, 
·ges
[
i
], 
·ge_idx
, &
fio
, 
NULL
);

1788 
	`f2fs_subm™_·ge_mbio
(
sbi
, 
·ges
[
i
], 
·ge_idx
, &
fio
);

1792 
	`f2fs_subm™_m”ged_bio
(
sbi
, 
META
, 
READ
);

1793  
i
;

1794 
	}
}

1796 
	$»¡Üe_node_summ¬y
(
f2fs_sb_šfo
 *
sbi
,

1797 
£gno
, 
f2fs_summ¬y_block
 *
sum
)

1799 
f2fs_node
 *
º
;

1800 
f2fs_summ¬y
 *
sum_’Œy
;

1801 
šode
 *šodğ
sbi
->
sb
->
s_bdev
->
bd_šode
;

1802 
block_t
 
addr
;

1803 
bio_blocks
 = 
	`MAX_BIO_BLOCKS
(
sbi
);

1804 
·ge
 *
·ges
[
bio_blocks
];

1805 
i
, 
idx
, 
Ï¡_off£t
, 
Ä·ges
, 
”r
 = 0;

1808 
Ï¡_off£t
 = 
sbi
->
blocks_³r_£g
;

1809 
addr
 = 
	`START_BLOCK
(
sbi
, 
£gno
);

1810 
sum_’Œy
 = &
sum
->
’Œ›s
[0];

1812 
i
 = 0; !
”r
 && i < 
Ï¡_off£t
; i +ğ
Ä·ges
, 
addr
 +=‚rpages) {

1813 
Ä·ges
 = 
	`mš
(
Ï¡_off£t
 - 
i
, 
bio_blocks
);

1816 
Ä·ges
 = 
	`¿_sum_·ges
(
sbi
, 
·ges
, 
addr
,‚rpages);

1817 ià(!
Ä·ges
)

1818  -
ENOMEM
;

1820 
idx
 = 0; idx < 
Ä·ges
; idx++) {

1821 ià(
”r
)

1822 
sk
;

1824 
	`lock_·ge
(
·ges
[
idx
]);

1825 ià(
	`uÆik–y
(!
	`PageU±od©e
(
·ges
[
idx
]))) {

1826 
”r
 = -
EIO
;

1828 
º
 = 
	`F2FS_NODE
(
·ges
[
idx
]);

1829 
sum_’Œy
->
nid
 = 
º
->
foÙ”
.nid;

1830 
sum_’Œy
->
v”siÚ
 = 0;

1831 
sum_’Œy
->
ofs_š_node
 = 0;

1832 
sum_’Œy
++;

1834 
	`uÆock_·ge
(
·ges
[
idx
]);

1835 
sk
:

1836 
	`·ge_ÿche_»Ëa£
(
·ges
[
idx
]);

1839 
	`šv®id©e_m­pšg_·ges
(
šode
->
i_m­pšg
, 
addr
,

1840 
addr
 + 
Ä·ges
);

1842  
”r
;

1843 
	}
}

1845 
	$»move_Çts_š_jouº®
(
f2fs_sb_šfo
 *
sbi
)

1847 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

1848 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
);

1849 
f2fs_summ¬y_block
 *
sum
 = 
cur£g
->
sum_blk
;

1850 
i
;

1852 
	`mu‹x_lock
(&
cur£g
->
cur£g_mu‹x
);

1853 
i
 = 0; i < 
	`Çts_š_cursum
(
sum
); i++) {

1854 
Çt_’Œy
 *
Ã
;

1855 
f2fs_Çt_’Œy
 
¿w_Ã
;

1856 
nid_t
 
nid
 = 
	`Ë32_to_ıu
(
	`nid_š_jouº®
(
sum
, 
i
));

1858 
¿w_Ã
 = 
	`Çt_š_jouº®
(
sum
, 
i
);

1859 
»Œy
:

1860 
	`wr™e_lock
(&
nm_i
->
Çt_Œ“_lock
);

1861 
Ã
 = 
	`__lookup_Çt_ÿche
(
nm_i
, 
nid
);

1862 ià(
Ã
)

1863 
found
;

1865 
Ã
 = 
	`g¿b_Çt_’Œy
(
nm_i
, 
nid
);

1866 ià(!
Ã
) {

1867 
	`wr™e_uÆock
(&
nm_i
->
Çt_Œ“_lock
);

1868 
»Œy
;

1870 
	`node_šfo_äom_¿w_Çt
(&
Ã
->
ni
, &
¿w_Ã
);

1871 
found
:

1872 
	`__£t_Çt_ÿche_dœty
(
nm_i
, 
Ã
);

1873 
	`wr™e_uÆock
(&
nm_i
->
Çt_Œ“_lock
);

1875 
	`upd©e_Çts_š_cursum
(
sum
, -
i
);

1876 
	`mu‹x_uÆock
(&
cur£g
->
cur£g_mu‹x
);

1877 
	}
}

1879 
	$__adju¡_Çt_’Œy_£t
(
Çt_’Œy_£t
 *
Ãs
,

1880 
li¡_h—d
 *
h—d
, 
max
)

1882 
Çt_’Œy_£t
 *
cur
;

1884 ià(
Ãs
->
’Œy_út
 >ğ
max
)

1885 
add_out
;

1887 
	`li¡_fÜ_—ch_’Œy
(
cur
, 
h—d
, 
£t_li¡
) {

1888 ià(
cur
->
’Œy_út
 >ğ
Ãs
->entry_cnt) {

1889 
	`li¡_add
(&
Ãs
->
£t_li¡
, 
cur
->£t_li¡.
´ev
);

1893 
add_out
:

1894 
	`li¡_add_
(&
Ãs
->
£t_li¡
, 
h—d
);

1895 
	}
}

1897 
	$__æush_Çt_’Œy_£t
(
f2fs_sb_šfo
 *
sbi
,

1898 
Çt_’Œy_£t
 *
£t
)

1900 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
);

1901 
f2fs_summ¬y_block
 *
sum
 = 
cur£g
->
sum_blk
;

1902 
nid_t
 
¡¬t_nid
 = 
£t
->£ˆ* 
NAT_ENTRY_PER_BLOCK
;

1903 
boŞ
 
to_jouº®
 = 
Œue
;

1904 
f2fs_Çt_block
 *
Çt_blk
;

1905 
Çt_’Œy
 *
Ã
, *
cur
;

1906 
·ge
 *·gğ
NULL
;

1913 ià(!
	`__has_cursum_¥aû
(
sum
, 
£t
->
’Œy_út
, 
NAT_JOURNAL
))

1914 
to_jouº®
 = 
çl£
;

1916 ià(
to_jouº®
) {

1917 
	`mu‹x_lock
(&
cur£g
->
cur£g_mu‹x
);

1919 
·ge
 = 
	`g‘_Ãxt_Çt_·ge
(
sbi
, 
¡¬t_nid
);

1920 
Çt_blk
 = 
	`·ge_add»ss
(
·ge
);

1921 
	`f2fs_bug_Ú
(
sbi
, !
Çt_blk
);

1925 
	`li¡_fÜ_—ch_’Œy_§ã
(
Ã
, 
cur
, &
£t
->
’Œy_li¡
, 
li¡
) {

1926 
f2fs_Çt_’Œy
 *
¿w_Ã
;

1927 
nid_t
 
nid
 = 
	`Çt_g‘_nid
(
Ã
);

1928 
off£t
;

1930 ià(
	`Çt_g‘_blkaddr
(
Ã
è=ğ
NEW_ADDR
)

1933 ià(
to_jouº®
) {

1934 
off£t
 = 
	`lookup_jouº®_š_cursum
(
sum
,

1935 
NAT_JOURNAL
, 
nid
, 1);

1936 
	`f2fs_bug_Ú
(
sbi
, 
off£t
 < 0);

1937 
¿w_Ã
 = &
	`Çt_š_jouº®
(
sum
, 
off£t
);

1938 
	`nid_š_jouº®
(
sum
, 
off£t
èğ
	`ıu_to_Ë32
(
nid
);

1940 
¿w_Ã
 = &
Çt_blk
->
’Œ›s
[
nid
 - 
¡¬t_nid
];

1942 
	`¿w_Çt_äom_node_šfo
(
¿w_Ã
, &
Ã
->
ni
);

1944 
	`wr™e_lock
(&
	`NM_I
(
sbi
)->
Çt_Œ“_lock
);

1945 
	`Çt_»£t_æag
(
Ã
);

1946 
	`__ş—r_Çt_ÿche_dœty
(
	`NM_I
(
sbi
), 
Ã
);

1947 
	`wr™e_uÆock
(&
	`NM_I
(
sbi
)->
Çt_Œ“_lock
);

1949 ià(
	`Çt_g‘_blkaddr
(
Ã
è=ğ
NULL_ADDR
)

1950 
	`add_ä“_nid
(
sbi
, 
nid
, 
çl£
);

1953 ià(
to_jouº®
)

1954 
	`mu‹x_uÆock
(&
cur£g
->
cur£g_mu‹x
);

1956 
	`f2fs_put_·ge
(
·ge
, 1);

1958 ià(!
£t
->
’Œy_út
) {

1959 
	`¿dix_Œ“_d–‘e
(&
	`NM_I
(
sbi
)->
Çt_£t_roÙ
, 
£t
->set);

1960 
	`kmem_ÿche_ä“
(
Çt_’Œy_£t_¦ab
, 
£t
);

1962 
	}
}

1967 
	$æush_Çt_’Œ›s
(
f2fs_sb_šfo
 *
sbi
)

1969 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

1970 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
);

1971 
f2fs_summ¬y_block
 *
sum
 = 
cur£g
->
sum_blk
;

1972 
Çt_’Œy_£t
 *
£tvec
[
NATVEC_SIZE
];

1973 
Çt_’Œy_£t
 *
£t
, *
tmp
;

1974 
found
;

1975 
nid_t
 
£t_idx
 = 0;

1976 
	`LIST_HEAD
(
£ts
);

1983 ià(!
	`__has_cursum_¥aû
(
sum
, 
nm_i
->
dœty_Çt_út
, 
NAT_JOURNAL
))

1984 
	`»move_Çts_š_jouº®
(
sbi
);

1986 ià(!
nm_i
->
dœty_Çt_út
)

1989 (
found
 = 
	`__gªg_lookup_Çt_£t
(
nm_i
,

1990 
£t_idx
, 
NATVEC_SIZE
, 
£tvec
))) {

1991 
idx
;

1992 
£t_idx
 = 
£tvec
[
found
 - 1]->
£t
 + 1;

1993 
idx
 = 0; idx < 
found
; idx++)

1994 
	`__adju¡_Çt_’Œy_£t
(
£tvec
[
idx
], &
£ts
,

1995 
	`MAX_NAT_JENTRIES
(
sum
));

1999 
	`li¡_fÜ_—ch_’Œy_§ã
(
£t
, 
tmp
, &
£ts
, 
£t_li¡
)

2000 
	`__æush_Çt_’Œy_£t
(
sbi
, 
£t
);

2002 
	`f2fs_bug_Ú
(
sbi
, 
nm_i
->
dœty_Çt_út
);

2003 
	}
}

2005 
	$š™_node_mªag”
(
f2fs_sb_šfo
 *
sbi
)

2007 
f2fs_su³r_block
 *
sb_¿w
 = 
	`F2FS_RAW_SUPER
(
sbi
);

2008 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2009 *
v”siÚ_b™m­
;

2010 
Çt_£gs
, 
Çt_blocks
;

2012 
nm_i
->
Çt_blkaddr
 = 
	`Ë32_to_ıu
(
sb_¿w
->nat_blkaddr);

2015 
Çt_£gs
 = 
	`Ë32_to_ıu
(
sb_¿w
->
£gm’t_couÁ_Çt
) >> 1;

2016 
Çt_blocks
 = 
Çt_£gs
 << 
	`Ë32_to_ıu
(
sb_¿w
->
log_blocks_³r_£g
);

2018 
nm_i
->
max_nid
 = 
NAT_ENTRY_PER_BLOCK
 * 
Çt_blocks
;

2021 
nm_i
->
avaabË_nids
 =‚m_i->
max_nid
 - 
F2FS_RESERVED_NODE_NUM
;

2022 
nm_i
->
fút
 = 0;

2023 
nm_i
->
Çt_út
 = 0;

2024 
nm_i
->
¿m_th»sh
 = 
DEF_RAM_THRESHOLD
;

2026 
	`INIT_RADIX_TREE
(&
nm_i
->
ä“_nid_roÙ
, 
GFP_ATOMIC
);

2027 
	`INIT_LIST_HEAD
(&
nm_i
->
ä“_nid_li¡
);

2028 
	`INIT_RADIX_TREE
(&
nm_i
->
Çt_roÙ
, 
GFP_ATOMIC
);

2029 
	`INIT_RADIX_TREE
(&
nm_i
->
Çt_£t_roÙ
, 
GFP_ATOMIC
);

2030 
	`INIT_LIST_HEAD
(&
nm_i
->
Çt_’Œ›s
);

2032 
	`mu‹x_š™
(&
nm_i
->
bud_lock
);

2033 
	`¥š_lock_š™
(&
nm_i
->
ä“_nid_li¡_lock
);

2034 
	`rwlock_š™
(&
nm_i
->
Çt_Œ“_lock
);

2036 
nm_i
->
Ãxt_sÿn_nid
 = 
	`Ë32_to_ıu
(
sbi
->
ck±
->
Ãxt_ä“_nid
);

2037 
nm_i
->
b™m­_size
 = 
	`__b™m­_size
(
sbi
, 
NAT_BITMAP
);

2038 
v”siÚ_b™m­
 = 
	`__b™m­_±r
(
sbi
, 
NAT_BITMAP
);

2039 ià(!
v”siÚ_b™m­
)

2040  -
EFAULT
;

2042 
nm_i
->
Çt_b™m­
 = 
	`kmemdup
(
v”siÚ_b™m­
,‚m_i->
b™m­_size
,

2043 
GFP_KERNEL
);

2044 ià(!
nm_i
->
Çt_b™m­
)

2045  -
ENOMEM
;

2047 
	}
}

2049 
	$bud_node_mªag”
(
f2fs_sb_šfo
 *
sbi
)

2051 
”r
;

2053 
sbi
->
nm_šfo
 = 
	`kz®loc
((
f2fs_nm_šfo
), 
GFP_KERNEL
);

2054 ià(!
sbi
->
nm_šfo
)

2055  -
ENOMEM
;

2057 
”r
 = 
	`š™_node_mªag”
(
sbi
);

2058 ià(
”r
)

2059  
”r
;

2061 
	`bud_ä“_nids
(
sbi
);

2063 
	}
}

2065 
	$de¡roy_node_mªag”
(
f2fs_sb_šfo
 *
sbi
)

2067 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

2068 
ä“_nid
 *
i
, *
Ãxt_i
;

2069 
Çt_’Œy
 *
Çtvec
[
NATVEC_SIZE
];

2070 
nid_t
 
nid
 = 0;

2071 
found
;

2073 ià(!
nm_i
)

2077 
	`¥š_lock
(&
nm_i
->
ä“_nid_li¡_lock
);

2078 
	`li¡_fÜ_—ch_’Œy_§ã
(
i
, 
Ãxt_i
, &
nm_i
->
ä“_nid_li¡
, 
li¡
) {

2079 
	`f2fs_bug_Ú
(
sbi
, 
i
->
¡©e
 =ğ
NID_ALLOC
);

2080 
	`__d–_äom_ä“_nid_li¡
(
nm_i
, 
i
);

2081 
nm_i
->
fút
--;

2082 
	`¥š_uÆock
(&
nm_i
->
ä“_nid_li¡_lock
);

2083 
	`kmem_ÿche_ä“
(
ä“_nid_¦ab
, 
i
);

2084 
	`¥š_lock
(&
nm_i
->
ä“_nid_li¡_lock
);

2086 
	`f2fs_bug_Ú
(
sbi
, 
nm_i
->
fút
);

2087 
	`¥š_uÆock
(&
nm_i
->
ä“_nid_li¡_lock
);

2090 
	`wr™e_lock
(&
nm_i
->
Çt_Œ“_lock
);

2091 (
found
 = 
	`__gªg_lookup_Çt_ÿche
(
nm_i
,

2092 
nid
, 
NATVEC_SIZE
, 
Çtvec
))) {

2093 
idx
;

2094 
nid
 = 
	`Çt_g‘_nid
(
Çtvec
[
found
 - 1]) + 1;

2095 
idx
 = 0; idx < 
found
; idx++)

2096 
	`__d–_äom_Çt_ÿche
(
nm_i
, 
Çtvec
[
idx
]);

2098 
	`f2fs_bug_Ú
(
sbi
, 
nm_i
->
Çt_út
);

2099 
	`wr™e_uÆock
(&
nm_i
->
Çt_Œ“_lock
);

2101 
	`kä“
(
nm_i
->
Çt_b™m­
);

2102 
sbi
->
nm_šfo
 = 
NULL
;

2103 
	`kä“
(
nm_i
);

2104 
	}
}

2106 
__š™
 
	$ü—‹_node_mªag”_ÿches
()

2108 
Çt_’Œy_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("nat_entry",

2109 (
Çt_’Œy
));

2110 ià(!
Çt_’Œy_¦ab
)

2111 
ç
;

2113 
ä“_nid_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("free_nid",

2114 (
ä“_nid
));

2115 ià(!
ä“_nid_¦ab
)

2116 
de¡Üy_Çt_’Œy
;

2118 
Çt_’Œy_£t_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("nat_entry_set",

2119 (
Çt_’Œy_£t
));

2120 ià(!
Çt_’Œy_£t_¦ab
)

2121 
de¡Üy_ä“_nid
;

2124 
de¡Üy_ä“_nid
:

2125 
	`kmem_ÿche_de¡roy
(
ä“_nid_¦ab
);

2126 
de¡Üy_Çt_’Œy
:

2127 
	`kmem_ÿche_de¡roy
(
Çt_’Œy_¦ab
);

2128 
ç
:

2129  -
ENOMEM
;

2130 
	}
}

2132 
	$de¡roy_node_mªag”_ÿches
()

2134 
	`kmem_ÿche_de¡roy
(
Çt_’Œy_£t_¦ab
);

2135 
	`kmem_ÿche_de¡roy
(
ä“_nid_¦ab
);

2136 
	`kmem_ÿche_de¡roy
(
Çt_’Œy_¦ab
);

2137 
	}
}

	@node.h

12 
	#START_NID
(
nid
è(Òid / 
NAT_ENTRY_PER_BLOCK
è* NAT_ENTRY_PER_BLOCK)

	)

15 
	#NAT_BLOCK_OFFSET
(
¡¬t_nid
è(¡¬t_nid / 
NAT_ENTRY_PER_BLOCK
)

	)

18 
	#FREE_NID_PAGES
 4

	)

21 
	#MAX_RA_NODE
 128

	)

24 
	#DEF_RAM_THRESHOLD
 10

	)

27 
	#NATVEC_SIZE
 64

	)

30 
	#LOCKED_PAGE
 1

	)

35 
	snode_šfo
 {

36 
nid_t
 
	mnid
;

37 
nid_t
 
	mšo
;

38 
block_t
 
	mblk_addr
;

39 
	mv”siÚ
;

43 
	mIS_CHECKPOINTED
,

44 
	mHAS_FSYNCED_INODE
,

45 
	mHAS_LAST_FSYNC
,

46 
	mIS_DIRTY
,

49 
	sÇt_’Œy
 {

50 
li¡_h—d
 
	mli¡
;

51 
	mæag
;

52 
node_šfo
 
	mni
;

55 
	#Çt_g‘_nid
(
Çt
èÒ©->
ni
.
nid
)

	)

56 
	#Çt_£t_nid
(
Çt
, 
n
èÒ©->
ni
.
nid
 =‚)

	)

57 
	#Çt_g‘_blkaddr
(
Çt
èÒ©->
ni
.
blk_addr
)

	)

58 
	#Çt_£t_blkaddr
(
Çt
, 
b
èÒ©->
ni
.
blk_addr
 = b)

	)

59 
	#Çt_g‘_šo
(
Çt
èÒ©->
ni
.
šo
)

	)

60 
	#Çt_£t_šo
(
Çt
, 
i
èÒ©->
ni
.
šo
 = i)

	)

61 
	#Çt_g‘_v”siÚ
(
Çt
èÒ©->
ni
.
v”siÚ
)

	)

62 
	#Çt_£t_v”siÚ
(
Çt
, 
v
èÒ©->
ni
.
v”siÚ
 = v)

	)

64 
	#šc_node_v”siÚ
(
v”siÚ
è(++v”siÚ)

	)

66 
šlše
 
	$£t_Çt_æag
(
Çt_’Œy
 *
Ã
,

67 
ty³
, 
boŞ
 
£t
)

69 
mask
 = 0x01 << 
ty³
;

70 ià(
£t
)

71 
Ã
->
æag
 |ğ
mask
;

73 
Ã
->
æag
 &ğ~
mask
;

74 
	}
}

76 
šlše
 
boŞ
 
	$g‘_Çt_æag
(
Çt_’Œy
 *
Ã
, 
ty³
)

78 
mask
 = 0x01 << 
ty³
;

79  
Ã
->
æag
 & 
mask
;

80 
	}
}

82 
šlše
 
	$Çt_»£t_æag
(
Çt_’Œy
 *
Ã
)

85 
	`£t_Çt_æag
(
Ã
, 
IS_CHECKPOINTED
, 
Œue
);

86 
	`£t_Çt_æag
(
Ã
, 
HAS_FSYNCED_INODE
, 
çl£
);

87 
	`£t_Çt_æag
(
Ã
, 
HAS_LAST_FSYNC
, 
Œue
);

88 
	}
}

90 
šlše
 
	$node_šfo_äom_¿w_Çt
(
node_šfo
 *
ni
,

91 
f2fs_Çt_’Œy
 *
¿w_Ã
)

93 
ni
->
šo
 = 
	`Ë32_to_ıu
(
¿w_Ã
->ino);

94 
ni
->
blk_addr
 = 
	`Ë32_to_ıu
(
¿w_Ã
->
block_addr
);

95 
ni
->
v”siÚ
 = 
¿w_Ã
->version;

96 
	}
}

98 
šlše
 
	$¿w_Çt_äom_node_šfo
(
f2fs_Çt_’Œy
 *
¿w_Ã
,

99 
node_šfo
 *
ni
)

101 
¿w_Ã
->
šo
 = 
	`ıu_to_Ë32
(
ni
->ino);

102 
¿w_Ã
->
block_addr
 = 
	`ıu_to_Ë32
(
ni
->
blk_addr
);

103 
¿w_Ã
->
v”siÚ
 = 
ni
->version;

104 
	}
}

106 
	emem_ty³
 {

107 
	mFREE_NIDS
,

108 
	mNAT_ENTRIES
,

109 
	mDIRTY_DENTS


112 
	sÇt_’Œy_£t
 {

113 
li¡_h—d
 
	m£t_li¡
;

114 
li¡_h—d
 
	m’Œy_li¡
;

115 
nid_t
 
	m£t
;

116 
	m’Œy_út
;

122 
	enid_¡©e
 {

123 
	mNID_NEW
,

124 
	mNID_ALLOC


127 
	sä“_nid
 {

128 
li¡_h—d
 
	mli¡
;

129 
nid_t
 
	mnid
;

130 
	m¡©e
;

133 
šlše
 
	$Ãxt_ä“_nid
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 *
nid
)

135 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

136 
ä“_nid
 *
âid
;

138 
	`¥š_lock
(&
nm_i
->
ä“_nid_li¡_lock
);

139 ià(
nm_i
->
fút
 <= 0) {

140 
	`¥š_uÆock
(&
nm_i
->
ä“_nid_li¡_lock
);

143 
âid
 = 
	`li¡_’Œy
(
nm_i
->
ä“_nid_li¡
.
Ãxt
, 
ä“_nid
, 
li¡
);

144 *
nid
 = 
âid
->nid;

145 
	`¥š_uÆock
(&
nm_i
->
ä“_nid_li¡_lock
);

146 
	}
}

151 
šlše
 
	$g‘_Çt_b™m­
(
f2fs_sb_šfo
 *
sbi
, *
addr
)

153 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

154 
	`memıy
(
addr
, 
nm_i
->
Çt_b™m­
,‚m_i->
b™m­_size
);

155 
	}
}

157 
šlše
 
pgoff_t
 
	$cu¼’t_Çt_addr
(
f2fs_sb_šfo
 *
sbi
, 
nid_t
 
¡¬t
)

159 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

160 
pgoff_t
 
block_off
;

161 
pgoff_t
 
block_addr
;

162 
£g_off
;

164 
block_off
 = 
	`NAT_BLOCK_OFFSET
(
¡¬t
);

165 
£g_off
 = 
block_off
 >> 
sbi
->
log_blocks_³r_£g
;

167 
block_addr
 = (
pgoff_t
)(
nm_i
->
Çt_blkaddr
 +

168 (
£g_off
 << 
sbi
->
log_blocks_³r_£g
 << 1) +

169 (
block_off
 & ((1 << 
sbi
->
log_blocks_³r_£g
) - 1)));

171 ià(
	`f2fs_‹¡_b™
(
block_off
, 
nm_i
->
Çt_b™m­
))

172 
block_addr
 +ğ
sbi
->
blocks_³r_£g
;

174  
block_addr
;

175 
	}
}

177 
šlše
 
pgoff_t
 
	$Ãxt_Çt_addr
(
f2fs_sb_šfo
 *
sbi
,

178 
pgoff_t
 
block_addr
)

180 
f2fs_nm_šfo
 *
nm_i
 = 
	`NM_I
(
sbi
);

182 
block_addr
 -ğ
nm_i
->
Çt_blkaddr
;

183 ià((
block_addr
 >> 
sbi
->
log_blocks_³r_£g
) % 2)

184 
block_addr
 -ğ
sbi
->
blocks_³r_£g
;

186 
block_addr
 +ğ
sbi
->
blocks_³r_£g
;

188  
block_addr
 + 
nm_i
->
Çt_blkaddr
;

189 
	}
}

191 
šlše
 
	$£t_to_Ãxt_Çt
(
f2fs_nm_šfo
 *
nm_i
, 
nid_t
 
¡¬t_nid
)

193 
block_off
 = 
	`NAT_BLOCK_OFFSET
(
¡¬t_nid
);

195 ià(
	`f2fs_‹¡_b™
(
block_off
, 
nm_i
->
Çt_b™m­
))

196 
	`f2fs_ş—r_b™
(
block_off
, 
nm_i
->
Çt_b™m­
);

198 
	`f2fs_£t_b™
(
block_off
, 
nm_i
->
Çt_b™m­
);

199 
	}
}

201 
šlše
 
	$fl_node_foÙ”
(
·ge
 *·ge, 
nid_t
 
nid
,

202 
nid_t
 
šo
, 
ofs
, 
boŞ
 
»£t
)

204 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
·ge
);

205 ià(
»£t
)

206 
	`mem£t
(
º
, 0, (*rn));

208 
º
->
foÙ”
.
nid
 = 
	`ıu_to_Ë32
(nid);

209 
º
->
foÙ”
.
šo
 = 
	`ıu_to_Ë32
(ino);

210 
º
->
foÙ”
.
æag
 = 
	`ıu_to_Ë32
(
ofs
 << 
OFFSET_BIT_SHIFT
);

211 
	}
}

213 
šlše
 
	$cİy_node_foÙ”
(
·ge
 *
d¡
, ·g*
¤c
)

215 
f2fs_node
 *
¤c_º
 = 
	`F2FS_NODE
(
¤c
);

216 
f2fs_node
 *
d¡_º
 = 
	`F2FS_NODE
(
d¡
);

217 
	`memıy
(&
d¡_º
->
foÙ”
, &
¤c_º
->foÙ”, (
node_foÙ”
));

218 
	}
}

220 
šlše
 
	$fl_node_foÙ”_blkaddr
(
·ge
 *·ge, 
block_t
 
blkaddr
)

222 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
	`F2FS_P_SB
(
·ge
));

223 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
·ge
);

225 
º
->
foÙ”
.
ı_v”
 = 
ck±
->
checkpošt_v”
;

226 
º
->
foÙ”
.
Ãxt_blkaddr
 = 
	`ıu_to_Ë32
(
blkaddr
);

227 
	}
}

229 
šlše
 
nid_t
 
	$šo_of_node
(
·ge
 *
node_·ge
)

231 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
node_·ge
);

232  
	`Ë32_to_ıu
(
º
->
foÙ”
.
šo
);

233 
	}
}

235 
šlše
 
nid_t
 
	$nid_of_node
(
·ge
 *
node_·ge
)

237 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
node_·ge
);

238  
	`Ë32_to_ıu
(
º
->
foÙ”
.
nid
);

239 
	}
}

241 
šlše
 
	$ofs_of_node
(
·ge
 *
node_·ge
)

243 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
node_·ge
);

244 
æag
 = 
	`Ë32_to_ıu
(
º
->
foÙ”
.flag);

245  
æag
 >> 
OFFSET_BIT_SHIFT
;

246 
	}
}

248 
šlše
 
	$ıv”_of_node
(
·ge
 *
node_·ge
)

250 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
node_·ge
);

251  
	`Ë64_to_ıu
(
º
->
foÙ”
.
ı_v”
);

252 
	}
}

254 
šlše
 
block_t
 
	$Ãxt_blkaddr_of_node
(
·ge
 *
node_·ge
)

256 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
node_·ge
);

257  
	`Ë32_to_ıu
(
º
->
foÙ”
.
Ãxt_blkaddr
);

258 
	}
}

281 
šlše
 
boŞ
 
	$IS_DNODE
(
·ge
 *
node_·ge
)

283 
ofs
 = 
	`ofs_of_node
(
node_·ge
);

285 ià(
	`f2fs_has_x©Œ_block
(
ofs
))

286  
çl£
;

288 ià(
ofs
 =ğ3 || of =ğ4 + 
NIDS_PER_BLOCK
 ||

289 
ofs
 =ğ5 + 2 * 
NIDS_PER_BLOCK
)

290  
çl£
;

291 ià(
ofs
 >ğ6 + 2 * 
NIDS_PER_BLOCK
) {

292 
ofs
 -ğ6 + 2 * 
NIDS_PER_BLOCK
;

293 ià(!(()
ofs
 % (
NIDS_PER_BLOCK
 + 1)))

294  
çl£
;

296  
Œue
;

297 
	}
}

299 
šlše
 
	$£t_nid
(
·ge
 *
p
, 
off
, 
nid_t
 
nid
, 
boŞ
 
i
)

301 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
p
);

303 
	`f2fs_wa™_Ú_·ge_wr™eback
(
p
, 
NODE
);

305 ià(
i
)

306 
º
->
i
.
i_nid
[
off
 - 
NODE_DIR1_BLOCK
] = 
	`ıu_to_Ë32
(
nid
);

308 
º
->
š
.
nid
[
off
] = 
	`ıu_to_Ë32
(nid);

309 
	`£t_·ge_dœty
(
p
);

310 
	}
}

312 
šlše
 
nid_t
 
	$g‘_nid
(
·ge
 *
p
, 
off
, 
boŞ
 
i
)

314 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
p
);

316 ià(
i
)

317  
	`Ë32_to_ıu
(
º
->
i
.
i_nid
[
off
 - 
NODE_DIR1_BLOCK
]);

318  
	`Ë32_to_ıu
(
º
->
š
.
nid
[
off
]);

319 
	}
}

327 
šlše
 
	$is_fe
(
šode
 *šode, 
ty³
)

329  
	`F2FS_I
(
šode
)->
i_advi£
 & 
ty³
;

330 
	}
}

332 
šlše
 
	$£t_fe
(
šode
 *šode, 
ty³
)

334 
	`F2FS_I
(
šode
)->
i_advi£
 |ğ
ty³
;

335 
	}
}

337 
šlše
 
	$ş—r_fe
(
šode
 *šode, 
ty³
)

339 
	`F2FS_I
(
šode
)->
i_advi£
 &ğ~
ty³
;

340 
	}
}

342 
	#fe_is_cŞd
(
šode
è
	`is_fe
(šode, 
FADVISE_COLD_BIT
)

	)

343 
	#fe_wrÚg_pšo
(
šode
è
	`is_fe
(šode, 
FADVISE_LOST_PINO_BIT
)

	)

344 
	#fe_£t_cŞd
(
šode
è
	`£t_fe
(šode, 
FADVISE_COLD_BIT
)

	)

345 
	#fe_lo¡_pšo
(
šode
è
	`£t_fe
(šode, 
FADVISE_LOST_PINO_BIT
)

	)

346 
	#fe_ş—r_cŞd
(
šode
è
	`ş—r_fe
(šode, 
FADVISE_COLD_BIT
)

	)

347 
	#fe_gÙ_pšo
(
šode
è
	`ş—r_fe
(šode, 
FADVISE_LOST_PINO_BIT
)

	)

349 
šlše
 
	$is_cŞd_d©a
(
·ge
 *page)

351  
	`PageChecked
(
·ge
);

352 
	}
}

354 
šlše
 
	$£t_cŞd_d©a
(
·ge
 *page)

356 
	`S‘PageChecked
(
·ge
);

357 
	}
}

359 
šlše
 
	$ş—r_cŞd_d©a
(
·ge
 *page)

361 
	`CË¬PageChecked
(
·ge
);

362 
	}
}

364 
šlše
 
	$is_node
(
·ge
 *·ge, 
ty³
)

366 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
·ge
);

367  
	`Ë32_to_ıu
(
º
->
foÙ”
.
æag
è& (1 << 
ty³
);

368 
	}
}

370 
	#is_cŞd_node
(
·ge
è
	`is_node
Õage, 
COLD_BIT_SHIFT
)

	)

371 
	#is_fsync_dnode
(
·ge
è
	`is_node
Õage, 
FSYNC_BIT_SHIFT
)

	)

372 
	#is_d’t_dnode
(
·ge
è
	`is_node
Õage, 
DENT_BIT_SHIFT
)

	)

374 
šlše
 
	$£t_cŞd_node
(
šode
 *šode, 
·ge
 *page)

376 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
·ge
);

377 
æag
 = 
	`Ë32_to_ıu
(
º
->
foÙ”
.flag);

379 ià(
	`S_ISDIR
(
šode
->
i_mode
))

380 
æag
 &ğ~(0x1 << 
COLD_BIT_SHIFT
);

382 
æag
 |ğ(0x1 << 
COLD_BIT_SHIFT
);

383 
º
->
foÙ”
.
æag
 = 
	`ıu_to_Ë32
(flag);

384 
	}
}

386 
šlše
 
	$£t_m¬k
(
·ge
 *·ge, 
m¬k
, 
ty³
)

388 
f2fs_node
 *
º
 = 
	`F2FS_NODE
(
·ge
);

389 
æag
 = 
	`Ë32_to_ıu
(
º
->
foÙ”
.flag);

390 ià(
m¬k
)

391 
æag
 |ğ(0x1 << 
ty³
);

393 
æag
 &ğ~(0x1 << 
ty³
);

394 
º
->
foÙ”
.
æag
 = 
	`ıu_to_Ë32
(flag);

395 
	}
}

396 
	#£t_d’Œy_m¬k
(
·ge
, 
m¬k
è
	`£t_m¬k
Õage, m¬k, 
DENT_BIT_SHIFT
)

	)

397 
	#£t_fsync_m¬k
(
·ge
, 
m¬k
è
	`£t_m¬k
Õage, m¬k, 
FSYNC_BIT_SHIFT
)

	)

	@recovery.c

11 
	~<lšux/fs.h
>

12 
	~<lšux/f2fs_fs.h
>

13 
	~"f2fs.h
"

14 
	~"node.h
"

15 
	~"£gm’t.h
"

48 
kmem_ÿche
 *
	gfsync_’Œy_¦ab
;

50 
boŞ
 
	$¥aû_fÜ_rŞl_fÜw¬d
(
f2fs_sb_šfo
 *
sbi
)

52 ià(
sbi
->
Ï¡_v®id_block_couÁ
 + sbi->
®loc_v®id_block_couÁ


53 > 
sbi
->
u£r_block_couÁ
)

54  
çl£
;

55  
Œue
;

56 
	}
}

58 
fsync_šode_’Œy
 *
	$g‘_fsync_šode
(
li¡_h—d
 *
h—d
,

59 
nid_t
 
šo
)

61 
fsync_šode_’Œy
 *
’Œy
;

63 
	`li¡_fÜ_—ch_’Œy
(
’Œy
, 
h—d
, 
li¡
)

64 ià(
’Œy
->
šode
->
i_šo
 =ğ
šo
)

65  
’Œy
;

67  
NULL
;

68 
	}
}

70 
	$»cov”_d’Œy
(
šode
 *šode, 
·ge
 *
age
)

72 
f2fs_šode
 *
¿w_šode
 = 
	`F2FS_INODE
(
age
);

73 
nid_t
 
pšo
 = 
	`Ë32_to_ıu
(
¿w_šode
->
i_pšo
);

74 
f2fs_dœ_’Œy
 *
de
;

75 
q¡r
 
Çme
;

76 
·ge
 *page;

77 
šode
 *
dœ
, *
ešode
;

78 
”r
 = 0;

80 
dœ
 = 
	`f2fs_ig‘
(
šode
->
i_sb
, 
pšo
);

81 ià(
	`IS_ERR
(
dœ
)) {

82 
”r
 = 
	`PTR_ERR
(
dœ
);

83 
out
;

86 
Çme
.
Ën
 = 
	`Ë32_to_ıu
(
¿w_šode
->
i_Çm–’
);

87 
Çme
.Çmğ
¿w_šode
->
i_Çme
;

89 ià(
	`uÆik–y
(
Çme
.
Ën
 > 
F2FS_NAME_LEN
)) {

90 
	`WARN_ON
(1);

91 
”r
 = -
ENAMETOOLONG
;

92 
out_”r
;

94 
»Œy
:

95 
de
 = 
	`f2fs_fšd_’Œy
(
dœ
, &
Çme
, &
·ge
);

96 ià(
de
 && 
šode
->
i_šo
 =ğ
	`Ë32_to_ıu
(de->
šo
)) {

97 
	`ş—r_šode_æag
(
	`F2FS_I
(
šode
), 
FI_INC_LINK
);

98 
out_unm­_put
;

100 ià(
de
) {

101 
ešode
 = 
	`f2fs_ig‘
(
šode
->
i_sb
, 
	`Ë32_to_ıu
(
de
->
šo
));

102 ià(
	`IS_ERR
(
ešode
)) {

103 
	`WARN_ON
(1);

104 
”r
 = 
	`PTR_ERR
(
ešode
);

105 ià(
”r
 =ğ-
ENOENT
)

106 
”r
 = -
EEXIST
;

107 
out_unm­_put
;

109 
”r
 = 
	`acquœe_Üphª_šode
(
	`F2FS_I_SB
(
šode
));

110 ià(
”r
) {

111 
	`ut
(
ešode
);

112 
out_unm­_put
;

114 
	`f2fs_d–‘e_’Œy
(
de
, 
·ge
, 
ešode
);

115 
	`ut
(
ešode
);

116 
»Œy
;

118 
”r
 = 
	`__f2fs_add_lšk
(
dœ
, &
Çme
, 
šode
);

119 ià(
”r
)

120 
out_”r
;

122 ià(
	`is_šode_æag_£t
(
	`F2FS_I
(
dœ
), 
FI_DELAY_IPUT
)) {

123 
	`ut
(
dœ
);

125 
	`add_dœty_dœ_šode
(
dœ
);

126 
	`£t_šode_æag
(
	`F2FS_I
(
dœ
), 
FI_DELAY_IPUT
);

129 
out
;

131 
out_unm­_put
:

132 
	`kunm­
(
·ge
);

133 
	`f2fs_put_·ge
(
·ge
, 0);

134 
out_”r
:

135 
	`ut
(
dœ
);

136 
out
:

137 
	`f2fs_msg
(
šode
->
i_sb
, 
KERN_NOTICE
,

139 
__func__
, 
	`šo_of_node
(
age
), 
¿w_šode
->
i_Çme
,

140 
	`IS_ERR
(
dœ
è? 0 : dœ->
i_šo
, 
”r
);

141  
”r
;

142 
	}
}

144 
	$»cov”_šode
(
šode
 *šode, 
·ge
 *page)

146 
f2fs_šode
 *
¿w
 = 
	`F2FS_INODE
(
·ge
);

148 
šode
->
i_mode
 = 
	`Ë16_to_ıu
(
¿w
->i_mode);

149 
	`i_size_wr™e
(
šode
, 
	`Ë64_to_ıu
(
¿w
->
i_size
));

150 
šode
->
i_©ime
.
tv_£c
 = 
	`Ë64_to_ıu
(
¿w
->
i_mtime
);

151 
šode
->
i_ùime
.
tv_£c
 = 
	`Ë64_to_ıu
(
¿w
->i_ctime);

152 
šode
->
i_mtime
.
tv_£c
 = 
	`Ë64_to_ıu
(
¿w
->i_mtime);

153 
šode
->
i_©ime
.
tv_n£c
 = 
	`Ë32_to_ıu
(
¿w
->
i_mtime_n£c
);

154 
šode
->
i_ùime
.
tv_n£c
 = 
	`Ë32_to_ıu
(
¿w
->
i_ùime_n£c
);

155 
šode
->
i_mtime
.
tv_n£c
 = 
	`Ë32_to_ıu
(
¿w
->
i_mtime_n£c
);

157 
	`f2fs_msg
(
šode
->
i_sb
, 
KERN_NOTICE
, "recover_inode: ino = %x,‚ame = %s",

158 
	`šo_of_node
(
·ge
), 
	`F2FS_INODE
Õage)->
i_Çme
);

159 
	}
}

161 
	$fšd_fsync_dnodes
(
f2fs_sb_šfo
 *
sbi
, 
li¡_h—d
 *
h—d
)

163 
ı_v”
 = 
	`cur_ı_v”siÚ
(
	`F2FS_CKPT
(
sbi
));

164 
cur£g_šfo
 *
cur£g
;

165 
·ge
 *·gğ
NULL
;

166 
block_t
 
blkaddr
;

167 
”r
 = 0;

170 
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_WARM_NODE
);

171 
blkaddr
 = 
	`NEXT_FREE_BLKADDR
(
sbi
, 
cur£g
);

174 
fsync_šode_’Œy
 *
’Œy
;

176 ià(
blkaddr
 < 
	`MAIN_BLKADDR
(
sbi
è|| blkadd¸>ğ
	`MAX_BLKADDR
(sbi))

179 
·ge
 = 
	`g‘_m‘a_·ge_¿
(
sbi
, 
blkaddr
);

181 ià(
ı_v”
 !ğ
	`ıv”_of_node
(
·ge
))

184 ià(!
	`is_fsync_dnode
(
·ge
))

185 
Ãxt
;

187 
’Œy
 = 
	`g‘_fsync_šode
(
h—d
, 
	`šo_of_node
(
·ge
));

188 ià(
’Œy
) {

189 ià(
	`IS_INODE
(
·ge
è&& 
	`is_d’t_dnode
(page))

190 
	`£t_šode_æag
(
	`F2FS_I
(
’Œy
->
šode
),

191 
FI_INC_LINK
);

193 ià(
	`IS_INODE
(
·ge
è&& 
	`is_d’t_dnode
(page)) {

194 
”r
 = 
	`»cov”_šode_·ge
(
sbi
, 
·ge
);

195 ià(
”r
)

200 
’Œy
 = 
	`kmem_ÿche_®loc
(
fsync_’Œy_¦ab
, 
GFP_F2FS_ZERO
);

201 ià(!
’Œy
) {

202 
”r
 = -
ENOMEM
;

209 
’Œy
->
šode
 = 
	`f2fs_ig‘
(
sbi
->
sb
, 
	`šo_of_node
(
·ge
));

210 ià(
	`IS_ERR
(
’Œy
->
šode
)) {

211 
”r
 = 
	`PTR_ERR
(
’Œy
->
šode
);

212 
	`kmem_ÿche_ä“
(
fsync_’Œy_¦ab
, 
’Œy
);

213 ià(
”r
 =ğ-
ENOENT
)

214 
Ãxt
;

217 
	`li¡_add_
(&
’Œy
->
li¡
, 
h—d
);

219 
’Œy
->
blkaddr
 = blkaddr;

221 ià(
	`IS_INODE
(
·ge
)) {

222 
’Œy
->
Ï¡_šode
 = 
blkaddr
;

223 ià(
	`is_d’t_dnode
(
·ge
))

224 
’Œy
->
Ï¡_d’Œy
 = 
blkaddr
;

226 
Ãxt
:

228 
blkaddr
 = 
	`Ãxt_blkaddr_of_node
(
·ge
);

229 
	`f2fs_put_·ge
(
·ge
, 1);

231 
	`f2fs_put_·ge
(
·ge
, 1);

232  
”r
;

233 
	}
}

235 
	$de¡roy_fsync_dnodes
(
li¡_h—d
 *
h—d
)

237 
fsync_šode_’Œy
 *
’Œy
, *
tmp
;

239 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
tmp
, 
h—d
, 
li¡
) {

240 
	`ut
(
’Œy
->
šode
);

241 
	`li¡_d–
(&
’Œy
->
li¡
);

242 
	`kmem_ÿche_ä“
(
fsync_’Œy_¦ab
, 
’Œy
);

244 
	}
}

246 
	$check_šdex_š_´ev_nodes
(
f2fs_sb_šfo
 *
sbi
,

247 
block_t
 
blkaddr
, 
dnode_of_d©a
 *
dn
)

249 
£g_’Œy
 *
£Áry
;

250 
£gno
 = 
	`GET_SEGNO
(
sbi
, 
blkaddr
);

251 
blkoff
 = 
	`GET_BLKOFF_FROM_SEG0
(
sbi
, 
blkaddr
);

252 
f2fs_summ¬y_block
 *
sum_node
;

253 
f2fs_summ¬y
 
sum
;

254 
·ge
 *
sum_·ge
, *
node_·ge
;

255 
nid_t
 
šo
, 
nid
;

256 
šode
 *inode;

257 
off£t
;

258 
block_t
 
bidx
;

259 
i
;

261 
£Áry
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

262 ià(!
	`f2fs_‹¡_b™
(
blkoff
, 
£Áry
->
cur_v®id_m­
))

266 
i
 = 
CURSEG_WARM_DATA
; i <ğ
CURSEG_COLD_DATA
; i++) {

267 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
i
);

268 ià(
cur£g
->
£gno
 == segno) {

269 
sum
 = 
cur£g
->
sum_blk
->
’Œ›s
[
blkoff
];

270 
gÙ_™
;

274 
sum_·ge
 = 
	`g‘_sum_·ge
(
sbi
, 
£gno
);

275 
sum_node
 = (
f2fs_summ¬y_block
 *)
	`·ge_add»ss
(
sum_·ge
);

276 
sum
 = 
sum_node
->
’Œ›s
[
blkoff
];

277 
	`f2fs_put_·ge
(
sum_·ge
, 1);

278 
gÙ_™
:

280 
nid
 = 
	`Ë32_to_ıu
(
sum
.nid);

281 ià(
dn
->
šode
->
i_šo
 =ğ
nid
) {

282 
dnode_of_d©a
 
tdn
 = *
dn
;

283 
tdn
.
nid
 =‚id;

284 
tdn
.
node_·ge
 = 
dn
->
šode_·ge
;

285 
tdn
.
ofs_š_node
 = 
	`Ë16_to_ıu
(
sum
.ofs_in_node);

286 
	`Œunÿ‹_d©a_blocks_¿nge
(&
tdn
, 1);

288 } ià(
dn
->
nid
 ==‚id) {

289 
dnode_of_d©a
 
tdn
 = *
dn
;

290 
tdn
.
ofs_š_node
 = 
	`Ë16_to_ıu
(
sum
.ofs_in_node);

291 
	`Œunÿ‹_d©a_blocks_¿nge
(&
tdn
, 1);

296 
node_·ge
 = 
	`g‘_node_·ge
(
sbi
, 
nid
);

297 ià(
	`IS_ERR
(
node_·ge
))

298  
	`PTR_ERR
(
node_·ge
);

300 
off£t
 = 
	`ofs_of_node
(
node_·ge
);

301 
šo
 = 
	`šo_of_node
(
node_·ge
);

302 
	`f2fs_put_·ge
(
node_·ge
, 1);

304 ià(
šo
 !ğ
dn
->
šode
->
i_šo
) {

306 
šode
 = 
	`f2fs_ig‘
(
sbi
->
sb
, 
šo
);

307 ià(
	`IS_ERR
(
šode
))

308  
	`PTR_ERR
(
šode
);

310 
šode
 = 
dn
->inode;

313 
bidx
 = 
	`¡¬t_bidx_of_node
(
off£t
, 
	`F2FS_I
(
šode
)) +

314 
	`Ë16_to_ıu
(
sum
.
ofs_š_node
);

316 ià(
šo
 !ğ
dn
->
šode
->
i_šo
) {

317 
	`Œunÿ‹_hŞe
(
šode
, 
bidx
, bidx + 1);

318 
	`ut
(
šode
);

320 
dnode_of_d©a
 
tdn
;

321 
	`£t_Ãw_dnode
(&
tdn
, 
šode
, 
dn
->
šode_·ge
, 
NULL
, 0);

322 ià(
	`g‘_dnode_of_d©a
(&
tdn
, 
bidx
, 
LOOKUP_NODE
))

324 ià(
tdn
.
d©a_blkaddr
 !ğ
NULL_ADDR
)

325 
	`Œunÿ‹_d©a_blocks_¿nge
(&
tdn
, 1);

326 
	`f2fs_put_·ge
(
tdn
.
node_·ge
, 1);

329 
	}
}

331 
	$do_»cov”_d©a
(
f2fs_sb_šfo
 *
sbi
, 
šode
 *inode,

332 
·ge
 *·ge, 
block_t
 
blkaddr
)

334 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

335 
¡¬t
, 
’d
;

336 
dnode_of_d©a
 
dn
;

337 
f2fs_summ¬y
 
sum
;

338 
node_šfo
 
ni
;

339 
”r
 = 0, 
»cov”ed
 = 0;

342 ià(
	`IS_INODE
(
·ge
)) {

343 
	`»cov”_šlše_x©Œ
(
šode
, 
·ge
);

344 } ià(
	`f2fs_has_x©Œ_block
(
	`ofs_of_node
(
·ge
))) {

345 
	`»cov”_x©Œ_d©a
(
šode
, 
·ge
, 
blkaddr
);

346 
out
;

350 ià(
	`»cov”_šlše_d©a
(
šode
, 
·ge
))

351 
out
;

354 
¡¬t
 = 
	`¡¬t_bidx_of_node
(
	`ofs_of_node
(
·ge
), 
fi
);

355 
’d
 = 
¡¬t
 + 
	`ADDRS_PER_PAGE
(
·ge
, 
fi
);

357 
	`f2fs_lock_İ
(
sbi
);

359 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 0);

361 
”r
 = 
	`g‘_dnode_of_d©a
(&
dn
, 
¡¬t
, 
ALLOC_NODE
);

362 ià(
”r
) {

363 
	`f2fs_uÆock_İ
(
sbi
);

364 
out
;

367 
	`f2fs_wa™_Ú_·ge_wr™eback
(
dn
.
node_·ge
, 
NODE
);

369 
	`g‘_node_šfo
(
sbi
, 
dn
.
nid
, &
ni
);

370 
	`f2fs_bug_Ú
(
sbi
, 
ni
.
šo
 !ğ
	`šo_of_node
(
·ge
));

371 
	`f2fs_bug_Ú
(
sbi
, 
	`ofs_of_node
(
dn
.
node_·ge
è!ğofs_of_node(
·ge
));

373 ; 
¡¬t
 < 
’d
; start++) {

374 
block_t
 
¤c
, 
de¡
;

376 
¤c
 = 
	`d©ablock_addr
(
dn
.
node_·ge
, dn.
ofs_š_node
);

377 
de¡
 = 
	`d©ablock_addr
(
·ge
, 
dn
.
ofs_š_node
);

379 ià(
¤c
 !ğ
de¡
 && de¡ !ğ
NEW_ADDR
 && de¡ !ğ
NULL_ADDR
) {

380 ià(
¤c
 =ğ
NULL_ADDR
) {

381 
”r
 = 
	`»£rve_Ãw_block
(&
dn
);

383 
	`f2fs_bug_Ú
(
sbi
, 
”r
);

387 
”r
 = 
	`check_šdex_š_´ev_nodes
(
sbi
, 
de¡
, &
dn
);

388 ià(
”r
)

389 
”r
;

391 
	`£t_summ¬y
(&
sum
, 
dn
.
nid
, dn.
ofs_š_node
, 
ni
.
v”siÚ
);

394 
	`»cov”_d©a_·ge
(
sbi
, 
NULL
, &
sum
, 
¤c
, 
de¡
);

395 
	`upd©e_ex‹Á_ÿche
(
de¡
, &
dn
);

396 
»cov”ed
++;

398 
dn
.
ofs_š_node
++;

402 
	`£t_summ¬y
(&
sum
, 
dn
.
nid
, 0, 0);

403 ià(
	`IS_INODE
(
dn
.
node_·ge
))

404 
	`sync_šode_·ge
(&
dn
);

406 
	`cİy_node_foÙ”
(
dn
.
node_·ge
, 
·ge
);

407 
	`fl_node_foÙ”
(
dn
.
node_·ge
, dn.
nid
, 
ni
.
šo
,

408 
	`ofs_of_node
(
·ge
), 
çl£
);

409 
	`£t_·ge_dœty
(
dn
.
node_·ge
);

410 
”r
:

411 
	`f2fs_put_dnode
(&
dn
);

412 
	`f2fs_uÆock_İ
(
sbi
);

413 
out
:

414 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_NOTICE
,

416 
šode
->
i_šo
, 
»cov”ed
, 
”r
);

417  
”r
;

418 
	}
}

420 
	$»cov”_d©a
(
f2fs_sb_šfo
 *
sbi
,

421 
li¡_h—d
 *
h—d
, 
ty³
)

423 
ı_v”
 = 
	`cur_ı_v”siÚ
(
	`F2FS_CKPT
(
sbi
));

424 
cur£g_šfo
 *
cur£g
;

425 
·ge
 *·gğ
NULL
;

426 
”r
 = 0;

427 
block_t
 
blkaddr
;

430 
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

431 
blkaddr
 = 
	`NEXT_FREE_BLKADDR
(
sbi
, 
cur£g
);

434 
fsync_šode_’Œy
 *
’Œy
;

436 ià(
blkaddr
 < 
	`MAIN_BLKADDR
(
sbi
è|| blkadd¸>ğ
	`MAX_BLKADDR
(sbi))

439 
·ge
 = 
	`g‘_m‘a_·ge_¿
(
sbi
, 
blkaddr
);

441 ià(
ı_v”
 !ğ
	`ıv”_of_node
(
·ge
)) {

442 
	`f2fs_put_·ge
(
·ge
, 1);

446 
’Œy
 = 
	`g‘_fsync_šode
(
h—d
, 
	`šo_of_node
(
·ge
));

447 ià(!
’Œy
)

448 
Ãxt
;

454 ià(
’Œy
->
Ï¡_šode
 =ğ
blkaddr
)

455 
	`»cov”_šode
(
’Œy
->
šode
, 
·ge
);

456 ià(
’Œy
->
Ï¡_d’Œy
 =ğ
blkaddr
) {

457 
”r
 = 
	`»cov”_d’Œy
(
’Œy
->
šode
, 
·ge
);

458 ià(
”r
) {

459 
	`f2fs_put_·ge
(
·ge
, 1);

463 
”r
 = 
	`do_»cov”_d©a
(
sbi
, 
’Œy
->
šode
, 
·ge
, 
blkaddr
);

464 ià(
”r
) {

465 
	`f2fs_put_·ge
(
·ge
, 1);

469 ià(
’Œy
->
blkaddr
 == blkaddr) {

470 
	`ut
(
’Œy
->
šode
);

471 
	`li¡_d–
(&
’Œy
->
li¡
);

472 
	`kmem_ÿche_ä“
(
fsync_’Œy_¦ab
, 
’Œy
);

474 
Ãxt
:

476 
blkaddr
 = 
	`Ãxt_blkaddr_of_node
(
·ge
);

477 
	`f2fs_put_·ge
(
·ge
, 1);

479 ià(!
”r
){

480 
	`®loÿ‹_Ãw_£gm’ts
(
sbi
);

482  
”r
;

483 
	}
}

485 
	$»cov”_fsync_d©a
(
f2fs_sb_šfo
 *
sbi
)

487 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_WARM_NODE
);

488 
li¡_h—d
 
šode_li¡
;

489 
block_t
 
blkaddr
;

490 
”r
;

491 
boŞ
 
Ãed_wr™eı
 = 
çl£
;

493 
fsync_’Œy_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("f2fs_fsync_inode_entry",

494 (
fsync_šode_’Œy
));

495 ià(!
fsync_’Œy_¦ab
)

496  -
ENOMEM
;

498 
	`INIT_LIST_HEAD
(&
šode_li¡
);

501 
sbi
->
pÜ_došg
 = 
Œue
;

504 
	`mu‹x_lock
(&
sbi
->
ı_mu‹x
);

506 
blkaddr
 = 
	`NEXT_FREE_BLKADDR
(
sbi
, 
cur£g
);

508 
”r
 = 
	`fšd_fsync_dnodes
(
sbi
, &
šode_li¡
);

510 ià(
”r
)

511 
out
;

513 ià(
	`li¡_em±y
(&
šode_li¡
))

514 
out
;

516 
Ãed_wr™eı
 = 
Œue
;

520 
”r
 = 
	`»cov”_d©a
(
sbi
, &
šode_li¡
, 
CURSEG_WARM_NODE
);

521 ià(!
”r
)

522 
	`f2fs_bug_Ú
(
sbi
, !
	`li¡_em±y
(&
šode_li¡
));

523 
out
:

524 
	`de¡roy_fsync_dnodes
(&
šode_li¡
);

525 
	`kmem_ÿche_de¡roy
(
fsync_’Œy_¦ab
);

528 
	`Œunÿ‹_šode_·ges_¿nge
(
	`META_MAPPING
(
sbi
),

529 
	`MAIN_BLKADDR
(
sbi
è<< 
PAGE_CACHE_SHIFT
, -1);

531 ià(
”r
) {

532 
	`Œunÿ‹_šode_·ges_fš®
(
	`NODE_MAPPING
(
sbi
));

533 
	`Œunÿ‹_šode_·ges_fš®
(
	`META_MAPPING
(
sbi
));

536 
sbi
->
pÜ_došg
 = 
çl£
;

537 ià(
”r
) {

538 
	`disÿrd_Ãxt_dnode
(
sbi
, 
blkaddr
);

541 
	`g‘_·ges
(
sbi
, 
F2FS_DIRTY_META
))

542 
	`sync_m‘a_·ges
(
sbi
, 
META
, 
LONG_MAX
);

543 
	`£t_ck±_æags
(
sbi
->
ck±
, 
CP_ERROR_FLAG
);

544 
	`mu‹x_uÆock
(&
sbi
->
ı_mu‹x
);

545 } ià(
Ãed_wr™eı
) {

546 
ı_cÚŒŞ
 
ıc
 = {

547 .
»asÚ
 = 
CP_SYNC
,

549 
	`mu‹x_uÆock
(&
sbi
->
ı_mu‹x
);

550 
	`wr™e_checkpošt
(
sbi
, &
ıc
);

552 
	`mu‹x_uÆock
(&
sbi
->
ı_mu‹x
);

554  
”r
;

555 
	}
}

	@segment.c

11 
	~<lšux/fs.h
>

12 
	~<lšux/f2fs_fs.h
>

13 
	~<lšux/bio.h
>

14 
	~<lšux/blkdev.h
>

15 
	~<lšux/´eãtch.h
>

16 
	~<lšux/kth»ad.h
>

17 
	~<lšux/vm®loc.h
>

18 
	~<lšux/sw­.h
>

20 
	~"f2fs.h
"

21 
	~"£gm’t.h
"

22 
	~"node.h
"

23 
	~<Œaû/ev’ts/f2fs.h
>

25 #ifdeà
F2FS_DA_MAP


26 
	~"gc.h
"

29 
	#__»v”£_ffz
(
x
è
	`__»v”£_ffs
(~(x))

	)

31 
kmem_ÿche
 *
	gdisÿrd_’Œy_¦ab
;

32 
kmem_ÿche
 *
	gs™_’Œy_£t_¦ab
;

33 
kmem_ÿche
 *
	gšmem_’Œy_¦ab
;

35 #ifdeà
F2FS_DA_MAP


36 
	ggc_block_off£t
 = 0;

37 
boŞ
 
	gF2FS_PLUG_ON
 = 
çl£
;

40 #ifdeà
F2FS_GET_FS_WAF


41 
	gËn_u£r_d©a
 = 0;

42 
	gËn_fs_wr™e
 = 0;

43 
	ggc_v®id_blocks_tÙ®
 = 0;

44 
	ggc_v®id_blocks_node
 = 0;

45 
	ggc_v®id_blocks_d©a
 = 0;

46 
	gdummy_·ge_couÁ
 = 0;

53 
šlše
 
	$__»v”£_ffs
(
wÜd
)

55 
num
 = 0;

57 #ià
BITS_PER_LONG
 == 64

58 ià((
wÜd
 & 0xffffffff) == 0) {

59 
num
 += 32;

60 
wÜd
 >>= 32;

63 ià((
wÜd
 & 0xffff) == 0) {

64 
num
 += 16;

65 
wÜd
 >>= 16;

67 ià((
wÜd
 & 0xff) == 0) {

68 
num
 += 8;

69 
wÜd
 >>= 8;

71 ià((
wÜd
 & 0xf0) == 0)

72 
num
 += 4;

74 
wÜd
 >>= 4;

75 ià((
wÜd
 & 0xc) == 0)

76 
num
 += 2;

78 
wÜd
 >>= 2;

79 ià((
wÜd
 & 0x2) == 0)

80 
num
 += 1;

81  
num
;

82 
	}
}

92 
	$__fšd_»v_Ãxt_b™
(cÚ¡ *
addr
,

93 
size
, 
off£t
)

95 cÚ¡ *
p
 = 
addr
 + 
	`BIT_WORD
(
off£t
);

96 
»suÉ
 = 
off£t
 & ~(
BITS_PER_LONG
 - 1);

97 
tmp
;

98 
mask
, 
submask
;

99 
quÙ
, 
»¡
;

101 ià(
off£t
 >ğ
size
)

102  
size
;

104 
size
 -ğ
»suÉ
;

105 
off£t
 %ğ
BITS_PER_LONG
;

106 ià(!
off£t
)

107 
®igÃd
;

109 
tmp
 = *(
p
++);

110 
quÙ
 = (
off£t
 >> 3) << 3;

111 
»¡
 = 
off£t
 & 0x7;

112 
mask
 = ~0UL << 
quÙ
;

113 
submask
 = ()(0xfà<< 
»¡
) >>„est;

114 
submask
 <<ğ
quÙ
;

115 
mask
 &ğ
submask
;

116 
tmp
 &ğ
mask
;

117 ià(
size
 < 
BITS_PER_LONG
)

118 
found_fœ¡
;

119 ià(
tmp
)

120 
found_middË
;

122 
size
 -ğ
BITS_PER_LONG
;

123 
»suÉ
 +ğ
BITS_PER_LONG
;

124 
®igÃd
:

125 
size
 & ~(
BITS_PER_LONG
-1)) {

126 
tmp
 = *(
p
++);

127 ià(
tmp
)

128 
found_middË
;

129 
»suÉ
 +ğ
BITS_PER_LONG
;

130 
size
 -ğ
BITS_PER_LONG
;

132 ià(!
size
)

133  
»suÉ
;

134 
tmp
 = *
p
;

135 
found_fœ¡
:

136 
tmp
 &ğ(~0UL >> (
BITS_PER_LONG
 - 
size
));

137 ià(
tmp
 == 0UL)

138  
»suÉ
 + 
size
;

139 
found_middË
:

140  
»suÉ
 + 
	`__»v”£_ffs
(
tmp
);

141 
	}
}

143 
	$__fšd_»v_Ãxt_z”o_b™
(cÚ¡ *
addr
,

144 
size
, 
off£t
)

146 cÚ¡ *
p
 = 
addr
 + 
	`BIT_WORD
(
off£t
);

147 
»suÉ
 = 
off£t
 & ~(
BITS_PER_LONG
 - 1);

148 
tmp
;

149 
mask
, 
submask
;

150 
quÙ
, 
»¡
;

152 ià(
off£t
 >ğ
size
)

153  
size
;

155 
size
 -ğ
»suÉ
;

156 
off£t
 %ğ
BITS_PER_LONG
;

157 ià(!
off£t
)

158 
®igÃd
;

160 
tmp
 = *(
p
++);

161 
quÙ
 = (
off£t
 >> 3) << 3;

162 
»¡
 = 
off£t
 & 0x7;

163 
mask
 = ~(~0UL << 
quÙ
);

164 
submask
 = ()~(()(0xfà<< 
»¡
) >>„est);

165 
submask
 <<ğ
quÙ
;

166 
mask
 +ğ
submask
;

167 
tmp
 |ğ
mask
;

168 ià(
size
 < 
BITS_PER_LONG
)

169 
found_fœ¡
;

170 ià(~
tmp
)

171 
found_middË
;

173 
size
 -ğ
BITS_PER_LONG
;

174 
»suÉ
 +ğ
BITS_PER_LONG
;

175 
®igÃd
:

176 
size
 & ~(
BITS_PER_LONG
 - 1)) {

177 
tmp
 = *(
p
++);

178 ià(~
tmp
)

179 
found_middË
;

180 
»suÉ
 +ğ
BITS_PER_LONG
;

181 
size
 -ğ
BITS_PER_LONG
;

183 ià(!
size
)

184  
»suÉ
;

185 
tmp
 = *
p
;

187 
found_fœ¡
:

188 
tmp
 |ğ~0UL << 
size
;

189 ià(
tmp
 == ~0UL)

190  
»suÉ
 + 
size
;

191 
found_middË
:

192  
»suÉ
 + 
	`__»v”£_ffz
(
tmp
);

193 
	}
}

195 
	$»gi¡”_šmem_·ge
(
šode
 *šode, 
·ge
 *page)

197 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

198 
šmem_·ges
 *
Ãw
;

200 
Ãw
 = 
	`f2fs_kmem_ÿche_®loc
(
šmem_’Œy_¦ab
, 
GFP_NOFS
);

203 
Ãw
->
·ge
 =…age;

204 
	`INIT_LIST_HEAD
(&
Ãw
->
li¡
);

207 
	`mu‹x_lock
(&
fi
->
šmem_lock
);

208 
	`g‘_·ge
(
·ge
);

209 
	`li¡_add_
(&
Ãw
->
li¡
, &
fi
->
šmem_·ges
);

210 
	`mu‹x_uÆock
(&
fi
->
šmem_lock
);

211 
	}
}

213 
	$comm™_šmem_·ges
(
šode
 *šode, 
boŞ
 
abÜt
)

215 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

216 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

217 
šmem_·ges
 *
cur
, *
tmp
;

218 
boŞ
 
subm™_bio
 = 
çl£
;

219 
f2fs_io_šfo
 
fio
 = {

220 .
ty³
 = 
DATA
,

221 .
rw
 = 
WRITE_SYNC
,

224 
	`f2fs_b®ªû_fs
(
sbi
);

225 
	`f2fs_lock_İ
(
sbi
);

227 
	`mu‹x_lock
(&
fi
->
šmem_lock
);

228 
	`li¡_fÜ_—ch_’Œy_§ã
(
cur
, 
tmp
, &
fi
->
šmem_·ges
, 
li¡
) {

229 
	`lock_·ge
(
cur
->
·ge
);

230 ià(!
abÜt
 && 
cur
->
·ge
->
m­pšg
 =ğ
šode
->
i_m­pšg
) {

231 
	`f2fs_wa™_Ú_·ge_wr™eback
(
cur
->
·ge
, 
DATA
);

232 ià(
	`ş—r_·ge_dœty_fÜ_io
(
cur
->
·ge
))

233 
	`šode_dec_dœty_·ges
(
šode
);

234 
	`do_wr™e_d©a_·ge
(
cur
->
·ge
, &
fio
);

235 
subm™_bio
 = 
Œue
;

237 
	`f2fs_put_·ge
(
cur
->
·ge
, 1);

238 
	`li¡_d–
(&
cur
->
li¡
);

239 
	`kmem_ÿche_ä“
(
šmem_’Œy_¦ab
, 
cur
);

241 ià(
subm™_bio
)

242 
	`f2fs_subm™_m”ged_bio
(
sbi
, 
DATA
, 
WRITE
);

243 
	`mu‹x_uÆock
(&
fi
->
šmem_lock
);

245 
	`fem­_fd©awa™_¿nge
(
šode
->
i_m­pšg
, 0, 
LLONG_MAX
);

246 
	`f2fs_uÆock_İ
(
sbi
);

247 
	}
}

253 
	$f2fs_b®ªû_fs
(
f2fs_sb_šfo
 *
sbi
)

259 ià(
	`has_nÙ_’ough_ä“_£cs
(
sbi
, 0)) {

260 
	`mu‹x_lock
(&
sbi
->
gc_mu‹x
);

261 
	`f2fs_gc
(
sbi
);

263 
	}
}

265 
	$f2fs_b®ªû_fs_bg
(
f2fs_sb_šfo
 *
sbi
)

268 ià(
	`Œy_to_ä“_Çts
(
sbi
, 
NAT_ENTRY_PER_BLOCK
) ||

269 
	`exûss_´eä“_£gs
(
sbi
))

270 
	`f2fs_sync_fs
(
sbi
->
sb
, 
Œue
);

271 
	}
}

273 
	$issue_æush_th»ad
(*
d©a
)

275 
f2fs_sb_šfo
 *
sbi
 = 
d©a
;

276 
æush_cmd_cÚŒŞ
 *
fcc
 = 
	`SM_I
(
sbi
)->
cmd_cÚŒŞ_šfo
;

277 
wa™_queue_h—d_t
 *
q
 = &
fcc
->
æush_wa™_queue
;

278 
»³©
:

279 ià(
	`kth»ad_should_¡İ
())

282 ià(!
	`Îi¡_em±y
(&
fcc
->
issue_li¡
)) {

283 
bio
 *biØğ
	`bio_®loc
(
GFP_NOIO
, 0);

284 
æush_cmd
 *
cmd
, *
Ãxt
;

285 
»t
;

287 
fcc
->
di¥©ch_li¡
 = 
	`Îi¡_d–_®l
(&fcc->
issue_li¡
);

288 
fcc
->
di¥©ch_li¡
 = 
	`Îi¡_»v”£_Üd”
(fcc->dispatch_list);

290 
bio
->
bi_bdev
 = 
sbi
->
sb
->
s_bdev
;

291 
»t
 = 
	`subm™_bio_wa™
(
WRITE_FLUSH
, 
bio
);

293 #ifdeà
F2FS_GET_FS_WAF


295 
Ën_fs_wr™e
 +ğ
bio
->
bi_vút
 * 4096;

299 
	`Îi¡_fÜ_—ch_’Œy_§ã
(
cmd
, 
Ãxt
,

300 
fcc
->
di¥©ch_li¡
, 
Înode
) {

301 
cmd
->
»t
 =„et;

302 
	`com¶‘e
(&
cmd
->
wa™
);

304 
	`bio_put
(
bio
);

305 
fcc
->
di¥©ch_li¡
 = 
NULL
;

308 
	`wa™_ev’t_š‹¼u±ibË
(*
q
,

309 
	`kth»ad_should_¡İ
(è|| !
	`Îi¡_em±y
(&
fcc
->
issue_li¡
));

310 
»³©
;

311 
	}
}

313 
	$f2fs_issue_æush
(
f2fs_sb_šfo
 *
sbi
)

315 
æush_cmd_cÚŒŞ
 *
fcc
 = 
	`SM_I
(
sbi
)->
cmd_cÚŒŞ_šfo
;

316 
æush_cmd
 
cmd
;

318 
	`Œaû_f2fs_issue_æush
(
sbi
->
sb
, 
	`‹¡_İt
(sbi, 
NOBARRIER
),

319 
	`‹¡_İt
(
sbi
, 
FLUSH_MERGE
));

321 ià(
	`‹¡_İt
(
sbi
, 
NOBARRIER
))

324 ià(!
	`‹¡_İt
(
sbi
, 
FLUSH_MERGE
))

325  
	`blkdev_issue_æush
(
sbi
->
sb
->
s_bdev
, 
GFP_KERNEL
, 
NULL
);

327 
	`š™_com¶‘iÚ
(&
cmd
.
wa™
);

329 
	`Îi¡_add
(&
cmd
.
Înode
, &
fcc
->
issue_li¡
);

331 ià(!
fcc
->
di¥©ch_li¡
)

332 
	`wake_up
(&
fcc
->
æush_wa™_queue
);

334 
	`wa™_fÜ_com¶‘iÚ
(&
cmd
.
wa™
);

336  
cmd
.
»t
;

337 
	}
}

339 
	$ü—‹_æush_cmd_cÚŒŞ
(
f2fs_sb_šfo
 *
sbi
)

341 
dev_t
 
dev
 = 
sbi
->
sb
->
s_bdev
->
bd_dev
;

342 
æush_cmd_cÚŒŞ
 *
fcc
;

343 
”r
 = 0;

345 
fcc
 = 
	`kz®loc
((
æush_cmd_cÚŒŞ
), 
GFP_KERNEL
);

346 ià(!
fcc
)

347  -
ENOMEM
;

348 
	`š™_wa™queue_h—d
(&
fcc
->
æush_wa™_queue
);

349 
	`š™_Îi¡_h—d
(&
fcc
->
issue_li¡
);

350 
	`SM_I
(
sbi
)->
cmd_cÚŒŞ_šfo
 = 
fcc
;

351 
fcc
->
f2fs_issue_æush
 = 
	`kth»ad_run
(
issue_æush_th»ad
, 
sbi
,

352 "f2fs_æush-%u:%u", 
	`MAJOR
(
dev
), 
	`MINOR
(dev));

353 ià(
	`IS_ERR
(
fcc
->
f2fs_issue_æush
)) {

354 
”r
 = 
	`PTR_ERR
(
fcc
->
f2fs_issue_æush
);

355 
	`kä“
(
fcc
);

356 
	`SM_I
(
sbi
)->
cmd_cÚŒŞ_šfo
 = 
NULL
;

357  
”r
;

360  
”r
;

361 
	}
}

363 
	$de¡roy_æush_cmd_cÚŒŞ
(
f2fs_sb_šfo
 *
sbi
)

365 
æush_cmd_cÚŒŞ
 *
fcc
 = 
	`SM_I
(
sbi
)->
cmd_cÚŒŞ_šfo
;

367 ià(
fcc
 && fcc->
f2fs_issue_æush
)

368 
	`kth»ad_¡İ
(
fcc
->
f2fs_issue_æush
);

369 
	`kä“
(
fcc
);

370 
	`SM_I
(
sbi
)->
cmd_cÚŒŞ_šfo
 = 
NULL
;

371 
	}
}

373 
	$__loÿ‹_dœty_£gm’t
(
f2fs_sb_šfo
 *
sbi
, 
£gno
,

374 
dœty_ty³
 dirty_type)

376 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

379 ià(
	`IS_CURSEG
(
sbi
, 
£gno
))

382 ià(!
	`‹¡_ªd_£t_b™
(
£gno
, 
dœty_i
->
dœty_£gm­
[
dœty_ty³
]))

383 
dœty_i
->
Ä_dœty
[
dœty_ty³
]++;

385 ià(
dœty_ty³
 =ğ
DIRTY
) {

386 
£g_’Œy
 *
£Áry
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

387 
dœty_ty³
 
t
 = 
£Áry
->
ty³
;

389 ià(
	`uÆik–y
(
t
 >ğ
DIRTY
)) {

390 
	`f2fs_bug_Ú
(
sbi
, 1);

393 ià(!
	`‹¡_ªd_£t_b™
(
£gno
, 
dœty_i
->
dœty_£gm­
[
t
]))

394 
dœty_i
->
Ä_dœty
[
t
]++;

396 
	}
}

398 
	$__»move_dœty_£gm’t
(
f2fs_sb_šfo
 *
sbi
, 
£gno
,

399 
dœty_ty³
 dirty_type)

401 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

403 ià(
	`‹¡_ªd_ş—r_b™
(
£gno
, 
dœty_i
->
dœty_£gm­
[
dœty_ty³
]))

404 
dœty_i
->
Ä_dœty
[
dœty_ty³
]--;

406 ià(
dœty_ty³
 =ğ
DIRTY
) {

407 
£g_’Œy
 *
£Áry
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

408 
dœty_ty³
 
t
 = 
£Áry
->
ty³
;

410 ià(
	`‹¡_ªd_ş—r_b™
(
£gno
, 
dœty_i
->
dœty_£gm­
[
t
]))

411 
dœty_i
->
Ä_dœty
[
t
]--;

413 ià(
	`g‘_v®id_blocks
(
sbi
, 
£gno
, sbi->
£gs_³r_£c
) == 0)

414 
	`ş—r_b™
(
	`GET_SECNO
(
sbi
, 
£gno
),

415 
dœty_i
->
viùim_£cm­
);

417 
	}
}

424 #ifdeà
F2FS_DA_MAP


425 
	$loÿ‹_dœty_£gm’t
(
f2fs_sb_šfo
 *
sbi
, 
£gno
)

427 
	$loÿ‹_dœty_£gm’t
(
f2fs_sb_šfo
 *
sbi
, 
£gno
)

430 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

431 
v®id_blocks
;

433 ià(
£gno
 =ğ
NULL_SEGNO
 || 
	`IS_CURSEG
(
sbi
, segno))

436 
	`mu‹x_lock
(&
dœty_i
->
£gli¡_lock
);

438 
v®id_blocks
 = 
	`g‘_v®id_blocks
(
sbi
, 
£gno
, 0);

440 ià(
v®id_blocks
 == 0) {

441 
	`__loÿ‹_dœty_£gm’t
(
sbi
, 
£gno
, 
PRE
);

442 
	`__»move_dœty_£gm’t
(
sbi
, 
£gno
, 
DIRTY
);

443 } ià(
v®id_blocks
 < 
sbi
->
blocks_³r_£g
) {

444 
	`__loÿ‹_dœty_£gm’t
(
sbi
, 
£gno
, 
DIRTY
);

447 
	`__»move_dœty_£gm’t
(
sbi
, 
£gno
, 
DIRTY
);

450 
	`mu‹x_uÆock
(&
dœty_i
->
£gli¡_lock
);

451 
	}
}

453 
	$f2fs_issue_disÿrd
(
f2fs_sb_šfo
 *
sbi
,

454 
block_t
 
blk¡¬t
, block_ˆ
blkËn
)

456 
£ùÜ_t
 
¡¬t
 = 
	`SECTOR_FROM_BLOCK
(
blk¡¬t
);

457 
£ùÜ_t
 
Ën
 = 
	`SECTOR_FROM_BLOCK
(
blkËn
);

458 
	`Œaû_f2fs_issue_disÿrd
(
sbi
->
sb
, 
blk¡¬t
, 
blkËn
);

459  
	`blkdev_issue_disÿrd
(
sbi
->
sb
->
s_bdev
, 
¡¬t
, 
Ën
, 
GFP_NOFS
, 0);

460 
	}
}

462 
	$disÿrd_Ãxt_dnode
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
blkaddr
)

464 ià(
	`f2fs_issue_disÿrd
(
sbi
, 
blkaddr
, 1)) {

465 
·ge
 *·gğ
	`g¿b_m‘a_·ge
(
sbi
, 
blkaddr
);

467 
	`£t_·ge_dœty
(
·ge
);

468 
	`f2fs_put_·ge
(
·ge
, 1);

470 
	}
}

472 
	$add_disÿrd_addrs
(
f2fs_sb_šfo
 *
sbi
, 
ı_cÚŒŞ
 *
ıc
)

474 
li¡_h—d
 *
h—d
 = &
	`SM_I
(
sbi
)->
disÿrd_li¡
;

475 
disÿrd_’Œy
 *
Ãw
;

476 
’Œ›s
 = 
SIT_VBLOCK_MAP_SIZE
 / ();

477 
max_blocks
 = 
sbi
->
blocks_³r_£g
;

478 
£g_’Œy
 *
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
ıc
->
Œim_¡¬t
);

479 *
cur_m­
 = (*)
£
->
cur_v®id_m­
;

480 *
ck±_m­
 = (*)
£
->
ck±_v®id_m­
;

481 
dm­
[
’Œ›s
];

482 
¡¬t
 = 0, 
’d
 = -1;

483 
boŞ
 
fÜû
 = (
ıc
->
»asÚ
 =ğ
CP_DISCARD
);

484 
i
;

486 ià(!
fÜû
 && !
	`‹¡_İt
(
sbi
, 
DISCARD
))

489 ià(
fÜû
 && !
£
->
v®id_blocks
) {

490 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

496 
	`mu‹x_lock
(&
dœty_i
->
£gli¡_lock
);

497 ià(
	`‹¡_b™
(
ıc
->
Œim_¡¬t
, 
dœty_i
->
dœty_£gm­
[
PRE
])) {

498 
	`mu‹x_uÆock
(&
dœty_i
->
£gli¡_lock
);

499 
ıc
->
Œimmed
 +ğ
sbi
->
blocks_³r_£g
;

502 
	`mu‹x_uÆock
(&
dœty_i
->
£gli¡_lock
);

504 
Ãw
 = 
	`f2fs_kmem_ÿche_®loc
(
disÿrd_’Œy_¦ab
, 
GFP_NOFS
);

505 
	`INIT_LIST_HEAD
(&
Ãw
->
li¡
);

506 
Ãw
->
blkaddr
 = 
	`START_BLOCK
(
sbi
, 
ıc
->
Œim_¡¬t
);

507 
Ãw
->
Ën
 = 
sbi
->
blocks_³r_£g
;

508 
	`li¡_add_
(&
Ãw
->
li¡
, 
h—d
);

509 
	`SM_I
(
sbi
)->
Ä_disÿrds
 +ğsbi->
blocks_³r_£g
;

510 
ıc
->
Œimmed
 +ğ
sbi
->
blocks_³r_£g
;

515 ià(!
£
->
v®id_blocks
 || se->v®id_block =ğ
max_blocks
)

519 
i
 = 0; i < 
’Œ›s
; i++)

520 
dm­
[
i
] = (
cur_m­
[i] ^ 
ck±_m­
[i]) & ckpt_map[i];

522 
fÜû
 || 
	`SM_I
(
sbi
)->
Ä_disÿrds
 <ğSM_I(sbi)->
max_disÿrds
) {

523 
¡¬t
 = 
	`__fšd_»v_Ãxt_b™
(
dm­
, 
max_blocks
, 
’d
 + 1);

524 ià(
¡¬t
 >ğ
max_blocks
)

527 
’d
 = 
	`__fšd_»v_Ãxt_z”o_b™
(
dm­
, 
max_blocks
, 
¡¬t
 + 1);

529 ià(
’d
 - 
¡¬t
 < 
ıc
->
Œim_mšËn
)

532 
Ãw
 = 
	`f2fs_kmem_ÿche_®loc
(
disÿrd_’Œy_¦ab
, 
GFP_NOFS
);

533 
	`INIT_LIST_HEAD
(&
Ãw
->
li¡
);

534 
Ãw
->
blkaddr
 = 
	`START_BLOCK
(
sbi
, 
ıc
->
Œim_¡¬t
è+ 
¡¬t
;

535 
Ãw
->
Ën
 = 
’d
 - 
¡¬t
;

536 
ıc
->
Œimmed
 +ğ
’d
 - 
¡¬t
;

538 
	`li¡_add_
(&
Ãw
->
li¡
, 
h—d
);

539 
	`SM_I
(
sbi
)->
Ä_disÿrds
 +ğ
’d
 - 
¡¬t
;

541 
	}
}

543 
	$»Ëa£_disÿrd_addrs
(
f2fs_sb_šfo
 *
sbi
)

545 
li¡_h—d
 *
h—d
 = &(
	`SM_I
(
sbi
)->
disÿrd_li¡
);

546 
disÿrd_’Œy
 *
’Œy
, *
this
;

549 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
this
, 
h—d
, 
li¡
) {

550 
	`li¡_d–
(&
’Œy
->
li¡
);

551 
	`kmem_ÿche_ä“
(
disÿrd_’Œy_¦ab
, 
’Œy
);

553 
	}
}

558 
	$£t_´eä“_as_ä“_£gm’ts
(
f2fs_sb_šfo
 *
sbi
)

560 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

561 
£gno
;

563 
	`mu‹x_lock
(&
dœty_i
->
£gli¡_lock
);

564 
	`fÜ_—ch_£t_b™
(
£gno
, 
dœty_i
->
dœty_£gm­
[
PRE
], 
	`MAIN_SEGS
(
sbi
))

565 
	`__£t_‹¡_ªd_ä“
(
sbi
, 
£gno
);

566 
	`mu‹x_uÆock
(&
dœty_i
->
£gli¡_lock
);

567 
	}
}

572 #ifdeà
F2FS_DA_MAP


573 
	$subm™_ä“_£ùiÚ_numb”
(
f2fs_sb_šfo
 *
sbi
, 
£gno
)

575 
·ge
* 
Ãw_·ge
 = 
NULL
;

576 * 
d¡_addr
;

577 
šfo
[3];

578 
block_t
 
max_blkaddr
;

581 
Ãw_·ge
 = 
	`®loc_·ge
(
GFP_KERNEL
);

583 if(!
Ãw_·ge
){

584 
	`´štk
(
KERN_INFO
 "ERROR[submit_invalid_segment_number] Cannot‡llocate‡…age.\n");

585 
	`ä“_·ge
(()
Ãw_·ge
);

588 
	`£t_·ge_wr™eback
(
Ãw_·ge
);

589 
	`šc_·ge_couÁ
(
sbi
, 
F2FS_WRITEBACK
);

590 
	`uÆock_·ge
(
Ãw_·ge
);

592 
	`z”o_u£r_£gm’t
(
Ãw_·ge
, 0, 
PAGE_CACHE_SIZE
);

595 
max_blkaddr
 = 
	`MAX_BLKADDR
(
sbi
) + 2;

598 
d¡_addr
 = 
	`km­
(
Ãw_·ge
);

600 
šfo
[0] = 
£gno
;

601 
šfo
[1] = 
	`START_BLOCK
(
sbi
, 
£gno
) * 512;

602 
šfo
[2] = 
	`SEGMENT_SIZE
(
sbi
) / 512;

604 
	`memıy
(
d¡_addr
, 
šfo
, () * 3);

605 
	`kunm­
(
Ãw_·ge
);

608 
	`f2fs_subm™_·ge_bio
(
sbi
, 
Ãw_·ge
, 
max_blkaddr
 + 
gc_block_off£t
, 
WRITE_SYNC
);

610 #ifdeà
F2FS_GET_FS_WAF


616 
gc_block_off£t
++;

617 if(
	`uÆik–y
(
gc_block_off£t
 >= 262142)){

618 
gc_block_off£t
 = 0;

620 
	}
}

623 
	$ş—r_´eä“_£gm’ts
(
f2fs_sb_šfo
 *
sbi
)

625 
li¡_h—d
 *
h—d
 = &(
	`SM_I
(
sbi
)->
disÿrd_li¡
);

626 
disÿrd_’Œy
 *
’Œy
, *
this
;

627 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

628 *
´eä“_m­
 = 
dœty_i
->
dœty_£gm­
[
PRE
];

629 
¡¬t
 = 0, 
’d
 = -1;

631 #ifdeà
F2FS_DA_MAP


632 
´ev_£c_nb
 = -1;

633 
£c_nb
 = 0;

635 
	`mu‹x_lock
(&
dœty_i
->
£gli¡_lock
);

638 
i
;

639 
¡¬t
 = 
	`fšd_Ãxt_b™
(
´eä“_m­
, 
	`MAIN_SEGS
(
sbi
), 
’d
 + 1);

640 ià(
¡¬t
 >ğ
	`MAIN_SEGS
(
sbi
))

642 
’d
 = 
	`fšd_Ãxt_z”o_b™
(
´eä“_m­
, 
	`MAIN_SEGS
(
sbi
),

643 
¡¬t
 + 1);

645 
i
 = 
¡¬t
; i < 
’d
; i++){

646 
	`ş—r_b™
(
i
, 
´eä“_m­
);

647 #ifdeà
F2FS_DA_MAP


648 
£c_nb
 = 
	`GET_SECNO
(
sbi
, 
i
);

649 if(
´ev_£c_nb
 !ğ
£c_nb
){

651 
´ev_£c_nb
 = 
£c_nb
;

656 
dœty_i
->
Ä_dœty
[
PRE
] -ğ
’d
 - 
¡¬t
;

658 ià(!
	`‹¡_İt
(
sbi
, 
DISCARD
))

661 
	`f2fs_issue_disÿrd
(
sbi
, 
	`START_BLOCK
(sbi, 
¡¬t
),

662 (
’d
 - 
¡¬t
è<< 
sbi
->
log_blocks_³r_£g
);

664 
	`mu‹x_uÆock
(&
dœty_i
->
£gli¡_lock
);

667 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
this
, 
h—d
, 
li¡
) {

668 
	`f2fs_issue_disÿrd
(
sbi
, 
’Œy
->
blkaddr
,ƒÁry->
Ën
);

669 
	`li¡_d–
(&
’Œy
->
li¡
);

670 
	`SM_I
(
sbi
)->
Ä_disÿrds
 -ğ
’Œy
->
Ën
;

671 
	`kmem_ÿche_ä“
(
disÿrd_’Œy_¦ab
, 
’Œy
);

673 
	}
}

675 
boŞ
 
	$__m¬k_s™_’Œy_dœty
(
f2fs_sb_šfo
 *
sbi
, 
£gno
)

677 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

679 ià(!
	`__‹¡_ªd_£t_b™
(
£gno
, 
s™_i
->
dœty_£Ár›s_b™m­
)) {

680 
s™_i
->
dœty_£Ár›s
++;

681  
çl£
;

684  
Œue
;

685 
	}
}

687 
	$__£t_s™_’Œy_ty³
(
f2fs_sb_šfo
 *
sbi
, 
ty³
,

688 
£gno
, 
modif›d
)

690 
£g_’Œy
 *
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

691 
£
->
ty³
 =ype;

692 ià(
modif›d
)

693 
	`__m¬k_s™_’Œy_dœty
(
sbi
, 
£gno
);

694 
	}
}

696 #ifdeà
F2FS_DA_MAP


697 
	$upd©e_s™_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
blkaddr
, 
d–
)

699 
	$upd©e_s™_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
blkaddr
, 
d–
)

702 
£g_’Œy
 *
£
;

703 
£gno
, 
off£t
;

704 
Ãw_vblocks
;

706 
£gno
 = 
	`GET_SEGNO
(
sbi
, 
blkaddr
);

708 
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

710 
Ãw_vblocks
 = 
£
->
v®id_blocks
 + 
d–
;

711 
off£t
 = 
	`GET_BLKOFF_FROM_SEG0
(
sbi
, 
blkaddr
);

713 
	`f2fs_bug_Ú
(
sbi
, (
Ãw_vblocks
 >> (() << 3) ||

714 (
Ãw_vblocks
 > 
sbi
->
blocks_³r_£g
)));

716 
£
->
v®id_blocks
 = 
Ãw_vblocks
;

717 
£
->
mtime
 = 
	`g‘_mtime
(
sbi
);

718 
	`SIT_I
(
sbi
)->
max_mtime
 = 
£
->
mtime
;

721 ià(
d–
 > 0) {

722 ià(
	`f2fs_£t_b™
(
off£t
, 
£
->
cur_v®id_m­
))

723 
	`f2fs_bug_Ú
(
sbi
, 1);

725 ià(!
	`f2fs_ş—r_b™
(
off£t
, 
£
->
cur_v®id_m­
))

726 
	`f2fs_bug_Ú
(
sbi
, 1);

728 ià(!
	`f2fs_‹¡_b™
(
off£t
, 
£
->
ck±_v®id_m­
))

729 
£
->
ck±_v®id_blocks
 +ğ
d–
;

731 
	`__m¬k_s™_’Œy_dœty
(
sbi
, 
£gno
);

734 
	`SIT_I
(
sbi
)->
wr™‹n_v®id_blocks
 +ğ
d–
;

736 ià(
sbi
->
£gs_³r_£c
 > 1)

737 
	`g‘_£c_’Œy
(
sbi
, 
£gno
)->
v®id_blocks
 +ğ
d–
;

739 
	}
}

741 
	$»äesh_s™_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
Şd
, block_ˆ
Ãw
)

743 
	`upd©e_s™_’Œy
(
sbi
, 
Ãw
, 1);

744 ià(
	`GET_SEGNO
(
sbi
, 
Şd
è!ğ
NULL_SEGNO
)

745 
	`upd©e_s™_’Œy
(
sbi
, 
Şd
, -1);

747 
	`loÿ‹_dœty_£gm’t
(
sbi
, 
	`GET_SEGNO
(sbi, 
Şd
));

748 
	`loÿ‹_dœty_£gm’t
(
sbi
, 
	`GET_SEGNO
(sbi, 
Ãw
));

749 
	}
}

751 
	$šv®id©e_blocks
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
addr
)

753 
£gno
 = 
	`GET_SEGNO
(
sbi
, 
addr
);

754 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

756 
	`f2fs_bug_Ú
(
sbi
, 
addr
 =ğ
NULL_ADDR
);

757 ià(
addr
 =ğ
NEW_ADDR
)

761 
	`mu‹x_lock
(&
s™_i
->
£Áry_lock
);

763 
	`upd©e_s™_’Œy
(
sbi
, 
addr
, -1);

766 
	`loÿ‹_dœty_£gm’t
(
sbi
, 
£gno
);

768 
	`mu‹x_uÆock
(&
s™_i
->
£Áry_lock
);

769 
	}
}

774 #ifdeà
F2FS_DA_MAP


775 
	$__add_sum_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
ty³
,

776 
f2fs_summ¬y
 *
sum
)

778 
	$__add_sum_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
ty³
,

779 
f2fs_summ¬y
 *
sum
)

782 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

783 *
addr
 = 
cur£g
->
sum_blk
;

784 
addr
 +ğ
cur£g
->
Ãxt_blkoff
 * (
f2fs_summ¬y
);

785 
	`memıy
(
addr
, 
sum
, (
f2fs_summ¬y
));

786 
	}
}

791 
	$Åages_fÜ_summ¬y_æush
(
f2fs_sb_šfo
 *
sbi
)

793 
v®id_sum_couÁ
 = 0;

794 
i
, 
sum_š_·ge
;

796 
i
 = 
CURSEG_HOT_DATA
; i <ğ
CURSEG_COLD_DATA
; i++) {

797 ià(
sbi
->
ck±
->
®loc_ty³
[
i
] =ğ
SSR
)

798 
v®id_sum_couÁ
 +ğ
sbi
->
blocks_³r_£g
;

800 
v®id_sum_couÁ
 +ğ
	`cur£g_blkoff
(
sbi
, 
i
);

803 
sum_š_·ge
 = (
PAGE_CACHE_SIZE
 - 2 * 
SUM_JOURNAL_SIZE
 -

804 
SUM_FOOTER_SIZE
è/ 
SUMMARY_SIZE
;

805 ià(
v®id_sum_couÁ
 <ğ
sum_š_·ge
)

807 ià((
v®id_sum_couÁ
 - 
sum_š_·ge
) <=

808 (
PAGE_CACHE_SIZE
 - 
SUM_FOOTER_SIZE
è/ 
SUMMARY_SIZE
)

811 
	}
}

816 
·ge
 *
	$g‘_sum_·ge
(
f2fs_sb_šfo
 *
sbi
, 
£gno
)

818  
	`g‘_m‘a_·ge
(
sbi
, 
	`GET_SUM_BLOCK
(sbi, 
£gno
));

819 
	}
}

821 
	$wr™e_sum_·ge
(
f2fs_sb_šfo
 *
sbi
,

822 
f2fs_summ¬y_block
 *
sum_blk
, 
block_t
 
blk_addr
)

824 
·ge
 *·gğ
	`g¿b_m‘a_·ge
(
sbi
, 
blk_addr
);

825 *
kaddr
 = 
	`·ge_add»ss
(
·ge
);

826 
	`memıy
(
kaddr
, 
sum_blk
, 
PAGE_CACHE_SIZE
);

827 
	`£t_·ge_dœty
(
·ge
);

828 
	`f2fs_put_·ge
(
·ge
, 1);

829 
	}
}

831 
	$is_Ãxt_£gm’t_ä“
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

833 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

834 
£gno
 = 
cur£g
->segno + 1;

835 
ä“_£gm­_šfo
 *
ä“_i
 = 
	`FREE_I
(
sbi
);

837 ià(
£gno
 < 
	`MAIN_SEGS
(
sbi
è&& segnØ% sbi->
£gs_³r_£c
)

838  !
	`‹¡_b™
(
£gno
, 
ä“_i
->
ä“_£gm­
);

840 
	}
}

846 
	$g‘_Ãw_£gm’t
(
f2fs_sb_šfo
 *
sbi
,

847 *
Ãw£g
, 
boŞ
 
Ãw_£c
, 
dœ
)

849 
ä“_£gm­_šfo
 *
ä“_i
 = 
	`FREE_I
(
sbi
);

850 
£gno
, 
£úo
, 
zÚ’o
;

851 
tÙ®_zÚes
 = 
	`MAIN_SECS
(
sbi
è/ sbi->
£cs_³r_zÚe
;

852 
hšt
 = *
Ãw£g
 / 
sbi
->
£gs_³r_£c
;

853 
Şd_zÚ’o
 = 
	`GET_ZONENO_FROM_SEGNO
(
sbi
, *
Ãw£g
);

854 
Ëá_¡¬t
 = 
hšt
;

855 
boŞ
 
š™
 = 
Œue
;

856 
go_Ëá
 = 0;

857 
i
;

859 
	`wr™e_lock
(&
ä“_i
->
£gm­_lock
);

861 ià(!
Ãw_£c
 && ((*
Ãw£g
 + 1è% 
sbi
->
£gs_³r_£c
)) {

862 
£gno
 = 
	`fšd_Ãxt_z”o_b™
(
ä“_i
->
ä“_£gm­
,

863 
	`MAIN_SEGS
(
sbi
), *
Ãw£g
 + 1);

864 ià(
£gno
 - *
Ãw£g
 < 
sbi
->
£gs_³r_£c
 -

865 (*
Ãw£g
 % 
sbi
->
£gs_³r_£c
))

866 
gÙ_™
;

868 
fšd_Ùh”_zÚe
:

869 
£úo
 = 
	`fšd_Ãxt_z”o_b™
(
ä“_i
->
ä“_£cm­
, 
	`MAIN_SECS
(
sbi
), 
hšt
);

870 ià(
£úo
 >ğ
	`MAIN_SECS
(
sbi
)) {

871 ià(
dœ
 =ğ
ALLOC_RIGHT
) {

872 
£úo
 = 
	`fšd_Ãxt_z”o_b™
(
ä“_i
->
ä“_£cm­
,

873 
	`MAIN_SECS
(
sbi
), 0);

874 
	`f2fs_bug_Ú
(
sbi
, 
£úo
 >ğ
	`MAIN_SECS
(sbi));

876 
go_Ëá
 = 1;

877 
Ëá_¡¬t
 = 
hšt
 - 1;

880 ià(
go_Ëá
 == 0)

881 
sk_Ëá
;

883 
	`‹¡_b™
(
Ëá_¡¬t
, 
ä“_i
->
ä“_£cm­
)) {

884 ià(
Ëá_¡¬t
 > 0) {

885 
Ëá_¡¬t
--;

888 
Ëá_¡¬t
 = 
	`fšd_Ãxt_z”o_b™
(
ä“_i
->
ä“_£cm­
,

889 
	`MAIN_SECS
(
sbi
), 0);

890 
	`f2fs_bug_Ú
(
sbi
, 
Ëá_¡¬t
 >ğ
	`MAIN_SECS
(sbi));

893 
£úo
 = 
Ëá_¡¬t
;

894 
sk_Ëá
:

895 
hšt
 = 
£úo
;

896 
£gno
 = 
£úo
 * 
sbi
->
£gs_³r_£c
;

897 
zÚ’o
 = 
£úo
 / 
sbi
->
£cs_³r_zÚe
;

900 ià(!
š™
)

901 
gÙ_™
;

902 ià(
sbi
->
£cs_³r_zÚe
 == 1)

903 
gÙ_™
;

904 ià(
zÚ’o
 =ğ
Şd_zÚ’o
)

905 
gÙ_™
;

906 ià(
dœ
 =ğ
ALLOC_LEFT
) {

907 ià(!
go_Ëá
 && 
zÚ’o
 + 1 >ğ
tÙ®_zÚes
)

908 
gÙ_™
;

909 ià(
go_Ëá
 && 
zÚ’o
 == 0)

910 
gÙ_™
;

912 
i
 = 0; i < 
NR_CURSEG_TYPE
; i++)

913 ià(
	`CURSEG_I
(
sbi
, 
i
)->
zÚe
 =ğ
zÚ’o
)

916 ià(
i
 < 
NR_CURSEG_TYPE
) {

918 ià(
go_Ëá
)

919 
hšt
 = 
zÚ’o
 * 
sbi
->
£cs_³r_zÚe
 - 1;

920 ià(
zÚ’o
 + 1 >ğ
tÙ®_zÚes
)

921 
hšt
 = 0;

923 
hšt
 = (
zÚ’o
 + 1è* 
sbi
->
£cs_³r_zÚe
;

924 
š™
 = 
çl£
;

925 
fšd_Ùh”_zÚe
;

927 
gÙ_™
:

929 
	`f2fs_bug_Ú
(
sbi
, 
	`‹¡_b™
(
£gno
, 
ä“_i
->
ä“_£gm­
));

930 
	`__£t_šu£
(
sbi
, 
£gno
);

931 *
Ãw£g
 = 
£gno
;

932 
	`wr™e_uÆock
(&
ä“_i
->
£gm­_lock
);

933 
	}
}

935 
	$»£t_cur£g
(
f2fs_sb_šfo
 *
sbi
, 
ty³
, 
modif›d
)

937 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

938 
summ¬y_foÙ”
 *
sum_foÙ”
;

940 
cur£g
->
£gno
 = cur£g->
Ãxt_£gno
;

941 
cur£g
->
zÚe
 = 
	`GET_ZONENO_FROM_SEGNO
(
sbi
, cur£g->
£gno
);

942 
cur£g
->
Ãxt_blkoff
 = 0;

943 
cur£g
->
Ãxt_£gno
 = 
NULL_SEGNO
;

945 
sum_foÙ”
 = &(
cur£g
->
sum_blk
->
foÙ”
);

946 
	`mem£t
(
sum_foÙ”
, 0, (
summ¬y_foÙ”
));

947 ià(
	`IS_DATASEG
(
ty³
))

948 
	`SET_SUM_TYPE
(
sum_foÙ”
, 
SUM_TYPE_DATA
);

949 ià(
	`IS_NODESEG
(
ty³
))

950 
	`SET_SUM_TYPE
(
sum_foÙ”
, 
SUM_TYPE_NODE
);

951 
	`__£t_s™_’Œy_ty³
(
sbi
, 
ty³
, 
cur£g
->
£gno
, 
modif›d
);

952 
	}
}

958 
	$Ãw_cur£g
(
f2fs_sb_šfo
 *
sbi
, 
ty³
, 
boŞ
 
Ãw_£c
)

960 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

961 
£gno
 = 
cur£g
->segno;

962 
dœ
 = 
ALLOC_LEFT
;

964 
	`wr™e_sum_·ge
(
sbi
, 
cur£g
->
sum_blk
,

965 
	`GET_SUM_BLOCK
(
sbi
, 
£gno
));

966 ià(
ty³
 =ğ
CURSEG_WARM_DATA
 ||y³ =ğ
CURSEG_COLD_DATA
)

967 
dœ
 = 
ALLOC_RIGHT
;

969 ià(
	`‹¡_İt
(
sbi
, 
NOHEAP
))

970 
dœ
 = 
ALLOC_RIGHT
;

972 
	`g‘_Ãw_£gm’t
(
sbi
, &
£gno
, 
Ãw_£c
, 
dœ
);

973 
cur£g
->
Ãxt_£gno
 = 
£gno
;

974 
	`»£t_cur£g
(
sbi
, 
ty³
, 1);

975 
cur£g
->
®loc_ty³
 = 
LFS
;

976 
	}
}

978 
	$__Ãxt_ä“_blkoff
(
f2fs_sb_šfo
 *
sbi
,

979 
cur£g_šfo
 *
£g
, 
block_t
 
¡¬t
)

981 
£g_’Œy
 *
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
£g
->
£gno
);

982 
’Œ›s
 = 
SIT_VBLOCK_MAP_SIZE
 / ();

983 
rg‘_m­
[
’Œ›s
];

984 *
ck±_m­
 = (*)
£
->
ck±_v®id_m­
;

985 *
cur_m­
 = (*)
£
->
cur_v®id_m­
;

986 
i
, 
pos
;

988 
i
 = 0; i < 
’Œ›s
; i++)

989 
rg‘_m­
[
i
] = 
ck±_m­
[i] | 
cur_m­
[i];

991 
pos
 = 
	`__fšd_»v_Ãxt_z”o_b™
(
rg‘_m­
, 
sbi
->
blocks_³r_£g
, 
¡¬t
);

993 
£g
->
Ãxt_blkoff
 = 
pos
;

994 
	}
}

1001 #ifdeà
F2FS_DA_MAP


1002 
	$__»äesh_Ãxt_blkoff
(
f2fs_sb_šfo
 *
sbi
,

1003 
cur£g_šfo
 *
£g
)

1005 
	$__»äesh_Ãxt_blkoff
(
f2fs_sb_šfo
 *
sbi
,

1006 
cur£g_šfo
 *
£g
)

1009 ià(
£g
->
®loc_ty³
 =ğ
SSR
)

1010 
	`__Ãxt_ä“_blkoff
(
sbi
, 
£g
, seg->
Ãxt_blkoff
 + 1);

1012 
£g
->
Ãxt_blkoff
++;

1013 
	}
}

1019 
	$chªge_cur£g
(
f2fs_sb_šfo
 *
sbi
, 
ty³
, 
boŞ
 
»u£
)

1021 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

1022 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

1023 
Ãw_£gno
 = 
cur£g
->
Ãxt_£gno
;

1024 
f2fs_summ¬y_block
 *
sum_node
;

1025 
·ge
 *
sum_·ge
;

1027 
	`wr™e_sum_·ge
(
sbi
, 
cur£g
->
sum_blk
,

1028 
	`GET_SUM_BLOCK
(
sbi
, 
cur£g
->
£gno
));

1029 
	`__£t_‹¡_ªd_šu£
(
sbi
, 
Ãw_£gno
);

1031 
	`mu‹x_lock
(&
dœty_i
->
£gli¡_lock
);

1032 
	`__»move_dœty_£gm’t
(
sbi
, 
Ãw_£gno
, 
PRE
);

1033 
	`__»move_dœty_£gm’t
(
sbi
, 
Ãw_£gno
, 
DIRTY
);

1034 
	`mu‹x_uÆock
(&
dœty_i
->
£gli¡_lock
);

1036 
	`»£t_cur£g
(
sbi
, 
ty³
, 1);

1037 
cur£g
->
®loc_ty³
 = 
SSR
;

1038 
	`__Ãxt_ä“_blkoff
(
sbi
, 
cur£g
, 0);

1040 ià(
»u£
) {

1041 
sum_·ge
 = 
	`g‘_sum_·ge
(
sbi
, 
Ãw_£gno
);

1042 
sum_node
 = (
f2fs_summ¬y_block
 *)
	`·ge_add»ss
(
sum_·ge
);

1043 
	`memıy
(
cur£g
->
sum_blk
, 
sum_node
, 
SUM_ENTRY_SIZE
);

1044 
	`f2fs_put_·ge
(
sum_·ge
, 1);

1046 
	}
}

1048 #iâdeà
F2FS_DA_MAP


1049 
	$g‘_s¤_£gm’t
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

1051 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

1052 cÚ¡ 
viùim_£ËùiÚ
 *
v_İs
 = 
	`DIRTY_I
(
sbi
)->v_ops;

1054 ià(
	`IS_NODESEG
(
ty³
è|| !
	`has_nÙ_’ough_ä“_£cs
(
sbi
, 0))

1055  
v_İs
->
	`g‘_viùim
(
sbi
,

1056 &(
cur£g
)->
Ãxt_£gno
, 
BG_GC
, 
ty³
, 
SSR
);

1059 ; 
ty³
 >ğ
CURSEG_HOT_DATA
;ype--)

1060 ià(
v_İs
->
	`g‘_viùim
(
sbi
, &(
cur£g
)->
Ãxt_£gno
,

1061 
BG_GC
, 
ty³
, 
SSR
))

1064 
	}
}

1071 
	$®loÿ‹_£gm’t_by_deçuÉ
(
f2fs_sb_šfo
 *
sbi
,

1072 
ty³
, 
boŞ
 
fÜû
)

1074 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

1076 ià(
fÜû
)

1077 
	`Ãw_cur£g
(
sbi
, 
ty³
, 
Œue
);

1078 ià(
ty³
 =ğ
CURSEG_WARM_NODE
)

1079 
	`Ãw_cur£g
(
sbi
, 
ty³
, 
çl£
);

1080 ià(
cur£g
->
®loc_ty³
 =ğ
LFS
 && 
	`is_Ãxt_£gm’t_ä“
(
sbi
, 
ty³
))

1081 
	`Ãw_cur£g
(
sbi
, 
ty³
, 
çl£
);

1082 #iâdeà
F2FS_DA_MAP


1083 ià(
	`Ãed_SSR
(
sbi
è&& 
	`g‘_s¤_£gm’t
(sbi, 
ty³
))

1084 
	`chªge_cur£g
(
sbi
, 
ty³
, 
Œue
);

1087 
	`Ãw_cur£g
(
sbi
, 
ty³
, 
çl£
);

1089 
	`¡©_šc_£g_ty³
(
sbi
, 
cur£g
);

1090 
	}
}

1092 
	$®loÿ‹_Ãw_£gm’ts
(
f2fs_sb_šfo
 *
sbi
)

1094 
cur£g_šfo
 *
cur£g
;

1095 
Şd_cur£g
;

1096 
i
;

1098 
i
 = 
CURSEG_HOT_DATA
; i <ğ
CURSEG_COLD_DATA
; i++) {

1099 
cur£g
 = 
	`CURSEG_I
(
sbi
, 
i
);

1100 
Şd_cur£g
 = 
cur£g
->
£gno
;

1101 
	`SIT_I
(
sbi
)->
s_İs
->
	`®loÿ‹_£gm’t
(sbi, 
i
, 
Œue
);

1102 
	`loÿ‹_dœty_£gm’t
(
sbi
, 
Şd_cur£g
);

1104 
	}
}

1106 cÚ¡ 
£gm’t_®loÿtiÚ
 
	gdeçuÉ_§Îoc_İs
 = {

1107 .
®loÿ‹_£gm’t
 = 
®loÿ‹_£gm’t_by_deçuÉ
,

1110 
	$f2fs_Œim_fs
(
f2fs_sb_šfo
 *
sbi
, 
f¡rim_¿nge
 *
¿nge
)

1112 
__u64
 
¡¬t
 = 
¿nge
->¡¬ˆ>> 
sbi
->
log_blocksize
;

1113 
__u64
 
’d
 = 
¡¬t
 + (
¿nge
->
Ën
 >> 
sbi
->
log_blocksize
) - 1;

1114 
¡¬t_£gno
, 
’d_£gno
;

1115 
ı_cÚŒŞ
 
ıc
;

1117 ià(
¿nge
->
mšËn
 > 
	`SEGMENT_SIZE
(
sbi
è|| 
¡¬t
 >ğ
	`MAX_BLKADDR
(sbi) ||

1118 
¿nge
->
Ën
 < 
sbi
->
blocksize
)

1119  -
EINVAL
;

1121 ià(
’d
 <ğ
	`MAIN_BLKADDR
(
sbi
))

1122 
out
;

1125 
¡¬t_£gno
 = (
¡¬t
 <ğ
	`MAIN_BLKADDR
(
sbi
)è? 0 : 
	`GET_SEGNO
(sbi, start);

1126 
’d_£gno
 = (
’d
 >ğ
	`MAX_BLKADDR
(
sbi
)è? 
	`MAIN_SEGS
(sbi) - 1 :

1127 
	`GET_SEGNO
(
sbi
, 
’d
);

1128 
ıc
.
»asÚ
 = 
CP_DISCARD
;

1129 
ıc
.
Œim_¡¬t
 = 
¡¬t_£gno
;

1130 
ıc
.
Œim_’d
 = 
’d_£gno
;

1131 
ıc
.
Œim_mšËn
 = 
¿nge
->
mšËn
 >> 
sbi
->
log_blocksize
;

1132 
ıc
.
Œimmed
 = 0;

1135 
	`wr™e_checkpošt
(
sbi
, &
ıc
);

1136 
out
:

1137 
¿nge
->
Ën
 = 
ıc
.
Œimmed
 << 
sbi
->
log_blocksize
;

1139 
	}
}

1141 #ifdeà
F2FS_DA_MAP


1142 
boŞ
 
	$__has_cur£g_¥aû
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

1144 
boŞ
 
	$__has_cur£g_¥aû
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

1147 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

1149 ià(
cur£g
->
Ãxt_blkoff
 < 
sbi
->
blocks_³r_£g
)

1150  
Œue
;

1151  
çl£
;

1152 
	}
}

1154 
	$__g‘_£gm’t_ty³_2
(
·ge
 *·ge, 
·ge_ty³
 
p_ty³
)

1156 ià(
p_ty³
 =ğ
DATA
)

1157  
CURSEG_HOT_DATA
;

1159  
CURSEG_HOT_NODE
;

1160 
	}
}

1162 
	$__g‘_£gm’t_ty³_4
(
·ge
 *·ge, 
·ge_ty³
 
p_ty³
)

1164 ià(
p_ty³
 =ğ
DATA
) {

1165 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

1167 ià(
	`S_ISDIR
(
šode
->
i_mode
))

1168  
CURSEG_HOT_DATA
;

1170  
CURSEG_COLD_DATA
;

1172 ià(
	`IS_DNODE
(
·ge
è&& !
	`is_cŞd_node
(page))

1173  
CURSEG_HOT_NODE
;

1175  
CURSEG_COLD_NODE
;

1177 
	}
}

1179 
	$__g‘_£gm’t_ty³_6
(
·ge
 *·ge, 
·ge_ty³
 
p_ty³
)

1181 ià(
p_ty³
 =ğ
DATA
) {

1182 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

1184 ià(
	`S_ISDIR
(
šode
->
i_mode
))

1185  
CURSEG_HOT_DATA
;

1186 ià(
	`is_cŞd_d©a
(
·ge
è|| 
	`fe_is_cŞd
(
šode
))

1187  
CURSEG_COLD_DATA
;

1189  
CURSEG_WARM_DATA
;

1191 ià(
	`IS_DNODE
(
·ge
))

1192  
	`is_cŞd_node
(
·ge
è? 
CURSEG_WARM_NODE
 :

1193 
CURSEG_HOT_NODE
;

1195  
CURSEG_COLD_NODE
;

1197 
	}
}

1199 #ifdeà
F2FS_DA_MAP


1200 
	$__g‘_£gm’t_ty³
(
·ge
 *·ge, 
·ge_ty³
 
p_ty³
)

1202 
	$__g‘_£gm’t_ty³
(
·ge
 *·ge, 
·ge_ty³
 
p_ty³
)

1205 
	`F2FS_P_SB
(
·ge
)->
aùive_logs
) {

1207  
	`__g‘_£gm’t_ty³_2
(
·ge
, 
p_ty³
);

1209  
	`__g‘_£gm’t_ty³_4
(
·ge
, 
p_ty³
);

1212 
	`f2fs_bug_Ú
(
	`F2FS_P_SB
(
·ge
),

1213 
	`F2FS_P_SB
(
·ge
)->
aùive_logs
 !ğ
NR_CURSEG_TYPE
);

1215  
	`__g‘_£gm’t_ty³_6
(
·ge
, 
p_ty³
);

1216 
	}
}

1218 
	$g‘_Ãxt_d©a_block
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 *
Ãw_blkaddr
, 
ty³
)

1220 
cur£g_šfo
 *
cur£g
;

1221 
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

1223 
	`mu‹x_lock
(&
cur£g
->
cur£g_mu‹x
);

1225 *
Ãw_blkaddr
 = 
	`NEXT_FREE_BLKADDR
(
sbi
, 
cur£g
);

1227 
	`mu‹x_uÆock
(&
cur£g
->
cur£g_mu‹x
);

1228 
	}
}

1230 
	$®loÿ‹_d©a_block
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page,

1231 
block_t
 
Şd_blkaddr
, block_ˆ*
Ãw_blkaddr
,

1232 
f2fs_summ¬y
 *
sum
, 
ty³
)

1234 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

1235 
cur£g_šfo
 *
cur£g
;

1237 
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

1239 
	`mu‹x_lock
(&
cur£g
->
cur£g_mu‹x
);

1241 *
Ãw_blkaddr
 = 
	`NEXT_FREE_BLKADDR
(
sbi
, 
cur£g
);

1248 
	`__add_sum_’Œy
(
sbi
, 
ty³
, 
sum
);

1250 
	`mu‹x_lock
(&
s™_i
->
£Áry_lock
);

1252 
	`__»äesh_Ãxt_blkoff
(
sbi
, 
cur£g
);

1254 
	`¡©_šc_block_couÁ
(
sbi
, 
cur£g
);

1256 ià(!
	`__has_cur£g_¥aû
(
sbi
, 
ty³
))

1257 
s™_i
->
s_İs
->
	`®loÿ‹_£gm’t
(
sbi
, 
ty³
, 
çl£
);

1262 #ifdeà
F2FS_DA_MAP_DBG


1263 
	`´štk
(" [JS DBG]‡Îoÿ‹ d©¨block, old: %d,‚ew: %d\n", 
Şd_blkaddr
, *
Ãw_blkaddr
);

1266 
	`»äesh_s™_’Œy
(
sbi
, 
Şd_blkaddr
, *
Ãw_blkaddr
);

1268 
	`mu‹x_uÆock
(&
s™_i
->
£Áry_lock
);

1270 ià(
·ge
 && 
	`IS_NODESEG
(
ty³
))

1271 
	`fl_node_foÙ”_blkaddr
(
·ge
, 
	`NEXT_FREE_BLKADDR
(
sbi
, 
cur£g
));

1273 
	`mu‹x_uÆock
(&
cur£g
->
cur£g_mu‹x
);

1274 
	}
}

1276 
	$do_wr™e_·ge
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page,

1277 
block_t
 
Şd_blkaddr
, block_ˆ*
Ãw_blkaddr
,

1278 
f2fs_summ¬y
 *
sum
, 
f2fs_io_šfo
 *
fio
)

1280 #ifdeà
F2FS_DA_MAP


1281 
f2fs_da_io_šfo
 
dio
;

1284 
ty³
 = 
	`__g‘_£gm’t_ty³
(
·ge
, 
fio
->type);

1286 #ifdeà
F2FS_DA_MAP


1287 
mu‹x
 
do_w_mu‹x
;

1288 
	`mu‹x_š™
(&
do_w_mu‹x
);

1291 
	`mu‹x_lock
(&
do_w_mu‹x
);

1294 
	`g‘_Ãxt_d©a_block
(
sbi
, 
Ãw_blkaddr
, 
ty³
);

1296 
dio
.
Şd_blkaddr
 = old_blkaddr;

1297 
dio
.
sum
 = sum;

1298 
dio
.
ty³
 =ype;

1301 
	`f2fs_subm™_·ge_mbio
(
sbi
, 
·ge
, *
Ãw_blkaddr
, 
fio
, &
dio
);

1302 *
Ãw_blkaddr
 = 
dio
.
Şd_blkaddr
;

1305 
	`mu‹x_uÆock
(&
do_w_mu‹x
);

1307 
	`®loÿ‹_d©a_block
(
sbi
, 
·ge
, 
Şd_blkaddr
, 
Ãw_blkaddr
, 
sum
, 
ty³
);

1310 
	`f2fs_subm™_·ge_mbio
(
sbi
, 
·ge
, *
Ãw_blkaddr
);

1312 
	}
}

1314 
	$wr™e_m‘a_·ge
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page)

1316 
f2fs_io_šfo
 
fio
 = {

1317 .
ty³
 = 
META
,

1318 .
rw
 = 
WRITE_SYNC
 | 
REQ_META
 | 
REQ_PRIO


1321 
	`£t_·ge_wr™eback
(
·ge
);

1323 #ifdeà
F2FS_DA_MAP


1324 
	`f2fs_subm™_·ge_mbio
(
sbi
, 
·ge
,…age->
šdex
, &
fio
, 
NULL
);

1326 
	`f2fs_subm™_·ge_mbio
(
sbi
, 
·ge
,…age->
šdex
, &
fio
);

1328 
	}
}

1330 
	$wr™e_node_·ge
(
f2fs_sb_šfo
 *
sbi
, 
·ge
 *page,

1331 
f2fs_io_šfo
 *
fio
,

1332 
nid
, 
block_t
 
Şd_blkaddr
, block_ˆ*
Ãw_blkaddr
)

1334 
f2fs_summ¬y
 
sum
;

1335 
	`£t_summ¬y
(&
sum
, 
nid
, 0, 0);

1336 
	`do_wr™e_·ge
(
sbi
, 
·ge
, 
Şd_blkaddr
, 
Ãw_blkaddr
, &
sum
, 
fio
);

1338 #ifdeà
F2FS_DA_MAP_DBG


1339 
	`´štk
("[JS DBG] Wr™node:‚id: %d,…age: %p, block: %d\n", 
nid
, 
·ge
, *
Ãw_blkaddr
);

1341 
	}
}

1343 
	$wr™e_d©a_·ge
(
·ge
 *·ge, 
dnode_of_d©a
 *
dn
,

1344 
block_t
 *
Ãw_blkaddr
, 
f2fs_io_šfo
 *
fio
)

1346 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
dn
->
šode
);

1347 
f2fs_summ¬y
 
sum
;

1348 
node_šfo
 
ni
;

1350 
	`f2fs_bug_Ú
(
sbi
, 
dn
->
d©a_blkaddr
 =ğ
NULL_ADDR
);

1351 
	`g‘_node_šfo
(
sbi
, 
dn
->
nid
, &
ni
);

1352 
	`£t_summ¬y
(&
sum
, 
dn
->
nid
, dn->
ofs_š_node
, 
ni
.
v”siÚ
);

1354 
	`do_wr™e_·ge
(
sbi
, 
·ge
, 
dn
->
d©a_blkaddr
, 
Ãw_blkaddr
, &
sum
, 
fio
);

1355 
	}
}

1357 
	$»wr™e_d©a_·ge
(
·ge
 *·ge, 
block_t
 
Şd_blkaddr
,

1358 
f2fs_io_šfo
 *
fio
)

1360 #ifdeà
F2FS_DA_MAP


1361 
	`f2fs_subm™_·ge_mbio
(
	`F2FS_P_SB
(
·ge
),…age, 
Şd_blkaddr
, 
fio
, 
NULL
);

1363 
	`f2fs_subm™_·ge_mbio
(
	`F2FS_P_SB
(
·ge
),…age, 
Şd_blkaddr
, 
fio
);

1365 
	}
}

1367 
	$»cov”_d©a_·ge
(
f2fs_sb_šfo
 *
sbi
,

1368 
·ge
 *·ge, 
f2fs_summ¬y
 *
sum
,

1369 
block_t
 
Şd_blkaddr
, block_ˆ
Ãw_blkaddr
)

1371 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

1372 
cur£g_šfo
 *
cur£g
;

1373 
£gno
, 
Şd_cur£gno
;

1374 
£g_’Œy
 *
£
;

1375 
ty³
;

1377 
£gno
 = 
	`GET_SEGNO
(
sbi
, 
Ãw_blkaddr
);

1378 
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

1379 
ty³
 = 
£
->type;

1381 ià(
£
->
v®id_blocks
 =ğ0 && !
	`IS_CURSEG
(
sbi
, 
£gno
)) {

1382 ià(
Şd_blkaddr
 =ğ
NULL_ADDR
)

1383 
ty³
 = 
CURSEG_COLD_DATA
;

1385 
ty³
 = 
CURSEG_WARM_DATA
;

1387 
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

1389 
	`mu‹x_lock
(&
cur£g
->
cur£g_mu‹x
);

1390 
	`mu‹x_lock
(&
s™_i
->
£Áry_lock
);

1392 
Şd_cur£gno
 = 
cur£g
->
£gno
;

1395 ià(
£gno
 !ğ
cur£g
->segno) {

1396 
cur£g
->
Ãxt_£gno
 = 
£gno
;

1397 
	`chªge_cur£g
(
sbi
, 
ty³
, 
Œue
);

1400 
cur£g
->
Ãxt_blkoff
 = 
	`GET_BLKOFF_FROM_SEG0
(
sbi
, 
Ãw_blkaddr
);

1401 
	`__add_sum_’Œy
(
sbi
, 
ty³
, 
sum
);

1403 
	`»äesh_s™_’Œy
(
sbi
, 
Şd_blkaddr
, 
Ãw_blkaddr
);

1404 
	`loÿ‹_dœty_£gm’t
(
sbi
, 
Şd_cur£gno
);

1406 
	`mu‹x_uÆock
(&
s™_i
->
£Áry_lock
);

1407 
	`mu‹x_uÆock
(&
cur£g
->
cur£g_mu‹x
);

1408 
	}
}

1410 
šlše
 
boŞ
 
	$is_m”ged_·ge
(
f2fs_sb_šfo
 *
sbi
,

1411 
·ge
 *·ge, 
·ge_ty³
 
ty³
)

1413 
·ge_ty³
 
bty³
 = 
	`PAGE_TYPE_OF_BIO
(
ty³
);

1414 
f2fs_bio_šfo
 *
io
 = &
sbi
->
wr™e_io
[
bty³
];

1415 
bio_vec
 *
bvec
;

1416 
i
;

1418 
	`down_»ad
(&
io
->
io_rw£m
);

1419 ià(!
io
->
bio
)

1420 
out
;

1422 
	`bio_fÜ_—ch_£gm’t_®l
(
bvec
, 
io
->
bio
, 
i
) {

1423 ià(
·ge
 =ğ
bvec
->
bv_·ge
) {

1424 
	`up_»ad
(&
io
->
io_rw£m
);

1425  
Œue
;

1429 
out
:

1430 
	`up_»ad
(&
io
->
io_rw£m
);

1431  
çl£
;

1432 
	}
}

1434 
	$f2fs_wa™_Ú_·ge_wr™eback
(
·ge
 *page,

1435 
·ge_ty³
 
ty³
)

1437 ià(
	`PageWr™eback
(
·ge
)) {

1438 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_P_SB
(
·ge
);

1440 ià(
	`is_m”ged_·ge
(
sbi
, 
·ge
, 
ty³
))

1441 
	`f2fs_subm™_m”ged_bio
(
sbi
, 
ty³
, 
WRITE
);

1442 
	`wa™_Ú_·ge_wr™eback
(
·ge
);

1444 
	}
}

1446 
	$»ad_com·ùed_summ¬›s
(
f2fs_sb_šfo
 *
sbi
)

1448 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

1449 
cur£g_šfo
 *
£g_i
;

1450 *
kaddr
;

1451 
·ge
 *page;

1452 
block_t
 
¡¬t
;

1453 
i
, 
j
, 
off£t
;

1455 
¡¬t
 = 
	`¡¬t_sum_block
(
sbi
);

1457 
·ge
 = 
	`g‘_m‘a_·ge
(
sbi
, 
¡¬t
++);

1458 
kaddr
 = (*)
	`·ge_add»ss
(
·ge
);

1461 
£g_i
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
);

1462 
	`memıy
(&
£g_i
->
sum_blk
->
n_Çts
, 
kaddr
, 
SUM_JOURNAL_SIZE
);

1465 
£g_i
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_DATA
);

1466 
	`memıy
(&
£g_i
->
sum_blk
->
n_s™s
, 
kaddr
 + 
SUM_JOURNAL_SIZE
,

1467 
SUM_JOURNAL_SIZE
);

1468 
off£t
 = 2 * 
SUM_JOURNAL_SIZE
;

1471 
i
 = 
CURSEG_HOT_DATA
; i <ğ
CURSEG_COLD_DATA
; i++) {

1472 
blk_off
;

1473 
£gno
;

1475 
£g_i
 = 
	`CURSEG_I
(
sbi
, 
i
);

1476 
£gno
 = 
	`Ë32_to_ıu
(
ck±
->
cur_d©a_£gno
[
i
]);

1477 
blk_off
 = 
	`Ë16_to_ıu
(
ck±
->
cur_d©a_blkoff
[
i
]);

1478 
£g_i
->
Ãxt_£gno
 = 
£gno
;

1479 
	`»£t_cur£g
(
sbi
, 
i
, 0);

1480 
£g_i
->
®loc_ty³
 = 
ck±
->®loc_ty³[
i
];

1481 
£g_i
->
Ãxt_blkoff
 = 
blk_off
;

1483 ià(
£g_i
->
®loc_ty³
 =ğ
SSR
)

1484 
blk_off
 = 
sbi
->
blocks_³r_£g
;

1486 
j
 = 0; j < 
blk_off
; j++) {

1487 
f2fs_summ¬y
 *
s
;

1488 
s
 = (
f2fs_summ¬y
 *)(
kaddr
 + 
off£t
);

1489 
£g_i
->
sum_blk
->
’Œ›s
[
j
] = *
s
;

1490 
off£t
 +ğ
SUMMARY_SIZE
;

1491 ià(
off£t
 + 
SUMMARY_SIZE
 <ğ
PAGE_CACHE_SIZE
 -

1492 
SUM_FOOTER_SIZE
)

1495 
	`f2fs_put_·ge
(
·ge
, 1);

1496 
·ge
 = 
NULL
;

1498 
·ge
 = 
	`g‘_m‘a_·ge
(
sbi
, 
¡¬t
++);

1499 
kaddr
 = (*)
	`·ge_add»ss
(
·ge
);

1500 
off£t
 = 0;

1503 
	`f2fs_put_·ge
(
·ge
, 1);

1505 
	}
}

1507 
	$»ad_nÜm®_summ¬›s
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

1509 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

1510 
f2fs_summ¬y_block
 *
sum
;

1511 
cur£g_šfo
 *
cur£g
;

1512 
·ge
 *
Ãw
;

1513 
blk_off
;

1514 
£gno
 = 0;

1515 
block_t
 
blk_addr
 = 0;

1518 ià(
	`IS_DATASEG
(
ty³
)) {

1519 
£gno
 = 
	`Ë32_to_ıu
(
ck±
->
cur_d©a_£gno
[
ty³
]);

1520 
blk_off
 = 
	`Ë16_to_ıu
(
ck±
->
cur_d©a_blkoff
[
ty³
 -

1521 
CURSEG_HOT_DATA
]);

1522 ià(
	`is_£t_ck±_æags
(
ck±
, 
CP_UMOUNT_FLAG
))

1523 
blk_addr
 = 
	`sum_blk_addr
(
sbi
, 
NR_CURSEG_TYPE
, 
ty³
);

1525 
blk_addr
 = 
	`sum_blk_addr
(
sbi
, 
NR_CURSEG_DATA_TYPE
, 
ty³
);

1527 
£gno
 = 
	`Ë32_to_ıu
(
ck±
->
cur_node_£gno
[
ty³
 -

1528 
CURSEG_HOT_NODE
]);

1529 
blk_off
 = 
	`Ë16_to_ıu
(
ck±
->
cur_node_blkoff
[
ty³
 -

1530 
CURSEG_HOT_NODE
]);

1531 ià(
	`is_£t_ck±_æags
(
ck±
, 
CP_UMOUNT_FLAG
))

1532 
blk_addr
 = 
	`sum_blk_addr
(
sbi
, 
NR_CURSEG_NODE_TYPE
,

1533 
ty³
 - 
CURSEG_HOT_NODE
);

1535 
blk_addr
 = 
	`GET_SUM_BLOCK
(
sbi
, 
£gno
);

1538 
Ãw
 = 
	`g‘_m‘a_·ge
(
sbi
, 
blk_addr
);

1539 
sum
 = (
f2fs_summ¬y_block
 *)
	`·ge_add»ss
(
Ãw
);

1541 ià(
	`IS_NODESEG
(
ty³
)) {

1542 ià(
	`is_£t_ck±_æags
(
ck±
, 
CP_UMOUNT_FLAG
)) {

1543 
f2fs_summ¬y
 *
ns
 = &
sum
->
’Œ›s
[0];

1544 
i
;

1545 
i
 = 0; i < 
sbi
->
blocks_³r_£g
; i++, 
ns
++) {

1546 
ns
->
v”siÚ
 = 0;

1547 
ns
->
ofs_š_node
 = 0;

1550 
”r
;

1552 
”r
 = 
	`»¡Üe_node_summ¬y
(
sbi
, 
£gno
, 
sum
);

1553 ià(
”r
) {

1554 
	`f2fs_put_·ge
(
Ãw
, 1);

1555  
”r
;

1561 
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

1562 
	`mu‹x_lock
(&
cur£g
->
cur£g_mu‹x
);

1563 
	`memıy
(
cur£g
->
sum_blk
, 
sum
, 
PAGE_CACHE_SIZE
);

1564 
cur£g
->
Ãxt_£gno
 = 
£gno
;

1565 
	`»£t_cur£g
(
sbi
, 
ty³
, 0);

1566 
cur£g
->
®loc_ty³
 = 
ck±
->®loc_ty³[
ty³
];

1567 
cur£g
->
Ãxt_blkoff
 = 
blk_off
;

1568 
	`mu‹x_uÆock
(&
cur£g
->
cur£g_mu‹x
);

1569 
	`f2fs_put_·ge
(
Ãw
, 1);

1571 
	}
}

1573 
	$»¡Üe_cur£g_summ¬›s
(
f2fs_sb_šfo
 *
sbi
)

1575 
ty³
 = 
CURSEG_HOT_DATA
;

1576 
”r
;

1578 ià(
	`is_£t_ck±_æags
(
	`F2FS_CKPT
(
sbi
), 
CP_COMPACT_SUM_FLAG
)) {

1580 ià(
	`»ad_com·ùed_summ¬›s
(
sbi
))

1581  -
EINVAL
;

1582 
ty³
 = 
CURSEG_HOT_NODE
;

1585 ; 
ty³
 <ğ
CURSEG_COLD_NODE
;ype++) {

1586 
”r
 = 
	`»ad_nÜm®_summ¬›s
(
sbi
, 
ty³
);

1587 ià(
”r
)

1588  
”r
;

1592 
	}
}

1594 
	$wr™e_com·ùed_summ¬›s
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
blkaddr
)

1596 
·ge
 *page;

1597 *
kaddr
;

1598 
f2fs_summ¬y
 *
summ¬y
;

1599 
cur£g_šfo
 *
£g_i
;

1600 
wr™‹n_size
 = 0;

1601 
i
, 
j
;

1603 
·ge
 = 
	`g¿b_m‘a_·ge
(
sbi
, 
blkaddr
++);

1604 
kaddr
 = (*)
	`·ge_add»ss
(
·ge
);

1607 
£g_i
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
);

1608 
	`memıy
(
kaddr
, &
£g_i
->
sum_blk
->
n_Çts
, 
SUM_JOURNAL_SIZE
);

1609 
wr™‹n_size
 +ğ
SUM_JOURNAL_SIZE
;

1612 
£g_i
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_DATA
);

1613 
	`memıy
(
kaddr
 + 
wr™‹n_size
, &
£g_i
->
sum_blk
->
n_s™s
,

1614 
SUM_JOURNAL_SIZE
);

1615 
wr™‹n_size
 +ğ
SUM_JOURNAL_SIZE
;

1618 
i
 = 
CURSEG_HOT_DATA
; i <ğ
CURSEG_COLD_DATA
; i++) {

1619 
blkoff
;

1620 
£g_i
 = 
	`CURSEG_I
(
sbi
, 
i
);

1621 ià(
sbi
->
ck±
->
®loc_ty³
[
i
] =ğ
SSR
)

1622 
blkoff
 = 
sbi
->
blocks_³r_£g
;

1624 
blkoff
 = 
	`cur£g_blkoff
(
sbi
, 
i
);

1626 
j
 = 0; j < 
blkoff
; j++) {

1627 ià(!
·ge
) {

1628 
·ge
 = 
	`g¿b_m‘a_·ge
(
sbi
, 
blkaddr
++);

1629 
kaddr
 = (*)
	`·ge_add»ss
(
·ge
);

1630 
wr™‹n_size
 = 0;

1632 
summ¬y
 = (
f2fs_summ¬y
 *)(
kaddr
 + 
wr™‹n_size
);

1633 *
summ¬y
 = 
£g_i
->
sum_blk
->
’Œ›s
[
j
];

1634 
wr™‹n_size
 +ğ
SUMMARY_SIZE
;

1636 ià(
wr™‹n_size
 + 
SUMMARY_SIZE
 <ğ
PAGE_CACHE_SIZE
 -

1637 
SUM_FOOTER_SIZE
)

1640 
	`£t_·ge_dœty
(
·ge
);

1641 
	`f2fs_put_·ge
(
·ge
, 1);

1642 
·ge
 = 
NULL
;

1645 ià(
·ge
) {

1646 
	`£t_·ge_dœty
(
·ge
);

1647 
	`f2fs_put_·ge
(
·ge
, 1);

1649 
	}
}

1651 
	$wr™e_nÜm®_summ¬›s
(
f2fs_sb_šfo
 *
sbi
,

1652 
block_t
 
blkaddr
, 
ty³
)

1654 
i
, 
’d
;

1655 ià(
	`IS_DATASEG
(
ty³
))

1656 
’d
 = 
ty³
 + 
NR_CURSEG_DATA_TYPE
;

1658 
’d
 = 
ty³
 + 
NR_CURSEG_NODE_TYPE
;

1660 
i
 = 
ty³
; i < 
’d
; i++) {

1661 
cur£g_šfo
 *
sum
 = 
	`CURSEG_I
(
sbi
, 
i
);

1662 
	`mu‹x_lock
(&
sum
->
cur£g_mu‹x
);

1663 
	`wr™e_sum_·ge
(
sbi
, 
sum
->
sum_blk
, 
blkaddr
 + (
i
 - 
ty³
));

1664 
	`mu‹x_uÆock
(&
sum
->
cur£g_mu‹x
);

1666 
	}
}

1668 
	$wr™e_d©a_summ¬›s
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
¡¬t_blk
)

1670 ià(
	`is_£t_ck±_æags
(
	`F2FS_CKPT
(
sbi
), 
CP_COMPACT_SUM_FLAG
))

1671 
	`wr™e_com·ùed_summ¬›s
(
sbi
, 
¡¬t_blk
);

1673 
	`wr™e_nÜm®_summ¬›s
(
sbi
, 
¡¬t_blk
, 
CURSEG_HOT_DATA
);

1674 
	}
}

1676 
	$wr™e_node_summ¬›s
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
¡¬t_blk
)

1678 ià(
	`is_£t_ck±_æags
(
	`F2FS_CKPT
(
sbi
), 
CP_UMOUNT_FLAG
))

1679 
	`wr™e_nÜm®_summ¬›s
(
sbi
, 
¡¬t_blk
, 
CURSEG_HOT_NODE
);

1680 
	}
}

1682 
	$lookup_jouº®_š_cursum
(
f2fs_summ¬y_block
 *
sum
, 
ty³
,

1683 
v®
, 
®loc
)

1685 
i
;

1687 ià(
ty³
 =ğ
NAT_JOURNAL
) {

1688 
i
 = 0; i < 
	`Çts_š_cursum
(
sum
); i++) {

1689 ià(
	`Ë32_to_ıu
(
	`nid_š_jouº®
(
sum
, 
i
)è=ğ
v®
)

1690  
i
;

1692 ià(
®loc
 && 
	`Çts_š_cursum
(
sum
è< 
NAT_JOURNAL_ENTRIES
)

1693  
	`upd©e_Çts_š_cursum
(
sum
, 1);

1694 } ià(
ty³
 =ğ
SIT_JOURNAL
) {

1695 
i
 = 0; i < 
	`s™s_š_cursum
(
sum
); i++)

1696 ià(
	`Ë32_to_ıu
(
	`£gno_š_jouº®
(
sum
, 
i
)è=ğ
v®
)

1697  
i
;

1698 ià(
®loc
 && 
	`s™s_š_cursum
(
sum
è< 
SIT_JOURNAL_ENTRIES
)

1699  
	`upd©e_s™s_š_cursum
(
sum
, 1);

1702 
	}
}

1704 
·ge
 *
	$g‘_cu¼’t_s™_·ge
(
f2fs_sb_šfo
 *
sbi
,

1705 
£gno
)

1707 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

1708 
off£t
 = 
	`SIT_BLOCK_OFFSET
(
£gno
);

1709 
block_t
 
blk_addr
 = 
s™_i
->
s™_ba£_addr
 + 
off£t
;

1711 
	`check_£g_¿nge
(
sbi
, 
£gno
);

1714 ià(
	`f2fs_‹¡_b™
(
off£t
, 
s™_i
->
s™_b™m­
))

1715 
blk_addr
 +ğ
s™_i
->
s™_blocks
;

1717  
	`g‘_m‘a_·ge
(
sbi
, 
blk_addr
);

1718 
	}
}

1720 
·ge
 *
	$g‘_Ãxt_s™_·ge
(
f2fs_sb_šfo
 *
sbi
,

1721 
¡¬t
)

1723 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

1724 
·ge
 *
¤c_·ge
, *
d¡_·ge
;

1725 
pgoff_t
 
¤c_off
, 
d¡_off
;

1726 *
¤c_addr
, *
d¡_addr
;

1728 
¤c_off
 = 
	`cu¼’t_s™_addr
(
sbi
, 
¡¬t
);

1729 
d¡_off
 = 
	`Ãxt_s™_addr
(
sbi
, 
¤c_off
);

1732 
¤c_·ge
 = 
	`g‘_m‘a_·ge
(
sbi
, 
¤c_off
);

1733 
d¡_·ge
 = 
	`g¿b_m‘a_·ge
(
sbi
, 
d¡_off
);

1734 
	`f2fs_bug_Ú
(
sbi
, 
	`PageDœty
(
¤c_·ge
));

1736 
¤c_addr
 = 
	`·ge_add»ss
(
¤c_·ge
);

1737 
d¡_addr
 = 
	`·ge_add»ss
(
d¡_·ge
);

1738 
	`memıy
(
d¡_addr
, 
¤c_addr
, 
PAGE_CACHE_SIZE
);

1740 
	`£t_·ge_dœty
(
d¡_·ge
);

1741 
	`f2fs_put_·ge
(
¤c_·ge
, 1);

1743 
	`£t_to_Ãxt_s™
(
s™_i
, 
¡¬t
);

1745  
d¡_·ge
;

1746 
	}
}

1748 
s™_’Œy_£t
 *
	$g¿b_s™_’Œy_£t
()

1750 
s™_’Œy_£t
 *
£s
 =

1751 
	`f2fs_kmem_ÿche_®loc
(
s™_’Œy_£t_¦ab
, 
GFP_ATOMIC
);

1753 
£s
->
’Œy_út
 = 0;

1754 
	`INIT_LIST_HEAD
(&
£s
->
£t_li¡
);

1755  
£s
;

1756 
	}
}

1758 
	$»Ëa£_s™_’Œy_£t
(
s™_’Œy_£t
 *
£s
)

1760 
	`li¡_d–
(&
£s
->
£t_li¡
);

1761 
	`kmem_ÿche_ä“
(
s™_’Œy_£t_¦ab
, 
£s
);

1762 
	}
}

1764 
	$adju¡_s™_’Œy_£t
(
s™_’Œy_£t
 *
£s
,

1765 
li¡_h—d
 *
h—d
)

1767 
s™_’Œy_£t
 *
Ãxt
 = 
£s
;

1769 ià(
	`li¡_is_Ï¡
(&
£s
->
£t_li¡
, 
h—d
))

1772 
	`li¡_fÜ_—ch_’Œy_cÚtšue
(
Ãxt
, 
h—d
, 
£t_li¡
)

1773 ià(
£s
->
’Œy_út
 <ğ
Ãxt
->entry_cnt)

1776 
	`li¡_move_
(&
£s
->
£t_li¡
, &
Ãxt
->set_list);

1777 
	}
}

1779 
	$add_s™_’Œy
(
£gno
, 
li¡_h—d
 *
h—d
)

1781 
s™_’Œy_£t
 *
£s
;

1782 
¡¬t_£gno
 = 
	`START_SEGNO
(
£gno
);

1784 
	`li¡_fÜ_—ch_’Œy
(
£s
, 
h—d
, 
£t_li¡
) {

1785 ià(
£s
->
¡¬t_£gno
 == start_segno) {

1786 
£s
->
’Œy_út
++;

1787 
	`adju¡_s™_’Œy_£t
(
£s
, 
h—d
);

1792 
£s
 = 
	`g¿b_s™_’Œy_£t
();

1794 
£s
->
¡¬t_£gno
 = start_segno;

1795 
£s
->
’Œy_út
++;

1796 
	`li¡_add
(&
£s
->
£t_li¡
, 
h—d
);

1797 
	}
}

1799 
	$add_s™s_š_£t
(
f2fs_sb_šfo
 *
sbi
)

1801 
f2fs_sm_šfo
 *
sm_šfo
 = 
	`SM_I
(
sbi
);

1802 
li¡_h—d
 *
£t_li¡
 = &
sm_šfo
->
s™_’Œy_£t
;

1803 *
b™m­
 = 
	`SIT_I
(
sbi
)->
dœty_£Ár›s_b™m­
;

1804 
£gno
;

1806 
	`fÜ_—ch_£t_b™
(
£gno
, 
b™m­
, 
	`MAIN_SEGS
(
sbi
))

1807 
	`add_s™_’Œy
(
£gno
, 
£t_li¡
);

1808 
	}
}

1810 
	$»move_s™s_š_jouº®
(
f2fs_sb_šfo
 *
sbi
)

1812 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_DATA
);

1813 
f2fs_summ¬y_block
 *
sum
 = 
cur£g
->
sum_blk
;

1814 
i
;

1816 
i
 = 
	`s™s_š_cursum
(
sum
) - 1; i >= 0; i--) {

1817 
£gno
;

1818 
boŞ
 
dœt›d
;

1820 
£gno
 = 
	`Ë32_to_ıu
(
	`£gno_š_jouº®
(
sum
, 
i
));

1821 
dœt›d
 = 
	`__m¬k_s™_’Œy_dœty
(
sbi
, 
£gno
);

1823 ià(!
dœt›d
)

1824 
	`add_s™_’Œy
(
£gno
, &
	`SM_I
(
sbi
)->
s™_’Œy_£t
);

1826 
	`upd©e_s™s_š_cursum
(
sum
, -
	`s™s_š_cursum
(sum));

1827 
	}
}

1833 
	$æush_s™_’Œ›s
(
f2fs_sb_šfo
 *
sbi
, 
ı_cÚŒŞ
 *
ıc
)

1835 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

1836 *
b™m­
 = 
s™_i
->
dœty_£Ár›s_b™m­
;

1837 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_DATA
);

1838 
f2fs_summ¬y_block
 *
sum
 = 
cur£g
->
sum_blk
;

1839 
s™_’Œy_£t
 *
£s
, *
tmp
;

1840 
li¡_h—d
 *
h—d
 = &
	`SM_I
(
sbi
)->
s™_’Œy_£t
;

1841 
boŞ
 
to_jouº®
 = 
Œue
;

1842 
£g_’Œy
 *
£
;

1844 
	`mu‹x_lock
(&
cur£g
->
cur£g_mu‹x
);

1845 
	`mu‹x_lock
(&
s™_i
->
£Áry_lock
);

1851 
	`add_s™s_š_£t
(
sbi
);

1858 ià(!
	`__has_cursum_¥aû
(
sum
, 
s™_i
->
dœty_£Ár›s
, 
SIT_JOURNAL
))

1859 
	`»move_s™s_š_jouº®
(
sbi
);

1861 ià(!
s™_i
->
dœty_£Ár›s
)

1862 
out
;

1869 
	`li¡_fÜ_—ch_’Œy_§ã
(
£s
, 
tmp
, 
h—d
, 
£t_li¡
) {

1870 
·ge
 *page;

1871 
f2fs_s™_block
 *
¿w_s™
 = 
NULL
;

1872 
¡¬t_£gno
 = 
£s
->start_segno;

1873 
’d
 = 
	`mš
(
¡¬t_£gno
 + 
SIT_ENTRY_PER_BLOCK
,

1874 ()
	`MAIN_SEGS
(
sbi
));

1875 
£gno
 = 
¡¬t_£gno
;

1877 ià(
to_jouº®
 &&

1878 !
	`__has_cursum_¥aû
(
sum
, 
£s
->
’Œy_út
, 
SIT_JOURNAL
))

1879 
to_jouº®
 = 
çl£
;

1881 ià(!
to_jouº®
) {

1882 
·ge
 = 
	`g‘_Ãxt_s™_·ge
(
sbi
, 
¡¬t_£gno
);

1883 
¿w_s™
 = 
	`·ge_add»ss
(
·ge
);

1887 
	`fÜ_—ch_£t_b™_äom
(
£gno
, 
b™m­
, 
’d
) {

1888 
off£t
, 
s™_off£t
;

1890 
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
£gno
);

1893 ià(
	`SM_I
(
sbi
)->
Ä_disÿrds
 < SM_I(sbi)->
max_disÿrds
) {

1894 
ıc
->
Œim_¡¬t
 = 
£gno
;

1895 
	`add_disÿrd_addrs
(
sbi
, 
ıc
);

1898 ià(
to_jouº®
) {

1899 
off£t
 = 
	`lookup_jouº®_š_cursum
(
sum
,

1900 
SIT_JOURNAL
, 
£gno
, 1);

1901 
	`f2fs_bug_Ú
(
sbi
, 
off£t
 < 0);

1902 
	`£gno_š_jouº®
(
sum
, 
off£t
) =

1903 
	`ıu_to_Ë32
(
£gno
);

1904 
	`£g_šfo_to_¿w_s™
(
£
,

1905 &
	`s™_š_jouº®
(
sum
, 
off£t
));

1907 
s™_off£t
 = 
	`SIT_ENTRY_OFFSET
(
s™_i
, 
£gno
);

1908 
	`£g_šfo_to_¿w_s™
(
£
,

1909 &
¿w_s™
->
’Œ›s
[
s™_off£t
]);

1912 
	`__ş—r_b™
(
£gno
, 
b™m­
);

1913 
s™_i
->
dœty_£Ár›s
--;

1914 
£s
->
’Œy_út
--;

1917 ià(!
to_jouº®
)

1918 
	`f2fs_put_·ge
(
·ge
, 1);

1920 
	`f2fs_bug_Ú
(
sbi
, 
£s
->
’Œy_út
);

1921 
	`»Ëa£_s™_’Œy_£t
(
£s
);

1924 
	`f2fs_bug_Ú
(
sbi
, !
	`li¡_em±y
(
h—d
));

1925 
	`f2fs_bug_Ú
(
sbi
, 
s™_i
->
dœty_£Ár›s
);

1926 
out
:

1927 ià(
ıc
->
»asÚ
 =ğ
CP_DISCARD
) {

1928 ; 
ıc
->
Œim_¡¬t
 <ğıc->
Œim_’d
; cpc->trim_start++)

1929 
	`add_disÿrd_addrs
(
sbi
, 
ıc
);

1931 
	`mu‹x_uÆock
(&
s™_i
->
£Áry_lock
);

1932 
	`mu‹x_uÆock
(&
cur£g
->
cur£g_mu‹x
);

1934 
	`£t_´eä“_as_ä“_£gm’ts
(
sbi
);

1935 
	}
}

1937 
	$bud_s™_šfo
(
f2fs_sb_šfo
 *
sbi
)

1939 
f2fs_su³r_block
 *
¿w_su³r
 = 
	`F2FS_RAW_SUPER
(
sbi
);

1940 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

1941 
s™_šfo
 *
s™_i
;

1942 
s™_£gs
, 
¡¬t
;

1943 *
¤c_b™m­
, *
d¡_b™m­
;

1944 
b™m­_size
;

1947 
s™_i
 = 
	`kz®loc
((
s™_šfo
), 
GFP_KERNEL
);

1948 ià(!
s™_i
)

1949  -
ENOMEM
;

1951 
	`SM_I
(
sbi
)->
s™_šfo
 = 
s™_i
;

1953 
s™_i
->
£Ár›s
 = 
	`vz®loc
(
	`MAIN_SEGS
(
sbi
è* (
£g_’Œy
));

1954 ià(!
s™_i
->
£Ár›s
)

1955  -
ENOMEM
;

1957 
b™m­_size
 = 
	`f2fs_b™m­_size
(
	`MAIN_SEGS
(
sbi
));

1958 
s™_i
->
dœty_£Ár›s_b™m­
 = 
	`kz®loc
(
b™m­_size
, 
GFP_KERNEL
);

1959 ià(!
s™_i
->
dœty_£Ár›s_b™m­
)

1960  -
ENOMEM
;

1962 
¡¬t
 = 0; s¹ < 
	`MAIN_SEGS
(
sbi
); start++) {

1963 
s™_i
->
£Ár›s
[
¡¬t
].
cur_v®id_m­


1964 ğ
	`kz®loc
(
SIT_VBLOCK_MAP_SIZE
, 
GFP_KERNEL
);

1965 
s™_i
->
£Ár›s
[
¡¬t
].
ck±_v®id_m­


1966 ğ
	`kz®loc
(
SIT_VBLOCK_MAP_SIZE
, 
GFP_KERNEL
);

1967 ià(!
s™_i
->
£Ár›s
[
¡¬t
].
cur_v®id_m­


1968 || !
s™_i
->
£Ár›s
[
¡¬t
].
ck±_v®id_m­
)

1969  -
ENOMEM
;

1972 ià(
sbi
->
£gs_³r_£c
 > 1) {

1973 
s™_i
->
£c_’Œ›s
 = 
	`vz®loc
(
	`MAIN_SECS
(
sbi
) *

1974 (
£c_’Œy
));

1975 ià(!
s™_i
->
£c_’Œ›s
)

1976  -
ENOMEM
;

1980 
s™_£gs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_s™
) >> 1;

1983 
b™m­_size
 = 
	`__b™m­_size
(
sbi
, 
SIT_BITMAP
);

1984 
¤c_b™m­
 = 
	`__b™m­_±r
(
sbi
, 
SIT_BITMAP
);

1986 
d¡_b™m­
 = 
	`kmemdup
(
¤c_b™m­
, 
b™m­_size
, 
GFP_KERNEL
);

1987 ià(!
d¡_b™m­
)

1988  -
ENOMEM
;

1991 
s™_i
->
s_İs
 = &
deçuÉ_§Îoc_İs
;

1993 
s™_i
->
s™_ba£_addr
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
s™_blkaddr
);

1994 
s™_i
->
s™_blocks
 = 
s™_£gs
 << 
sbi
->
log_blocks_³r_£g
;

1995 
s™_i
->
wr™‹n_v®id_blocks
 = 
	`Ë64_to_ıu
(
ck±
->
v®id_block_couÁ
);

1996 
s™_i
->
s™_b™m­
 = 
d¡_b™m­
;

1997 
s™_i
->
b™m­_size
 = bitmap_size;

1998 
s™_i
->
dœty_£Ár›s
 = 0;

1999 
s™_i
->
£Ás_³r_block
 = 
SIT_ENTRY_PER_BLOCK
;

2000 
s™_i
->
–­£d_time
 = 
	`Ë64_to_ıu
(
sbi
->
ck±
->elapsed_time);

2001 
s™_i
->
mouÁed_time
 = 
CURRENT_TIME_SEC
.
tv_£c
;

2002 
	`mu‹x_š™
(&
s™_i
->
£Áry_lock
);

2004 
	}
}

2006 
	$bud_ä“_£gm­
(
f2fs_sb_šfo
 *
sbi
)

2008 
ä“_£gm­_šfo
 *
ä“_i
;

2009 
b™m­_size
, 
£c_b™m­_size
;

2012 
ä“_i
 = 
	`kz®loc
((
ä“_£gm­_šfo
), 
GFP_KERNEL
);

2013 ià(!
ä“_i
)

2014  -
ENOMEM
;

2016 
	`SM_I
(
sbi
)->
ä“_šfo
 = 
ä“_i
;

2018 
b™m­_size
 = 
	`f2fs_b™m­_size
(
	`MAIN_SEGS
(
sbi
));

2019 
ä“_i
->
ä“_£gm­
 = 
	`km®loc
(
b™m­_size
, 
GFP_KERNEL
);

2020 ià(!
ä“_i
->
ä“_£gm­
)

2021  -
ENOMEM
;

2023 
£c_b™m­_size
 = 
	`f2fs_b™m­_size
(
	`MAIN_SECS
(
sbi
));

2024 
ä“_i
->
ä“_£cm­
 = 
	`km®loc
(
£c_b™m­_size
, 
GFP_KERNEL
);

2025 ià(!
ä“_i
->
ä“_£cm­
)

2026  -
ENOMEM
;

2029 
	`mem£t
(
ä“_i
->
ä“_£gm­
, 0xff, 
b™m­_size
);

2030 
	`mem£t
(
ä“_i
->
ä“_£cm­
, 0xff, 
£c_b™m­_size
);

2033 
ä“_i
->
¡¬t_£gno
 = 
	`GET_SEGNO_FROM_SEG0
(
sbi
, 
	`MAIN_BLKADDR
(sbi));

2034 
ä“_i
->
ä“_£gm’ts
 = 0;

2035 
ä“_i
->
ä“_£ùiÚs
 = 0;

2036 
	`rwlock_š™
(&
ä“_i
->
£gm­_lock
);

2038 
	}
}

2040 
	$bud_cur£g
(
f2fs_sb_šfo
 *
sbi
)

2042 
cur£g_šfo
 *
¬¿y
;

2043 
i
;

2045 
¬¿y
 = 
	`kÿÎoc
(
NR_CURSEG_TYPE
, (*¬¿y), 
GFP_KERNEL
);

2046 ià(!
¬¿y
)

2047  -
ENOMEM
;

2049 
	`SM_I
(
sbi
)->
cur£g_¬¿y
 = 
¬¿y
;

2051 
i
 = 0; i < 
NR_CURSEG_TYPE
; i++) {

2052 
	`mu‹x_š™
(&
¬¿y
[
i
].
cur£g_mu‹x
);

2053 
¬¿y
[
i
].
sum_blk
 = 
	`kz®loc
(
PAGE_CACHE_SIZE
, 
GFP_KERNEL
);

2054 ià(!
¬¿y
[
i
].
sum_blk
)

2055  -
ENOMEM
;

2056 
¬¿y
[
i
].
£gno
 = 
NULL_SEGNO
;

2057 
¬¿y
[
i
].
Ãxt_blkoff
 = 0;

2059  
	`»¡Üe_cur£g_summ¬›s
(
sbi
);

2060 
	}
}

2062 
	$bud_s™_’Œ›s
(
f2fs_sb_šfo
 *
sbi
)

2064 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

2065 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_DATA
);

2066 
f2fs_summ¬y_block
 *
sum
 = 
cur£g
->
sum_blk
;

2067 
s™_blk_út
 = 
	`SIT_BLK_CNT
(
sbi
);

2068 
i
, 
¡¬t
, 
’d
;

2069 
»aded
, 
¡¬t_blk
 = 0;

2070 
Ä·ges
 = 
	`MAX_BIO_BLOCKS
(
sbi
);

2073 
»aded
 = 
	`¿_m‘a_·ges
(
sbi
, 
¡¬t_blk
, 
Ä·ges
, 
META_SIT
);

2075 
¡¬t
 = 
¡¬t_blk
 * 
s™_i
->
£Ás_³r_block
;

2076 
’d
 = (
¡¬t_blk
 + 
»aded
è* 
s™_i
->
£Ás_³r_block
;

2078 ; 
¡¬t
 < 
’d
 && s¹ < 
	`MAIN_SEGS
(
sbi
); start++) {

2079 
£g_’Œy
 *
£
 = &
s™_i
->
£Ár›s
[
¡¬t
];

2080 
f2fs_s™_block
 *
s™_blk
;

2081 
f2fs_s™_’Œy
 
s™
;

2082 
·ge
 *page;

2084 
	`mu‹x_lock
(&
cur£g
->
cur£g_mu‹x
);

2085 
i
 = 0; i < 
	`s™s_š_cursum
(
sum
); i++) {

2086 ià(
	`Ë32_to_ıu
(
	`£gno_š_jouº®
(
sum
, 
i
))

2087 =ğ
¡¬t
) {

2088 
s™
 = 
	`s™_š_jouº®
(
sum
, 
i
);

2089 
	`mu‹x_uÆock
(&
cur£g
->
cur£g_mu‹x
);

2090 
gÙ_™
;

2093 
	`mu‹x_uÆock
(&
cur£g
->
cur£g_mu‹x
);

2095 
·ge
 = 
	`g‘_cu¼’t_s™_·ge
(
sbi
, 
¡¬t
);

2096 
s™_blk
 = (
f2fs_s™_block
 *)
	`·ge_add»ss
(
·ge
);

2097 
s™
 = 
s™_blk
->
’Œ›s
[
	`SIT_ENTRY_OFFSET
(
s™_i
, 
¡¬t
)];

2098 
	`f2fs_put_·ge
(
·ge
, 1);

2099 
gÙ_™
:

2100 
	`check_block_couÁ
(
sbi
, 
¡¬t
, &
s™
);

2101 
	`£g_šfo_äom_¿w_s™
(
£
, &
s™
);

2102 ià(
sbi
->
£gs_³r_£c
 > 1) {

2103 
£c_’Œy
 *
e
 = 
	`g‘_£c_’Œy
(
sbi
, 
¡¬t
);

2104 
e
->
v®id_blocks
 +ğ
£
->valid_blocks;

2107 
¡¬t_blk
 +ğ
»aded
;

2108 } 
¡¬t_blk
 < 
s™_blk_út
);

2109 
	}
}

2111 
	$š™_ä“_£gm­
(
f2fs_sb_šfo
 *
sbi
)

2113 
¡¬t
;

2114 
ty³
;

2116 
¡¬t
 = 0; s¹ < 
	`MAIN_SEGS
(
sbi
); start++) {

2117 
£g_’Œy
 *
£Áry
 = 
	`g‘_£g_’Œy
(
sbi
, 
¡¬t
);

2118 ià(!
£Áry
->
v®id_blocks
)

2119 
	`__£t_ä“
(
sbi
, 
¡¬t
);

2123 
ty³
 = 
CURSEG_HOT_DATA
;y³ <ğ
CURSEG_COLD_NODE
;ype++) {

2124 
cur£g_šfo
 *
cur£g_t
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

2125 
	`__£t_‹¡_ªd_šu£
(
sbi
, 
cur£g_t
->
£gno
);

2127 
	}
}

2129 
	$š™_dœty_£gm­
(
f2fs_sb_šfo
 *
sbi
)

2131 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

2132 
ä“_£gm­_šfo
 *
ä“_i
 = 
	`FREE_I
(
sbi
);

2133 
£gno
 = 0, 
off£t
 = 0;

2134 
v®id_blocks
;

2138 
£gno
 = 
	`fšd_Ãxt_šu£
(
ä“_i
, 
	`MAIN_SEGS
(
sbi
), 
off£t
);

2139 ià(
£gno
 >ğ
	`MAIN_SEGS
(
sbi
))

2141 
off£t
 = 
£gno
 + 1;

2142 
v®id_blocks
 = 
	`g‘_v®id_blocks
(
sbi
, 
£gno
, 0);

2143 ià(
v®id_blocks
 =ğ
sbi
->
blocks_³r_£g
 || !valid_blocks)

2145 ià(
v®id_blocks
 > 
sbi
->
blocks_³r_£g
) {

2146 
	`f2fs_bug_Ú
(
sbi
, 1);

2149 
	`mu‹x_lock
(&
dœty_i
->
£gli¡_lock
);

2150 
	`__loÿ‹_dœty_£gm’t
(
sbi
, 
£gno
, 
DIRTY
);

2151 
	`mu‹x_uÆock
(&
dœty_i
->
£gli¡_lock
);

2153 
	}
}

2155 
	$š™_viùim_£cm­
(
f2fs_sb_šfo
 *
sbi
)

2157 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

2158 
b™m­_size
 = 
	`f2fs_b™m­_size
(
	`MAIN_SECS
(
sbi
));

2160 
dœty_i
->
viùim_£cm­
 = 
	`kz®loc
(
b™m­_size
, 
GFP_KERNEL
);

2161 ià(!
dœty_i
->
viùim_£cm­
)

2162  -
ENOMEM
;

2164 
	}
}

2166 
	$bud_dœty_£gm­
(
f2fs_sb_šfo
 *
sbi
)

2168 
dœty_£gli¡_šfo
 *
dœty_i
;

2169 
b™m­_size
, 
i
;

2172 
dœty_i
 = 
	`kz®loc
((
dœty_£gli¡_šfo
), 
GFP_KERNEL
);

2173 ià(!
dœty_i
)

2174  -
ENOMEM
;

2176 
	`SM_I
(
sbi
)->
dœty_šfo
 = 
dœty_i
;

2177 
	`mu‹x_š™
(&
dœty_i
->
£gli¡_lock
);

2179 
b™m­_size
 = 
	`f2fs_b™m­_size
(
	`MAIN_SEGS
(
sbi
));

2181 
i
 = 0; i < 
NR_DIRTY_TYPE
; i++) {

2182 
dœty_i
->
dœty_£gm­
[
i
] = 
	`kz®loc
(
b™m­_size
, 
GFP_KERNEL
);

2183 ià(!
dœty_i
->
dœty_£gm­
[
i
])

2184  -
ENOMEM
;

2187 
	`š™_dœty_£gm­
(
sbi
);

2188  
	`š™_viùim_£cm­
(
sbi
);

2189 
	}
}

2194 
	$š™_mš_max_mtime
(
f2fs_sb_šfo
 *
sbi
)

2196 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

2197 
£gno
;

2199 
	`mu‹x_lock
(&
s™_i
->
£Áry_lock
);

2201 
s™_i
->
mš_mtime
 = 
LLONG_MAX
;

2203 
£gno
 = 0; segnØ< 
	`MAIN_SEGS
(
sbi
); segnØ+ğsbi->
£gs_³r_£c
) {

2204 
i
;

2205 
mtime
 = 0;

2207 
i
 = 0; i < 
sbi
->
£gs_³r_£c
; i++)

2208 
mtime
 +ğ
	`g‘_£g_’Œy
(
sbi
, 
£gno
 + 
i
)->mtime;

2210 
mtime
 = 
	`div_u64
(mtime, 
sbi
->
£gs_³r_£c
);

2212 ià(
s™_i
->
mš_mtime
 > 
mtime
)

2213 
s™_i
->
mš_mtime
 = 
mtime
;

2215 
s™_i
->
max_mtime
 = 
	`g‘_mtime
(
sbi
);

2216 
	`mu‹x_uÆock
(&
s™_i
->
£Áry_lock
);

2217 
	}
}

2219 
	$bud_£gm’t_mªag”
(
f2fs_sb_šfo
 *
sbi
)

2221 
f2fs_su³r_block
 *
¿w_su³r
 = 
	`F2FS_RAW_SUPER
(
sbi
);

2222 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

2223 
f2fs_sm_šfo
 *
sm_šfo
;

2224 
”r
;

2226 
sm_šfo
 = 
	`kz®loc
((
f2fs_sm_šfo
), 
GFP_KERNEL
);

2227 ià(!
sm_šfo
)

2228  -
ENOMEM
;

2231 
sbi
->
sm_šfo
 = sm_info;

2232 
sm_šfo
->
£g0_blkaddr
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t0_blkaddr
);

2233 
sm_šfo
->
maš_blkaddr
 = 
	`Ë32_to_ıu
(
¿w_su³r
->main_blkaddr);

2234 
sm_šfo
->
£gm’t_couÁ
 = 
	`Ë32_to_ıu
(
¿w_su³r
->segment_count);

2235 
sm_šfo
->
»£rved_£gm’ts
 = 
	`Ë32_to_ıu
(
ck±
->
rsvd_£gm’t_couÁ
);

2236 
sm_šfo
->
ovp_£gm’ts
 = 
	`Ë32_to_ıu
(
ck±
->
ov”´ov_£gm’t_couÁ
);

2237 
sm_šfo
->
maš_£gm’ts
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_maš
);

2238 
sm_šfo
->
s§_blkaddr
 = 
	`Ë32_to_ıu
(
¿w_su³r
->ssa_blkaddr);

2239 
sm_šfo
->
»c_´eä“_£gm’ts
 = sm_šfo->
maš_£gm’ts
 *

2240 
DEF_RECLAIM_PREFREE_SEGMENTS
 / 100;

2241 #ifdeà
F2FS_DA_MAP


2242 
sm_šfo
->
u_pŞicy
 = 1 << 
F2FS_IPU_DISABLE
;

2244 
sm_šfo
->
u_pŞicy
 = 1 << 
F2FS_IPU_FSYNC
;

2246 
sm_šfo
->
mš_u_ut
 = 
DEF_MIN_IPU_UTIL
;

2247 
sm_šfo
->
mš_fsync_blocks
 = 
DEF_MIN_FSYNC_BLOCKS
;

2249 
	`INIT_LIST_HEAD
(&
sm_šfo
->
disÿrd_li¡
);

2250 
sm_šfo
->
Ä_disÿrds
 = 0;

2251 
sm_šfo
->
max_disÿrds
 = 0;

2253 
	`INIT_LIST_HEAD
(&
sm_šfo
->
s™_’Œy_£t
);

2255 ià(
	`‹¡_İt
(
sbi
, 
FLUSH_MERGE
è&& !
	`f2fs_»adÚly
(sbi->
sb
)) {

2256 
”r
 = 
	`ü—‹_æush_cmd_cÚŒŞ
(
sbi
);

2257 ià(
”r
)

2258  
”r
;

2261 
”r
 = 
	`bud_s™_šfo
(
sbi
);

2262 ià(
”r
)

2263  
”r
;

2264 
”r
 = 
	`bud_ä“_£gm­
(
sbi
);

2265 ià(
”r
)

2266  
”r
;

2267 
”r
 = 
	`bud_cur£g
(
sbi
);

2268 ià(
”r
)

2269  
”r
;

2272 
	`bud_s™_’Œ›s
(
sbi
);

2274 
	`š™_ä“_£gm­
(
sbi
);

2275 
”r
 = 
	`bud_dœty_£gm­
(
sbi
);

2276 ià(
”r
)

2277  
”r
;

2279 
	`š™_mš_max_mtime
(
sbi
);

2281 
	}
}

2283 
	$disÿrd_dœty_£gm­
(
f2fs_sb_šfo
 *
sbi
,

2284 
dœty_ty³
 dirty_type)

2286 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

2288 
	`mu‹x_lock
(&
dœty_i
->
£gli¡_lock
);

2289 
	`kä“
(
dœty_i
->
dœty_£gm­
[
dœty_ty³
]);

2290 
dœty_i
->
Ä_dœty
[
dœty_ty³
] = 0;

2291 
	`mu‹x_uÆock
(&
dœty_i
->
£gli¡_lock
);

2292 
	}
}

2294 
	$de¡roy_viùim_£cm­
(
f2fs_sb_šfo
 *
sbi
)

2296 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

2297 
	`kä“
(
dœty_i
->
viùim_£cm­
);

2298 
	}
}

2300 
	$de¡roy_dœty_£gm­
(
f2fs_sb_šfo
 *
sbi
)

2302 
dœty_£gli¡_šfo
 *
dœty_i
 = 
	`DIRTY_I
(
sbi
);

2303 
i
;

2305 ià(!
dœty_i
)

2309 
i
 = 0; i < 
NR_DIRTY_TYPE
; i++)

2310 
	`disÿrd_dœty_£gm­
(
sbi
, 
i
);

2312 
	`de¡roy_viùim_£cm­
(
sbi
);

2313 
	`SM_I
(
sbi
)->
dœty_šfo
 = 
NULL
;

2314 
	`kä“
(
dœty_i
);

2315 
	}
}

2317 
	$de¡roy_cur£g
(
f2fs_sb_šfo
 *
sbi
)

2319 
cur£g_šfo
 *
¬¿y
 = 
	`SM_I
(
sbi
)->
cur£g_¬¿y
;

2320 
i
;

2322 ià(!
¬¿y
)

2324 
	`SM_I
(
sbi
)->
cur£g_¬¿y
 = 
NULL
;

2325 
i
 = 0; i < 
NR_CURSEG_TYPE
; i++)

2326 
	`kä“
(
¬¿y
[
i
].
sum_blk
);

2327 
	`kä“
(
¬¿y
);

2328 
	}
}

2330 
	$de¡roy_ä“_£gm­
(
f2fs_sb_šfo
 *
sbi
)

2332 
ä“_£gm­_šfo
 *
ä“_i
 = 
	`SM_I
(
sbi
)->
ä“_šfo
;

2333 ià(!
ä“_i
)

2335 
	`SM_I
(
sbi
)->
ä“_šfo
 = 
NULL
;

2336 
	`kä“
(
ä“_i
->
ä“_£gm­
);

2337 
	`kä“
(
ä“_i
->
ä“_£cm­
);

2338 
	`kä“
(
ä“_i
);

2339 
	}
}

2341 
	$de¡roy_s™_šfo
(
f2fs_sb_šfo
 *
sbi
)

2343 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

2344 
¡¬t
;

2346 ià(!
s™_i
)

2349 ià(
s™_i
->
£Ár›s
) {

2350 
¡¬t
 = 0; s¹ < 
	`MAIN_SEGS
(
sbi
); start++) {

2351 
	`kä“
(
s™_i
->
£Ár›s
[
¡¬t
].
cur_v®id_m­
);

2352 
	`kä“
(
s™_i
->
£Ár›s
[
¡¬t
].
ck±_v®id_m­
);

2355 
	`vä“
(
s™_i
->
£Ár›s
);

2356 
	`vä“
(
s™_i
->
£c_’Œ›s
);

2357 
	`kä“
(
s™_i
->
dœty_£Ár›s_b™m­
);

2359 
	`SM_I
(
sbi
)->
s™_šfo
 = 
NULL
;

2360 
	`kä“
(
s™_i
->
s™_b™m­
);

2361 
	`kä“
(
s™_i
);

2362 
	}
}

2364 
	$de¡roy_£gm’t_mªag”
(
f2fs_sb_šfo
 *
sbi
)

2366 
f2fs_sm_šfo
 *
sm_šfo
 = 
	`SM_I
(
sbi
);

2368 ià(!
sm_šfo
)

2370 
	`de¡roy_æush_cmd_cÚŒŞ
(
sbi
);

2371 
	`de¡roy_dœty_£gm­
(
sbi
);

2372 
	`de¡roy_cur£g
(
sbi
);

2373 
	`de¡roy_ä“_£gm­
(
sbi
);

2374 
	`de¡roy_s™_šfo
(
sbi
);

2375 
sbi
->
sm_šfo
 = 
NULL
;

2376 
	`kä“
(
sm_šfo
);

2377 
	}
}

2379 
__š™
 
	$ü—‹_£gm’t_mªag”_ÿches
()

2381 
disÿrd_’Œy_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("discard_entry",

2382 (
disÿrd_’Œy
));

2383 ià(!
disÿrd_’Œy_¦ab
)

2384 
ç
;

2386 
s™_’Œy_£t_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("sit_entry_set",

2387 (
Çt_’Œy_£t
));

2388 ià(!
s™_’Œy_£t_¦ab
)

2389 
de¡Üy_disÿrd_’Œy
;

2391 
šmem_’Œy_¦ab
 = 
	`f2fs_kmem_ÿche_ü—‹
("inmem_page_entry",

2392 (
šmem_·ges
));

2393 ià(!
šmem_’Œy_¦ab
)

2394 
de¡roy_s™_’Œy_£t
;

2397 
de¡roy_s™_’Œy_£t
:

2398 
	`kmem_ÿche_de¡roy
(
s™_’Œy_£t_¦ab
);

2399 
de¡Üy_disÿrd_’Œy
:

2400 
	`kmem_ÿche_de¡roy
(
disÿrd_’Œy_¦ab
);

2401 
ç
:

2402  -
ENOMEM
;

2403 
	}
}

2405 
	$de¡roy_£gm’t_mªag”_ÿches
()

2407 
	`kmem_ÿche_de¡roy
(
s™_’Œy_£t_¦ab
);

2408 
	`kmem_ÿche_de¡roy
(
disÿrd_’Œy_¦ab
);

2409 
	`kmem_ÿche_de¡roy
(
šmem_’Œy_¦ab
);

2410 
	}
}

	@segment.h

11 
	~<lšux/blkdev.h
>

14 
	#F2FS_DA_MAP


	)

15 
	#F2FS_GET_FS_WAF


	)

17 
	#F2FS_GET_VALID_BLOCKS_INFO


	)

19 
	#BIO_MAX_W_DUMMY
 129

	)

22 #ifdeà
F2FS_GET_FS_WAF


23 
	~<lšux/´oc_fs.h
>

26 
	#NAND_PAGE_SIZE
 8192

	)

27 
	#N_PAGE_ALIGN
 ((
NAND_PAGE_SIZE
)/(
PAGE_SIZE
))

	)

30 
	#NULL_SEGNO
 (()(~0))

	)

31 
	#NULL_SECNO
 (()(~0))

	)

33 
	#DEF_RECLAIM_PREFREE_SEGMENTS
 5

	)

36 
	#GET_L2R_SEGNO
(
ä“_i
, 
£gno
è(£gnØ- f»e_i->
¡¬t_£gno
)

	)

37 
	#GET_R2L_SEGNO
(
ä“_i
, 
£gno
è(£gnØ+ f»e_i->
¡¬t_£gno
)

	)

39 
	#IS_DATASEG
(
t
èÑ <ğ
CURSEG_COLD_DATA
)

	)

40 
	#IS_NODESEG
(
t
èÑ >ğ
CURSEG_HOT_NODE
)

	)

42 
	#IS_CURSEG
(
sbi
, 
£g
) \

43 ((
£g
 =ğ
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
)->
£gno
) || \

44 (
£g
 =ğ
	`CURSEG_I
(
sbi
, 
CURSEG_WARM_DATA
)->
£gno
) || \

45 (
£g
 =ğ
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_DATA
)->
£gno
) || \

46 (
£g
 =ğ
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_NODE
)->
£gno
) || \

47 (
£g
 =ğ
	`CURSEG_I
(
sbi
, 
CURSEG_WARM_NODE
)->
£gno
) || \

48 (
£g
 =ğ
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_NODE
)->
£gno
))

	)

50 
	#IS_CURSEC
(
sbi
, 
£úo
) \

51 ((
£úo
 =ğ
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_DATA
)->
£gno
 / \

52 
sbi
->
£gs_³r_£c
) || \

53 (
£úo
 =ğ
	`CURSEG_I
(
sbi
, 
CURSEG_WARM_DATA
)->
£gno
 / \

54 
sbi
->
£gs_³r_£c
) || \

55 (
£úo
 =ğ
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_DATA
)->
£gno
 / \

56 
sbi
->
£gs_³r_£c
) || \

57 (
£úo
 =ğ
	`CURSEG_I
(
sbi
, 
CURSEG_HOT_NODE
)->
£gno
 / \

58 
sbi
->
£gs_³r_£c
) || \

59 (
£úo
 =ğ
	`CURSEG_I
(
sbi
, 
CURSEG_WARM_NODE
)->
£gno
 / \

60 
sbi
->
£gs_³r_£c
) || \

61 (
£úo
 =ğ
	`CURSEG_I
(
sbi
, 
CURSEG_COLD_NODE
)->
£gno
 / \

62 
sbi
->
£gs_³r_£c
)) \

63 

	)

64 
	#MAIN_BLKADDR
(
sbi
è(
	`SM_I
(sbi)->
maš_blkaddr
)

	)

65 
	#SEG0_BLKADDR
(
sbi
è(
	`SM_I
(sbi)->
£g0_blkaddr
)

	)

67 
	#MAIN_SEGS
(
sbi
è(
	`SM_I
(sbi)->
maš_£gm’ts
)

	)

68 
	#MAIN_SECS
(
sbi
è(sbi->
tÙ®_£ùiÚs
)

	)

70 
	#TOTAL_SEGS
(
sbi
è(
	`SM_I
(sbi)->
£gm’t_couÁ
)

	)

71 
	#TOTAL_BLKS
(
sbi
è(
	`TOTAL_SEGS
(sbiè<< sbi->
log_blocks_³r_£g
)

	)

73 
	#MAX_BLKADDR
(
sbi
è(
	`SEG0_BLKADDR
(sbiè+ 
	`TOTAL_BLKS
(sbi))

	)

74 
	#SEGMENT_SIZE
(
sbi
è(1ULL << (sbi->
log_blocksize
 + \

75 
sbi
->
log_blocks_³r_£g
))

	)

77 
	#START_BLOCK
(
sbi
, 
£gno
è(
	`SEG0_BLKADDR
(sbi) + \

78 (
	`GET_R2L_SEGNO
(
	`FREE_I
(
sbi
), 
£gno
è<< sbi->
log_blocks_³r_£g
))

	)

80 
	#NEXT_FREE_BLKADDR
(
sbi
, 
cur£g
) \

81 (
	`START_BLOCK
(
sbi
, 
cur£g
->
£gno
è+ cur£g->
Ãxt_blkoff
)

	)

83 
	#GET_SEGOFF_FROM_SEG0
(
sbi
, 
blk_addr
è((blk_addrè- 
	`SEG0_BLKADDR
(sbi))

	)

84 
	#GET_SEGNO_FROM_SEG0
(
sbi
, 
blk_addr
) \

85 (
	`GET_SEGOFF_FROM_SEG0
(
sbi
, 
blk_addr
è>> sbi->
log_blocks_³r_£g
)

	)

86 
	#GET_BLKOFF_FROM_SEG0
(
sbi
, 
blk_addr
) \

87 (
	`GET_SEGOFF_FROM_SEG0
(
sbi
, 
blk_addr
è& (sbi->
blocks_³r_£g
 - 1))

	)

89 
	#GET_SEGNO
(
sbi
, 
blk_addr
) \

90 (((
blk_addr
 =ğ
NULL_ADDR
è|| (blk_add¸=ğ
NEW_ADDR
)) ? \

91 
NULL_SEGNO
 : 
	`GET_L2R_SEGNO
(
	`FREE_I
(
sbi
), \

92 
	`GET_SEGNO_FROM_SEG0
(
sbi
, 
blk_addr
)))

	)

93 
	#GET_SECNO
(
sbi
, 
£gno
) \

94 ((
£gno
è/ 
sbi
->
£gs_³r_£c
)

	)

95 
	#GET_ZONENO_FROM_SEGNO
(
sbi
, 
£gno
) \

96 ((
£gno
 / 
sbi
->
£gs_³r_£c
è/ sbi->
£cs_³r_zÚe
)

	)

98 
	#GET_SUM_BLOCK
(
sbi
, 
£gno
) \

99 ((
sbi
->
sm_šfo
->
s§_blkaddr
è+ 
£gno
)

	)

101 
	#GET_SUM_TYPE
(
foÙ”
è((foÙ”)->
’Œy_ty³
)

	)

102 
	#SET_SUM_TYPE
(
foÙ”
, 
ty³
è((foÙ”)->
’Œy_ty³
 =y³)

	)

104 
	#SIT_ENTRY_OFFSET
(
s™_i
, 
£gno
) \

105 (
£gno
 % 
s™_i
->
£Ás_³r_block
)

	)

106 
	#SIT_BLOCK_OFFSET
(
£gno
) \

107 (
£gno
 / 
SIT_ENTRY_PER_BLOCK
)

	)

108 
	#START_SEGNO
(
£gno
) \

109 (
	`SIT_BLOCK_OFFSET
(
£gno
è* 
SIT_ENTRY_PER_BLOCK
)

	)

110 
	#SIT_BLK_CNT
(
sbi
) \

111 ((
	`MAIN_SEGS
(
sbi
è+ 
SIT_ENTRY_PER_BLOCK
 - 1è/ SIT_ENTRY_PER_BLOCK)

	)

112 
	#f2fs_b™m­_size
(
Ä
) \

113 (
	`BITS_TO_LONGS
(
Ä
è* ())

	)

115 
	#SECTOR_FROM_BLOCK
(
blk_addr
) \

116 (((
£ùÜ_t
)
blk_addr
è<< 
F2FS_LOG_SECTORS_PER_BLOCK
)

	)

117 
	#SECTOR_TO_BLOCK
(
£ùÜs
) \

118 (
£ùÜs
 >> 
F2FS_LOG_SECTORS_PER_BLOCK
)

	)

119 
	#MAX_BIO_BLOCKS
(
sbi
) \

120 (()
	`mš
(()
	`max_hw_blocks
(
sbi
), 
BIO_MAX_PAGES
))

	)

128 
	mALLOC_RIGHT
 = 0,

129 
	mALLOC_LEFT


138 
	mLFS
 = 0,

139 
	mSSR


148 
	mGC_CB
 = 0,

149 
	mGC_GREEDY


157 
	mBG_GC
 = 0,

158 
	mFG_GC


162 
	sviùim_£l_pŞicy
 {

163 
	m®loc_mode
;

164 
	mgc_mode
;

165 *
	mdœty_£gm­
;

166 
	mmax_£¬ch
;

167 
	moff£t
;

168 
	mofs_un™
;

169 
	mmš_co¡
;

170 
	mmš_£gno
;

173 
	s£g_’Œy
 {

174 
	mv®id_blocks
;

175 *
	mcur_v®id_m­
;

180 
	mck±_v®id_blocks
;

181 *
	mck±_v®id_m­
;

182 
	mty³
;

183 
	mmtime
;

186 
	s£c_’Œy
 {

187 
	mv®id_blocks
;

190 
	s£gm’t_®loÿtiÚ
 {

191 (*
	m®loÿ‹_£gm’t
)(
	mf2fs_sb_šfo
 *, , 
	mboŞ
);

194 
	sšmem_·ges
 {

195 
li¡_h—d
 
	mli¡
;

196 
·ge
 *
	m·ge
;

199 
	ss™_šfo
 {

200 cÚ¡ 
£gm’t_®loÿtiÚ
 *
	ms_İs
;

202 
block_t
 
	ms™_ba£_addr
;

203 
block_t
 
	ms™_blocks
;

204 
block_t
 
	mwr™‹n_v®id_blocks
;

205 *
	ms™_b™m­
;

206 
	mb™m­_size
;

208 *
	mdœty_£Ár›s_b™m­
;

209 
	mdœty_£Ár›s
;

210 
	m£Ás_³r_block
;

211 
mu‹x
 
	m£Áry_lock
;

212 
£g_’Œy
 *
	m£Ár›s
;

213 
£c_’Œy
 *
	m£c_’Œ›s
;

216 
	m–­£d_time
;

217 
	mmouÁed_time
;

218 
	mmš_mtime
;

219 
	mmax_mtime
;

222 
	sä“_£gm­_šfo
 {

223 
	m¡¬t_£gno
;

224 
	mä“_£gm’ts
;

225 
	mä“_£ùiÚs
;

226 
rwlock_t
 
	m£gm­_lock
;

227 *
	mä“_£gm­
;

228 *
	mä“_£cm­
;

232 
	edœty_ty³
 {

233 
	mDIRTY_HOT_DATA
,

234 
	mDIRTY_WARM_DATA
,

235 
	mDIRTY_COLD_DATA
,

236 
	mDIRTY_HOT_NODE
,

237 
	mDIRTY_WARM_NODE
,

238 
	mDIRTY_COLD_NODE
,

239 
	mDIRTY
,

240 
	mPRE
,

241 
	mNR_DIRTY_TYPE


244 
	sdœty_£gli¡_šfo
 {

245 cÚ¡ 
viùim_£ËùiÚ
 *
	mv_İs
;

246 *
	mdœty_£gm­
[
NR_DIRTY_TYPE
];

247 
mu‹x
 
	m£gli¡_lock
;

248 
	mÄ_dœty
[
NR_DIRTY_TYPE
];

249 *
	mviùim_£cm­
;

253 
	sviùim_£ËùiÚ
 {

254 (*
	mg‘_viùim
)(
	mf2fs_sb_šfo
 *, *,

259 
	scur£g_šfo
 {

260 
mu‹x
 
	mcur£g_mu‹x
;

261 
f2fs_summ¬y_block
 *
	msum_blk
;

262 
	m®loc_ty³
;

263 
	m£gno
;

264 
	mÃxt_blkoff
;

265 
	mzÚe
;

266 
	mÃxt_£gno
;

269 
	ss™_’Œy_£t
 {

270 
li¡_h—d
 
	m£t_li¡
;

271 
	m¡¬t_£gno
;

272 
	m’Œy_út
;

278 
šlše
 
cur£g_šfo
 *
	$CURSEG_I
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

280  (
cur£g_šfo
 *)(
	`SM_I
(
sbi
)->
cur£g_¬¿y
 + 
ty³
);

281 
	}
}

283 
šlše
 
£g_’Œy
 *
	$g‘_£g_’Œy
(
f2fs_sb_šfo
 *
sbi
,

284 
£gno
)

286 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

287  &
s™_i
->
£Ár›s
[
£gno
];

288 
	}
}

290 
šlše
 
£c_’Œy
 *
	$g‘_£c_’Œy
(
f2fs_sb_šfo
 *
sbi
,

291 
£gno
)

293 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

294  &
s™_i
->
£c_’Œ›s
[
	`GET_SECNO
(
sbi
, 
£gno
)];

295 
	}
}

297 
šlše
 
	$g‘_v®id_blocks
(
f2fs_sb_šfo
 *
sbi
,

298 
£gno
, 
£ùiÚ
)

304 ià(
£ùiÚ
 > 1)

305  
	`g‘_£c_’Œy
(
sbi
, 
£gno
)->
v®id_blocks
;

307  
	`g‘_£g_’Œy
(
sbi
, 
£gno
)->
v®id_blocks
;

308 
	}
}

310 
šlše
 
	$£g_šfo_äom_¿w_s™
(
£g_’Œy
 *
£
,

311 
f2fs_s™_’Œy
 *
rs
)

313 
£
->
v®id_blocks
 = 
	`GET_SIT_VBLOCKS
(
rs
);

314 
£
->
ck±_v®id_blocks
 = 
	`GET_SIT_VBLOCKS
(
rs
);

315 
	`memıy
(
£
->
cur_v®id_m­
, 
rs
->
v®id_m­
, 
SIT_VBLOCK_MAP_SIZE
);

316 
	`memıy
(
£
->
ck±_v®id_m­
, 
rs
->
v®id_m­
, 
SIT_VBLOCK_MAP_SIZE
);

317 
£
->
ty³
 = 
	`GET_SIT_TYPE
(
rs
);

318 
£
->
mtime
 = 
	`Ë64_to_ıu
(
rs
->mtime);

319 
	}
}

321 
šlše
 
	$£g_šfo_to_¿w_s™
(
£g_’Œy
 *
£
,

322 
f2fs_s™_’Œy
 *
rs
)

324 
¿w_vblocks
 = (
£
->
ty³
 << 
SIT_VBLOCKS_SHIFT
) |

325 
£
->
v®id_blocks
;

326 
rs
->
vblocks
 = 
	`ıu_to_Ë16
(
¿w_vblocks
);

327 
	`memıy
(
rs
->
v®id_m­
, 
£
->
cur_v®id_m­
, 
SIT_VBLOCK_MAP_SIZE
);

328 
	`memıy
(
£
->
ck±_v®id_m­
, 
rs
->
v®id_m­
, 
SIT_VBLOCK_MAP_SIZE
);

329 
£
->
ck±_v®id_blocks
 = se->
v®id_blocks
;

330 
rs
->
mtime
 = 
	`ıu_to_Ë64
(
£
->mtime);

331 
	}
}

333 
šlše
 
	$fšd_Ãxt_šu£
(
ä“_£gm­_šfo
 *
ä“_i
,

334 
max
, 
£gno
)

336 
»t
;

337 
	`»ad_lock
(&
ä“_i
->
£gm­_lock
);

338 
»t
 = 
	`fšd_Ãxt_b™
(
ä“_i
->
ä“_£gm­
, 
max
, 
£gno
);

339 
	`»ad_uÆock
(&
ä“_i
->
£gm­_lock
);

340  
»t
;

341 
	}
}

343 
šlše
 
	$__£t_ä“
(
f2fs_sb_šfo
 *
sbi
, 
£gno
)

345 
ä“_£gm­_šfo
 *
ä“_i
 = 
	`FREE_I
(
sbi
);

346 
£úo
 = 
£gno
 / 
sbi
->
£gs_³r_£c
;

347 
¡¬t_£gno
 = 
£úo
 * 
sbi
->
£gs_³r_£c
;

348 
Ãxt
;

350 
	`wr™e_lock
(&
ä“_i
->
£gm­_lock
);

351 
	`ş—r_b™
(
£gno
, 
ä“_i
->
ä“_£gm­
);

352 
ä“_i
->
ä“_£gm’ts
++;

354 
Ãxt
 = 
	`fšd_Ãxt_b™
(
ä“_i
->
ä“_£gm­
, 
	`MAIN_SEGS
(
sbi
), 
¡¬t_£gno
);

355 ià(
Ãxt
 >ğ
¡¬t_£gno
 + 
sbi
->
£gs_³r_£c
) {

356 
	`ş—r_b™
(
£úo
, 
ä“_i
->
ä“_£cm­
);

357 
ä“_i
->
ä“_£ùiÚs
++;

359 
	`wr™e_uÆock
(&
ä“_i
->
£gm­_lock
);

360 
	}
}

362 
šlše
 
	$__£t_šu£
(
f2fs_sb_šfo
 *
sbi
,

363 
£gno
)

365 
ä“_£gm­_šfo
 *
ä“_i
 = 
	`FREE_I
(
sbi
);

366 
£úo
 = 
£gno
 / 
sbi
->
£gs_³r_£c
;

367 
	`£t_b™
(
£gno
, 
ä“_i
->
ä“_£gm­
);

368 
ä“_i
->
ä“_£gm’ts
--;

369 ià(!
	`‹¡_ªd_£t_b™
(
£úo
, 
ä“_i
->
ä“_£cm­
))

370 
ä“_i
->
ä“_£ùiÚs
--;

371 
	}
}

373 
šlše
 
	$__£t_‹¡_ªd_ä“
(
f2fs_sb_šfo
 *
sbi
,

374 
£gno
)

376 
ä“_£gm­_šfo
 *
ä“_i
 = 
	`FREE_I
(
sbi
);

377 
£úo
 = 
£gno
 / 
sbi
->
£gs_³r_£c
;

378 
¡¬t_£gno
 = 
£úo
 * 
sbi
->
£gs_³r_£c
;

379 
Ãxt
;

381 
	`wr™e_lock
(&
ä“_i
->
£gm­_lock
);

382 ià(
	`‹¡_ªd_ş—r_b™
(
£gno
, 
ä“_i
->
ä“_£gm­
)) {

383 
ä“_i
->
ä“_£gm’ts
++;

385 
Ãxt
 = 
	`fšd_Ãxt_b™
(
ä“_i
->
ä“_£gm­
,

386 
¡¬t_£gno
 + 
sbi
->
£gs_³r_£c
, start_segno);

387 ià(
Ãxt
 >ğ
¡¬t_£gno
 + 
sbi
->
£gs_³r_£c
) {

388 ià(
	`‹¡_ªd_ş—r_b™
(
£úo
, 
ä“_i
->
ä“_£cm­
))

389 
ä“_i
->
ä“_£ùiÚs
++;

392 
	`wr™e_uÆock
(&
ä“_i
->
£gm­_lock
);

393 
	}
}

395 
šlše
 
	$__£t_‹¡_ªd_šu£
(
f2fs_sb_šfo
 *
sbi
,

396 
£gno
)

398 
ä“_£gm­_šfo
 *
ä“_i
 = 
	`FREE_I
(
sbi
);

399 
£úo
 = 
£gno
 / 
sbi
->
£gs_³r_£c
;

400 
	`wr™e_lock
(&
ä“_i
->
£gm­_lock
);

401 ià(!
	`‹¡_ªd_£t_b™
(
£gno
, 
ä“_i
->
ä“_£gm­
)) {

402 
ä“_i
->
ä“_£gm’ts
--;

403 ià(!
	`‹¡_ªd_£t_b™
(
£úo
, 
ä“_i
->
ä“_£cm­
))

404 
ä“_i
->
ä“_£ùiÚs
--;

406 
	`wr™e_uÆock
(&
ä“_i
->
£gm­_lock
);

407 
	}
}

409 
šlše
 
	$g‘_s™_b™m­
(
f2fs_sb_šfo
 *
sbi
,

410 *
d¡_addr
)

412 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

413 
	`memıy
(
d¡_addr
, 
s™_i
->
s™_b™m­
, s™_i->
b™m­_size
);

414 
	}
}

416 
šlše
 
block_t
 
	$wr™‹n_block_couÁ
(
f2fs_sb_šfo
 *
sbi
)

418  
	`SIT_I
(
sbi
)->
wr™‹n_v®id_blocks
;

419 
	}
}

421 
šlše
 
	$ä“_£gm’ts
(
f2fs_sb_šfo
 *
sbi
)

423  
	`FREE_I
(
sbi
)->
ä“_£gm’ts
;

424 
	}
}

426 
šlše
 
	$»£rved_£gm’ts
(
f2fs_sb_šfo
 *
sbi
)

428  
	`SM_I
(
sbi
)->
»£rved_£gm’ts
;

429 
	}
}

431 
šlše
 
	$ä“_£ùiÚs
(
f2fs_sb_šfo
 *
sbi
)

433  
	`FREE_I
(
sbi
)->
ä“_£ùiÚs
;

434 
	}
}

436 
šlše
 
	$´eä“_£gm’ts
(
f2fs_sb_šfo
 *
sbi
)

438  
	`DIRTY_I
(
sbi
)->
Ä_dœty
[
PRE
];

439 
	}
}

441 
šlše
 
	$dœty_£gm’ts
(
f2fs_sb_šfo
 *
sbi
)

443  
	`DIRTY_I
(
sbi
)->
Ä_dœty
[
DIRTY_HOT_DATA
] +

444 
	`DIRTY_I
(
sbi
)->
Ä_dœty
[
DIRTY_WARM_DATA
] +

445 
	`DIRTY_I
(
sbi
)->
Ä_dœty
[
DIRTY_COLD_DATA
] +

446 
	`DIRTY_I
(
sbi
)->
Ä_dœty
[
DIRTY_HOT_NODE
] +

447 
	`DIRTY_I
(
sbi
)->
Ä_dœty
[
DIRTY_WARM_NODE
] +

448 
	`DIRTY_I
(
sbi
)->
Ä_dœty
[
DIRTY_COLD_NODE
];

449 
	}
}

451 
šlše
 
	$ov”´ovisiÚ_£gm’ts
(
f2fs_sb_šfo
 *
sbi
)

453  
	`SM_I
(
sbi
)->
ovp_£gm’ts
;

454 
	}
}

456 
šlše
 
	$ov”´ovisiÚ_£ùiÚs
(
f2fs_sb_šfo
 *
sbi
)

458  ((è
	`ov”´ovisiÚ_£gm’ts
(
sbi
)è/ sbi->
£gs_³r_£c
;

459 
	}
}

461 
šlše
 
	$»£rved_£ùiÚs
(
f2fs_sb_šfo
 *
sbi
)

463  ((è
	`»£rved_£gm’ts
(
sbi
)è/ sbi->
£gs_³r_£c
;

464 
	}
}

466 
šlše
 
boŞ
 
	$Ãed_SSR
(
f2fs_sb_šfo
 *
sbi
)

468 
node_£cs
 = 
	`g‘_blockty³_£cs
(
sbi
, 
F2FS_DIRTY_NODES
);

469 
d’t_£cs
 = 
	`g‘_blockty³_£cs
(
sbi
, 
F2FS_DIRTY_DENTS
);

470  
	`ä“_£ùiÚs
(
sbi
è<ğ(
node_£cs
 + 2 * 
d’t_£cs
 +

471 
	`»£rved_£ùiÚs
(
sbi
) + 1);

472 
	}
}

474 
šlše
 
boŞ
 
	$has_nÙ_’ough_ä“_£cs
(
f2fs_sb_šfo
 *
sbi
, 
ä“d
)

476 
node_£cs
 = 
	`g‘_blockty³_£cs
(
sbi
, 
F2FS_DIRTY_NODES
);

477 
d’t_£cs
 = 
	`g‘_blockty³_£cs
(
sbi
, 
F2FS_DIRTY_DENTS
);

479 ià(
	`uÆik–y
(
sbi
->
pÜ_došg
))

480  
çl£
;

482  (
	`ä“_£ùiÚs
(
sbi
è+ 
ä“d
è<ğ(
node_£cs
 + 2 * 
d’t_£cs
 +

483 
	`»£rved_£ùiÚs
(
sbi
));

484 
	}
}

486 
šlše
 
boŞ
 
	$exûss_´eä“_£gs
(
f2fs_sb_šfo
 *
sbi
)

488  
	`´eä“_£gm’ts
(
sbi
è> 
	`SM_I
(sbi)->
»c_´eä“_£gm’ts
;

489 
	}
}

491 
šlše
 
	$utiz©iÚ
(
f2fs_sb_šfo
 *
sbi
)

493  
	`div_u64
((
u64
)
	`v®id_u£r_blocks
(
sbi
) * 100,

494 
sbi
->
u£r_block_couÁ
);

495 
	}
}

511 
	#DEF_MIN_IPU_UTIL
 70

	)

512 
	#DEF_MIN_FSYNC_BLOCKS
 8

	)

515 
	mF2FS_IPU_FORCE
,

516 
	mF2FS_IPU_SSR
,

517 
	mF2FS_IPU_UTIL
,

518 
	mF2FS_IPU_SSR_UTIL
,

519 
	mF2FS_IPU_FSYNC
,

520 #ifdeà
F2FS_DA_MAP


521 
	mF2FS_IPU_DISABLE
,

525 
šlše
 
boŞ
 
	$Ãed_š¶aû_upd©e
(
šode
 *inode)

527 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

528 
pŞicy
 = 
	`SM_I
(
sbi
)->
u_pŞicy
;

531 ià(
	`S_ISDIR
(
šode
->
i_mode
è|| 
	`f2fs_is_©omic_fe
(inode))

532  
çl£
;

533 #ifdeà
F2FS_DA_MAP


534 ià(
pŞicy
 & (0x1 << 
F2FS_IPU_DISABLE
))

535  
çl£
;

537 ià(
pŞicy
 & (0x1 << 
F2FS_IPU_FORCE
))

538  
Œue
;

539 ià(
pŞicy
 & (0x1 << 
F2FS_IPU_SSR
è&& 
	`Ãed_SSR
(
sbi
))

540  
Œue
;

541 ià(
pŞicy
 & (0x1 << 
F2FS_IPU_UTIL
) &&

542 
	`utiz©iÚ
(
sbi
è> 
	`SM_I
(sbi)->
mš_u_ut
)

543  
Œue
;

544 ià(
pŞicy
 & (0x1 << 
F2FS_IPU_SSR_UTIL
è&& 
	`Ãed_SSR
(
sbi
) &&

545 
	`utiz©iÚ
(
sbi
è> 
	`SM_I
(sbi)->
mš_u_ut
)

546  
Œue
;

549 ià(
pŞicy
 & (0x1 << 
F2FS_IPU_FSYNC
) &&

550 
	`is_šode_æag_£t
(
	`F2FS_I
(
šode
), 
FI_NEED_IPU
))

551  
Œue
;

553  
çl£
;

554 
	}
}

556 
šlše
 
	$cur£g_£gno
(
f2fs_sb_šfo
 *
sbi
,

557 
ty³
)

559 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

560  
cur£g
->
£gno
;

561 
	}
}

563 
šlše
 
	$cur£g_®loc_ty³
(
f2fs_sb_šfo
 *
sbi
,

564 
ty³
)

566 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

567  
cur£g
->
®loc_ty³
;

568 
	}
}

570 
šlše
 
	$cur£g_blkoff
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

572 
cur£g_šfo
 *
cur£g
 = 
	`CURSEG_I
(
sbi
, 
ty³
);

573  
cur£g
->
Ãxt_blkoff
;

574 
	}
}

576 #ifdeà
CONFIG_F2FS_CHECK_FS


577 
šlše
 
	$check_£g_¿nge
(
f2fs_sb_šfo
 *
sbi
, 
£gno
)

579 
	`BUG_ON
(
£gno
 > 
	`TOTAL_SEGS
(
sbi
) - 1);

580 
	}
}

582 
šlše
 
	$v”ify_block_addr
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
blk_addr
)

584 
	`BUG_ON
(
blk_addr
 < 
	`SEG0_BLKADDR
(
sbi
));

585 
	`BUG_ON
(
blk_addr
 >ğ
	`MAX_BLKADDR
(
sbi
));

586 
	}
}

591 
šlše
 
	$check_block_couÁ
(
f2fs_sb_šfo
 *
sbi
,

592 
£gno
, 
f2fs_s™_’Œy
 *
¿w_s™
)

594 
boŞ
 
is_v®id
 = 
	`‹¡_b™_Ë
(0, 
¿w_s™
->
v®id_m­
è? 
Œue
 : 
çl£
;

595 
v®id_blocks
 = 0;

596 
cur_pos
 = 0, 
Ãxt_pos
;

599 
	`BUG_ON
(
	`GET_SIT_VBLOCKS
(
¿w_s™
è> 
sbi
->
blocks_³r_£g
);

602 
	`BUG_ON
(
£gno
 > 
	`TOTAL_SEGS
(
sbi
) - 1);

606 ià(
is_v®id
) {

607 
Ãxt_pos
 = 
	`fšd_Ãxt_z”o_b™_Ë
(&
¿w_s™
->
v®id_m­
,

608 
sbi
->
blocks_³r_£g
,

609 
cur_pos
);

610 
v®id_blocks
 +ğ
Ãxt_pos
 - 
cur_pos
;

612 
Ãxt_pos
 = 
	`fšd_Ãxt_b™_Ë
(&
¿w_s™
->
v®id_m­
,

613 
sbi
->
blocks_³r_£g
,

614 
cur_pos
);

615 
cur_pos
 = 
Ãxt_pos
;

616 
is_v®id
 = !is_valid;

617 } 
cur_pos
 < 
sbi
->
blocks_³r_£g
);

618 
	`BUG_ON
(
	`GET_SIT_VBLOCKS
(
¿w_s™
è!ğ
v®id_blocks
);

619 
	}
}

621 
šlše
 
	$check_£g_¿nge
(
f2fs_sb_šfo
 *
sbi
, 
£gno
)

623 ià(
£gno
 > 
	`TOTAL_SEGS
(
sbi
) - 1)

624 
sbi
->
Ãed_fsck
 = 
Œue
;

625 
	}
}

627 
šlše
 
	$v”ify_block_addr
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
blk_addr
)

629 ià(
blk_addr
 < 
	`SEG0_BLKADDR
(
sbi
è|| blk_add¸>ğ
	`MAX_BLKADDR
(sbi))

630 
sbi
->
Ãed_fsck
 = 
Œue
;

631 
	}
}

636 
šlše
 
	$check_block_couÁ
(
f2fs_sb_šfo
 *
sbi
,

637 
£gno
, 
f2fs_s™_’Œy
 *
¿w_s™
)

640 ià(
	`GET_SIT_VBLOCKS
(
¿w_s™
è> 
sbi
->
blocks_³r_£g
)

641 
sbi
->
Ãed_fsck
 = 
Œue
;

644 ià(
£gno
 > 
	`TOTAL_SEGS
(
sbi
) - 1)

645 
sbi
->
Ãed_fsck
 = 
Œue
;

646 
	}
}

649 
šlše
 
pgoff_t
 
	$cu¼’t_s™_addr
(
f2fs_sb_šfo
 *
sbi
,

650 
¡¬t
)

652 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

653 
off£t
 = 
	`SIT_BLOCK_OFFSET
(
¡¬t
);

654 
block_t
 
blk_addr
 = 
s™_i
->
s™_ba£_addr
 + 
off£t
;

656 
	`check_£g_¿nge
(
sbi
, 
¡¬t
);

659 ià(
	`f2fs_‹¡_b™
(
off£t
, 
s™_i
->
s™_b™m­
))

660 
blk_addr
 +ğ
s™_i
->
s™_blocks
;

662  
blk_addr
;

663 
	}
}

665 
šlše
 
pgoff_t
 
	$Ãxt_s™_addr
(
f2fs_sb_šfo
 *
sbi
,

666 
pgoff_t
 
block_addr
)

668 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

669 
block_addr
 -ğ
s™_i
->
s™_ba£_addr
;

670 ià(
block_addr
 < 
s™_i
->
s™_blocks
)

671 
block_addr
 +ğ
s™_i
->
s™_blocks
;

673 
block_addr
 -ğ
s™_i
->
s™_blocks
;

675  
block_addr
 + 
s™_i
->
s™_ba£_addr
;

676 
	}
}

678 
šlše
 
	$£t_to_Ãxt_s™
(
s™_šfo
 *
s™_i
, 
¡¬t
)

680 
block_off
 = 
	`SIT_BLOCK_OFFSET
(
¡¬t
);

682 ià(
	`f2fs_‹¡_b™
(
block_off
, 
s™_i
->
s™_b™m­
))

683 
	`f2fs_ş—r_b™
(
block_off
, 
s™_i
->
s™_b™m­
);

685 
	`f2fs_£t_b™
(
block_off
, 
s™_i
->
s™_b™m­
);

686 
	}
}

688 
šlše
 
	$g‘_mtime
(
f2fs_sb_šfo
 *
sbi
)

690 
s™_šfo
 *
s™_i
 = 
	`SIT_I
(
sbi
);

691  
s™_i
->
–­£d_time
 + 
CURRENT_TIME_SEC
.
tv_£c
 -

692 
s™_i
->
mouÁed_time
;

693 
	}
}

695 
šlše
 
	$£t_summ¬y
(
f2fs_summ¬y
 *
sum
, 
nid_t
 
nid
,

696 
ofs_š_node
, 
v”siÚ
)

698 
sum
->
nid
 = 
	`ıu_to_Ë32
(nid);

699 
sum
->
ofs_š_node
 = 
	`ıu_to_Ë16
(ofs_in_node);

700 
sum
->
v”siÚ
 = version;

701 
	}
}

703 
šlše
 
block_t
 
	$¡¬t_sum_block
(
f2fs_sb_šfo
 *
sbi
)

705  
	`__¡¬t_ı_addr
(
sbi
) +

706 
	`Ë32_to_ıu
(
	`F2FS_CKPT
(
sbi
)->
ı_·ck_¡¬t_sum
);

707 
	}
}

709 
šlše
 
block_t
 
	$sum_blk_addr
(
f2fs_sb_šfo
 *
sbi
, 
ba£
, 
ty³
)

711  
	`__¡¬t_ı_addr
(
sbi
) +

712 
	`Ë32_to_ıu
(
	`F2FS_CKPT
(
sbi
)->
ı_·ck_tÙ®_block_couÁ
)

713 - (
ba£
 + 1è+ 
ty³
;

714 
	}
}

716 
šlše
 
boŞ
 
	$£c_u§ge_check
(
f2fs_sb_šfo
 *
sbi
, 
£úo
)

718 ià(
	`IS_CURSEC
(
sbi
, 
£úo
è|| (sbi->
cur_viùim_£c
 == secno))

719  
Œue
;

720  
çl£
;

721 
	}
}

723 
šlše
 
	$max_hw_blocks
(
f2fs_sb_šfo
 *
sbi
)

725 
block_deviû
 *
bdev
 = 
sbi
->
sb
->
s_bdev
;

726 
»que¡_queue
 *
q
 = 
	`bdev_g‘_queue
(
bdev
);

727  
	`SECTOR_TO_BLOCK
(
	`queue_max_£ùÜs
(
q
));

728 
	}
}

737 
šlše
 
	$Ä_·ges_to_sk
(
f2fs_sb_šfo
 *
sbi
, 
ty³
)

739 ià(
ty³
 =ğ
DATA
)

740  
sbi
->
blocks_³r_£g
;

741 ià(
ty³
 =ğ
NODE
)

742  3 * 
sbi
->
blocks_³r_£g
;

743 ià(
ty³
 =ğ
META
)

744  
	`MAX_BIO_BLOCKS
(
sbi
);

747 
	}
}

752 
šlše
 
	$Ä_·ges_to_wr™e
(
f2fs_sb_šfo
 *
sbi
, 
ty³
,

753 
wr™eback_cÚŒŞ
 *
wbc
)

755 
Ä_to_wr™e
, 
desœed
;

757 ià(
wbc
->
sync_mode
 !ğ
WB_SYNC_NONE
)

760 
Ä_to_wr™e
 = 
wbc
->nr_to_write;

762 ià(
ty³
 =ğ
DATA
)

763 
desœed
 = 4096;

764 ià(
ty³
 =ğ
NODE
)

765 
desœed
 = 3 * 
	`max_hw_blocks
(
sbi
);

767 
desœed
 = 
	`MAX_BIO_BLOCKS
(
sbi
);

769 
wbc
->
Ä_to_wr™e
 = 
desœed
;

770  
desœed
 - 
Ä_to_wr™e
;

771 
	}
}

773 #ifdeà
F2FS_DA_MAP


774 
boŞ
 
F2FS_PLUG_ON
;

776 
__add_sum_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
ty³
, 
f2fs_summ¬y
 *
sum
);

777 
__g‘_£gm’t_ty³
(
·ge
 *·ge, 
·ge_ty³
 
p_ty³
);

778 
__»äesh_Ãxt_blkoff
(
f2fs_sb_šfo
 *
sbi
,

779 
cur£g_šfo
 *
£g
);

780 
boŞ
 
__has_cur£g_¥aû
(
f2fs_sb_šfo
 *
sbi
, 
ty³
);

781 
upd©e_s™_’Œy
(
f2fs_sb_šfo
 *
sbi
, 
block_t
 
blkaddr
, 
d–
);

782 
loÿ‹_dœty_£gm’t
(
f2fs_sb_šfo
 *
sbi
, 
£gno
);

783 
subm™_šv®id_£gm’t_numb”
(
f2fs_sb_šfo
 *
sbi
, 
£gno
);

786 #ifdeà
F2FS_GET_FS_WAF


787 
Ën_u£r_d©a
;

788 
Ën_fs_wr™e
;

789 
gc_v®id_blocks_tÙ®
;

790 
gc_v®id_blocks_node
;

791 
gc_v®id_blocks_d©a
;

792 
dummy_·ge_couÁ
;

	@super.c

11 
	~<lšux/moduË.h
>

12 
	~<lšux/š™.h
>

13 
	~<lšux/fs.h
>

14 
	~<lšux/¡©fs.h
>

15 
	~<lšux/bufãr_h—d.h
>

16 
	~<lšux/backšg-dev.h
>

17 
	~<lšux/kth»ad.h
>

18 
	~<lšux/·r£r.h
>

19 
	~<lšux/mouÁ.h
>

20 
	~<lšux/£q_fe.h
>

21 
	~<lšux/´oc_fs.h
>

22 
	~<lšux/¿ndom.h
>

23 
	~<lšux/expÜtfs.h
>

24 
	~<lšux/blkdev.h
>

25 
	~<lšux/f2fs_fs.h
>

26 
	~<lšux/sysfs.h
>

28 
	~"f2fs.h
"

29 
	~"node.h
"

30 
	~"£gm’t.h
"

31 
	~"x©Œ.h
"

32 
	~"gc.h
"

34 
	#CREATE_TRACE_POINTS


	)

35 
	~<Œaû/ev’ts/f2fs.h
>

37 
´oc_dœ_’Œy
 *
	gf2fs_´oc_roÙ
;

38 
kmem_ÿche
 *
	gf2fs_šode_ÿch•
;

39 
k£t
 *
	gf2fs_k£t
;

42 
	mO±_gc_background
,

43 
	mO±_di§bË_rŞl_fÜw¬d
,

44 
	mO±_disÿrd
,

45 
	mO±_noh—p
,

46 
	mO±_u£r_x©Œ
,

47 
	mO±_nou£r_x©Œ
,

48 
	mO±_aş
,

49 
	mO±_nßş
,

50 
	mO±_aùive_logs
,

51 
	mO±_di§bË_ext_id’tify
,

52 
	mO±_šlše_x©Œ
,

53 
	mO±_šlše_d©a
,

54 
	mO±_æush_m”ge
,

55 
	mO±_nob¬r›r
,

56 
	mO±_”r
,

59 
m©ch_bË_t
 
	gf2fs_tok’s
 = {

60 {
O±_gc_background
, "background_gc=%s"},

61 {
O±_di§bË_rŞl_fÜw¬d
, "disable_roll_forward"},

62 {
O±_disÿrd
, "discard"},

63 {
O±_noh—p
, "no_heap"},

64 {
O±_u£r_x©Œ
, "user_xattr"},

65 {
O±_nou£r_x©Œ
, "nouser_xattr"},

66 {
O±_aş
, "acl"},

67 {
O±_nßş
, "noacl"},

68 {
O±_aùive_logs
, "active_logs=%u"},

69 {
O±_di§bË_ext_id’tify
, "disable_ext_identify"},

70 {
O±_šlše_x©Œ
, "inline_xattr"},

71 {
O±_šlše_d©a
, "inline_data"},

72 {
O±_æush_m”ge
, "flush_merge"},

73 {
O±_nob¬r›r
, "nobarrier"},

74 {
O±_”r
, 
NULL
},

79 
	mGC_THREAD
,

80 
	mSM_INFO
,

81 
	mNM_INFO
,

82 
	mF2FS_SBI
,

85 
	sf2fs_©Œ
 {

86 
©Œibu‹
 
	m©Œ
;

87 
ssize_t
 (*
show
)(
	mf2fs_©Œ
 *, 
	mf2fs_sb_šfo
 *, *);

88 
ssize_t
 (*
¡Üe
)(
	mf2fs_©Œ
 *, 
	mf2fs_sb_šfo
 *,

89 cÚ¡ *, 
	msize_t
);

90 
	m¡ruù_ty³
;

91 
	moff£t
;

94 *
	$__¡ruù_±r
(
f2fs_sb_šfo
 *
sbi
, 
¡ruù_ty³
)

96 ià(
¡ruù_ty³
 =ğ
GC_THREAD
)

97  (*)
sbi
->
gc_th»ad
;

98 ià(
¡ruù_ty³
 =ğ
SM_INFO
)

99  (*)
	`SM_I
(
sbi
);

100 ià(
¡ruù_ty³
 =ğ
NM_INFO
)

101  (*)
	`NM_I
(
sbi
);

102 ià(
¡ruù_ty³
 =ğ
F2FS_SBI
)

103  (*)
sbi
;

104  
NULL
;

105 
	}
}

107 
ssize_t
 
	$f2fs_sbi_show
(
f2fs_©Œ
 *
a
,

108 
f2fs_sb_šfo
 *
sbi
, *
buf
)

110 *
±r
 = 
NULL
;

111 *
ui
;

113 
±r
 = 
	`__¡ruù_±r
(
sbi
, 
a
->
¡ruù_ty³
);

114 ià(!
±r
)

115  -
EINVAL
;

117 
ui
 = (*)(
±r
 + 
a
->
off£t
);

119  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%u\n", *
ui
);

120 
	}
}

122 
ssize_t
 
	$f2fs_sbi_¡Üe
(
f2fs_©Œ
 *
a
,

123 
f2fs_sb_šfo
 *
sbi
,

124 cÚ¡ *
buf
, 
size_t
 
couÁ
)

126 *
±r
;

127 
t
;

128 *
ui
;

129 
ssize_t
 
»t
;

131 
±r
 = 
	`__¡ruù_±r
(
sbi
, 
a
->
¡ruù_ty³
);

132 ià(!
±r
)

133  -
EINVAL
;

135 
ui
 = (*)(
±r
 + 
a
->
off£t
);

137 
»t
 = 
	`k¡¹oul
(
	`sk_¥aûs
(
buf
), 0, &
t
);

138 ià(
»t
 < 0)

139  
»t
;

140 *
ui
 = 
t
;

141  
couÁ
;

142 
	}
}

144 
ssize_t
 
	$f2fs_©Œ_show
(
kobjeù
 *
kobj
,

145 
©Œibu‹
 *
©Œ
, *
buf
)

147 
f2fs_sb_šfo
 *
sbi
 = 
	`cÚš”_of
(
kobj
, f2fs_sb_info,

148 
s_kobj
);

149 
f2fs_©Œ
 *
a
 = 
	`cÚš”_of
(
©Œ
, f2fs_attr,‡ttr);

151  
a
->
show
 ?‡->
	`show
×, 
sbi
, 
buf
) : 0;

152 
	}
}

154 
ssize_t
 
	$f2fs_©Œ_¡Üe
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
,

155 cÚ¡ *
buf
, 
size_t
 
Ën
)

157 
f2fs_sb_šfo
 *
sbi
 = 
	`cÚš”_of
(
kobj
, f2fs_sb_info,

158 
s_kobj
);

159 
f2fs_©Œ
 *
a
 = 
	`cÚš”_of
(
©Œ
, f2fs_attr,‡ttr);

161  
a
->
¡Üe
 ?‡->
	`¡Üe
×, 
sbi
, 
buf
, 
Ën
) : 0;

162 
	}
}

164 
	$f2fs_sb_»Ëa£
(
kobjeù
 *
kobj
)

166 
f2fs_sb_šfo
 *
sbi
 = 
	`cÚš”_of
(
kobj
, f2fs_sb_info,

167 
s_kobj
);

168 
	`com¶‘e
(&
sbi
->
s_kobj_uÄegi¡”
);

169 
	}
}

171 
	#F2FS_ATTR_OFFSET
(
_¡ruù_ty³
, 
_Çme
, 
_mode
, 
_show
, 
_¡Üe
, 
_off£t
) \

172 
f2fs_©Œ
 
f2fs_©Œ_
##
_Çme
 = { \

173 .
©Œ
 = {.
Çme
 = 
	`__¡ršgify
(
_Çme
), .
mode
 = 
_mode
 }, \

174 .
show
 = 
_show
, \

175 .
¡Üe
 = 
_¡Üe
, \

176 .
¡ruù_ty³
 = 
_¡ruù_ty³
, \

177 .
off£t
 = 
_off£t
 \

178 }

	)

180 
	#F2FS_RW_ATTR
(
¡ruù_ty³
, 
¡ruù_Çme
, 
Çme
, 
–Çme
) \

181 
	`F2FS_ATTR_OFFSET
(
¡ruù_ty³
, 
Çme
, 0644, \

182 
f2fs_sbi_show
, 
f2fs_sbi_¡Üe
, \

183 
	`off£tof
(
¡ruù_Çme
, 
–Çme
))

	)

185 
F2FS_RW_ATTR
(
GC_THREAD
, 
f2fs_gc_kth»ad
, 
gc_mš_¦“p_time
, 
mš_¦“p_time
);

186 
F2FS_RW_ATTR
(
GC_THREAD
, 
f2fs_gc_kth»ad
, 
gc_max_¦“p_time
, 
max_¦“p_time
);

187 
F2FS_RW_ATTR
(
GC_THREAD
, 
f2fs_gc_kth»ad
, 
gc_no_gc_¦“p_time
, 
no_gc_¦“p_time
);

188 
F2FS_RW_ATTR
(
GC_THREAD
, 
f2fs_gc_kth»ad
, 
gc_idË
, gc_idle);

189 
F2FS_RW_ATTR
(
SM_INFO
, 
f2fs_sm_šfo
, 
»şaim_£gm’ts
, 
»c_´eä“_£gm’ts
);

190 
F2FS_RW_ATTR
(
SM_INFO
, 
f2fs_sm_šfo
, 
max_sm®l_disÿrds
, 
max_disÿrds
);

191 
F2FS_RW_ATTR
(
SM_INFO
, 
f2fs_sm_šfo
, 
u_pŞicy
, ipu_policy);

192 
F2FS_RW_ATTR
(
SM_INFO
, 
f2fs_sm_šfo
, 
mš_u_ut
, min_ipu_util);

193 
F2FS_RW_ATTR
(
SM_INFO
, 
f2fs_sm_šfo
, 
mš_fsync_blocks
, min_fsync_blocks);

194 
F2FS_RW_ATTR
(
NM_INFO
, 
f2fs_nm_šfo
, 
¿m_th»sh
,„am_thresh);

195 
F2FS_RW_ATTR
(
F2FS_SBI
, 
f2fs_sb_šfo
, 
max_viùim_£¬ch
, max_victim_search);

196 
F2FS_RW_ATTR
(
F2FS_SBI
, 
f2fs_sb_šfo
, 
dœ_Ëv–
, dir_level);

198 
	#ATTR_LIST
(
Çme
è(&
f2fs_©Œ_
##Çme.
©Œ
)

	)

199 
©Œibu‹
 *
	gf2fs_©Œs
[] = {

200 
ATTR_LIST
(
gc_mš_¦“p_time
),

201 
ATTR_LIST
(
gc_max_¦“p_time
),

202 
ATTR_LIST
(
gc_no_gc_¦“p_time
),

203 
ATTR_LIST
(
gc_idË
),

204 
ATTR_LIST
(
»şaim_£gm’ts
),

205 
ATTR_LIST
(
max_sm®l_disÿrds
),

206 
ATTR_LIST
(
u_pŞicy
),

207 
ATTR_LIST
(
mš_u_ut
),

208 
ATTR_LIST
(
mš_fsync_blocks
),

209 
ATTR_LIST
(
max_viùim_£¬ch
),

210 
ATTR_LIST
(
dœ_Ëv–
),

211 
ATTR_LIST
(
¿m_th»sh
),

212 
NULL
,

215 cÚ¡ 
sysfs_İs
 
	gf2fs_©Œ_İs
 = {

216 .
show
 = 
f2fs_©Œ_show
,

217 .
	g¡Üe
 = 
f2fs_©Œ_¡Üe
,

220 
kobj_ty³
 
	gf2fs_kty³
 = {

221 .
deçuÉ_©Œs
 = 
f2fs_©Œs
,

222 .
	gsysfs_İs
 = &
f2fs_©Œ_İs
,

223 .
	g»Ëa£
 = 
f2fs_sb_»Ëa£
,

226 
	$f2fs_msg
(
su³r_block
 *
sb
, cÚ¡ *
Ëv–
, cÚ¡ *
fmt
, ...)

228 
va_fÜm©
 
vaf
;

229 
va_li¡
 
¬gs
;

231 
	`va_¡¬t
(
¬gs
, 
fmt
);

232 
vaf
.
fmt
 = fmt;

233 
vaf
.
va
 = &
¬gs
;

234 
	`´štk
("%sF2FS-f (%s): %pV\n", 
Ëv–
, 
sb
->
s_id
, &
vaf
);

235 
	`va_’d
(
¬gs
);

236 
	}
}

238 
	$š™_Úû
(*
foo
)

240 
f2fs_šode_šfo
 *
fi
 = (f2fs_šode_šfØ*è
foo
;

242 
	`šode_š™_Úû
(&
fi
->
vfs_šode
);

243 
	}
}

245 
	$·r£_İtiÚs
(
su³r_block
 *
sb
, *
İtiÚs
)

247 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

248 
sub¡ršg_t
 
¬gs
[
MAX_OPT_ARGS
];

249 *
p
, *
Çme
;

250 
¬g
 = 0;

252 ià(!
İtiÚs
)

255 (
p
 = 
	`¡r£p
(&
İtiÚs
, ",")è!ğ
NULL
) {

256 
tok’
;

257 ià(!*
p
)

263 
¬gs
[0].
to
 =‡rgs[0].
äom
 = 
NULL
;

264 
tok’
 = 
	`m©ch_tok’
(
p
, 
f2fs_tok’s
, 
¬gs
);

266 
tok’
) {

267 
O±_gc_background
:

268 
Çme
 = 
	`m©ch_¡rdup
(&
¬gs
[0]);

270 ià(!
Çme
)

271  -
ENOMEM
;

272 ià(
	`¡¾’
(
Çme
è=ğ2 && !
	`¡ºcmp
(name, "on", 2))

273 
	`£t_İt
(
sbi
, 
BG_GC
);

274 ià(
	`¡¾’
(
Çme
è=ğ3 && !
	`¡ºcmp
(name, "off", 3))

275 
	`ş—r_İt
(
sbi
, 
BG_GC
);

277 
	`kä“
(
Çme
);

278  -
EINVAL
;

280 
	`kä“
(
Çme
);

282 
O±_di§bË_rŞl_fÜw¬d
:

283 
	`£t_İt
(
sbi
, 
DISABLE_ROLL_FORWARD
);

285 
O±_disÿrd
:

286 
	`£t_İt
(
sbi
, 
DISCARD
);

288 
O±_noh—p
:

289 
	`£t_İt
(
sbi
, 
NOHEAP
);

291 #ifdeà
CONFIG_F2FS_FS_XATTR


292 
O±_u£r_x©Œ
:

293 
	`£t_İt
(
sbi
, 
XATTR_USER
);

295 
O±_nou£r_x©Œ
:

296 
	`ş—r_İt
(
sbi
, 
XATTR_USER
);

298 
O±_šlše_x©Œ
:

299 
	`£t_İt
(
sbi
, 
INLINE_XATTR
);

302 
O±_u£r_x©Œ
:

303 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

306 
O±_nou£r_x©Œ
:

307 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

310 
O±_šlše_x©Œ
:

311 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

315 #ifdeà
CONFIG_F2FS_FS_POSIX_ACL


316 
O±_aş
:

317 
	`£t_İt
(
sbi
, 
POSIX_ACL
);

319 
O±_nßş
:

320 
	`ş—r_İt
(
sbi
, 
POSIX_ACL
);

323 
O±_aş
:

324 
	`f2fs_msg
(
sb
, 
KERN_INFO
, "acl options‚ot supported");

326 
O±_nßş
:

327 
	`f2fs_msg
(
sb
, 
KERN_INFO
, "noacl options‚ot supported");

330 
O±_aùive_logs
:

331 ià(
¬gs
->
äom
 && 
	`m©ch_št
×rgs, &
¬g
))

332  -
EINVAL
;

333 ià(
¬g
 !ğ2 &&‡rg !ğ4 &&‡rg !ğ
NR_CURSEG_TYPE
)

334  -
EINVAL
;

335 
sbi
->
aùive_logs
 = 
¬g
;

337 
O±_di§bË_ext_id’tify
:

338 
	`£t_İt
(
sbi
, 
DISABLE_EXT_IDENTIFY
);

340 
O±_šlše_d©a
:

341 
	`£t_İt
(
sbi
, 
INLINE_DATA
);

343 
O±_æush_m”ge
:

344 
	`£t_İt
(
sbi
, 
FLUSH_MERGE
);

346 
O±_nob¬r›r
:

347 
	`£t_İt
(
sbi
, 
NOBARRIER
);

350 
	`f2fs_msg
(
sb
, 
KERN_ERR
,

352 
p
);

353  -
EINVAL
;

357 
	}
}

359 
šode
 *
	$f2fs_®loc_šode
(
su³r_block
 *
sb
)

361 
f2fs_šode_šfo
 *
fi
;

363 
fi
 = 
	`kmem_ÿche_®loc
(
f2fs_šode_ÿch•
, 
GFP_F2FS_ZERO
);

364 ià(!
fi
)

365  
NULL
;

367 
	`š™_Úû
((*è
fi
);

370 
fi
->
vfs_šode
.
i_v”siÚ
 = 1;

371 
	`©omic_£t
(&
fi
->
dœty_·ges
, 0);

372 
fi
->
i_cu¼’t_d•th
 = 1;

373 
fi
->
i_advi£
 = 0;

374 
	`rwlock_š™
(&
fi
->
ext
.
ext_lock
);

375 
	`š™_rw£m
(&
fi
->
i_£m
);

376 
	`INIT_LIST_HEAD
(&
fi
->
šmem_·ges
);

377 
	`mu‹x_š™
(&
fi
->
šmem_lock
);

379 
	`£t_šode_æag
(
fi
, 
FI_NEW_INODE
);

381 ià(
	`‹¡_İt
(
	`F2FS_SB
(
sb
), 
INLINE_XATTR
))

382 
	`£t_šode_æag
(
fi
, 
FI_INLINE_XATTR
);

385 
fi
->
i_dœ_Ëv–
 = 
	`F2FS_SB
(
sb
)->
dœ_Ëv–
;

387  &
fi
->
vfs_šode
;

388 
	}
}

390 
	$f2fs_drİ_šode
(
šode
 *inode)

399 ià(!
	`šode_unhashed
(
šode
è&& inode->
i_¡©e
 & 
I_SYNC
)

401  
	`g’”ic_drİ_šode
(
šode
);

402 
	}
}

409 
	$f2fs_dœty_šode
(
šode
 *šode, 
æags
)

411 
	`£t_šode_æag
(
	`F2FS_I
(
šode
), 
FI_DIRTY_INODE
);

412 
	}
}

414 
	$f2fs_i_ÿÎback
(
rcu_h—d
 *
h—d
)

416 
šode
 *šodğ
	`cÚš”_of
(
h—d
, šode, 
i_rcu
);

417 
	`kmem_ÿche_ä“
(
f2fs_šode_ÿch•
, 
	`F2FS_I
(
šode
));

418 
	}
}

420 
	$f2fs_de¡roy_šode
(
šode
 *inode)

422 
	`ÿÎ_rcu
(&
šode
->
i_rcu
, 
f2fs_i_ÿÎback
);

423 
	}
}

425 
	$f2fs_put_su³r
(
su³r_block
 *
sb
)

427 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

429 ià(
sbi
->
s_´oc
) {

430 #ifdeà
F2FS_GET_FS_WAF


431 
	`»move_´oc_’Œy
("waf_šfo", 
sbi
->
s_´oc
);

433 #ifdeà
F2FS_GET_VALID_BLOCKS_INFO


434 
	`»move_´oc_’Œy
("v®id_blocks_šfo", 
sbi
->
s_´oc
);

436 
	`»move_´oc_’Œy
("£gm’t_šfo", 
sbi
->
s_´oc
);

437 
	`»move_´oc_’Œy
(
sb
->
s_id
, 
f2fs_´oc_roÙ
);

439 
	`kobjeù_d–
(&
sbi
->
s_kobj
);

441 
	`f2fs_de¡roy_¡©s
(
sbi
);

442 
	`¡İ_gc_th»ad
(
sbi
);

445 ià(
sbi
->
s_dœty
) {

446 
ı_cÚŒŞ
 
ıc
 = {

447 .
»asÚ
 = 
CP_UMOUNT
,

449 
	`wr™e_checkpošt
(
sbi
, &
ıc
);

456 
	`»Ëa£_dœty_šode
(
sbi
);

457 
	`»Ëa£_disÿrd_addrs
(
sbi
);

459 
	`ut
(
sbi
->
node_šode
);

460 
	`ut
(
sbi
->
m‘a_šode
);

463 
	`de¡roy_node_mªag”
(
sbi
);

464 
	`de¡roy_£gm’t_mªag”
(
sbi
);

466 
	`kä“
(
sbi
->
ck±
);

467 
	`kobjeù_put
(&
sbi
->
s_kobj
);

468 
	`wa™_fÜ_com¶‘iÚ
(&
sbi
->
s_kobj_uÄegi¡”
);

470 
sb
->
s_fs_šfo
 = 
NULL
;

471 
	`b»l£
(
sbi
->
¿w_su³r_buf
);

472 
	`kä“
(
sbi
);

473 
	}
}

475 
	$f2fs_sync_fs
(
su³r_block
 *
sb
, 
sync
)

477 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

479 
	`Œaû_f2fs_sync_fs
(
sb
, 
sync
);

481 ià(
sync
) {

482 
ı_cÚŒŞ
 
ıc
 = {

483 .
»asÚ
 = 
CP_SYNC
,

485 
	`mu‹x_lock
(&
sbi
->
gc_mu‹x
);

486 
	`wr™e_checkpošt
(
sbi
, &
ıc
);

487 
	`mu‹x_uÆock
(&
sbi
->
gc_mu‹x
);

489 
	`f2fs_b®ªû_fs
(
sbi
);

493 
	}
}

495 
	$f2fs_ä“ze
(
su³r_block
 *
sb
)

497 
”r
;

499 ià(
	`f2fs_»adÚly
(
sb
))

502 
”r
 = 
	`f2fs_sync_fs
(
sb
, 1);

503  
”r
;

504 
	}
}

506 
	$f2fs_unä“ze
(
su³r_block
 *
sb
)

509 
	}
}

511 
	$f2fs_¡©fs
(
d’Œy
 *d’Œy, 
k¡©fs
 *
buf
)

513 
su³r_block
 *
sb
 = 
d’Œy
->
d_sb
;

514 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

515 
u64
 
id
 = 
	`huge_’code_dev
(
sb
->
s_bdev
->
bd_dev
);

516 
block_t
 
tÙ®_couÁ
, 
u£r_block_couÁ
, 
¡¬t_couÁ
, 
ovp_couÁ
;

518 
tÙ®_couÁ
 = 
	`Ë64_to_ıu
(
sbi
->
¿w_su³r
->
block_couÁ
);

519 
u£r_block_couÁ
 = 
sbi
->user_block_count;

520 
¡¬t_couÁ
 = 
	`Ë32_to_ıu
(
sbi
->
¿w_su³r
->
£gm’t0_blkaddr
);

521 
ovp_couÁ
 = 
	`SM_I
(
sbi
)->
ovp_£gm’ts
 << sbi->
log_blocks_³r_£g
;

522 
buf
->
f_ty³
 = 
F2FS_SUPER_MAGIC
;

523 
buf
->
f_bsize
 = 
sbi
->
blocksize
;

525 
buf
->
f_blocks
 = 
tÙ®_couÁ
 - 
¡¬t_couÁ
;

526 
buf
->
f_bä“
 = buf->
f_blocks
 - 
	`v®id_u£r_blocks
(
sbi
è- 
ovp_couÁ
;

527 
buf
->
f_bava
 = 
u£r_block_couÁ
 - 
	`v®id_u£r_blocks
(
sbi
);

529 
buf
->
f_fes
 = 
sbi
->
tÙ®_node_couÁ
 - 
F2FS_RESERVED_NODE_NUM
;

530 
buf
->
f_fä“
 = buf->
f_fes
 - 
	`v®id_šode_couÁ
(
sbi
);

532 
buf
->
f_Çm–’
 = 
F2FS_NAME_LEN
;

533 
buf
->
f_fsid
.
v®
[0] = (
u32
)
id
;

534 
buf
->
f_fsid
.
v®
[1] = (
u32
)(
id
 >> 32);

537 
	}
}

539 
	$f2fs_show_İtiÚs
(
£q_fe
 *
£q
, 
d’Œy
 *
roÙ
)

541 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
roÙ
->
d_sb
);

543 ià(!
	`f2fs_»adÚly
(
sbi
->
sb
è&& 
	`‹¡_İt
(sbi, 
BG_GC
))

544 
	`£q_´štf
(
£q
, ",background_gc=%s", "on");

546 
	`£q_´štf
(
£q
, ",background_gc=%s", "off");

547 ià(
	`‹¡_İt
(
sbi
, 
DISABLE_ROLL_FORWARD
))

548 
	`£q_puts
(
£q
, ",disable_roll_forward");

549 ià(
	`‹¡_İt
(
sbi
, 
DISCARD
))

550 
	`£q_puts
(
£q
, ",discard");

551 ià(
	`‹¡_İt
(
sbi
, 
NOHEAP
))

552 
	`£q_puts
(
£q
, ",no_heap_alloc");

553 #ifdeà
CONFIG_F2FS_FS_XATTR


554 ià(
	`‹¡_İt
(
sbi
, 
XATTR_USER
))

555 
	`£q_puts
(
£q
, ",user_xattr");

557 
	`£q_puts
(
£q
, ",nouser_xattr");

558 ià(
	`‹¡_İt
(
sbi
, 
INLINE_XATTR
))

559 
	`£q_puts
(
£q
, ",inline_xattr");

561 #ifdeà
CONFIG_F2FS_FS_POSIX_ACL


562 ià(
	`‹¡_İt
(
sbi
, 
POSIX_ACL
))

563 
	`£q_puts
(
£q
, ",acl");

565 
	`£q_puts
(
£q
, ",noacl");

567 ià(
	`‹¡_İt
(
sbi
, 
DISABLE_EXT_IDENTIFY
))

568 
	`£q_puts
(
£q
, ",disable_ext_identify");

569 ià(
	`‹¡_İt
(
sbi
, 
INLINE_DATA
))

570 
	`£q_puts
(
£q
, ",inline_data");

571 ià(!
	`f2fs_»adÚly
(
sbi
->
sb
è&& 
	`‹¡_İt
(sbi, 
FLUSH_MERGE
))

572 
	`£q_puts
(
£q
, ",flush_merge");

573 ià(
	`‹¡_İt
(
sbi
, 
NOBARRIER
))

574 
	`£q_puts
(
£q
, ",nobarrier");

575 
	`£q_´štf
(
£q
, ",aùive_logs=%u", 
sbi
->
aùive_logs
);

578 
	}
}

580 #ifdeà
F2FS_GET_FS_WAF


581 
	$waf_šfo_£q_show
(
£q_fe
 *
£q
, *
off£t
)

583 
	`£q_´štf
(
£q
,"%Îu\t%Îu\t%Îu\t%Îu\t%Îu\t%Îu\n", 
Ën_u£r_d©a
,

584 
Ën_fs_wr™e
,

585 
gc_v®id_blocks_tÙ®
,

586 
gc_v®id_blocks_node
,

587 
gc_v®id_blocks_d©a
,

588 
dummy_·ge_couÁ
);

590 
Ën_u£r_d©a
 = 0;

591 
Ën_fs_wr™e
 = 0;

592 
gc_v®id_blocks_tÙ®
 = 0;

593 
gc_v®id_blocks_node
 = 0;

594 
gc_v®id_blocks_d©a
 = 0;

595 
dummy_·ge_couÁ
 = 0;

598 
	}
}

601 #ifdeà
F2FS_GET_VALID_BLOCKS_INFO


602 
	$v®id_blocks_šfo_£q_show
(
£q_fe
 *
£q
, *
off£t
)

604 
i
;

605 
su³r_block
 *
sb
 = 
£q
->
´iv©e
;

606 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

607 
ä“_£gm­_šfo
 *
ä“_i
 = 
	`FREE_I
(
sbi
);

608 
n_tÙ®_£gs
 = 
	`Ë32_to_ıu
(
sbi
->
¿w_su³r
->
£gm’t_couÁ_maš
);

609 
v®id_blocks
 = 0;

610 
£ùiÚ
 = 
sbi
->
£gs_³r_£c
;

611 
ty³
;

612 
®loÿ‹d
;

614 if(
£ùiÚ
 > 1){

615 
i
 = 0; i < 
n_tÙ®_£gs
 ; i+=
£ùiÚ
){

616 
v®id_blocks
 = 
	`g‘_v®id_blocks
(
sbi
, 
i
, 
£ùiÚ
);

617 
ty³
 = 
	`g‘_£g_’Œy
(
sbi
, 
i
)->type;

618 if(
	`‹¡_b™
(
	`GET_SECNO
(
sbi
, 
i
), 
ä“_i
->
ä“_£cm­
)){

619 
®loÿ‹d
 = 1;

622 
®loÿ‹d
 = 0;

624 
	`£q_´štf
(
£q
, "%d\t%d\t%d\t%u\n", 
	`GET_SECNO
(
sbi
, 
i
), 
ty³
, 
®loÿ‹d
, 
v®id_blocks
);

629 
i
 = 0; i < 
n_tÙ®_£gs
 ; i++){

630 
v®id_blocks
 = 
	`g‘_£g_’Œy
(
sbi
, 
i
)->valid_blocks;

631 
ty³
 = 
	`g‘_£g_’Œy
(
sbi
, 
i
)->type;

632 if(
	`‹¡_b™
(
i
, 
ä“_i
->
ä“_£gm­
)){

633 
®loÿ‹d
 = 1;

636 
®loÿ‹d
 = 0;

638 
	`£q_´štf
(
£q
, "%d\t%d\t%d\t%u\n", 
i
, 
ty³
, 
®loÿ‹d
, 
v®id_blocks
);

643 
	}
}

646 
	$£gm’t_šfo_£q_show
(
£q_fe
 *
£q
, *
off£t
)

648 
su³r_block
 *
sb
 = 
£q
->
´iv©e
;

649 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

650 
tÙ®_£gs
 =

651 
	`Ë32_to_ıu
(
sbi
->
¿w_su³r
->
£gm’t_couÁ_maš
);

652 
i
;

654 
	`£q_puts
(
£q
, "format: segment_type|valid_blocks\n"

657 
i
 = 0; i < 
tÙ®_£gs
; i++) {

658 
£g_’Œy
 *
£
 = 
	`g‘_£g_’Œy
(
sbi
, 
i
);

660 ià((
i
 % 10) == 0)

661 
	`£q_´štf
(
£q
, "%-5d", 
i
);

662 
	`£q_´štf
(
£q
, "%d|%-3u", 
£
->
ty³
,

663 
	`g‘_v®id_blocks
(
sbi
, 
i
, 1));

664 ià((
i
 % 10è=ğ9 || i =ğ(
tÙ®_£gs
 - 1))

665 
	`£q_putc
(
£q
, '\n');

667 
	`£q_putc
(
£q
, ' ');

671 
	}
}

673 #ifdeà
F2FS_GET_FS_WAF


674 
	$waf_šfo_İ’_fs
(
šode
 *šode, 
fe
 *file)

676  
	`sšgË_İ’
(
fe
, 
waf_šfo_£q_show
, 
	`PDE_DATA
(
šode
));

677 
	}
}

680 #ifdeà
F2FS_GET_VALID_BLOCKS_INFO


681 
	$v®id_blocks_šfo_İ’_fs
(
šode
 *šode, 
fe
 *file)

683  
	`sšgË_İ’
(
fe
, 
v®id_blocks_šfo_£q_show
, 
	`PDE_DATA
(
šode
));

684 
	}
}

687 
	$£gm’t_šfo_İ’_fs
(
šode
 *šode, 
fe
 *file)

689  
	`sšgË_İ’
(
fe
, 
£gm’t_šfo_£q_show
, 
	`PDE_DATA
(
šode
));

690 
	}
}

692 #ifdeà
F2FS_GET_FS_WAF


693 cÚ¡ 
fe_İ”©iÚs
 
	gf2fs_waf_šfo_fİs
 = {

694 .
owÃr
 = 
THIS_MODULE
,

695 .
	gİ’
 = 
waf_šfo_İ’_fs
,

696 .
	g»ad
 = 
£q_»ad
,

697 .
	gÎ£ek
 = 
£q_l£ek
,

698 .
	g»Ëa£
 = 
sšgË_»Ëa£
,

702 #ifdeà
F2FS_GET_VALID_BLOCKS_INFO


703 cÚ¡ 
fe_İ”©iÚs
 
	gf2fs_v®id_blocks_šfo_fİs
 = {

704 .
owÃr
 = 
THIS_MODULE
,

705 .
	gİ’
 = 
v®id_blocks_šfo_İ’_fs
,

706 .
	g»ad
 = 
£q_»ad
,

707 .
	gÎ£ek
 = 
£q_l£ek
,

708 .
	g»Ëa£
 = 
sšgË_»Ëa£
,

712 cÚ¡ 
fe_İ”©iÚs
 
	gf2fs_£q_£gm’t_šfo_fİs
 = {

713 .
owÃr
 = 
THIS_MODULE
,

714 .
	gİ’
 = 
£gm’t_šfo_İ’_fs
,

715 .
	g»ad
 = 
£q_»ad
,

716 .
	gÎ£ek
 = 
£q_l£ek
,

717 .
	g»Ëa£
 = 
sšgË_»Ëa£
,

720 
	$f2fs_»mouÁ
(
su³r_block
 *
sb
, *
æags
, *
d©a
)

722 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

723 
f2fs_mouÁ_šfo
 
Üg_mouÁ_İt
;

724 
”r
, 
aùive_logs
;

725 
boŞ
 
Ãed_»¡¬t_gc
 = 
çl£
;

726 
boŞ
 
Ãed_¡İ_gc
 = 
çl£
;

728 
	`sync_fesy¡em
(
sb
);

734 
Üg_mouÁ_İt
 = 
sbi
->
mouÁ_İt
;

735 
aùive_logs
 = 
sbi
->active_logs;

737 
sbi
->
mouÁ_İt
.
İt
 = 0;

738 
sbi
->
aùive_logs
 = 
NR_CURSEG_TYPE
;

741 
”r
 = 
	`·r£_İtiÚs
(
sb
, 
d©a
);

742 ià(
”r
)

743 
»¡Üe_İts
;

749 ià(
	`f2fs_»adÚly
(
sb
è&& (*
æags
 & 
MS_RDONLY
))

750 
sk
;

757 ià((*
æags
 & 
MS_RDONLY
è|| !
	`‹¡_İt
(
sbi
, 
BG_GC
)) {

758 ià(
sbi
->
gc_th»ad
) {

759 
	`¡İ_gc_th»ad
(
sbi
);

760 
	`f2fs_sync_fs
(
sb
, 1);

761 
Ãed_»¡¬t_gc
 = 
Œue
;

763 } ià(
	`‹¡_İt
(
sbi
, 
BG_GC
è&& !sbi->
gc_th»ad
) {

764 
”r
 = 
	`¡¬t_gc_th»ad
(
sbi
);

765 ià(
”r
)

766 
»¡Üe_İts
;

767 
Ãed_¡İ_gc
 = 
Œue
;

774 ià((*
æags
 & 
MS_RDONLY
è|| !
	`‹¡_İt
(
sbi
, 
FLUSH_MERGE
)) {

775 
	`de¡roy_æush_cmd_cÚŒŞ
(
sbi
);

776 } ià(
	`‹¡_İt
(
sbi
, 
FLUSH_MERGE
è&& !
	`SM_I
(sbi)->
cmd_cÚŒŞ_šfo
) {

777 
”r
 = 
	`ü—‹_æush_cmd_cÚŒŞ
(
sbi
);

778 ià(
”r
)

779 
»¡Üe_gc
;

781 
sk
:

783 
sb
->
s_æags
 = (sb->s_æag & ~
MS_POSIXACL
) |

784 (
	`‹¡_İt
(
sbi
, 
POSIX_ACL
è? 
MS_POSIXACL
 : 0);

786 
»¡Üe_gc
:

787 ià(
Ãed_»¡¬t_gc
) {

788 ià(
	`¡¬t_gc_th»ad
(
sbi
))

789 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_WARNING
,

791 } ià(
Ãed_¡İ_gc
) {

792 
	`¡İ_gc_th»ad
(
sbi
);

794 
»¡Üe_İts
:

795 
sbi
->
mouÁ_İt
 = 
Üg_mouÁ_İt
;

796 
sbi
->
aùive_logs
 =‡ctive_logs;

797  
”r
;

798 
	}
}

800 
su³r_İ”©iÚs
 
	gf2fs_sİs
 = {

801 .
®loc_šode
 = 
f2fs_®loc_šode
,

802 .
	gdrİ_šode
 = 
f2fs_drİ_šode
,

803 .
	gde¡roy_šode
 = 
f2fs_de¡roy_šode
,

804 .
	gwr™e_šode
 = 
f2fs_wr™e_šode
,

805 .
	gdœty_šode
 = 
f2fs_dœty_šode
,

806 .
	gshow_İtiÚs
 = 
f2fs_show_İtiÚs
,

807 .
	geviù_šode
 = 
f2fs_eviù_šode
,

808 .
	gput_su³r
 = 
f2fs_put_su³r
,

809 .
	gsync_fs
 = 
f2fs_sync_fs
,

810 .
	gä“ze_fs
 = 
f2fs_ä“ze
,

811 .
	gunä“ze_fs
 = 
f2fs_unä“ze
,

812 .
	g¡©fs
 = 
f2fs_¡©fs
,

813 .
	g»mouÁ_fs
 = 
f2fs_»mouÁ
,

816 
šode
 *
	$f2fs_nfs_g‘_šode
(
su³r_block
 *
sb
,

817 
u64
 
šo
, 
u32
 
g’”©iÚ
)

819 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
sb
);

820 
šode
 *inode;

822 ià(
	`check_nid_¿nge
(
sbi
, 
šo
))

823  
	`ERR_PTR
(-
ESTALE
);

830 
šode
 = 
	`f2fs_ig‘
(
sb
, 
šo
);

831 ià(
	`IS_ERR
(
šode
))

832  
	`ERR_CAST
(
šode
);

833 ià(
	`uÆik–y
(
g’”©iÚ
 && 
šode
->
i_g’”©iÚ
 != generation)) {

835 
	`ut
(
šode
);

836  
	`ERR_PTR
(-
ESTALE
);

838  
šode
;

839 
	}
}

841 
d’Œy
 *
	$f2fs_fh_to_d’Œy
(
su³r_block
 *
sb
, 
fid
 *fid,

842 
fh_Ën
, 
fh_ty³
)

844  
	`g’”ic_fh_to_d’Œy
(
sb
, 
fid
, 
fh_Ën
, 
fh_ty³
,

845 
f2fs_nfs_g‘_šode
);

846 
	}
}

848 
d’Œy
 *
	$f2fs_fh_to_·»Á
(
su³r_block
 *
sb
, 
fid
 *fid,

849 
fh_Ën
, 
fh_ty³
)

851  
	`g’”ic_fh_to_·»Á
(
sb
, 
fid
, 
fh_Ën
, 
fh_ty³
,

852 
f2fs_nfs_g‘_šode
);

853 
	}
}

855 cÚ¡ 
expÜt_İ”©iÚs
 
	gf2fs_expÜt_İs
 = {

856 .
fh_to_d’Œy
 = 
f2fs_fh_to_d’Œy
,

857 .
	gfh_to_·»Á
 = 
f2fs_fh_to_·»Á
,

858 .
	gg‘_·»Á
 = 
f2fs_g‘_·»Á
,

861 
loff_t
 
	$max_fe_size
(
b™s
)

863 
loff_t
 
»suÉ
 = (
DEF_ADDRS_PER_INODE
 - 
F2FS_INLINE_XATTR_ADDRS
);

864 
loff_t
 
Ëaf_couÁ
 = 
ADDRS_PER_BLOCK
;

867 
»suÉ
 +ğ(
Ëaf_couÁ
 * 2);

870 
Ëaf_couÁ
 *ğ
NIDS_PER_BLOCK
;

871 
»suÉ
 +ğ(
Ëaf_couÁ
 * 2);

874 
Ëaf_couÁ
 *ğ
NIDS_PER_BLOCK
;

875 
»suÉ
 +ğ
Ëaf_couÁ
;

877 
»suÉ
 <<ğ
b™s
;

878  
»suÉ
;

879 
	}
}

881 
	$§n™y_check_¿w_su³r
(
su³r_block
 *
sb
,

882 
f2fs_su³r_block
 *
¿w_su³r
)

884 
blocksize
;

886 ià(
F2FS_SUPER_MAGIC
 !ğ
	`Ë32_to_ıu
(
¿w_su³r
->
magic
)) {

887 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

889 
F2FS_SUPER_MAGIC
, 
	`Ë32_to_ıu
(
¿w_su³r
->
magic
));

894 ià(
F2FS_BLKSIZE
 !ğ
PAGE_CACHE_SIZE
) {

895 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

897 
PAGE_CACHE_SIZE
);

902 
blocksize
 = 1 << 
	`Ë32_to_ıu
(
¿w_su³r
->
log_blocksize
);

903 ià(
blocksize
 !ğ
F2FS_BLKSIZE
) {

904 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

906 
blocksize
);

911 ià(
	`Ë32_to_ıu
(
¿w_su³r
->
log_£ùÜsize
) >

912 
F2FS_MAX_LOG_SECTOR_SIZE
 ||

913 
	`Ë32_to_ıu
(
¿w_su³r
->
log_£ùÜsize
) <

914 
F2FS_MIN_LOG_SECTOR_SIZE
) {

915 
	`f2fs_msg
(
sb
, 
KERN_INFO
, "Invalid†og sectorsize (%u)",

916 
	`Ë32_to_ıu
(
¿w_su³r
->
log_£ùÜsize
));

919 ià(
	`Ë32_to_ıu
(
¿w_su³r
->
log_£ùÜs_³r_block
) +

920 
	`Ë32_to_ıu
(
¿w_su³r
->
log_£ùÜsize
) !=

921 
F2FS_MAX_LOG_SECTOR_SIZE
) {

922 
	`f2fs_msg
(
sb
, 
KERN_INFO
,

924 
	`Ë32_to_ıu
(
¿w_su³r
->
log_£ùÜs_³r_block
),

925 
	`Ë32_to_ıu
(
¿w_su³r
->
log_£ùÜsize
));

929 
	}
}

931 
	$§n™y_check_ck±
(
f2fs_sb_šfo
 *
sbi
)

933 
tÙ®
, 
fsm‘a
;

934 
f2fs_su³r_block
 *
¿w_su³r
 = 
	`F2FS_RAW_SUPER
(
sbi
);

935 
f2fs_checkpošt
 *
ck±
 = 
	`F2FS_CKPT
(
sbi
);

937 
tÙ®
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ
);

938 
fsm‘a
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_ck±
);

939 
fsm‘a
 +ğ
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_s™
);

940 
fsm‘a
 +ğ
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_Çt
);

941 
fsm‘a
 +ğ
	`Ë32_to_ıu
(
ck±
->
rsvd_£gm’t_couÁ
);

942 
fsm‘a
 +ğ
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_s§
);

944 ià(
	`uÆik–y
(
fsm‘a
 >ğ
tÙ®
))

947 ià(
	`uÆik–y
(
	`f2fs_ı_”rÜ
(
sbi
))) {

948 
	`f2fs_msg
(
sbi
->
sb
, 
KERN_ERR
, "A bug case:‚eedo„un fsck");

952 
	}
}

954 
	$š™_sb_šfo
(
f2fs_sb_šfo
 *
sbi
)

956 
f2fs_su³r_block
 *
¿w_su³r
 = 
sbi
->raw_super;

957 
i
;

959 
sbi
->
log_£ùÜs_³r_block
 =

960 
	`Ë32_to_ıu
(
¿w_su³r
->
log_£ùÜs_³r_block
);

961 
sbi
->
log_blocksize
 = 
	`Ë32_to_ıu
(
¿w_su³r
->log_blocksize);

962 
sbi
->
blocksize
 = 1 << sbi->
log_blocksize
;

963 
sbi
->
log_blocks_³r_£g
 = 
	`Ë32_to_ıu
(
¿w_su³r
->log_blocks_per_seg);

964 
sbi
->
blocks_³r_£g
 = 1 << sbi->
log_blocks_³r_£g
;

965 
sbi
->
£gs_³r_£c
 = 
	`Ë32_to_ıu
(
¿w_su³r
->segs_per_sec);

966 
sbi
->
£cs_³r_zÚe
 = 
	`Ë32_to_ıu
(
¿w_su³r
->secs_per_zone);

967 
sbi
->
tÙ®_£ùiÚs
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
£ùiÚ_couÁ
);

968 
sbi
->
tÙ®_node_couÁ
 =

969 (
	`Ë32_to_ıu
(
¿w_su³r
->
£gm’t_couÁ_Çt
) / 2)

970 * 
sbi
->
blocks_³r_£g
 * 
NAT_ENTRY_PER_BLOCK
;

971 
sbi
->
roÙ_šo_num
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
roÙ_šo
);

972 
sbi
->
node_šo_num
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
node_šo
);

973 
sbi
->
m‘a_šo_num
 = 
	`Ë32_to_ıu
(
¿w_su³r
->
m‘a_šo
);

974 
sbi
->
cur_viùim_£c
 = 
NULL_SECNO
;

975 
sbi
->
max_viùim_£¬ch
 = 
DEF_MAX_VICTIM_SEARCH
;

977 
i
 = 0; i < 
NR_COUNT_TYPE
; i++)

978 
	`©omic_£t
(&
sbi
->
Ä_·ges
[
i
], 0);

980 
sbi
->
dœ_Ëv–
 = 
DEF_DIR_LEVEL
;

981 
sbi
->
Ãed_fsck
 = 
çl£
;

982 
	}
}

989 
	$»ad_¿w_su³r_block
(
su³r_block
 *
sb
,

990 
f2fs_su³r_block
 **
¿w_su³r
,

991 
bufãr_h—d
 **
¿w_su³r_buf
)

993 
block
 = 0;

995 
»Œy
:

996 *
¿w_su³r_buf
 = 
	`sb_b»ad
(
sb
, 
block
);

997 ià(!*
¿w_su³r_buf
) {

998 
	`f2fs_msg
(
sb
, 
KERN_ERR
, "Unableo„ead %dth superblock",

999 
block
 + 1);

1000 ià(
block
 == 0) {

1001 
block
++;

1002 
»Œy
;

1004  -
EIO
;

1008 *
¿w_su³r
 = (
f2fs_su³r_block
 *)

1009 ((*)(*
¿w_su³r_buf
)->
b_d©a
 + 
F2FS_SUPER_OFFSET
);

1012 ià(
	`§n™y_check_¿w_su³r
(
sb
, *
¿w_su³r
)) {

1013 
	`b»l£
(*
¿w_su³r_buf
);

1014 
	`f2fs_msg
(
sb
, 
KERN_ERR
,

1016 
block
 + 1);

1017 ià(
block
 == 0) {

1018 
block
++;

1019 
»Œy
;

1021  -
EINVAL
;

1026 
	}
}

1028 
	$f2fs_fl_su³r
(
su³r_block
 *
sb
, *
d©a
, 
s’t
)

1030 
f2fs_sb_šfo
 *
sbi
;

1031 
f2fs_su³r_block
 *
¿w_su³r
;

1032 
bufãr_h—d
 *
¿w_su³r_buf
;

1033 
šode
 *
roÙ
;

1034 
”r
 = -
EINVAL
;

1035 
boŞ
 
»Œy
 = 
Œue
;

1036 
i
;

1038 
Œy_ÚemÜe
:

1040 
sbi
 = 
	`kz®loc
((
f2fs_sb_šfo
), 
GFP_KERNEL
);

1041 ià(!
sbi
)

1042  -
ENOMEM
;

1045 ià(
	`uÆik–y
(!
	`sb_£t_blocksize
(
sb
, 
F2FS_BLKSIZE
))) {

1046 
	`f2fs_msg
(
sb
, 
KERN_ERR
, "unableo set blocksize");

1047 
ä“_sbi
;

1050 
”r
 = 
	`»ad_¿w_su³r_block
(
sb
, &
¿w_su³r
, &
¿w_su³r_buf
);

1051 ià(
”r
)

1052 
ä“_sbi
;

1054 
sb
->
s_fs_šfo
 = 
sbi
;

1056 
sbi
->
aùive_logs
 = 
NR_CURSEG_TYPE
;

1058 
	`£t_İt
(
sbi
, 
BG_GC
);

1060 #ifdeà
CONFIG_F2FS_FS_XATTR


1061 
	`£t_İt
(
sbi
, 
XATTR_USER
);

1063 #ifdeà
CONFIG_F2FS_FS_POSIX_ACL


1064 
	`£t_İt
(
sbi
, 
POSIX_ACL
);

1067 
”r
 = 
	`·r£_İtiÚs
(
sb
, (*)
d©a
);

1068 ià(
”r
)

1069 
ä“_sb_buf
;

1071 
sb
->
s_maxby‹s
 = 
	`max_fe_size
(
	`Ë32_to_ıu
(
¿w_su³r
->
log_blocksize
));

1072 
sb
->
s_max_lšks
 = 
F2FS_LINK_MAX
;

1073 
	`g‘_¿ndom_by‹s
(&
sbi
->
s_Ãxt_g’”©iÚ
, (
u32
));

1075 
sb
->
s_İ
 = &
f2fs_sİs
;

1076 
sb
->
s_x©Œ
 = 
f2fs_x©Œ_hªdËrs
;

1077 
sb
->
s_expÜt_İ
 = &
f2fs_expÜt_İs
;

1078 
sb
->
s_magic
 = 
F2FS_SUPER_MAGIC
;

1079 
sb
->
s_time_g¿n
 = 1;

1080 
sb
->
s_æags
 = (sb->s_æag & ~
MS_POSIXACL
) |

1081 (
	`‹¡_İt
(
sbi
, 
POSIX_ACL
è? 
MS_POSIXACL
 : 0);

1082 
	`memıy
(
sb
->
s_uuid
, 
¿w_su³r
->
uuid
, (raw_super->uuid));

1085 
sbi
->
sb
 = sb;

1086 
sbi
->
¿w_su³r
 =„aw_super;

1087 
sbi
->
¿w_su³r_buf
 =„aw_super_buf;

1088 
	`mu‹x_š™
(&
sbi
->
gc_mu‹x
);

1089 
	`mu‹x_š™
(&
sbi
->
wr™•ages
);

1090 
	`mu‹x_š™
(&
sbi
->
ı_mu‹x
);

1091 
	`š™_rw£m
(&
sbi
->
node_wr™e
);

1092 
sbi
->
pÜ_došg
 = 
çl£
;

1093 
	`¥š_lock_š™
(&
sbi
->
¡©_lock
);

1095 
	`š™_rw£m
(&
sbi
->
»ad_io
.
io_rw£m
);

1096 
sbi
->
»ad_io
.sbi = sbi;

1097 
sbi
->
»ad_io
.
bio
 = 
NULL
;

1098 
i
 = 0; i < 
NR_PAGE_TYPE
; i++) {

1099 
	`š™_rw£m
(&
sbi
->
wr™e_io
[
i
].
io_rw£m
);

1100 
sbi
->
wr™e_io
[
i
].sbi = sbi;

1101 
sbi
->
wr™e_io
[
i
].
bio
 = 
NULL
;

1104 
	`š™_rw£m
(&
sbi
->
ı_rw£m
);

1105 
	`š™_wa™queue_h—d
(&
sbi
->
ı_wa™
);

1106 
	`š™_sb_šfo
(
sbi
);

1109 
sbi
->
m‘a_šode
 = 
	`f2fs_ig‘
(
sb
, 
	`F2FS_META_INO
(sbi));

1110 ià(
	`IS_ERR
(
sbi
->
m‘a_šode
)) {

1111 
	`f2fs_msg
(
sb
, 
KERN_ERR
, "Failedo„ead F2FS meta data inode");

1112 
”r
 = 
	`PTR_ERR
(
sbi
->
m‘a_šode
);

1113 
ä“_sb_buf
;

1116 
”r
 = 
	`g‘_v®id_checkpošt
(
sbi
);

1117 ià(
”r
) {

1118 
	`f2fs_msg
(
sb
, 
KERN_ERR
, "Failedo get valid F2FS checkpoint");

1119 
ä“_m‘a_šode
;

1123 
”r
 = -
EINVAL
;

1124 ià(
	`§n™y_check_ck±
(
sbi
)) {

1125 
	`f2fs_msg
(
sb
, 
KERN_ERR
, "Invalid F2FS checkpoint");

1126 
ä“_ı
;

1129 
sbi
->
tÙ®_v®id_node_couÁ
 =

1130 
	`Ë32_to_ıu
(
sbi
->
ck±
->
v®id_node_couÁ
);

1131 
sbi
->
tÙ®_v®id_šode_couÁ
 =

1132 
	`Ë32_to_ıu
(
sbi
->
ck±
->
v®id_šode_couÁ
);

1133 
sbi
->
u£r_block_couÁ
 = 
	`Ë64_to_ıu
(sbi->
ck±
->user_block_count);

1134 
sbi
->
tÙ®_v®id_block_couÁ
 =

1135 
	`Ë64_to_ıu
(
sbi
->
ck±
->
v®id_block_couÁ
);

1136 
sbi
->
Ï¡_v®id_block_couÁ
 = sbi->
tÙ®_v®id_block_couÁ
;

1137 
sbi
->
®loc_v®id_block_couÁ
 = 0;

1138 
	`INIT_LIST_HEAD
(&
sbi
->
dœ_šode_li¡
);

1139 
	`¥š_lock_š™
(&
sbi
->
dœ_šode_lock
);

1141 
	`š™_šo_’Œy_šfo
(
sbi
);

1144 
”r
 = 
	`bud_£gm’t_mªag”
(
sbi
);

1145 ià(
”r
) {

1146 
	`f2fs_msg
(
sb
, 
KERN_ERR
,

1148 
ä“_sm
;

1150 
”r
 = 
	`bud_node_mªag”
(
sbi
);

1151 ià(
”r
) {

1152 
	`f2fs_msg
(
sb
, 
KERN_ERR
,

1154 
ä“_nm
;

1157 
	`bud_gc_mªag”
(
sbi
);

1160 
sbi
->
node_šode
 = 
	`f2fs_ig‘
(
sb
, 
	`F2FS_NODE_INO
(sbi));

1161 ià(
	`IS_ERR
(
sbi
->
node_šode
)) {

1162 
	`f2fs_msg
(
sb
, 
KERN_ERR
, "Failedo„ead‚ode inode");

1163 
”r
 = 
	`PTR_ERR
(
sbi
->
node_šode
);

1164 
ä“_nm
;

1168 
	`»cov”_Üphª_šodes
(
sbi
);

1171 
roÙ
 = 
	`f2fs_ig‘
(
sb
, 
	`F2FS_ROOT_INO
(
sbi
));

1172 ià(
	`IS_ERR
(
roÙ
)) {

1173 
	`f2fs_msg
(
sb
, 
KERN_ERR
, "Failedo„ead„oot inode");

1174 
”r
 = 
	`PTR_ERR
(
roÙ
);

1175 
ä“_node_šode
;

1177 ià(!
	`S_ISDIR
(
roÙ
->
i_mode
è|| !roÙ->
i_blocks
 || !roÙ->
i_size
) {

1178 
	`ut
(
roÙ
);

1179 
”r
 = -
EINVAL
;

1180 
ä“_node_šode
;

1183 
sb
->
s_roÙ
 = 
	`d_make_roÙ
(
roÙ
);

1184 ià(!
sb
->
s_roÙ
) {

1185 
”r
 = -
ENOMEM
;

1186 
ä“_roÙ_šode
;

1189 
”r
 = 
	`f2fs_bud_¡©s
(
sbi
);

1190 ià(
”r
)

1191 
ä“_roÙ_šode
;

1193 ià(
f2fs_´oc_roÙ
)

1194 
sbi
->
s_´oc
 = 
	`´oc_mkdœ
(
sb
->
s_id
, 
f2fs_´oc_roÙ
);

1196 #ifdeà
F2FS_GET_FS_WAF


1197 ià(
sbi
->
s_´oc
)

1198 
	`´oc_ü—‹_d©a
("waf_šfo", 
S_IRUGO
, 
sbi
->
s_´oc
,

1199 &
f2fs_waf_šfo_fİs
, 
sb
);

1201 #ifdeà
F2FS_GET_VALID_BLOCKS_INFO


1202 ià(
sbi
->
s_´oc
)

1203 
	`´oc_ü—‹_d©a
("v®id_blocks_šfo", 
S_IRUGO
, 
sbi
->
s_´oc
,

1204 &
f2fs_v®id_blocks_šfo_fİs
, 
sb
);

1206 ià(
sbi
->
s_´oc
)

1207 
	`´oc_ü—‹_d©a
("£gm’t_šfo", 
S_IRUGO
, 
sbi
->
s_´oc
,

1208 &
f2fs_£q_£gm’t_šfo_fİs
, 
sb
);

1210 ià(
	`‹¡_İt
(
sbi
, 
DISCARD
)) {

1211 
»que¡_queue
 *
q
 = 
	`bdev_g‘_queue
(
sb
->
s_bdev
);

1212 ià(!
	`blk_queue_disÿrd
(
q
))

1213 
	`f2fs_msg
(
sb
, 
KERN_WARNING
,

1218 
sbi
->
s_kobj
.
k£t
 = 
f2fs_k£t
;

1219 
	`š™_com¶‘iÚ
(&
sbi
->
s_kobj_uÄegi¡”
);

1220 
”r
 = 
	`kobjeù_š™_ªd_add
(&
sbi
->
s_kobj
, &
f2fs_kty³
, 
NULL
,

1221 "%s", 
sb
->
s_id
);

1222 ià(
”r
)

1223 
ä“_´oc
;

1225 ià(!
»Œy
)

1226 
sbi
->
Ãed_fsck
 = 
Œue
;

1229 ià(!
	`‹¡_İt
(
sbi
, 
DISABLE_ROLL_FORWARD
)) {

1230 
”r
 = 
	`»cov”_fsync_d©a
(
sbi
);

1231 ià(
”r
) {

1232 
	`f2fs_msg
(
sb
, 
KERN_ERR
,

1233 "CªnÙ„ecov”‡Î fsynød©¨”ºo=%ld", 
”r
);

1234 
ä“_kobj
;

1242 ià(!
	`f2fs_»adÚly
(
sb
)) {

1244 
”r
 = 
	`¡¬t_gc_th»ad
(
sbi
);

1245 ià(
”r
)

1246 
ä“_kobj
;

1250 
ä“_kobj
:

1251 
	`kobjeù_d–
(&
sbi
->
s_kobj
);

1252 
ä“_´oc
:

1253 ià(
sbi
->
s_´oc
) {

1254 #ifdeà
F2FS_GET_FS_WAF


1255 
	`»move_´oc_’Œy
("waf_šfo", 
sbi
->
s_´oc
);

1257 #ifdeà
F2FS_GET_VALID_BLOCKS_INFO


1258 
	`»move_´oc_’Œy
("v®id_blocks_šfo", 
sbi
->
s_´oc
);

1260 
	`»move_´oc_’Œy
("£gm’t_šfo", 
sbi
->
s_´oc
);

1261 
	`»move_´oc_’Œy
(
sb
->
s_id
, 
f2fs_´oc_roÙ
);

1263 
	`f2fs_de¡roy_¡©s
(
sbi
);

1264 
ä“_roÙ_šode
:

1265 
	`dput
(
sb
->
s_roÙ
);

1266 
sb
->
s_roÙ
 = 
NULL
;

1267 
ä“_node_šode
:

1268 
	`ut
(
sbi
->
node_šode
);

1269 
ä“_nm
:

1270 
	`de¡roy_node_mªag”
(
sbi
);

1271 
ä“_sm
:

1272 
	`de¡roy_£gm’t_mªag”
(
sbi
);

1273 
ä“_ı
:

1274 
	`kä“
(
sbi
->
ck±
);

1275 
ä“_m‘a_šode
:

1276 
	`make_bad_šode
(
sbi
->
m‘a_šode
);

1277 
	`ut
(
sbi
->
m‘a_šode
);

1278 
ä“_sb_buf
:

1279 
	`b»l£
(
¿w_su³r_buf
);

1280 
ä“_sbi
:

1281 
	`kä“
(
sbi
);

1284 ià(
»Œy
) {

1285 
»Œy
 = 0;

1286 
	`shršk_dÿche_sb
(
sb
);

1287 
Œy_ÚemÜe
;

1289  
”r
;

1290 
	}
}

1292 
d’Œy
 *
	$f2fs_mouÁ
(
fe_sy¡em_ty³
 *
fs_ty³
, 
æags
,

1293 cÚ¡ *
dev_Çme
, *
d©a
)

1295  
	`mouÁ_bdev
(
fs_ty³
, 
æags
, 
dev_Çme
, 
d©a
, 
f2fs_fl_su³r
);

1296 
	}
}

1298 
fe_sy¡em_ty³
 
	gf2fs_fs_ty³
 = {

1299 .
owÃr
 = 
THIS_MODULE
,

1300 .
	gÇme
 = "f2fs",

1301 .
	gmouÁ
 = 
f2fs_mouÁ
,

1302 .
	gkl_sb
 = 
kl_block_su³r
,

1303 .
	gfs_æags
 = 
FS_REQUIRES_DEV
,

1305 
MODULE_ALIAS_FS
("f2fs");

1307 
__š™
 
	$š™_šodeÿche
()

1309 
f2fs_šode_ÿch•
 = 
	`f2fs_kmem_ÿche_ü—‹
("f2fs_inode_cache",

1310 (
f2fs_šode_šfo
));

1311 ià(!
f2fs_šode_ÿch•
)

1312  -
ENOMEM
;

1314 
	}
}

1316 
	$de¡roy_šodeÿche
()

1322 
	`rcu_b¬r›r
();

1323 
	`kmem_ÿche_de¡roy
(
f2fs_šode_ÿch•
);

1324 
	}
}

1326 
__š™
 
	$š™_f2fs_fs
()

1328 
”r
;

1330 
”r
 = 
	`š™_šodeÿche
();

1331 ià(
”r
)

1332 
ç
;

1333 
”r
 = 
	`ü—‹_node_mªag”_ÿches
();

1334 ià(
”r
)

1335 
ä“_šodeÿche
;

1336 
”r
 = 
	`ü—‹_£gm’t_mªag”_ÿches
();

1337 ià(
”r
)

1338 
ä“_node_mªag”_ÿches
;

1339 
”r
 = 
	`ü—‹_gc_ÿches
();

1340 ià(
”r
)

1341 
ä“_£gm’t_mªag”_ÿches
;

1342 
”r
 = 
	`ü—‹_checkpošt_ÿches
();

1343 ià(
”r
)

1344 
ä“_gc_ÿches
;

1345 
f2fs_k£t
 = 
	`k£t_ü—‹_ªd_add
("f2fs", 
NULL
, 
fs_kobj
);

1346 ià(!
f2fs_k£t
) {

1347 
”r
 = -
ENOMEM
;

1348 
ä“_checkpošt_ÿches
;

1350 
”r
 = 
	`»gi¡”_fesy¡em
(&
f2fs_fs_ty³
);

1351 ià(
”r
)

1352 
ä“_k£t
;

1353 
	`f2fs_ü—‹_roÙ_¡©s
();

1354 
f2fs_´oc_roÙ
 = 
	`´oc_mkdœ
("fs/f2fs", 
NULL
);

1357 
ä“_k£t
:

1358 
	`k£t_uÄegi¡”
(
f2fs_k£t
);

1359 
ä“_checkpošt_ÿches
:

1360 
	`de¡roy_checkpošt_ÿches
();

1361 
ä“_gc_ÿches
:

1362 
	`de¡roy_gc_ÿches
();

1363 
ä“_£gm’t_mªag”_ÿches
:

1364 
	`de¡roy_£gm’t_mªag”_ÿches
();

1365 
ä“_node_mªag”_ÿches
:

1366 
	`de¡roy_node_mªag”_ÿches
();

1367 
ä“_šodeÿche
:

1368 
	`de¡roy_šodeÿche
();

1369 
ç
:

1370  
”r
;

1371 
	}
}

1373 
__ex™
 
	$ex™_f2fs_fs
()

1375 
	`»move_´oc_’Œy
("fs/f2fs", 
NULL
);

1376 
	`f2fs_de¡roy_roÙ_¡©s
();

1377 
	`uÄegi¡”_fesy¡em
(&
f2fs_fs_ty³
);

1378 
	`de¡roy_checkpošt_ÿches
();

1379 
	`de¡roy_gc_ÿches
();

1380 
	`de¡roy_£gm’t_mªag”_ÿches
();

1381 
	`de¡roy_node_mªag”_ÿches
();

1382 
	`de¡roy_šodeÿche
();

1383 
	`k£t_uÄegi¡”
(
f2fs_k£t
);

1384 
	}
}

1386 
	$moduË_š™
(
š™_f2fs_fs
)

1387 
	$moduË_ex™
(
ex™_f2fs_fs
)

1389 
	`MODULE_AUTHOR
("Samsung Electronics's Praesto Team");

1390 
	`MODULE_DESCRIPTION
("Flash Friendly File System");

1391 
	`MODULE_LICENSE
("GPL");

	@xattr.c

21 
	~<lšux/rw£m.h
>

22 
	~<lšux/f2fs_fs.h
>

23 
	~<lšux/£cur™y.h
>

24 
	~<lšux/posix_aş_x©Œ.h
>

25 
	~"f2fs.h
"

26 
	~"x©Œ.h
"

28 
size_t
 
	$f2fs_x©Œ_g’”ic_li¡
(
d’Œy
 *d’Œy, *
li¡
,

29 
size_t
 
li¡_size
, cÚ¡ *
Çme
, size_ˆ
Ën
, 
ty³
)

31 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
d’Œy
->
d_sb
);

32 
tÙ®_Ën
, 
´efix_Ën
 = 0;

33 cÚ¡ *
´efix
 = 
NULL
;

35 
ty³
) {

36 
F2FS_XATTR_INDEX_USER
:

37 ià(!
	`‹¡_İt
(
sbi
, 
XATTR_USER
))

38  -
EOPNOTSUPP
;

39 
´efix
 = 
XATTR_USER_PREFIX
;

40 
´efix_Ën
 = 
XATTR_USER_PREFIX_LEN
;

42 
F2FS_XATTR_INDEX_TRUSTED
:

43 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

44  -
EPERM
;

45 
´efix
 = 
XATTR_TRUSTED_PREFIX
;

46 
´efix_Ën
 = 
XATTR_TRUSTED_PREFIX_LEN
;

48 
F2FS_XATTR_INDEX_SECURITY
:

49 
´efix
 = 
XATTR_SECURITY_PREFIX
;

50 
´efix_Ën
 = 
XATTR_SECURITY_PREFIX_LEN
;

53  -
EINVAL
;

56 
tÙ®_Ën
 = 
´efix_Ën
 + 
Ën
 + 1;

57 ià(
li¡
 && 
tÙ®_Ën
 <ğ
li¡_size
) {

58 
	`memıy
(
li¡
, 
´efix
, 
´efix_Ën
);

59 
	`memıy
(
li¡
 + 
´efix_Ën
, 
Çme
, 
Ën
);

60 
li¡
[
´efix_Ën
 + 
Ën
] = '\0';

62  
tÙ®_Ën
;

63 
	}
}

65 
	$f2fs_x©Œ_g’”ic_g‘
(
d’Œy
 *d’Œy, cÚ¡ *
Çme
,

66 *
bufãr
, 
size_t
 
size
, 
ty³
)

68 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
d’Œy
->
d_sb
);

70 
ty³
) {

71 
F2FS_XATTR_INDEX_USER
:

72 ià(!
	`‹¡_İt
(
sbi
, 
XATTR_USER
))

73  -
EOPNOTSUPP
;

75 
F2FS_XATTR_INDEX_TRUSTED
:

76 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

77  -
EPERM
;

79 
F2FS_XATTR_INDEX_SECURITY
:

82  -
EINVAL
;

84 ià(
	`¡rcmp
(
Çme
, "") == 0)

85  -
EINVAL
;

86  
	`f2fs_g‘x©Œ
(
d’Œy
->
d_šode
, 
ty³
, 
Çme
, 
bufãr
, 
size
);

87 
	}
}

89 
	$f2fs_x©Œ_g’”ic_£t
(
d’Œy
 *d’Œy, cÚ¡ *
Çme
,

90 cÚ¡ *
v®ue
, 
size_t
 
size
, 
æags
, 
ty³
)

92 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_SB
(
d’Œy
->
d_sb
);

94 
ty³
) {

95 
F2FS_XATTR_INDEX_USER
:

96 ià(!
	`‹¡_İt
(
sbi
, 
XATTR_USER
))

97  -
EOPNOTSUPP
;

99 
F2FS_XATTR_INDEX_TRUSTED
:

100 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

101  -
EPERM
;

103 
F2FS_XATTR_INDEX_SECURITY
:

106  -
EINVAL
;

108 ià(
	`¡rcmp
(
Çme
, "") == 0)

109  -
EINVAL
;

111  
	`f2fs_£tx©Œ
(
d’Œy
->
d_šode
, 
ty³
, 
Çme
,

112 
v®ue
, 
size
, 
NULL
, 
æags
);

113 
	}
}

115 
size_t
 
	$f2fs_x©Œ_advi£_li¡
(
d’Œy
 *d’Œy, *
li¡
,

116 
size_t
 
li¡_size
, cÚ¡ *
Çme
, size_ˆ
Ën
, 
ty³
)

118 cÚ¡ *
xÇme
 = 
F2FS_SYSTEM_ADVISE_PREFIX
;

119 
size_t
 
size
;

121 ià(
ty³
 !ğ
F2FS_XATTR_INDEX_ADVISE
)

124 
size
 = 
	`¡¾’
(
xÇme
) + 1;

125 ià(
li¡
 && 
size
 <ğ
li¡_size
)

126 
	`memıy
(
li¡
, 
xÇme
, 
size
);

127  
size
;

128 
	}
}

130 
	$f2fs_x©Œ_advi£_g‘
(
d’Œy
 *d’Œy, cÚ¡ *
Çme
,

131 *
bufãr
, 
size_t
 
size
, 
ty³
)

133 
šode
 *šodğ
d’Œy
->
d_šode
;

135 ià(
	`¡rcmp
(
Çme
, "") != 0)

136  -
EINVAL
;

138 *((*)
bufãr
èğ
	`F2FS_I
(
šode
)->
i_advi£
;

140 
	}
}

142 
	$f2fs_x©Œ_advi£_£t
(
d’Œy
 *d’Œy, cÚ¡ *
Çme
,

143 cÚ¡ *
v®ue
, 
size_t
 
size
, 
æags
, 
ty³
)

145 
šode
 *šodğ
d’Œy
->
d_šode
;

147 ià(
	`¡rcmp
(
Çme
, "") != 0)

148  -
EINVAL
;

149 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

150  -
EPERM
;

151 ià(
v®ue
 =ğ
NULL
)

152  -
EINVAL
;

154 
	`F2FS_I
(
šode
)->
i_advi£
 |ğ*(*)
v®ue
;

156 
	}
}

158 #ifdeà
CONFIG_F2FS_FS_SECURITY


159 
	$f2fs_š™x©Œs
(
šode
 *šode, cÚ¡ 
x©Œ
 *
x©Œ_¬¿y
,

160 *
·ge
)

162 cÚ¡ 
x©Œ
 *xattr;

163 
”r
 = 0;

165 
x©Œ
 = 
x©Œ_¬¿y
; x©Œ->
Çme
 !ğ
NULL
; xattr++) {

166 
”r
 = 
	`f2fs_£tx©Œ
(
šode
, 
F2FS_XATTR_INDEX_SECURITY
,

167 
x©Œ
->
Çme
, x©Œ->
v®ue
,

168 
x©Œ
->
v®ue_Ën
, (
·ge
 *)page, 0);

169 ià(
”r
 < 0)

172  
”r
;

173 
	}
}

175 
	$f2fs_š™_£cur™y
(
šode
 *šode, šod*
dœ
,

176 cÚ¡ 
q¡r
 *q¡r, 
·ge
 *
age
)

178  
	`£cur™y_šode_š™_£cur™y
(
šode
, 
dœ
, 
q¡r
,

179 &
f2fs_š™x©Œs
, 
age
);

180 
	}
}

183 cÚ¡ 
x©Œ_hªdËr
 
	gf2fs_x©Œ_u£r_hªdËr
 = {

184 .
´efix
 = 
XATTR_USER_PREFIX
,

185 .
	gæags
 = 
F2FS_XATTR_INDEX_USER
,

186 .
	gli¡
 = 
f2fs_x©Œ_g’”ic_li¡
,

187 .
	gg‘
 = 
f2fs_x©Œ_g’”ic_g‘
,

188 .
	g£t
 = 
f2fs_x©Œ_g’”ic_£t
,

191 cÚ¡ 
x©Œ_hªdËr
 
	gf2fs_x©Œ_Œu¡ed_hªdËr
 = {

192 .
´efix
 = 
XATTR_TRUSTED_PREFIX
,

193 .
	gæags
 = 
F2FS_XATTR_INDEX_TRUSTED
,

194 .
	gli¡
 = 
f2fs_x©Œ_g’”ic_li¡
,

195 .
	gg‘
 = 
f2fs_x©Œ_g’”ic_g‘
,

196 .
	g£t
 = 
f2fs_x©Œ_g’”ic_£t
,

199 cÚ¡ 
x©Œ_hªdËr
 
	gf2fs_x©Œ_advi£_hªdËr
 = {

200 .
´efix
 = 
F2FS_SYSTEM_ADVISE_PREFIX
,

201 .
	gæags
 = 
F2FS_XATTR_INDEX_ADVISE
,

202 .
	gli¡
 = 
f2fs_x©Œ_advi£_li¡
,

203 .
	gg‘
 = 
f2fs_x©Œ_advi£_g‘
,

204 .
	g£t
 = 
f2fs_x©Œ_advi£_£t
,

207 cÚ¡ 
x©Œ_hªdËr
 
	gf2fs_x©Œ_£cur™y_hªdËr
 = {

208 .
´efix
 = 
XATTR_SECURITY_PREFIX
,

209 .
	gæags
 = 
F2FS_XATTR_INDEX_SECURITY
,

210 .
	gli¡
 = 
f2fs_x©Œ_g’”ic_li¡
,

211 .
	gg‘
 = 
f2fs_x©Œ_g’”ic_g‘
,

212 .
	g£t
 = 
f2fs_x©Œ_g’”ic_£t
,

215 cÚ¡ 
x©Œ_hªdËr
 *
	gf2fs_x©Œ_hªdËr_m­
[] = {

216 [
F2FS_XATTR_INDEX_USER
] = &
f2fs_x©Œ_u£r_hªdËr
,

217 #ifdeà
CONFIG_F2FS_FS_POSIX_ACL


218 [
F2FS_XATTR_INDEX_POSIX_ACL_ACCESS
] = &
posix_aş_acûss_x©Œ_hªdËr
,

219 [
F2FS_XATTR_INDEX_POSIX_ACL_DEFAULT
] = &
posix_aş_deçuÉ_x©Œ_hªdËr
,

221 [
F2FS_XATTR_INDEX_TRUSTED
] = &
f2fs_x©Œ_Œu¡ed_hªdËr
,

222 #ifdeà
CONFIG_F2FS_FS_SECURITY


223 [
F2FS_XATTR_INDEX_SECURITY
] = &
f2fs_x©Œ_£cur™y_hªdËr
,

225 [
F2FS_XATTR_INDEX_ADVISE
] = &
f2fs_x©Œ_advi£_hªdËr
,

228 cÚ¡ 
x©Œ_hªdËr
 *
	gf2fs_x©Œ_hªdËrs
[] = {

229 &
f2fs_x©Œ_u£r_hªdËr
,

230 #ifdeà
CONFIG_F2FS_FS_POSIX_ACL


231 &
posix_aş_acûss_x©Œ_hªdËr
,

232 &
posix_aş_deçuÉ_x©Œ_hªdËr
,

234 &
f2fs_x©Œ_Œu¡ed_hªdËr
,

235 #ifdeà
CONFIG_F2FS_FS_SECURITY


236 &
f2fs_x©Œ_£cur™y_hªdËr
,

238 &
f2fs_x©Œ_advi£_hªdËr
,

239 
NULL
,

242 
šlše
 cÚ¡ 
x©Œ_hªdËr
 *
	$f2fs_x©Œ_hªdËr
(
šdex
)

244 cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
 = 
NULL
;

246 ià(
šdex
 > 0 && index < 
	`ARRAY_SIZE
(
f2fs_x©Œ_hªdËr_m­
))

247 
hªdËr
 = 
f2fs_x©Œ_hªdËr_m­
[
šdex
];

248  
hªdËr
;

249 
	}
}

251 
f2fs_x©Œ_’Œy
 *
	$__fšd_x©Œ
(*
ba£_addr
, 
šdex
,

252 
size_t
 
Ën
, cÚ¡ *
Çme
)

254 
f2fs_x©Œ_’Œy
 *
’Œy
;

256 
	`li¡_fÜ_—ch_x©Œ
(
’Œy
, 
ba£_addr
) {

257 ià(
’Œy
->
e_Çme_šdex
 !ğ
šdex
)

259 ià(
’Œy
->
e_Çme_Ën
 !ğ
Ën
)

261 ià(!
	`memcmp
(
’Œy
->
e_Çme
, 
Çme
, 
Ën
))

264  
’Œy
;

265 
	}
}

267 *
	$»ad_®l_x©Œs
(
šode
 *šode, 
·ge
 *
age
)

269 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

270 
f2fs_x©Œ_h—d”
 *
h—d”
;

271 
size_t
 
size
 = 
PAGE_SIZE
, 
šlše_size
 = 0;

272 *
tx©Œ_addr
;

274 
šlše_size
 = 
	`šlše_x©Œ_size
(
šode
);

276 
tx©Œ_addr
 = 
	`kz®loc
(
šlše_size
 + 
size
, 
GFP_F2FS_ZERO
);

277 ià(!
tx©Œ_addr
)

278  
NULL
;

281 ià(
šlše_size
) {

282 
·ge
 *·gğ
NULL
;

283 *
šlše_addr
;

285 ià(
age
) {

286 
šlše_addr
 = 
	`šlše_x©Œ_addr
(
age
);

288 
·ge
 = 
	`g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

289 ià(
	`IS_ERR
(
·ge
))

290 
ç
;

291 
šlše_addr
 = 
	`šlše_x©Œ_addr
(
·ge
);

293 
	`memıy
(
tx©Œ_addr
, 
šlše_addr
, 
šlše_size
);

294 
	`f2fs_put_·ge
(
·ge
, 1);

298 ià(
	`F2FS_I
(
šode
)->
i_x©Œ_nid
) {

299 
·ge
 *
x·ge
;

300 *
x©Œ_addr
;

303 
x·ge
 = 
	`g‘_node_·ge
(
sbi
, 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
);

304 ià(
	`IS_ERR
(
x·ge
))

305 
ç
;

307 
x©Œ_addr
 = 
	`·ge_add»ss
(
x·ge
);

308 
	`memıy
(
tx©Œ_addr
 + 
šlše_size
, 
x©Œ_addr
, 
PAGE_SIZE
);

309 
	`f2fs_put_·ge
(
x·ge
, 1);

312 
h—d”
 = 
	`XATTR_HDR
(
tx©Œ_addr
);

315 ià(
	`Ë32_to_ıu
(
h—d”
->
h_magic
è!ğ
F2FS_XATTR_MAGIC
) {

316 
h—d”
->
h_magic
 = 
	`ıu_to_Ë32
(
F2FS_XATTR_MAGIC
);

317 
h—d”
->
h_»fcouÁ
 = 
	`ıu_to_Ë32
(1);

319  
tx©Œ_addr
;

320 
ç
:

321 
	`kzä“
(
tx©Œ_addr
);

322  
NULL
;

323 
	}
}

325 
šlše
 
	$wr™e_®l_x©Œs
(
šode
 *šode, 
__u32
 
hsize
,

326 *
tx©Œ_addr
, 
·ge
 *
age
)

328 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

329 
size_t
 
šlše_size
 = 0;

330 *
x©Œ_addr
;

331 
·ge
 *
x·ge
;

332 
nid_t
 
Ãw_nid
 = 0;

333 
”r
;

335 
šlše_size
 = 
	`šlše_x©Œ_size
(
šode
);

337 ià(
hsize
 > 
šlše_size
 && !
	`F2FS_I
(
šode
)->
i_x©Œ_nid
)

338 ià(!
	`®loc_nid
(
sbi
, &
Ãw_nid
))

339  -
ENOSPC
;

342 ià(
šlše_size
) {

343 
·ge
 *·gğ
NULL
;

344 *
šlše_addr
;

346 ià(
age
) {

347 
šlše_addr
 = 
	`šlše_x©Œ_addr
(
age
);

348 
	`f2fs_wa™_Ú_·ge_wr™eback
(
age
, 
NODE
);

350 
·ge
 = 
	`g‘_node_·ge
(
sbi
, 
šode
->
i_šo
);

351 ià(
	`IS_ERR
(
·ge
)) {

352 
	`®loc_nid_çed
(
sbi
, 
Ãw_nid
);

353  
	`PTR_ERR
(
·ge
);

355 
šlše_addr
 = 
	`šlše_x©Œ_addr
(
·ge
);

356 
	`f2fs_wa™_Ú_·ge_wr™eback
(
·ge
, 
NODE
);

358 
	`memıy
(
šlše_addr
, 
tx©Œ_addr
, 
šlše_size
);

359 
	`f2fs_put_·ge
(
·ge
, 1);

362 ià(
hsize
 <ğ
šlše_size
) {

363 
”r
 = 
	`Œunÿ‹_x©Œ_node
(
šode
, 
age
);

364 
	`®loc_nid_çed
(
sbi
, 
Ãw_nid
);

365  
”r
;

370 ià(
	`F2FS_I
(
šode
)->
i_x©Œ_nid
) {

371 
x·ge
 = 
	`g‘_node_·ge
(
sbi
, 
	`F2FS_I
(
šode
)->
i_x©Œ_nid
);

372 ià(
	`IS_ERR
(
x·ge
)) {

373 
	`®loc_nid_çed
(
sbi
, 
Ãw_nid
);

374  
	`PTR_ERR
(
x·ge
);

376 
	`f2fs_bug_Ú
(
sbi
, 
Ãw_nid
);

377 
	`f2fs_wa™_Ú_·ge_wr™eback
(
x·ge
, 
NODE
);

379 
dnode_of_d©a
 
dn
;

380 
	`£t_Ãw_dnode
(&
dn
, 
šode
, 
NULL
, NULL, 
Ãw_nid
);

381 
x·ge
 = 
	`Ãw_node_·ge
(&
dn
, 
XATTR_NODE_OFFSET
, 
age
);

382 ià(
	`IS_ERR
(
x·ge
)) {

383 
	`®loc_nid_çed
(
sbi
, 
Ãw_nid
);

384  
	`PTR_ERR
(
x·ge
);

386 
	`®loc_nid_dÚe
(
sbi
, 
Ãw_nid
);

389 
x©Œ_addr
 = 
	`·ge_add»ss
(
x·ge
);

390 
	`memıy
(
x©Œ_addr
, 
tx©Œ_addr
 + 
šlše_size
, 
PAGE_SIZE
 -

391 (
node_foÙ”
));

392 
	`£t_·ge_dœty
(
x·ge
);

393 
	`f2fs_put_·ge
(
x·ge
, 1);

396 
	`F2FS_I
(
šode
)->
x©Œ_v”
 = 
	`cur_ı_v”siÚ
(
	`F2FS_CKPT
(
sbi
));

398 
	}
}

400 
	$f2fs_g‘x©Œ
(
šode
 *šode, 
šdex
, cÚ¡ *
Çme
,

401 *
bufãr
, 
size_t
 
bufãr_size
)

403 
f2fs_x©Œ_’Œy
 *
’Œy
;

404 *
ba£_addr
;

405 
”rÜ
 = 0;

406 
size_t
 
size
, 
Ën
;

408 ià(
Çme
 =ğ
NULL
)

409  -
EINVAL
;

411 
Ën
 = 
	`¡¾’
(
Çme
);

412 ià(
Ën
 > 
F2FS_NAME_LEN
)

413  -
ERANGE
;

415 
ba£_addr
 = 
	`»ad_®l_x©Œs
(
šode
, 
NULL
);

416 ià(!
ba£_addr
)

417  -
ENOMEM
;

419 
’Œy
 = 
	`__fšd_x©Œ
(
ba£_addr
, 
šdex
, 
Ën
, 
Çme
);

420 ià(
	`IS_XATTR_LAST_ENTRY
(
’Œy
)) {

421 
”rÜ
 = -
ENODATA
;

422 
ş—nup
;

425 
size
 = 
	`Ë16_to_ıu
(
’Œy
->
e_v®ue_size
);

427 ià(
bufãr
 && 
size
 > 
bufãr_size
) {

428 
”rÜ
 = -
ERANGE
;

429 
ş—nup
;

432 ià(
bufãr
) {

433 *
pv®
 = 
’Œy
->
e_Çme
 +ƒÁry->
e_Çme_Ën
;

434 
	`memıy
(
bufãr
, 
pv®
, 
size
);

436 
”rÜ
 = 
size
;

438 
ş—nup
:

439 
	`kzä“
(
ba£_addr
);

440  
”rÜ
;

441 
	}
}

443 
ssize_t
 
	$f2fs_li¡x©Œ
(
d’Œy
 *d’Œy, *
bufãr
, 
size_t
 
bufãr_size
)

445 
šode
 *šodğ
d’Œy
->
d_šode
;

446 
f2fs_x©Œ_’Œy
 *
’Œy
;

447 *
ba£_addr
;

448 
”rÜ
 = 0;

449 
size_t
 
»¡
 = 
bufãr_size
;

451 
ba£_addr
 = 
	`»ad_®l_x©Œs
(
šode
, 
NULL
);

452 ià(!
ba£_addr
)

453  -
ENOMEM
;

455 
	`li¡_fÜ_—ch_x©Œ
(
’Œy
, 
ba£_addr
) {

456 cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
 =

457 
	`f2fs_x©Œ_hªdËr
(
’Œy
->
e_Çme_šdex
);

458 
size_t
 
size
;

460 ià(!
hªdËr
)

463 
size
 = 
hªdËr
->
	`li¡
(
d’Œy
, 
bufãr
, 
»¡
, 
’Œy
->
e_Çme
,

464 
’Œy
->
e_Çme_Ën
, 
hªdËr
->
æags
);

465 ià(
bufãr
 && 
size
 > 
»¡
) {

466 
”rÜ
 = -
ERANGE
;

467 
ş—nup
;

470 ià(
bufãr
)

471 
bufãr
 +ğ
size
;

472 
»¡
 -ğ
size
;

474 
”rÜ
 = 
bufãr_size
 - 
»¡
;

475 
ş—nup
:

476 
	`kzä“
(
ba£_addr
);

477  
”rÜ
;

478 
	}
}

480 
	$__f2fs_£tx©Œ
(
šode
 *šode, 
šdex
,

481 cÚ¡ *
Çme
, cÚ¡ *
v®ue
, 
size_t
 
size
,

482 
·ge
 *
age
, 
æags
)

484 
f2fs_šode_šfo
 *
fi
 = 
	`F2FS_I
(
šode
);

485 
f2fs_x©Œ_’Œy
 *
h”e
, *
Ï¡
;

486 *
ba£_addr
;

487 
found
, 
Ãwsize
;

488 
size_t
 
Ën
;

489 
__u32
 
Ãw_hsize
;

490 
”rÜ
 = -
ENOMEM
;

492 ià(
Çme
 =ğ
NULL
)

493  -
EINVAL
;

495 ià(
v®ue
 =ğ
NULL
)

496 
size
 = 0;

498 
Ën
 = 
	`¡¾’
(
Çme
);

500 ià(
Ën
 > 
F2FS_NAME_LEN
 || 
size
 > 
	`MAX_VALUE_LEN
(
šode
))

501  -
ERANGE
;

503 
ba£_addr
 = 
	`»ad_®l_x©Œs
(
šode
, 
age
);

504 ià(!
ba£_addr
)

505 
ex™
;

508 
h”e
 = 
	`__fšd_x©Œ
(
ba£_addr
, 
šdex
, 
Ën
, 
Çme
);

510 
found
 = 
	`IS_XATTR_LAST_ENTRY
(
h”e
) ? 0 : 1;

512 ià((
æags
 & 
XATTR_REPLACE
è&& !
found
) {

513 
”rÜ
 = -
ENODATA
;

514 
ex™
;

515 } ià((
æags
 & 
XATTR_CREATE
è&& 
found
) {

516 
”rÜ
 = -
EEXIST
;

517 
ex™
;

520 
Ï¡
 = 
h”e
;

521 !
	`IS_XATTR_LAST_ENTRY
(
Ï¡
))

522 
Ï¡
 = 
	`XATTR_NEXT_ENTRY
(last);

524 
Ãwsize
 = 
	`XATTR_ALIGN
((
f2fs_x©Œ_’Œy
è+ 
Ën
 + 
size
);

527 ià(
v®ue
) {

528 
ä“
;

533 
ä“
 = 
	`MIN_OFFSET
(
šode
è- ((*)
Ï¡
 - (*)
ba£_addr
);

534 ià(
found
)

535 
ä“
 = f»+ 
	`ENTRY_SIZE
(
h”e
);

537 ià(
	`uÆik–y
(
ä“
 < 
Ãwsize
)) {

538 
”rÜ
 = -
ENOSPC
;

539 
ex™
;

544 ià(
found
) {

549 
f2fs_x©Œ_’Œy
 *
Ãxt
 = 
	`XATTR_NEXT_ENTRY
(
h”e
);

550 
Şdsize
 = 
	`ENTRY_SIZE
(
h”e
);

552 
	`memmove
(
h”e
, 
Ãxt
, (*)
Ï¡
 - (*)next);

553 
Ï¡
 = (
f2fs_x©Œ_’Œy
 *)((*îa¡ - 
Şdsize
);

554 
	`mem£t
(
Ï¡
, 0, 
Şdsize
);

557 
Ãw_hsize
 = (*)
Ï¡
 - (*)
ba£_addr
;

560 ià(
v®ue
) {

561 *
pv®
;

566 
	`mem£t
(
Ï¡
, 0, 
Ãwsize
);

567 
Ï¡
->
e_Çme_šdex
 = 
šdex
;

568 
Ï¡
->
e_Çme_Ën
 = 
Ën
;

569 
	`memıy
(
Ï¡
->
e_Çme
, 
Çme
, 
Ën
);

570 
pv®
 = 
Ï¡
->
e_Çme
 + 
Ën
;

571 
	`memıy
(
pv®
, 
v®ue
, 
size
);

572 
Ï¡
->
e_v®ue_size
 = 
	`ıu_to_Ë16
(
size
);

573 
Ãw_hsize
 +ğ
Ãwsize
;

576 
”rÜ
 = 
	`wr™e_®l_x©Œs
(
šode
, 
Ãw_hsize
, 
ba£_addr
, 
age
);

577 ià(
”rÜ
)

578 
ex™
;

580 ià(
	`is_šode_æag_£t
(
fi
, 
FI_ACL_MODE
)) {

581 
šode
->
i_mode
 = 
fi
->
i_aş_mode
;

582 
šode
->
i_ùime
 = 
CURRENT_TIME
;

583 
	`ş—r_šode_æag
(
fi
, 
FI_ACL_MODE
);

586 ià(
age
)

587 
	`upd©e_šode
(
šode
, 
age
);

589 
	`upd©e_šode_·ge
(
šode
);

590 
ex™
:

591 
	`kzä“
(
ba£_addr
);

592  
”rÜ
;

593 
	}
}

595 
	$f2fs_£tx©Œ
(
šode
 *šode, 
šdex
, cÚ¡ *
Çme
,

596 cÚ¡ *
v®ue
, 
size_t
 
size
,

597 
·ge
 *
age
, 
æags
)

599 
f2fs_sb_šfo
 *
sbi
 = 
	`F2FS_I_SB
(
šode
);

600 
”r
;

603 ià(
age
)

604  
	`__f2fs_£tx©Œ
(
šode
, 
šdex
, 
Çme
, 
v®ue
,

605 
size
, 
age
, 
æags
);

606 
	`f2fs_b®ªû_fs
(
sbi
);

608 
	`f2fs_lock_İ
(
sbi
);

610 
	`down_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

611 
”r
 = 
	`__f2fs_£tx©Œ
(
šode
, 
šdex
, 
Çme
, 
v®ue
, 
size
, 
age
, 
æags
);

612 
	`up_wr™e
(&
	`F2FS_I
(
šode
)->
i_£m
);

613 
	`f2fs_uÆock_İ
(
sbi
);

615  
”r
;

616 
	}
}

	@xattr.h

17 #iâdeà
__F2FS_XATTR_H__


18 
	#__F2FS_XATTR_H__


	)

20 
	~<lšux/š™.h
>

21 
	~<lšux/x©Œ.h
>

24 
	#F2FS_XATTR_MAGIC
 0xF2F52011

	)

27 
	#F2FS_XATTR_REFCOUNT_MAX
 1024

	)

30 
	#F2FS_SYSTEM_ADVISE_PREFIX
 "sy¡em.advi£"

	)

31 
	#F2FS_XATTR_INDEX_USER
 1

	)

32 
	#F2FS_XATTR_INDEX_POSIX_ACL_ACCESS
 2

	)

33 
	#F2FS_XATTR_INDEX_POSIX_ACL_DEFAULT
 3

	)

34 
	#F2FS_XATTR_INDEX_TRUSTED
 4

	)

35 
	#F2FS_XATTR_INDEX_LUSTRE
 5

	)

36 
	#F2FS_XATTR_INDEX_SECURITY
 6

	)

37 
	#F2FS_XATTR_INDEX_ADVISE
 7

	)

39 
	sf2fs_x©Œ_h—d”
 {

40 
__Ë32
 
	mh_magic
;

41 
__Ë32
 
	mh_»fcouÁ
;

42 
__u32
 
	mh_»£rved
[4];

45 
	sf2fs_x©Œ_’Œy
 {

46 
__u8
 
	me_Çme_šdex
;

47 
__u8
 
	me_Çme_Ën
;

48 
__Ë16
 
	me_v®ue_size
;

49 
	me_Çme
[0];

52 
	#XATTR_HDR
(
±r
è((
f2fs_x©Œ_h—d”
 *)ÕŒ))

	)

53 
	#XATTR_ENTRY
(
±r
è((
f2fs_x©Œ_’Œy
 *)ÕŒ))

	)

54 
	#XATTR_FIRST_ENTRY
(
±r
è(
	`XATTR_ENTRY
(
	`XATTR_HDR
ÕŒè+ 1))

	)

55 
	#XATTR_ROUND
 (3)

	)

57 
	#XATTR_ALIGN
(
size
è((siz+ 
XATTR_ROUND
è& ~XATTR_ROUND)

	)

59 
	#ENTRY_SIZE
(
’Œy
è(
	`XATTR_ALIGN
((
f2fs_x©Œ_’Œy
) + \

60 
’Œy
->
e_Çme_Ën
 + 
	`Ë16_to_ıu
ÓÁry->
e_v®ue_size
)))

	)

62 
	#XATTR_NEXT_ENTRY
(
’Œy
è((
f2fs_x©Œ_’Œy
 *)((*)(entry) +\

63 
	`ENTRY_SIZE
(
’Œy
)))

	)

65 
	#IS_XATTR_LAST_ENTRY
(
’Œy
è(*(
__u32
 *)ÓÁryè=ğ0)

	)

67 
	#li¡_fÜ_—ch_x©Œ
(
’Œy
, 
addr
) \

68 
’Œy
 = 
	`XATTR_FIRST_ENTRY
(
addr
);\

69 !
	`IS_XATTR_LAST_ENTRY
(
’Œy
);\

70 
’Œy
 = 
	`XATTR_NEXT_ENTRY
ÓÁry))

	)

72 
	#MIN_OFFSET
(
i
è
	`XATTR_ALIGN
(
	`šlše_x©Œ_size
(iè+ 
PAGE_SIZE
 - \

73 (
node_foÙ”
è- (
__u32
))

	)

75 
	#MAX_VALUE_LEN
(
i
è(
	`MIN_OFFSET
(i) - \

76 (
f2fs_x©Œ_h—d”
) - \

77 (
f2fs_x©Œ_’Œy
))

	)

108 #ifdeà
CONFIG_F2FS_FS_XATTR


109 cÚ¡ 
x©Œ_hªdËr
 
f2fs_x©Œ_u£r_hªdËr
;

110 cÚ¡ 
x©Œ_hªdËr
 
f2fs_x©Œ_Œu¡ed_hªdËr
;

111 cÚ¡ 
x©Œ_hªdËr
 
f2fs_x©Œ_advi£_hªdËr
;

112 cÚ¡ 
x©Œ_hªdËr
 
f2fs_x©Œ_£cur™y_hªdËr
;

114 cÚ¡ 
x©Œ_hªdËr
 *
f2fs_x©Œ_hªdËrs
[];

116 
f2fs_£tx©Œ
(
šode
 *, , const *,

117 cÚ¡ *, 
size_t
, 
·ge
 *, );

118 
f2fs_g‘x©Œ
(
šode
 *, , cÚ¡ *, *, 
size_t
);

119 
ssize_t
 
f2fs_li¡x©Œ
(
d’Œy
 *, *, 
size_t
);

122 
	#f2fs_x©Œ_hªdËrs
 
NULL


	)

123 
šlše
 
	$f2fs_£tx©Œ
(
šode
 *šode, 
šdex
,

124 cÚ¡ *
Çme
, cÚ¡ *
v®ue
, 
size_t
 
size
, 
æags
)

126  -
EOPNOTSUPP
;

127 
	}
}

128 
šlše
 
	$f2fs_g‘x©Œ
(
šode
 *šode, 
šdex
,

129 cÚ¡ *
Çme
, *
bufãr
, 
size_t
 
bufãr_size
)

131  -
EOPNOTSUPP
;

132 
	}
}

133 
šlše
 
ssize_t
 
	$f2fs_li¡x©Œ
(
d’Œy
 *d’Œy, *
bufãr
,

134 
size_t
 
bufãr_size
)

136  -
EOPNOTSUPP
;

137 
	}
}

140 #ifdeà
CONFIG_F2FS_FS_SECURITY


141 
f2fs_š™_£cur™y
(
šode
 *, inode *,

142 cÚ¡ 
q¡r
 *, 
·ge
 *);

144 
šlše
 
	$f2fs_š™_£cur™y
(
šode
 *šode, šod*
dœ
,

145 cÚ¡ 
q¡r
 *q¡r, 
·ge
 *
age
)

148 
	}
}

	@/usr/include/linux/falloc.h

1 #iâdeà
_FALLOC_H_


2 
	#_FALLOC_H_


	)

4 
	#FALLOC_FL_KEEP_SIZE
 0x01

	)

5 
	#FALLOC_FL_PUNCH_HOLE
 0x02

	)

6 
	#FALLOC_FL_NO_HIDE_STALE
 0x04

	)

	@/usr/include/linux/fs.h

1 #iâdeà
_LINUX_FS_H


2 
	#_LINUX_FS_H


	)

9 
	~<lšux/lim™s.h
>

10 
	~<lšux/ioùl.h
>

11 
	~<lšux/ty³s.h
>

24 #undeà
NR_OPEN


25 
	#INR_OPEN_CUR
 1024

	)

26 
	#INR_OPEN_MAX
 4096

	)

28 
	#BLOCK_SIZE_BITS
 10

	)

29 
	#BLOCK_SIZE
 (1<<
BLOCK_SIZE_BITS
)

	)

31 
	#SEEK_SET
 0

	)

32 
	#SEEK_CUR
 1

	)

33 
	#SEEK_END
 2

	)

34 
	#SEEK_DATA
 3

	)

35 
	#SEEK_HOLE
 4

	)

36 
	#SEEK_MAX
 
SEEK_HOLE


	)

38 
	sf¡rim_¿nge
 {

39 
__u64
 
	m¡¬t
;

40 
__u64
 
	mËn
;

41 
__u64
 
	mmšËn
;

45 
	sfes_¡©_¡ruù
 {

46 
	mÄ_fes
;

47 
	mÄ_ä“_fes
;

48 
	mmax_fes
;

51 
	sšodes_¡©_t
 {

52 
	mÄ_šodes
;

53 
	mÄ_unu£d
;

54 
	mdummy
[5];

58 
	#NR_FILE
 8192

	)

64 
	#MS_RDONLY
 1

	)

65 
	#MS_NOSUID
 2

	)

66 
	#MS_NODEV
 4

	)

67 
	#MS_NOEXEC
 8

	)

68 
	#MS_SYNCHRONOUS
 16

	)

69 
	#MS_REMOUNT
 32

	)

70 
	#MS_MANDLOCK
 64

	)

71 
	#MS_DIRSYNC
 128

	)

72 
	#MS_NOATIME
 1024

	)

73 
	#MS_NODIRATIME
 2048

	)

74 
	#MS_BIND
 4096

	)

75 
	#MS_MOVE
 8192

	)

76 
	#MS_REC
 16384

	)

77 
	#MS_VERBOSE
 32768

	)

79 
	#MS_SILENT
 32768

	)

80 
	#MS_POSIXACL
 (1<<16è

	)

81 
	#MS_UNBINDABLE
 (1<<17è

	)

82 
	#MS_PRIVATE
 (1<<18è

	)

83 
	#MS_SLAVE
 (1<<19è

	)

84 
	#MS_SHARED
 (1<<20è

	)

85 
	#MS_RELATIME
 (1<<21è

	)

86 
	#MS_KERNMOUNT
 (1<<22è

	)

87 
	#MS_I_VERSION
 (1<<23è

	)

88 
	#MS_STRICTATIME
 (1<<24è

	)

91 
	#MS_NOSEC
 (1<<28)

	)

92 
	#MS_BORN
 (1<<29)

	)

93 
	#MS_ACTIVE
 (1<<30)

	)

94 
	#MS_NOUSER
 (1<<31)

	)

99 
	#MS_RMT_MASK
 (
MS_RDONLY
|
MS_SYNCHRONOUS
|
MS_MANDLOCK
|
MS_I_VERSION
)

	)

104 
	#MS_MGC_VAL
 0xC0ED0000

	)

105 
	#MS_MGC_MSK
 0xffff0000

	)

110 
	#BLKROSET
 
	`_IO
(0x12,93è

	)

111 
	#BLKROGET
 
	`_IO
(0x12,94è

	)

112 
	#BLKRRPART
 
	`_IO
(0x12,95è

	)

113 
	#BLKGETSIZE
 
	`_IO
(0x12,96è

	)

114 
	#BLKFLSBUF
 
	`_IO
(0x12,97è

	)

115 
	#BLKRASET
 
	`_IO
(0x12,98è

	)

116 
	#BLKRAGET
 
	`_IO
(0x12,99è

	)

117 
	#BLKFRASET
 
	`_IO
(0x12,100)

	)

118 
	#BLKFRAGET
 
	`_IO
(0x12,101)

	)

119 
	#BLKSECTSET
 
	`_IO
(0x12,102)

	)

120 
	#BLKSECTGET
 
	`_IO
(0x12,103)

	)

121 
	#BLKSSZGET
 
	`_IO
(0x12,104)

	)

123 
	#BLKPG
 
	`_IO
(0x12,105)

	)

127 
	#BLKELVGET
 
	`_IOR
(0x12,106,
size_t
)

	)

128 
	#BLKELVSET
 
	`_IOW
(0x12,107,
size_t
)

	)

133 
	#BLKBSZGET
 
	`_IOR
(0x12,112,
size_t
)

	)

134 
	#BLKBSZSET
 
	`_IOW
(0x12,113,
size_t
)

	)

135 
	#BLKGETSIZE64
 
	`_IOR
(0x12,114,
size_t
è

	)

136 
	#BLKTRACESETUP
 
	`_IOWR
(0x12,115,
blk_u£r_Œaû_£tup
)

	)

137 
	#BLKTRACESTART
 
	`_IO
(0x12,116)

	)

138 
	#BLKTRACESTOP
 
	`_IO
(0x12,117)

	)

139 
	#BLKTRACETEARDOWN
 
	`_IO
(0x12,118)

	)

140 
	#BLKDISCARD
 
	`_IO
(0x12,119)

	)

141 
	#BLKIOMIN
 
	`_IO
(0x12,120)

	)

142 
	#BLKIOOPT
 
	`_IO
(0x12,121)

	)

143 
	#BLKALIGNOFF
 
	`_IO
(0x12,122)

	)

144 
	#BLKPBSZGET
 
	`_IO
(0x12,123)

	)

145 
	#BLKDISCARDZEROES
 
	`_IO
(0x12,124)

	)

146 
	#BLKSECDISCARD
 
	`_IO
(0x12,125)

	)

147 
	#BLKROTATIONAL
 
	`_IO
(0x12,126)

	)

148 
	#BLKZEROOUT
 
	`_IO
(0x12,127)

	)

150 
	#BMAP_IOCTL
 1

	)

151 
	#FIBMAP
 
	`_IO
(0x00,1è

	)

152 
	#FIGETBSZ
 
	`_IO
(0x00,2è

	)

153 
	#FIFREEZE
 
	`_IOWR
('X', 119, è

	)

154 
	#FITHAW
 
	`_IOWR
('X', 120, è

	)

155 
	#FITRIM
 
	`_IOWR
('X', 121, 
f¡rim_¿nge
è

	)

157 
	#FS_IOC_GETFLAGS
 
	`_IOR
('f', 1, )

	)

158 
	#FS_IOC_SETFLAGS
 
	`_IOW
('f', 2, )

	)

159 
	#FS_IOC_GETVERSION
 
	`_IOR
('v', 1, )

	)

160 
	#FS_IOC_SETVERSION
 
	`_IOW
('v', 2, )

	)

161 
	#FS_IOC_FIEMAP
 
	`_IOWR
('f', 11, 
f›m­
)

	)

162 
	#FS_IOC32_GETFLAGS
 
	`_IOR
('f', 1, )

	)

163 
	#FS_IOC32_SETFLAGS
 
	`_IOW
('f', 2, )

	)

164 
	#FS_IOC32_GETVERSION
 
	`_IOR
('v', 1, )

	)

165 
	#FS_IOC32_SETVERSION
 
	`_IOW
('v', 2, )

	)

170 
	#FS_SECRM_FL
 0x00000001

	)

171 
	#FS_UNRM_FL
 0x00000002

	)

172 
	#FS_COMPR_FL
 0x00000004

	)

173 
	#FS_SYNC_FL
 0x00000008

	)

174 
	#FS_IMMUTABLE_FL
 0x00000010

	)

175 
	#FS_APPEND_FL
 0x00000020

	)

176 
	#FS_NODUMP_FL
 0x00000040

	)

177 
	#FS_NOATIME_FL
 0x00000080

	)

179 
	#FS_DIRTY_FL
 0x00000100

	)

180 
	#FS_COMPRBLK_FL
 0x00000200

	)

181 
	#FS_NOCOMP_FL
 0x00000400

	)

182 
	#FS_ECOMPR_FL
 0x00000800

	)

184 
	#FS_BTREE_FL
 0x00001000

	)

185 
	#FS_INDEX_FL
 0x00001000

	)

186 
	#FS_IMAGIC_FL
 0x00002000

	)

187 
	#FS_JOURNAL_DATA_FL
 0x00004000

	)

188 
	#FS_NOTAIL_FL
 0x00008000

	)

189 
	#FS_DIRSYNC_FL
 0x00010000

	)

190 
	#FS_TOPDIR_FL
 0x00020000

	)

191 
	#FS_EXTENT_FL
 0x00080000

	)

192 
	#FS_DIRECTIO_FL
 0x00100000

	)

193 
	#FS_NOCOW_FL
 0x00800000

	)

194 
	#FS_RESERVED_FL
 0x80000000

	)

196 
	#FS_FL_USER_VISIBLE
 0x0003DFFF

	)

197 
	#FS_FL_USER_MODIFIABLE
 0x000380FF

	)

200 
	#SYNC_FILE_RANGE_WAIT_BEFORE
 1

	)

201 
	#SYNC_FILE_RANGE_WRITE
 2

	)

202 
	#SYNC_FILE_RANGE_WAIT_AFTER
 4

	)

	@/usr/include/linux/magic.h

1 #iâdeà
__LINUX_MAGIC_H__


2 
	#__LINUX_MAGIC_H__


	)

4 
	#ADFS_SUPER_MAGIC
 0xadf5

	)

5 
	#AFFS_SUPER_MAGIC
 0xadff

	)

6 
	#AFS_SUPER_MAGIC
 0x5346414F

	)

7 
	#AUTOFS_SUPER_MAGIC
 0x0187

	)

8 
	#CODA_SUPER_MAGIC
 0x73757245

	)

9 
	#CRAMFS_MAGIC
 0x28cd3d45

	)

10 
	#CRAMFS_MAGIC_WEND
 0x453dcd28

	)

11 
	#DEBUGFS_MAGIC
 0x64626720

	)

12 
	#SECURITYFS_MAGIC
 0x73636673

	)

13 
	#SELINUX_MAGIC
 0xf97cff8c

	)

14 
	#SMACK_MAGIC
 0x43415d53

	)

15 
	#RAMFS_MAGIC
 0x858458f6

	)

16 
	#TMPFS_MAGIC
 0x01021994

	)

17 
	#HUGETLBFS_MAGIC
 0x958458f6

	)

18 
	#SQUASHFS_MAGIC
 0x73717368

	)

19 
	#ECRYPTFS_SUPER_MAGIC
 0xf15f

	)

20 
	#EFS_SUPER_MAGIC
 0x414A53

	)

21 
	#EXT2_SUPER_MAGIC
 0xEF53

	)

22 
	#EXT3_SUPER_MAGIC
 0xEF53

	)

23 
	#XENFS_SUPER_MAGIC
 0xabba1974

	)

24 
	#EXT4_SUPER_MAGIC
 0xEF53

	)

25 
	#BTRFS_SUPER_MAGIC
 0x9123683E

	)

26 
	#NILFS_SUPER_MAGIC
 0x3434

	)

27 
	#F2FS_SUPER_MAGIC
 0xF2F52010

	)

28 
	#HPFS_SUPER_MAGIC
 0xf995e849

	)

29 
	#ISOFS_SUPER_MAGIC
 0x9660

	)

30 
	#JFFS2_SUPER_MAGIC
 0x72b6

	)

31 
	#PSTOREFS_MAGIC
 0x6165676C

	)

32 
	#EFIVARFS_MAGIC
 0xde5e81e4

	)

33 
	#HOSTFS_SUPER_MAGIC
 0x00c0fãe

	)

35 
	#MINIX_SUPER_MAGIC
 0x137F

	)

36 
	#MINIX_SUPER_MAGIC2
 0x138F

	)

37 
	#MINIX2_SUPER_MAGIC
 0x2468

	)

38 
	#MINIX2_SUPER_MAGIC2
 0x2478

	)

39 
	#MINIX3_SUPER_MAGIC
 0x4d5¨

	)

41 
	#MSDOS_SUPER_MAGIC
 0x4d44

	)

42 
	#NCP_SUPER_MAGIC
 0x564ø

	)

43 
	#NFS_SUPER_MAGIC
 0x6969

	)

44 
	#OPENPROM_SUPER_MAGIC
 0x9ç1

	)

45 
	#QNX4_SUPER_MAGIC
 0x002à

	)

46 
	#QNX6_SUPER_MAGIC
 0x68191122

	)

48 
	#REISERFS_SUPER_MAGIC
 0x52654973

	)

51 
	#REISERFS_SUPER_MAGIC_STRING
 "ReIsErFs"

	)

52 
	#REISER2FS_SUPER_MAGIC_STRING
 "ReIsEr2Fs"

	)

53 
	#REISER2FS_JR_SUPER_MAGIC_STRING
 "ReIsEr3Fs"

	)

55 
	#SMB_SUPER_MAGIC
 0x517B

	)

56 
	#CGROUP_SUPER_MAGIC
 0x27e0eb

	)

59 
	#STACK_END_MAGIC
 0x57AC6E9D

	)

61 
	#V9FS_MAGIC
 0x01021997

	)

63 
	#BDEVFS_MAGIC
 0x62646576

	)

64 
	#BINFMTFS_MAGIC
 0x42494e4d

	)

65 
	#DEVPTS_SUPER_MAGIC
 0x1cd1

	)

66 
	#FUTEXFS_SUPER_MAGIC
 0xBAD1DEA

	)

67 
	#PIPEFS_MAGIC
 0x50495045

	)

68 
	#PROC_SUPER_MAGIC
 0x9ç0

	)

69 
	#SOCKFS_MAGIC
 0x534F434B

	)

70 
	#SYSFS_MAGIC
 0x62656572

	)

71 
	#USBDEVICE_SUPER_MAGIC
 0x9ç2

	)

72 
	#MTD_INODE_FS_MAGIC
 0x11307854

	)

73 
	#ANON_INODE_FS_MAGIC
 0x09041934

	)

74 
	#BTRFS_TEST_MAGIC
 0x73727279

	)

	@/usr/include/linux/random.h

7 #iâdeà
_LINUX_RANDOM_H


8 
	#_LINUX_RANDOM_H


	)

10 
	~<lšux/ty³s.h
>

11 
	~<lšux/ioùl.h
>

12 
	~<lšux/œqÄ.h
>

17 
	#RNDGETENTCNT
 
	`_IOR
Ğ'R', 0x00, )

	)

20 
	#RNDADDTOENTCNT
 
	`_IOW
Ğ'R', 0x01, )

	)

23 
	#RNDGETPOOL
 
	`_IOR
Ğ'R', 0x02, [2] )

	)

29 
	#RNDADDENTROPY
 
	`_IOW
Ğ'R', 0x03, [2] )

	)

32 
	#RNDZAPENTCNT
 
	`_IO
Ğ'R', 0x04 )

	)

35 
	#RNDCLEARPOOL
 
	`_IO
Ğ'R', 0x06 )

	)

37 
	s¿nd_poŞ_šfo
 {

38 
	m’Œİy_couÁ
;

39 
	mbuf_size
;

40 
__u32
 
	mbuf
[0];

	@/usr/include/linux/sched.h

1 #iâdeà
_LINUX_SCHED_H


2 
	#_LINUX_SCHED_H


	)

7 
	#CSIGNAL
 0x000000fà

	)

8 
	#CLONE_VM
 0x00000100

	)

9 
	#CLONE_FS
 0x00000200

	)

10 
	#CLONE_FILES
 0x00000400

	)

11 
	#CLONE_SIGHAND
 0x00000800

	)

12 
	#CLONE_PTRACE
 0x00002000

	)

13 
	#CLONE_VFORK
 0x00004000

	)

14 
	#CLONE_PARENT
 0x00008000

	)

15 
	#CLONE_THREAD
 0x00010000

	)

16 
	#CLONE_NEWNS
 0x00020000

	)

17 
	#CLONE_SYSVSEM
 0x00040000

	)

18 
	#CLONE_SETTLS
 0x00080000

	)

19 
	#CLONE_PARENT_SETTID
 0x00100000

	)

20 
	#CLONE_CHILD_CLEARTID
 0x00200000

	)

21 
	#CLONE_DETACHED
 0x00400000

	)

22 
	#CLONE_UNTRACED
 0x00800000

	)

23 
	#CLONE_CHILD_SETTID
 0x01000000

	)

26 
	#CLONE_NEWUTS
 0x04000000

	)

27 
	#CLONE_NEWIPC
 0x08000000

	)

28 
	#CLONE_NEWUSER
 0x10000000

	)

29 
	#CLONE_NEWPID
 0x20000000

	)

30 
	#CLONE_NEWNET
 0x40000000

	)

31 
	#CLONE_IO
 0x80000000

	)

36 
	#SCHED_NORMAL
 0

	)

37 
	#SCHED_FIFO
 1

	)

38 
	#SCHED_RR
 2

	)

39 
	#SCHED_BATCH
 3

	)

41 
	#SCHED_IDLE
 5

	)

43 
	#SCHED_RESET_ON_FORK
 0x40000000

	)

	@/usr/include/linux/stat.h

1 #iâdeà
_LINUX_STAT_H


2 
	#_LINUX_STAT_H


	)

5 #ià
defšed
(
__KERNEL__
è|| !defšed(
__GLIBC__
) || (__GLIBC__ < 2)

7 
	#S_IFMT
 00170000

	)

8 
	#S_IFSOCK
 0140000

	)

9 
	#S_IFLNK
 0120000

	)

10 
	#S_IFREG
 0100000

	)

11 
	#S_IFBLK
 0060000

	)

12 
	#S_IFDIR
 0040000

	)

13 
	#S_IFCHR
 0020000

	)

14 
	#S_IFIFO
 0010000

	)

15 
	#S_ISUID
 0004000

	)

16 
	#S_ISGID
 0002000

	)

17 
	#S_ISVTX
 0001000

	)

19 
	#S_ISLNK
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFLNK
)

	)

20 
	#S_ISREG
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFREG
)

	)

21 
	#S_ISDIR
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFDIR
)

	)

22 
	#S_ISCHR
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFCHR
)

	)

23 
	#S_ISBLK
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFBLK
)

	)

24 
	#S_ISFIFO
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFIFO
)

	)

25 
	#S_ISSOCK
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFSOCK
)

	)

27 
	#S_IRWXU
 00700

	)

28 
	#S_IRUSR
 00400

	)

29 
	#S_IWUSR
 00200

	)

30 
	#S_IXUSR
 00100

	)

32 
	#S_IRWXG
 00070

	)

33 
	#S_IRGRP
 00040

	)

34 
	#S_IWGRP
 00020

	)

35 
	#S_IXGRP
 00010

	)

37 
	#S_IRWXO
 00007

	)

38 
	#S_IROTH
 00004

	)

39 
	#S_IWOTH
 00002

	)

40 
	#S_IXOTH
 00001

	)

	@/usr/include/linux/types.h

1 #iâdeà
_LINUX_TYPES_H


2 
	#_LINUX_TYPES_H


	)

4 
	~<asm/ty³s.h
>

6 #iâdeà
__ASSEMBLY__


8 
	~<lšux/posix_ty³s.h
>

16 #ifdeà
__CHECKER__


17 
	#__b™wi£__
 
	`__©Œibu‹__
((
b™wi£
))

	)

19 
	#__b™wi£__


	)

21 #ifdeà
__CHECK_ENDIAN__


22 
	#__b™wi£
 
__b™wi£__


	)

24 
	#__b™wi£


	)

27 
__u16
 
	t__b™wi£
 
	t__Ë16
;

28 
__u16
 
	t__b™wi£
 
	t__be16
;

29 
__u32
 
	t__b™wi£
 
	t__Ë32
;

30 
__u32
 
	t__b™wi£
 
	t__be32
;

31 
__u64
 
	t__b™wi£
 
	t__Ë64
;

32 
__u64
 
	t__b™wi£
 
	t__be64
;

34 
__u16
 
	t__b™wi£
 
	t__sum16
;

35 
__u32
 
	t__b™wi£
 
	t__wsum
;

46 
	#__®igÃd_u64
 
__u64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

47 
	#__®igÃd_be64
 
__be64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

48 
	#__®igÃd_Ë64
 
__Ë64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

	@/usr/include/linux/xattr.h

11 
	~<lšux/libc-com·t.h
>

13 #iâdeà
_LINUX_XATTR_H


14 
	#_LINUX_XATTR_H


	)

16 #ià
__UAPI_DEF_XATTR


17 
	#__USE_KERNEL_XATTR_DEFS


	)

19 
	#XATTR_CREATE
 0x1

	)

20 
	#XATTR_REPLACE
 0x2

	)

24 
	#XATTR_OS2_PREFIX
 "os2."

	)

25 
	#XATTR_OS2_PREFIX_LEN
 ((
XATTR_OS2_PREFIX
è- 1)

	)

27 
	#XATTR_MAC_OSX_PREFIX
 "osx."

	)

28 
	#XATTR_MAC_OSX_PREFIX_LEN
 ((
XATTR_MAC_OSX_PREFIX
è- 1)

	)

30 
	#XATTR_SECURITY_PREFIX
 "£cur™y."

	)

31 
	#XATTR_SECURITY_PREFIX_LEN
 ((
XATTR_SECURITY_PREFIX
è- 1)

	)

33 
	#XATTR_SYSTEM_PREFIX
 "sy¡em."

	)

34 
	#XATTR_SYSTEM_PREFIX_LEN
 ((
XATTR_SYSTEM_PREFIX
è- 1)

	)

36 
	#XATTR_TRUSTED_PREFIX
 "Œu¡ed."

	)

37 
	#XATTR_TRUSTED_PREFIX_LEN
 ((
XATTR_TRUSTED_PREFIX
è- 1)

	)

39 
	#XATTR_USER_PREFIX
 "u£r."

	)

40 
	#XATTR_USER_PREFIX_LEN
 ((
XATTR_USER_PREFIX
è- 1)

	)

43 
	#XATTR_EVM_SUFFIX
 "evm"

	)

44 
	#XATTR_NAME_EVM
 
XATTR_SECURITY_PREFIX
 
XATTR_EVM_SUFFIX


	)

46 
	#XATTR_IMA_SUFFIX
 "ima"

	)

47 
	#XATTR_NAME_IMA
 
XATTR_SECURITY_PREFIX
 
XATTR_IMA_SUFFIX


	)

49 
	#XATTR_SELINUX_SUFFIX
 "£lšux"

	)

50 
	#XATTR_NAME_SELINUX
 
XATTR_SECURITY_PREFIX
 
XATTR_SELINUX_SUFFIX


	)

52 
	#XATTR_SMACK_SUFFIX
 "SMACK64"

	)

53 
	#XATTR_SMACK_IPIN
 "SMACK64IPIN"

	)

54 
	#XATTR_SMACK_IPOUT
 "SMACK64IPOUT"

	)

55 
	#XATTR_SMACK_EXEC
 "SMACK64EXEC"

	)

56 
	#XATTR_SMACK_TRANSMUTE
 "SMACK64TRANSMUTE"

	)

57 
	#XATTR_SMACK_MMAP
 "SMACK64MMAP"

	)

58 
	#XATTR_NAME_SMACK
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_SUFFIX


	)

59 
	#XATTR_NAME_SMACKIPIN
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_IPIN


	)

60 
	#XATTR_NAME_SMACKIPOUT
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_IPOUT


	)

61 
	#XATTR_NAME_SMACKEXEC
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_EXEC


	)

62 
	#XATTR_NAME_SMACKTRANSMUTE
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_TRANSMUTE


	)

63 
	#XATTR_NAME_SMACKMMAP
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_MMAP


	)

65 
	#XATTR_CAPS_SUFFIX
 "ÿ·b™y"

	)

66 
	#XATTR_NAME_CAPS
 
XATTR_SECURITY_PREFIX
 
XATTR_CAPS_SUFFIX


	)

68 
	#XATTR_POSIX_ACL_ACCESS
 "posix_aş_acûss"

	)

69 
	#XATTR_NAME_POSIX_ACL_ACCESS
 
XATTR_SYSTEM_PREFIX
 
XATTR_POSIX_ACL_ACCESS


	)

70 
	#XATTR_POSIX_ACL_DEFAULT
 "posix_aş_deçuÉ"

	)

71 
	#XATTR_NAME_POSIX_ACL_DEFAULT
 
XATTR_SYSTEM_PREFIX
 
XATTR_POSIX_ACL_DEFAULT


	)

	@/usr/include/linux/ioctl.h

1 #iâdeà
_LINUX_IOCTL_H


2 
	#_LINUX_IOCTL_H


	)

4 
	~<asm/ioùl.h
>

	@/usr/include/linux/irqnr.h

	@/usr/include/linux/libc-compat.h

48 #iâdeà
_LIBC_COMPAT_H


49 
	#_LIBC_COMPAT_H


	)

52 #ià
defšed
(
__GLIBC__
)

55 #ià
defšed
(
_NETINET_IN_H
)

59 
	#__UAPI_DEF_IN6_ADDR
 0

	)

64 #ià
defšed
(
__USE_MISC
è|| defšed (
__USE_GNU
)

65 
	#__UAPI_DEF_IN6_ADDR_ALT
 0

	)

67 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

69 
	#__UAPI_DEF_SOCKADDR_IN6
 0

	)

70 
	#__UAPI_DEF_IPV6_MREQ
 0

	)

71 
	#__UAPI_DEF_IPPROTO_V6
 0

	)

72 
	#__UAPI_DEF_IPV6_OPTIONS
 0

	)

79 
	#__UAPI_DEF_IN6_ADDR
 1

	)

82 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

83 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

84 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

85 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

86 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

91 #ià
defšed
(
_SYS_XATTR_H
)

92 
	#__UAPI_DEF_XATTR
 0

	)

94 
	#__UAPI_DEF_XATTR
 1

	)

103 
	#__UAPI_DEF_IN6_ADDR
 1

	)

104 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

105 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

106 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

107 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

108 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

111 
	#__UAPI_DEF_XATTR
 1

	)

	@/usr/include/linux/limits.h

1 #iâdeà
_LINUX_LIMITS_H


2 
	#_LINUX_LIMITS_H


	)

4 
	#NR_OPEN
 1024

	)

6 
	#NGROUPS_MAX
 65536

	)

7 
	#ARG_MAX
 131072

	)

8 
	#LINK_MAX
 127

	)

9 
	#MAX_CANON
 255

	)

10 
	#MAX_INPUT
 255

	)

11 
	#NAME_MAX
 255

	)

12 
	#PATH_MAX
 4096

	)

13 
	#PIPE_BUF
 4096

	)

14 
	#XATTR_NAME_MAX
 255

	)

15 
	#XATTR_SIZE_MAX
 65536

	)

16 
	#XATTR_LIST_MAX
 65536

	)

18 
	#RTSIG_MAX
 32

	)

	@/usr/include/linux/posix_types.h

1 #iâdeà
_LINUX_POSIX_TYPES_H


2 
	#_LINUX_POSIX_TYPES_H


	)

4 
	~<lšux/¡ddef.h
>

21 #undeà
__FD_SETSIZE


22 
	#__FD_SETSIZE
 1024

	)

25 
	mfds_b™s
[
__FD_SETSIZE
 / (8 * ())];

26 } 
	t__k”Ãl_fd_£t
;

29 (*
	t__k”Ãl_sighªdËr_t
)();

32 
	t__k”Ãl_key_t
;

33 
	t__k”Ãl_mqd_t
;

35 
	~<asm/posix_ty³s.h
>

	@/usr/include/linux/stddef.h

	@
1
.
1
/usr/include
37
572
acl.c
acl.h
checkpoint.c
data.c
debug.c
dir.c
f2fs.h
f2fs.mod.c
file.c
gc.c
gc.h
hash.c
inline.c
inode.c
namei.c
node.c
node.h
recovery.c
segment.c
segment.h
super.c
xattr.c
xattr.h
/usr/include/linux/falloc.h
/usr/include/linux/fs.h
/usr/include/linux/magic.h
/usr/include/linux/random.h
/usr/include/linux/sched.h
/usr/include/linux/stat.h
/usr/include/linux/types.h
/usr/include/linux/xattr.h
/usr/include/linux/ioctl.h
/usr/include/linux/irqnr.h
/usr/include/linux/libc-compat.h
/usr/include/linux/limits.h
/usr/include/linux/posix_types.h
/usr/include/linux/stddef.h
